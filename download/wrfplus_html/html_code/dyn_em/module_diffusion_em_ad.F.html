<HTML> <BODY BGCOLOR=#cceeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!                           DISCLAIMER<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!   This file was generated by TAF version 1.7.18<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>!   FASTOPT DISCLAIMS  ALL  WARRANTIES,  EXPRESS  OR  IMPLIED,<a name='6'></font>
<font color=#447700>!   INCLUDING (WITHOUT LIMITATION) ALL IMPLIED  WARRANTIES  OF<a name='7'></font>
<font color=#447700>!   MERCHANTABILITY  OR FITNESS FOR A PARTICULAR PURPOSE, WITH<a name='8'></font>
<font color=#447700>!   RESPECT TO THE SOFTWARE AND USER PROGRAMS.   IN  NO  EVENT<a name='9'></font>
<font color=#447700>!   SHALL  FASTOPT BE LIABLE FOR ANY LOST OR ANTICIPATED PROF-<a name='10'></font>
<font color=#447700>!   ITS, OR ANY INDIRECT, INCIDENTAL, EXEMPLARY,  SPECIAL,  OR<a name='11'></font>
<font color=#447700>!   CONSEQUENTIAL  DAMAGES, WHETHER OR NOT FASTOPT WAS ADVISED<a name='12'></font>
<font color=#447700>!   OF THE POSSIBILITY OF SUCH DAMAGES.<a name='13'></font>
<font color=#447700>!<a name='14'></font>
<font color=#447700>!                           Haftungsbeschraenkung<a name='15'></font>
<font color=#447700>!   FastOpt gibt ausdruecklich keine Gewaehr, explizit oder indirekt,<a name='16'></font>
<font color=#447700>!   bezueglich der Brauchbarkeit  der Software  fuer einen bestimmten<a name='17'></font>
<font color=#447700>!   Zweck.   Unter  keinen  Umstaenden   ist  FastOpt   haftbar  fuer<a name='18'></font>
<font color=#447700>!   irgendeinen Verlust oder nicht eintretenden erwarteten Gewinn und<a name='19'></font>
<font color=#447700>!   allen indirekten,  zufaelligen,  exemplarischen  oder  speziellen<a name='20'></font>
<font color=#447700>!   Schaeden  oder  Folgeschaeden  unabhaengig  von einer eventuellen<a name='21'></font>
<font color=#447700>!   Mitteilung darueber an FastOpt.<a name='22'></font>
<font color=#447700>!<a name='23'></font>
<A NAME='A_MODULE_DIFFUSION_EM'><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_MODULE_DIFFUSION_EM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='24'>
<font color=#993300>module     </font><font color=#cc0000>a_module_diffusion_em</font> <A href='../../call_to/A_MODULE_DIFFUSION_EM.html' TARGET='index'>2</A><a name='25'>
<font color=#447700>!******************************************************************<a name='26'></font>
<font color=#447700>!******************************************************************<a name='27'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='28'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='29'></font>
<font color=#447700>!******************************************************************<a name='30'></font>
<font color=#447700>!******************************************************************<a name='31'></font>
<font color=#447700>!==============================================<a name='32'></font>
<font color=#447700>! referencing used modules<a name='33'></font>
<font color=#447700>!==============================================<a name='34'></font>
use <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#module_diffusion_em_ad.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_12"><a name='35'>
use <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#module_diffusion_em_ad.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_11"><a name='36'>
use <A href='../../html_code/dyn_em/module_bc_ad.F.html#A_MODULE_BC'>a_module_bc</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#module_diffusion_em_ad.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_MODULE_BC_3"><a name='37'>
use module_state_description<a name='38'>
use <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#module_diffusion_em_ad.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_6"><a name='39'>
use <A href='../../html_code/dyn_em/module_big_step_utilities_em_ad.F.html#A_MODULE_BIG_STEP_UTILITIES_EM'>a_module_big_step_utilities_em</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#module_diffusion_em_ad.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_MODULE_BIG_STEP_UTILITIES_EM_2"><a name='40'>
use <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#module_diffusion_em_ad.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_8"><a name='41'>
use <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#module_diffusion_em_ad.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_10"><a name='42'>
use <A href='../../html_code/dyn_em/module_diffusion_em.F.html#MODULE_DIFFUSION_EM'>module_diffusion_em</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#module_diffusion_em_ad.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DIFFUSION_EM_1"><a name='43'>
<a name='44'>
<font color=#447700>!==============================================<a name='45'></font>
<font color=#447700>! all entries are defined explicitly<a name='46'></font>
<font color=#447700>!==============================================<a name='47'></font>
implicit none<a name='48'>
<a name='49'>
contains<a name='50'>
<A NAME='A_CAL_DAMPKM'><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CAL_DAMPKM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='51'>
<font color=#993300>subroutine </font><font color=#cc0000>a_cal_dampkm</font>( xkmhd, a_xkmhd, dx, dt, dampcoef, rdz, rdzw, zdamp, ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite,&amp; <A href='../../call_to/A_CAL_DAMPKM.html' TARGET='index'>1</A><a name='52'>
&amp; jts, jte, kts, kte )<a name='53'>
<font color=#447700>!******************************************************************<a name='54'></font>
<font color=#447700>!******************************************************************<a name='55'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='56'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='57'></font>
<font color=#447700>!******************************************************************<a name='58'></font>
<font color=#447700>!******************************************************************<a name='59'></font>
<font color=#447700>!==============================================<a name='60'></font>
<font color=#447700>! all entries are defined explicitly<a name='61'></font>
<font color=#447700>!==============================================<a name='62'></font>
implicit none<a name='63'>
<a name='64'>
<font color=#447700>!==============================================<a name='65'></font>
<font color=#447700>! declare arguments<a name='66'></font>
<font color=#447700>!==============================================<a name='67'></font>
integer, intent(in) :: ime<a name='68'>
integer, intent(in) :: ims<a name='69'>
integer, intent(in) :: jme<a name='70'>
integer, intent(in) :: jms<a name='71'>
integer, intent(in) :: kme<a name='72'>
integer, intent(in) :: kms<a name='73'>
real, intent(inout) :: a_xkmhd(ims:ime,kms:kme,jms:jme)<a name='74'>
real, intent(in) :: dampcoef<a name='75'>
real, intent(in) :: dt<a name='76'>
real, intent(in) :: dx<a name='77'>
integer, intent(in) :: ide<a name='78'>
integer, intent(in) :: ite<a name='79'>
integer, intent(in) :: its<a name='80'>
integer, intent(in) :: jde<a name='81'>
integer, intent(in) :: jte<a name='82'>
integer, intent(in) :: jts<a name='83'>
integer, intent(in) :: kde<a name='84'>
integer, intent(in) :: kte<a name='85'>
integer, intent(in) :: kts<a name='86'>
real, intent(in) :: rdz(ims:ime,kms:kme,jms:jme)<a name='87'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='88'>
real, intent(inout) :: xkmhd(ims:ime,kms:kme,jms:jme)<a name='89'>
real, intent(in) :: zdamp<a name='90'>
<a name='91'>
<font color=#447700>!==============================================<a name='92'></font>
<font color=#447700>! declare local variables<a name='93'></font>
<font color=#447700>!==============================================<a name='94'></font>
real dampk(its:ite,kts:kte,jts:jte)<a name='95'>
real degrad90<a name='96'>
real deltaz(its:ite)<a name='97'>
real dz<a name='98'>
integer i<a name='99'>
integer i_end<a name='100'>
integer i_start<a name='101'>
integer j<a name='102'>
integer j_end<a name='103'>
integer j_start<a name='104'>
integer k<a name='105'>
real kmmax<a name='106'>
integer ktf<a name='107'>
integer ktfm1<a name='108'>
real tmp<a name='109'>
<a name='110'>
<font color=#447700>!----------------------------------------------<a name='111'></font>
<font color=#447700>! ROUTINE BODY<a name='112'></font>
<font color=#447700>!----------------------------------------------<a name='113'></font>
ktf = min(kte,kde-1)<a name='114'>
<font color=#447700>! recompute : ktf<a name='115'></font>
ktfm1 = ktf-1<a name='116'>
<font color=#447700>! recompute : ktfm1<a name='117'></font>
i_start = its<a name='118'>
<font color=#447700>! recompute : i_start<a name='119'></font>
i_end = min(ite,ide-1)<a name='120'>
<font color=#447700>! recompute : i_end<a name='121'></font>
j_start = jts<a name='122'>
<font color=#447700>! recompute : j_start<a name='123'></font>
j_end = min(jte,jde-1)<a name='124'>
<font color=#447700>! recompute : j_end<a name='125'></font>
kmmax = dx*dx/dt<a name='126'>
<font color=#447700>! recompute : kmmax<a name='127'></font>
degrad90 = degrad*90.<a name='128'>
<font color=#447700>! recompute : degrad90<a name='129'></font>
do j = j_start, j_end<a name='130'>
  k = ktf<a name='131'>
  do i = i_start, i_end<a name='132'>
    dz = 1./rdzw(i,k,j)<a name='133'>
    deltaz(i) = 0.5*dz<a name='134'>
    tmp = min(deltaz(i)/zdamp,1.)<a name='135'>
    dampk(i,k,j) = cos(degrad90*tmp)*kmmax*dampcoef<a name='136'>
  end do<a name='137'>
  do k = ktfm1, kts, -1<a name='138'>
    do i = i_start, i_end<a name='139'>
      dz = 1./rdz(i,k,j)<a name='140'>
      deltaz(i) = deltaz(i)+dz<a name='141'>
      tmp = min(deltaz(i)/zdamp,1.)<a name='142'>
      dampk(i,k,j) = cos(degrad90*tmp)*kmmax*dampcoef<a name='143'>
    end do<a name='144'>
  end do<a name='145'>
end do<a name='146'>
<font color=#447700>! recompute : dampk<a name='147'></font>
do j = j_start, j_end<a name='148'>
  do k = kts, ktf<a name='149'>
    do i = i_start, i_end<a name='150'>
      a_xkmhd(i,k,j) = a_xkmhd(i,k,j)*(0.5+sign(0.5,xkmhd(i,k,j)-dampk(i,k,j)))<a name='151'>
    end do<a name='152'>
  end do<a name='153'>
end do<a name='154'>
<a name='155'>
end subroutine a_cal_dampkm<a name='156'>
<a name='157'>
<a name='158'>
<A NAME='A_CALC_L_SCALE'><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALC_L_SCALE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='159'>
<font color=#993300>subroutine </font><font color=#cc0000>a_calc_l_scale</font>( tke, bn2, a_bn2, l_scale, a_l_scale, i_start, i_end, ktf, j_start, j_end, dx, dy, rdzw, ims, ime, jms, &amp; <A href='../../call_to/A_CALC_L_SCALE.html' TARGET='index'>1</A><a name='160'>
&amp;jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='161'>
<font color=#447700>!******************************************************************<a name='162'></font>
<font color=#447700>!******************************************************************<a name='163'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='164'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='165'></font>
<font color=#447700>!******************************************************************<a name='166'></font>
<font color=#447700>!******************************************************************<a name='167'></font>
<font color=#447700>!==============================================<a name='168'></font>
<font color=#447700>! all entries are defined explicitly<a name='169'></font>
<font color=#447700>!==============================================<a name='170'></font>
implicit none<a name='171'>
<a name='172'>
<font color=#447700>!==============================================<a name='173'></font>
<font color=#447700>! declare arguments<a name='174'></font>
<font color=#447700>!==============================================<a name='175'></font>
integer, intent(in) :: ime<a name='176'>
integer, intent(in) :: ims<a name='177'>
integer, intent(in) :: jme<a name='178'>
integer, intent(in) :: jms<a name='179'>
integer, intent(in) :: kme<a name='180'>
integer, intent(in) :: kms<a name='181'>
real, intent(inout) :: a_bn2(ims:ime,kms:kme,jms:jme)<a name='182'>
integer, intent(in) :: ite<a name='183'>
integer, intent(in) :: its<a name='184'>
integer, intent(in) :: jte<a name='185'>
integer, intent(in) :: jts<a name='186'>
integer, intent(in) :: kte<a name='187'>
integer, intent(in) :: kts<a name='188'>
real, intent(inout) :: a_l_scale(its:ite,kts:kte,jts:jte)<a name='189'>
real, intent(in) :: bn2(ims:ime,kms:kme,jms:jme)<a name='190'>
real, intent(in) :: dx<a name='191'>
real, intent(in) :: dy<a name='192'>
integer, intent(in) :: i_end<a name='193'>
integer, intent(in) :: i_start<a name='194'>
integer, intent(in) :: j_end<a name='195'>
integer, intent(in) :: j_start<a name='196'>
integer, intent(in) :: ktf<a name='197'>
real, intent(out) :: l_scale(its:ite,kts:kte,jts:jte)<a name='198'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='199'>
real, intent(in) :: tke(ims:ime,kms:kme,jms:jme)<a name='200'>
<a name='201'>
<font color=#447700>!==============================================<a name='202'></font>
<font color=#447700>! declare local variables<a name='203'></font>
<font color=#447700>!==============================================<a name='204'></font>
real deltas<a name='205'>
integer i<a name='206'>
integer j<a name='207'>
integer k<a name='208'>
real tmp<a name='209'>
<a name='210'>
<font color=#447700>!----------------------------------------------<a name='211'></font>
<font color=#447700>! ROUTINE BODY<a name='212'></font>
<font color=#447700>!----------------------------------------------<a name='213'></font>
do j = j_start, j_end<a name='214'>
  do k = kts, ktf<a name='215'>
    do i = i_start, i_end<a name='216'>
      deltas = (dx*dy/rdzw(i,k,j))**0.33333333<a name='217'>
<font color=#447700>! recompute : deltas<a name='218'></font>
      l_scale(i,k,j) = deltas<a name='219'>
      if (bn2(i,k,j) .gt. 1.e-6) then<a name='220'>
        tmp = sqrt(max(tke(i,k,j),1.e-6))<a name='221'>
<font color=#447700>! recompute : tmp<a name='222'></font>
        l_scale(i,k,j) = 0.76*tmp/sqrt(bn2(i,k,j))<a name='223'>
<font color=#447700>! recompute : l_scale<a name='224'></font>
        l_scale(i,k,j) = min(l_scale(i,k,j),deltas)<a name='225'>
<font color=#447700>! recompute : l_scale<a name='226'></font>
        a_l_scale(i,k,j) = a_l_scale(i,k,j)*(0.5+sign(0.5,l_scale(i,k,j)-0.001*deltas))<a name='227'>
<font color=#447700>! recdepend vars : bn2,i,j,k,tmp<a name='228'></font>
<font color=#447700>! recompute pos : ASSIGN_STMT module_diffusion_em.f90:1870<a name='229'></font>
<font color=#447700>! recompute vars : l_scale<a name='230'></font>
        l_scale(i,k,j) = 0.76*tmp/sqrt(bn2(i,k,j))<a name='231'>
<font color=#447700>! recompute vars : l_scale<a name='232'></font>
        a_l_scale(i,k,j) = a_l_scale(i,k,j)*(0.5+sign(0.5,deltas-l_scale(i,k,j)))<a name='233'>
        a_bn2(i,k,j) = a_bn2(i,k,j)-a_l_scale(i,k,j)*(0.76*tmp*(1./(2.*sqrt(bn2(i,k,j))))/(sqrt(bn2(i,k,j))*sqrt(bn2(i,k,j))))<a name='234'>
        a_l_scale(i,k,j) = 0.<a name='235'>
      endif<a name='236'>
      a_l_scale(i,k,j) = 0.<a name='237'>
    end do<a name='238'>
  end do<a name='239'>
end do<a name='240'>
<a name='241'>
end subroutine a_calc_l_scale<a name='242'>
<a name='243'>
<a name='244'>
<A NAME='A_CALCULATE_KM_KH'><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='245'>
<font color=#993300>subroutine </font><font color=#cc0000>a_calculate_km_kh</font>( config_flags, dt, dampcoef, zdamp, damp_opt, xkmh, xkmhd, a_xkmhd, xkmv, xkhh, xkhv, bn2, a_bn2, &amp; <A href='../../call_to/A_CALCULATE_KM_KH.html' TARGET='index'>2</A>,<A href='../../call_from/A_CALCULATE_KM_KH.html' TARGET='index'>11</A><a name='246'>
&amp;khdif, div, defor11, defor22, defor33, defor12, defor13, defor23, tke, p8w, a_p8w, t8w, a_t8w, theta, a_theta, t, a_t, p, a_p, &amp;<a name='247'>
&amp;moist, a_moist, dn, dnw, dx, dy, rdz, rdzw, n_moist, cf1, cf2, cf3, kh_tke_upper_bound, ids, ide, jds, jde, kde, ims, ime, jms, &amp;<a name='248'>
&amp;jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='249'>
<font color=#447700>!******************************************************************<a name='250'></font>
<font color=#447700>!******************************************************************<a name='251'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='252'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='253'></font>
<font color=#447700>!******************************************************************<a name='254'></font>
<font color=#447700>!******************************************************************<a name='255'></font>
<font color=#447700>!==============================================<a name='256'></font>
<font color=#447700>! all entries are defined explicitly<a name='257'></font>
<font color=#447700>!==============================================<a name='258'></font>
implicit none<a name='259'>
<a name='260'>
<font color=#447700>!==============================================<a name='261'></font>
<font color=#447700>! declare arguments<a name='262'></font>
<font color=#447700>!==============================================<a name='263'></font>
integer, intent(in) :: ime<a name='264'>
integer, intent(in) :: ims<a name='265'>
integer, intent(in) :: jme<a name='266'>
integer, intent(in) :: jms<a name='267'>
integer, intent(in) :: kme<a name='268'>
integer, intent(in) :: kms<a name='269'>
real, intent(inout) :: a_bn2(ims:ime,kms:kme,jms:jme)<a name='270'>
integer, intent(in) :: n_moist<a name='271'>
real, intent(inout) :: a_moist(ims:ime,kms:kme,jms:jme,n_moist)<a name='272'>
real, intent(inout) :: a_p(ims:ime,kms:kme,jms:jme)<a name='273'>
real, intent(inout) :: a_p8w(ims:ime,kms:kme,jms:jme)<a name='274'>
real, intent(inout) :: a_t(ims:ime,kms:kme,jms:jme)<a name='275'>
real, intent(inout) :: a_t8w(ims:ime,kms:kme,jms:jme)<a name='276'>
real, intent(inout) :: a_theta(ims:ime,kms:kme,jms:jme)<a name='277'>
real, intent(inout) :: a_xkmhd(ims:ime,kms:kme,jms:jme)<a name='278'>
real, intent(inout) :: bn2(ims:ime,kms:kme,jms:jme)<a name='279'>
real, intent(in) :: cf1<a name='280'>
real, intent(in) :: cf2<a name='281'>
real, intent(in) :: cf3<a name='282'>
type (grid_config_rec_type), intent(in) :: config_flags<a name='283'>
integer, intent(in) :: damp_opt<a name='284'>
real, intent(in) :: dampcoef<a name='285'>
real, intent(in) :: defor11(ims:ime,kms:kme,jms:jme)<a name='286'>
real, intent(in) :: defor12(ims:ime,kms:kme,jms:jme)<a name='287'>
real, intent(in) :: defor13(ims:ime,kms:kme,jms:jme)<a name='288'>
real, intent(in) :: defor22(ims:ime,kms:kme,jms:jme)<a name='289'>
real, intent(in) :: defor23(ims:ime,kms:kme,jms:jme)<a name='290'>
real, intent(in) :: defor33(ims:ime,kms:kme,jms:jme)<a name='291'>
real, intent(in) :: div(ims:ime,kms:kme,jms:jme)<a name='292'>
real, intent(in) :: dn(kms:kme)<a name='293'>
real, intent(in) :: dnw(kms:kme)<a name='294'>
real, intent(in) :: dt<a name='295'>
real, intent(in) :: dx<a name='296'>
real, intent(in) :: dy<a name='297'>
integer, intent(in) :: ide<a name='298'>
integer, intent(in) :: ids<a name='299'>
integer, intent(in) :: ite<a name='300'>
integer, intent(in) :: its<a name='301'>
integer, intent(in) :: jde<a name='302'>
integer, intent(in) :: jds<a name='303'>
integer, intent(in) :: jte<a name='304'>
integer, intent(in) :: jts<a name='305'>
integer, intent(in) :: kde<a name='306'>
real, intent(in) :: kh_tke_upper_bound<a name='307'>
real, intent(in) :: khdif<a name='308'>
integer, intent(in) :: kte<a name='309'>
integer, intent(in) :: kts<a name='310'>
real, intent(inout) :: moist(ims:ime,kms:kme,jms:jme,n_moist)<a name='311'>
real, intent(in) :: p(ims:ime,kms:kme,jms:jme)<a name='312'>
real, intent(in) :: p8w(ims:ime,kms:kme,jms:jme)<a name='313'>
real, intent(in) :: rdz(ims:ime,kms:kme,jms:jme)<a name='314'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='315'>
real, intent(in) :: t(ims:ime,kms:kme,jms:jme)<a name='316'>
real, intent(in) :: t8w(ims:ime,kms:kme,jms:jme)<a name='317'>
real, intent(in) :: theta(ims:ime,kms:kme,jms:jme)<a name='318'>
real, intent(inout) :: tke(ims:ime,kms:kme,jms:jme)<a name='319'>
real, intent(inout) :: xkhh(ims:ime,kms:kme,jms:jme)<a name='320'>
real, intent(inout) :: xkhv(ims:ime,kms:kme,jms:jme)<a name='321'>
real, intent(inout) :: xkmh(ims:ime,kms:kme,jms:jme)<a name='322'>
real, intent(inout) :: xkmhd(ims:ime,kms:kme,jms:jme)<a name='323'>
real, intent(inout) :: xkmv(ims:ime,kms:kme,jms:jme)<a name='324'>
real, intent(in) :: zdamp<a name='325'>
<a name='326'>
<font color=#447700>!==============================================<a name='327'></font>
<font color=#447700>! declare local variables<a name='328'></font>
<font color=#447700>!==============================================<a name='329'></font>
real a_xkmhh(1+ime-ims,1+kme-kms,1+jme-jms)<a name='330'>
real a_xkmhi(1+ime-ims,1+kme-kms,1+jme-jms)<a name='331'>
real a_xkmhj(1+ime-ims,1+kme-kms,1+jme-jms)<a name='332'>
real cr_len<a name='333'>
integer kds<a name='334'>
real kv_tke_upper_bound<a name='335'>
real kvdif<a name='336'>
logical warm_rain<a name='337'>
<a name='338'>
<font color=#447700>!----------------------------------------------<a name='339'></font>
<font color=#447700>! RESET LOCAL ADJOINT VARIABLES<a name='340'></font>
<font color=#447700>!----------------------------------------------<a name='341'></font>
a_xkmhh(:,:,:) = 0.<a name='342'>
a_xkmhi(:,:,:) = 0.<a name='343'>
a_xkmhj(:,:,:) = 0.<a name='344'>
<a name='345'>
<font color=#447700>!----------------------------------------------<a name='346'></font>
<font color=#447700>! ROUTINE BODY<a name='347'></font>
<font color=#447700>!----------------------------------------------<a name='348'></font>
call <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_N2'>calculate_n2</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_N2_2">( config_flags,bn2,moist,theta,t,p,p8w,t8w,dnw,dn,rdz,rdzw,n_moist,cf1,cf2,cf3,warm_rain,ids,ide,jds,jde,kds,kde,&amp;<a name='349'>
&amp;ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='350'>
<font color=#447700>! recompute : bn2<a name='351'></font>
km_coeg: select case ( config_flags%km_opt )<a name='352'>
case (1) km_coeg<a name='353'>
  call <A href='../../html_code/dyn_em/module_diffusion_em.F.html#ISOTROPIC_KM'>isotropic_km</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ISOTROPIC_KM_2">( config_flags,xkmh,xkmhd,xkmv,xkhh,xkhv,khdif,kvdif,ids,ide,jds,jde,kds,kde,ims,ime,jms,jme,kms,kme,its,ite,&amp;<a name='354'>
&amp;jts,jte,kts,kte )<a name='355'>
case (2) km_coeg<a name='356'>
  call <A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_KM'>tke_km</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TKE_KM_2">( config_flags,xkmh,xkmhd,xkmv,xkhh,xkhv,bn2,tke,p8w,t8w,theta,rdz,rdzw,dx,dy,cr_len,kh_tke_upper_bound,&amp;<a name='357'>
&amp;kv_tke_upper_bound,ids,ide,jds,jde,kds,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='358'>
case (3) km_coeg<a name='359'>
  call <A href='../../html_code/dyn_em/module_diffusion_em.F.html#SMAG_KM'>smag_km</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMAG_KM_2">( config_flags,xkmh,xkmhd,xkmv,xkhh,xkhv,bn2,div,defor11,defor22,defor33,defor12,defor13,defor23,rdzw,dx,dy,cr_len,&amp;<a name='360'>
&amp;ids,ide,jds,jde,kds,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='361'>
case (4) km_coeg<a name='362'>
  call <A href='../../html_code/dyn_em/module_diffusion_em.F.html#SMAG2D_KM'>smag2d_km</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMAG2D_KM_2">( config_flags,xkmh,xkmhd,xkmv,xkhh,xkhv,defor11,defor22,defor12,rdzw,dx,dy,ids,ide,jds,jde,kds,kde,ims,ime,jms,&amp;<a name='363'>
&amp;jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='364'>
end select km_coeg<a name='365'>
<font color=#447700>! recompute : xkmhd<a name='366'></font>
if (damp_opt .eq. 1) then<a name='367'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CAL_DAMPKM'>a_cal_dampkm</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_CAL_DAMPKM_1">( xkmhd,a_xkmhd,dx,dt,dampcoef,rdz,rdzw,zdamp,ide,jde,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='368'>
endif<a name='369'>
a_km_coef: select case ( config_flags%km_opt )<a name='370'>
case (1) a_km_coef<a name='371'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_ISOTROPIC_KM'>a_isotropic_km</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_ISOTROPIC_KM_1">( a_xkmhd,ide,jde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='372'>
case (2) a_km_coef<a name='373'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_TKE_KM'>a_tke_km</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_TKE_KM_1">( config_flags,xkmh,a_xkmhh,a_xkmhd,bn2,a_bn2,tke,rdzw,dx,dy,kh_tke_upper_bound,ids,ide,jds,jde,kde,ims,ime,jms,jme,&amp;<a name='374'>
&amp;kms,kme,its,ite,jts,jte,kts,kte )<a name='375'>
case (3) a_km_coef<a name='376'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_SMAG_KM'>a_smag_km</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_SMAG_KM_1">( config_flags,xkmh,a_xkmhi,a_xkmhd,bn2,a_bn2,defor11,defor22,defor33,defor12,defor13,defor23,rdzw,dx,dy,ids,ide,&amp;<a name='377'>
&amp;jds,jde,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='378'>
case (4) a_km_coef<a name='379'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_SMAG2D_KM'>a_smag2d_km</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_SMAG2D_KM_1">( config_flags,xkmh,a_xkmhj,a_xkmhd,defor11,defor22,defor12,dx,dy,ids,ide,jds,jde,kde,ims,ime,jms,jme,kms,kme,&amp;<a name='380'>
&amp;its,ite,jts,jte,kts,kte )<a name='381'>
end select a_km_coef<a name='382'>
call <A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_N2'>a_calculate_n2</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_CALCULATE_N2_1">( config_flags,a_bn2,moist,a_moist,theta,a_theta,t,a_t,p,a_p,p8w,a_p8w,t8w,a_t8w,rdz,rdzw,n_moist,cf1,cf2,cf3,&amp;<a name='383'>
&amp;ids,ide,jds,jde,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='384'>
<a name='385'>
end subroutine a_calculate_km_kh<a name='386'>
<a name='387'>
<a name='388'>
<A NAME='A_CALCULATE_N2'><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_N2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='389'>
<font color=#993300>subroutine </font><font color=#cc0000>a_calculate_n2</font>( config_flags, a_bn2, moist, a_moist, theta, a_theta, t, a_t, p, a_p, p8w, a_p8w, t8w, a_t8w, rdz, rdzw, &amp; <A href='../../call_to/A_CALCULATE_N2.html' TARGET='index'>1</A><a name='390'>
&amp;n_moist, cf1, cf2, cf3, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='391'>
<font color=#447700>!******************************************************************<a name='392'></font>
<font color=#447700>!******************************************************************<a name='393'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='394'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='395'></font>
<font color=#447700>!******************************************************************<a name='396'></font>
<font color=#447700>!******************************************************************<a name='397'></font>
<font color=#447700>!==============================================<a name='398'></font>
<font color=#447700>! all entries are defined explicitly<a name='399'></font>
<font color=#447700>!==============================================<a name='400'></font>
implicit none<a name='401'>
<a name='402'>
<font color=#447700>!==============================================<a name='403'></font>
<font color=#447700>! declare arguments<a name='404'></font>
<font color=#447700>!==============================================<a name='405'></font>
integer, intent(in) :: ime<a name='406'>
integer, intent(in) :: ims<a name='407'>
integer, intent(in) :: jme<a name='408'>
integer, intent(in) :: jms<a name='409'>
integer, intent(in) :: kme<a name='410'>
integer, intent(in) :: kms<a name='411'>
real, intent(inout) :: a_bn2(ims:ime,kms:kme,jms:jme)<a name='412'>
integer, intent(in) :: n_moist<a name='413'>
real, intent(inout) :: a_moist(ims:ime,kms:kme,jms:jme,n_moist)<a name='414'>
real, intent(inout) :: a_p(ims:ime,kms:kme,jms:jme)<a name='415'>
real, intent(inout) :: a_p8w(ims:ime,kms:kme,jms:jme)<a name='416'>
real, intent(inout) :: a_t(ims:ime,kms:kme,jms:jme)<a name='417'>
real, intent(inout) :: a_t8w(ims:ime,kms:kme,jms:jme)<a name='418'>
real, intent(inout) :: a_theta(ims:ime,kms:kme,jms:jme)<a name='419'>
real, intent(in) :: cf1<a name='420'>
real, intent(in) :: cf2<a name='421'>
real, intent(in) :: cf3<a name='422'>
type (grid_config_rec_type), intent(in) :: config_flags<a name='423'>
integer, intent(in) :: ide<a name='424'>
integer, intent(in) :: ids<a name='425'>
integer, intent(in) :: ite<a name='426'>
integer, intent(in) :: its<a name='427'>
integer, intent(in) :: jde<a name='428'>
integer, intent(in) :: jds<a name='429'>
integer, intent(in) :: jte<a name='430'>
integer, intent(in) :: jts<a name='431'>
integer, intent(in) :: kde<a name='432'>
integer, intent(in) :: kte<a name='433'>
integer, intent(in) :: kts<a name='434'>
real, intent(inout) :: moist(ims:ime,kms:kme,jms:jme,n_moist)<a name='435'>
real, intent(in) :: p(ims:ime,kms:kme,jms:jme)<a name='436'>
real, intent(in) :: p8w(ims:ime,kms:kme,jms:jme)<a name='437'>
real, intent(in) :: rdz(ims:ime,kms:kme,jms:jme)<a name='438'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='439'>
real, intent(in) :: t(ims:ime,kms:kme,jms:jme)<a name='440'>
real, intent(in) :: t8w(ims:ime,kms:kme,jms:jme)<a name='441'>
real, intent(in) :: theta(ims:ime,kms:kme,jms:jme)<a name='442'>
<a name='443'>
<font color=#447700>!==============================================<a name='444'></font>
<font color=#447700>! declare local variables<a name='445'></font>
<font color=#447700>!==============================================<a name='446'></font>
real a_coefa<a name='447'>
real a_es<a name='448'>
real a_qctmp(its:ite,kts:kte,jts:jte)<a name='449'>
real a_qvs(its:ite,kts:kte,jts:jte)<a name='450'>
real a_qvsfc<a name='451'>
real a_tc<a name='452'>
real a_thetaem1<a name='453'>
real a_thetaep1<a name='454'>
real a_thetaesfc<a name='455'>
real a_thetasfc<a name='456'>
real a_tmp1(its:ite,kts:kte,jts:jte)<a name='457'>
real a_tmp1sfc(its:ite,jts:jte)<a name='458'>
real a_xlvqv<a name='459'>
real coefa<a name='460'>
real es<a name='461'>
integer i<a name='462'>
integer i_end<a name='463'>
integer i_start<a name='464'>
integer ispe<a name='465'>
integer j<a name='466'>
integer j_end<a name='467'>
integer j_start<a name='468'>
integer k<a name='469'>
integer ktf<a name='470'>
real qc_cr<a name='471'>
real qctmp(its:ite,kts:kte,jts:jte)<a name='472'>
real qvs(its:ite,kts:kte,jts:jte)<a name='473'>
real qvsfc<a name='474'>
real tc<a name='475'>
real thetaem1<a name='476'>
real thetaep1<a name='477'>
real thetaesfc<a name='478'>
real thetasfc<a name='479'>
real tmpdz<a name='480'>
real xlvqv<a name='481'>
<a name='482'>
<font color=#447700>!----------------------------------------------<a name='483'></font>
<font color=#447700>! RESET LOCAL ADJOINT VARIABLES<a name='484'></font>
<font color=#447700>!----------------------------------------------<a name='485'></font>
a_coefa = 0.<a name='486'>
a_es = 0.<a name='487'>
a_qctmp(:,:,:) = 0.<a name='488'>
a_qvs(:,:,:) = 0.<a name='489'>
a_qvsfc = 0.<a name='490'>
a_tc = 0.<a name='491'>
a_thetaem1 = 0.<a name='492'>
a_thetaep1 = 0.<a name='493'>
a_thetaesfc = 0.<a name='494'>
a_thetasfc = 0.<a name='495'>
a_tmp1(:,:,:) = 0.<a name='496'>
a_tmp1sfc(:,:) = 0.<a name='497'>
a_xlvqv = 0.<a name='498'>
<a name='499'>
<font color=#447700>!----------------------------------------------<a name='500'></font>
<font color=#447700>! ROUTINE BODY<a name='501'></font>
<font color=#447700>!----------------------------------------------<a name='502'></font>
qc_cr = 0.00001<a name='503'>
<font color=#447700>! recompute : qc_cr<a name='504'></font>
ktf = min(kte,kde-1)<a name='505'>
<font color=#447700>! recompute : ktf<a name='506'></font>
i_start = its<a name='507'>
<font color=#447700>! recompute : i_start<a name='508'></font>
i_end = min(ite,ide-1)<a name='509'>
<font color=#447700>! recompute : i_end<a name='510'></font>
j_start = jts<a name='511'>
<font color=#447700>! recompute : j_start<a name='512'></font>
j_end = min(jte,jde-1)<a name='513'>
<font color=#447700>! recompute : j_end<a name='514'></font>
if (config_flags%open_xs .or. config_flags%specified .or. config_flags%nested) then<a name='515'>
  i_start = max(ids+1,its)<a name='516'>
endif<a name='517'>
<font color=#447700>! recompute : i_start<a name='518'></font>
if (config_flags%open_xe .or. config_flags%specified .or. config_flags%nested) then<a name='519'>
  i_end = min(ide-2,ite)<a name='520'>
endif<a name='521'>
<font color=#447700>! recompute : i_end<a name='522'></font>
if (config_flags%open_ys .or. config_flags%specified .or. config_flags%nested) then<a name='523'>
  j_start = max(jds+1,jts)<a name='524'>
endif<a name='525'>
<font color=#447700>! recompute : j_start<a name='526'></font>
if (config_flags%open_ye .or. config_flags%specified .or. config_flags%nested) then<a name='527'>
  j_end = min(jde-2,jte)<a name='528'>
endif<a name='529'>
<font color=#447700>! recompute : j_end<a name='530'></font>
if (p_qc .gt. param_first_scalar) then<a name='531'>
  do j = j_start, j_end<a name='532'>
    do k = kts, ktf<a name='533'>
      do i = i_start, i_end<a name='534'>
        qctmp(i,k,j) = moist(i,k,j,p_qc)<a name='535'>
      end do<a name='536'>
    end do<a name='537'>
  end do<a name='538'>
else<a name='539'>
  do j = j_start, j_end<a name='540'>
    do k = kts, ktf<a name='541'>
      do i = i_start, i_end<a name='542'>
        qctmp(i,k,j) = 0.<a name='543'>
      end do<a name='544'>
    end do<a name='545'>
  end do<a name='546'>
endif<a name='547'>
<font color=#447700>! recompute : qctmp<a name='548'></font>
do j = j_start, j_end<a name='549'>
  do k = kts, ktf<a name='550'>
    do i = i_start, i_end<a name='551'>
      tc = t(i,k,j)-svpt0<a name='552'>
      es = 1000.*svp1*exp(svp2*tc/(t(i,k,j)-svp3))<a name='553'>
      qvs(i,k,j) = ep_2*es/(p(i,k,j)-es)<a name='554'>
    end do<a name='555'>
  end do<a name='556'>
end do<a name='557'>
<font color=#447700>! recompute : qvs<a name='558'></font>
k = kts<a name='559'>
<font color=#447700>! recompute : k<a name='560'></font>
do j = j_start, j_end<a name='561'>
  do i = i_start, i_end<a name='562'>
    a_bn2(i,ktf-1,j) = a_bn2(i,ktf-1,j)+a_bn2(i,ktf,j)<a name='563'>
    a_bn2(i,ktf,j) = 0.<a name='564'>
  end do<a name='565'>
end do<a name='566'>
do j = j_start, j_end<a name='567'>
  a_coefa = 0.<a name='568'>
  a_qvsfc = 0.<a name='569'>
  a_thetaep1 = 0.<a name='570'>
  a_thetaesfc = 0.<a name='571'>
  a_thetasfc = 0.<a name='572'>
  a_xlvqv = 0.<a name='573'>
  do i = i_start, i_end<a name='574'>
    a_coefa = 0.<a name='575'>
    a_qvsfc = 0.<a name='576'>
    a_thetaep1 = 0.<a name='577'>
    a_thetaesfc = 0.<a name='578'>
    a_thetasfc = 0.<a name='579'>
    a_xlvqv = 0.<a name='580'>
    tmpdz = 1./rdz(i,k+1,j)+0.5/rdzw(i,k,j)<a name='581'>
<font color=#447700>! recompute : tmpdz<a name='582'></font>
    thetasfc = t8w(i,kts,j)/(p8w(i,k,j)/p1000mb)**(r_d/cp)<a name='583'>
<font color=#447700>! recompute : thetasfc<a name='584'></font>
    if (moist(i,k,j,p_qv) .ge. qvs(i,k,j) .or. qctmp(i,k,j) .ge. qc_cr) then<a name='585'>
      qvsfc = cf1*qvs(i,1,j)+cf2*qvs(i,2,j)+cf3*qvs(i,3,j)<a name='586'>
<font color=#447700>! recompute : qvsfc<a name='587'></font>
      xlvqv = xlv*moist(i,k,j,p_qv)<a name='588'>
<font color=#447700>! recompute : xlvqv<a name='589'></font>
      coefa = (1.+xlvqv/r_d/t(i,k,j))/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))/theta(i,k,j)<a name='590'>
<font color=#447700>! recompute : coefa<a name='591'></font>
      thetaep1 = theta(i,k+1,j)*(1.+xlv*qvs(i,k+1,j)/cp/t(i,k+1,j))<a name='592'>
<font color=#447700>! recompute : thetaep1<a name='593'></font>
      thetaesfc = thetasfc*(1.+xlv*qvsfc/cp/t8w(i,kts,j))<a name='594'>
<font color=#447700>! recompute : thetaesfc<a name='595'></font>
      a_coefa = a_coefa+a_bn2(i,k,j)*g*((thetaep1-thetaesfc)/tmpdz)<a name='596'>
      a_thetaep1 = a_thetaep1+a_bn2(i,k,j)*g*(coefa/tmpdz)<a name='597'>
      a_thetaesfc = a_thetaesfc-a_bn2(i,k,j)*g*(coefa/tmpdz)<a name='598'>
      a_tmp1(i,k+1,j) = a_tmp1(i,k+1,j)-a_bn2(i,k,j)*(g/tmpdz)<a name='599'>
      a_tmp1sfc(i,j) = a_tmp1sfc(i,j)+a_bn2(i,k,j)*(g/tmpdz)<a name='600'>
      a_bn2(i,k,j) = 0.<a name='601'>
      a_qvsfc = a_qvsfc+a_thetaesfc*thetasfc*(xlv/cp/t8w(i,kts,j))<a name='602'>
      a_t8w(i,kts,j) = a_t8w(i,kts,j)-a_thetaesfc*thetasfc*(xlv*qvsfc/cp/(t8w(i,kts,j)*t8w(i,kts,j)))<a name='603'>
      a_thetasfc = a_thetasfc+a_thetaesfc*(1+xlv*qvsfc/cp/t8w(i,kts,j))<a name='604'>
      a_thetaesfc = 0.<a name='605'>
      a_qvs(i,k+1,j) = a_qvs(i,k+1,j)+a_thetaep1*theta(i,k+1,j)*(xlv/cp/t(i,k+1,j))<a name='606'>
      a_t(i,k+1,j) = a_t(i,k+1,j)-a_thetaep1*theta(i,k+1,j)*(xlv*qvs(i,k+1,j)/cp/(t(i,k+1,j)*t(i,k+1,j)))<a name='607'>
      a_theta(i,k+1,j) = a_theta(i,k+1,j)+a_thetaep1*(1+xlv*qvs(i,k+1,j)/cp/t(i,k+1,j))<a name='608'>
      a_thetaep1 = 0.<a name='609'>
      a_t(i,k,j) = a_t(i,k,j)+a_coefa*(((-(xlvqv/r_d/(t(i,k,j)*t(i,k,j))/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))))+(1.+xlvqv/r_d/&amp;<a name='610'>
&amp;t(i,k,j))*(xlv*xlvqv/cp/r_v/(t(i,k,j)*t(i,k,j))/t(i,k,j)+xlv*xlvqv/cp/r_v/t(i,k,j)/(t(i,k,j)*t(i,k,j)))/((1.+xlv*xlvqv/cp/&amp;<a name='611'>
&amp;r_v/t(i,k,j)/t(i,k,j))*(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))))/theta(i,k,j))<a name='612'>
      a_theta(i,k,j) = a_theta(i,k,j)-a_coefa*((1.+xlvqv/r_d/t(i,k,j))/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))/(theta(i,k,j)*&amp;<a name='613'>
&amp;theta(i,k,j)))<a name='614'>
      a_xlvqv = a_xlvqv+a_coefa*((1/r_d/t(i,k,j)/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))-(1.+xlvqv/r_d/t(i,k,j))*(xlv/cp/r_v/t(i,k,&amp;<a name='615'>
&amp;j)/t(i,k,j))/((1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))*(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))))/theta(i,k,j))<a name='616'>
      a_coefa = 0.<a name='617'>
      a_moist(i,k,j,p_qv) = a_moist(i,k,j,p_qv)+a_xlvqv*xlv<a name='618'>
      a_xlvqv = 0.<a name='619'>
      a_qvs(i,3,j) = a_qvs(i,3,j)+a_qvsfc*cf3<a name='620'>
      a_qvs(i,2,j) = a_qvs(i,2,j)+a_qvsfc*cf2<a name='621'>
      a_qvs(i,1,j) = a_qvs(i,1,j)+a_qvsfc*cf1<a name='622'>
      a_qvsfc = 0.<a name='623'>
    else<a name='624'>
      tmpdz = 1./rdzw(i,k,j)<a name='625'>
<font color=#447700>! recompute : tmpdz<a name='626'></font>
      a_moist(i,k+1,j,p_qv) = a_moist(i,k+1,j,p_qv)+a_bn2(i,k,j)*g*(1.61/tmpdz)<a name='627'>
      a_qvsfc = a_qvsfc+a_bn2(i,k,j)*g*((-1.61)/tmpdz)<a name='628'>
      a_theta(i,k+1,j) = a_theta(i,k+1,j)+a_bn2(i,k,j)*g*(1/theta(i,k,j)/tmpdz)<a name='629'>
      a_theta(i,k,j) = a_theta(i,k,j)+a_bn2(i,k,j)*g*(((-1)/theta(i,k,j)-(theta(i,k+1,j)-theta(i,k,j))/(theta(i,k,j)*theta(i,k,j)))&amp;<a name='630'>
&amp;/tmpdz)<a name='631'>
      a_tmp1(i,k+1,j) = a_tmp1(i,k+1,j)-a_bn2(i,k,j)*(g/tmpdz)<a name='632'>
      a_tmp1sfc(i,j) = a_tmp1sfc(i,j)+a_bn2(i,k,j)*(g/tmpdz)<a name='633'>
      a_bn2(i,k,j) = 0.<a name='634'>
      a_moist(i,3,j,p_qv) = a_moist(i,3,j,p_qv)+a_qvsfc*cf3<a name='635'>
      a_moist(i,2,j,p_qv) = a_moist(i,2,j,p_qv)+a_qvsfc*cf2<a name='636'>
      a_moist(i,1,j,p_qv) = a_moist(i,1,j,p_qv)+a_qvsfc*cf1<a name='637'>
      a_qvsfc = 0.<a name='638'>
    endif<a name='639'>
    a_p8w(i,k,j) = a_p8w(i,k,j)-a_thetasfc*(t8w(i,kts,j)/p1000mb*r_d/cp*(p8w(i,k,j)/p1000mb)**(r_d/cp-1)/((p8w(i,k,j)/p1000mb)**&amp;<a name='640'>
&amp;(r_d/cp)*(p8w(i,k,j)/p1000mb)**(r_d/cp)))<a name='641'>
    a_t8w(i,kts,j) = a_t8w(i,kts,j)+a_thetasfc/(p8w(i,k,j)/p1000mb)**(r_d/cp)<a name='642'>
    a_thetasfc = 0.<a name='643'>
  end do<a name='644'>
end do<a name='645'>
do j = j_start, j_end<a name='646'>
  a_coefa = 0.<a name='647'>
  a_thetaem1 = 0.<a name='648'>
  a_thetaep1 = 0.<a name='649'>
  a_xlvqv = 0.<a name='650'>
  do k = kts+1, ktf-1<a name='651'>
    a_coefa = 0.<a name='652'>
    a_thetaem1 = 0.<a name='653'>
    a_thetaep1 = 0.<a name='654'>
    a_xlvqv = 0.<a name='655'>
    do i = i_start, i_end<a name='656'>
      a_coefa = 0.<a name='657'>
      a_thetaem1 = 0.<a name='658'>
      a_thetaep1 = 0.<a name='659'>
      a_xlvqv = 0.<a name='660'>
      tmpdz = 1./rdz(i,k,j)+1./rdz(i,k+1,j)<a name='661'>
<font color=#447700>! recompute : tmpdz<a name='662'></font>
      if (moist(i,k,j,p_qv) .ge. qvs(i,k,j) .or. qctmp(i,k,j) .ge. qc_cr) then<a name='663'>
        xlvqv = xlv*moist(i,k,j,p_qv)<a name='664'>
<font color=#447700>! recompute : xlvqv<a name='665'></font>
        coefa = (1.+xlvqv/r_d/t(i,k,j))/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))/theta(i,k,j)<a name='666'>
<font color=#447700>! recompute : coefa<a name='667'></font>
        thetaep1 = theta(i,k+1,j)*(1.+xlv*qvs(i,k+1,j)/cp/t(i,k+1,j))<a name='668'>
<font color=#447700>! recompute : thetaep1<a name='669'></font>
        thetaem1 = theta(i,k-1,j)*(1.+xlv*qvs(i,k-1,j)/cp/t(i,k-1,j))<a name='670'>
<font color=#447700>! recompute : thetaem1<a name='671'></font>
        a_coefa = a_coefa+a_bn2(i,k,j)*g*((thetaep1-thetaem1)/tmpdz)<a name='672'>
        a_thetaem1 = a_thetaem1-a_bn2(i,k,j)*g*(coefa/tmpdz)<a name='673'>
        a_thetaep1 = a_thetaep1+a_bn2(i,k,j)*g*(coefa/tmpdz)<a name='674'>
        a_tmp1(i,k-1,j) = a_tmp1(i,k-1,j)+a_bn2(i,k,j)*(g/tmpdz)<a name='675'>
        a_tmp1(i,k+1,j) = a_tmp1(i,k+1,j)-a_bn2(i,k,j)*(g/tmpdz)<a name='676'>
        a_bn2(i,k,j) = 0.<a name='677'>
        a_qvs(i,k-1,j) = a_qvs(i,k-1,j)+a_thetaem1*theta(i,k-1,j)*(xlv/cp/t(i,k-1,j))<a name='678'>
        a_t(i,k-1,j) = a_t(i,k-1,j)-a_thetaem1*theta(i,k-1,j)*(xlv*qvs(i,k-1,j)/cp/(t(i,k-1,j)*t(i,k-1,j)))<a name='679'>
        a_theta(i,k-1,j) = a_theta(i,k-1,j)+a_thetaem1*(1+xlv*qvs(i,k-1,j)/cp/t(i,k-1,j))<a name='680'>
        a_thetaem1 = 0.<a name='681'>
        a_qvs(i,k+1,j) = a_qvs(i,k+1,j)+a_thetaep1*theta(i,k+1,j)*(xlv/cp/t(i,k+1,j))<a name='682'>
        a_t(i,k+1,j) = a_t(i,k+1,j)-a_thetaep1*theta(i,k+1,j)*(xlv*qvs(i,k+1,j)/cp/(t(i,k+1,j)*t(i,k+1,j)))<a name='683'>
        a_theta(i,k+1,j) = a_theta(i,k+1,j)+a_thetaep1*(1+xlv*qvs(i,k+1,j)/cp/t(i,k+1,j))<a name='684'>
        a_thetaep1 = 0.<a name='685'>
        a_t(i,k,j) = a_t(i,k,j)+a_coefa*(((-(xlvqv/r_d/(t(i,k,j)*t(i,k,j))/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))))+(1.+xlvqv/r_d/&amp;<a name='686'>
&amp;t(i,k,j))*(xlv*xlvqv/cp/r_v/(t(i,k,j)*t(i,k,j))/t(i,k,j)+xlv*xlvqv/cp/r_v/t(i,k,j)/(t(i,k,j)*t(i,k,j)))/((1.+xlv*xlvqv/cp/&amp;<a name='687'>
&amp;r_v/t(i,k,j)/t(i,k,j))*(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))))/theta(i,k,j))<a name='688'>
        a_theta(i,k,j) = a_theta(i,k,j)-a_coefa*((1.+xlvqv/r_d/t(i,k,j))/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))/(theta(i,k,j)*&amp;<a name='689'>
&amp;theta(i,k,j)))<a name='690'>
        a_xlvqv = a_xlvqv+a_coefa*((1/r_d/t(i,k,j)/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))-(1.+xlvqv/r_d/t(i,k,j))*(xlv/cp/r_v/t(i,&amp;<a name='691'>
&amp;k,j)/t(i,k,j))/((1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))*(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))))/theta(i,k,j))<a name='692'>
        a_coefa = 0.<a name='693'>
        a_moist(i,k,j,p_qv) = a_moist(i,k,j,p_qv)+a_xlvqv*xlv<a name='694'>
        a_xlvqv = 0.<a name='695'>
      else<a name='696'>
        a_moist(i,k-1,j,p_qv) = a_moist(i,k-1,j,p_qv)+a_bn2(i,k,j)*g*((-1.61)/tmpdz)<a name='697'>
        a_moist(i,k+1,j,p_qv) = a_moist(i,k+1,j,p_qv)+a_bn2(i,k,j)*g*(1.61/tmpdz)<a name='698'>
        a_theta(i,k-1,j) = a_theta(i,k-1,j)+a_bn2(i,k,j)*g*((-1)/theta(i,k,j)/tmpdz)<a name='699'>
        a_theta(i,k+1,j) = a_theta(i,k+1,j)+a_bn2(i,k,j)*g*(1/theta(i,k,j)/tmpdz)<a name='700'>
        a_theta(i,k,j) = a_theta(i,k,j)-a_bn2(i,k,j)*g*((theta(i,k+1,j)-theta(i,k-1,j))/(theta(i,k,j)*theta(i,k,j))/tmpdz)<a name='701'>
        a_tmp1(i,k-1,j) = a_tmp1(i,k-1,j)+a_bn2(i,k,j)*(g/tmpdz)<a name='702'>
        a_tmp1(i,k+1,j) = a_tmp1(i,k+1,j)-a_bn2(i,k,j)*(g/tmpdz)<a name='703'>
        a_bn2(i,k,j) = 0.<a name='704'>
      endif<a name='705'>
    end do<a name='706'>
  end do<a name='707'>
end do<a name='708'>
do j = j_start, j_end<a name='709'>
  a_es = 0.<a name='710'>
  a_tc = 0.<a name='711'>
  do k = kts, ktf<a name='712'>
    a_es = 0.<a name='713'>
    a_tc = 0.<a name='714'>
    do i = i_start, i_end<a name='715'>
      a_es = 0.<a name='716'>
      a_tc = 0.<a name='717'>
      tc = t(i,k,j)-svpt0<a name='718'>
<font color=#447700>! recompute : tc<a name='719'></font>
      es = 1000.*svp1*exp(svp2*tc/(t(i,k,j)-svp3))<a name='720'>
<font color=#447700>! recompute : es<a name='721'></font>
      a_es = a_es+a_qvs(i,k,j)*(ep_2/(p(i,k,j)-es)+ep_2*es/((p(i,k,j)-es)*(p(i,k,j)-es)))<a name='722'>
      a_p(i,k,j) = a_p(i,k,j)-a_qvs(i,k,j)*(ep_2*es/((p(i,k,j)-es)*(p(i,k,j)-es)))<a name='723'>
      a_qvs(i,k,j) = 0.<a name='724'>
      a_t(i,k,j) = a_t(i,k,j)-1000.*a_es*svp1*(svp2*tc/((t(i,k,j)-svp3)*(t(i,k,j)-svp3)))*exp(svp2*tc/(t(i,k,j)-svp3))<a name='725'>
      a_tc = a_tc+1000.*a_es*svp1*(svp2/(t(i,k,j)-svp3))*exp(svp2*tc/(t(i,k,j)-svp3))<a name='726'>
      a_es = 0.<a name='727'>
      a_t(i,k,j) = a_t(i,k,j)+a_tc<a name='728'>
      a_tc = 0.<a name='729'>
    end do<a name='730'>
  end do<a name='731'>
end do<a name='732'>
do ispe = n_moist, param_first_scalar, -1<a name='733'>
  if (ispe .eq. p_qv .or. ispe .eq. p_qc .or. ispe .eq. p_qi) then<a name='734'>
    do j = j_start, j_end<a name='735'>
      do i = i_start, i_end<a name='736'>
        a_moist(i,3,j,ispe) = a_moist(i,3,j,ispe)+a_tmp1sfc(i,j)*cf3<a name='737'>
        a_moist(i,2,j,ispe) = a_moist(i,2,j,ispe)+a_tmp1sfc(i,j)*cf2<a name='738'>
        a_moist(i,1,j,ispe) = a_moist(i,1,j,ispe)+a_tmp1sfc(i,j)*cf1<a name='739'>
      end do<a name='740'>
    end do<a name='741'>
    do j = j_start, j_end<a name='742'>
      do k = kts, ktf<a name='743'>
        do i = i_start, i_end<a name='744'>
          a_moist(i,k,j,ispe) = a_moist(i,k,j,ispe)+a_tmp1(i,k,j)<a name='745'>
        end do<a name='746'>
      end do<a name='747'>
    end do<a name='748'>
  endif<a name='749'>
end do<a name='750'>
if (p_qc .gt. param_first_scalar) then<a name='751'>
  do j = j_start, j_end<a name='752'>
    do k = kts, ktf<a name='753'>
      do i = i_start, i_end<a name='754'>
        a_moist(i,k,j,p_qc) = a_moist(i,k,j,p_qc)+a_qctmp(i,k,j)<a name='755'>
        a_qctmp(i,k,j) = 0.<a name='756'>
      end do<a name='757'>
    end do<a name='758'>
  end do<a name='759'>
endif<a name='760'>
<a name='761'>
end subroutine a_calculate_n2<a name='762'>
<a name='763'>
<a name='764'>
<A NAME='A_ISOTROPIC_KM'><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_ISOTROPIC_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='765'>
<font color=#993300>subroutine </font><font color=#cc0000>a_isotropic_km</font>( a_xkmhd, ide, jde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte ) <A href='../../call_to/A_ISOTROPIC_KM.html' TARGET='index'>1</A><a name='766'>
<font color=#447700>!******************************************************************<a name='767'></font>
<font color=#447700>!******************************************************************<a name='768'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='769'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='770'></font>
<font color=#447700>!******************************************************************<a name='771'></font>
<font color=#447700>!******************************************************************<a name='772'></font>
<font color=#447700>!==============================================<a name='773'></font>
<font color=#447700>! all entries are defined explicitly<a name='774'></font>
<font color=#447700>!==============================================<a name='775'></font>
implicit none<a name='776'>
<a name='777'>
<font color=#447700>!==============================================<a name='778'></font>
<font color=#447700>! declare arguments<a name='779'></font>
<font color=#447700>!==============================================<a name='780'></font>
integer, intent(in) :: ime<a name='781'>
integer, intent(in) :: ims<a name='782'>
integer, intent(in) :: jme<a name='783'>
integer, intent(in) :: jms<a name='784'>
integer, intent(in) :: kme<a name='785'>
integer, intent(in) :: kms<a name='786'>
real, intent(inout) :: a_xkmhd(ims:ime,kms:kme,jms:jme)<a name='787'>
integer, intent(in) :: ide<a name='788'>
integer, intent(in) :: ite<a name='789'>
integer, intent(in) :: its<a name='790'>
integer, intent(in) :: jde<a name='791'>
integer, intent(in) :: jte<a name='792'>
integer, intent(in) :: jts<a name='793'>
integer, intent(in) :: kte<a name='794'>
integer, intent(in) :: kts<a name='795'>
<a name='796'>
<font color=#447700>!==============================================<a name='797'></font>
<font color=#447700>! declare local variables<a name='798'></font>
<font color=#447700>!==============================================<a name='799'></font>
integer i<a name='800'>
integer i_end<a name='801'>
integer i_start<a name='802'>
integer j<a name='803'>
integer j_end<a name='804'>
integer j_start<a name='805'>
integer k<a name='806'>
integer ktf<a name='807'>
<a name='808'>
<font color=#447700>!----------------------------------------------<a name='809'></font>
<font color=#447700>! ROUTINE BODY<a name='810'></font>
<font color=#447700>!----------------------------------------------<a name='811'></font>
ktf = kte<a name='812'>
<font color=#447700>! recompute : ktf<a name='813'></font>
i_start = its<a name='814'>
<font color=#447700>! recompute : i_start<a name='815'></font>
i_end = min(ite,ide-1)<a name='816'>
<font color=#447700>! recompute : i_end<a name='817'></font>
j_start = jts<a name='818'>
<font color=#447700>! recompute : j_start<a name='819'></font>
j_end = min(jte,jde-1)<a name='820'>
<font color=#447700>! recompute : j_end<a name='821'></font>
do j = j_start, j_end<a name='822'>
  do k = kts, ktf<a name='823'>
    do i = i_start, i_end<a name='824'>
      a_xkmhd(i,k,j) = 0.<a name='825'>
    end do<a name='826'>
  end do<a name='827'>
end do<a name='828'>
<a name='829'>
end subroutine a_isotropic_km<a name='830'>
<a name='831'>
<a name='832'>
<A NAME='A_SMAG2D_KM'><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_SMAG2D_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='833'>
<font color=#993300>subroutine </font><font color=#cc0000>a_smag2d_km</font>( config_flags, xkmh, a_xkmh, a_xkmhd, defor11, defor22, defor12, dx, dy, ids, ide, jds, jde, kde, ims, ime, &amp; <A href='../../call_to/A_SMAG2D_KM.html' TARGET='index'>1</A><a name='834'>
&amp;jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='835'>
<font color=#447700>!******************************************************************<a name='836'></font>
<font color=#447700>!******************************************************************<a name='837'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='838'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='839'></font>
<font color=#447700>!******************************************************************<a name='840'></font>
<font color=#447700>!******************************************************************<a name='841'></font>
<font color=#447700>!==============================================<a name='842'></font>
<font color=#447700>! all entries are defined explicitly<a name='843'></font>
<font color=#447700>!==============================================<a name='844'></font>
implicit none<a name='845'>
<a name='846'>
<font color=#447700>!==============================================<a name='847'></font>
<font color=#447700>! declare arguments<a name='848'></font>
<font color=#447700>!==============================================<a name='849'></font>
integer, intent(in) :: ime<a name='850'>
integer, intent(in) :: ims<a name='851'>
integer, intent(in) :: jme<a name='852'>
integer, intent(in) :: jms<a name='853'>
integer, intent(in) :: kme<a name='854'>
integer, intent(in) :: kms<a name='855'>
real, intent(inout) :: a_xkmh(ims:ime,kms:kme,jms:jme)<a name='856'>
real, intent(inout) :: a_xkmhd(ims:ime,kms:kme,jms:jme)<a name='857'>
type (grid_config_rec_type), intent(in) :: config_flags<a name='858'>
real, intent(in) :: defor11(ims:ime,kms:kme,jms:jme)<a name='859'>
real, intent(in) :: defor12(ims:ime,kms:kme,jms:jme)<a name='860'>
real, intent(in) :: defor22(ims:ime,kms:kme,jms:jme)<a name='861'>
real, intent(in) :: dx<a name='862'>
real, intent(in) :: dy<a name='863'>
integer, intent(in) :: ide<a name='864'>
integer, intent(in) :: ids<a name='865'>
integer, intent(in) :: ite<a name='866'>
integer, intent(in) :: its<a name='867'>
integer, intent(in) :: jde<a name='868'>
integer, intent(in) :: jds<a name='869'>
integer, intent(in) :: jte<a name='870'>
integer, intent(in) :: jts<a name='871'>
integer, intent(in) :: kde<a name='872'>
integer, intent(in) :: kte<a name='873'>
integer, intent(in) :: kts<a name='874'>
real, intent(inout) :: xkmh(ims:ime,kms:kme,jms:jme)<a name='875'>
<a name='876'>
<font color=#447700>!==============================================<a name='877'></font>
<font color=#447700>! declare local variables<a name='878'></font>
<font color=#447700>!==============================================<a name='879'></font>
real def2(its:ite,kts:kte,jts:jte)<a name='880'>
integer i<a name='881'>
integer i_end<a name='882'>
integer i_start<a name='883'>
integer j<a name='884'>
integer j_end<a name='885'>
integer j_start<a name='886'>
integer k<a name='887'>
integer ktf<a name='888'>
real mlen_h<a name='889'>
real tmp<a name='890'>
<a name='891'>
<font color=#447700>!----------------------------------------------<a name='892'></font>
<font color=#447700>! ROUTINE BODY<a name='893'></font>
<font color=#447700>!----------------------------------------------<a name='894'></font>
ktf = min(kte,kde-1)<a name='895'>
<font color=#447700>! recompute : ktf<a name='896'></font>
i_start = its<a name='897'>
<font color=#447700>! recompute : i_start<a name='898'></font>
i_end = min(ite,ide-1)<a name='899'>
<font color=#447700>! recompute : i_end<a name='900'></font>
j_start = jts<a name='901'>
<font color=#447700>! recompute : j_start<a name='902'></font>
j_end = min(jte,jde-1)<a name='903'>
<font color=#447700>! recompute : j_end<a name='904'></font>
if (config_flags%open_xs .or. config_flags%specified .or. config_flags%nested) then<a name='905'>
  i_start = max(ids+1,its)<a name='906'>
endif<a name='907'>
<font color=#447700>! recompute : i_start<a name='908'></font>
if (config_flags%open_xe .or. config_flags%specified .or. config_flags%nested) then<a name='909'>
  i_end = min(ide-2,ite)<a name='910'>
endif<a name='911'>
<font color=#447700>! recompute : i_end<a name='912'></font>
if (config_flags%open_ys .or. config_flags%specified .or. config_flags%nested) then<a name='913'>
  j_start = max(jds+1,jts)<a name='914'>
endif<a name='915'>
<font color=#447700>! recompute : j_start<a name='916'></font>
if (config_flags%open_ye .or. config_flags%specified .or. config_flags%nested) then<a name='917'>
  j_end = min(jde-2,jte)<a name='918'>
endif<a name='919'>
<font color=#447700>! recompute : j_end<a name='920'></font>
do j = j_start, j_end<a name='921'>
  do k = kts, ktf<a name='922'>
    do i = i_start, i_end<a name='923'>
      def2(i,k,j) = 0.25*(defor11(i,k,j)-defor22(i,k,j))**2+defor12(i,k,j)*defor12(i,k,j)<a name='924'>
    end do<a name='925'>
  end do<a name='926'>
end do<a name='927'>
<font color=#447700>! recompute : def2<a name='928'></font>
mlen_h = sqrt(dx*dy)<a name='929'>
<font color=#447700>! recompute : mlen_h<a name='930'></font>
do j = j_start, j_end<a name='931'>
  do k = kts, ktf<a name='932'>
    do i = i_start, i_end<a name='933'>
      tmp = def2(i,k,j)**0.5<a name='934'>
<font color=#447700>! recompute : tmp<a name='935'></font>
      xkmh(i,k,j) = c_s*c_s*mlen_h*mlen_h*tmp<a name='936'>
<font color=#447700>! recompute : xkmh<a name='937'></font>
      a_xkmh(i,k,j) = a_xkmh(i,k,j)+a_xkmhd(i,k,j)<a name='938'>
      a_xkmhd(i,k,j) = 0.<a name='939'>
      a_xkmh(i,k,j) = a_xkmh(i,k,j)*(0.5+sign(0.5,10.*mlen_h-xkmh(i,k,j)))<a name='940'>
      a_xkmh(i,k,j) = 0.<a name='941'>
    end do<a name='942'>
  end do<a name='943'>
end do<a name='944'>
<a name='945'>
end subroutine a_smag2d_km<a name='946'>
<a name='947'>
<a name='948'>
<A NAME='A_SMAG_KM'><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_SMAG_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='949'>
<font color=#993300>subroutine </font><font color=#cc0000>a_smag_km</font>( config_flags, xkmh, a_xkmh, a_xkmhd, bn2, a_bn2, defor11, defor22, defor33, defor12, defor13, defor23, rdzw, &amp; <A href='../../call_to/A_SMAG_KM.html' TARGET='index'>1</A><a name='950'>
&amp;dx, dy, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='951'>
<font color=#447700>!******************************************************************<a name='952'></font>
<font color=#447700>!******************************************************************<a name='953'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='954'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='955'></font>
<font color=#447700>!******************************************************************<a name='956'></font>
<font color=#447700>!******************************************************************<a name='957'></font>
<font color=#447700>!==============================================<a name='958'></font>
<font color=#447700>! all entries are defined explicitly<a name='959'></font>
<font color=#447700>!==============================================<a name='960'></font>
implicit none<a name='961'>
<a name='962'>
<font color=#447700>!==============================================<a name='963'></font>
<font color=#447700>! declare arguments<a name='964'></font>
<font color=#447700>!==============================================<a name='965'></font>
integer, intent(in) :: ime<a name='966'>
integer, intent(in) :: ims<a name='967'>
integer, intent(in) :: jme<a name='968'>
integer, intent(in) :: jms<a name='969'>
integer, intent(in) :: kme<a name='970'>
integer, intent(in) :: kms<a name='971'>
real, intent(inout) :: a_bn2(ims:ime,kms:kme,jms:jme)<a name='972'>
real, intent(inout) :: a_xkmh(ims:ime,kms:kme,jms:jme)<a name='973'>
real, intent(inout) :: a_xkmhd(ims:ime,kms:kme,jms:jme)<a name='974'>
real, intent(in) :: bn2(ims:ime,kms:kme,jms:jme)<a name='975'>
type (grid_config_rec_type), intent(in) :: config_flags<a name='976'>
real, intent(in) :: defor11(ims:ime,kms:kme,jms:jme)<a name='977'>
real, intent(in) :: defor12(ims:ime,kms:kme,jms:jme)<a name='978'>
real, intent(in) :: defor13(ims:ime,kms:kme,jms:jme)<a name='979'>
real, intent(in) :: defor22(ims:ime,kms:kme,jms:jme)<a name='980'>
real, intent(in) :: defor23(ims:ime,kms:kme,jms:jme)<a name='981'>
real, intent(in) :: defor33(ims:ime,kms:kme,jms:jme)<a name='982'>
real, intent(in) :: dx<a name='983'>
real, intent(in) :: dy<a name='984'>
integer, intent(in) :: ide<a name='985'>
integer, intent(in) :: ids<a name='986'>
integer, intent(in) :: ite<a name='987'>
integer, intent(in) :: its<a name='988'>
integer, intent(in) :: jde<a name='989'>
integer, intent(in) :: jds<a name='990'>
integer, intent(in) :: jte<a name='991'>
integer, intent(in) :: jts<a name='992'>
integer, intent(in) :: kde<a name='993'>
integer, intent(in) :: kte<a name='994'>
integer, intent(in) :: kts<a name='995'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='996'>
real, intent(inout) :: xkmh(ims:ime,kms:kme,jms:jme)<a name='997'>
<a name='998'>
<font color=#447700>!==============================================<a name='999'></font>
<font color=#447700>! declare local variables<a name='1000'></font>
<font color=#447700>!==============================================<a name='1001'></font>
real a_tmp<a name='1002'>
real cr_len<a name='1003'>
real def2(its:ite,kts:kte,jts:jte)<a name='1004'>
real deltas<a name='1005'>
integer i<a name='1006'>
integer i_end<a name='1007'>
integer i_start<a name='1008'>
integer j<a name='1009'>
integer j_end<a name='1010'>
integer j_start<a name='1011'>
integer k<a name='1012'>
integer ktf<a name='1013'>
real mlen_h<a name='1014'>
real pr<a name='1015'>
real tmp<a name='1016'>
<a name='1017'>
<font color=#447700>!----------------------------------------------<a name='1018'></font>
<font color=#447700>! RESET LOCAL ADJOINT VARIABLES<a name='1019'></font>
<font color=#447700>!----------------------------------------------<a name='1020'></font>
a_tmp = 0.<a name='1021'>
<a name='1022'>
<font color=#447700>!----------------------------------------------<a name='1023'></font>
<font color=#447700>! ROUTINE BODY<a name='1024'></font>
<font color=#447700>!----------------------------------------------<a name='1025'></font>
ktf = min(kte,kde-1)<a name='1026'>
<font color=#447700>! recompute : ktf<a name='1027'></font>
i_start = its<a name='1028'>
<font color=#447700>! recompute : i_start<a name='1029'></font>
i_end = min(ite,ide-1)<a name='1030'>
<font color=#447700>! recompute : i_end<a name='1031'></font>
j_start = jts<a name='1032'>
<font color=#447700>! recompute : j_start<a name='1033'></font>
j_end = min(jte,jde-1)<a name='1034'>
<font color=#447700>! recompute : j_end<a name='1035'></font>
if (config_flags%open_xs .or. config_flags%specified .or. config_flags%nested) then<a name='1036'>
  i_start = max(ids+1,its)<a name='1037'>
endif<a name='1038'>
<font color=#447700>! recompute : i_start<a name='1039'></font>
if (config_flags%open_xe .or. config_flags%specified .or. config_flags%nested) then<a name='1040'>
  i_end = min(ide-2,ite)<a name='1041'>
endif<a name='1042'>
<font color=#447700>! recompute : i_end<a name='1043'></font>
if (config_flags%open_ys .or. config_flags%specified .or. config_flags%nested) then<a name='1044'>
  j_start = max(jds+1,jts)<a name='1045'>
endif<a name='1046'>
<font color=#447700>! recompute : j_start<a name='1047'></font>
if (config_flags%open_ye .or. config_flags%specified .or. config_flags%nested) then<a name='1048'>
  j_end = min(jde-2,jte)<a name='1049'>
endif<a name='1050'>
<font color=#447700>! recompute : j_end<a name='1051'></font>
pr = 1./3.<a name='1052'>
<font color=#447700>! recompute : pr<a name='1053'></font>
do j = j_start, j_end<a name='1054'>
  do k = kts, ktf<a name='1055'>
    do i = i_start, i_end<a name='1056'>
      def2(i,k,j) = 0.5*(defor11(i,k,j)*defor11(i,k,j)+defor22(i,k,j)*defor22(i,k,j)+defor33(i,k,j)*defor33(i,k,j))<a name='1057'>
    end do<a name='1058'>
  end do<a name='1059'>
end do<a name='1060'>
<font color=#447700>! recompute : def2<a name='1061'></font>
do j = j_start, j_end<a name='1062'>
  do k = kts, ktf<a name='1063'>
    do i = i_start, i_end<a name='1064'>
      tmp = 0.25*(defor12(i,k,j)+defor12(i,k,j+1)+defor12(i+1,k,j)+defor12(i+1,k,j+1))<a name='1065'>
      def2(i,k,j) = def2(i,k,j)+0.5*tmp*tmp<a name='1066'>
    end do<a name='1067'>
  end do<a name='1068'>
end do<a name='1069'>
<font color=#447700>! recompute : def2<a name='1070'></font>
do j = j_start, j_end<a name='1071'>
  do k = kts, ktf<a name='1072'>
    do i = i_start, i_end<a name='1073'>
      tmp = 0.25*(defor13(i,k+1,j)+defor13(i,k,j)+defor13(i+1,k+1,j)+defor13(i+1,k,j))<a name='1074'>
      def2(i,k,j) = def2(i,k,j)+0.5*tmp*tmp<a name='1075'>
    end do<a name='1076'>
  end do<a name='1077'>
end do<a name='1078'>
<font color=#447700>! recompute : def2<a name='1079'></font>
do j = j_start, j_end<a name='1080'>
  do k = kts, ktf<a name='1081'>
    do i = i_start, i_end<a name='1082'>
      tmp = 0.25*(defor23(i,k+1,j)+defor23(i,k,j)+defor23(i,k+1,j+1)+defor23(i,k,j+1))<a name='1083'>
      def2(i,k,j) = def2(i,k,j)+0.5*tmp*tmp<a name='1084'>
    end do<a name='1085'>
  end do<a name='1086'>
end do<a name='1087'>
<font color=#447700>! recompute : def2<a name='1088'></font>
cr_len = dx+1.<a name='1089'>
<font color=#447700>! recompute : cr_len<a name='1090'></font>
if (dx .gt. cr_len) then<a name='1091'>
  mlen_h = sqrt(dx*dy)<a name='1092'>
<font color=#447700>! recompute : mlen_h<a name='1093'></font>
  do j = j_start, j_end<a name='1094'>
    a_tmp = 0.<a name='1095'>
    do k = kts, ktf<a name='1096'>
      a_tmp = 0.<a name='1097'>
      do i = i_start, i_end<a name='1098'>
        a_tmp = 0.<a name='1099'>
        tmp = max(0.,def2(i,k,j)-bn2(i,k,j)/pr)<a name='1100'>
<font color=#447700>! recompute : tmp<a name='1101'></font>
        tmp = tmp**0.5<a name='1102'>
<font color=#447700>! recompute : tmp<a name='1103'></font>
        xkmh(i,k,j) = max(c_s*c_s*mlen_h*mlen_h*tmp,1.e-6*mlen_h*mlen_h)<a name='1104'>
<font color=#447700>! recompute : xkmh<a name='1105'></font>
        a_xkmh(i,k,j) = a_xkmh(i,k,j)+a_xkmhd(i,k,j)<a name='1106'>
        a_xkmhd(i,k,j) = 0.<a name='1107'>
        a_xkmh(i,k,j) = a_xkmh(i,k,j)*(0.5+sign(0.5,10.*mlen_h-xkmh(i,k,j)))<a name='1108'>
        a_tmp = a_tmp+a_xkmh(i,k,j)*(0.5+sign(0.5,c_s*c_s*mlen_h*mlen_h*tmp-1.e-6*mlen_h*mlen_h))*c_s*c_s*mlen_h*mlen_h<a name='1109'>
        a_xkmh(i,k,j) = 0.<a name='1110'>
<font color=#447700>! recdepend vars : bn2,def2,i,j,k,pr<a name='1111'></font>
<font color=#447700>! recompute pos : ASSIGN_STMT module_diffusion_em.f90:1516<a name='1112'></font>
<font color=#447700>! recompute vars : tmp<a name='1113'></font>
        tmp = max(0.,def2(i,k,j)-bn2(i,k,j)/pr)<a name='1114'>
<font color=#447700>! recompute vars : tmp<a name='1115'></font>
        a_tmp = 0.5*a_tmp*tmp**(-0.5)<a name='1116'>
        a_bn2(i,k,j) = a_bn2(i,k,j)-a_tmp*((0.5-sign(0.5,0.-(def2(i,k,j)-bn2(i,k,j)/pr)))/pr)<a name='1117'>
        a_tmp = 0.<a name='1118'>
      end do<a name='1119'>
    end do<a name='1120'>
  end do<a name='1121'>
else<a name='1122'>
  do j = j_start, j_end<a name='1123'>
    a_tmp = 0.<a name='1124'>
    do k = kts, ktf<a name='1125'>
      a_tmp = 0.<a name='1126'>
      do i = i_start, i_end<a name='1127'>
        a_tmp = 0.<a name='1128'>
        deltas = (dx*dy/rdzw(i,k,j))**0.33333333<a name='1129'>
<font color=#447700>! recompute : deltas<a name='1130'></font>
        tmp = max(0.,def2(i,k,j)-bn2(i,k,j)/pr)<a name='1131'>
<font color=#447700>! recompute : tmp<a name='1132'></font>
        tmp = tmp**0.5<a name='1133'>
<font color=#447700>! recompute : tmp<a name='1134'></font>
        xkmh(i,k,j) = max(c_s*c_s*deltas*deltas*tmp,1.e-6*deltas*deltas)<a name='1135'>
<font color=#447700>! recompute : xkmh<a name='1136'></font>
        a_xkmh(i,k,j) = a_xkmh(i,k,j)+a_xkmhd(i,k,j)<a name='1137'>
        a_xkmhd(i,k,j) = 0.<a name='1138'>
        a_xkmh(i,k,j) = a_xkmh(i,k,j)*(0.5+sign(0.5,10.*deltas-xkmh(i,k,j)))<a name='1139'>
        a_tmp = a_tmp+a_xkmh(i,k,j)*(0.5+sign(0.5,c_s*c_s*deltas*deltas*tmp-1.e-6*deltas*deltas))*c_s*c_s*deltas*deltas<a name='1140'>
        a_xkmh(i,k,j) = 0.<a name='1141'>
<font color=#447700>! recdepend vars : bn2,def2,i,j,k,pr<a name='1142'></font>
<font color=#447700>! recompute pos : ASSIGN_STMT module_diffusion_em.f90:1533<a name='1143'></font>
<font color=#447700>! recompute vars : tmp<a name='1144'></font>
        tmp = max(0.,def2(i,k,j)-bn2(i,k,j)/pr)<a name='1145'>
<font color=#447700>! recompute vars : tmp<a name='1146'></font>
        a_tmp = 0.5*a_tmp*tmp**(-0.5)<a name='1147'>
        a_bn2(i,k,j) = a_bn2(i,k,j)-a_tmp*((0.5-sign(0.5,0.-(def2(i,k,j)-bn2(i,k,j)/pr)))/pr)<a name='1148'>
        a_tmp = 0.<a name='1149'>
      end do<a name='1150'>
    end do<a name='1151'>
  end do<a name='1152'>
endif<a name='1153'>
<a name='1154'>
end subroutine a_smag_km<a name='1155'>
<a name='1156'>
<a name='1157'>
<A NAME='A_TKE_KM'><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_TKE_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1158'>
<font color=#993300>subroutine </font><font color=#cc0000>a_tke_km</font>( config_flags, xkmh, a_xkmh, a_xkmhd, bn2, a_bn2, tke, rdzw, dx, dy, kh_tke_upper_bound, ids, ide, jds, jde, &amp; <A href='../../call_to/A_TKE_KM.html' TARGET='index'>1</A>,<A href='../../call_from/A_TKE_KM.html' TARGET='index'>2</A><a name='1159'>
&amp;kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='1160'>
<font color=#447700>!******************************************************************<a name='1161'></font>
<font color=#447700>!******************************************************************<a name='1162'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='1163'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='1164'></font>
<font color=#447700>!******************************************************************<a name='1165'></font>
<font color=#447700>!******************************************************************<a name='1166'></font>
<font color=#447700>!==============================================<a name='1167'></font>
<font color=#447700>! all entries are defined explicitly<a name='1168'></font>
<font color=#447700>!==============================================<a name='1169'></font>
implicit none<a name='1170'>
<a name='1171'>
<font color=#447700>!==============================================<a name='1172'></font>
<font color=#447700>! declare parameters<a name='1173'></font>
<font color=#447700>!==============================================<a name='1174'></font>
real epsilon<a name='1175'>
parameter ( epsilon = 1.e-10 )<a name='1176'>
real tke_seed_value<a name='1177'>
parameter ( tke_seed_value = 1.e-6 )<a name='1178'>
<a name='1179'>
<font color=#447700>!==============================================<a name='1180'></font>
<font color=#447700>! declare arguments<a name='1181'></font>
<font color=#447700>!==============================================<a name='1182'></font>
integer, intent(in) :: ime<a name='1183'>
integer, intent(in) :: ims<a name='1184'>
integer, intent(in) :: jme<a name='1185'>
integer, intent(in) :: jms<a name='1186'>
integer, intent(in) :: kme<a name='1187'>
integer, intent(in) :: kms<a name='1188'>
real, intent(inout) :: a_bn2(ims:ime,kms:kme,jms:jme)<a name='1189'>
real, intent(inout) :: a_xkmh(ims:ime,kms:kme,jms:jme)<a name='1190'>
real, intent(inout) :: a_xkmhd(ims:ime,kms:kme,jms:jme)<a name='1191'>
real, intent(in) :: bn2(ims:ime,kms:kme,jms:jme)<a name='1192'>
type (grid_config_rec_type), intent(in) :: config_flags<a name='1193'>
real, intent(in) :: dx<a name='1194'>
real, intent(in) :: dy<a name='1195'>
integer, intent(in) :: ide<a name='1196'>
integer, intent(in) :: ids<a name='1197'>
integer, intent(in) :: ite<a name='1198'>
integer, intent(in) :: its<a name='1199'>
integer, intent(in) :: jde<a name='1200'>
integer, intent(in) :: jds<a name='1201'>
integer, intent(in) :: jte<a name='1202'>
integer, intent(in) :: jts<a name='1203'>
integer, intent(in) :: kde<a name='1204'>
real, intent(in) :: kh_tke_upper_bound<a name='1205'>
integer, intent(in) :: kte<a name='1206'>
integer, intent(in) :: kts<a name='1207'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='1208'>
real, intent(in) :: tke(ims:ime,kms:kme,jms:jme)<a name='1209'>
real, intent(inout) :: xkmh(ims:ime,kms:kme,jms:jme)<a name='1210'>
<a name='1211'>
<font color=#447700>!==============================================<a name='1212'></font>
<font color=#447700>! declare local variables<a name='1213'></font>
<font color=#447700>!==============================================<a name='1214'></font>
real a_l_scale(its:ite,kts:kte,jts:jte)<a name='1215'>
real cr_len<a name='1216'>
integer i<a name='1217'>
integer i_end<a name='1218'>
integer i_start<a name='1219'>
integer j<a name='1220'>
integer j_end<a name='1221'>
integer j_start<a name='1222'>
integer k<a name='1223'>
integer kds<a name='1224'>
integer ktf<a name='1225'>
real l_scale(its:ite,kts:kte,jts:jte)<a name='1226'>
real mlen_h<a name='1227'>
real tke_seed<a name='1228'>
real tmp<a name='1229'>
<a name='1230'>
<font color=#447700>!----------------------------------------------<a name='1231'></font>
<font color=#447700>! RESET LOCAL ADJOINT VARIABLES<a name='1232'></font>
<font color=#447700>!----------------------------------------------<a name='1233'></font>
a_l_scale(:,:,:) = 0.<a name='1234'>
<a name='1235'>
<font color=#447700>!----------------------------------------------<a name='1236'></font>
<font color=#447700>! ROUTINE BODY<a name='1237'></font>
<font color=#447700>!----------------------------------------------<a name='1238'></font>
ktf = min(kte,kde-1)<a name='1239'>
<font color=#447700>! recompute : ktf<a name='1240'></font>
i_start = its<a name='1241'>
<font color=#447700>! recompute : i_start<a name='1242'></font>
i_end = min(ite,ide-1)<a name='1243'>
<font color=#447700>! recompute : i_end<a name='1244'></font>
j_start = jts<a name='1245'>
<font color=#447700>! recompute : j_start<a name='1246'></font>
j_end = min(jte,jde-1)<a name='1247'>
<font color=#447700>! recompute : j_end<a name='1248'></font>
if (config_flags%open_xs .or. config_flags%specified .or. config_flags%nested) then<a name='1249'>
  i_start = max(ids+1,its)<a name='1250'>
endif<a name='1251'>
<font color=#447700>! recompute : i_start<a name='1252'></font>
if (config_flags%open_xe .or. config_flags%specified .or. config_flags%nested) then<a name='1253'>
  i_end = min(ide-2,ite)<a name='1254'>
endif<a name='1255'>
<font color=#447700>! recompute : i_end<a name='1256'></font>
if (config_flags%open_ys .or. config_flags%specified .or. config_flags%nested) then<a name='1257'>
  j_start = max(jds+1,jts)<a name='1258'>
endif<a name='1259'>
<font color=#447700>! recompute : j_start<a name='1260'></font>
if (config_flags%open_ye .or. config_flags%specified .or. config_flags%nested) then<a name='1261'>
  j_end = min(jde-2,jte)<a name='1262'>
endif<a name='1263'>
<font color=#447700>! recompute : j_end<a name='1264'></font>
tke_seed = tke_seed_value<a name='1265'>
<font color=#447700>! recompute : tke_seed<a name='1266'></font>
if (config_flags%tke_drag_coefficient .gt. epsilon .or. config_flags%tke_heat_flux .gt. epsilon) then<a name='1267'>
  tke_seed = 0.<a name='1268'>
endif<a name='1269'>
<font color=#447700>! recompute : tke_seed<a name='1270'></font>
cr_len = dx+1.<a name='1271'>
<font color=#447700>! recompute : cr_len<a name='1272'></font>
if (dx .gt. cr_len) then<a name='1273'>
  mlen_h = sqrt(dx*dy)<a name='1274'>
<font color=#447700>! recompute : mlen_h<a name='1275'></font>
  do j = j_start, j_end<a name='1276'>
    do k = kts, ktf<a name='1277'>
      do i = i_start, i_end<a name='1278'>
        tmp = sqrt(max(tke(i,k,j),tke_seed))<a name='1279'>
<font color=#447700>! recompute : tmp<a name='1280'></font>
        xkmh(i,k,j) = max(c_k*tmp*mlen_h,1.e-6*mlen_h*mlen_h)<a name='1281'>
<font color=#447700>! recompute : xkmh<a name='1282'></font>
        a_xkmh(i,k,j) = a_xkmh(i,k,j)+a_xkmhd(i,k,j)<a name='1283'>
        a_xkmhd(i,k,j) = 0.<a name='1284'>
        a_xkmh(i,k,j) = a_xkmh(i,k,j)*(0.5+sign(0.5,10.*mlen_h-xkmh(i,k,j)))<a name='1285'>
        a_xkmh(i,k,j) = 0.<a name='1286'>
      end do<a name='1287'>
    end do<a name='1288'>
  end do<a name='1289'>
else<a name='1290'>
  call <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALC_L_SCALE'>calc_l_scale</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_TKE_KM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_L_SCALE_3">( config_flags,tke,bn2,l_scale,i_start,i_end,ktf,j_start,j_end,dx,dy,rdzw,ids,ide,jds,jde,kds,kde,ims,ime,jms,&amp;<a name='1291'>
&amp;jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='1292'>
<font color=#447700>! recompute : l_scale<a name='1293'></font>
  do j = j_start, j_end<a name='1294'>
    do k = kts, ktf<a name='1295'>
      do i = i_start, i_end<a name='1296'>
        tmp = sqrt(max(tke(i,k,j),tke_seed))<a name='1297'>
<font color=#447700>! recompute : tmp<a name='1298'></font>
        xkmh(i,k,j) = c_k*tmp*l_scale(i,k,j)<a name='1299'>
<font color=#447700>! recompute : xkmh<a name='1300'></font>
        a_xkmh(i,k,j) = a_xkmh(i,k,j)+a_xkmhd(i,k,j)<a name='1301'>
        a_xkmhd(i,k,j) = 0.<a name='1302'>
        a_xkmh(i,k,j) = a_xkmh(i,k,j)*(0.5-sign(0.5,xkmh(i,k,j)-kh_tke_upper_bound))<a name='1303'>
        a_l_scale(i,k,j) = a_l_scale(i,k,j)+a_xkmh(i,k,j)*c_k*tmp<a name='1304'>
        a_xkmh(i,k,j) = 0.<a name='1305'>
      end do<a name='1306'>
    end do<a name='1307'>
  end do<a name='1308'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALC_L_SCALE'>a_calc_l_scale</A><A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_TKE_KM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_CALC_L_SCALE_1">( tke,bn2,a_bn2,l_scale,a_l_scale,i_start,i_end,ktf,j_start,j_end,dx,dy,rdzw,ims,ime,jms,jme,kms,kme,its,ite,&amp;<a name='1309'>
&amp;jts,jte,kts,kte )<a name='1310'>
endif<a name='1311'>
<a name='1312'>
end subroutine a_tke_km<a name='1313'>
<a name='1314'>
<a name='1315'>
end module     a_module_diffusion_em<a name='1316'>
<a name='1317'>
<a name='1318'>
</pre></body></html>