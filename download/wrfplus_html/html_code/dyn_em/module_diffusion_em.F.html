<HTML> <BODY BGCOLOR=#cceeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>! WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
 <a name='3'>
<A NAME='MODULE_DIFFUSION_EM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#MODULE_DIFFUSION_EM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
    <font color=#993300>MODULE </font><font color=#cc0000>module_diffusion_em</font> <A href='../../call_to/MODULE_DIFFUSION_EM.html' TARGET='index'>7</A><a name='5'>
<a name='6'>
    USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#module_diffusion_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_11"><a name='7'>
    USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#module_diffusion_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_10"><a name='8'>
    USE module_state_description<a name='9'>
    USE <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#module_diffusion_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_5"><a name='10'>
    USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#module_diffusion_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_7">    <a name='11'>
    USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#module_diffusion_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_9"><a name='12'>
<a name='13'>
    CONTAINS<a name='14'>
<a name='15'>
<font color=#447700>!=======================================================================<a name='16'></font>
<font color=#447700>!=======================================================================<a name='17'></font>
<a name='18'>
<A NAME='CAL_DEFORM_AND_DIV'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_DEFORM_AND_DIV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='19'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_deform_and_div</font>( config_flags, u, v, w, div,       &amp; <A href='../../call_to/CAL_DEFORM_AND_DIV.html' TARGET='index'>3</A><a name='20'>
                                   defor11, defor22, defor33,        &amp;<a name='21'>
                                   defor12, defor13, defor23,        &amp;<a name='22'>
                                   u_base, v_base,msfu, msfv, msft,  &amp;<a name='23'>
                                   rdx, rdy, dn, dnw, rdz, rdzw,     &amp;<a name='24'>
                                   fnm, fnp, cf1, cf2, cf3, zx, zy,  &amp;<a name='25'>
                                   ids, ide, jds, jde, kds, kde,     &amp;<a name='26'>
                                   ims, ime, jms, jme, kms, kme,     &amp;<a name='27'>
                                   its, ite, jts, jte, kts, kte      )<a name='28'>
<a name='29'>
<font color=#447700>! History:     Sep 2003  Changes by Jason Knievel and George Bryan, NCAR<a name='30'></font>
<font color=#447700>!              Oct 2001  Converted to mass core by Bill Skamarock, NCAR<a name='31'></font>
<font color=#447700>!              ...        ...<a name='32'></font>
<a name='33'>
<font color=#447700>! Purpose:     This routine calculates deformation and 3-d divergence.<a name='34'></font>
<a name='35'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='36'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='37'></font>
<a name='38'>
<font color=#447700>!-----------------------------------------------------------------------<a name='39'></font>
<font color=#447700>! Begin declarations.<a name='40'></font>
<a name='41'>
    IMPLICIT NONE<a name='42'>
<a name='43'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='44'>
    :: config_flags<a name='45'>
<a name='46'>
    INTEGER, INTENT( IN )  &amp;<a name='47'>
    :: ids, ide, jds, jde, kds, kde, &amp;<a name='48'>
       ims, ime, jms, jme, kms, kme, &amp;<a name='49'>
       its, ite, jts, jte, kts, kte<a name='50'>
<a name='51'>
    REAL, INTENT( IN )  &amp;<a name='52'>
    :: rdx, rdy, cf1, cf2, cf3<a name='53'>
<a name='54'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='55'>
    :: fnm, fnp, dn, dnw, u_base, v_base<a name='56'>
<a name='57'>
    REAL, DIMENSION( ims:ime , jms:jme ),  INTENT( IN )  &amp;<a name='58'>
    :: msfu, msfv, msft<a name='59'>
<a name='60'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='61'>
    ::  u, v, w, zx, zy, rdz, rdzw<a name='62'>
<a name='63'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='64'>
    :: defor11, defor22, defor33, defor12, defor13, defor23, div <a name='65'>
<a name='66'>
<font color=#447700>! Local variables.<a name='67'></font>
<a name='68'>
    INTEGER  &amp;<a name='69'>
    :: i, j, k, ktf, ktes1, ktes2, i_start, i_end, j_start, j_end<a name='70'>
<a name='71'>
    REAL  &amp;<a name='72'>
    :: tmp, tmpzx, tmpzy, tmpzeta_z, cft1, cft2<a name='73'>
<a name='74'>
    REAL, DIMENSION( its:ite, jts:jte )  &amp;<a name='75'>
    :: mm, zzavg, zeta_zd12<a name='76'>
<a name='77'>
    REAL, DIMENSION( its-2:ite+2, kts:kte, jts-2:jte+2 )  &amp;<a name='78'>
    :: tmp1, hat, hatavg<a name='79'>
<a name='80'>
<font color=#447700>! End declarations.<a name='81'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='82'></font>
<a name='83'>
<font color=#447700>!=======================================================================<a name='84'></font>
<font color=#447700>! In the following section, calculate 3-d divergence and the first three<a name='85'></font>
<font color=#447700>! (defor11, defor22, defor33) of six deformation terms.<a name='86'></font>
<a name='87'>
    ktes1   = kte-1<a name='88'>
    ktes2   = kte-2<a name='89'>
<a name='90'>
    cft2    = - 0.5 * dnw(ktes1) / dn(ktes1)<a name='91'>
    cft1    = 1.0 - cft2<a name='92'>
<a name='93'>
    ktf     = MIN( kte, kde-1 )<a name='94'>
<a name='95'>
    i_start = its<a name='96'>
    i_end   = MIN( ite, ide-1 )<a name='97'>
    j_start = jts<a name='98'>
    j_end   = MIN( jte, jde-1 )<a name='99'>
<a name='100'>
<font color=#447700>! Square the map scale factor.<a name='101'></font>
<a name='102'>
    DO j = j_start, j_end<a name='103'>
    DO i = i_start, i_end<a name='104'>
      mm(i,j) = msft(i,j) * msft(i,j)<a name='105'>
    END DO<a name='106'>
    END DO<a name='107'>
<a name='108'>
<font color=#447700>!-----------------------------------------------------------------------<a name='109'></font>
<font color=#447700>! Calculate du/dx.<a name='110'></font>
<a name='111'>
<font color=#447700>! Apply a coordinate transformation to zonal velocity, u.<a name='112'></font>
<a name='113'>
    DO j = j_start, j_end<a name='114'>
    DO k = kts, ktf<a name='115'>
    DO i = i_start, i_end+1<a name='116'>
      hat(i,k,j) = u(i,k,j) / msfu(i,j)<a name='117'>
    END DO<a name='118'>
    END DO<a name='119'>
    END DO<a name='120'>
<a name='121'>
<font color=#447700>! Average in x and z.<a name='122'></font>
<a name='123'>
    DO j=j_start,j_end<a name='124'>
    DO k=kts+1,ktf<a name='125'>
    DO i=i_start,i_end<a name='126'>
      hatavg(i,k,j) = 0.5 *  &amp;<a name='127'>
                    ( fnm(k) * ( hat(i,k  ,j) + hat(i+1,  k,j) ) +  &amp;<a name='128'>
                      fnp(k) * ( hat(i,k-1,j) + hat(i+1,k-1,j) ) )<a name='129'>
    END DO<a name='130'>
    END DO<a name='131'>
    END DO<a name='132'>
<a name='133'>
<font color=#447700>! Extrapolate to top and bottom of domain (to w levels).<a name='134'></font>
<a name='135'>
    DO j = j_start, j_end<a name='136'>
    DO i = i_start, i_end<a name='137'>
      hatavg(i,1,j)   =  0.5 * (  &amp;<a name='138'>
                         cf1 * hat(i  ,1,j) +  &amp;<a name='139'>
                         cf2 * hat(i  ,2,j) +  &amp;<a name='140'>
                         cf3 * hat(i  ,3,j) +  &amp;<a name='141'>
                         cf1 * hat(i+1,1,j) +  &amp;<a name='142'>
                         cf2 * hat(i+1,2,j) +  &amp;<a name='143'>
                         cf3 * hat(i+1,3,j) )<a name='144'>
      hatavg(i,kte,j) =  0.5 * (  &amp;<a name='145'>
                        cft1 * ( hat(i,ktes1,j) + hat(i+1,ktes1,j) )  +  &amp;<a name='146'>
                        cft2 * ( hat(i,ktes2,j) + hat(i+1,ktes2,j) ) )<a name='147'>
    END DO<a name='148'>
    END DO<a name='149'>
<a name='150'>
    DO j = j_start, j_end<a name='151'>
    DO k = kts, ktf<a name='152'>
    DO i = i_start, i_end<a name='153'>
      tmpzx       = 0.25 * (  &amp;<a name='154'>
                    zx(i,k  ,j) + zx(i+1,k  ,j) +  &amp;<a name='155'>
                    zx(i,k+1,j) + zx(i+1,k+1,j) )<a name='156'>
      tmp1(i,k,j) = ( hatavg(i,k+1,j) - hatavg(i,k,j) ) *tmpzx * rdzw(i,k,j)<a name='157'>
    END DO<a name='158'>
    END DO<a name='159'>
    END DO<a name='160'>
<a name='161'>
    DO j = j_start, j_end<a name='162'>
    DO k = kts, ktf<a name='163'>
    DO i = i_start, i_end<a name='164'>
      tmp1(i,k,j) = mm(i,j) * ( rdx * ( hat(i+1,k,j) - hat(i,k,j) ) -  &amp;<a name='165'>
                    tmp1(i,k,j))<a name='166'>
    END DO<a name='167'>
    END DO<a name='168'>
    END DO<a name='169'>
<a name='170'>
<font color=#447700>! End calculation of du/dx.<a name='171'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='172'></font>
<a name='173'>
<font color=#447700>!-----------------------------------------------------------------------<a name='174'></font>
<font color=#447700>! Calculate defor11 (2*du/dx).<a name='175'></font>
<a name='176'>
    DO j = j_start, j_end<a name='177'>
    DO k = kts, ktf<a name='178'>
    DO i = i_start, i_end<a name='179'>
      defor11(i,k,j) = 2.0 * tmp1(i,k,j)<a name='180'>
    END DO<a name='181'>
    END DO<a name='182'>
    END DO<a name='183'>
<a name='184'>
<font color=#447700>! End calculation of defor11.<a name='185'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='186'></font>
<a name='187'>
<font color=#447700>!-----------------------------------------------------------------------<a name='188'></font>
<font color=#447700>! Calculate zonal divergence (du/dx) and add it to the divergence array.<a name='189'></font>
<a name='190'>
    DO j = j_start, j_end<a name='191'>
    DO k = kts, ktf<a name='192'>
    DO i = i_start, i_end<a name='193'>
      div(i,k,j) = tmp1(i,k,j)<a name='194'>
    END DO<a name='195'>
    END DO<a name='196'>
    END DO<a name='197'>
<a name='198'>
<font color=#447700>! End calculation of zonal divergence.<a name='199'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='200'></font>
<a name='201'>
<font color=#447700>!-----------------------------------------------------------------------<a name='202'></font>
<font color=#447700>! Calculate dv/dy.<a name='203'></font>
<a name='204'>
<font color=#447700>! Apply a coordinate transformation to meridional velocity, v.<a name='205'></font>
<a name='206'>
    DO j = j_start, j_end+1<a name='207'>
    DO k = kts, ktf<a name='208'>
    DO i = i_start, i_end<a name='209'>
      hat(i,k,j) = v(i,k,j) / msfv(i,j)<a name='210'>
    END DO<a name='211'>
    END DO<a name='212'>
    END DO<a name='213'>
<a name='214'>
<font color=#447700>! Account for the slope in y of eta surfaces.<a name='215'></font>
<a name='216'>
    DO j=j_start,j_end<a name='217'>
    DO k=kts+1,ktf<a name='218'>
    DO i=i_start,i_end<a name='219'>
      hatavg(i,k,j) = 0.5 * (  &amp;<a name='220'>
                      fnm(k) * ( hat(i,k  ,j) + hat(i,k  ,j+1) ) +  &amp;<a name='221'>
                      fnp(k) * ( hat(i,k-1,j) + hat(i,k-1,j+1) ) )<a name='222'>
    END DO<a name='223'>
    END DO<a name='224'>
    END DO<a name='225'>
<a name='226'>
<font color=#447700>! Extrapolate to top and bottom of domain (to w levels).<a name='227'></font>
<a name='228'>
    DO j = j_start, j_end<a name='229'>
    DO i = i_start, i_end<a name='230'>
      hatavg(i,1,j)   =  0.5 * (  &amp;<a name='231'>
                         cf1 * hat(i,1,j  ) +  &amp;<a name='232'>
                         cf2 * hat(i,2,j  ) +  &amp;<a name='233'>
                         cf3 * hat(i,3,j  ) +  &amp;<a name='234'>
                         cf1 * hat(i,1,j+1) +  &amp;<a name='235'>
                         cf2 * hat(i,2,j+1) +  &amp;<a name='236'>
                         cf3 * hat(i,3,j+1) )<a name='237'>
      hatavg(i,kte,j) =  0.5 * (  &amp;<a name='238'>
                        cft1 * ( hat(i,ktes1,j) + hat(i,ktes1,j+1) ) +  &amp;<a name='239'>
                        cft2 * ( hat(i,ktes2,j) + hat(i,ktes2,j+1) ) )<a name='240'>
    END DO<a name='241'>
    END DO<a name='242'>
<a name='243'>
    DO j = j_start, j_end<a name='244'>
    DO k = kts, ktf<a name='245'>
    DO i = i_start, i_end<a name='246'>
      tmpzy       =  0.25 * (  &amp;<a name='247'>
                     zy(i,k  ,j) + zy(i,k  ,j+1) +  &amp;<a name='248'>
                     zy(i,k+1,j) + zy(i,k+1,j+1)  )<a name='249'>
      tmp1(i,k,j) = ( hatavg(i,k+1,j) - hatavg(i,k,j) ) * tmpzy * rdzw(i,k,j)<a name='250'>
    END DO<a name='251'>
    END DO<a name='252'>
    END DO<a name='253'>
<a name='254'>
    DO j = j_start, j_end<a name='255'>
    DO k = kts, ktf<a name='256'>
    DO i = i_start, i_end<a name='257'>
      tmp1(i,k,j) = mm(i,j) * (  &amp;<a name='258'>
                    rdy * ( hat(i,k,j+1) - hat(i,k,j) ) - tmp1(i,k,j) )<a name='259'>
    END DO<a name='260'>
    END DO<a name='261'>
    END DO<a name='262'>
<a name='263'>
<font color=#447700>! End calculation of dv/dy.<a name='264'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='265'></font>
<a name='266'>
<font color=#447700>!-----------------------------------------------------------------------<a name='267'></font>
<font color=#447700>! Calculate defor22 (2*dv/dy).<a name='268'></font>
<a name='269'>
    DO j = j_start, j_end<a name='270'>
    DO k = kts, ktf<a name='271'>
    DO i = i_start, i_end<a name='272'>
      defor22(i,k,j) = 2.0 * tmp1(i,k,j)<a name='273'>
    END DO<a name='274'>
    END DO<a name='275'>
    END DO<a name='276'>
<a name='277'>
<font color=#447700>! End calculation of defor22.<a name='278'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='279'></font>
<a name='280'>
<font color=#447700>!-----------------------------------------------------------------------<a name='281'></font>
<font color=#447700>! Calculate meridional divergence (dv/dy) and add it to the divergence<a name='282'></font>
<font color=#447700>! array.<a name='283'></font>
<a name='284'>
    DO j = j_start, j_end<a name='285'>
    DO k = kts, ktf<a name='286'>
    DO i = i_start, i_end<a name='287'>
      div(i,k,j) = div(i,k,j) + tmp1(i,k,j)<a name='288'>
    END DO<a name='289'>
    END DO<a name='290'>
    END DO<a name='291'>
<a name='292'>
<font color=#447700>! End calculation of meridional divergence.<a name='293'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='294'></font>
<a name='295'>
<font color=#447700>!-----------------------------------------------------------------------<a name='296'></font>
<font color=#447700>! Calculate dw/dz.<a name='297'></font>
<a name='298'>
    DO j = j_start, j_end<a name='299'>
    DO k = kts, ktf<a name='300'>
    DO i = i_start, i_end<a name='301'>
      tmp1(i,k,j) = ( w(i,k+1,j) - w(i,k,j) ) * rdzw(i,k,j)<a name='302'>
    END DO<a name='303'>
    END DO<a name='304'>
    END DO<a name='305'>
<a name='306'>
<font color=#447700>! End calculation of dw/dz.<a name='307'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='308'></font>
<a name='309'>
<font color=#447700>!-----------------------------------------------------------------------<a name='310'></font>
<font color=#447700>! Calculate defor33 (2*dw/dz).<a name='311'></font>
<a name='312'>
    DO j = j_start, j_end<a name='313'>
    DO k = kts, ktf<a name='314'>
    DO i = i_start, i_end<a name='315'>
      defor33(i,k,j) = 2.0 * tmp1(i,k,j)<a name='316'>
    END DO<a name='317'>
    END DO<a name='318'>
    END DO<a name='319'>
<a name='320'>
<font color=#447700>! End calculation of defor33.<a name='321'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='322'></font>
<a name='323'>
<font color=#447700>!-----------------------------------------------------------------------<a name='324'></font>
<font color=#447700>! Calculate vertical divergence (dw/dz) and add it to the divergence<a name='325'></font>
<font color=#447700>! array.<a name='326'></font>
<a name='327'>
    DO j = j_start, j_end<a name='328'>
    DO k = kts, ktf<a name='329'>
    DO i = i_start, i_end<a name='330'>
      div(i,k,j) = div(i,k,j) + tmp1(i,k,j)<a name='331'>
    END DO<a name='332'>
    END DO<a name='333'>
    END DO<a name='334'>
<a name='335'>
<font color=#447700>! End calculation of vertical divergence. <a name='336'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='337'></font>
<a name='338'>
<font color=#447700>! Three-dimensional divergence is now finished and values are in array<a name='339'></font>
<font color=#447700>! "div."  Also, the first three (defor11, defor22, defor33) of six<a name='340'></font>
<font color=#447700>! deformation terms are now calculated at pressure points.<a name='341'></font>
<font color=#447700>!=======================================================================<a name='342'></font>
<a name='343'>
<font color=#447700>!=======================================================================<a name='344'></font>
<font color=#447700>! Calculate the final three deformations (defor12, defor13, defor23) at <a name='345'></font>
<font color=#447700>! vorticity points.<a name='346'></font>
<a name='347'>
    i_start = its<a name='348'>
    i_end   = ite<a name='349'>
    j_start = jts<a name='350'>
    j_end   = jte<a name='351'>
<a name='352'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='353'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='354'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp; <a name='355'>
         config_flags%nested) i_end   = MIN( ide-1, ite )<a name='356'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='357'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='358'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='359'>
         config_flags%nested) j_end   = MIN( jde-1, jte )<a name='360'>
<a name='361'>
<font color=#447700>!-----------------------------------------------------------------------<a name='362'></font>
<font color=#447700>! Calculate du/dy.<a name='363'></font>
<a name='364'>
<font color=#447700>! First, calculate an average mapscale factor.<a name='365'></font>
<a name='366'>
    DO j = j_start, j_end<a name='367'>
    DO i = i_start, i_end<a name='368'>
      mm(i,j) = 0.25 * ( msfu(i,j-1) + msfu(i,j) ) * ( msfv(i-1,j) + msfv(i,j) )<a name='369'>
    END DO<a name='370'>
    END DO<a name='371'>
<a name='372'>
<font color=#447700>! Apply a coordinate transformation to zonal velocity, u.<a name='373'></font>
<a name='374'>
    DO j =j_start-1, j_end<a name='375'>
    DO k =kts, ktf<a name='376'>
    DO i =i_start, i_end<a name='377'>
      hat(i,k,j) = u(i,k,j) / msfu(i,j)<a name='378'>
    END DO<a name='379'>
    END DO<a name='380'>
    END DO<a name='381'>
<a name='382'>
<font color=#447700>! Average in y and z.<a name='383'></font>
<a name='384'>
    DO j=j_start,j_end<a name='385'>
    DO k=kts+1,ktf<a name='386'>
    DO i=i_start,i_end<a name='387'>
      hatavg(i,k,j) = 0.5 * (  &amp;<a name='388'>
                      fnm(k) * ( hat(i,k  ,j-1) + hat(i,k  ,j) ) +  &amp;<a name='389'>
                      fnp(k) * ( hat(i,k-1,j-1) + hat(i,k-1,j) ) )<a name='390'>
    END DO<a name='391'>
    END DO<a name='392'>
    END DO<a name='393'>
<a name='394'>
<font color=#447700>! Extrapolate to top and bottom of domain (to w levels).<a name='395'></font>
<a name='396'>
    DO j = j_start, j_end<a name='397'>
    DO i = i_start, i_end<a name='398'>
      hatavg(i,1,j)   =  0.5 * (  &amp;<a name='399'>
                         cf1 * hat(i,1,j-1) +  &amp;<a name='400'>
                         cf2 * hat(i,2,j-1) +  &amp;<a name='401'>
                         cf3 * hat(i,3,j-1) +  &amp;<a name='402'>
                         cf1 * hat(i,1,j  ) +  &amp;<a name='403'>
                         cf2 * hat(i,2,j  ) +  &amp;<a name='404'>
                         cf3 * hat(i,3,j  ) )<a name='405'>
      hatavg(i,kte,j) =  0.5 * (  &amp;<a name='406'>
                        cft1 * ( hat(i,ktes1,j-1) + hat(i,ktes1,j) ) +  &amp;<a name='407'>
                        cft2 * ( hat(i,ktes2,j-1) + hat(i,ktes2,j) ) )<a name='408'>
    END DO<a name='409'>
    END DO<a name='410'>
<a name='411'>
    DO j = j_start, j_end<a name='412'>
    DO k = kts, ktf<a name='413'>
    DO i = i_start, i_end<a name='414'>
      tmpzy       = 0.25 * (  &amp;<a name='415'>
                    zy(i-1,k  ,j) + zy(i,k  ,j) +  &amp;<a name='416'>
                    zy(i-1,k+1,j) + zy(i,k+1,j) )<a name='417'>
      tmp1(i,k,j) = ( hatavg(i,k+1,j) - hatavg(i,k,j) ) *  &amp;<a name='418'>
                    0.5 * tmpzy * ( rdzw(i,k,j) + rdzw(i-1,k,j) )<a name='419'>
    END DO<a name='420'>
    END DO<a name='421'>
    END DO<a name='422'>
<a name='423'>
<font color=#447700>! End calculation of du/dy.<a name='424'></font>
<font color=#447700>!---------------------------------------------------------------------- <a name='425'></font>
<a name='426'>
<font color=#447700>!-----------------------------------------------------------------------<a name='427'></font>
<font color=#447700>! Add the first term to defor12 (du/dy+dv/dx) at vorticity points.<a name='428'></font>
<a name='429'>
    DO j = j_start, j_end<a name='430'>
    DO k = kts, ktf<a name='431'>
    DO i = i_start, i_end<a name='432'>
      defor12(i,k,j) = mm(i,j) * (  &amp;<a name='433'>
                       rdy * ( hat(i,k,j) - hat(i,k,j-1) ) - tmp1(i,k,j) )<a name='434'>
    END DO<a name='435'>
    END DO<a name='436'>
    END DO<a name='437'>
<a name='438'>
<font color=#447700>! End addition of the first term to defor12.<a name='439'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='440'></font>
<a name='441'>
<font color=#447700>!-----------------------------------------------------------------------<a name='442'></font>
<font color=#447700>! Calculate dv/dx.<a name='443'></font>
<a name='444'>
<font color=#447700>! Apply a coordinate transformation to meridional velocity, v.<a name='445'></font>
<a name='446'>
    DO j = j_start, j_end<a name='447'>
    DO k = kts, ktf<a name='448'>
    DO i = i_start-1, i_end<a name='449'>
       hat(i,k,j) = v(i,k,j) / msfv(i,j)<a name='450'>
    END DO<a name='451'>
    END DO<a name='452'>
    END DO<a name='453'>
<a name='454'>
<font color=#447700>! Account for the slope in x of eta surfaces.<a name='455'></font>
<a name='456'>
    DO j = j_start, j_end<a name='457'>
    DO k = kts+1, ktf<a name='458'>
    DO i = i_start, i_end<a name='459'>
      hatavg(i,k,j) = 0.5 * (  &amp;<a name='460'>
                      fnm(k) * ( hat(i-1,k  ,j) + hat(i,k  ,j) ) +  &amp;<a name='461'>
                      fnp(k) * ( hat(i-1,k-1,j) + hat(i,k-1,j) ) )<a name='462'>
    END DO<a name='463'>
    END DO<a name='464'>
    END DO<a name='465'>
<a name='466'>
<font color=#447700>! Extrapolate to top and bottom of domain (to w levels).<a name='467'></font>
<a name='468'>
    DO j = j_start, j_end<a name='469'>
    DO i = i_start, i_end<a name='470'>
       hatavg(i,1,j)   =  0.5 * (  &amp;<a name='471'>
                          cf1 * hat(i-1,1,j) +  &amp;<a name='472'>
                          cf2 * hat(i-1,2,j) +  &amp;<a name='473'>
                          cf3 * hat(i-1,3,j) +  &amp;<a name='474'>
                          cf1 * hat(i  ,1,j) +  &amp;<a name='475'>
                          cf2 * hat(i  ,2,j) +  &amp;<a name='476'>
                          cf3 * hat(i  ,3,j) )<a name='477'>
       hatavg(i,kte,j) =  0.5 * (  &amp;<a name='478'>
                         cft1 * ( hat(i,ktes1,j) + hat(i-1,ktes1,j) ) +  &amp;<a name='479'>
                         cft2 * ( hat(i,ktes2,j) + hat(i-1,ktes2,j) ) )<a name='480'>
    END DO<a name='481'>
    END DO<a name='482'>
<a name='483'>
    DO j = j_start, j_end<a name='484'>
    DO k = kts, ktf<a name='485'>
    DO i = i_start, i_end<a name='486'>
      tmpzx       = 0.25 * (  &amp;<a name='487'>
                    zx(i,k  ,j-1) + zx(i,k  ,j) +  &amp;<a name='488'>
                    zx(i,k+1,j-1) + zx(i,k+1,j) )<a name='489'>
      tmp1(i,k,j) = ( hatavg(i,k+1,j) - hatavg(i,k,j) ) *  &amp;<a name='490'>
                    0.5 * tmpzx * ( rdzw(i,k,j) + rdzw(i,k,j-1) )<a name='491'>
    END DO<a name='492'>
    END DO<a name='493'>
    END DO<a name='494'>
<a name='495'>
<font color=#447700>! End calculation of dv/dx.<a name='496'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='497'></font>
<a name='498'>
<font color=#447700>!-----------------------------------------------------------------------<a name='499'></font>
<font color=#447700>! Add the second term to defor12 (du/dy+dv/dx) at vorticity points.<a name='500'></font>
<a name='501'>
    DO j = j_start, j_end<a name='502'>
    DO k = kts, ktf<a name='503'>
    DO i = i_start, i_end<a name='504'>
      defor12(i,k,j) = defor12(i,k,j) +  &amp;<a name='505'>
                       mm(i,j) * (  &amp;<a name='506'>
                       rdx * ( hat(i,k,j) - hat(i-1,k,j) ) - tmp1(i,k,j) )<a name='507'>
    END DO<a name='508'>
    END DO<a name='509'>
    END DO<a name='510'>
<a name='511'>
<font color=#447700>! End addition of the second term to defor12.<a name='512'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='513'></font>
<a name='514'>
<font color=#447700>!-----------------------------------------------------------------------<a name='515'></font>
<font color=#447700>! Update the boundary for defor12 (might need to change later).<a name='516'></font>
 <a name='517'>
    IF ( .NOT. config_flags%periodic_x .AND. i_start .EQ. ids+1 ) THEN<a name='518'>
      DO j = jts, jte<a name='519'>
      DO k = kts, kte<a name='520'>
        defor12(ids,k,j) = defor12(ids+1,k,j)<a name='521'>
      END DO<a name='522'>
      END DO<a name='523'>
    END IF<a name='524'>
 <a name='525'>
    IF ( .NOT. config_flags%periodic_y .AND. j_start .EQ. jds+1) THEN<a name='526'>
      DO k = kts, kte<a name='527'>
      DO i = its, ite<a name='528'>
        defor12(i,k,jds) = defor12(i,k,jds+1)<a name='529'>
      END DO<a name='530'>
      END DO<a name='531'>
    END IF<a name='532'>
<a name='533'>
    IF ( .NOT. config_flags%periodic_x .AND. i_end .EQ. ide-1) THEN<a name='534'>
      DO j = jts, jte<a name='535'>
      DO k = kts, kte<a name='536'>
        defor12(ide,k,j) = defor12(ide-1,k,j)<a name='537'>
      END DO<a name='538'>
      END DO<a name='539'>
    END IF<a name='540'>
<a name='541'>
    IF ( .NOT. config_flags%periodic_y .AND. j_end .EQ. jde-1) THEN<a name='542'>
      DO k = kts, kte<a name='543'>
      DO i = its, ite<a name='544'>
        defor12(i,k,jde) = defor12(i,k,jde-1)<a name='545'>
      END DO<a name='546'>
      END DO<a name='547'>
    END IF<a name='548'>
<a name='549'>
<font color=#447700>! End update of boundary for defor12.<a name='550'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='551'></font>
<a name='552'>
<font color=#447700>!-----------------------------------------------------------------------<a name='553'></font>
<font color=#447700>! Calculate dw/dx.<a name='554'></font>
<a name='555'>
    i_start = its<a name='556'>
    i_end   = MIN( ite, ide-1 )<a name='557'>
    j_start = jts<a name='558'>
    j_end   = MIN( jte, jde-1 )<a name='559'>
<a name='560'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='561'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='562'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='563'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='564'>
<a name='565'>
    IF ( config_flags%periodic_x ) i_end = MIN( ite, ide )<a name='566'>
    IF ( config_flags%periodic_y ) j_end = MIN( jte, jde )<a name='567'>
<a name='568'>
<font color=#447700>! Square the mapscale factor.<a name='569'></font>
<a name='570'>
    DO j = jts, jte<a name='571'>
    DO i = its, ite<a name='572'>
      mm(i,j) = msfu(i,j) * msfu(i,j)<a name='573'>
    END DO<a name='574'>
    END DO<a name='575'>
<a name='576'>
<font color=#447700>! Apply a coordinate transformation to vertical velocity, w.  This is for both<a name='577'></font>
<font color=#447700>! defor13 and defor23.<a name='578'></font>
<a name='579'>
    DO j = j_start, j_end<a name='580'>
    DO k = kts, kte<a name='581'>
    DO i = i_start, i_end<a name='582'>
      hat(i,k,j) = w(i,k,j) / msft(i,j)<a name='583'>
    END DO<a name='584'>
    END DO<a name='585'>
    END DO<a name='586'>
<a name='587'>
    i = i_start-1<a name='588'>
    DO j = j_start, MIN( jte, jde-1 )<a name='589'>
    DO k = kts, kte<a name='590'>
      hat(i,k,j) = w(i,k,j) / msft(i,j)<a name='591'>
    END DO<a name='592'>
    END DO<a name='593'>
<a name='594'>
    j = j_start-1<a name='595'>
    DO k = kts, kte<a name='596'>
    DO i = i_start, MIN( ite, ide-1 )<a name='597'>
      hat(i,k,j) = w(i,k,j) / msft(i,j)<a name='598'>
    END DO<a name='599'>
    END DO<a name='600'>
<a name='601'>
<font color=#447700>! QUESTION: What is this for?<a name='602'></font>
<a name='603'>
    DO j = j_start, j_end<a name='604'>
    DO k = kts, ktf<a name='605'>
    DO i = i_start, i_end<a name='606'>
      hatavg(i,k,j) = 0.25 * (  &amp;<a name='607'>
                      hat(i  ,k  ,j) +  &amp;<a name='608'>
                      hat(i  ,k+1,j) +  &amp;<a name='609'>
                      hat(i-1,k  ,j) +  &amp;<a name='610'>
                      hat(i-1,k+1,j) )<a name='611'>
    END DO<a name='612'>
    END DO<a name='613'>
    END DO<a name='614'>
<a name='615'>
<font color=#447700>! Calculate dw/dx.<a name='616'></font>
<a name='617'>
    DO j = j_start, j_end<a name='618'>
    DO k = kts+1, ktf<a name='619'>
    DO i = i_start, i_end<a name='620'>
      tmp1(i,k,j) = ( hatavg(i,k,j) - hatavg(i,k-1,j) ) * zx(i,k,j) *  &amp;<a name='621'>
                    0.5 * ( rdz(i,k,j) + rdz(i-1,k,j) )<a name='622'>
    END DO<a name='623'>
    END DO<a name='624'>
    END DO<a name='625'>
<a name='626'>
<font color=#447700>! End calculation of dw/dx.<a name='627'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='628'></font>
<a name='629'>
<font color=#447700>!-----------------------------------------------------------------------<a name='630'></font>
<font color=#447700>! Add the first term (dw/dx) to defor13 (dw/dx+du/dz) at vorticity<a name='631'></font>
<font color=#447700>! points.<a name='632'></font>
<a name='633'>
    DO j = j_start, j_end<a name='634'>
    DO k = kts+1, ktf<a name='635'>
    DO i = i_start, i_end<a name='636'>
      defor13(i,k,j) = mm(i,j) * (  &amp;<a name='637'>
                       rdx * ( hat(i,k,j) - hat(i-1,k,j) ) - tmp1(i,k,j) )<a name='638'>
    END DO<a name='639'>
    END DO<a name='640'>
    END DO<a name='641'>
<a name='642'>
    DO j = j_start, j_end<a name='643'>
    DO i = i_start, i_end<a name='644'>
      defor13(i,kts,j  ) = 0.0<a name='645'>
      defor13(i,ktf+1,j) = 0.0<a name='646'>
    END DO<a name='647'>
    END DO<a name='648'>
<a name='649'>
<font color=#447700>! End addition of the first term to defor13.<a name='650'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='651'></font>
<a name='652'>
<font color=#447700>!-----------------------------------------------------------------------<a name='653'></font>
<font color=#447700>! Calculate du/dz.<a name='654'></font>
<a name='655'>
    IF ( config_flags%mix_full_fields ) THEN<a name='656'>
<a name='657'>
      DO j = j_start, j_end<a name='658'>
      DO k = kts+1, ktf<a name='659'>
      DO i = i_start, i_end<a name='660'>
        tmp1(i,k,j) = ( u(i,k,j) - u(i,k-1,j) ) *  &amp;<a name='661'>
                      0.5 * ( rdz(i,k,j) + rdz(i-1,k,j) )<a name='662'>
      END DO<a name='663'>
      END DO<a name='664'>
      END DO<a name='665'>
<a name='666'>
    ELSE<a name='667'>
<a name='668'>
      DO j = j_start, j_end<a name='669'>
      DO k = kts+1, ktf<a name='670'>
      DO i = i_start, i_end<a name='671'>
        tmp1(i,k,j) = ( u(i,k,j) - u_base(k) - u(i,k-1,j) + u_base(k-1) ) *  &amp;<a name='672'>
                      0.5 * ( rdz(i,k,j) + rdz(i-1,k,j) )<a name='673'>
      END DO<a name='674'>
      END DO<a name='675'>
      END DO<a name='676'>
<a name='677'>
    END IF<a name='678'>
<a name='679'>
<font color=#447700>!-----------------------------------------------------------------------<a name='680'></font>
<font color=#447700>! Add the second term (du/dz) to defor13 (dw/dx+du/dz) at vorticity<a name='681'></font>
<font color=#447700>! points.<a name='682'></font>
<a name='683'>
    DO j = j_start, j_end<a name='684'>
    DO k = kts+1, ktf<a name='685'>
    DO i = i_start, i_end<a name='686'>
      defor13(i,k,j) = defor13(i,k,j) + tmp1(i,k,j)<a name='687'>
    END DO<a name='688'>
    END DO<a name='689'>
    END DO<a name='690'>
<a name='691'>
<font color=#447700>! End addition of the second term to defor13.<a name='692'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='693'></font>
<a name='694'>
<font color=#447700>!-----------------------------------------------------------------------<a name='695'></font>
<font color=#447700>! Calculate dw/dy.<a name='696'></font>
<a name='697'>
    i_start = its<a name='698'>
    i_end   = MIN( ite, ide-1 )<a name='699'>
    j_start = jts<a name='700'>
    j_end   = MIN( jte, jde-1 )<a name='701'>
<a name='702'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='703'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='704'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='705'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='706'>
    IF ( config_flags%periodic_y ) j_end = MIN( jte, jde )<a name='707'>
<a name='708'>
<font color=#447700>! Square mapscale factor.<a name='709'></font>
<a name='710'>
    DO j = jts, jte<a name='711'>
    DO i = its, ite<a name='712'>
      mm(i,j) = msfv(i,j) * msfv(i,j)<a name='713'>
    END DO<a name='714'>
    END DO<a name='715'>
<a name='716'>
<font color=#447700>! QUESTION: What is this for?<a name='717'></font>
<a name='718'>
    DO j = j_start, j_end<a name='719'>
    DO k = kts, ktf<a name='720'>
    DO i = i_start, i_end<a name='721'>
      hatavg(i,k,j) = 0.25 * (  &amp;<a name='722'>
                      hat(i,k  ,j  ) +  &amp;<a name='723'>
                      hat(i,k+1,j  ) +  &amp;<a name='724'>
                      hat(i,k  ,j-1) +  &amp;<a name='725'>
                      hat(i,k+1,j-1) )<a name='726'>
    END DO<a name='727'>
    END DO<a name='728'>
    END DO<a name='729'>
<a name='730'>
<font color=#447700>! Calculate dw/dy and store in tmp1.<a name='731'></font>
<a name='732'>
    DO j = j_start, j_end<a name='733'>
    DO k = kts+1, ktf<a name='734'>
    DO i = i_start, i_end<a name='735'>
      tmp1(i,k,j) = ( hatavg(i,k,j) - hatavg(i,k-1,j) ) * zy(i,k,j) *  &amp;<a name='736'>
                    0.5 * ( rdz(i,k,j) + rdz(i,k,j-1) )<a name='737'>
    END DO<a name='738'>
    END DO<a name='739'>
    END DO<a name='740'>
<a name='741'>
<font color=#447700>! End calculation of dw/dy.<a name='742'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='743'></font>
<a name='744'>
<font color=#447700>!-----------------------------------------------------------------------<a name='745'></font>
<font color=#447700>! Add the first term (dw/dy) to defor23 (dw/dy+dv/dz) at vorticity<a name='746'></font>
<font color=#447700>! points.<a name='747'></font>
<a name='748'>
    DO j = j_start, j_end<a name='749'>
    DO k = kts+1, ktf<a name='750'>
    DO i = i_start, i_end<a name='751'>
      defor23(i,k,j) = mm(i,j) * (  &amp;<a name='752'>
                       rdy * ( hat(i,k,j) - hat(i,k,j-1) ) - tmp1(i,k,j) )<a name='753'>
    END DO<a name='754'>
    END DO<a name='755'>
    END DO<a name='756'>
<a name='757'>
    DO j = j_start, j_end<a name='758'>
    DO i = i_start, i_end<a name='759'>
      defor23(i,kts,j  ) = 0.0<a name='760'>
      defor23(i,ktf+1,j) = 0.0<a name='761'>
    END DO<a name='762'>
    END DO<a name='763'>
<a name='764'>
<font color=#447700>! End addition of the first term to defor23.<a name='765'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='766'></font>
<a name='767'>
<font color=#447700>!-----------------------------------------------------------------------<a name='768'></font>
<font color=#447700>! Calculate dv/dz.<a name='769'></font>
<a name='770'>
    IF ( config_flags%mix_full_fields ) THEN<a name='771'>
<a name='772'>
      DO j = j_start, j_end<a name='773'>
      DO k = kts+1, ktf<a name='774'>
      DO i = i_start, i_end<a name='775'>
        tmp1(i,k,j) = ( v(i,k,j) - v(i,k-1,j) ) *  &amp;<a name='776'>
                      0.5 * ( rdz(i,k,j) + rdz(i,k,j-1) )<a name='777'>
      END DO<a name='778'>
      END DO<a name='779'>
      END DO<a name='780'>
<a name='781'>
    ELSE<a name='782'>
<a name='783'>
      DO j = j_start, j_end<a name='784'>
      DO k = kts+1, ktf<a name='785'>
      DO i = i_start, i_end<a name='786'>
        tmp1(i,k,j) = ( v(i,k,j) - v_base(k) - v(i,k-1,j) + v_base(k-1) ) *  &amp;<a name='787'>
                      0.5 * ( rdz(i,k,j) + rdz(i,k,j-1) )<a name='788'>
      END DO<a name='789'>
      END DO<a name='790'>
      END DO<a name='791'>
<a name='792'>
    END IF<a name='793'>
<a name='794'>
<font color=#447700>! End calculation of dv/dz.<a name='795'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='796'></font>
<a name='797'>
<font color=#447700>!-----------------------------------------------------------------------<a name='798'></font>
<font color=#447700>! Add the second term (dv/dz) to defor23 (dw/dy+dv/dz) at vorticity<a name='799'></font>
<font color=#447700>! points.<a name='800'></font>
<a name='801'>
<font color=#447700>! Add tmp1 to defor23.<a name='802'></font>
<a name='803'>
    DO j = j_start, j_end<a name='804'>
    DO k = kts+1, ktf<a name='805'>
    DO i = i_start, i_end<a name='806'>
      defor23(i,k,j) = defor23(i,k,j) + tmp1(i,k,j)<a name='807'>
    END DO<a name='808'>
    END DO<a name='809'>
    END DO<a name='810'>
<a name='811'>
<font color=#447700>! End addition of the second term to defor23.<a name='812'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='813'></font>
<a name='814'>
<font color=#447700>!-----------------------------------------------------------------------<a name='815'></font>
<font color=#447700>! Update the boundary for defor13 and defor23 (might need to change<a name='816'></font>
<font color=#447700>! later).<a name='817'></font>
<a name='818'>
    IF ( .NOT. config_flags%periodic_x .AND. i_start .EQ. ids+1) THEN<a name='819'>
      DO j = jts, jte<a name='820'>
      DO k = kts, kte<a name='821'>
        defor13(ids,k,j) = defor13(ids+1,k,j)<a name='822'>
        defor23(ids,k,j) = defor23(ids+1,k,j)<a name='823'>
      END DO<a name='824'>
      END DO<a name='825'>
    END IF<a name='826'>
<a name='827'>
    IF ( .NOT. config_flags%periodic_y .AND. j_start .EQ. jds+1) THEN<a name='828'>
      DO k = kts, kte<a name='829'>
      DO i = its, ite<a name='830'>
        defor13(i,k,jds) = defor13(i,k,jds+1)<a name='831'>
        defor23(i,k,jds) = defor23(i,k,jds+1)<a name='832'>
      END DO<a name='833'>
      END DO<a name='834'>
    END IF<a name='835'>
<a name='836'>
    IF ( .NOT. config_flags%periodic_x .AND. i_end .EQ. ide-1) THEN<a name='837'>
      DO j = jts, jte<a name='838'>
      DO k = kts, kte<a name='839'>
        defor13(ide,k,j) = defor13(ide-1,k,j)<a name='840'>
        defor23(ide,k,j) = defor23(ide-1,k,j)<a name='841'>
      END DO<a name='842'>
      END DO<a name='843'>
    END IF<a name='844'>
<a name='845'>
    IF ( .NOT. config_flags%periodic_y .AND. j_end .EQ. jde-1) THEN<a name='846'>
      DO k = kts, kte<a name='847'>
      DO i = its, ite<a name='848'>
        defor13(i,k,jde) = defor13(i,k,jde-1)<a name='849'>
        defor23(i,k,jde) = defor23(i,k,jde-1)<a name='850'>
      END DO<a name='851'>
      END DO<a name='852'>
    END IF<a name='853'>
<a name='854'>
<font color=#447700>! End update of boundary for defor13 and defor23.<a name='855'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='856'></font>
<a name='857'>
<font color=#447700>! The second three (defor12, defor13, defor23) of six deformation terms<a name='858'></font>
<font color=#447700>! are now calculated at vorticity points.<a name='859'></font>
<font color=#447700>!=======================================================================<a name='860'></font>
<a name='861'>
    END SUBROUTINE cal_deform_and_div<a name='862'>
<a name='863'>
<font color=#447700>!=======================================================================<a name='864'></font>
<font color=#447700>!=======================================================================<a name='865'></font>
<a name='866'>
<A NAME='CALCULATE_KM_KH'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='867'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>calculate_km_kh</font>( config_flags, dt,                        &amp; <A href='../../call_to/CALCULATE_KM_KH.html' TARGET='index'>14</A>,<A href='../../call_from/CALCULATE_KM_KH.html' TARGET='index'>7</A><a name='868'>
                                dampcoef, zdamp, damp_opt,               &amp;<a name='869'>
                                xkmh, xkmhd, xkmv, xkhh, xkhv,           &amp;<a name='870'>
                                BN2, khdif, kvdif, div,                  &amp;<a name='871'>
                                defor11, defor22, defor33,               &amp;<a name='872'>
                                defor12, defor13, defor23,               &amp;<a name='873'>
                                tke, p8w, t8w, theta, t, p, moist,       &amp;<a name='874'>
                                dn, dnw, dx, dy, rdz, rdzw, cr_len,      &amp;<a name='875'>
                                n_moist, cf1, cf2, cf3, warm_rain,       &amp;<a name='876'>
                                kh_tke_upper_bound, kv_tke_upper_bound,  &amp;<a name='877'>
                                ids, ide, jds, jde, kds, kde,            &amp;<a name='878'>
                                ims, ime, jms, jme, kms, kme,            &amp;<a name='879'>
                                its, ite, jts, jte, kts, kte             )<a name='880'>
<a name='881'>
<font color=#447700>! History:     Sep 2003  Changes by George Bryan and Jason Knievel, NCAR<a name='882'></font>
<font color=#447700>!              Oct 2001  Converted to mass core by Bill Skamarock, NCAR<a name='883'></font>
<font color=#447700>!              ...       ...<a name='884'></font>
<a name='885'>
<font color=#447700>! Purpose:     This routine calculates exchange coefficients for the TKE<a name='886'></font>
<font color=#447700>!              scheme.<a name='887'></font>
<a name='888'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='889'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='890'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='891'></font>
<a name='892'>
<font color=#447700>!-----------------------------------------------------------------------<a name='893'></font>
<font color=#447700>! Begin declarations.<a name='894'></font>
<a name='895'>
    IMPLICIT NONE<a name='896'>
<a name='897'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='898'>
    :: config_flags   <a name='899'>
<a name='900'>
    INTEGER, INTENT( IN )  &amp;<a name='901'>
    :: n_moist, damp_opt,             &amp; <a name='902'>
       ids, ide, jds, jde, kds, kde,  &amp;<a name='903'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='904'>
       its, ite, jts, jte, kts, kte <a name='905'>
<a name='906'>
    LOGICAL, INTENT( IN )  &amp;<a name='907'>
    :: warm_rain<a name='908'>
<a name='909'>
    REAL, INTENT( IN )  &amp;<a name='910'>
    :: cr_len, dx, dy, zdamp, dt, dampcoef, cf1, cf2, cf3, khdif, kvdif<a name='911'>
<a name='912'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='913'>
    :: dnw, dn<a name='914'>
<a name='915'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme, n_moist ), INTENT( INOUT )  &amp;<a name='916'>
    :: moist<a name='917'>
<a name='918'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='919'>
    :: xkmv, xkmh, xkmhd, xkhv, xkhh, BN2  <a name='920'>
<a name='921'>
    REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),  INTENT( IN )  &amp;<a name='922'>
    :: defor11, defor22, defor33, defor12, defor13, defor23,      &amp;<a name='923'>
       div, rdz, rdzw, p8w, t8w, theta, t, p<a name='924'>
<a name='925'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='926'>
    :: tke<a name='927'>
<a name='928'>
    REAL, INTENT( IN )  &amp;<a name='929'>
    :: kh_tke_upper_bound, kv_tke_upper_bound<a name='930'>
<a name='931'>
<font color=#447700>! Local variables.<a name='932'></font>
<a name='933'>
    INTEGER  &amp;<a name='934'>
    :: i_start, i_end, j_start, j_end, ktf, i, j, k<a name='935'>
<a name='936'>
<font color=#447700>! End declarations.<a name='937'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='938'></font>
<a name='939'>
    ktf     = MIN( kte, kde-1 )<a name='940'>
    i_start = its<a name='941'>
    i_end   = MIN( ite, ide-1 )<a name='942'>
    j_start = jts<a name='943'>
    j_end   = MIN( jte, jde-1 )<a name='944'>
<a name='945'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_N2'>calculate_N2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_N2_1">( config_flags, BN2, moist,           &amp;<a name='946'>
                       theta, t, p, p8w, t8w,              &amp;<a name='947'>
                       dnw, dn, rdz, rdzw,                 &amp;<a name='948'>
                       n_moist, cf1, cf2, cf3, warm_rain,  &amp;<a name='949'>
                       ids, ide, jds, jde, kds, kde,       &amp;<a name='950'>
                       ims, ime, jms, jme, kms, kme,       &amp;<a name='951'>
                       its, ite, jts, jte, kts, kte        )<a name='952'>
<a name='953'>
<font color=#447700>! Select a scheme for calculating diffusion coefficients.<a name='954'></font>
<a name='955'>
    km_coef: SELECT CASE( config_flags%km_opt )<a name='956'>
<a name='957'>
      CASE (1)<a name='958'>
            CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#ISOTROPIC_KM'>isotropic_km</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ISOTROPIC_KM_1">( config_flags, xkmh, xkmhd, xkmv,         &amp;<a name='959'>
                               xkhh, xkhv, khdif, kvdif,                &amp;<a name='960'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='961'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='962'>
                               its, ite, jts, jte, kts, kte             )<a name='963'>
      CASE (2)  <a name='964'>
            CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_KM'>tke_km</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TKE_KM_1">(       config_flags, xkmh, xkmhd, xkmv,         &amp;<a name='965'>
                               xkhh, xkhv, BN2, tke, p8w, t8w, theta,   &amp;<a name='966'>
                               rdz, rdzw, dx, dy, cr_len,               &amp;<a name='967'>
                               kh_tke_upper_bound, kv_tke_upper_bound,  &amp;<a name='968'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='969'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='970'>
                               its, ite, jts, jte, kts, kte             )<a name='971'>
      CASE (3)  <a name='972'>
            CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#SMAG_KM'>smag_km</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMAG_KM_1">(      config_flags, xkmh, xkmhd, xkmv,         &amp;<a name='973'>
                               xkhh, xkhv, BN2, div,                    &amp;<a name='974'>
                               defor11, defor22, defor33,               &amp;<a name='975'>
                               defor12, defor13, defor23,               &amp;<a name='976'>
                               rdzw, dx, dy, cr_len,                    &amp;<a name='977'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='978'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='979'>
                               its, ite, jts, jte, kts, kte             )<a name='980'>
      CASE (4)  <a name='981'>
            CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#SMAG2D_KM'>smag2d_km</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMAG2D_KM_1">(    config_flags, xkmh, xkmhd, xkmv,         &amp;<a name='982'>
                               xkhh, xkhv, defor11, defor22, defor12,   &amp;<a name='983'>
                               rdzw, dx, dy,                            &amp;<a name='984'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='985'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='986'>
                               its, ite, jts, jte, kts, kte             )<a name='987'>
      CASE DEFAULT<a name='988'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_16">( 'Please choose diffusion coefficient scheme' )<a name='989'>
<a name='990'>
    END SELECT km_coef<a name='991'>
<a name='992'>
    IF ( damp_opt .eq. 1 ) THEN<a name='993'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_DAMPKM'>cal_dampkm</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_DAMPKM_1">( config_flags, xkmhd, xkmh, xkhh, xkmv, xkhv,   &amp;<a name='994'>
                       dx, dy, dt, dampcoef, rdz, rdzw, zdamp,  &amp;<a name='995'>
                       ids, ide, jds, jde, kds, kde,            &amp;<a name='996'>
                       ims, ime, jms, jme, kms, kme,            &amp;<a name='997'>
                       its, ite, jts, jte, kts, kte             )<a name='998'>
    END IF<a name='999'>
<a name='1000'>
    END SUBROUTINE calculate_km_kh<a name='1001'>
<a name='1002'>
<font color=#447700>!=======================================================================<a name='1003'></font>
<a name='1004'>
<A NAME='CAL_DAMPKM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_DAMPKM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1005'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_dampkm</font>( config_flags,xkmhd,xkmh,xkhh,xkmv,xkhv,                 &amp; <A href='../../call_to/CAL_DAMPKM.html' TARGET='index'>1</A><a name='1006'>
                       dx,dy,dt,dampcoef,                                      &amp;<a name='1007'>
                       rdz, rdzw ,zdamp,                                       &amp;<a name='1008'>
                       ids,ide, jds,jde, kds,kde,                              &amp;<a name='1009'>
                       ims,ime, jms,jme, kms,kme,                              &amp;<a name='1010'>
                       its,ite, jts,jte, kts,kte                              )<a name='1011'>
<a name='1012'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1013'></font>
<font color=#447700>! Begin declarations.<a name='1014'></font>
<a name='1015'>
   IMPLICIT NONE<a name='1016'>
<a name='1017'>
   TYPE(grid_config_rec_type) , INTENT(IN   ) :: config_flags<a name='1018'>
<a name='1019'>
   INTEGER ,          INTENT(IN   )           :: ids, ide, jds, jde, kds, kde, &amp;<a name='1020'>
                                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1021'>
                                                 its, ite, jts, jte, kts, kte<a name='1022'>
<a name='1023'>
   REAL    ,          INTENT(IN   )           :: zdamp,dx,dy,dt,dampcoef<a name='1024'>
<a name='1025'>
<a name='1026'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT)    ::    xkmhd, &amp;<a name='1027'>
                                                                         xkmh , &amp;<a name='1028'>
                                                                         xkhh , &amp;<a name='1029'>
                                                                         xkmv , &amp;<a name='1030'>
                                                                         xkhv <a name='1031'>
<a name='1032'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   )    ::     rdz,   &amp;<a name='1033'>
                                                                         rdzw<a name='1034'>
<font color=#447700>! LOCAL VARS<a name='1035'></font>
<a name='1036'>
   INTEGER :: i_start, i_end, j_start, j_end, ktf, ktfm1, i, j, k<a name='1037'>
   REAL    :: kmmax,kmmvmax,degrad90,dz,tmp<a name='1038'>
   REAL ,     DIMENSION( its:ite )                                ::   deltaz<a name='1039'>
   REAL , DIMENSION( its:ite, kts:kte, jts:jte)                   ::   dampk,dampkv<a name='1040'>
<a name='1041'>
<font color=#447700>! End declarations.<a name='1042'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1043'></font>
<a name='1044'>
   ktf = min(kte,kde-1)<a name='1045'>
   ktfm1 = ktf-1<a name='1046'>
<a name='1047'>
   i_start = its<a name='1048'>
   i_end   = MIN(ite,ide-1)<a name='1049'>
   j_start = jts<a name='1050'>
   j_end   = MIN(jte,jde-1)<a name='1051'>
<a name='1052'>
   kmmax=dx*dx/dt<a name='1053'>
   degrad90=DEGRAD*90.<a name='1054'>
   DO j = j_start, j_end<a name='1055'>
<a name='1056'>
      k=ktf<a name='1057'>
      DO i = i_start, i_end<a name='1058'>
<a name='1059'>
<font color=#447700>!         deltaz(i)=0.5*dnw(k)/zeta_z(i,j)<a name='1060'></font>
<font color=#447700>!         dz=dnw(k)/zeta_z(i,j)<a name='1061'></font>
         dz = 1./rdzw(i,k,j)<a name='1062'>
         deltaz(i) = 0.5*dz<a name='1063'>
<a name='1064'>
         kmmvmax=dz*dz/dt<a name='1065'>
         tmp=min(deltaz(i)/zdamp,1.)<a name='1066'>
         dampk(i,k,j)=cos(degrad90*tmp)*kmmax*dampcoef<a name='1067'>
         dampkv(i,k,j)=cos(degrad90*tmp)*kmmvmax*dampcoef<a name='1068'>
<font color=#447700>! set upper limit on vertical K (based on horizontal K)<a name='1069'></font>
         dampkv(i,k,j)=min(dampkv(i,k,j),dampk(i,k,j))<a name='1070'>
<a name='1071'>
      ENDDO<a name='1072'>
<a name='1073'>
      DO k = ktfm1,kts,-1<a name='1074'>
      DO i = i_start, i_end<a name='1075'>
<a name='1076'>
<font color=#447700>!         deltaz(i)=deltaz(i)+dn(k)/zeta_z(i,j)<a name='1077'></font>
<font color=#447700>!         dz=dnw(k)/zeta_z(i,j)<a name='1078'></font>
         dz = 1./rdz(i,k,j)<a name='1079'>
         deltaz(i) = deltaz(i) + dz<a name='1080'>
         dz = 1./rdzw(i,k,j)<a name='1081'>
<a name='1082'>
         kmmvmax=dz*dz/dt<a name='1083'>
         tmp=min(deltaz(i)/zdamp,1.)<a name='1084'>
         dampk(i,k,j)=cos(degrad90*tmp)*kmmax*dampcoef<a name='1085'>
         dampkv(i,k,j)=cos(degrad90*tmp)*kmmvmax*dampcoef<a name='1086'>
<font color=#447700>! set upper limit on vertical K (based on horizontal K)<a name='1087'></font>
         dampkv(i,k,j)=min(dampkv(i,k,j),dampk(i,k,j))<a name='1088'>
      ENDDO<a name='1089'>
      ENDDO<a name='1090'>
<a name='1091'>
   ENDDO<a name='1092'>
<a name='1093'>
   DO j = j_start, j_end<a name='1094'>
   DO k = kts,ktf<a name='1095'>
   DO i = i_start, i_end<a name='1096'>
      xkmhd(i,k,j)=max(xkmhd(i,k,j),dampk(i,k,j))<a name='1097'>
      xkmh(i,k,j)=max(xkmh(i,k,j),dampk(i,k,j))<a name='1098'>
      xkhh(i,k,j)=max(xkhh(i,k,j),dampk(i,k,j))<a name='1099'>
      xkmv(i,k,j)=max(xkmv(i,k,j),dampkv(i,k,j))<a name='1100'>
      xkhv(i,k,j)=max(xkhv(i,k,j),dampkv(i,k,j))<a name='1101'>
   ENDDO<a name='1102'>
   ENDDO<a name='1103'>
   ENDDO<a name='1104'>
<a name='1105'>
END SUBROUTINE cal_dampkm<a name='1106'>
<a name='1107'>
<font color=#447700>!=======================================================================<a name='1108'></font>
<font color=#447700>!=======================================================================<a name='1109'></font>
<a name='1110'>
<A NAME='CALCULATE_N2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_N2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1111'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>calculate_N2</font>( config_flags, BN2, moist,           &amp; <A href='../../call_to/CALCULATE_N2.html' TARGET='index'>2</A><a name='1112'>
                             theta, t, p, p8w, t8w,              &amp;<a name='1113'>
                             dnw, dn, rdz, rdzw,                 &amp;<a name='1114'>
                             n_moist, cf1, cf2, cf3, warm_rain,  &amp;<a name='1115'>
                             ids, ide, jds, jde, kds, kde,       &amp;<a name='1116'>
                             ims, ime, jms, jme, kms, kme,       &amp;<a name='1117'>
                             its, ite, jts, jte, kts, kte        )<a name='1118'>
<a name='1119'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1120'></font>
<font color=#447700>! Begin declarations.<a name='1121'></font>
<a name='1122'>
    IMPLICIT NONE<a name='1123'>
<a name='1124'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='1125'>
    :: config_flags<a name='1126'>
<a name='1127'>
    INTEGER, INTENT( IN )  &amp;<a name='1128'>
    :: n_moist,  &amp;<a name='1129'>
       ids, ide, jds, jde, kds, kde, &amp;<a name='1130'>
       ims, ime, jms, jme, kms, kme, &amp;<a name='1131'>
       its, ite, jts, jte, kts, kte<a name='1132'>
<a name='1133'>
    LOGICAL, INTENT( IN )  &amp;<a name='1134'>
    :: warm_rain<a name='1135'>
<a name='1136'>
    REAL, INTENT( IN )  &amp;<a name='1137'>
    :: cf1, cf2, cf3<a name='1138'>
<a name='1139'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='1140'>
    :: BN2<a name='1141'>
<a name='1142'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='1143'>
    :: rdz, rdzw, theta, t, p, p8w, t8w <a name='1144'>
<a name='1145'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='1146'>
    :: dnw, dn<a name='1147'>
<a name='1148'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme, n_moist), INTENT( INOUT )  &amp;<a name='1149'>
    :: moist<a name='1150'>
<a name='1151'>
<font color=#447700>! Local variables.<a name='1152'></font>
<a name='1153'>
    INTEGER  &amp;<a name='1154'>
    :: i, j, k, ktf, ispe, ktes1, ktes2,  &amp;<a name='1155'>
       i_start, i_end, j_start, j_end<a name='1156'>
<a name='1157'>
    REAL  &amp;<a name='1158'>
    :: coefa, thetaep1, thetaem1, qc_cr, es, tc, qlpqi, qsw, qsi,  &amp;<a name='1159'>
       tmpdz, xlvqv, thetaesfc, thetasfc, qvtop, qvsfc, thetatop, thetaetop<a name='1160'>
<a name='1161'>
    REAL, DIMENSION( its:ite, jts:jte )  &amp;<a name='1162'>
    :: tmp1sfc, tmp1top<a name='1163'>
<a name='1164'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='1165'>
    :: tmp1, qvs, qctmp<a name='1166'>
<a name='1167'>
<font color=#447700>! End declarations.<a name='1168'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1169'></font>
<a name='1170'>
    qc_cr   = 0.00001  <font color=#447700>! in Kg/Kg<a name='1171'></font>
<a name='1172'>
    ktf     = MIN( kte, kde-1 )<a name='1173'>
    ktes1   = kte-1<a name='1174'>
    ktes2   = kte-2<a name='1175'>
<a name='1176'>
    i_start = its<a name='1177'>
    i_end   = MIN( ite, ide-1 )<a name='1178'>
    j_start = jts<a name='1179'>
    j_end   = MIN( jte, jde-1 )<a name='1180'>
<a name='1181'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='1182'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='1183'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='1184'>
         config_flags%nested) i_end   = MIN( ide-2, ite )<a name='1185'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='1186'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='1187'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='1188'>
         config_flags%nested) j_end   = MIN( jde-2 ,jte )<a name='1189'>
 <a name='1190'>
    IF ( P_QC .GT. PARAM_FIRST_SCALAR) THEN<a name='1191'>
      DO j = j_start, j_end<a name='1192'>
      DO k = kts, ktf<a name='1193'>
      DO i = i_start, i_end<a name='1194'>
        qctmp(i,k,j) = moist(i,k,j,P_QC)<a name='1195'>
      END DO<a name='1196'>
      END DO<a name='1197'>
      END DO<a name='1198'>
    ELSE<a name='1199'>
      DO j = j_start, j_end<a name='1200'>
      DO k = kts, ktf<a name='1201'>
      DO i = i_start, i_end<a name='1202'>
         qctmp(i,k,j) = 0.0<a name='1203'>
      END DO<a name='1204'>
      END DO<a name='1205'>
      END DO<a name='1206'>
    END IF<a name='1207'>
 <a name='1208'>
    DO j = jts, jte<a name='1209'>
    DO k = kts, kte<a name='1210'>
    DO i = its, ite<a name='1211'>
      tmp1(i,k,j) = 0.0<a name='1212'>
    END DO<a name='1213'>
    END DO<a name='1214'>
    END DO<a name='1215'>
 <a name='1216'>
    DO j = jts,jte<a name='1217'>
    DO i = its,ite<a name='1218'>
      tmp1sfc(i,j) = 0.0<a name='1219'>
      tmp1top(i,j) = 0.0<a name='1220'>
    END DO<a name='1221'>
    END DO<a name='1222'>
 <a name='1223'>
    DO ispe = PARAM_FIRST_SCALAR, n_moist<a name='1224'>
      IF ( ispe .EQ. P_QV .OR. ispe .EQ. P_QC .OR. ispe .EQ. P_QI) THEN<a name='1225'>
        DO j = j_start, j_end<a name='1226'>
        DO k = kts, ktf<a name='1227'>
        DO i = i_start, i_end<a name='1228'>
          tmp1(i,k,j) = tmp1(i,k,j) + moist(i,k,j,ispe)<a name='1229'>
        END DO<a name='1230'>
        END DO<a name='1231'>
        END DO<a name='1232'>
 <a name='1233'>
        DO j = j_start, j_end<a name='1234'>
        DO i = i_start, i_end<a name='1235'>
          tmp1sfc(i,j) = tmp1sfc(i,j) +  &amp;<a name='1236'>
                         cf1 * moist(i,1,j,ispe) +  &amp;<a name='1237'>
                         cf2 * moist(i,2,j,ispe) +  &amp;<a name='1238'>
                         cf3 * moist(i,3,j,ispe)<a name='1239'>
          tmp1top(i,j) = tmp1top(i,j) +  &amp;<a name='1240'>
                         moist(i,ktes1,j,ispe) + &amp;<a name='1241'>
                         ( moist(i,ktes1,j,ispe) - moist(i,ktes2,j,ispe) ) *  &amp;<a name='1242'>
                         0.5 * dnw(ktes1) / dn(ktes1)<a name='1243'>
        END DO<a name='1244'>
        END DO<a name='1245'>
      END IF<a name='1246'>
    END DO<a name='1247'>
<a name='1248'>
<font color=#447700>! Calculate saturation mixing ratio.<a name='1249'></font>
<a name='1250'>
    DO j = j_start, j_end<a name='1251'>
    DO k = kts, ktf<a name='1252'>
    DO i = i_start, i_end<a name='1253'>
      tc         = t(i,k,j) - SVPT0<a name='1254'>
      es         = 1000.0 * SVP1 * EXP( SVP2 * tc / ( t(i,k,j) - SVP3 ) )<a name='1255'>
      qvs(i,k,j) = EP_2 * es / ( p(i,k,j) - es )<a name='1256'>
    END DO<a name='1257'>
    END DO<a name='1258'>
    END DO<a name='1259'>
 <a name='1260'>
    DO j = j_start, j_end<a name='1261'>
    DO k = kts+1, ktf-1<a name='1262'>
    DO i = i_start, i_end<a name='1263'>
      tmpdz = 1.0 / rdz(i,k,j) + 1.0 / rdz(i,k+1,j)<a name='1264'>
      IF ( moist(i,k,j,P_QV) .GE. qvs(i,k,j) .OR. qctmp(i,k,j) .GE. qc_cr) THEN<a name='1265'>
        xlvqv      = XLV * moist(i,k,j,P_QV)<a name='1266'>
        coefa      = ( 1.0 + xlvqv / R_d / t(i,k,j) ) / &amp;<a name='1267'>
                     ( 1.0 + XLV * xlvqv / Cp / R_v / t(i,k,j) / t(i,k,j) ) /  &amp;<a name='1268'>
                     theta(i,k,j)<a name='1269'>
        thetaep1   = theta(i,k+1,j) *  &amp;<a name='1270'>
                     ( 1.0 + XLV * qvs(i,k+1,j) / Cp / t(i,k+1,j) )<a name='1271'>
        thetaem1   = theta(i,k-1,j) *  &amp;<a name='1272'>
                     ( 1.0 + XLV * qvs(i,k-1,j) / Cp / t(i,k-1,j) )<a name='1273'>
        BN2(i,k,j) = g * ( coefa * ( thetaep1 - thetaem1 ) / tmpdz -  &amp;<a name='1274'>
                     ( tmp1(i,k+1,j) - tmp1(i,k-1,j) ) / tmpdz )<a name='1275'>
      ELSE<a name='1276'>
        BN2(i,k,j) = g * ( (theta(i,k+1,j) - theta(i,k-1,j) ) /  &amp;<a name='1277'>
                     theta(i,k,j) / tmpdz +  &amp;<a name='1278'>
                     1.61 * ( moist(i,k+1,j,P_QV) - moist(i,k-1,j,P_QV) ) / &amp;<a name='1279'>
                     tmpdz -   &amp;<a name='1280'>
                     ( tmp1(i,k+1,j) - tmp1(i,k-1,j) ) / tmpdz )<a name='1281'>
      ENDIF<a name='1282'>
    END DO<a name='1283'>
    END DO<a name='1284'>
    END DO<a name='1285'>
<a name='1286'>
    k = kts<a name='1287'>
    DO j = j_start, j_end<a name='1288'>
    DO i = i_start, i_end<a name='1289'>
      tmpdz     = 1.0 / rdz(i,k+1,j) + 0.5 / rdzw(i,k,j)<a name='1290'>
      thetasfc  = T8w(i,kts,j) / ( p8w(i,k,j) / p1000mb )**( R_d / Cp )<a name='1291'>
      IF ( moist(i,k,j,P_QV) .GE. qvs(i,k,j) .OR. qctmp(i,k,j) .GE. qc_cr) THEN<a name='1292'>
        qvsfc     = cf1 * qvs(i,1,j) +  &amp;<a name='1293'>
                    cf2 * qvs(i,2,j) +  &amp;<a name='1294'>
                    cf3 * qvs(i,3,j)<a name='1295'>
        xlvqv      = XLV * moist(i,k,j,P_QV)<a name='1296'>
        coefa      = ( 1.0 + xlvqv / R_d / t(i,k,j) ) /  &amp;<a name='1297'>
                     ( 1.0 + XLV * xlvqv / Cp / R_v / t(i,k,j) / t(i,k,j) ) /  &amp;<a name='1298'>
                     theta(i,k,j)<a name='1299'>
        thetaep1   = theta(i,k+1,j) *  &amp;<a name='1300'>
                     ( 1.0 + XLV * qvs(i,k+1,j) / Cp / t(i,k+1,j) )<a name='1301'>
        thetaesfc  = thetasfc *  &amp;<a name='1302'>
                     ( 1.0 + XLV * qvsfc / Cp / t8w(i,kts,j) )<a name='1303'>
        BN2(i,k,j) = g * ( coefa * ( thetaep1 - thetaesfc ) / tmpdz -  &amp;<a name='1304'>
                     ( tmp1(i,k+1,j) - tmp1sfc(i,j) ) / tmpdz )<a name='1305'>
      ELSE<a name='1306'>
        qvsfc     = cf1 * moist(i,1,j,P_QV) +  &amp;<a name='1307'>
                    cf2 * moist(i,2,j,P_QV) +  &amp;<a name='1308'>
                    cf3 * moist(i,3,j,P_QV)<a name='1309'>
<font color=#447700>!        BN2(i,k,j) = g * ( ( theta(i,k+1,j) - thetasfc ) /  &amp;<a name='1310'></font>
<font color=#447700>!                     theta(i,k,j) / tmpdz +  &amp;<a name='1311'></font>
<font color=#447700>!                     1.61 * ( moist(i,k+1,j,P_QV) - qvsfc ) /  &amp;<a name='1312'></font>
<font color=#447700>!                     tmpdz -  &amp;<a name='1313'></font>
<font color=#447700>!                     ( tmp1(i,k+1,j) - tmp1sfc(i,j) ) / tmpdz  )<a name='1314'></font>
<font color=#447700>!...... MARTA: change in computation of BN2 at the surface, WCS 040331<a name='1315'></font>
<a name='1316'>
        tmpdz= 1./rdzw(i,k,j) <font color=#447700>! controlare come calcola rdzw<a name='1317'></font>
        BN2(i,k,j) = g * ( ( theta(i,k+1,j) - theta(i,k,j)) /  &amp;<a name='1318'>
                     theta(i,k,j) / tmpdz +  &amp;<a name='1319'>
                     1.61 * ( moist(i,k+1,j,P_QV) - qvsfc ) /  &amp;<a name='1320'>
                     tmpdz -  &amp;<a name='1321'>
                     ( tmp1(i,k+1,j) - tmp1sfc(i,j) ) / tmpdz  )<a name='1322'>
<font color=#447700>! end of MARTA/WCS change<a name='1323'></font>
<a name='1324'>
      ENDIF<a name='1325'>
    END DO<a name='1326'>
    END DO<a name='1327'>
 <a name='1328'>
<a name='1329'>
<font color=#447700>!...... MARTA: change in computation of BN2 at the top, WCS 040331<a name='1330'></font>
    DO j = j_start, j_end<a name='1331'>
    DO i = i_start, i_end<a name='1332'>
       BN2(i,ktf,j)=BN2(i,ktf-1,j)<a name='1333'>
    END DO<a name='1334'>
    END DO   <a name='1335'>
<font color=#447700>! end of MARTA/WCS change<a name='1336'></font>
<a name='1337'>
    END SUBROUTINE calculate_N2<a name='1338'>
<a name='1339'>
<font color=#447700>!=======================================================================<a name='1340'></font>
<font color=#447700>!=======================================================================<a name='1341'></font>
<a name='1342'>
<A NAME='ISOTROPIC_KM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#ISOTROPIC_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1343'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>isotropic_km</font>( config_flags,                                         &amp; <A href='../../call_to/ISOTROPIC_KM.html' TARGET='index'>2</A><a name='1344'>
                         xkmh,xkmhd,xkmv,xkhh,xkhv,khdif,kvdif,                &amp;<a name='1345'>
                         ids,ide, jds,jde, kds,kde,                            &amp;<a name='1346'>
                         ims,ime, jms,jme, kms,kme,                            &amp;<a name='1347'>
                         its,ite, jts,jte, kts,kte                            )<a name='1348'>
<a name='1349'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1350'></font>
<font color=#447700>! Begin declarations.<a name='1351'></font>
<a name='1352'>
   IMPLICIT NONE<a name='1353'>
<a name='1354'>
   TYPE(grid_config_rec_type) , INTENT(IN   ) :: config_flags<a name='1355'>
<a name='1356'>
   INTEGER ,          INTENT(IN   )           :: ids, ide, jds, jde, kds, kde, &amp;<a name='1357'>
                                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1358'>
                                                 its, ite, jts, jte, kts, kte<a name='1359'>
<a name='1360'>
   REAL    ,          INTENT(IN   )           :: khdif,kvdif               <a name='1361'>
<a name='1362'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) ::     xkmh, &amp;<a name='1363'>
                                                                        xkmhd, &amp;<a name='1364'>
                                                                         xkmv, &amp;<a name='1365'>
                                                                         xkhh, &amp;<a name='1366'>
                                                                         xkhv<a name='1367'>
<font color=#447700>! LOCAL VARS<a name='1368'></font>
<a name='1369'>
   INTEGER :: i_start, i_end, j_start, j_end, ktf, i, j, k<a name='1370'>
   REAL    :: khdif3,kvdif3<a name='1371'>
<a name='1372'>
<font color=#447700>! End declarations.<a name='1373'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1374'></font>
<a name='1375'>
   ktf = kte<a name='1376'>
<a name='1377'>
   i_start = its<a name='1378'>
   i_end   = MIN(ite,ide-1)<a name='1379'>
   j_start = jts<a name='1380'>
   j_end   = MIN(jte,jde-1)<a name='1381'>
<a name='1382'>
<font color=#447700>!   khdif3=khdif*3.<a name='1383'></font>
<font color=#447700>!   kvdif3=kvdif*3.<a name='1384'></font>
   khdif3=khdif/prandtl<a name='1385'>
   kvdif3=kvdif/prandtl<a name='1386'>
<a name='1387'>
   DO j = j_start, j_end<a name='1388'>
   DO k = kts, ktf<a name='1389'>
   DO i = i_start, i_end<a name='1390'>
      xkmh(i,k,j)=khdif<a name='1391'>
      xkmhd(i,k,j)=khdif<a name='1392'>
      xkmv(i,k,j)=kvdif<a name='1393'>
      xkhh(i,k,j)=khdif3<a name='1394'>
      xkhv(i,k,j)=kvdif3<a name='1395'>
   ENDDO<a name='1396'>
   ENDDO<a name='1397'>
   ENDDO<a name='1398'>
<a name='1399'>
END SUBROUTINE isotropic_km<a name='1400'>
<a name='1401'>
<font color=#447700>!=======================================================================<a name='1402'></font>
<font color=#447700>!=======================================================================<a name='1403'></font>
<a name='1404'>
<A NAME='SMAG_KM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#SMAG_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1405'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>smag_km</font>( config_flags,xkmh,xkmhd,xkmv,xkhh,xkhv,BN2,                &amp; <A href='../../call_to/SMAG_KM.html' TARGET='index'>2</A><a name='1406'>
                    div,defor11,defor22,defor33,defor12,                       &amp;<a name='1407'>
                    defor13,defor23,                                           &amp;<a name='1408'>
                    rdzw,dx,dy,cr_len_in,                                      &amp;<a name='1409'>
                    ids,ide, jds,jde, kds,kde,                                 &amp;<a name='1410'>
                    ims,ime, jms,jme, kms,kme,                                 &amp;<a name='1411'>
                    its,ite, jts,jte, kts,kte                                  )<a name='1412'>
<a name='1413'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1414'></font>
<font color=#447700>! Begin declarations.<a name='1415'></font>
<a name='1416'>
   IMPLICIT NONE<a name='1417'>
<a name='1418'>
   TYPE(grid_config_rec_type) , INTENT(IN   ) :: config_flags<a name='1419'>
<a name='1420'>
   INTEGER ,          INTENT(IN   )           :: ids, ide, jds, jde, kds, kde, &amp;<a name='1421'>
                                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1422'>
                                                 its, ite, jts, jte, kts, kte<a name='1423'>
<a name='1424'>
   REAL    ,          INTENT(IN   )           :: cr_len_in, dx, dy<a name='1425'>
<a name='1426'>
<a name='1427'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) ::      BN2, &amp;<a name='1428'>
                                                                         rdzw<a name='1429'>
<a name='1430'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) ::     xkmh, &amp;<a name='1431'>
                                                                        xkmhd, &amp;<a name='1432'>
                                                                         xkmv, &amp;<a name='1433'>
                                                                         xkhh, &amp;<a name='1434'>
                                                                         xkhv<a name='1435'>
<a name='1436'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ),  INTENT(IN   )      ::      &amp;    <a name='1437'>
                                                                      defor11, &amp;<a name='1438'>
                                                                      defor22, &amp;<a name='1439'>
                                                                      defor33, &amp;<a name='1440'>
                                                                      defor12, &amp;<a name='1441'>
                                                                      defor13, &amp;<a name='1442'>
                                                                      defor23, &amp;<a name='1443'>
                                                                          div<a name='1444'>
<a name='1445'>
<font color=#447700>! LOCAL VARS<a name='1446'></font>
<a name='1447'>
   INTEGER :: i_start, i_end, j_start, j_end, ktf, i, j, k<a name='1448'>
   REAL    :: deltas, tmp, pr, mlen_h, mlen_v, cr_len<a name='1449'>
<a name='1450'>
   REAL, DIMENSION( its:ite , kts:kte , jts:jte )                 ::     def2<a name='1451'>
<a name='1452'>
<font color=#447700>! End declarations.<a name='1453'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1454'></font>
<a name='1455'>
   ktf = min(kte,kde-1)<a name='1456'>
<a name='1457'>
   i_start = its<a name='1458'>
   i_end   = MIN(ite,ide-1)<a name='1459'>
   j_start = jts<a name='1460'>
   j_end   = MIN(jte,jde-1)<a name='1461'>
<a name='1462'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='1463'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='1464'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='1465'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='1466'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='1467'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='1468'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='1469'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='1470'>
<a name='1471'>
   pr=1./3.<a name='1472'>
   cr_len = cr_len_in<a name='1473'>
<a name='1474'>
   do j=j_start,j_end<a name='1475'>
   do k=kts,ktf<a name='1476'>
   do i=i_start,i_end<a name='1477'>
      def2(i,k,j)=0.5*(defor11(i,k,j)*defor11(i,k,j) + &amp;<a name='1478'>
                       defor22(i,k,j)*defor22(i,k,j) + &amp;<a name='1479'>
                       defor33(i,k,j)*defor33(i,k,j))<a name='1480'>
   enddo<a name='1481'>
   enddo<a name='1482'>
   enddo<a name='1483'>
<a name='1484'>
   do j=j_start,j_end<a name='1485'>
   do k=kts,ktf<a name='1486'>
   do i=i_start,i_end<a name='1487'>
      tmp=0.25*(defor12(i  ,k,j)+defor12(i  ,k,j+1)+ &amp;<a name='1488'>
                defor12(i+1,k,j)+defor12(i+1,k,j+1))<a name='1489'>
      def2(i,k,j)=def2(i,k,j)+0.5*tmp*tmp<a name='1490'>
   enddo<a name='1491'>
   enddo<a name='1492'>
   enddo<a name='1493'>
<a name='1494'>
   do j=j_start,j_end<a name='1495'>
   do k=kts,ktf<a name='1496'>
   do i=i_start,i_end<a name='1497'>
      tmp=0.25*(defor13(i  ,k+1,j)+defor13(i  ,k,j)+ &amp;<a name='1498'>
                defor13(i+1,k+1,j)+defor13(i+1,k,j))<a name='1499'>
      def2(i,k,j)=def2(i,k,j)+0.5*tmp*tmp<a name='1500'>
   enddo<a name='1501'>
   enddo<a name='1502'>
   enddo<a name='1503'>
<a name='1504'>
   do j=j_start,j_end<a name='1505'>
   do k=kts,ktf<a name='1506'>
   do i=i_start,i_end<a name='1507'>
      tmp=0.25*(defor23(i,k+1,j  )+defor23(i,k,j  )+ &amp;<a name='1508'>
                defor23(i,k+1,j+1)+defor23(i,k,j+1))<a name='1509'>
      def2(i,k,j)=def2(i,k,j)+0.5*tmp*tmp<a name='1510'>
   enddo<a name='1511'>
   enddo<a name='1512'>
   enddo<a name='1513'>
<font color=#447700>!<a name='1514'></font>
   cr_len = dx + 1.  <font color=#447700>!  hardwire for mixing length = (dx*dy*dz)**(1/3).<a name='1515'></font>
                     <font color=#447700>!  remove this for the alternate formulation<a name='1516'></font>
<a name='1517'>
   IF (dx .gt. cr_len) THEN<a name='1518'>
      mlen_h=sqrt(dx*dy)<a name='1519'>
      DO j = j_start, j_end<a name='1520'>
      DO k = kts, ktf<a name='1521'>
      DO i = i_start, i_end<a name='1522'>
         mlen_v= 1./rdzw(i,k,j)<a name='1523'>
         tmp=max(0.,def2(i,k,j)-BN2(i,k,j)/pr)<a name='1524'>
         tmp=tmp**0.5<a name='1525'>
         xkmh(i,k,j)=max(c_s*c_s*mlen_h*mlen_h*tmp, 1.0E-6*mlen_h*mlen_h )<a name='1526'>
         xkmh(i,k,j)=min(xkmh(i,k,j), 10.*mlen_h )<a name='1527'>
         xkmhd(i,k,j)=xkmh(i,k,j)<a name='1528'>
         xkmv(i,k,j)=max(c_s*c_s*mlen_v*mlen_v*tmp, 1.0E-6*mlen_v*mlen_v )<a name='1529'>
         xkmv(i,k,j)=min(xkmv(i,k,j), 10.*mlen_v )<a name='1530'>
         xkhh(i,k,j)=xkmh(i,k,j)/pr<a name='1531'>
         xkhv(i,k,j)=xkmv(i,k,j)/pr<a name='1532'>
      ENDDO<a name='1533'>
      ENDDO<a name='1534'>
      ENDDO<a name='1535'>
   ELSE<a name='1536'>
      DO j = j_start, j_end<a name='1537'>
      DO k = kts, ktf<a name='1538'>
      DO i = i_start, i_end<a name='1539'>
         deltas=(dx*dy/rdzw(i,k,j))**0.33333333<a name='1540'>
         tmp=max(0.,def2(i,k,j)-BN2(i,k,j)/pr)<a name='1541'>
         tmp=tmp**0.5<a name='1542'>
         xkmh(i,k,j)=max(c_s*c_s*deltas*deltas*tmp, 1.0E-6*deltas*deltas )<a name='1543'>
         xkmh(i,k,j)=min(xkmh(i,k,j), 10.*deltas )<a name='1544'>
         xkmhd(i,k,j)=xkmh(i,k,j)<a name='1545'>
         xkmv(i,k,j)=xkmh(i,k,j)<a name='1546'>
         xkhh(i,k,j)=xkmh(i,k,j)/pr<a name='1547'>
         xkhv(i,k,j)=xkmv(i,k,j)/pr<a name='1548'>
      ENDDO<a name='1549'>
      ENDDO<a name='1550'>
      ENDDO<a name='1551'>
   ENDIF<a name='1552'>
<a name='1553'>
END SUBROUTINE smag_km<a name='1554'>
<a name='1555'>
<font color=#447700>!=======================================================================<a name='1556'></font>
<font color=#447700>!=======================================================================<a name='1557'></font>
<a name='1558'>
<A NAME='SMAG2D_KM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#SMAG2D_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1559'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>smag2d_km</font>( config_flags,xkmh,xkmhd,xkmv,xkhh,xkhv,                  &amp; <A href='../../call_to/SMAG2D_KM.html' TARGET='index'>2</A><a name='1560'>
                    defor11,defor22,defor12,                                   &amp;<a name='1561'>
                    rdzw,dx,dy,                                                &amp;<a name='1562'>
                    ids,ide, jds,jde, kds,kde,                                 &amp;<a name='1563'>
                    ims,ime, jms,jme, kms,kme,                                 &amp;<a name='1564'>
                    its,ite, jts,jte, kts,kte                                  )<a name='1565'>
<a name='1566'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1567'></font>
<font color=#447700>! Begin declarations.<a name='1568'></font>
<a name='1569'>
   IMPLICIT NONE<a name='1570'>
<a name='1571'>
   TYPE(grid_config_rec_type) , INTENT(IN   ) :: config_flags<a name='1572'>
<a name='1573'>
   INTEGER ,          INTENT(IN   )           :: ids, ide, jds, jde, kds, kde, &amp;<a name='1574'>
                                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1575'>
                                                 its, ite, jts, jte, kts, kte<a name='1576'>
<a name='1577'>
   REAL    ,          INTENT(IN   )           :: dx, dy<a name='1578'>
<a name='1579'>
<a name='1580'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) ::     rdzw<a name='1581'>
<a name='1582'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) ::     xkmh, &amp;<a name='1583'>
                                                                        xkmhd, &amp;<a name='1584'>
                                                                         xkmv, &amp;<a name='1585'>
                                                                         xkhh, &amp;<a name='1586'>
                                                                         xkhv<a name='1587'>
<a name='1588'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ),  INTENT(IN   )      ::      &amp;    <a name='1589'>
                                                                      defor11, &amp;<a name='1590'>
                                                                      defor22, &amp;<a name='1591'>
                                                                      defor12<a name='1592'>
<a name='1593'>
<font color=#447700>! LOCAL VARS<a name='1594'></font>
<a name='1595'>
   INTEGER :: i_start, i_end, j_start, j_end, ktf, i, j, k<a name='1596'>
   REAL    :: deltas, tmp, pr, mlen_h<a name='1597'>
<a name='1598'>
   REAL, DIMENSION( its:ite , kts:kte , jts:jte )                 ::     def2<a name='1599'>
<a name='1600'>
<font color=#447700>! End declarations.<a name='1601'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1602'></font>
<a name='1603'>
   ktf = min(kte,kde-1)<a name='1604'>
<a name='1605'>
   i_start = its<a name='1606'>
   i_end   = MIN(ite,ide-1)<a name='1607'>
   j_start = jts<a name='1608'>
   j_end   = MIN(jte,jde-1)<a name='1609'>
<a name='1610'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='1611'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='1612'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='1613'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='1614'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='1615'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='1616'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='1617'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='1618'>
<a name='1619'>
   pr=1./3.<a name='1620'>
<a name='1621'>
   do j=j_start,j_end<a name='1622'>
   do k=kts,ktf<a name='1623'>
   do i=i_start,i_end<a name='1624'>
      def2(i,k,j)=0.25*(defor11(i,k,j)-defor22(i,k,j))**2 + &amp;<a name='1625'>
                       defor12(i,k,j)*defor12(i,k,j)<a name='1626'>
   enddo<a name='1627'>
   enddo<a name='1628'>
   enddo<a name='1629'>
<font color=#447700>!<a name='1630'></font>
      mlen_h=sqrt(dx*dy)<a name='1631'>
      DO j = j_start, j_end<a name='1632'>
      DO k = kts, ktf<a name='1633'>
      DO i = i_start, i_end<a name='1634'>
         tmp=def2(i,k,j)**0.5<a name='1635'>
<font color=#447700>!        xkmh(i,k,j)=max(c_s*c_s*mlen_h*mlen_h*tmp, 1.0E-6*mlen_h*mlen_h )<a name='1636'></font>
         xkmh(i,k,j)=c_s*c_s*mlen_h*mlen_h*tmp<a name='1637'>
         xkmh(i,k,j)=min(xkmh(i,k,j), 10.*mlen_h )<a name='1638'>
         xkmhd(i,k,j)=xkmh(i,k,j)<a name='1639'>
         xkmv(i,k,j)=0.<a name='1640'>
         xkhh(i,k,j)=xkmh(i,k,j)/pr<a name='1641'>
         xkhv(i,k,j)=0.<a name='1642'>
      ENDDO<a name='1643'>
      ENDDO<a name='1644'>
      ENDDO<a name='1645'>
<a name='1646'>
END SUBROUTINE smag2d_km<a name='1647'>
<a name='1648'>
<font color=#447700>!=======================================================================<a name='1649'></font>
<font color=#447700>!=======================================================================<a name='1650'></font>
<a name='1651'>
<A NAME='TKE_KM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1652'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>tke_km</font>( config_flags, xkmh, xkmhd, xkmv, xkhh, xkhv,  &amp; <A href='../../call_to/TKE_KM.html' TARGET='index'>2</A>,<A href='../../call_from/TKE_KM.html' TARGET='index'>1</A><a name='1653'>
                       bn2, tke, p8w, t8w, theta,                    &amp;<a name='1654'>
                       rdz, rdzw, dx,dy, cr_len_in,                  &amp;<a name='1655'>
                       kh_tke_upper_bound, kv_tke_upper_bound,       &amp;<a name='1656'>
                       ids, ide, jds, jde, kds, kde,                 &amp;<a name='1657'>
                       ims, ime, jms, jme, kms, kme,                 &amp;<a name='1658'>
                       its, ite, jts, jte, kts, kte                  )<a name='1659'>
<a name='1660'>
<font color=#447700>! History:     Sep 2003   Changes by Jason Knievel and George Bryan, NCAR<a name='1661'></font>
<font color=#447700>!              Oct 2001   Converted to mass core by Bill Skamarock, NCAR<a name='1662'></font>
<font color=#447700>!              ...        ...<a name='1663'></font>
<a name='1664'>
<font color=#447700>! Purpose:     This routine calculates the exchange coefficients for the<a name='1665'></font>
<font color=#447700>!              TKE turbulence parameterization.<a name='1666'></font>
<a name='1667'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='1668'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='1669'></font>
<a name='1670'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1671'></font>
<font color=#447700>! Begin declarations.<a name='1672'></font>
<a name='1673'>
    IMPLICIT NONE<a name='1674'>
<a name='1675'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='1676'>
    :: config_flags<a name='1677'>
<a name='1678'>
    INTEGER, INTENT( IN )  &amp;<a name='1679'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='1680'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='1681'>
       its, ite, jts, jte, kts, kte<a name='1682'>
<a name='1683'>
    REAL, INTENT( IN )  &amp;<a name='1684'>
    :: cr_len_in, dx, dy<a name='1685'>
<a name='1686'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='1687'>
    :: tke, p8w, t8w, theta, rdz, rdzw, bn2<a name='1688'>
<a name='1689'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='1690'>
    :: xkmh, xkmhd, xkmv, xkhh, xkhv<a name='1691'>
<a name='1692'>
    REAL, INTENT( IN )  &amp;<a name='1693'>
    :: kh_tke_upper_bound, kv_tke_upper_bound<a name='1694'>
<a name='1695'>
<font color=#447700>! Local variables.<a name='1696'></font>
<a name='1697'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='1698'>
    :: l_scale<a name='1699'>
<a name='1700'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='1701'>
    :: dthrdn<a name='1702'>
<a name='1703'>
    REAL  &amp;<a name='1704'>
    :: deltas, tmp, mlen_s, mlen_h, mlen_v, tmpdz,  &amp;<a name='1705'>
       thetasfc, thetatop, minkx, pr_inv, pr_inv_h, pr_inv_v, cr_len<a name='1706'>
<a name='1707'>
    INTEGER  &amp;<a name='1708'>
    :: i_start, i_end, j_start, j_end, ktf, i, j, k<a name='1709'>
<a name='1710'>
    REAL, PARAMETER :: tke_seed_value = 1.e-06<a name='1711'>
    REAL            :: tke_seed<a name='1712'>
    REAL, PARAMETER :: epsilon = 1.e-10<a name='1713'>
<a name='1714'>
<font color=#447700>! End declarations.<a name='1715'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1716'></font>
<a name='1717'>
    ktf     = MIN( kte, kde-1 )<a name='1718'>
    i_start = its<a name='1719'>
    i_end   = MIN( ite, ide-1 )<a name='1720'>
    j_start = jts<a name='1721'>
    j_end   = MIN( jte, jde-1 )<a name='1722'>
<a name='1723'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='1724'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='1725'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='1726'>
         config_flags%nested) i_end   = MIN( ide-2, ite )<a name='1727'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='1728'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='1729'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='1730'>
         config_flags%nested) j_end   = MIN( jde-2, jte)<a name='1731'>
<a name='1732'>
<font color=#447700>! in the absence of surface drag or a surface heat flux, there<a name='1733'></font>
<font color=#447700>! is no way to generate tke without pre-existing tke.  Use<a name='1734'></font>
<font color=#447700>! tke_seed if the drag and flux are off.<a name='1735'></font>
<a name='1736'>
    cr_len = cr_len_in<a name='1737'>
    tke_seed = tke_seed_value<a name='1738'>
    if( (config_flags%tke_drag_coefficient .gt. epsilon) .or.  &amp;<a name='1739'>
        (config_flags%tke_heat_flux .gt. epsilon)  ) tke_seed = 0.<a name='1740'>
<a name='1741'>
    DO j = j_start, j_end<a name='1742'>
    DO k = kts+1, ktf-1<a name='1743'>
    DO i = i_start, i_end<a name='1744'>
      tmpdz         = 1.0 / ( rdz(i,k+1,j) + rdz(i,k,j) )<a name='1745'>
      dthrdn(i,k,j) = ( theta(i,k+1,j) - theta(i,k-1,j) ) / tmpdz<a name='1746'>
    END DO<a name='1747'>
    END DO<a name='1748'>
    END DO<a name='1749'>
<a name='1750'>
    k = kts<a name='1751'>
    DO j = j_start, j_end<a name='1752'>
    DO i = i_start, i_end<a name='1753'>
      tmpdz         = 1.0 / ( rdzw(i,k+1,j) + rdzw(i,k,j) )<a name='1754'>
      thetasfc      = T8w(i,kts,j) / ( p8w(i,k,j) / p1000mb )**( R_d / Cp )<a name='1755'>
      dthrdn(i,k,j) = ( theta(i,k+1,j) - thetasfc ) / tmpdz<a name='1756'>
    END DO<a name='1757'>
    END DO<a name='1758'>
<a name='1759'>
    k = ktf<a name='1760'>
    DO j = j_start, j_end<a name='1761'>
    DO i = i_start, i_end<a name='1762'>
      tmpdz         = 1.0 / rdz(i,k,j) + 0.5 / rdzw(i,k,j)<a name='1763'>
      thetatop      = T8w(i,kde,j) / ( p8w(i,kde,j) / p1000mb )**( R_d / Cp )<a name='1764'>
      dthrdn(i,k,j) = ( thetatop - theta(i,k-1,j) ) / tmpdz<a name='1765'>
    END DO<a name='1766'>
    END DO<a name='1767'>
<a name='1768'>
    cr_len = dx + 1.0 <font color=#447700>!  hardwire for mixing length = (dx*dy*dz)**(1/3).<a name='1769'></font>
                      <font color=#447700>!  remove this for the alternate formulation<a name='1770'></font>
<a name='1771'>
    IF ( dx .gt. cr_len ) THEN<a name='1772'>
      mlen_h = SQRT( dx * dy )<a name='1773'>
      DO j = j_start, j_end<a name='1774'>
      DO k = kts, ktf<a name='1775'>
      DO i = i_start, i_end<a name='1776'>
        tmp    = SQRT( MAX( tke(i,k,j), tke_seed ) )<a name='1777'>
        deltas = 1.0 / rdzw(i,k,j)<a name='1778'>
        mlen_v = deltas<a name='1779'>
        IF ( dthrdn(i,k,j) .GT. 0.) THEN<a name='1780'>
          mlen_s = 0.76 * tmp / ( ABS( g / theta(i,k,j) * dthrdn(i,k,j) ) )**0.5<a name='1781'>
          mlen_v = MIN( mlen_v, mlen_s )<a name='1782'>
        END IF<a name='1783'>
        xkmh(i,k,j)  = MAX( c_k * tmp * mlen_h, 1.0E-6 * mlen_h * mlen_h )<a name='1784'>
        xkmh(i,k,j)  = MIN( xkmh(i,k,j), 10.0 * mlen_h )<a name='1785'>
        xkmhd(i,k,j) = xkmh(i,k,j)<a name='1786'>
        xkmv(i,k,j)  = MAX( c_k * tmp * mlen_v, 1.0E-6 * deltas * deltas )<a name='1787'>
        xkmv(i,k,j)  = MIN( xkmv(i,k,j), 10.0 * deltas )<a name='1788'>
        pr_inv_h     = 3.0<a name='1789'>
        pr_inv_v     = 1.0 + 2.0 * mlen_v / deltas<a name='1790'>
        xkhh(i,k,j)  = xkmh(i,k,j) * pr_inv_h<a name='1791'>
        xkhv(i,k,j)  = xkmv(i,k,j) * pr_inv_v<a name='1792'>
      END DO<a name='1793'>
      END DO<a name='1794'>
      END DO<a name='1795'>
    ELSE<a name='1796'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALC_L_SCALE'>calc_l_scale</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_KM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_L_SCALE_1">( config_flags, tke, BN2, l_scale,      &amp;<a name='1797'>
                         i_start, i_end, ktf, j_start, j_end,  &amp;<a name='1798'>
                         dx, dy, rdzw,                         &amp;<a name='1799'>
                         ids, ide, jds, jde, kds, kde,         &amp;<a name='1800'>
                         ims, ime, jms, jme, kms, kme,         &amp;<a name='1801'>
                         its, ite, jts, jte, kts, kte          )<a name='1802'>
      DO j = j_start, j_end<a name='1803'>
      DO k = kts, ktf<a name='1804'>
      DO i = i_start, i_end<a name='1805'>
        tmp          = SQRT( MAX( tke(i,k,j), tke_seed ) )<a name='1806'>
        deltas       = ( dx * dy / rdzw(i,k,j) )**0.33333333<a name='1807'>
        xkmh(i,k,j)  = c_k * tmp * l_scale(i,k,j)<a name='1808'>
        xkmh(i,k,j)  = MIN( kh_tke_upper_bound,  xkmh(i,k,j) )<a name='1809'>
        xkmhd(i,k,j) = xkmh(i,k,j)<a name='1810'>
        xkmv(i,k,j)  = c_k * tmp * l_scale(i,k,j)<a name='1811'>
        xkmv(i,k,j)  = MIN( kv_tke_upper_bound,  xkmv(i,k,j) )<a name='1812'>
        pr_inv       = 1.0 + 2.0 * l_scale(i,k,j) / deltas<a name='1813'>
        xkhh(i,k,j)  = MIN( kh_tke_upper_bound*pr_inv, xkmh(i,k,j) * pr_inv )<a name='1814'>
        xkhv(i,k,j)  = MIN( kv_tke_upper_bound*pr_inv, xkmv(i,k,j) * pr_inv )<a name='1815'>
      END DO<a name='1816'>
      END DO<a name='1817'>
      END DO<a name='1818'>
    END IF<a name='1819'>
<a name='1820'>
    END SUBROUTINE tke_km<a name='1821'>
<a name='1822'>
<font color=#447700>!=======================================================================<a name='1823'></font>
<font color=#447700>!=======================================================================<a name='1824'></font>
<a name='1825'>
<A NAME='CALC_L_SCALE'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALC_L_SCALE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1826'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_l_scale</font>( config_flags, tke, BN2, l_scale,      &amp; <A href='../../call_to/CALC_L_SCALE.html' TARGET='index'>3</A><a name='1827'>
                             i_start, i_end, ktf, j_start, j_end,  &amp;<a name='1828'>
                             dx, dy, rdzw,                         &amp;<a name='1829'>
                             ids, ide, jds, jde, kds, kde,         &amp;<a name='1830'>
                             ims, ime, jms, jme, kms, kme,         &amp;<a name='1831'>
                             its, ite, jts, jte, kts, kte          )<a name='1832'>
<a name='1833'>
<font color=#447700>! History:     Sep 2003   Written by Bryan and Knievel, NCAR<a name='1834'></font>
<a name='1835'>
<font color=#447700>! Purpose:     This routine calculates the length scale, based on stability,<a name='1836'></font>
<font color=#447700>!              for TKE parameterization of subgrid-scale turbulence.<a name='1837'></font>
<a name='1838'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1839'></font>
<font color=#447700>! Begin declarations.<a name='1840'></font>
<a name='1841'>
    IMPLICIT NONE<a name='1842'>
<a name='1843'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='1844'>
    :: config_flags<a name='1845'>
<a name='1846'>
    INTEGER, INTENT( IN )  &amp;<a name='1847'>
    :: i_start, i_end, ktf, j_start, j_end,  &amp;<a name='1848'>
       ids, ide, jds, jde, kds, kde,         &amp;<a name='1849'>
       ims, ime, jms, jme, kms, kme,         &amp;<a name='1850'>
       its, ite, jts, jte, kts, kte<a name='1851'>
<a name='1852'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='1853'>
    :: BN2, tke, rdzw<a name='1854'>
<a name='1855'>
    REAL, INTENT( IN )  &amp;<a name='1856'>
    :: dx, dy<a name='1857'>
<a name='1858'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte ), INTENT( OUT )  &amp;<a name='1859'>
    :: l_scale<a name='1860'>
<a name='1861'>
<font color=#447700>! Local variables.<a name='1862'></font>
<a name='1863'>
    INTEGER  &amp;<a name='1864'>
    :: i, j, k<a name='1865'>
<a name='1866'>
    REAL  &amp;<a name='1867'>
    :: deltas, tmp<a name='1868'>
<a name='1869'>
<font color=#447700>! End declarations.<a name='1870'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1871'></font>
<a name='1872'>
    DO j = j_start, j_end<a name='1873'>
    DO k = kts, ktf<a name='1874'>
    DO i = i_start, i_end<a name='1875'>
      deltas         = ( dx * dy / rdzw(i,k,j) )**0.33333333<a name='1876'>
      l_scale(i,k,j) = deltas<a name='1877'>
<a name='1878'>
      IF ( BN2(i,k,j) .gt. 1.0e-6 ) THEN<a name='1879'>
        tmp            = SQRT( MAX( tke(i,k,j), 1.0e-6 ) )<a name='1880'>
        l_scale(i,k,j) = 0.76 * tmp / SQRT( BN2(i,k,j) )<a name='1881'>
        l_scale(i,k,j) = MIN( l_scale(i,k,j), deltas)<a name='1882'>
        l_scale(i,k,j) = MAX( l_scale(i,k,j), 0.001 * deltas )<a name='1883'>
      END IF<a name='1884'>
<a name='1885'>
    END DO<a name='1886'>
    END DO<a name='1887'>
    END DO<a name='1888'>
<a name='1889'>
    END SUBROUTINE calc_l_scale<a name='1890'>
<a name='1891'>
<font color=#447700>!=======================================================================<a name='1892'></font>
<font color=#447700>!=======================================================================<a name='1893'></font>
<a name='1894'>
<A NAME='HORIZONTAL_DIFFUSION_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1895'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_2</font> ( rt_tendf, ru_tendf, rv_tendf, rw_tendf,    &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_2.html' TARGET='index'>3</A>,<A href='../../call_from/HORIZONTAL_DIFFUSION_2.html' TARGET='index'>7</A><a name='1896'>
                                    tke_tendf,                                 &amp;<a name='1897'>
                                    moist_tendf, n_moist,                      &amp;<a name='1898'>
                                    scalar_tendf, n_scalar,                    &amp;<a name='1899'>
                                    thp, theta, mu, tke, config_flags,         &amp;<a name='1900'>
                                    defor11, defor22, defor12,                 &amp;<a name='1901'>
                                    defor13, defor23, div,                     &amp;<a name='1902'>
                                    moist, scalar,                             &amp;<a name='1903'>
                                    msfu, msfv, msft, xkmh, xkhh,km_opt,       &amp;<a name='1904'>
                                    rdx, rdy, rdz, rdzw, fnm, fnp,             &amp;<a name='1905'>
                                    cf1, cf2, cf3, zx, zy, dn, dnw,            &amp;<a name='1906'>
                                    ids, ide, jds, jde, kds, kde,              &amp;<a name='1907'>
                                    ims, ime, jms, jme, kms, kme,              &amp;<a name='1908'>
                                    its, ite, jts, jte, kts, kte               )<a name='1909'>
<a name='1910'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1911'></font>
<font color=#447700>! Begin declarations.<a name='1912'></font>
<a name='1913'>
   IMPLICIT NONE<a name='1914'>
<a name='1915'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='1916'>
<a name='1917'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='1918'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='1919'>
                                            its, ite, jts, jte, kts, kte<a name='1920'>
<a name='1921'>
   INTEGER ,        INTENT(IN   ) ::        n_moist, n_scalar, km_opt<a name='1922'>
<a name='1923'>
   REAL ,           INTENT(IN   ) ::        cf1, cf2, cf3<a name='1924'>
<a name='1925'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='1926'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='1927'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: dnw<a name='1928'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::  dn<a name='1929'>
<a name='1930'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msfu, &amp;<a name='1931'>
                                                                    msfv, &amp;<a name='1932'>
                                                                    msft, &amp;<a name='1933'>
                                                                      mu<a name='1934'>
<a name='1935'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::rt_tendf,&amp;<a name='1936'>
                                                                 ru_tendf,&amp;<a name='1937'>
                                                                 rv_tendf,&amp;<a name='1938'>
                                                                 rw_tendf,&amp;<a name='1939'>
                                                                tke_tendf<a name='1940'>
<a name='1941'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist),                 &amp;<a name='1942'>
          INTENT(INOUT) ::                                    moist_tendf<a name='1943'>
<a name='1944'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_scalar),                &amp;<a name='1945'>
          INTENT(INOUT) ::                                   scalar_tendf<a name='1946'>
<a name='1947'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist),                 &amp;<a name='1948'>
          INTENT(IN   ) ::                                          moist<a name='1949'>
<a name='1950'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_scalar) ,               &amp;<a name='1951'>
          INTENT(IN   ) ::                                         scalar <a name='1952'>
<a name='1953'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::defor11, &amp;<a name='1954'>
                                                                 defor22, &amp;<a name='1955'>
                                                                 defor12, &amp;<a name='1956'>
                                                                 defor13, &amp;<a name='1957'>
                                                                 defor23, &amp;<a name='1958'>
                                                                     div, &amp;<a name='1959'>
                                                                    xkmh, &amp;<a name='1960'>
                                                                    xkhh, &amp;<a name='1961'>
                                                                      zx, &amp;<a name='1962'>
                                                                      zy, &amp;<a name='1963'>
                                                                   theta, &amp;<a name='1964'>
                                                                     thp, &amp;<a name='1965'>
                                                                     tke, &amp;<a name='1966'>
                                                                     rdz, &amp;<a name='1967'>
                                                                    rdzw<a name='1968'>
<a name='1969'>
<a name='1970'>
   REAL ,                                        INTENT(IN   ) ::    rdx, &amp;<a name='1971'>
                                                                     rdy<a name='1972'>
<a name='1973'>
<font color=#447700>! LOCAL VARS<a name='1974'></font>
   <a name='1975'>
   INTEGER :: im<a name='1976'>
<a name='1977'>
<font color=#447700>!  REAL , DIMENSION(its-1:ite+1, kts:kte, jts-1:jte+1)       ::     xkhh<a name='1978'></font>
<a name='1979'>
<font color=#447700>! End declarations.<a name='1980'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1981'></font>
<a name='1982'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1983'></font>
<font color=#447700>! Call diffusion subroutines.<a name='1984'></font>
<a name='1985'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_U_2'>horizontal_diffusion_u_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_U_2_1">( ru_tendf, mu, config_flags,             &amp;<a name='1986'>
                                   defor11, defor12, div,                  &amp;<a name='1987'>
                                   tke(ims,kms,jms),                       &amp;<a name='1988'>
                                   msfu, xkmh, rdx, rdy, fnm, fnp,         &amp;<a name='1989'>
                                   zx, zy, rdzw,                           &amp;<a name='1990'>
                                   ids, ide, jds, jde, kds, kde,           &amp;<a name='1991'>
                                   ims, ime, jms, jme, kms, kme,           &amp;<a name='1992'>
                                   its, ite, jts, jte, kts, kte           )<a name='1993'>
<a name='1994'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_V_2'>horizontal_diffusion_v_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_V_2_1">( rv_tendf, mu, config_flags,             &amp;<a name='1995'>
                                   defor12, defor22, div,                  &amp;<a name='1996'>
                                   tke(ims,kms,jms),                       &amp;<a name='1997'>
                                   msfv, xkmh, rdx, rdy, fnm, fnp,         &amp;<a name='1998'>
                                   zx, zy, rdzw,                           &amp;<a name='1999'>
                                   ids, ide, jds, jde, kds, kde,           &amp;<a name='2000'>
                                   ims, ime, jms, jme, kms, kme,           &amp;<a name='2001'>
                                   its, ite, jts, jte, kts, kte           )<a name='2002'>
<a name='2003'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_W_2'>horizontal_diffusion_w_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_W_2_1">( rw_tendf, mu, config_flags,             &amp;<a name='2004'>
                                   defor13, defor23, div,                  &amp;<a name='2005'>
                                   tke(ims,kms,jms),                       &amp;<a name='2006'>
                                   msft, xkmh, rdx, rdy, fnm, fnp,         &amp;<a name='2007'>
                                   zx, zy, rdz,                            &amp;<a name='2008'>
                                   ids, ide, jds, jde, kds, kde,           &amp;<a name='2009'>
                                   ims, ime, jms, jme, kms, kme,           &amp;<a name='2010'>
                                   its, ite, jts, jte, kts, kte           )<a name='2011'>
<a name='2012'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S'>horizontal_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_S_1">  ( rt_tendf, mu, config_flags, thp,        &amp;<a name='2013'>
                                   msft, msfu, msfv, xkhh, rdx, rdy,       &amp;<a name='2014'>
                                   fnm, fnp, cf1, cf2, cf3,                &amp;<a name='2015'>
                                   zx, zy, rdz, rdzw, dnw, dn,             &amp;<a name='2016'>
                                   .false.,                                &amp;<a name='2017'>
                                   ids, ide, jds, jde, kds, kde,           &amp;<a name='2018'>
                                   ims, ime, jms, jme, kms, kme,           &amp;<a name='2019'>
                                   its, ite, jts, jte, kts, kte           )<a name='2020'>
<a name='2021'>
    IF (km_opt .eq. 2)                                                     &amp;<a name='2022'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S'>horizontal_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_S_2">  ( tke_tendf(ims,kms,jms),                 &amp;<a name='2023'>
                                   mu, config_flags,                       &amp;<a name='2024'>
                                   tke(ims,kms,jms),                       &amp;<a name='2025'>
                                   msft, msfu, msfv, xkhh, rdx, rdy,       &amp;<a name='2026'>
                                   fnm, fnp, cf1, cf2, cf3,                &amp;<a name='2027'>
                                   zx, zy, rdz, rdzw, dnw, dn,             &amp;<a name='2028'>
                                   .true.,                                 &amp;<a name='2029'>
                                   ids, ide, jds, jde, kds, kde,           &amp;<a name='2030'>
                                   ims, ime, jms, jme, kms, kme,           &amp;<a name='2031'>
                                   its, ite, jts, jte, kts, kte           )<a name='2032'>
<a name='2033'>
    IF (n_moist .ge. PARAM_FIRST_SCALAR) THEN <a name='2034'>
<a name='2035'>
      moist_loop: do im = PARAM_FIRST_SCALAR, n_moist<a name='2036'>
<a name='2037'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S'>horizontal_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_S_3">( moist_tendf(ims,kms,jms,im),       &amp;<a name='2038'>
                                       mu, config_flags,                  &amp;<a name='2039'>
                                       moist(ims,kms,jms,im),             &amp;<a name='2040'>
                                       msft, msfu, msfv, xkhh, rdx, rdy,  &amp;<a name='2041'>
                                       fnm, fnp, cf1, cf2, cf3,           &amp;<a name='2042'>
                                       zx, zy, rdz, rdzw, dnw, dn,        &amp;<a name='2043'>
                                       .false.,                           &amp;<a name='2044'>
                                       ids, ide, jds, jde, kds, kde,      &amp;<a name='2045'>
                                       ims, ime, jms, jme, kms, kme,      &amp;<a name='2046'>
                                       its, ite, jts, jte, kts, kte      )<a name='2047'>
<a name='2048'>
      ENDDO moist_loop<a name='2049'>
<a name='2050'>
    ENDIF<a name='2051'>
<a name='2052'>
    IF (n_scalar .ge. PARAM_FIRST_SCALAR) THEN <a name='2053'>
<a name='2054'>
      scalar_loop: do im = PARAM_FIRST_SCALAR, n_scalar<a name='2055'>
<a name='2056'>
        CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S'>horizontal_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_S_4">( scalar_tendf(ims,kms,jms,im),     &amp;<a name='2057'>
                                     mu, config_flags,                 &amp;<a name='2058'>
                                     scalar(ims,kms,jms,im),           &amp;<a name='2059'>
                                     msft, msfu, msfv, xkhh, rdx, rdy, &amp;<a name='2060'>
                                     fnm, fnp, cf1, cf2, cf3,          &amp;<a name='2061'>
                                     zx, zy, rdz, rdzw, dnw, dn,       &amp;<a name='2062'>
                                     .false.,                          &amp;<a name='2063'>
                                     ids, ide, jds, jde, kds, kde,     &amp;<a name='2064'>
                                     ims, ime, jms, jme, kms, kme,     &amp;<a name='2065'>
                                     its, ite, jts, jte, kts, kte     )<a name='2066'>
<a name='2067'>
      ENDDO scalar_loop<a name='2068'>
<a name='2069'>
    ENDIF<a name='2070'>
<a name='2071'>
    END SUBROUTINE horizontal_diffusion_2<a name='2072'>
<a name='2073'>
<font color=#447700>!=======================================================================<a name='2074'></font>
<font color=#447700>!=======================================================================<a name='2075'></font>
<a name='2076'>
<A NAME='HORIZONTAL_DIFFUSION_U_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_U_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2077'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_u_2</font>( tendency, mu, config_flags,          &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_U_2.html' TARGET='index'>1</A>,<A href='../../call_from/HORIZONTAL_DIFFUSION_U_2.html' TARGET='index'>2</A><a name='2078'>
                                     defor11, defor12, div, tke,          &amp;<a name='2079'>
                                     msfu, xkmh, rdx, rdy, fnm, fnp,      &amp;<a name='2080'>
                                     zx, zy, rdzw,                        &amp;<a name='2081'>
                                     ids, ide, jds, jde, kds, kde,        &amp;<a name='2082'>
                                     ims, ime, jms, jme, kms, kme,        &amp;<a name='2083'>
                                     its, ite, jts, jte, kts, kte        )<a name='2084'>
<a name='2085'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2086'></font>
<font color=#447700>! Begin declarations.<a name='2087'></font>
<a name='2088'>
   IMPLICIT NONE<a name='2089'>
<a name='2090'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2091'>
<a name='2092'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='2093'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='2094'>
                                            its, ite, jts, jte, kts, kte<a name='2095'>
<a name='2096'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='2097'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='2098'>
<a name='2099'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msfu, &amp;<a name='2100'>
                                                                      mu<a name='2101'>
<a name='2102'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::tendency<a name='2103'>
<a name='2104'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::   rdzw  <a name='2105'>
                                                                    <a name='2106'>
 <a name='2107'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::defor11, &amp;<a name='2108'>
                                                                 defor12, &amp;<a name='2109'>
                                                                     div, &amp;   <a name='2110'>
                                                                     tke, &amp;   <a name='2111'>
                                                                    xkmh, &amp;<a name='2112'>
                                                                      zx, &amp;<a name='2113'>
                                                                      zy<a name='2114'>
<a name='2115'>
   REAL ,                                        INTENT(IN   ) ::    rdx, &amp;<a name='2116'>
                                                                     rdy<a name='2117'>
<font color=#447700>! Local data<a name='2118'></font>
   <a name='2119'>
   INTEGER :: i, j, k, ktf<a name='2120'>
<a name='2121'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2122'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext  <a name='2123'>
<a name='2124'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)    :: titau1avg, &amp;<a name='2125'>
                                                              titau2avg, &amp;<a name='2126'>
                                                                 titau1, &amp; <a name='2127'>
                                                                 titau2, &amp; <a name='2128'>
                                                                 xkxavg, &amp; <a name='2129'>
                                                                  rravg<a name='2130'>
<font color=#447700>! new<a name='2131'></font>
<font color=#447700>!                                                                 zxavg, &amp; <a name='2132'></font>
<font color=#447700>!                                                                 zyavg<a name='2133'></font>
   REAL :: mrdx, mrdy, rcoup<a name='2134'>
<a name='2135'>
   REAL :: tmpzy, tmpzeta_z<a name='2136'>
<a name='2137'>
   REAL :: term1, term2, term3<a name='2138'>
<a name='2139'>
<font color=#447700>! End declarations.<a name='2140'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2141'></font>
<a name='2142'>
   ktf=MIN(kte,kde-1)<a name='2143'>
 <a name='2144'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2145'></font>
<font color=#447700>! u :   p (.), u(|), w(-)<a name='2146'></font>
<font color=#447700>!       <a name='2147'></font>
<font color=#447700>!       p  u  p  u                                  u     u<a name='2148'></font>
<font color=#447700>!<a name='2149'></font>
<font color=#447700>! p  |  .  |  .  |  .  |   k+1                |  .  |  .  |  .  |   k+1<a name='2150'></font>
<font color=#447700>!           <a name='2151'></font>
<font color=#447700>! w     - 13  -     -      k+1                     13               k+1 <a name='2152'></font>
<font color=#447700>!<a name='2153'></font>
<font color=#447700>! p  |  11 O 11  |  .  |   k                  |  12 O 12  |  .  |   k      <a name='2154'></font>
<font color=#447700>!<a name='2155'></font>
<font color=#447700>! w     - 13  -     -      k                       13               k  <a name='2156'></font>
<font color=#447700>!<a name='2157'></font>
<font color=#447700>! p  |  .  |  .  |  .  |   k-1                |  .  |  .  |  .  |   k-1<a name='2158'></font>
<font color=#447700>!<a name='2159'></font>
<font color=#447700>!      i-1 i  i i+1                          j-1 j  j j+1 j+1         <a name='2160'></font>
<font color=#447700>!<a name='2161'></font>
<a name='2162'>
   i_start = its<a name='2163'>
   i_end   = ite<a name='2164'>
   j_start = jts<a name='2165'>
   j_end   = MIN(jte,jde-1)<a name='2166'>
<a name='2167'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='2168'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='2169'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='2170'>
        config_flags%nested) i_end   = MIN(ide-1,ite)<a name='2171'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='2172'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='2173'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='2174'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='2175'>
<a name='2176'>
<font color=#447700>! titau1 = titau11 <a name='2177'></font>
   is_ext=1<a name='2178'>
   ie_ext=0<a name='2179'>
   js_ext=0<a name='2180'>
   je_ext=0<a name='2181'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_11_22_33'>cal_titau_11_22_33</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_U_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_11_22_33_1">( config_flags, titau1,            &amp;<a name='2182'>
                            mu, tke, xkmh, defor11,          &amp;<a name='2183'>
                            is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='2184'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='2185'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='2186'>
                            its, ite, jts, jte, kts, kte     )<a name='2187'>
<a name='2188'>
<font color=#447700>! titau2 = titau12<a name='2189'></font>
   is_ext=0<a name='2190'>
   ie_ext=0<a name='2191'>
   js_ext=0<a name='2192'>
   je_ext=1<a name='2193'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_12_21'>cal_titau_12_21</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_U_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_12_21_1">( config_flags, titau2,            &amp;<a name='2194'>
                         mu, xkmh, defor12,               &amp;<a name='2195'>
                         is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='2196'>
                         ids, ide, jds, jde, kds, kde,    &amp;<a name='2197'>
                         ims, ime, jms, jme, kms, kme,    &amp;<a name='2198'>
                         its, ite, jts, jte, kts, kte     )<a name='2199'>
<a name='2200'>
<font color=#447700>! titau1avg = titau11avg<a name='2201'></font>
<font color=#447700>! titau2avg = titau12avg <a name='2202'></font>
<a name='2203'>
   DO j = j_start, j_end<a name='2204'>
   DO k = kts+1,ktf<a name='2205'>
   DO i = i_start, i_end<a name='2206'>
      titau1avg(i,k,j)=0.5*(fnm(k)*(titau1(i-1,k  ,j)+titau1(i,k  ,j))+ &amp;<a name='2207'>
                            fnp(k)*(titau1(i-1,k-1,j)+titau1(i,k-1,j)))<a name='2208'>
      titau2avg(i,k,j)=0.5*(fnm(k)*(titau2(i,k  ,j+1)+titau2(i,k  ,j))+ &amp;<a name='2209'>
                            fnp(k)*(titau2(i,k-1,j+1)+titau2(i,k-1,j)))<a name='2210'>
      tmpzy = 0.25*( zy(i-1,k,j  )+zy(i,k,j  )+ &amp;<a name='2211'>
                     zy(i-1,k,j+1)+zy(i,k,j+1)  )<a name='2212'>
<font color=#447700>!      tmpzeta_z = 0.5*(zeta_z(i,j)+zeta_z(i-1,j))<a name='2213'></font>
<font color=#447700>!      titau1avg(i,k,j)=titau1avg(i,k,j)*zx(i,k,j)*tmpzeta_z<a name='2214'></font>
<font color=#447700>!      titau2avg(i,k,j)=titau2avg(i,k,j)*tmpzy    *tmpzeta_z<a name='2215'></font>
<a name='2216'>
      titau1avg(i,k,j)=titau1avg(i,k,j)*zx(i,k,j)<a name='2217'>
      titau2avg(i,k,j)=titau2avg(i,k,j)*tmpzy    <a name='2218'>
<a name='2219'>
   ENDDO<a name='2220'>
   ENDDO<a name='2221'>
   ENDDO<a name='2222'>
<font color=#447700>!<a name='2223'></font>
   DO j = j_start, j_end<a name='2224'>
   DO i = i_start, i_end<a name='2225'>
      titau1avg(i,kts,j)=0.<a name='2226'>
      titau1avg(i,ktf+1,j)=0.<a name='2227'>
      titau2avg(i,kts,j)=0.<a name='2228'>
      titau2avg(i,ktf+1,j)=0.<a name='2229'>
   ENDDO<a name='2230'>
   ENDDO<a name='2231'>
<font color=#447700>!<a name='2232'></font>
   DO j = j_start, j_end<a name='2233'>
   DO k = kts,ktf<a name='2234'>
   DO i = i_start, i_end<a name='2235'>
<a name='2236'>
      mrdx=msfu(i,j)*rdx<a name='2237'>
      mrdy=msfu(i,j)*rdy<a name='2238'>
      tendency(i,k,j)=tendency(i,k,j)-                                    &amp;<a name='2239'>
           (mrdx*(titau1(i,k,j  )-titau1(i-1,k,j))+                       &amp;<a name='2240'>
            mrdy*(titau2(i,k,j+1)-titau2(i,k,j  ))-                       &amp;<a name='2241'>
            msfu(i,j)*rdzw(i,k,j)*((titau1avg(i,k+1,j)-titau1avg(i,k,j))+ &amp;<a name='2242'>
                                   (titau2avg(i,k+1,j)-titau2avg(i,k,j))  &amp;<a name='2243'>
                                  )                                      )<a name='2244'>
   ENDDO<a name='2245'>
   ENDDO<a name='2246'>
   ENDDO<a name='2247'>
<a name='2248'>
END SUBROUTINE horizontal_diffusion_u_2<a name='2249'>
<a name='2250'>
<font color=#447700>!=======================================================================<a name='2251'></font>
<font color=#447700>!=======================================================================<a name='2252'></font>
<a name='2253'>
<A NAME='HORIZONTAL_DIFFUSION_V_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_V_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2254'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_v_2</font>( tendency, mu, config_flags,          &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_V_2.html' TARGET='index'>1</A>,<A href='../../call_from/HORIZONTAL_DIFFUSION_V_2.html' TARGET='index'>2</A><a name='2255'>
                                     defor12, defor22, div, tke,          &amp;<a name='2256'>
                                     msfv, xkmh, rdx, rdy, fnm, fnp,      &amp;<a name='2257'>
                                     zx, zy, rdzw,                        &amp;<a name='2258'>
                                     ids, ide, jds, jde, kds, kde,        &amp;<a name='2259'>
                                     ims, ime, jms, jme, kms, kme,        &amp;<a name='2260'>
                                     its, ite, jts, jte, kts, kte        )<a name='2261'>
<a name='2262'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2263'></font>
<font color=#447700>! Begin declarations.<a name='2264'></font>
<a name='2265'>
   IMPLICIT NONE<a name='2266'>
<a name='2267'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2268'>
<a name='2269'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='2270'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='2271'>
                                            its, ite, jts, jte, kts, kte<a name='2272'>
<a name='2273'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='2274'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='2275'>
<a name='2276'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msfv, &amp;<a name='2277'>
                                                                      mu<a name='2278'>
<a name='2279'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: tendency<a name='2280'>
<a name='2281'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::defor12, &amp;<a name='2282'>
                                                                 defor22, &amp;<a name='2283'>
                                                                     div, &amp;<a name='2284'>
                                                                     tke, &amp;<a name='2285'>
                                                                    xkmh, &amp;<a name='2286'>
                                                                      zx, &amp;<a name='2287'>
                                                                      zy, &amp;<a name='2288'>
                                                                    rdzw<a name='2289'>
<a name='2290'>
   REAL ,                                        INTENT(IN   ) ::    rdx, &amp;<a name='2291'>
                                                                     rdy<a name='2292'>
<a name='2293'>
<font color=#447700>! Local data<a name='2294'></font>
<a name='2295'>
   INTEGER :: i, j, k, ktf<a name='2296'>
<a name='2297'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2298'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext  <a name='2299'>
<a name='2300'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)    :: titau1avg, &amp;<a name='2301'>
                                                              titau2avg, &amp;<a name='2302'>
                                                                 titau1, &amp;<a name='2303'>
                                                                 titau2, &amp;<a name='2304'>
                                                                 xkxavg, &amp;<a name='2305'>
                                                                  rravg<a name='2306'>
<font color=#447700>! new<a name='2307'></font>
<font color=#447700>!                                                                 zxavg, &amp;<a name='2308'></font>
<font color=#447700>!                                                                 zyavg<a name='2309'></font>
<a name='2310'>
   REAL :: mrdx, mrdy, rcoup<a name='2311'>
<a name='2312'>
   REAL :: tmpzx, tmpzeta_z<a name='2313'>
<a name='2314'>
<font color=#447700>! End declarations.<a name='2315'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2316'></font>
<a name='2317'>
   ktf=MIN(kte,kde-1)<a name='2318'>
 <a name='2319'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2320'></font>
<font color=#447700>! v :   p (.), v(+), w(-)<a name='2321'></font>
<font color=#447700>!       <a name='2322'></font>
<font color=#447700>!       p  v  p  v                                  v     v<a name='2323'></font>
<font color=#447700>!<a name='2324'></font>
<font color=#447700>! p  +  .  +  .  +  .  +   k+1                +  .  +  .  +  .  +   k+1<a name='2325'></font>
<font color=#447700>!           <a name='2326'></font>
<font color=#447700>! w     - 23  -     -      k+1                     23               k+1 <a name='2327'></font>
<font color=#447700>!<a name='2328'></font>
<font color=#447700>! p  +  22 O 22  +  .  +   k                  +  21 O 21  +  .  +   k      <a name='2329'></font>
<font color=#447700>!<a name='2330'></font>
<font color=#447700>! w     - 23  -     -      k                       23               k  <a name='2331'></font>
<font color=#447700>!<a name='2332'></font>
<font color=#447700>! p  +  .  +  .  +  .  +   k-1                +  .  +  .  +  .  +   k-1<a name='2333'></font>
<font color=#447700>!<a name='2334'></font>
<font color=#447700>!      j-1 j  j j+1                          i-1 i  i i+1 i+1         <a name='2335'></font>
<font color=#447700>!<a name='2336'></font>
<a name='2337'>
   i_start = its<a name='2338'>
   i_end   = MIN(ite,ide-1)<a name='2339'>
   j_start = jts<a name='2340'>
   j_end   = jte<a name='2341'>
<a name='2342'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='2343'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='2344'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='2345'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='2346'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='2347'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='2348'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='2349'>
        config_flags%nested) j_end   = MIN(jde-1,jte)<a name='2350'>
<a name='2351'>
<font color=#447700>! titau1 = titau21<a name='2352'></font>
   is_ext=0<a name='2353'>
   ie_ext=1<a name='2354'>
   js_ext=0<a name='2355'>
   je_ext=0<a name='2356'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_12_21'>cal_titau_12_21</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_V_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_12_21_2">( config_flags, titau1,          &amp;<a name='2357'>
                         mu, xkmh, defor12,             &amp;<a name='2358'>
                         is_ext,ie_ext,js_ext,je_ext,   &amp;<a name='2359'>
                         ids, ide, jds, jde, kds, kde,  &amp;<a name='2360'>
                         ims, ime, jms, jme, kms, kme,  &amp;<a name='2361'>
                         its, ite, jts, jte, kts, kte   )<a name='2362'>
<a name='2363'>
<font color=#447700>! titau2 = titau22<a name='2364'></font>
   is_ext=0<a name='2365'>
   ie_ext=0<a name='2366'>
   js_ext=1<a name='2367'>
   je_ext=0<a name='2368'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_11_22_33'>cal_titau_11_22_33</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_V_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_11_22_33_2">( config_flags, titau2,           &amp;<a name='2369'>
                            mu, tke, xkmh, defor22,         &amp;<a name='2370'>
                            is_ext, ie_ext, js_ext, je_ext, &amp;<a name='2371'>
                            ids, ide, jds, jde, kds, kde,   &amp;<a name='2372'>
                            ims, ime, jms, jme, kms, kme,   &amp;<a name='2373'>
                            its, ite, jts, jte, kts, kte    )<a name='2374'>
<a name='2375'>
   DO j = j_start, j_end<a name='2376'>
   DO k = kts+1,ktf<a name='2377'>
   DO i = i_start, i_end<a name='2378'>
      titau1avg(i,k,j)=0.5*(fnm(k)*(titau1(i+1,k  ,j)+titau1(i,k  ,j))+ &amp;<a name='2379'>
                            fnp(k)*(titau1(i+1,k-1,j)+titau1(i,k-1,j)))<a name='2380'>
      titau2avg(i,k,j)=0.5*(fnm(k)*(titau2(i,k  ,j-1)+titau2(i,k  ,j))+ &amp;<a name='2381'>
                            fnp(k)*(titau2(i,k-1,j-1)+titau2(i,k-1,j)))<a name='2382'>
<a name='2383'>
      tmpzx = 0.25*( zx(i,k,j  )+zx(i+1,k,j  )+ &amp;<a name='2384'>
                     zx(i,k,j-1)+zx(i+1,k,j-1)  )<a name='2385'>
<a name='2386'>
<a name='2387'>
      titau1avg(i,k,j)=titau1avg(i,k,j)*tmpzx<a name='2388'>
      titau2avg(i,k,j)=titau2avg(i,k,j)*zy(i,k,j)<a name='2389'>
<a name='2390'>
<a name='2391'>
   ENDDO<a name='2392'>
   ENDDO<a name='2393'>
   ENDDO<a name='2394'>
<a name='2395'>
   DO j = j_start, j_end<a name='2396'>
   DO i = i_start, i_end<a name='2397'>
      titau1avg(i,kts,j)=0.<a name='2398'>
      titau1avg(i,ktf+1,j)=0.<a name='2399'>
      titau2avg(i,kts,j)=0.<a name='2400'>
      titau2avg(i,ktf+1,j)=0.<a name='2401'>
   ENDDO<a name='2402'>
   ENDDO<a name='2403'>
<font color=#447700>!<a name='2404'></font>
   DO j = j_start, j_end<a name='2405'>
   DO k = kts,ktf<a name='2406'>
   DO i = i_start, i_end<a name='2407'>
       <a name='2408'>
      mrdx=msfv(i,j)*rdx<a name='2409'>
      mrdy=msfv(i,j)*rdy<a name='2410'>
      tendency(i,k,j)=tendency(i,k,j)-                                    &amp;<a name='2411'>
           (mrdy*(titau2(i  ,k,j)-titau2(i,k,j-1))+                       &amp;<a name='2412'>
            mrdx*(titau1(i+1,k,j)-titau1(i,k,j  ))-                       &amp;<a name='2413'>
            msfv(i,j)*rdzw(i,k,j)*((titau1avg(i,k+1,j)-titau1avg(i,k,j))+ &amp;<a name='2414'>
                                   (titau2avg(i,k+1,j)-titau2avg(i,k,j))  &amp;<a name='2415'>
                                )			                  &amp;<a name='2416'>
           )<a name='2417'>
<a name='2418'>
   ENDDO<a name='2419'>
   ENDDO<a name='2420'>
   ENDDO<a name='2421'>
<a name='2422'>
END SUBROUTINE horizontal_diffusion_v_2<a name='2423'>
<a name='2424'>
<font color=#447700>!=======================================================================<a name='2425'></font>
<font color=#447700>!=======================================================================<a name='2426'></font>
<a name='2427'>
<A NAME='HORIZONTAL_DIFFUSION_W_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_W_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2428'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_w_2</font>( tendency, mu, config_flags,          &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_W_2.html' TARGET='index'>1</A>,<A href='../../call_from/HORIZONTAL_DIFFUSION_W_2.html' TARGET='index'>2</A><a name='2429'>
                                     defor13, defor23, div, tke,          &amp;<a name='2430'>
                                     msft, xkmh, rdx, rdy, fnm, fnp,      &amp;<a name='2431'>
                                     zx, zy, rdz,                         &amp;<a name='2432'>
                                     ids, ide, jds, jde, kds, kde,        &amp;<a name='2433'>
                                     ims, ime, jms, jme, kms, kme,        &amp;<a name='2434'>
                                     its, ite, jts, jte, kts, kte        )<a name='2435'>
<a name='2436'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2437'></font>
<font color=#447700>! Begin declarations.<a name='2438'></font>
<a name='2439'>
   IMPLICIT NONE<a name='2440'>
<a name='2441'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2442'>
<a name='2443'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='2444'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='2445'>
                                            its, ite, jts, jte, kts, kte<a name='2446'>
<a name='2447'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='2448'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='2449'>
<a name='2450'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msft, &amp;<a name='2451'>
                                                                      mu<a name='2452'>
<a name='2453'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: tendency<a name='2454'>
<a name='2455'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::defor13, &amp;<a name='2456'>
                                                                 defor23, &amp;<a name='2457'>
                                                                     div, &amp;<a name='2458'>
                                                                     tke, &amp;<a name='2459'>
                                                                    xkmh, &amp;<a name='2460'>
                                                                      zx, &amp;<a name='2461'>
                                                                      zy, &amp;<a name='2462'>
                                                                     rdz<a name='2463'>
<a name='2464'>
   REAL ,                                        INTENT(IN   ) ::    rdx, &amp;<a name='2465'>
                                                                     rdy<a name='2466'>
<a name='2467'>
<font color=#447700>! Local data<a name='2468'></font>
<a name='2469'>
   INTEGER :: i, j, k, ktf<a name='2470'>
<a name='2471'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2472'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext  <a name='2473'>
<a name='2474'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)    :: titau1avg, &amp;<a name='2475'>
                                                              titau2avg, &amp;<a name='2476'>
                                                                 titau1, &amp;<a name='2477'>
                                                                 titau2, &amp;<a name='2478'>
                                                                 xkxavg, &amp;<a name='2479'>
                                                                  rravg<a name='2480'>
<font color=#447700>! new<a name='2481'></font>
<font color=#447700>!                                                                 zxavg, &amp;<a name='2482'></font>
<font color=#447700>!                                                                 zyavg<a name='2483'></font>
<a name='2484'>
   REAL :: mrdx, mrdy, rcoup<a name='2485'>
<a name='2486'>
   REAL :: tmpzx, tmpzy, tmpzeta_z<a name='2487'>
<a name='2488'>
<font color=#447700>! End declarations.<a name='2489'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2490'></font>
<a name='2491'>
   ktf=MIN(kte,kde-1)<a name='2492'>
 <a name='2493'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2494'></font>
<font color=#447700>! w :   p (.), u(|), v(+), w(-)<a name='2495'></font>
<font color=#447700>!       <a name='2496'></font>
<font color=#447700>!       p  u  p  u                               p  v  p  v <a name='2497'></font>
<font color=#447700>!<a name='2498'></font>
<font color=#447700>! w     -     -     -      k+1             w     -     -     -      k+1 <a name='2499'></font>
<font color=#447700>!<a name='2500'></font>
<font color=#447700>! p     .  | 33  |  .      k               p     .  + 33  +  .      k      <a name='2501'></font>
<font color=#447700>!<a name='2502'></font>
<font color=#447700>! w     -  31 O 31  -      k               w     -  32 O 32  -      k   <a name='2503'></font>
<font color=#447700>!<a name='2504'></font>
<font color=#447700>! p     .  | 33  |  .      k-1             p     .  | 33  |  .      k-1 <a name='2505'></font>
<font color=#447700>!<a name='2506'></font>
<font color=#447700>! w     -     -     -      k-1             w     -     -     -      k-1 <a name='2507'></font>
<font color=#447700>!<a name='2508'></font>
<font color=#447700>!      i-1 i  i i+1                             j-1 j  j j+1         <a name='2509'></font>
<font color=#447700>!<a name='2510'></font>
   i_start = its<a name='2511'>
   i_end   = MIN(ite,ide-1)<a name='2512'>
   j_start = jts<a name='2513'>
   j_end   = MIN(jte,jde-1)<a name='2514'>
<a name='2515'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='2516'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='2517'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='2518'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='2519'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='2520'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='2521'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='2522'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='2523'>
<a name='2524'>
<font color=#447700>! titau1 = titau31<a name='2525'></font>
   is_ext=0<a name='2526'>
   ie_ext=1<a name='2527'>
   js_ext=0<a name='2528'>
   je_ext=0<a name='2529'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_13_31'>cal_titau_13_31</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_W_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_13_31_1">( config_flags, titau1, defor13,   &amp;<a name='2530'>
                         mu, xkmh, fnm, fnp,              &amp;<a name='2531'>
                         is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='2532'>
                         ids, ide, jds, jde, kds, kde,    &amp;<a name='2533'>
                         ims, ime, jms, jme, kms, kme,    &amp;<a name='2534'>
                         its, ite, jts, jte, kts, kte     )<a name='2535'>
<a name='2536'>
<font color=#447700>! titau2 = titau32<a name='2537'></font>
   is_ext=0<a name='2538'>
   ie_ext=0<a name='2539'>
   js_ext=0<a name='2540'>
   je_ext=1<a name='2541'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_23_32'>cal_titau_23_32</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_W_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_23_32_1">( config_flags, titau2, defor23,   &amp;<a name='2542'>
                         mu, xkmh, fnm, fnp,              &amp;<a name='2543'>
                         is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='2544'>
                         ids, ide, jds, jde, kds, kde,    &amp;<a name='2545'>
                         ims, ime, jms, jme, kms, kme,    &amp;<a name='2546'>
                         its, ite, jts, jte, kts, kte     )<a name='2547'>
<a name='2548'>
<font color=#447700>! titau1avg = titau31avg * zx * zeta_z = titau13avg * zx * zeta_z<a name='2549'></font>
<font color=#447700>! titau2avg = titau32avg * zy * zeta_z = titau23avg * zy * zeta_z<a name='2550'></font>
<a name='2551'>
   DO j = j_start, j_end<a name='2552'>
   DO k = kts,ktf<a name='2553'>
   DO i = i_start, i_end<a name='2554'>
      titau1avg(i,k,j)=0.25*(titau1(i+1,k+1,j)+titau1(i,k+1,j)+ &amp;<a name='2555'>
                             titau1(i+1,k  ,j)+titau1(i,k  ,j))<a name='2556'>
      titau2avg(i,k,j)=0.25*(titau2(i,k+1,j+1)+titau2(i,k+1,j)+ &amp;<a name='2557'>
                             titau2(i,k  ,j+1)+titau2(i,k  ,j))<a name='2558'>
<font color=#447700>! new<a name='2559'></font>
      tmpzx  =0.25*( zx(i,k  ,j)+zx(i+1,k  ,j)+ &amp;<a name='2560'>
                     zx(i,k+1,j)+zx(i+1,k+1,j)  )<a name='2561'>
      tmpzy  =0.25*( zy(i,k  ,j)+zy(i,k  ,j+1)+ &amp;<a name='2562'>
                     zy(i,k+1,j)+zy(i,k+1,j+1)  )<a name='2563'>
<a name='2564'>
      titau1avg(i,k,j)=titau1avg(i,k,j)*tmpzx<a name='2565'>
      titau2avg(i,k,j)=titau2avg(i,k,j)*tmpzy<a name='2566'>
<font color=#447700>!      titau1avg(i,k,j)=titau1avg(i,k,j)*tmpzx*zeta_z(i,j)<a name='2567'></font>
<font color=#447700>!      titau2avg(i,k,j)=titau2avg(i,k,j)*tmpzy*zeta_z(i,j)<a name='2568'></font>
   ENDDO<a name='2569'>
   ENDDO<a name='2570'>
   ENDDO<a name='2571'>
<a name='2572'>
   DO j = j_start, j_end<a name='2573'>
   DO i = i_start, i_end<a name='2574'>
      titau1avg(i,kts  ,j)=0.<a name='2575'>
      titau2avg(i,kts  ,j)=0.<a name='2576'>
      titau1avg(i,ktf+1,j)=0.<a name='2577'>
      titau2avg(i,ktf+1,j)=0.<a name='2578'>
   ENDDO<a name='2579'>
   ENDDO<a name='2580'>
<a name='2581'>
   DO j = j_start, j_end<a name='2582'>
   DO k = kts+1,ktf<a name='2583'>
   DO i = i_start, i_end<a name='2584'>
<a name='2585'>
      mrdx=msft(i,j)*rdx<a name='2586'>
      mrdy=msft(i,j)*rdy<a name='2587'>
<a name='2588'>
      tendency(i,k,j)=tendency(i,k,j)-                                 &amp;<a name='2589'>
           (mrdx*(titau1(i+1,k,j)-titau1(i,k,j))+                      &amp;<a name='2590'>
            mrdy*(titau2(i,k,j+1)-titau2(i,k,j))-                      &amp;<a name='2591'>
            msft(i,j)*rdz(i,k,j)*(titau1avg(i,k,j)-titau1avg(i,k-1,j)+ &amp;<a name='2592'>
                                  titau2avg(i,k,j)-titau2avg(i,k-1,j)  &amp;<a name='2593'>
                               )				       &amp;<a name='2594'>
           )<a name='2595'>
<font color=#447700>!            msft(i,j)/dn(k)*(titau1avg(i,k,j)-titau1avg(i,k-1,j)+ &amp;<a name='2596'></font>
<font color=#447700>!                                titau2avg(i,k,j)-titau2avg(i,k-1,j)  &amp;<a name='2597'></font>
<font color=#447700>!                               )				     &amp;<a name='2598'></font>
<font color=#447700>!           )<a name='2599'></font>
   ENDDO<a name='2600'>
   ENDDO<a name='2601'>
   ENDDO<a name='2602'>
<a name='2603'>
END SUBROUTINE horizontal_diffusion_w_2<a name='2604'>
<a name='2605'>
<font color=#447700>!=======================================================================<a name='2606'></font>
<font color=#447700>!=======================================================================<a name='2607'></font>
<a name='2608'>
<A NAME='HORIZONTAL_DIFFUSION_S'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2609'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_s</font> (tendency, mu, config_flags, var,       &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_S.html' TARGET='index'>4</A><a name='2610'>
                                   msft, msfu, msfv, xkhh, rdx, rdy,      &amp;<a name='2611'>
                                   fnm, fnp, cf1, cf2, cf3,               &amp;<a name='2612'>
                                   zx, zy, rdz, rdzw, dn, dnw,            &amp;<a name='2613'>
                                   doing_tke,                             &amp;<a name='2614'>
                                   ids, ide, jds, jde, kds, kde,          &amp;<a name='2615'>
                                   ims, ime, jms, jme, kms, kme,          &amp;<a name='2616'>
                                   its, ite, jts, jte, kts, kte           )<a name='2617'>
<a name='2618'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2619'></font>
<font color=#447700>! Begin declarations.<a name='2620'></font>
<a name='2621'>
   IMPLICIT NONE<a name='2622'>
<a name='2623'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2624'>
<a name='2625'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='2626'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='2627'>
                                            its, ite, jts, jte, kts, kte<a name='2628'>
<a name='2629'>
   LOGICAL,         INTENT(IN   ) ::        doing_tke<a name='2630'>
<a name='2631'>
   REAL , INTENT(IN   )           ::        cf1, cf2, cf3<a name='2632'>
<a name='2633'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='2634'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='2635'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::     dn<a name='2636'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    dnw<a name='2637'>
<a name='2638'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msfu<a name='2639'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msfv<a name='2640'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msft<a name='2641'>
<a name='2642'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   mu<a name='2643'>
<a name='2644'>
<font color=#447700>!  REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1),                 &amp;<a name='2645'></font>
<font color=#447700>!         INTENT(IN   ) ::                                         xkhh<a name='2646'></font>
<a name='2647'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: tendency<a name='2648'>
<a name='2649'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::         &amp;<a name='2650'>
                                                                    xkhh, &amp;<a name='2651'>
                                                                     rdz, &amp;<a name='2652'>
                                                                     rdzw<a name='2653'>
<a name='2654'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::    var, &amp;<a name='2655'>
                                                                      zx, &amp;<a name='2656'>
                                                                      zy<a name='2657'>
<a name='2658'>
   REAL ,                                        INTENT(IN   ) ::    rdx, &amp;<a name='2659'>
                                                                     rdy<a name='2660'>
<a name='2661'>
<font color=#447700>! Local data<a name='2662'></font>
<a name='2663'>
   INTEGER :: i, j, k, ktf<a name='2664'>
<a name='2665'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2666'>
<a name='2667'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)    ::     H1avg, &amp;<a name='2668'>
                                                                  H2avg, &amp;<a name='2669'>
                                                                     H1, &amp;<a name='2670'>
                                                                     H2, &amp;<a name='2671'>
                                                                 xkxavg<a name='2672'>
<font color=#447700>! new<a name='2673'></font>
<font color=#447700>!                                                                 zxavg, &amp;<a name='2674'></font>
<font color=#447700>!                                                                 zyavg<a name='2675'></font>
<a name='2676'>
   REAL , DIMENSION( its:ite, kts:kte, jts:jte)            ::  tmptendf<a name='2677'>
<a name='2678'>
   REAL    :: mrdx, mrdy, rcoup<a name='2679'>
   REAL    :: tmpzx, tmpzy, tmpzeta_z<a name='2680'>
   INTEGER :: ktes1,ktes2<a name='2681'>
<a name='2682'>
<font color=#447700>! End declarations.<a name='2683'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2684'></font>
<a name='2685'>
   ktf=MIN(kte,kde-1)<a name='2686'>
 <a name='2687'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2688'></font>
<font color=#447700>! scalars:   t (.), u(|), v(+), w(-)<a name='2689'></font>
<font color=#447700>!       <a name='2690'></font>
<font color=#447700>!       t  u  t  u                               t  v  t  v <a name='2691'></font>
<font color=#447700>!<a name='2692'></font>
<font color=#447700>! w     -     3     -      k+1             w     -     3     -      k+1 <a name='2693'></font>
<font color=#447700>!<a name='2694'></font>
<font color=#447700>! t     .  1  O  1  .      k               t     .  2  O  2  .      k      <a name='2695'></font>
<font color=#447700>!<a name='2696'></font>
<font color=#447700>! w     -     3     -      k               w     -     3     -      k   <a name='2697'></font>
<font color=#447700>!<a name='2698'></font>
<font color=#447700>! t     .  |  .  |  .      k-1             t     .  +  .  +  .      k-1 <a name='2699'></font>
<font color=#447700>!<a name='2700'></font>
<font color=#447700>! w     -     -     -      k-1             w     -     -     -      k-1 <a name='2701'></font>
<font color=#447700>!<a name='2702'></font>
<font color=#447700>! t    i-1 i  i i+1                             j-1 j  j j+1         <a name='2703'></font>
<font color=#447700>!<a name='2704'></font>
<a name='2705'>
   ktes1=kte-1<a name='2706'>
   ktes2=kte-2<a name='2707'>
<a name='2708'>
   i_start = its<a name='2709'>
   i_end   = MIN(ite,ide-1)<a name='2710'>
   j_start = jts<a name='2711'>
   j_end   = MIN(jte,jde-1)<a name='2712'>
<a name='2713'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='2714'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='2715'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='2716'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='2717'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='2718'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='2719'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='2720'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='2721'>
<a name='2722'>
<font color=#447700>! diffusion of the TKE needs mutiple 2<a name='2723'></font>
<a name='2724'>
   IF ( doing_tke ) THEN<a name='2725'>
      DO j = j_start, j_end<a name='2726'>
      DO k = kts,ktf<a name='2727'>
      DO i = i_start, i_end<a name='2728'>
         tmptendf(i,k,j)=tendency(i,k,j)<a name='2729'>
      ENDDO<a name='2730'>
      ENDDO<a name='2731'>
      ENDDO<a name='2732'>
   ENDIF<a name='2733'>
<a name='2734'>
<font color=#447700>! H1 = partial var over partial x<a name='2735'></font>
<a name='2736'>
   DO j = j_start, j_end<a name='2737'>
   DO k = kts, ktf<a name='2738'>
   DO i = i_start, i_end + 1<a name='2739'>
<font color=#447700>! new<a name='2740'></font>
<font color=#447700>!     zxavg(i,k,j) =0.5*( zx(i-1,k,j)+ zx(i,k,j))<a name='2741'></font>
      xkxavg(i,k,j)=0.5*(xkhh(i-1,k,j)+xkhh(i,k,j))<a name='2742'>
   ENDDO<a name='2743'>
   ENDDO<a name='2744'>
   ENDDO<a name='2745'>
<a name='2746'>
   DO j = j_start, j_end<a name='2747'>
   DO k = kts+1, ktf<a name='2748'>
   DO i = i_start, i_end + 1<a name='2749'>
      H1avg(i,k,j)=0.5*(fnm(k)*(var(i-1,k  ,j)+var(i,k  ,j))+  &amp;<a name='2750'>
                        fnp(k)*(var(i-1,k-1,j)+var(i,k-1,j)))<a name='2751'>
   ENDDO<a name='2752'>
   ENDDO<a name='2753'>
   ENDDO<a name='2754'>
<a name='2755'>
   DO j = j_start, j_end<a name='2756'>
   DO i = i_start, i_end + 1<a name='2757'>
      H1avg(i,kts  ,j)=0.5*(cf1*var(i  ,1,j)+cf2*var(i  ,2,j)+ &amp;<a name='2758'>
                            cf3*var(i  ,3,j)+cf1*var(i-1,1,j)+  &amp;<a name='2759'>
                            cf2*var(i-1,2,j)+cf3*var(i-1,3,j))<a name='2760'>
      H1avg(i,ktf+1,j)=0.5*(var(i,ktes1,j)+(var(i,ktes1,j)- &amp;<a name='2761'>
                            var(i,ktes2,j))*0.5*dnw(ktes1)/dn(ktes1)+ &amp;<a name='2762'>
                            var(i-1,ktes1,j)+(var(i-1,ktes1,j)- &amp;<a name='2763'>
                            var(i-1,ktes2,j))*0.5*dnw(ktes1)/dn(ktes1))<a name='2764'>
   ENDDO<a name='2765'>
   ENDDO<a name='2766'>
<a name='2767'>
   DO j = j_start, j_end<a name='2768'>
   DO k = kts, ktf<a name='2769'>
   DO i = i_start, i_end + 1<a name='2770'>
<font color=#447700>! new<a name='2771'></font>
      tmpzx = 0.5*( zx(i,k,j)+ zx(i,k+1,j))<a name='2772'>
      H1(i,k,j)=-msfu(i,j)*xkxavg(i,k,j)*(                      &amp;<a name='2773'>
                 rdx*(var(i,k,j)-var(i-1,k,j)) - tmpzx*         &amp;<a name='2774'>
                     (H1avg(i,k+1,j)-H1avg(i,k,j))*rdzw(i,k,j) )<a name='2775'>
<a name='2776'>
<font color=#447700>!      tmpzeta_z = 0.5*(zeta_z(i,j)+zeta_z(i-1,j))<a name='2777'></font>
<font color=#447700>!      H1(i,k,j)=-msfu(i,j)*xkxavg(i,k,j)*(                         &amp;<a name='2778'></font>
<font color=#447700>!                 rdx*(var(i,k,j)-var(i-1,k,j)) - tmpzx*tmpzeta_z*  &amp;<a name='2779'></font>
<font color=#447700>!                     (H1avg(i,k+1,j)-H1avg(i,k,j))/dnw(k))<a name='2780'></font>
   ENDDO<a name='2781'>
   ENDDO<a name='2782'>
   ENDDO<a name='2783'>
<a name='2784'>
<font color=#447700>! H2 = partial var over partial y<a name='2785'></font>
<a name='2786'>
   DO j = j_start, j_end + 1<a name='2787'>
   DO k = kts, ktf<a name='2788'>
   DO i = i_start, i_end<a name='2789'>
<font color=#447700>! new<a name='2790'></font>
<font color=#447700>!     zyavg(i,k,j) =0.5*( zy(i,k,j-1)+ zy(i,k,j))<a name='2791'></font>
      xkxavg(i,k,j)=0.5*(xkhh(i,k,j-1)+xkhh(i,k,j))<a name='2792'>
   ENDDO<a name='2793'>
   ENDDO<a name='2794'>
   ENDDO<a name='2795'>
<a name='2796'>
   DO j = j_start, j_end + 1<a name='2797'>
   DO k = kts+1,   ktf<a name='2798'>
   DO i = i_start, i_end<a name='2799'>
<font color=#447700>! new<a name='2800'></font>
      H2avg(i,k,j)=0.5*(fnm(k)*(var(i,k  ,j-1)+var(i,k  ,j))+  &amp;<a name='2801'>
                        fnp(k)*(var(i,k-1,j-1)+var(i,k-1,j)))<a name='2802'>
   ENDDO<a name='2803'>
   ENDDO<a name='2804'>
   ENDDO<a name='2805'>
<a name='2806'>
   DO j = j_start, j_end + 1<a name='2807'>
   DO i = i_start, i_end<a name='2808'>
      H2avg(i,kts  ,j)=0.5*(cf1*var(i,1,j  )+cf2*var(i  ,2,j)+ &amp;<a name='2809'>
                            cf3*var(i,3,j  )+cf1*var(i,1,j-1)+  &amp;<a name='2810'>
                            cf2*var(i,2,j-1)+cf3*var(i,3,j-1))<a name='2811'>
      H2avg(i,ktf+1,j)=0.5*(var(i,ktes1,j)+(var(i,ktes1,j)- &amp;<a name='2812'>
                            var(i,ktes2,j))*0.5*dnw(ktes1)/dn(ktes1)+ &amp;<a name='2813'>
                            var(i,ktes1,j-1)+(var(i,ktes1,j-1)- &amp;<a name='2814'>
                            var(i,ktes2,j-1))*0.5*dnw(ktes1)/dn(ktes1))<a name='2815'>
   ENDDO<a name='2816'>
   ENDDO<a name='2817'>
<a name='2818'>
   DO j = j_start, j_end + 1<a name='2819'>
   DO k = kts, ktf<a name='2820'>
   DO i = i_start, i_end<a name='2821'>
<font color=#447700>! new<a name='2822'></font>
      tmpzy = 0.5*( zy(i,k,j)+ zy(i,k+1,j))<a name='2823'>
<a name='2824'>
      H2(i,k,j)=-msfv(i,j)*xkxavg(i,k,j)*(                       &amp;<a name='2825'>
                 rdy*(var(i,k,j)-var(i,k,j-1)) - tmpzy*          &amp;<a name='2826'>
                     (H2avg(i ,k+1,j)-H2avg(i,k,j))*rdzw(i,k,j))<a name='2827'>
<a name='2828'>
<font color=#447700>!      tmpzeta_z = 0.5*(zeta_z(i,j)+zeta_z(i,j-1))<a name='2829'></font>
<font color=#447700>!      H2(i,k,j)=-msfv(i,j)*xkxavg(i,k,j)*(                         &amp;<a name='2830'></font>
<font color=#447700>!                 rdy*(var(i,k,j)-var(i,k,j-1)) - tmpzy*tmpzeta_z*  &amp;<a name='2831'></font>
<font color=#447700>!                     (H2avg(i ,k+1,j)-H2avg(i,k,j))/dnw(k))<a name='2832'></font>
   ENDDO<a name='2833'>
   ENDDO<a name='2834'>
   ENDDO<a name='2835'>
<a name='2836'>
   DO j = j_start, j_end<a name='2837'>
   DO k = kts+1, ktf<a name='2838'>
   DO i = i_start, i_end<a name='2839'>
      H1avg(i,k,j)=0.5*(fnm(k)*(H1(i+1,k  ,j)+H1(i,k  ,j))+  &amp;<a name='2840'>
                        fnp(k)*(H1(i+1,k-1,j)+H1(i,k-1,j)))<a name='2841'>
      H2avg(i,k,j)=0.5*(fnm(k)*(H2(i,k  ,j+1)+H2(i,k  ,j))+  &amp;<a name='2842'>
                        fnp(k)*(H2(i,k-1,j+1)+H2(i,k-1,j)))<a name='2843'>
<font color=#447700>! new<a name='2844'></font>
<font color=#447700>!     zxavg(i,k,j)=fnm(k)*zx(i,k,j)+fnp(k)*zx(i,k-1,j)<a name='2845'></font>
<font color=#447700>!     zyavg(i,k,j)=fnm(k)*zy(i,k,j)+fnp(k)*zy(i,k-1,j)<a name='2846'></font>
<a name='2847'>
<font color=#447700>! H1avg(i,k,j)=zx*H1avg*zeta_z<a name='2848'></font>
<font color=#447700>! H2avg(i,k,j)=zy*H2avg*zeta_z<a name='2849'></font>
<a name='2850'>
      tmpzx = 0.5*( zx(i,k,j)+ zx(i+1,k,j  ))<a name='2851'>
      tmpzy = 0.5*( zy(i,k,j)+ zy(i  ,k,j+1))<a name='2852'>
<a name='2853'>
      H1avg(i,k,j)=H1avg(i,k,j)*tmpzx<a name='2854'>
      H2avg(i,k,j)=H2avg(i,k,j)*tmpzy<a name='2855'>
<a name='2856'>
<font color=#447700>!      H1avg(i,k,j)=H1avg(i,k,j)*tmpzx*zeta_z(i,j)<a name='2857'></font>
<font color=#447700>!      H2avg(i,k,j)=H2avg(i,k,j)*tmpzy*zeta_z(i,j)<a name='2858'></font>
   ENDDO<a name='2859'>
   ENDDO<a name='2860'>
   ENDDO<a name='2861'>
 <a name='2862'>
   DO j = j_start, j_end<a name='2863'>
   DO i = i_start, i_end<a name='2864'>
      H1avg(i,kts  ,j)=0.<a name='2865'>
      H1avg(i,ktf+1,j)=0.<a name='2866'>
      H2avg(i,kts  ,j)=0.<a name='2867'>
      H2avg(i,ktf+1,j)=0.<a name='2868'>
   ENDDO<a name='2869'>
   ENDDO<a name='2870'>
<a name='2871'>
   DO j = j_start, j_end<a name='2872'>
   DO k = kts,ktf<a name='2873'>
   DO i = i_start, i_end<a name='2874'>
<a name='2875'>
      mrdx=msft(i,j)*rdx<a name='2876'>
      mrdy=msft(i,j)*rdy<a name='2877'>
<a name='2878'>
      tendency(i,k,j)=tendency(i,k,j)-                      &amp;<a name='2879'>
           (mrdx*0.5*((mu(i+1,j)+mu(i,j))*H1(i+1,k,j)-      &amp;<a name='2880'>
                      (mu(i-1,j)+mu(i,j))*H1(i  ,k,j))+     &amp;<a name='2881'>
            mrdy*0.5*((mu(i,j+1)+mu(i,j))*H2(i,k,j+1)-      &amp;<a name='2882'>
                      (mu(i,j-1)+mu(i,j))*H2(i,k,j  ))-     &amp;<a name='2883'>
            msft(i,j)*mu(i,j)*(H1avg(i,k+1,j)-H1avg(i,k,j)+ &amp;<a name='2884'>
                       H2avg(i,k+1,j)-H2avg(i,k,j)          &amp;<a name='2885'>
                                )*rdzw(i,k,j)               &amp;<a name='2886'>
                                                          )<a name='2887'>
<a name='2888'>
   ENDDO<a name='2889'>
   ENDDO<a name='2890'>
   ENDDO<a name='2891'>
           <a name='2892'>
   IF ( doing_tke ) THEN<a name='2893'>
      DO j = j_start, j_end<a name='2894'>
      DO k = kts,ktf<a name='2895'>
      DO i = i_start, i_end<a name='2896'>
          tendency(i,k,j)=tmptendf(i,k,j)+2.* &amp;<a name='2897'>
                          (tendency(i,k,j)-tmptendf(i,k,j))<a name='2898'>
      ENDDO<a name='2899'>
      ENDDO<a name='2900'>
      ENDDO<a name='2901'>
   ENDIF<a name='2902'>
<a name='2903'>
END SUBROUTINE horizontal_diffusion_s<a name='2904'>
<a name='2905'>
<font color=#447700>!=======================================================================<a name='2906'></font>
<font color=#447700>!=======================================================================<a name='2907'></font>
<a name='2908'>
<A NAME='VERTICAL_DIFFUSION_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2909'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_2</font>   ( ru_tendf, rv_tendf, rw_tendf, rt_tendf,   &amp; <A href='../../call_to/VERTICAL_DIFFUSION_2.html' TARGET='index'>3</A>,<A href='../../call_from/VERTICAL_DIFFUSION_2.html' TARGET='index'>7</A><a name='2910'>
                                    tke_tendf, moist_tendf, n_moist,          &amp;<a name='2911'>
                                    scalar_tendf, n_scalar,                   &amp;<a name='2912'>
                                    u_2, v_2,                                 &amp;<a name='2913'>
                                    thp,u_base,v_base,t_base,qv_base,mu,tke,  &amp;<a name='2914'>
                                    config_flags,defor13,defor23,defor33,div, &amp;<a name='2915'>
                                    moist, scalar, xkmv, xkhv,km_opt,         &amp;<a name='2916'>
                                    fnm, fnp, dn, dnw, rdz, rdzw,             &amp;<a name='2917'>
                                    ids, ide, jds, jde, kds, kde,             &amp;<a name='2918'>
                                    ims, ime, jms, jme, kms, kme,             &amp;<a name='2919'>
                                    its, ite, jts, jte, kts, kte             )<a name='2920'>
<a name='2921'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2922'></font>
<font color=#447700>! Begin declarations.<a name='2923'></font>
<a name='2924'>
   IMPLICIT NONE<a name='2925'>
<a name='2926'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2927'>
<a name='2928'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='2929'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='2930'>
                                            its, ite, jts, jte, kts, kte<a name='2931'>
<a name='2932'>
   INTEGER ,        INTENT(IN   ) ::        n_moist, n_scalar, km_opt<a name='2933'>
<a name='2934'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fnm<a name='2935'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fnp<a name='2936'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: dnw<a name='2937'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::  dn<a name='2938'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,  INTENT(IN   )      ::  mu<a name='2939'>
<a name='2940'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: qv_base<a name='2941'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::  u_base<a name='2942'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::  v_base<a name='2943'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::  t_base<a name='2944'>
<a name='2945'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::ru_tendf,&amp;<a name='2946'>
                                                                 rv_tendf,&amp;<a name='2947'>
                                                                 rw_tendf,&amp;<a name='2948'>
                                                                tke_tendf,&amp;<a name='2949'>
                                                                rt_tendf  <a name='2950'>
<a name='2951'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist),                 &amp;<a name='2952'>
          INTENT(INOUT) ::                                    moist_tendf<a name='2953'>
<a name='2954'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_scalar) ,               &amp;<a name='2955'>
          INTENT(INOUT) ::                                   scalar_tendf<a name='2956'>
<a name='2957'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist),                 &amp;<a name='2958'>
          INTENT(INOUT) ::                                          moist<a name='2959'>
<a name='2960'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_scalar) ,               &amp;<a name='2961'>
          INTENT(IN   ) ::                                         scalar<a name='2962'>
<a name='2963'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::defor13, &amp;<a name='2964'>
                                                                 defor23, &amp;<a name='2965'>
                                                                 defor33, &amp;<a name='2966'>
                                                                     div, &amp;<a name='2967'>
                                                                    xkmv, &amp;<a name='2968'>
                                                                    xkhv, &amp;<a name='2969'>
                                                                     tke, &amp;<a name='2970'>
                                                                     rdz, &amp;<a name='2971'>
                                                                     u_2, &amp;<a name='2972'>
                                                                     v_2, &amp;<a name='2973'>
                                                                    rdzw<a name='2974'>
<a name='2975'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::    thp<a name='2976'>
<a name='2977'>
<font color=#447700>! LOCAL VAR<a name='2978'></font>
<a name='2979'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme)  ::    var_mix<a name='2980'>
<a name='2981'>
   INTEGER :: im, i,j,k<a name='2982'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2983'>
<a name='2984'>
<font color=#447700>!  REAL , DIMENSION( its:ite, kts:kte, jts:jte) :: xkhv<a name='2985'></font>
<a name='2986'>
<font color=#447700>!***************************************************************************<a name='2987'></font>
<font color=#447700>!***************************************************************************<a name='2988'></font>
<font color=#447700>!MODIFICA VARIABILI PER I FLUSSI<a name='2989'></font>
<font color=#447700>!<a name='2990'></font>
    REAL , DIMENSION( ims:ime, jms:jme) :: Cd<a name='2991'>
    REAL :: V0_u,V0_v,tao_xz,tao_yz,ustar,cd0<a name='2992'>
    REAL :: xsfc,psi1,vk2,zrough,lnz<a name='2993'>
    REAL :: heat_flux<a name='2994'>
<font color=#447700>!<a name='2995'></font>
<font color=#447700>!FINE MODIFICA VARIABILI PER I FLUSSI<a name='2996'></font>
<font color=#447700>!***************************************************************************<a name='2997'></font>
<font color=#447700>!<a name='2998'></font>
<a name='2999'>
<font color=#447700>! End declarations.<a name='3000'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3001'></font>
<a name='3002'>
   i_start = its<a name='3003'>
   i_end   = MIN(ite,ide-1)<a name='3004'>
   j_start = jts<a name='3005'>
   j_end   = MIN(jte,jde-1)<a name='3006'>
<font color=#447700>!<a name='3007'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3008'></font>
<a name='3009'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_U_2'>vertical_diffusion_u_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_U_2_1">( ru_tendf, config_flags, mu,    &amp;<a name='3010'>
                                   defor13, xkmv,                 &amp;<a name='3011'>
                                   dnw, rdzw, fnm, fnp,           &amp;<a name='3012'>
                                   ids, ide, jds, jde, kds, kde,  &amp;<a name='3013'>
                                   ims, ime, jms, jme, kms, kme,  &amp;<a name='3014'>
                                   its, ite, jts, jte, kts, kte  )<a name='3015'>
<a name='3016'>
<a name='3017'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_V_2'>vertical_diffusion_v_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_V_2_1">( rv_tendf, config_flags, mu,    &amp;<a name='3018'>
                                   defor23, xkmv,                 &amp;<a name='3019'>
                                   dnw, rdzw, fnm, fnp,           &amp;<a name='3020'>
                                   ids, ide, jds, jde, kds, kde,  &amp;<a name='3021'>
                                   ims, ime, jms, jme, kms, kme,  &amp;<a name='3022'>
                                   its, ite, jts, jte, kts, kte  )<a name='3023'>
<a name='3024'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_W_2'>vertical_diffusion_w_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_W_2_1">( rw_tendf, config_flags, mu,    &amp;<a name='3025'>
                                   defor33, tke(ims,kms,jms),     &amp;<a name='3026'>
                                   div, xkmv,                     &amp;<a name='3027'>
                                   dn, rdz,                       &amp;  <a name='3028'>
                                   ids, ide, jds, jde, kds, kde,  &amp;<a name='3029'>
                                   ims, ime, jms, jme, kms, kme,  &amp;<a name='3030'>
                                   its, ite, jts, jte, kts, kte  )<a name='3031'>
<a name='3032'>
<font color=#447700>!*****************************************<a name='3033'></font>
<font color=#447700>!*****************************************<a name='3034'></font>
<font color=#447700>!  MODIFICA al flusso di momento alla parete<a name='3035'></font>
<font color=#447700>!<a name='3036'></font>
    cd0 = config_flags%tke_drag_coefficient  <font color=#447700>! constant drag coefficient<a name='3037'></font>
                                             <font color=#447700>! set in namelist.input<a name='3038'></font>
    DO j = j_start, j_end+1<a name='3039'>
    DO i = i_start, i_end+1<a name='3040'>
       Cd(i,j)=  cd0<a name='3041'>
    ENDDO<a name='3042'>
    ENDDO<a name='3043'>
<font color=#447700>!<a name='3044'></font>
<font color=#447700>!calcolo del modulo della velocita<a name='3045'></font>
    DO j = j_start, j_end<a name='3046'>
    DO i = i_start, i_end+1<a name='3047'>
       V0_u=0.<a name='3048'>
       tao_xz=0.<a name='3049'>
       V0_u=    sqrt((u_2(i,kts,j)**2) +         &amp;<a name='3050'>
                        (((v_2(i  ,kts,j  )+          &amp;<a name='3051'>
                           v_2(i  ,kts,j+1)+          &amp;<a name='3052'>
                           v_2(i-1,kts,j  )+          &amp;<a name='3053'>
                           v_2(i-1,kts,j+1))/4)**2))+epsilon<a name='3054'>
       tao_xz=Cd(i,j)*V0_u*u_2(i,kts,j)<a name='3055'>
       ru_tendf(i,kts,j)=ru_tendf(i,kts,j)            &amp;<a name='3056'>
                         -0.25*(mu(i,j)+mu(i-1,j))*tao_xz*(rdzw(i,kts,j)+rdzw(i-1,kts,j))<a name='3057'>
    ENDDO<a name='3058'>
    ENDDO<a name='3059'>
 <a name='3060'>
<font color=#447700>!<a name='3061'></font>
    DO j = j_start, j_end+1<a name='3062'>
    DO i = i_start, i_end<a name='3063'>
       V0_v=0.<a name='3064'>
       tao_yz=0.<a name='3065'>
       V0_v=    sqrt((v_2(i,kts,j)**2) +         &amp;<a name='3066'>
                        (((u_2(i  ,kts,j  )+          &amp;<a name='3067'>
                           u_2(i  ,kts,j-1)+          &amp;<a name='3068'>
                           u_2(i+1,kts,j  )+          &amp;<a name='3069'>
                           u_2(i+1,kts,j-1))/4)**2))+epsilon<a name='3070'>
       tao_yz=Cd(i,j)*V0_v*v_2(i,kts,j)<a name='3071'>
       rv_tendf(i,kts,j)=rv_tendf(i,kts,j)            &amp;<a name='3072'>
                         -0.25*(mu(i,j)+mu(i,j-1))*tao_yz*(rdzw(i,kts,j)+rdzw(i,kts,j-1))<a name='3073'>
    ENDDO<a name='3074'>
    ENDDO<a name='3075'>
<font color=#447700>!<a name='3076'></font>
<font color=#447700>!  FINE MODIFICA al flusso di momento alla parete<a name='3077'></font>
<font color=#447700>!*****************************************<a name='3078'></font>
<font color=#447700>!*****************************************<a name='3079'></font>
<a name='3080'>
   IF ( config_flags%mix_full_fields ) THEN<a name='3081'>
<a name='3082'>
     DO j=jts,min(jte,jde-1)<a name='3083'>
     DO k=kts,kte-1<a name='3084'>
     DO i=its,min(ite,ide-1)<a name='3085'>
       var_mix(i,k,j) = thp(i,k,j)<a name='3086'>
     ENDDO<a name='3087'>
     ENDDO<a name='3088'>
     ENDDO<a name='3089'>
<a name='3090'>
   ELSE<a name='3091'>
<a name='3092'>
     DO j=jts,min(jte,jde-1)<a name='3093'>
     DO k=kts,kte-1<a name='3094'>
     DO i=its,min(ite,ide-1)<a name='3095'>
       var_mix(i,k,j) = thp(i,k,j) - t_base(k)<a name='3096'>
     ENDDO<a name='3097'>
     ENDDO<a name='3098'>
     ENDDO<a name='3099'>
<a name='3100'>
   END IF<a name='3101'>
<a name='3102'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S'>vertical_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_S_1">( rt_tendf, config_flags, var_mix, mu, xkhv, &amp;<a name='3103'>
                              dn, dnw, rdz, rdzw, fnm, fnp,          &amp;<a name='3104'>
                              .false.,                               &amp;<a name='3105'>
                              ids, ide, jds, jde, kds, kde,          &amp;<a name='3106'>
                              ims, ime, jms, jme, kms, kme,          &amp;<a name='3107'>
                              its, ite, jts, jte, kts, kte          )<a name='3108'>
<a name='3109'>
<a name='3110'>
<font color=#447700>!*****************************************<a name='3111'></font>
<font color=#447700>!*****************************************<a name='3112'></font>
<font color=#447700>!MODIFICA al flusso di calore<a name='3113'></font>
<font color=#447700>!<a name='3114'></font>
<font color=#447700>!<a name='3115'></font>
    heat_flux = config_flags%tke_heat_flux  <font color=#447700>! constant heat flux value<a name='3116'></font>
                                            <font color=#447700>! set in namelist.input<a name='3117'></font>
    DO j = j_start, j_end<a name='3118'>
    DO i = i_start, i_end<a name='3119'>
<a name='3120'>
       rt_tendf(i,kts,j)=rt_tendf(i,kts,j)  &amp;<a name='3121'>
            +mu(i,j)*heat_flux*rdzw(i,kts,j)<a name='3122'>
<a name='3123'>
    ENDDO<a name='3124'>
    ENDDO<a name='3125'>
<font color=#447700>!<a name='3126'></font>
<font color=#447700>! FINE MODIFICA al flusso di calore<a name='3127'></font>
<font color=#447700>!*****************************************<a name='3128'></font>
<font color=#447700>!*****************************************<a name='3129'></font>
<a name='3130'>
   If (km_opt .eq. 2) then<a name='3131'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S'>vertical_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_S_2">( tke_tendf(ims,kms,jms),               &amp;<a name='3132'>
                              config_flags, tke(ims,kms,jms),       &amp;<a name='3133'>
                              mu, xkhv,                             &amp;<a name='3134'>
                              dn, dnw, rdz, rdzw, fnm, fnp,         &amp;<a name='3135'>
                              .true.,                               &amp;<a name='3136'>
                              ids, ide, jds, jde, kds, kde,         &amp;<a name='3137'>
                              ims, ime, jms, jme, kms, kme,         &amp;<a name='3138'>
                              its, ite, jts, jte, kts, kte         )<a name='3139'>
   endif<a name='3140'>
 <a name='3141'>
   IF (n_moist .ge. PARAM_FIRST_SCALAR) THEN <a name='3142'>
<a name='3143'>
     moist_loop: do im = PARAM_FIRST_SCALAR, n_moist<a name='3144'>
<a name='3145'>
       IF ( (.not. config_flags%mix_full_fields) .and. (im == P_QV) ) THEN<a name='3146'>
<a name='3147'>
         DO j=jts,min(jte,jde-1)<a name='3148'>
         DO k=kts,kte-1<a name='3149'>
         DO i=its,min(ite,ide-1)<a name='3150'>
          var_mix(i,k,j) = moist(i,k,j,im) - qv_base(k)<a name='3151'>
         ENDDO<a name='3152'>
         ENDDO<a name='3153'>
         ENDDO<a name='3154'>
<a name='3155'>
       ELSE<a name='3156'>
<a name='3157'>
         DO j=jts,min(jte,jde-1)<a name='3158'>
         DO k=kts,kte-1<a name='3159'>
         DO i=its,min(ite,ide-1)<a name='3160'>
          var_mix(i,k,j) = moist(i,k,j,im)<a name='3161'>
         ENDDO<a name='3162'>
         ENDDO<a name='3163'>
         ENDDO<a name='3164'>
<a name='3165'>
       END IF<a name='3166'>
<a name='3167'>
<a name='3168'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S'>vertical_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_S_3">( moist_tendf(ims,kms,jms,im),         &amp;<a name='3169'>
                                     config_flags, var_mix,               &amp;<a name='3170'>
                                     mu, xkhv,                            &amp;<a name='3171'>
                                     dn, dnw, rdz, rdzw, fnm, fnp,        &amp;<a name='3172'>
                                     .false.,                             &amp;<a name='3173'>
                                     ids, ide, jds, jde, kds, kde,        &amp;<a name='3174'>
                                     ims, ime, jms, jme, kms, kme,        &amp;<a name='3175'>
                                     its, ite, jts, jte, kts, kte        )<a name='3176'>
<a name='3177'>
     ENDDO moist_loop<a name='3178'>
<a name='3179'>
   ENDIF<a name='3180'>
<a name='3181'>
<a name='3182'>
   IF (n_scalar .ge. PARAM_FIRST_SCALAR) THEN <a name='3183'>
<a name='3184'>
     scalar_loop: do im = PARAM_FIRST_SCALAR, n_scalar<a name='3185'>
<a name='3186'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S'>vertical_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_S_4">( scalar_tendf(ims,kms,jms,im),         &amp;<a name='3187'>
                                     config_flags, scalar(ims,kms,jms,im), &amp;<a name='3188'>
                                     mu, xkhv,                             &amp;<a name='3189'>
                                     dn, dnw, rdz, rdzw, fnm, fnp,         &amp;<a name='3190'>
                                     .false.,                              &amp;<a name='3191'>
                                     ids, ide, jds, jde, kds, kde,         &amp;<a name='3192'>
                                     ims, ime, jms, jme, kms, kme,         &amp;<a name='3193'>
                                     its, ite, jts, jte, kts, kte         )<a name='3194'>
     ENDDO scalar_loop<a name='3195'>
<a name='3196'>
   ENDIF<a name='3197'>
<a name='3198'>
END SUBROUTINE vertical_diffusion_2<a name='3199'>
<a name='3200'>
<font color=#447700>!=======================================================================<a name='3201'></font>
<font color=#447700>!=======================================================================<a name='3202'></font>
<a name='3203'>
<A NAME='VERTICAL_DIFFUSION_U_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_U_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3204'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_u_2</font>( tendency, config_flags, mu,            &amp; <A href='../../call_to/VERTICAL_DIFFUSION_U_2.html' TARGET='index'>1</A>,<A href='../../call_from/VERTICAL_DIFFUSION_U_2.html' TARGET='index'>1</A><a name='3205'>
                                   defor13, xkmv,                         &amp;<a name='3206'>
                                   dnw, rdzw, fnm, fnp,                   &amp;<a name='3207'>
                                   ids, ide, jds, jde, kds, kde,          &amp;<a name='3208'>
                                   ims, ime, jms, jme, kms, kme,          &amp;<a name='3209'>
                                   its, ite, jts, jte, kts, kte          )<a name='3210'>
<a name='3211'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3212'></font>
<font color=#447700>! Begin declarations.<a name='3213'></font>
<a name='3214'>
   IMPLICIT NONE<a name='3215'>
<a name='3216'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3217'>
<a name='3218'>
   INTEGER ,         INTENT(IN   ) ::       ids, ide, jds, jde, kds, kde, &amp;<a name='3219'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='3220'>
                                            its, ite, jts, jte, kts, kte<a name='3221'>
<a name='3222'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='3223'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='3224'>
   REAL , DIMENSION( kms:kme ) ,            INTENT(IN   )      :: dnw<a name='3225'>
<font color=#447700>!   REAL , DIMENSION( ims:ime , jms:jme ) ,  INTENT(IN   )      :: zeta_z<a name='3226'></font>
<a name='3227'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::tendency<a name='3228'>
<a name='3229'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) ,                       &amp;<a name='3230'>
                                            INTENT(IN   )      ::defor13, &amp;<a name='3231'>
                                                                    xkmv, &amp;<a name='3232'>
                                                                      rdzw<a name='3233'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,  INTENT(IN   )      :: mu<a name='3234'>
<a name='3235'>
<font color=#447700>! LOCAL VARS<a name='3236'></font>
<a name='3237'>
   INTEGER :: i, j, k, ktf<a name='3238'>
<a name='3239'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3240'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext  <a name='3241'>
<a name='3242'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)        :: titau3<a name='3243'>
<a name='3244'>
   REAL , DIMENSION( its:ite, jts:jte)                         ::  zzavg<a name='3245'>
<a name='3246'>
   REAL :: rdzu<a name='3247'>
<a name='3248'>
<font color=#447700>! End declarations.<a name='3249'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3250'></font>
<a name='3251'>
   ktf=MIN(kte,kde-1)<a name='3252'>
  <a name='3253'>
   i_start = its<a name='3254'>
   i_end   = ite<a name='3255'>
   j_start = jts<a name='3256'>
   j_end   = MIN(jte,jde-1)<a name='3257'>
<a name='3258'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='3259'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='3260'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='3261'>
        config_flags%nested) i_end   = MIN(ide-1,ite)<a name='3262'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='3263'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='3264'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='3265'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='3266'>
<a name='3267'>
<font color=#447700>! titau3 = titau13<a name='3268'></font>
   is_ext=0<a name='3269'>
   ie_ext=0<a name='3270'>
   js_ext=0<a name='3271'>
   je_ext=0<a name='3272'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_13_31'>cal_titau_13_31</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_U_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_13_31_2">( config_flags, titau3, defor13,   &amp;<a name='3273'>
                         mu, xkmv, fnm, fnp,              &amp;<a name='3274'>
                         is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='3275'>
                         ids, ide, jds, jde, kds, kde,    &amp;<a name='3276'>
                         ims, ime, jms, jme, kms, kme,    &amp;<a name='3277'>
                         its, ite, jts, jte, kts, kte     )<a name='3278'>
<font color=#447700>!<a name='3279'></font>
      DO j = j_start, j_end<a name='3280'>
      DO k=kts+1,ktf<a name='3281'>
      DO i = i_start, i_end<a name='3282'>
<a name='3283'>
         rdzu = 2./(1./rdzw(i,k,j) + 1./rdzw(i-1,k,j))<a name='3284'>
         tendency(i,k,j)=tendency(i,k,j)-rdzu*(titau3(i,k+1,j)-titau3(i,k,j))<a name='3285'>
<a name='3286'>
      ENDDO<a name='3287'>
      ENDDO<a name='3288'>
      ENDDO<a name='3289'>
<a name='3290'>
<font color=#447700>! ******** MODIF...<a name='3291'></font>
<font color=#447700>!  we will pick up the surface drag (titau3(i,kts,j)) later<a name='3292'></font>
<font color=#447700>!<a name='3293'></font>
       DO j = j_start, j_end<a name='3294'>
       k=kts<a name='3295'>
       DO i = i_start, i_end<a name='3296'>
 <a name='3297'>
          rdzu = 2./(1./rdzw(i,k,j) + 1./rdzw(i-1,k,j))<a name='3298'>
          tendency(i,k,j)=tendency(i,k,j)-rdzu*(titau3(i,k+1,j))<a name='3299'>
       ENDDO<a name='3300'>
       ENDDO<a name='3301'>
<font color=#447700>! ******** MODIF...<a name='3302'></font>
<a name='3303'>
END SUBROUTINE vertical_diffusion_u_2<a name='3304'>
<a name='3305'>
<font color=#447700>!=======================================================================<a name='3306'></font>
<font color=#447700>!=======================================================================<a name='3307'></font>
<a name='3308'>
<A NAME='VERTICAL_DIFFUSION_V_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_V_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3309'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_v_2</font>( tendency, config_flags, mu,            &amp; <A href='../../call_to/VERTICAL_DIFFUSION_V_2.html' TARGET='index'>1</A>,<A href='../../call_from/VERTICAL_DIFFUSION_V_2.html' TARGET='index'>1</A><a name='3310'>
                                   defor23, xkmv,                         &amp;<a name='3311'>
                                   dnw, rdzw, fnm, fnp,                   &amp;<a name='3312'>
                                   ids, ide, jds, jde, kds, kde,          &amp;<a name='3313'>
                                   ims, ime, jms, jme, kms, kme,          &amp;<a name='3314'>
                                   its, ite, jts, jte, kts, kte          )<a name='3315'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3316'></font>
<font color=#447700>! Begin declarations.<a name='3317'></font>
<a name='3318'>
   IMPLICIT NONE<a name='3319'>
<a name='3320'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3321'>
<a name='3322'>
   INTEGER ,         INTENT(IN   ) ::       ids, ide, jds, jde, kds, kde, &amp;<a name='3323'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='3324'>
                                            its, ite, jts, jte, kts, kte<a name='3325'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='3326'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='3327'>
   REAL , DIMENSION( kms:kme ) ,            INTENT(IN   )      :: dnw<a name='3328'>
<font color=#447700>!   REAL , DIMENSION( ims:ime , jms:jme ) ,  INTENT(IN   )      :: zeta_z<a name='3329'></font>
<a name='3330'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::tendency<a name='3331'>
<a name='3332'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) ,                       &amp;<a name='3333'>
                                            INTENT(IN   )      ::defor23, &amp;<a name='3334'>
                                                                    xkmv, &amp;<a name='3335'>
                                                                    rdzw<a name='3336'>
<a name='3337'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,  INTENT(IN   )      :: mu<a name='3338'>
<a name='3339'>
<font color=#447700>! LOCAL VARS<a name='3340'></font>
<a name='3341'>
   INTEGER :: i, j, k, ktf<a name='3342'>
<a name='3343'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3344'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext  <a name='3345'>
<a name='3346'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)        :: titau3<a name='3347'>
<a name='3348'>
   REAL , DIMENSION( its:ite, jts:jte)                         ::  zzavg<a name='3349'>
<a name='3350'>
   REAL  :: rdzv<a name='3351'>
<a name='3352'>
<font color=#447700>! End declarations.<a name='3353'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3354'></font>
<a name='3355'>
   ktf=MIN(kte,kde-1)<a name='3356'>
  <a name='3357'>
   i_start = its<a name='3358'>
   i_end   = MIN(ite,ide-1)<a name='3359'>
   j_start = jts<a name='3360'>
   j_end   = jte<a name='3361'>
<a name='3362'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='3363'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='3364'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='3365'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='3366'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='3367'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='3368'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='3369'>
        config_flags%nested) j_end   = MIN(jde-1,jte)<a name='3370'>
<a name='3371'>
<font color=#447700>! titau3 = titau23<a name='3372'></font>
   is_ext=0<a name='3373'>
   ie_ext=0<a name='3374'>
   js_ext=0<a name='3375'>
   je_ext=0<a name='3376'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_23_32'>cal_titau_23_32</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_V_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_23_32_2">( config_flags, titau3, defor23,   &amp;<a name='3377'>
                         mu, xkmv, fnm, fnp,              &amp;<a name='3378'>
                         is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='3379'>
                         ids, ide, jds, jde, kds, kde,    &amp;<a name='3380'>
                         ims, ime, jms, jme, kms, kme,    &amp;<a name='3381'>
                         its, ite, jts, jte, kts, kte     )<a name='3382'>
<a name='3383'>
   DO j = j_start, j_end<a name='3384'>
   DO k = kts+1,ktf<a name='3385'>
   DO i = i_start, i_end<a name='3386'>
<a name='3387'>
      rdzv = 2./(1./rdzw(i,k,j) + 1./rdzw(i,k,j-1))<a name='3388'>
      tendency(i,k,j)=tendency(i,k,j)-rdzv*(titau3(i,k+1,j)-titau3(i,k,j))<a name='3389'>
<a name='3390'>
   ENDDO<a name='3391'>
   ENDDO<a name='3392'>
   ENDDO<a name='3393'>
<a name='3394'>
<font color=#447700>! ******** MODIF...<a name='3395'></font>
<font color=#447700>!  we will pick up the surface drag (titau3(i,kts,j)) later<a name='3396'></font>
<font color=#447700>!<a name='3397'></font>
       DO j = j_start, j_end<a name='3398'>
       k=kts<a name='3399'>
       DO i = i_start, i_end<a name='3400'>
 <a name='3401'>
          rdzv = 2./(1./rdzw(i,k,j) + 1./rdzw(i,k,j-1))<a name='3402'>
          tendency(i,k,j)=tendency(i,k,j)-rdzv*(titau3(i,k+1,j))<a name='3403'>
 <a name='3404'>
       ENDDO<a name='3405'>
       ENDDO<a name='3406'>
<font color=#447700>! ******** MODIF...<a name='3407'></font>
<a name='3408'>
END SUBROUTINE vertical_diffusion_v_2<a name='3409'>
<a name='3410'>
<font color=#447700>!=======================================================================<a name='3411'></font>
<font color=#447700>!=======================================================================<a name='3412'></font>
<a name='3413'>
<A NAME='VERTICAL_DIFFUSION_W_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_W_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3414'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_w_2</font>(tendency, config_flags, mu,             &amp; <A href='../../call_to/VERTICAL_DIFFUSION_W_2.html' TARGET='index'>1</A>,<A href='../../call_from/VERTICAL_DIFFUSION_W_2.html' TARGET='index'>1</A><a name='3415'>
                                defor33, tke, div, xkmv,                  &amp;<a name='3416'>
                                dn, rdz,                                  &amp;<a name='3417'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='3418'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='3419'>
                                its, ite, jts, jte, kts, kte              )<a name='3420'>
<a name='3421'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3422'></font>
<font color=#447700>! Begin declarations.<a name='3423'></font>
<a name='3424'>
   IMPLICIT NONE<a name='3425'>
<a name='3426'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3427'>
<a name='3428'>
   INTEGER ,         INTENT(IN   ) ::       ids, ide, jds, jde, kds, kde, &amp;<a name='3429'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='3430'>
                                            its, ite, jts, jte, kts, kte<a name='3431'>
<a name='3432'>
   REAL , DIMENSION( kms:kme ) ,            INTENT(IN   )      ::  dn<a name='3433'>
<a name='3434'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::tendency<a name='3435'>
<a name='3436'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) ,                       &amp;<a name='3437'>
                                            INTENT(IN   )      ::defor33, &amp;<a name='3438'>
                                                                     tke, &amp;<a name='3439'>
                                                                     div, &amp;<a name='3440'>
                                                                    xkmv, &amp;<a name='3441'>
                                                                     rdz<a name='3442'>
<a name='3443'>
   REAL , DIMENSION( ims:ime, jms:jme), INTENT(IN   ) :: mu<a name='3444'>
<a name='3445'>
<font color=#447700>! LOCAL VARS<a name='3446'></font>
<a name='3447'>
   INTEGER :: i, j, k, ktf<a name='3448'>
<a name='3449'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3450'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext  <a name='3451'>
<a name='3452'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)        :: titau3<a name='3453'>
<a name='3454'>
<font color=#447700>! End declarations.<a name='3455'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3456'></font>
<a name='3457'>
   ktf=MIN(kte,kde-1)<a name='3458'>
  <a name='3459'>
   i_start = its<a name='3460'>
   i_end   = MIN(ite,ide-1)<a name='3461'>
   j_start = jts<a name='3462'>
   j_end   = MIN(jte,jde-1)<a name='3463'>
<a name='3464'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='3465'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='3466'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='3467'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='3468'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='3469'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='3470'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='3471'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='3472'>
<a name='3473'>
<font color=#447700>! titau3 = titau33<a name='3474'></font>
   is_ext=0<a name='3475'>
   ie_ext=0<a name='3476'>
   js_ext=0<a name='3477'>
   je_ext=0<a name='3478'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_11_22_33'>cal_titau_11_22_33</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_W_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_11_22_33_3">( config_flags, titau3,            &amp;<a name='3479'>
                            mu, tke, xkmv, defor33,          &amp;<a name='3480'>
                            is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='3481'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='3482'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='3483'>
                            its, ite, jts, jte, kts, kte     )<a name='3484'>
<a name='3485'>
<font color=#447700>!   DO j = j_start, j_end<a name='3486'></font>
<font color=#447700>!   DO k = kts+1, ktf<a name='3487'></font>
<font color=#447700>!   DO i = i_start, i_end<a name='3488'></font>
<font color=#447700>!      titau3(i,k,j)=titau3(i,k,j)*zeta_z(i,j)<a name='3489'></font>
<font color=#447700>!   ENDDO<a name='3490'></font>
<font color=#447700>!   ENDDO<a name='3491'></font>
<font color=#447700>!   ENDDO<a name='3492'></font>
<a name='3493'>
   DO j = j_start, j_end<a name='3494'>
   DO k = kts+1, ktf<a name='3495'>
   DO i = i_start, i_end<a name='3496'>
      tendency(i,k,j)=tendency(i,k,j)-rdz(i,k,j)*(titau3(i,k,j)-titau3(i,k-1,j))<a name='3497'>
   ENDDO<a name='3498'>
   ENDDO<a name='3499'>
   ENDDO<a name='3500'>
<a name='3501'>
END SUBROUTINE vertical_diffusion_w_2<a name='3502'>
<a name='3503'>
<font color=#447700>!=======================================================================<a name='3504'></font>
<font color=#447700>!=======================================================================<a name='3505'></font>
<a name='3506'>
<A NAME='VERTICAL_DIFFUSION_S'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3507'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_s</font>( tendency, config_flags, var, mu, xkhv,   &amp; <A href='../../call_to/VERTICAL_DIFFUSION_S.html' TARGET='index'>4</A><a name='3508'>
                                 dn, dnw, rdz, rdzw, fnm, fnp,            &amp;<a name='3509'>
                                 doing_tke,                               &amp;<a name='3510'>
                                 ids, ide, jds, jde, kds, kde,            &amp;<a name='3511'>
                                 ims, ime, jms, jme, kms, kme,            &amp;<a name='3512'>
                                 its, ite, jts, jte, kts, kte            )<a name='3513'>
<a name='3514'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3515'></font>
<font color=#447700>! Begin declarations.<a name='3516'></font>
<a name='3517'>
   IMPLICIT NONE<a name='3518'>
<a name='3519'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3520'>
<a name='3521'>
   INTEGER ,         INTENT(IN   ) ::       ids, ide, jds, jde, kds, kde, &amp;<a name='3522'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='3523'>
                                            its, ite, jts, jte, kts, kte<a name='3524'>
<a name='3525'>
   LOGICAL,         INTENT(IN   ) ::        doing_tke<a name='3526'>
<a name='3527'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='3528'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='3529'>
   REAL , DIMENSION( kms:kme ) ,            INTENT(IN   )      ::  dn<a name='3530'>
   REAL , DIMENSION( kms:kme ) ,            INTENT(IN   )      :: dnw<a name='3531'>
<a name='3532'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::tendency<a name='3533'>
<a name='3534'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) , INTENT(IN) ::   xkhv<a name='3535'>
<a name='3536'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN) ::   mu<a name='3537'>
<a name='3538'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) ,                       &amp;<a name='3539'>
                                            INTENT(IN   )      ::    var, &amp;<a name='3540'>
                                                                     rdz, &amp;<a name='3541'>
                                                                    rdzw<a name='3542'>
<font color=#447700>! LOCAL VARS<a name='3543'></font>
<a name='3544'>
   INTEGER :: i, j, k, ktf<a name='3545'>
<a name='3546'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3547'>
<a name='3548'>
   REAL , DIMENSION( its:ite, kts:kte, jts:jte)            ::        H3, &amp;<a name='3549'>
                                                                 xkxavg, &amp;<a name='3550'>
                                                                  rravg<a name='3551'>
<a name='3552'>
   REAL , DIMENSION( its:ite, kts:kte, jts:jte)            ::  tmptendf<a name='3553'>
<a name='3554'>
<font color=#447700>! End declarations.<a name='3555'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3556'></font>
<a name='3557'>
   ktf=MIN(kte,kde-1)<a name='3558'>
  <a name='3559'>
   i_start = its<a name='3560'>
   i_end   = MIN(ite,ide-1)<a name='3561'>
   j_start = jts<a name='3562'>
   j_end   = MIN(jte,jde-1)<a name='3563'>
<a name='3564'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='3565'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='3566'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='3567'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='3568'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='3569'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='3570'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='3571'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='3572'>
<a name='3573'>
   IF (doing_tke) THEN<a name='3574'>
      DO j = j_start, j_end<a name='3575'>
      DO k = kts,ktf<a name='3576'>
      DO i = i_start, i_end<a name='3577'>
         tmptendf(i,k,j)=tendency(i,k,j)<a name='3578'>
      ENDDO<a name='3579'>
      ENDDO<a name='3580'>
      ENDDO<a name='3581'>
   ENDIF<a name='3582'>
<a name='3583'>
<font color=#447700>! H3<a name='3584'></font>
<a name='3585'>
   xkxavg = 0.<a name='3586'>
<a name='3587'>
   DO j = j_start, j_end<a name='3588'>
   DO k = kts+1,ktf<a name='3589'>
   DO i = i_start, i_end<a name='3590'>
      xkxavg(i,k,j)=fnm(k)*xkhv(i,k,j)+fnp(k)*xkhv(i,k-1,j)<a name='3591'>
      H3(i,k,j)=-xkxavg(i,k,j)*(var(i,k,j)-var(i,k-1,j))*rdz(i,k,j)<a name='3592'>
<font color=#447700>!      H3(i,k,j)=-xkxavg(i,k,j)*zeta_z(i,j)* &amp;<a name='3593'></font>
<font color=#447700>!                 (var(i,k,j)-var(i,k-1,j))/dn(k)<a name='3594'></font>
   ENDDO<a name='3595'>
   ENDDO<a name='3596'>
   ENDDO<a name='3597'>
<a name='3598'>
   DO j = j_start, j_end<a name='3599'>
   DO i = i_start, i_end<a name='3600'>
      H3(i,kts,j)=0.<a name='3601'>
      H3(i,ktf+1,j)=0.<a name='3602'>
<font color=#447700>!      H3(i,kts,j)=H3(i,kts+1,j)<a name='3603'></font>
<font color=#447700>!      H3(i,ktf+1,j)=H3(i,ktf,j)<a name='3604'></font>
   ENDDO<a name='3605'>
   ENDDO<a name='3606'>
<a name='3607'>
   DO j = j_start, j_end<a name='3608'>
   DO k = kts,ktf<a name='3609'>
   DO i = i_start, i_end<a name='3610'>
      tendency(i,k,j)=tendency(i,k,j)  &amp;<a name='3611'>
                       -mu(i,j)*(H3(i,k+1,j)-H3(i,k,j))*rdzw(i,k,j)<a name='3612'>
   ENDDO<a name='3613'>
   ENDDO<a name='3614'>
   ENDDO<a name='3615'>
<a name='3616'>
   IF (doing_tke) THEN<a name='3617'>
      DO j = j_start, j_end<a name='3618'>
      DO k = kts,ktf<a name='3619'>
      DO i = i_start, i_end<a name='3620'>
          tendency(i,k,j)=tmptendf(i,k,j)+2.* &amp;<a name='3621'>
                          (tendency(i,k,j)-tmptendf(i,k,j))<a name='3622'>
      ENDDO<a name='3623'>
      ENDDO<a name='3624'>
      ENDDO<a name='3625'>
   ENDIF<a name='3626'>
<a name='3627'>
END SUBROUTINE vertical_diffusion_s<a name='3628'>
<a name='3629'>
<font color=#447700>!=======================================================================<a name='3630'></font>
<font color=#447700>!=======================================================================<a name='3631'></font>
<a name='3632'>
<A NAME='CAL_TITAU_11_22_33'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_11_22_33' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3633'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_titau_11_22_33</font>( config_flags, titau,              &amp; <A href='../../call_to/CAL_TITAU_11_22_33.html' TARGET='index'>3</A><a name='3634'>
                                   mu, tke, xkx, defor,              &amp;<a name='3635'>
                                   is_ext, ie_ext, js_ext, je_ext,   &amp;<a name='3636'>
                                   ids, ide, jds, jde, kds, kde,     &amp;<a name='3637'>
                                   ims, ime, jms, jme, kms, kme,     &amp;<a name='3638'>
                                   its, ite, jts, jte, kts, kte      )<a name='3639'>
<a name='3640'>
<font color=#447700>! History:     Sep 2003  Changes by George Bryan and Jason Knievel, NCAR<a name='3641'></font>
<font color=#447700>!              Oct 2001  Converted to mass core by Bill Skamarock, NCAR<a name='3642'></font>
<font color=#447700>!              Aug 2000  Original code by Shu-Hua Chen, UC-Davis<a name='3643'></font>
<a name='3644'>
<font color=#447700>! Purpose:     This routine calculates stress terms (taus) for use in<a name='3645'></font>
<font color=#447700>!              the calculation of production of TKE by sheared wind<a name='3646'></font>
<a name='3647'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='3648'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='3649'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='3650'></font>
<a name='3651'>
<font color=#447700>! Key:<a name='3652'></font>
<a name='3653'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3654'></font>
<font color=#447700>! Begin declarations.<a name='3655'></font>
<a name='3656'>
    IMPLICIT NONE<a name='3657'>
<a name='3658'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='3659'>
    :: config_flags<a name='3660'>
<a name='3661'>
    INTEGER, INTENT( IN )  &amp;<a name='3662'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='3663'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='3664'>
       its, ite, jts, jte, kts, kte<a name='3665'>
<a name='3666'>
    INTEGER, INTENT( IN )  &amp;<a name='3667'>
    :: is_ext, ie_ext, js_ext, je_ext  <a name='3668'>
<a name='3669'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 ), INTENT( INOUT )  &amp;<a name='3670'>
    :: titau <a name='3671'>
<a name='3672'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='3673'>
    :: defor, xkx, tke<a name='3674'>
<a name='3675'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='3676'>
    :: mu<a name='3677'>
<a name='3678'>
<font color=#447700>! Local variables.<a name='3679'></font>
<a name='3680'>
    INTEGER  &amp;<a name='3681'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='3682'>
<a name='3683'>
<font color=#447700>! End declarations.<a name='3684'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3685'></font>
<a name='3686'>
    ktf = MIN( kte, kde-1 )<a name='3687'>
<a name='3688'>
    i_start = its<a name='3689'>
    i_end   = ite<a name='3690'>
    j_start = jts<a name='3691'>
    j_end   = jte<a name='3692'>
<a name='3693'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='3694'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='3695'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='3696'>
         config_flags%nested) i_end   = MIN( ide-1, ite )<a name='3697'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='3698'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='3699'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='3700'>
         config_flags%nested) j_end   = MIN( jde-1, jte )<a name='3701'>
<a name='3702'>
    i_start = i_start - is_ext<a name='3703'>
    i_end   = i_end   + ie_ext   <a name='3704'>
    j_start = j_start - js_ext<a name='3705'>
    j_end   = j_end   + je_ext   <a name='3706'>
<a name='3707'>
    IF ( config_flags%km_opt .EQ. 2) THEN<a name='3708'>
      DO j = j_start,j_end<a name='3709'>
      DO k = kts,ktf<a name='3710'>
      DO i = i_start,i_end  <a name='3711'>
        titau(i,k,j) = mu(i,j) * ( - xkx(i,k,j) * ( defor(i,k,j) ) )       <a name='3712'>
      END DO<a name='3713'>
      END DO<a name='3714'>
      END DO<a name='3715'>
    ELSE<a name='3716'>
      DO j = j_start, j_end<a name='3717'>
      DO k = kts, ktf<a name='3718'>
      DO i = i_start, i_end<a name='3719'>
        titau(i,k,j) = - mu(i,j) * xkx(i,k,j) * defor(i,k,j)<a name='3720'>
      END DO<a name='3721'>
      END DO<a name='3722'>
      END DO<a name='3723'>
    END IF<a name='3724'>
<a name='3725'>
    END SUBROUTINE cal_titau_11_22_33<a name='3726'>
<a name='3727'>
<font color=#447700>!=======================================================================<a name='3728'></font>
<font color=#447700>!=======================================================================<a name='3729'></font>
<a name='3730'>
<A NAME='CAL_TITAU_12_21'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_12_21' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3731'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_titau_12_21</font>( config_flags, titau,             &amp; <A href='../../call_to/CAL_TITAU_12_21.html' TARGET='index'>2</A><a name='3732'>
                                mu, xkx, defor,                  &amp;<a name='3733'>
                                is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='3734'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='3735'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='3736'>
                                its, ite, jts, jte, kts, kte     )<a name='3737'>
<a name='3738'>
<font color=#447700>! History:     Sep 2003   Modifications by George Bryan and Jason Knievel, NCAR<a name='3739'></font>
<font color=#447700>!              Oct 2001   Converted to mass core by Bill Skamarock, NCAR<a name='3740'></font>
<font color=#447700>!              Aug 2000   Original code by Shu-Hua Chen, UC-Davis<a name='3741'></font>
<a name='3742'>
<font color=#447700>! Pusrpose     This routine calculates the stress terms (taus) for use in<a name='3743'></font>
<font color=#447700>!              the calculation of production of TKE by sheared wind<a name='3744'></font>
<a name='3745'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='3746'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='3747'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='3748'></font>
<a name='3749'>
<font color=#447700>! Key:<a name='3750'></font>
<a name='3751'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3752'></font>
<font color=#447700>! Begin declarations.<a name='3753'></font>
<a name='3754'>
    IMPLICIT NONE<a name='3755'>
<a name='3756'>
    TYPE( grid_config_rec_type), INTENT( IN )  &amp;<a name='3757'>
    :: config_flags<a name='3758'>
<a name='3759'>
    INTEGER, INTENT( IN )  &amp;<a name='3760'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='3761'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='3762'>
       its, ite, jts, jte, kts, kte<a name='3763'>
<a name='3764'>
    INTEGER, INTENT( IN )  &amp;<a name='3765'>
    :: is_ext, ie_ext, js_ext, je_ext  <a name='3766'>
<a name='3767'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 ), INTENT( INOUT )  &amp;<a name='3768'>
    :: titau <a name='3769'>
 <a name='3770'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='3771'>
    :: defor, xkx<a name='3772'>
<a name='3773'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='3774'>
    :: mu<a name='3775'>
<a name='3776'>
<font color=#447700>! Local variables.<a name='3777'></font>
<a name='3778'>
    INTEGER  &amp;<a name='3779'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='3780'>
<a name='3781'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 )  &amp;<a name='3782'>
    :: xkxavg  <a name='3783'>
<a name='3784'>
    REAL, DIMENSION( its-1:ite+1, jts-1:jte+1 )  &amp;<a name='3785'>
    :: muavg<a name='3786'>
<a name='3787'>
<font color=#447700>! End declarations.<a name='3788'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3789'></font>
<a name='3790'>
    ktf = MIN( kte, kde-1 )<a name='3791'>
<a name='3792'>
<font color=#447700>! Needs one more point in the x and y directions.<a name='3793'></font>
<a name='3794'>
    i_start = its<a name='3795'>
    i_end   = ite<a name='3796'>
    j_start = jts<a name='3797'>
    j_end   = jte<a name='3798'>
<a name='3799'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='3800'>
         config_flags%nested ) i_start = MAX( ids+1, its )<a name='3801'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='3802'>
         config_flags%nested ) i_end   = MIN( ide-1, ite )<a name='3803'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='3804'>
         config_flags%nested ) j_start = MAX( jds+1, jts )<a name='3805'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='3806'>
         config_flags%nested ) j_end   = MIN( jde-1, jte )<a name='3807'>
<a name='3808'>
    i_start = i_start - is_ext<a name='3809'>
    i_end   = i_end   + ie_ext   <a name='3810'>
    j_start = j_start - js_ext<a name='3811'>
    j_end   = j_end   + je_ext   <a name='3812'>
<a name='3813'>
    DO j = j_start, j_end<a name='3814'>
    DO k = kts, ktf<a name='3815'>
    DO i = i_start, i_end<a name='3816'>
      xkxavg(i,k,j) = 0.25 * ( xkx(i-1,k,j  ) + xkx(i,k,j  ) +  &amp;<a name='3817'>
                               xkx(i-1,k,j-1) + xkx(i,k,j-1) )<a name='3818'>
    END DO<a name='3819'>
    END DO<a name='3820'>
    END DO<a name='3821'>
<a name='3822'>
    DO j = j_start, j_end<a name='3823'>
    DO i = i_start, i_end<a name='3824'>
      muavg(i,j) = 0.25 * ( mu(i-1,j  ) + mu(i,j  ) +  &amp;<a name='3825'>
                            mu(i-1,j-1) + mu(i,j-1) )<a name='3826'>
    END DO<a name='3827'>
    END DO<a name='3828'>
<a name='3829'>
<font color=#447700>! titau12 or titau21<a name='3830'></font>
<a name='3831'>
    DO j = j_start, j_end<a name='3832'>
    DO k = kts, ktf<a name='3833'>
    DO i = i_start, i_end<a name='3834'>
      titau(i,k,j) = - muavg(i,j) * xkxavg(i,k,j) * defor(i,k,j)<a name='3835'>
    END DO<a name='3836'>
    END DO<a name='3837'>
    END DO<a name='3838'>
<a name='3839'>
    END SUBROUTINE cal_titau_12_21<a name='3840'>
<a name='3841'>
<font color=#447700>!=======================================================================<a name='3842'></font>
<a name='3843'>
<A NAME='CAL_TITAU_13_31'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_13_31' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3844'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_titau_13_31</font>( config_flags, titau,             &amp; <A href='../../call_to/CAL_TITAU_13_31.html' TARGET='index'>2</A><a name='3845'>
                                defor, mu, xkx, fnm, fnp,        &amp;<a name='3846'>
                                is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='3847'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='3848'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='3849'>
                                its, ite, jts, jte, kts, kte     )<a name='3850'>
<a name='3851'>
<font color=#447700>! History:     Sep 2003   Modifications by George Bryan and Jason Knievel, NCAR<a name='3852'></font>
<font color=#447700>!              Oct 2001   Converted to mass core by Bill Skamarock, NCAR<a name='3853'></font>
<font color=#447700>!              Aug 2000   Original code by Shu-Hua Chen, UC-Davis<a name='3854'></font>
<a name='3855'>
<font color=#447700>! Purpose:     This routine calculates the stress terms (taus) for use in<a name='3856'></font>
<font color=#447700>!              the calculation of production of TKE by sheared wind<a name='3857'></font>
<a name='3858'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='3859'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='3860'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='3861'></font>
<a name='3862'>
<font color=#447700>! Key:<a name='3863'></font>
<a name='3864'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3865'></font>
<font color=#447700>! Begin declarations.<a name='3866'></font>
<a name='3867'>
    IMPLICIT NONE<a name='3868'>
<a name='3869'>
    TYPE( grid_config_rec_type), INTENT( IN )  &amp;<a name='3870'>
    :: config_flags<a name='3871'>
<a name='3872'>
    INTEGER, INTENT( IN )  &amp;<a name='3873'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='3874'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='3875'>
       its, ite, jts, jte, kts, kte<a name='3876'>
<a name='3877'>
    INTEGER, INTENT( IN )  &amp;<a name='3878'>
    :: is_ext, ie_ext, js_ext, je_ext  <a name='3879'>
<a name='3880'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='3881'>
    :: fnm, fnp<a name='3882'>
<a name='3883'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 ), INTENT( INOUT )  &amp;<a name='3884'>
    :: titau <a name='3885'>
 <a name='3886'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme), INTENT( IN )  &amp;<a name='3887'>
    :: defor, xkx<a name='3888'>
<a name='3889'>
    REAL, DIMENSION( ims:ime, jms:jme), INTENT( IN )  &amp;<a name='3890'>
    :: mu<a name='3891'>
<a name='3892'>
<font color=#447700>! Local variables.<a name='3893'></font>
<a name='3894'>
    INTEGER  &amp;<a name='3895'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='3896'>
<a name='3897'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 )  &amp;<a name='3898'>
    :: xkxavg <a name='3899'>
<a name='3900'>
    REAL, DIMENSION( its-1:ite+1, jts-1:jte+1 )  &amp;<a name='3901'>
    :: muavg<a name='3902'>
<a name='3903'>
<font color=#447700>! End declarations.<a name='3904'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3905'></font>
<a name='3906'>
    ktf = MIN( kte, kde-1 )<a name='3907'>
<a name='3908'>
<font color=#447700>! Find ide-1 and jde-1 for averaging to p point.<a name='3909'></font>
<a name='3910'>
    i_start = its<a name='3911'>
    i_end   = ite<a name='3912'>
    j_start = jts<a name='3913'>
    j_end   = MIN( jte, jde-1 )<a name='3914'>
<a name='3915'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='3916'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='3917'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='3918'>
         config_flags%nested) i_end   = MIN( ide-1, ite )<a name='3919'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='3920'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='3921'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='3922'>
         config_flags%nested) j_end   = MIN( jde-2, jte )<a name='3923'>
<a name='3924'>
    i_start = i_start - is_ext<a name='3925'>
    i_end   = i_end   + ie_ext   <a name='3926'>
    j_start = j_start - js_ext<a name='3927'>
    j_end   = j_end   + je_ext   <a name='3928'>
<a name='3929'>
    DO j = j_start, j_end<a name='3930'>
    DO k = kts+1, ktf<a name='3931'>
    DO i = i_start, i_end<a name='3932'>
      xkxavg(i,k,j) = 0.5 * ( fnm(k) * ( xkx(i,k  ,j) + xkx(i-1,k  ,j) ) +  &amp;<a name='3933'>
                              fnp(k) * ( xkx(i,k-1,j) + xkx(i-1,k-1,j) ) )<a name='3934'>
    END DO<a name='3935'>
    END DO<a name='3936'>
    END DO<a name='3937'>
<a name='3938'>
    DO j = j_start, j_end<a name='3939'>
    DO i = i_start, i_end<a name='3940'>
      muavg(i,j) = 0.5 * ( mu(i,j) + mu(i-1,j) )<a name='3941'>
    END DO<a name='3942'>
    END DO<a name='3943'>
<a name='3944'>
    DO j = j_start, j_end<a name='3945'>
    DO k = kts+1, ktf<a name='3946'>
    DO i = i_start, i_end<a name='3947'>
      titau(i,k,j) = - muavg(i,j) * xkxavg(i,k,j) * defor(i,k,j)<a name='3948'>
    ENDDO<a name='3949'>
    ENDDO<a name='3950'>
    ENDDO<a name='3951'>
<a name='3952'>
    DO j = j_start, j_end<a name='3953'>
    DO i = i_start, i_end<a name='3954'>
      titau(i,kts  ,j) = 0.0<a name='3955'>
      titau(i,ktf+1,j) = 0.0<a name='3956'>
    ENDDO<a name='3957'>
    ENDDO<a name='3958'>
<a name='3959'>
    END SUBROUTINE cal_titau_13_31<a name='3960'>
<a name='3961'>
<font color=#447700>!=======================================================================<a name='3962'></font>
<font color=#447700>!=======================================================================<a name='3963'></font>
<a name='3964'>
<A NAME='CAL_TITAU_23_32'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_23_32' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3965'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_titau_23_32</font>( config_flags, titau, defor,      &amp; <A href='../../call_to/CAL_TITAU_23_32.html' TARGET='index'>2</A><a name='3966'>
                                mu, xkx, fnm, fnp,               &amp;<a name='3967'>
                                is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='3968'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='3969'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='3970'>
                                its, ite, jts, jte, kts, kte     )<a name='3971'>
<a name='3972'>
<font color=#447700>! History:     Sep 2003  Changes by George Bryan and Jason Knievel, NCAR<a name='3973'></font>
<font color=#447700>!              Oct 2001  Converted to mass core by Bill Skamarock, NCAR<a name='3974'></font>
<font color=#447700>!              Aug 2000  Original code by Shu-Hua Chen, UC-Davis<a name='3975'></font>
<a name='3976'>
<font color=#447700>! Purpose:     This routine calculates stress terms (taus) for use in<a name='3977'></font>
<font color=#447700>!              the calculation of production of TKE by sheared wind<a name='3978'></font>
<a name='3979'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='3980'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='3981'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='3982'></font>
<a name='3983'>
<font color=#447700>! Key:<a name='3984'></font>
<a name='3985'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3986'></font>
<font color=#447700>! Begin declarations.<a name='3987'></font>
<a name='3988'>
    IMPLICIT NONE<a name='3989'>
<a name='3990'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='3991'>
    :: config_flags<a name='3992'>
<a name='3993'>
    INTEGER, INTENT( IN )  &amp;<a name='3994'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='3995'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='3996'>
       its, ite, jts, jte, kts, kte<a name='3997'>
<a name='3998'>
    INTEGER, INTENT( IN )  &amp;<a name='3999'>
    :: is_ext,ie_ext,js_ext,je_ext  <a name='4000'>
<a name='4001'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='4002'>
    :: fnm, fnp<a name='4003'>
<a name='4004'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 ), INTENT( INOUT )  &amp;  <a name='4005'>
    :: titau <a name='4006'>
 <a name='4007'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='4008'>
    :: defor, xkx<a name='4009'>
  <a name='4010'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='4011'>
    ::  mu<a name='4012'>
<a name='4013'>
<font color=#447700>! Local variables.<a name='4014'></font>
<a name='4015'>
    INTEGER  &amp;<a name='4016'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='4017'>
<a name='4018'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 )  &amp;<a name='4019'>
    :: xkxavg <a name='4020'>
                                                                   <a name='4021'>
    REAL, DIMENSION( its-1:ite+1, jts-1:jte+1 )  &amp;<a name='4022'>
    :: muavg<a name='4023'>
<a name='4024'>
<font color=#447700>! End declarations.<a name='4025'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4026'></font>
<a name='4027'>
     ktf = MIN( kte, kde-1 )<a name='4028'>
<a name='4029'>
<font color=#447700>! Find ide-1 and jde-1 for averaging to p point.<a name='4030'></font>
<a name='4031'>
    i_start = its<a name='4032'>
    i_end   = MIN( ite, ide-1 )<a name='4033'>
    j_start = jts<a name='4034'>
    j_end   = jte<a name='4035'>
<a name='4036'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='4037'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='4038'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='4039'>
         config_flags%nested) i_end   = MIN( ide-2, ite )<a name='4040'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='4041'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='4042'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='4043'>
         config_flags%nested) j_end   = MIN( jde-1, jte )<a name='4044'>
<a name='4045'>
    i_start = i_start - is_ext<a name='4046'>
    i_end   = i_end   + ie_ext   <a name='4047'>
    j_start = j_start - js_ext<a name='4048'>
    j_end   = j_end   + je_ext   <a name='4049'>
<a name='4050'>
    DO j = j_start, j_end<a name='4051'>
    DO k = kts+1, ktf<a name='4052'>
    DO i = i_start, i_end<a name='4053'>
      xkxavg(i,k,j) = 0.5 * ( fnm(k) * ( xkx(i,k  ,j) + xkx(i,k  ,j-1) ) +  &amp;<a name='4054'>
                              fnp(k) * ( xkx(i,k-1,j) + xkx(i,k-1,j-1) ) )<a name='4055'>
    END DO<a name='4056'>
    END DO<a name='4057'>
    END DO<a name='4058'>
 <a name='4059'>
    DO j = j_start, j_end<a name='4060'>
    DO i = i_start, i_end<a name='4061'>
      muavg(i,j) = 0.5 * ( mu(i,j) + mu(i,j-1) )<a name='4062'>
    END DO<a name='4063'>
    END DO<a name='4064'>
 <a name='4065'>
    DO j = j_start, j_end<a name='4066'>
    DO k = kts+1, ktf<a name='4067'>
    DO i = i_start, i_end<a name='4068'>
       titau(i,k,j) = - muavg(i,j) * xkxavg(i,k,j) * defor(i,k,j)<a name='4069'>
    END DO<a name='4070'>
    END DO<a name='4071'>
    END DO<a name='4072'>
<a name='4073'>
    DO j = j_start, j_end<a name='4074'>
    DO i = i_start, i_end<a name='4075'>
      titau(i,kts  ,j) = 0.0<a name='4076'>
      titau(i,ktf+1,j) = 0.0<a name='4077'>
    END DO<a name='4078'>
    END DO<a name='4079'>
<a name='4080'>
    END SUBROUTINE cal_titau_23_32<a name='4081'>
<a name='4082'>
<font color=#447700>!=======================================================================<a name='4083'></font>
<font color=#447700>!=======================================================================<a name='4084'></font>
<a name='4085'>
<A NAME='PHY_BC'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4086'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>phy_bc</font> ( config_flags,div,defor11,defor22,defor33,              &amp; <A href='../../call_to/PHY_BC.html' TARGET='index'>3</A>,<A href='../../call_from/PHY_BC.html' TARGET='index'>15</A><a name='4087'>
                    defor12,defor13,defor23,xkmh,xkmhd,xkmv,xkhh,xkhv,tke, &amp;<a name='4088'>
                    RUBLTEN, RVBLTEN,                                      &amp;<a name='4089'>
                    ids, ide, jds, jde, kds, kde,                          &amp;<a name='4090'>
                    ims, ime, jms, jme, kms, kme,                          &amp;<a name='4091'>
                    ips, ipe, jps, jpe, kps, kpe,                          &amp;<a name='4092'>
                    its, ite, jts, jte, kts, kte                           )<a name='4093'>
<a name='4094'>
<font color=#447700>!------------------------------------------------------------------------------<a name='4095'></font>
<font color=#447700>! Begin declarations.<a name='4096'></font>
<a name='4097'>
   IMPLICIT NONE<a name='4098'>
<a name='4099'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='4100'>
<a name='4101'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='4102'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='4103'>
                                            ips, ipe, jps, jpe, kps, kpe, &amp;<a name='4104'>
                                            its, ite, jts, jte, kts, kte<a name='4105'>
<a name='4106'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::RUBLTEN, &amp;<a name='4107'>
                                                                 RVBLTEN, &amp;<a name='4108'>
                                                                 defor11, &amp;<a name='4109'>
                                                                 defor22, &amp;<a name='4110'>
                                                                 defor33, &amp;<a name='4111'>
                                                                 defor12, &amp;<a name='4112'>
                                                                 defor13, &amp;<a name='4113'>
                                                                 defor23, &amp;<a name='4114'>
                                                                    xkmh, &amp;<a name='4115'>
                                                                   xkmhd, &amp;<a name='4116'>
                                                                    xkmv, &amp;<a name='4117'>
                                                                    xkhh, &amp;<a name='4118'>
                                                                    xkhv, &amp;<a name='4119'>
                                                                     tke, &amp;<a name='4120'>
                                                                     div<a name='4121'>
<a name='4122'>
<font color=#447700>! End declarations.<a name='4123'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4124'></font>
<a name='4125'>
   IF(config_flags%bl_pbl_physics .GT. 0) THEN<a name='4126'>
<a name='4127'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_55">( RUBLTEN , 't', config_flags,              &amp;<a name='4128'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4129'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4130'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4131'>
                                its, ite, jts, jte, kts, kte              )<a name='4132'>
<a name='4133'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_56">( RVBLTEN , 't', config_flags,              &amp;<a name='4134'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4135'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4136'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4137'>
                                its, ite, jts, jte, kts, kte              )<a name='4138'>
<a name='4139'>
   ENDIF<a name='4140'>
<a name='4141'>
   IF(config_flags%diff_opt .eq. 2) THEN<a name='4142'>
<a name='4143'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_57">( xkmh    , 't', config_flags,                   &amp;<a name='4144'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4145'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4146'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4147'>
                                its, ite, jts, jte, kts, kte              )<a name='4148'>
<a name='4149'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_58">( xkmhd   , 't', config_flags,                   &amp;<a name='4150'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4151'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4152'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4153'>
                                its, ite, jts, jte, kts, kte              )<a name='4154'>
<a name='4155'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_59">( xkmv    , 't', config_flags,                   &amp;<a name='4156'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4157'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4158'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4159'>
                                its, ite, jts, jte, kts, kte              )<a name='4160'>
<a name='4161'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_60">( xkhh    , 't', config_flags,                   &amp;<a name='4162'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4163'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4164'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4165'>
                                its, ite, jts, jte, kts, kte              )<a name='4166'>
<a name='4167'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_61">( xkhv    , 't', config_flags,                   &amp;<a name='4168'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4169'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4170'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4171'>
                                its, ite, jts, jte, kts, kte              )<a name='4172'>
<a name='4173'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_62">( tke     , 't', config_flags,                   &amp;<a name='4174'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4175'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4176'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4177'>
                                its, ite, jts, jte, kts, kte              )<a name='4178'>
<a name='4179'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_63">( div     , 't', config_flags,                   &amp;<a name='4180'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4181'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4182'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4183'>
                                its, ite, jts, jte, kts, kte              )<a name='4184'>
<a name='4185'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_64">( defor11 , 't', config_flags,                   &amp;<a name='4186'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4187'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4188'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4189'>
                                its, ite, jts, jte, kts, kte              )<a name='4190'>
<a name='4191'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_65">( defor22 , 't', config_flags,                   &amp;<a name='4192'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4193'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4194'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4195'>
                                its, ite, jts, jte, kts, kte              )<a name='4196'>
<a name='4197'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_66">( defor33 , 't', config_flags,                   &amp;<a name='4198'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4199'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4200'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4201'>
                                its, ite, jts, jte, kts, kte              )<a name='4202'>
<a name='4203'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_67">( defor12 , 'd', config_flags,                   &amp;<a name='4204'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4205'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4206'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4207'>
                                its, ite, jts, jte, kts, kte              )<a name='4208'>
<a name='4209'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_68">( defor13 , 'e', config_flags,                   &amp;<a name='4210'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4211'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4212'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4213'>
                                its, ite, jts, jte, kts, kte              )<a name='4214'>
<a name='4215'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_69">( defor23 , 'f', config_flags,                   &amp;<a name='4216'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4217'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4218'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4219'>
                                its, ite, jts, jte, kts, kte              )<a name='4220'>
<a name='4221'>
   ENDIF<a name='4222'>
<a name='4223'>
END SUBROUTINE phy_bc <a name='4224'>
<a name='4225'>
<font color=#447700>!=======================================================================<a name='4226'></font>
<font color=#447700>!=======================================================================<a name='4227'></font>
<a name='4228'>
<A NAME='TKE_RHS'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_RHS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4229'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>tke_rhs</font>( tendency, BN2, config_flags,            &amp; <A href='../../call_to/TKE_RHS.html' TARGET='index'>3</A>,<A href='../../call_from/TKE_RHS.html' TARGET='index'>3</A><a name='4230'>
                        defor11, defor22, defor33,              &amp;<a name='4231'>
                        defor12, defor13, defor23,              &amp;<a name='4232'>
                        u, v, w, div, tke, mu,                  &amp;<a name='4233'>
                        theta, p, p8w, t8w, z, fnm, fnp,        &amp;<a name='4234'>
                        cf1, cf2, cf3, msft, xkmh, xkmv, xkhv,  &amp;<a name='4235'>
                        rdx, rdy, dx, dy, dt, zx, zy,           &amp;<a name='4236'>
                        rdz, rdzw, dn, dnw, cr_len,             &amp;<a name='4237'>
                        ids, ide, jds, jde, kds, kde,           &amp;<a name='4238'>
                        ims, ime, jms, jme, kms, kme,           &amp;<a name='4239'>
                        its, ite, jts, jte, kts, kte            )<a name='4240'>
<a name='4241'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4242'></font>
<font color=#447700>! Begin declarations.<a name='4243'></font>
<a name='4244'>
    IMPLICIT NONE<a name='4245'>
<a name='4246'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='4247'>
    :: config_flags<a name='4248'>
<a name='4249'>
    INTEGER, INTENT( IN )  &amp;<a name='4250'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='4251'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='4252'>
       its, ite, jts, jte, kts, kte<a name='4253'>
<a name='4254'>
    REAL, INTENT( IN )  &amp;<a name='4255'>
    :: cf1, cf2, cf3, dt, rdx, rdy, dx, dy, cr_len<a name='4256'>
<a name='4257'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='4258'>
    :: fnm, fnp, dnw, dn<a name='4259'>
<a name='4260'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='4261'>
    :: msft<a name='4262'>
<a name='4263'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='4264'>
    :: tendency<a name='4265'>
<a name='4266'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='4267'>
    :: defor11, defor22, defor33, defor12, defor13, defor23,  &amp;<a name='4268'>
       div, BN2, tke, xkmh, xkmv, xkhv, zx, zy, u, v, w, theta,  &amp;<a name='4269'>
       p, p8w, t8w, z, rdz, rdzw<a name='4270'>
<a name='4271'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='4272'>
    :: mu<a name='4273'>
<a name='4274'>
<font color=#447700>! Local variables.<a name='4275'></font>
<a name='4276'>
    INTEGER  &amp;<a name='4277'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='4278'>
<a name='4279'>
<font color=#447700>! End declarations.<a name='4280'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4281'></font>
<a name='4282'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_SHEAR'>tke_shear</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_RHS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TKE_SHEAR_1">(    tendency, config_flags,                &amp;<a name='4283'>
                       defor11, defor22, defor33,             &amp;<a name='4284'>
                       defor12, defor13, defor23,             &amp;<a name='4285'>
                       u, v, w, tke, mu, fnm, fnp,            &amp;<a name='4286'>
                       cf1, cf2, cf3, msft, xkmh, xkmv,       &amp;<a name='4287'>
                       rdx, rdy, zx, zy, rdz, rdzw, dnw, dn,  &amp;<a name='4288'>
                       ids, ide, jds, jde, kds, kde,          &amp;<a name='4289'>
                       ims, ime, jms, jme, kms, kme,          &amp;<a name='4290'>
                       its, ite, jts, jte, kts, kte           )<a name='4291'>
<a name='4292'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_BUOYANCY'>tke_buoyancy</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_RHS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TKE_BUOYANCY_1">( tendency, config_flags, mu,            &amp;<a name='4293'>
                       tke, xkhv, BN2, dt,                    &amp;<a name='4294'>
                       ids, ide, jds, jde, kds, kde,          &amp;<a name='4295'>
                       ims, ime, jms, jme, kms, kme,          &amp;<a name='4296'>
                       its, ite, jts, jte, kts, kte           )<a name='4297'>
<a name='4298'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_DISSIP'>tke_dissip</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_RHS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TKE_DISSIP_1">(   tendency, config_flags,                &amp;<a name='4299'>
                       mu, tke, bn2, theta, p8w, t8w, z,      &amp;<a name='4300'>
                       dx, dy,rdz, rdzw, cr_len,              &amp;<a name='4301'>
                       ids, ide, jds, jde, kds, kde,          &amp;<a name='4302'>
                       ims, ime, jms, jme, kms, kme,          &amp;<a name='4303'>
                       its, ite, jts, jte, kts, kte           )<a name='4304'>
<a name='4305'>
<font color=#447700>! Set a lower limit on TKE.<a name='4306'></font>
<a name='4307'>
    ktf     = MIN( kte, kde-1 )<a name='4308'>
    i_start = its<a name='4309'>
    i_end   = MIN( ite, ide-1 )<a name='4310'>
    j_start = jts<a name='4311'>
    j_end   = MIN( jte, jde-1 )<a name='4312'>
<a name='4313'>
    IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='4314'>
         config_flags%nested) i_start = MAX(ids+1,its)<a name='4315'>
    IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='4316'>
         config_flags%nested) i_end   = MIN(ide-2,ite)<a name='4317'>
    IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='4318'>
         config_flags%nested) j_start = MAX(jds+1,jts)<a name='4319'>
    IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='4320'>
         config_flags%nested) j_end   = MIN(jde-2,jte)<a name='4321'>
 <a name='4322'>
    DO j = j_start, j_end<a name='4323'>
    DO k = kts, ktf<a name='4324'>
    DO i = i_start, i_end<a name='4325'>
      tendency(i,k,j) = max( tendency(i,k,j), -mu(i,j) * max( 0.0 , tke(i,k,j) ) / dt )<a name='4326'>
    END DO<a name='4327'>
    END DO<a name='4328'>
    END DO<a name='4329'>
<a name='4330'>
    END SUBROUTINE tke_rhs<a name='4331'>
<a name='4332'>
<font color=#447700>!=======================================================================<a name='4333'></font>
<font color=#447700>!=======================================================================<a name='4334'></font>
<a name='4335'>
<A NAME='TKE_BUOYANCY'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_BUOYANCY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4336'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>tke_buoyancy</font>( tendency, config_flags, mu,    &amp; <A href='../../call_to/TKE_BUOYANCY.html' TARGET='index'>1</A><a name='4337'>
                             tke, xkhv, BN2, dt,            &amp;<a name='4338'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='4339'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='4340'>
                             its, ite, jts, jte, kts, kte   )<a name='4341'>
<a name='4342'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4343'></font>
<font color=#447700>! Begin declarations.<a name='4344'></font>
<a name='4345'>
    IMPLICIT NONE<a name='4346'>
<a name='4347'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='4348'>
    :: config_flags<a name='4349'>
<a name='4350'>
    INTEGER, INTENT( IN )  &amp;<a name='4351'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='4352'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='4353'>
       its, ite, jts, jte, kts, kte<a name='4354'>
<a name='4355'>
    REAL, INTENT( IN )  &amp;<a name='4356'>
    :: dt<a name='4357'>
<a name='4358'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='4359'>
    :: tendency<a name='4360'>
<a name='4361'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='4362'>
    :: xkhv, tke, BN2   <a name='4363'>
<a name='4364'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='4365'>
    :: mu<a name='4366'>
<a name='4367'>
<font color=#447700>! Local variables.<a name='4368'></font>
<a name='4369'>
    INTEGER  &amp;<a name='4370'>
    :: i, j, k, ktf<a name='4371'>
<a name='4372'>
    INTEGER  &amp;<a name='4373'>
    :: i_start, i_end, j_start, j_end<a name='4374'>
<a name='4375'>
    REAL :: heat_flux<a name='4376'>
<a name='4377'>
<font color=#447700>! End declarations.<a name='4378'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4379'></font>
<a name='4380'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4381'></font>
<font color=#447700>! Add to the TKE tendency the term that accounts for production of TKE<a name='4382'></font>
<font color=#447700>! due to buoyant motions.<a name='4383'></font>
<a name='4384'>
    ktf     = MIN( kte, kde-1 )<a name='4385'>
    i_start = its<a name='4386'>
    i_end   = MIN( ite, ide-1 )<a name='4387'>
    j_start = jts<a name='4388'>
    j_end   = MIN( jte, jde-1 )<a name='4389'>
<a name='4390'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='4391'>
         config_flags%nested ) i_start = MAX( ids+1, its )<a name='4392'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='4393'>
         config_flags%nested ) i_end   = MIN( ide-2, ite )<a name='4394'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='4395'>
         config_flags%nested ) j_start = MAX( jds+1, jts )<a name='4396'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='4397'>
         config_flags%nested ) j_end   = MIN( jde-2, jte )<a name='4398'>
 <a name='4399'>
    DO j = j_start, j_end<a name='4400'>
    DO k = kts+1, ktf<a name='4401'>
    DO i = i_start, i_end<a name='4402'>
      tendency(i,k,j) = tendency(i,k,j) - mu(i,j) * xkhv(i,k,j) * BN2(i,k,j)<a name='4403'>
    END DO<a name='4404'>
    END DO<a name='4405'>
    END DO<a name='4406'>
<a name='4407'>
<font color=#447700>! MARTA: change in the computation of the tke's tendency  at the surface.<a name='4408'></font>
<font color=#447700>!  the buoyancy flux is the average of the surface heat flux (0.06) and the<a name='4409'></font>
<font color=#447700>!   flux at the first w level<a name='4410'></font>
<font color=#447700>!<a name='4411'></font>
<font color=#447700>! WCS 040331<a name='4412'></font>
<a name='4413'>
   heat_flux = config_flags%tke_heat_flux  <font color=#447700>! constant heat flux value<a name='4414'></font>
                                           <font color=#447700>! set in namelist.input<a name='4415'></font>
 IF(abs(heat_flux).lt.1.0e-6)THEN<a name='4416'>
   K=KTS<a name='4417'>
   DO j = j_start, j_end<a name='4418'>
   DO i = i_start, i_end<a name='4419'>
      tendency(i,k,j)= tendency(i,k,j) - &amp;<a name='4420'>
                   mu(i,j)*xkhv(i,k,j)*BN2(i,k,j)<a name='4421'>
   ENDDO<a name='4422'>
   ENDDO   <a name='4423'>
 ELSE<a name='4424'>
   K=KTS<a name='4425'>
   DO j = j_start, j_end<a name='4426'>
   DO i = i_start, i_end<a name='4427'>
      tendency(i,k,j)= tendency(i,k,j) - &amp;<a name='4428'>
<a name='4429'>
                   mu(i,j)*((xkhv(i,k,j)*BN2(i,k,j))- heat_flux)/2.<a name='4430'>
<a name='4431'>
   ENDDO<a name='4432'>
   ENDDO   <a name='4433'>
 ENDIF<a name='4434'>
<font color=#447700>! end of MARTA/WCS change<a name='4435'></font>
<a name='4436'>
<font color=#447700>! The tendency array now includes production of TKE from buoyant<a name='4437'></font>
<font color=#447700>! motions.<a name='4438'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4439'></font>
<a name='4440'>
    END SUBROUTINE tke_buoyancy<a name='4441'>
<a name='4442'>
<font color=#447700>!=======================================================================<a name='4443'></font>
<font color=#447700>!=======================================================================<a name='4444'></font>
<a name='4445'>
<A NAME='TKE_DISSIP'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_DISSIP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4446'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>tke_dissip</font>( tendency, config_flags,            &amp; <A href='../../call_to/TKE_DISSIP.html' TARGET='index'>1</A>,<A href='../../call_from/TKE_DISSIP.html' TARGET='index'>1</A><a name='4447'>
                           mu, tke, bn2, theta, p8w, t8w, z,  &amp;<a name='4448'>
                           dx, dy, rdz, rdzw, cr_len_in,      &amp;<a name='4449'>
                           ids, ide, jds, jde, kds, kde,      &amp;<a name='4450'>
                           ims, ime, jms, jme, kms, kme,      &amp;<a name='4451'>
                           its, ite, jts, jte, kts, kte       )<a name='4452'>
<a name='4453'>
<font color=#447700>! History:     Sep 2003  Changes by George Bryan and Jason Knievel, NCAR<a name='4454'></font>
<font color=#447700>!              Oct 2001  Converted to mass core by Bill Skamarock, NCAR<a name='4455'></font>
<font color=#447700>!              Aug 2000  Original code by Shu-Hua Chen, UC-Davis<a name='4456'></font>
<a name='4457'>
<font color=#447700>! Purpose:     This routine calculates dissipation of turbulent kinetic<a name='4458'></font>
<font color=#447700>!              energy.<a name='4459'></font>
<a name='4460'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='4461'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='4462'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='4463'></font>
<a name='4464'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4465'></font>
<font color=#447700>! Begin declarations.<a name='4466'></font>
<a name='4467'>
    IMPLICIT NONE<a name='4468'>
<a name='4469'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='4470'>
    :: config_flags<a name='4471'>
<a name='4472'>
    INTEGER, INTENT( IN )  &amp;<a name='4473'>
    ::  ids, ide, jds, jde, kds, kde,  &amp;<a name='4474'>
        ims, ime, jms, jme, kms, kme,  &amp;<a name='4475'>
        its, ite, jts, jte, kts, kte<a name='4476'>
<a name='4477'>
    REAL, INTENT( IN )  &amp;<a name='4478'>
    :: dx, dy, cr_len_in<a name='4479'>
 <a name='4480'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='4481'>
    :: tendency<a name='4482'>
 <a name='4483'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='4484'>
    :: tke, bn2, theta, p8w, t8w, z, rdz, rdzw<a name='4485'>
<a name='4486'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='4487'>
    :: mu<a name='4488'>
<a name='4489'>
<font color=#447700>! Local variables.<a name='4490'></font>
<a name='4491'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='4492'>
    :: dthrdn<a name='4493'>
<a name='4494'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='4495'>
    :: l_scale<a name='4496'>
<a name='4497'>
    REAL, DIMENSION( its:ite )  &amp; <a name='4498'>
    :: sumtke,  sumtkez<a name='4499'>
<a name='4500'>
    INTEGER  &amp;<a name='4501'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='4502'>
<a name='4503'>
    REAL  &amp;<a name='4504'>
    :: disp_len, deltas, coefc, tmpdz, len_s, thetasfc,  &amp;<a name='4505'>
       thetatop, len_0, tketmp, tmp, cr_len, ce1, ce2<a name='4506'>
<a name='4507'>
<font color=#447700>! End declarations.<a name='4508'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4509'></font>
<a name='4510'>
    ce1 = ( c_k / 0.10 ) * 0.19<a name='4511'>
    ce2 = max( 0.0 , 0.93 - ce1 )<a name='4512'>
<a name='4513'>
    ktf     = MIN( kte, kde-1 )<a name='4514'>
    i_start = its<a name='4515'>
    i_end   = MIN(ite,ide-1)<a name='4516'>
    j_start = jts<a name='4517'>
    j_end   = MIN(jte,jde-1)<a name='4518'>
<a name='4519'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='4520'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='4521'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='4522'>
         config_flags%nested) i_end   = MIN( ide-2, ite )<a name='4523'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='4524'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='4525'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='4526'>
         config_flags%nested) j_end   = MIN( jde-2, jte )<a name='4527'>
<a name='4528'>
    cr_len = cr_len_in<a name='4529'>
    cr_len = dx + 1.0 <font color=#447700>!  hardwire for mixing length = (dx*dy*dz)**(1/3).<a name='4530'></font>
                      <font color=#447700>!  remove this for the alternate formulation<a name='4531'></font>
<a name='4532'>
    IF (dx .gt. cr_len) THEN<a name='4533'>
<a name='4534'>
      DO j = j_start, j_end<a name='4535'>
        DO i = i_start, i_end<a name='4536'>
          sumtke(i)  = 0.0<a name='4537'>
          sumtkez(i) = 0.0<a name='4538'>
        END DO<a name='4539'>
        DO k = kts, ktf<a name='4540'>
        DO i = i_start, i_end<a name='4541'>
          tketmp     = MAX( tke(i,k,j), 0.0 )<a name='4542'>
          sumtke(i)  = sumtke(i) + SQRT(tketmp) / rdzw(i,k,j)<a name='4543'>
          sumtkez(i) = sumtkez(i)+ sumtke(i) * z(i,k,j)<a name='4544'>
          IF ( ABS( sumtke(i) ) .gt. 0.01 ) THEN<a name='4545'>
            len_0 = 0.2 * sumtkez(i) / sumtke(i)<a name='4546'>
          ELSE<a name='4547'>
            len_0 = 80.0<a name='4548'>
          ENDIF<a name='4549'>
          len_0 = MIN( 80.0, len_0)<a name='4550'>
          l_scale(i,k,j)  = KARMAN * z(i,k,j) /  &amp;<a name='4551'>
                            ( 1.0 + KARMAN * z(i,k,j) / len_0 )<a name='4552'>
          tendency(i,k,j) = tendency(i,k,j) -                     &amp;<a name='4553'>
                            mu(i,j) * 2.0 * SQRT( 2.0 ) / 15.0 *  &amp;<a name='4554'>
                            tketmp**1.5 / l_scale(i,k,j)<a name='4555'>
        END DO<a name='4556'>
        END DO<a name='4557'>
      END DO<a name='4558'>
    ELSE<a name='4559'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALC_L_SCALE'>calc_l_scale</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_DISSIP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_L_SCALE_2">( config_flags, tke, BN2, l_scale,      &amp;<a name='4560'>
                         i_start, i_end, ktf, j_start, j_end,  &amp;<a name='4561'>
                         dx, dy, rdzw,                         &amp;<a name='4562'>
                         ids, ide, jds, jde, kds, kde,         &amp;<a name='4563'>
                         ims, ime, jms, jme, kms, kme,         &amp;<a name='4564'>
                         its, ite, jts, jte, kts, kte          )<a name='4565'>
      DO j = j_start, j_end<a name='4566'>
      DO k = kts, ktf<a name='4567'>
      DO i = i_start, i_end<a name='4568'>
        deltas  = ( dx * dy / rdzw(i,k,j) )**0.33333333<a name='4569'>
        tketmp  = MAX( tke(i,k,j), 1.0e-6 )<a name='4570'>
<a name='4571'>
<font color=#447700>! Apply Deardorff's (1980) "wall effect" at the bottom of the domain. <a name='4572'></font>
<a name='4573'>
        IF ( k .eq. kts .or. k .eq. ktf ) then<a name='4574'>
          coefc = 3.9<a name='4575'>
        ELSE<a name='4576'>
          coefc = ce1 + ce2 * l_scale(i,k,j) / deltas<a name='4577'>
        END IF<a name='4578'>
<a name='4579'>
        tendency(i,k,j) = tendency(i,k,j) - &amp;<a name='4580'>
                          mu(i,j) * coefc * tketmp**1.5 / l_scale(i,k,j)<a name='4581'>
      END DO<a name='4582'>
      END DO<a name='4583'>
      END DO<a name='4584'>
    ENDIF<a name='4585'>
<a name='4586'>
    END SUBROUTINE tke_dissip<a name='4587'>
<a name='4588'>
<font color=#447700>!=======================================================================<a name='4589'></font>
<font color=#447700>!=======================================================================<a name='4590'></font>
<a name='4591'>
<A NAME='TKE_SHEAR'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_SHEAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4592'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>tke_shear</font>( tendency, config_flags,                &amp; <A href='../../call_to/TKE_SHEAR.html' TARGET='index'>1</A><a name='4593'>
                          defor11, defor22, defor33,             &amp;<a name='4594'>
                          defor12, defor13, defor23,             &amp;<a name='4595'>
                          u, v, w, tke, mu, fnm, fnp,            &amp;<a name='4596'>
                          cf1, cf2, cf3, msft, xkmh, xkmv,       &amp;<a name='4597'>
                          rdx, rdy, zx, zy, rdz, rdzw, dn, dnw,  &amp;<a name='4598'>
                          ids, ide, jds, jde, kds, kde,          &amp;<a name='4599'>
                          ims, ime, jms, jme, kms, kme,          &amp;<a name='4600'>
                          its, ite, jts, jte, kts, kte           )<a name='4601'>
<a name='4602'>
<font color=#447700>! History:     Sep 2003   Rewritten by George Bryan and Jason Knievel,<a name='4603'></font>
<font color=#447700>!                         NCAR<a name='4604'></font>
<font color=#447700>!              Oct 2001   Converted to mass core by Bill Skamarock, NCAR<a name='4605'></font>
<font color=#447700>!              Aug 2000   Original code by Shu-Hua Chen, UC-Davis<a name='4606'></font>
<a name='4607'>
<font color=#447700>! Purpose:     This routine calculates the production of turbulent<a name='4608'></font>
<font color=#447700>!              kinetic energy by stresses due to sheared wind.<a name='4609'></font>
<a name='4610'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='4611'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980) <a name='4612'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='4613'></font>
<a name='4614'>
<font color=#447700>! Key:<a name='4615'></font>
<a name='4616'>
<font color=#447700>! avg          temporary working array<a name='4617'></font>
<font color=#447700>! cf1          <a name='4618'></font>
<font color=#447700>! cf2         <a name='4619'></font>
<font color=#447700>! cf3<a name='4620'></font>
<font color=#447700>! defor11      deformation term ( du/dx + du/dx )<a name='4621'></font>
<font color=#447700>! defor12      deformation term ( dv/dx + du/dy ); same as defor21<a name='4622'></font>
<font color=#447700>! defor13      deformation term ( dw/dx + du/dz ); same as defor31<a name='4623'></font>
<font color=#447700>! defor22      deformation term ( dv/dy + dv/dy )<a name='4624'></font>
<font color=#447700>! defor23      deformation term ( dw/dy + dv/dz ); same as defor32<a name='4625'></font>
<font color=#447700>! defor33      deformation term ( dw/dz + dw/dz )<a name='4626'></font>
<font color=#447700>! div          3-d divergence<a name='4627'></font>
<font color=#447700>! dn<a name='4628'></font>
<font color=#447700>! dnw<a name='4629'></font>
<font color=#447700>! fnm<a name='4630'></font>
<font color=#447700>! fnp<a name='4631'></font>
<font color=#447700>! msft<a name='4632'></font>
<font color=#447700>! rdx<a name='4633'></font>
<font color=#447700>! rdy<a name='4634'></font>
<font color=#447700>! tendency<a name='4635'></font>
<font color=#447700>! titau        tau (stress tensor) with a tilde, indicating division by<a name='4636'></font>
<font color=#447700>!              a map-scale factor and the fraction of the total modeled<a name='4637'></font>
<font color=#447700>!              atmosphere beneath a given altitude (titau = tau/m/zeta)<a name='4638'></font>
<font color=#447700>! tke          turbulent kinetic energy<a name='4639'></font>
<a name='4640'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4641'></font>
<font color=#447700>! Begin declarations.<a name='4642'></font>
<a name='4643'>
    IMPLICIT NONE<a name='4644'>
<a name='4645'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='4646'>
    :: config_flags<a name='4647'>
<a name='4648'>
    INTEGER, INTENT( IN )  &amp;<a name='4649'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='4650'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='4651'>
       its, ite, jts, jte, kts, kte<a name='4652'>
<a name='4653'>
    REAL, INTENT( IN )  &amp;<a name='4654'>
    :: cf1, cf2, cf3, rdx, rdy<a name='4655'>
<a name='4656'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='4657'>
    :: fnm, fnp, dn, dnw<a name='4658'>
<a name='4659'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='4660'>
    :: msft<a name='4661'>
<a name='4662'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='4663'>
    :: tendency<a name='4664'>
<a name='4665'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;  <a name='4666'>
    :: defor11, defor22, defor33, defor12, defor13, defor23,    &amp;<a name='4667'>
       tke, xkmh, xkmv, zx, zy, u, v, w, rdz, rdzw<a name='4668'>
<a name='4669'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='4670'>
    :: mu<a name='4671'>
<a name='4672'>
<font color=#447700>! Local variables.<a name='4673'></font>
<a name='4674'>
    INTEGER  &amp;<a name='4675'>
    :: i, j, k, ktf, ktes1, ktes2,      &amp;<a name='4676'>
       i_start, i_end, j_start, j_end,  &amp;<a name='4677'>
       is_ext, ie_ext, js_ext, je_ext   <a name='4678'>
<a name='4679'>
    REAL  &amp;<a name='4680'>
    :: mtau<a name='4681'>
<a name='4682'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 )  &amp;<a name='4683'>
    :: avg, titau, tmp2<a name='4684'>
<a name='4685'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='4686'>
    :: titau12, tmp1, zxavg, zyavg<a name='4687'>
<a name='4688'>
    REAL :: absU, cd0<a name='4689'>
<a name='4690'>
<font color=#447700>! End declarations.<a name='4691'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4692'></font>
<a name='4693'>
    ktf    = MIN( kte, kde-1 )<a name='4694'>
    ktes1  = kte-1<a name='4695'>
    ktes2  = kte-2<a name='4696'>
   <a name='4697'>
    i_start = its<a name='4698'>
    i_end   = MIN( ite, ide-1 )<a name='4699'>
    j_start = jts<a name='4700'>
    j_end   = MIN( jte, jde-1 )<a name='4701'>
<a name='4702'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='4703'>
         config_flags%nested ) i_start = MAX( ids+1, its )<a name='4704'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='4705'>
         config_flags%nested ) i_end   = MIN( ide-2, ite )<a name='4706'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='4707'>
         config_flags%nested ) j_start = MAX( jds+1, jts )<a name='4708'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='4709'>
         config_flags%nested ) j_end   = MIN( jde-2, jte )<a name='4710'>
<a name='4711'>
    DO j = j_start, j_end<a name='4712'>
    DO k = kts, ktf<a name='4713'>
    DO i = i_start, i_end<a name='4714'>
      zxavg(i,k,j) = 0.25 * ( zx(i,k  ,j) + zx(i+1,k  ,j) + &amp;<a name='4715'>
                              zx(i,k+1,j) + zx(i+1,k+1,j)  )<a name='4716'>
      zyavg(i,k,j) = 0.25 * ( zy(i,k  ,j) + zy(i,k  ,j+1) + &amp;<a name='4717'>
                              zy(i,k+1,j) + zy(i,k+1,j+1)  )<a name='4718'>
    END DO<a name='4719'>
    END DO<a name='4720'>
    END DO<a name='4721'>
<a name='4722'>
<font color=#447700>! Begin calculating production of turbulence due to shear.  The approach<a name='4723'></font>
<font color=#447700>! is to add together contributions from six terms, each of which is the<a name='4724'></font>
<font color=#447700>! square of a deformation that is then multiplied by an exchange<a name='4725'></font>
<font color=#447700>! coefficiant.  The same exchange coefficient is assumed for horizontal<a name='4726'></font>
<font color=#447700>! and vertical coefficients for some of the terms (the vertical value is<a name='4727'></font>
<font color=#447700>! the one used). <a name='4728'></font>
<a name='4729'>
<font color=#447700>! For defor11.<a name='4730'></font>
<a name='4731'>
    DO j = j_start, j_end<a name='4732'>
    DO k = kts, ktf<a name='4733'>
    DO i = i_start, i_end<a name='4734'>
      tendency(i,k,j) = tendency(i,k,j) + 0.5 *  &amp;<a name='4735'>
                        mu(i,j) * xkmh(i,k,j) * ( ( defor11(i,k,j) )**2 )<a name='4736'>
    END DO<a name='4737'>
    END DO<a name='4738'>
    END DO<a name='4739'>
<a name='4740'>
<font color=#447700>! For defor22.<a name='4741'></font>
<a name='4742'>
    DO j = j_start, j_end <a name='4743'>
    DO k = kts, ktf<a name='4744'>
    DO i = i_start, i_end<a name='4745'>
      tendency(i,k,j) = tendency(i,k,j) + 0.5 *  &amp;<a name='4746'>
                        mu(i,j) * xkmh(i,k,j) * ( ( defor22(i,k,j) )**2 )<a name='4747'>
    END DO<a name='4748'>
    END DO<a name='4749'>
    END DO<a name='4750'>
<a name='4751'>
<font color=#447700>! For defor33.<a name='4752'></font>
<a name='4753'>
    DO j = j_start, j_end <a name='4754'>
    DO k = kts, ktf<a name='4755'>
    DO i = i_start, i_end<a name='4756'>
      tendency(i,k,j) = tendency(i,k,j) + 0.5 *  &amp;<a name='4757'>
                        mu(i,j) * xkmv(i,k,j) * ( ( defor33(i,k,j) )**2 )<a name='4758'>
    END DO<a name='4759'>
    END DO<a name='4760'>
    END DO<a name='4761'>
<a name='4762'>
<font color=#447700>! For defor12.<a name='4763'></font>
<a name='4764'>
    DO j = j_start, j_end<a name='4765'>
    DO k = kts, ktf<a name='4766'>
    DO i = i_start, i_end<a name='4767'>
      avg(i,k,j) = 0.25 *  &amp;<a name='4768'>
                   ( ( defor12(i  ,k,j)**2 ) + ( defor12(i  ,k,j+1)**2 ) +  &amp;<a name='4769'>
                     ( defor12(i+1,k,j)**2 ) + ( defor12(i+1,k,j+1)**2 ) )<a name='4770'>
    END DO<a name='4771'>
    END DO<a name='4772'>
    END DO<a name='4773'>
<a name='4774'>
    DO j = j_start, j_end<a name='4775'>
    DO k = kts, ktf<a name='4776'>
    DO i = i_start, i_end<a name='4777'>
      tendency(i,k,j) = tendency(i,k,j) + mu(i,j) * xkmh(i,k,j) * avg(i,k,j)<a name='4778'>
    END DO<a name='4779'>
    END DO<a name='4780'>
    END DO<a name='4781'>
<a name='4782'>
<font color=#447700>! For defor13.<a name='4783'></font>
<a name='4784'>
    DO j = j_start, j_end<a name='4785'>
    DO k = kts+1, ktf<a name='4786'>
    DO i = i_start, i_end+1<a name='4787'>
      tmp2(i,k,j) = defor13(i,k,j)<a name='4788'>
    END DO<a name='4789'>
    END DO<a name='4790'>
    END DO<a name='4791'>
<a name='4792'>
    DO j = j_start, j_end<a name='4793'>
    DO i = i_start, i_end+1<a name='4794'>
      tmp2(i,kts  ,j) = 0.0<a name='4795'>
      tmp2(i,ktf+1,j) = 0.0<a name='4796'>
    END DO<a name='4797'>
    END DO<a name='4798'>
<a name='4799'>
    DO j = j_start, j_end<a name='4800'>
    DO k = kts, ktf<a name='4801'>
    DO i = i_start, i_end<a name='4802'>
      avg(i,k,j) = 0.25 *  &amp;<a name='4803'>
                   ( ( tmp2(i  ,k+1,j)**2 ) + ( tmp2(i  ,k,j)**2 ) +  &amp;<a name='4804'>
                     ( tmp2(i+1,k+1,j)**2 ) + ( tmp2(i+1,k,j)**2 ) )<a name='4805'>
    END DO<a name='4806'>
    END DO<a name='4807'>
    END DO<a name='4808'>
<a name='4809'>
    DO j = j_start, j_end<a name='4810'>
    DO k = kts, ktf<a name='4811'>
    DO i = i_start, i_end<a name='4812'>
      tendency(i,k,j) = tendency(i,k,j) + mu(i,j) * xkmv(i,k,j) * avg(i,k,j)<a name='4813'>
    END DO<a name='4814'>
    END DO<a name='4815'>
    END DO<a name='4816'>
<a name='4817'>
<font color=#447700>!MARTA: add the drug at the surface; WCS 040331<a name='4818'></font>
    K=KTS<a name='4819'>
<a name='4820'>
    cd0 = config_flags%tke_drag_coefficient  <font color=#447700>! drag coefficient set <a name='4821'></font>
                                             <font color=#447700>! in namelist.input<a name='4822'></font>
    DO j = j_start, j_end   <a name='4823'>
    DO i = i_start, i_end<a name='4824'>
<a name='4825'>
      absU=0.5*sqrt((u(i,k,j)+u(i+1,k,j))**2+(v(i,k,j)+v(i,k,j+1))**2)<a name='4826'>
<a name='4827'>
      tendency(i,k,j) = tendency(i,k,j) +       &amp;<a name='4828'>
           mu(i,j)*( (u(i,k,j)+u(i+1,k,j))*0.5* &amp;<a name='4829'>
                     cd0*absU*defor13(i,kts+1,j))<a name='4830'>
<a name='4831'>
    END DO<a name='4832'>
    END DO<a name='4833'>
<font color=#447700>! end of MARTA/WCS change<a name='4834'></font>
<a name='4835'>
<font color=#447700>! For defor23.<a name='4836'></font>
<a name='4837'>
    DO j = j_start, j_end+1<a name='4838'>
    DO k = kts+1, ktf<a name='4839'>
    DO i = i_start, i_end<a name='4840'>
      tmp2(i,k,j) = defor23(i,k,j)<a name='4841'>
    END DO<a name='4842'>
    END DO<a name='4843'>
    END DO<a name='4844'>
<a name='4845'>
    DO j = j_start, j_end+1<a name='4846'>
    DO i = i_start, i_end<a name='4847'>
      tmp2(i,kts,  j) = 0.0<a name='4848'>
      tmp2(i,ktf+1,j) = 0.0<a name='4849'>
    END DO<a name='4850'>
    END DO<a name='4851'>
<a name='4852'>
    DO j = j_start, j_end<a name='4853'>
    DO k = kts, ktf<a name='4854'>
    DO i = i_start, i_end<a name='4855'>
      avg(i,k,j) = 0.25 *  &amp;<a name='4856'>
                   ( ( tmp2(i,k+1,j  )**2 ) + ( tmp2(i,k,j  )**2) +  &amp;<a name='4857'>
                     ( tmp2(i,k+1,j+1)**2 ) + ( tmp2(i,k,j+1)**2) )<a name='4858'>
    END DO<a name='4859'>
    END DO<a name='4860'>
    END DO<a name='4861'>
<a name='4862'>
    DO j = j_start, j_end<a name='4863'>
    DO k = kts, ktf<a name='4864'>
    DO i = i_start, i_end<a name='4865'>
      tendency(i,k,j) = tendency(i,k,j) + mu(i,j) * xkmv(i,k,j) * avg(i,k,j)<a name='4866'>
    END DO<a name='4867'>
    END DO<a name='4868'>
    END DO<a name='4869'>
<a name='4870'>
<font color=#447700>!MARTA: add the drug at the surface; WCS 040331<a name='4871'></font>
    K=KTS<a name='4872'>
<a name='4873'>
    cd0 = config_flags%tke_drag_coefficient   <font color=#447700>! constant drag coefficient <a name='4874'></font>
                                              <font color=#447700>! set in namelist.input<a name='4875'></font>
    DO j = j_start, j_end   <a name='4876'>
    DO i = i_start, i_end<a name='4877'>
<a name='4878'>
      tendency(i,k,j) = tendency(i,k,j) +       &amp;<a name='4879'>
           mu(i,j)*( (v(i,k,j)+v(i,k,j+1))*0.5* &amp;<a name='4880'>
                     cd0*absU*defor23(i,kts+1,j))<a name='4881'>
<a name='4882'>
    END DO<a name='4883'>
    END DO<a name='4884'>
<font color=#447700>! end of MARTA/WCS change<a name='4885'></font>
<a name='4886'>
    END SUBROUTINE tke_shear<a name='4887'>
<a name='4888'>
<font color=#447700>!=======================================================================<a name='4889'></font>
<font color=#447700>!=======================================================================<a name='4890'></font>
<a name='4891'>
<A NAME='COMPUTE_DIFF_METRICS'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#COMPUTE_DIFF_METRICS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4892'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>compute_diff_metrics</font>( config_flags, ph, phb, z, rdz, rdzw,  &amp; <A href='../../call_to/COMPUTE_DIFF_METRICS.html' TARGET='index'>3</A><a name='4893'>
                                     zx, zy, rdx, rdy,                     &amp;<a name='4894'>
                                     ids, ide, jds, jde, kds, kde,         &amp;<a name='4895'>
                                     ims, ime, jms, jme, kms, kme,         &amp;<a name='4896'>
                                     its, ite, jts, jte, kts, kte         )<a name='4897'>
<a name='4898'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4899'></font>
<font color=#447700>! Begin declarations.<a name='4900'></font>
<a name='4901'>
    IMPLICIT NONE<a name='4902'>
<a name='4903'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='4904'>
    :: config_flags<a name='4905'>
<a name='4906'>
    INTEGER, INTENT( IN )  &amp;<a name='4907'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='4908'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='4909'>
       its, ite, jts, jte, kts, kte<a name='4910'>
<a name='4911'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='4912'>
    :: ph, phb<a name='4913'>
<a name='4914'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( OUT )  &amp;<a name='4915'>
    :: rdz, rdzw, zx, zy, z<a name='4916'>
<a name='4917'>
    REAL, INTENT( IN )  &amp;<a name='4918'>
    :: rdx, rdy<a name='4919'>
<a name='4920'>
<font color=#447700>! Local variables.<a name='4921'></font>
<a name='4922'>
    INTEGER  &amp;<a name='4923'>
    :: i, j, k, i_start, i_end, j_start, j_end, ktf<a name='4924'>
<a name='4925'>
<font color=#447700>! End declarations.<a name='4926'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4927'></font>
<a name='4928'>
    ktf = MIN( kte, kde-1 )<a name='4929'>
<a name='4930'>
<font color=#447700>! Bug fix, WCS, 22 april 2002.<a name='4931'></font>
<a name='4932'>
<font color=#447700>! We need rdzw in halo for average to u and v points.<a name='4933'></font>
<a name='4934'>
    j_start = jts-1<a name='4935'>
    j_end   = jte<a name='4936'>
<a name='4937'>
<font color=#447700>! Begin with dz computations.<a name='4938'></font>
<a name='4939'>
    DO j = j_start, j_end<a name='4940'>
<a name='4941'>
      IF ( ( j_start &gt;= jts ) .AND. ( j_end &lt;= MIN( jte, jde-1 ) ) ) THEN<a name='4942'>
        i_start = its-1<a name='4943'>
        i_end   = ite<a name='4944'>
      ELSE<a name='4945'>
        i_start = its<a name='4946'>
        i_end   = MIN( ite, ide-1 )<a name='4947'>
      END IF<a name='4948'>
<a name='4949'>
<font color=#447700>! Compute z at w points for rdz and rdzw computations.  We'll switch z<a name='4950'></font>
<font color=#447700>! to z at p points before returning<a name='4951'></font>
<a name='4952'>
      DO k = 1, kte<a name='4953'>
<a name='4954'>
<font color=#447700>! Bug fix, WCS, 22 april 2002<a name='4955'></font>
<a name='4956'>
      DO i = i_start, i_end<a name='4957'>
        z(i,k,j) = ( ph(i,k,j) + phb(i,k,j) ) / g<a name='4958'>
      END DO<a name='4959'>
      END DO<a name='4960'>
<a name='4961'>
      DO k = 1, ktf<a name='4962'>
      DO i = i_start, i_end<a name='4963'>
        rdzw(i,k,j) = 1.0 / ( z(i,k+1,j) - z(i,k,j) )<a name='4964'>
      END DO<a name='4965'>
      END DO<a name='4966'>
<a name='4967'>
      DO k = 2, ktf<a name='4968'>
      DO i = i_start, i_end<a name='4969'>
        rdz(i,k,j) = 2.0 / ( z(i,k+1,j) - z(i,k-1,j) )<a name='4970'>
      END DO<a name='4971'>
      END DO<a name='4972'>
<a name='4973'>
<font color=#447700>! Bug fix, WCS, 22 april 2002; added the following code<a name='4974'></font>
<a name='4975'>
      DO i = i_start, i_end<a name='4976'>
        rdz(i,1,j) = 2./(z(i,2,j)-z(i,1,j))<a name='4977'>
      END DO<a name='4978'>
<a name='4979'>
    END DO<a name='4980'>
<a name='4981'>
<font color=#447700>! End bug fix.<a name='4982'></font>
<a name='4983'>
<font color=#447700>! Now compute zx and zy; we'll assume that the halo for ph and phb is<a name='4984'></font>
<font color=#447700>! properly filled.<a name='4985'></font>
<a name='4986'>
    i_start = its<a name='4987'>
    i_end   = MIN( ite, ide-1 )<a name='4988'>
    j_start = jts<a name='4989'>
    j_end   = MIN( jte, jde-1 )<a name='4990'>
<a name='4991'>
    DO j = j_start, j_end<a name='4992'>
    DO k = 1, kte<a name='4993'>
    DO i = MAX( ids+1, its ), i_end<a name='4994'>
      zx(i,k,j) = rdx * ( phb(i,k,j) - phb(i-1,k,j) ) / g<a name='4995'>
    END DO<a name='4996'>
    END DO<a name='4997'>
    END DO<a name='4998'>
<a name='4999'>
    DO j = j_start, j_end<a name='5000'>
    DO k = 1, kte<a name='5001'>
    DO i = MAX( ids+1, its ), i_end<a name='5002'>
      zx(i,k,j) = zx(i,k,j) + rdx * ( ph(i,k,j) - ph(i-1,k,j) ) / g<a name='5003'>
    END DO<a name='5004'>
    END DO<a name='5005'>
    END DO<a name='5006'>
<a name='5007'>
    DO j = MAX( jds+1, jts ), j_end<a name='5008'>
    DO k = 1, kte<a name='5009'>
    DO i = i_start, i_end<a name='5010'>
      zy(i,k,j) = rdy * ( phb(i,k,j) - phb(i,k,j-1) ) / g<a name='5011'>
    END DO<a name='5012'>
    END DO<a name='5013'>
    END DO<a name='5014'>
<a name='5015'>
    DO j = MAX( jds+1, jts ), j_end<a name='5016'>
    DO k = 1, kte<a name='5017'>
    DO i = i_start, i_end<a name='5018'>
      zy(i,k,j) = zy(i,k,j) + rdy * ( ph(i,k,j) - ph(i,k,j-1) ) / g<a name='5019'>
    END DO<a name='5020'>
    END DO<a name='5021'>
    END DO<a name='5022'>
<a name='5023'>
<font color=#447700>! Some b.c. on zx and zy.<a name='5024'></font>
<a name='5025'>
    IF ( .NOT. config_flags%periodic_x ) THEN<a name='5026'>
<a name='5027'>
      IF ( ite == ide ) THEN<a name='5028'>
        DO j = j_start, j_end<a name='5029'>
        DO k = 1, ktf<a name='5030'>
          zx(ide,k,j) = 0.0<a name='5031'>
        END DO<a name='5032'>
        END DO<a name='5033'>
      END IF<a name='5034'>
<a name='5035'>
      IF ( its == ids ) THEN<a name='5036'>
        DO j = j_start, j_end<a name='5037'>
        DO k = 1, ktf<a name='5038'>
          zx(ids,k,j) = 0.0<a name='5039'>
        END DO<a name='5040'>
        END DO<a name='5041'>
      END IF<a name='5042'>
<a name='5043'>
    ELSE<a name='5044'>
<a name='5045'>
      IF ( ite == ide ) THEN<a name='5046'>
        DO j=j_start,j_end<a name='5047'>
        DO k=1,ktf<a name='5048'>
         zx(ide,k,j) = rdx * ( phb(ide,k,j) - phb(ide-1,k,j) ) / g<a name='5049'>
        END DO<a name='5050'>
        END DO<a name='5051'>
<a name='5052'>
        DO j = j_start, j_end<a name='5053'>
        DO k = 1, ktf<a name='5054'>
          zx(ide,k,j) = zx(ide,k,j) + rdx * ( ph(ide,k,j) - ph(ide-1,k,j) ) / g<a name='5055'>
        END DO<a name='5056'>
        END DO<a name='5057'>
      END IF<a name='5058'>
<a name='5059'>
      IF ( its == ids ) THEN<a name='5060'>
        DO j = j_start, j_end<a name='5061'>
        DO k = 1, ktf<a name='5062'>
          zx(ids,k,j) = rdx * ( phb(ids,k,j) - phb(ids-1,k,j) ) / g<a name='5063'>
        END DO<a name='5064'>
        END DO<a name='5065'>
<a name='5066'>
        DO j =j_start,j_end<a name='5067'>
        DO k =1,ktf<a name='5068'>
          zx(ids,k,j) = zx(ids,k,j) + rdx * ( ph(ids,k,j) - ph(ids-1,k,j) ) / g<a name='5069'>
        END DO<a name='5070'>
        END DO<a name='5071'>
      END IF<a name='5072'>
<a name='5073'>
    END IF<a name='5074'>
<a name='5075'>
    IF ( .NOT. config_flags%periodic_y ) THEN<a name='5076'>
<a name='5077'>
      IF ( jte == jde ) THEN<a name='5078'>
        DO k =1, ktf<a name='5079'>
        DO i =i_start, i_end<a name='5080'>
          zy(i,k,jde) = 0.0<a name='5081'>
        END DO<a name='5082'>
        END DO<a name='5083'>
      END IF<a name='5084'>
<a name='5085'>
      IF ( jts == jds ) THEN<a name='5086'>
        DO k =1, ktf<a name='5087'>
        DO i =i_start, i_end<a name='5088'>
          zy(i,k,jds) = 0.0<a name='5089'>
        END DO<a name='5090'>
        END DO<a name='5091'>
      END IF<a name='5092'>
<a name='5093'>
    ELSE<a name='5094'>
<a name='5095'>
      IF ( jte == jde ) THEN<a name='5096'>
        DO j=j_start, j_end<a name='5097'>
        DO k=1, ktf<a name='5098'>
          zy(i,k,jde) = rdy * ( phb(i,k,jde) - phb(i,k,jde-1) ) / g<a name='5099'>
        END DO<a name='5100'>
        END DO<a name='5101'>
<a name='5102'>
        DO j = j_start, j_end<a name='5103'>
        DO k = 1, ktf<a name='5104'>
          zy(i,k,jde) = zy(i,k,jde) + rdy * ( ph(i,k,jde) - ph(i,k,jde-1) ) / g<a name='5105'>
        END DO<a name='5106'>
        END DO<a name='5107'>
      END IF<a name='5108'>
<a name='5109'>
      IF ( jts == jds ) THEN<a name='5110'>
        DO j = j_start, j_end<a name='5111'>
        DO k = 1, ktf<a name='5112'>
          zy(i,k,jds) = rdy * ( phb(i,k,jds) - phb(i,k,jds-1) ) / g<a name='5113'>
        END DO<a name='5114'>
        END DO<a name='5115'>
<a name='5116'>
        DO j = j_start, j_end<a name='5117'>
        DO k = 1, ktf<a name='5118'>
          zy(i,k,jds) = zy(i,k,jds) + rdy * ( ph(i,k,jds) - ph(i,k,jds-1) ) / g<a name='5119'>
        END DO<a name='5120'>
        END DO<a name='5121'>
      END IF<a name='5122'>
<a name='5123'>
    END IF<a name='5124'>
      <a name='5125'>
<font color=#447700>! Calculate z at p points.<a name='5126'></font>
<a name='5127'>
    DO j = j_start, j_end<a name='5128'>
      DO k = 1, ktf<a name='5129'>
      DO i = i_start, i_end<a name='5130'>
        z(i,k,j) = 0.5 *  &amp;<a name='5131'>
                   ( ph(i,k,j) + phb(i,k,j) + ph(i,k+1,j) + phb(i,k+1,j) ) / g<a name='5132'>
      END DO<a name='5133'>
      END DO<a name='5134'>
    END DO<a name='5135'>
<a name='5136'>
    END SUBROUTINE compute_diff_metrics<a name='5137'>
<a name='5138'>
<font color=#447700>!=======================================================================<a name='5139'></font>
<font color=#447700>!=======================================================================<a name='5140'></font>
<a name='5141'>
    END MODULE module_diffusion_em<a name='5142'>
<a name='5143'>
<font color=#447700>!=======================================================================<a name='5144'></font>
<font color=#447700>!=======================================================================<a name='5145'></font>
<a name='5146'>
<a name='5147'>
</pre></body></html>