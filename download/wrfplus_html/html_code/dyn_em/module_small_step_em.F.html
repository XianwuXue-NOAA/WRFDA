<HTML> <BODY BGCOLOR=#cceeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:DYNAMICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<font color=#447700>!  SMALL_STEP code for the geometric height coordinate model<a name='5'></font>
<font color=#447700>!<a name='6'></font>
<font color=#447700>!---------------------------------------------------------------------------<a name='7'></font>
<a name='8'>
<A NAME='MODULE_SMALL_STEP_EM'><A href='../../html_code/dyn_em/module_small_step_em.F.html#MODULE_SMALL_STEP_EM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='9'>
<font color=#993300>MODULE </font><font color=#cc0000>module_small_step_em</font> <A href='../../call_to/MODULE_SMALL_STEP_EM.html' TARGET='index'>7</A><a name='10'>
<a name='11'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_small_step_em.F.html#module_small_step_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_22"><a name='12'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_small_step_em.F.html#module_small_step_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_20"><a name='13'>
<a name='14'>
CONTAINS<a name='15'>
<a name='16'>
<font color=#447700>!----------------------------------------------------------------------<a name='17'></font>
<a name='18'>
<A NAME='SMALL_STEP_PREP'><A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_PREP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='19'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>small_step_prep</font>( u_1, u_2, v_1, v_2, w_1, w_2, &amp; <A href='../../call_to/SMALL_STEP_PREP.html' TARGET='index'>12</A><a name='20'>
                            t_1, t_2, ph_1, ph_2,         &amp;<a name='21'>
                            mub, mu_1, mu_2,              &amp;<a name='22'>
                            muu, muus, muv, muvs,         &amp;<a name='23'>
                            mut, muts, mudf,              &amp;<a name='24'>
                            u_save, v_save, w_save,       &amp;<a name='25'>
                            t_save, ph_save, mu_save,     &amp;<a name='26'>
                            ww, ww_save,                  &amp;<a name='27'>
                            dnw, c2a, pb, p, alt,         &amp;<a name='28'>
                            msfu, msfv, msft,             &amp;<a name='29'>
                            rk_step, leapfrog,            &amp;<a name='30'>
                            ids,ide, jds,jde, kds,kde,    &amp; <a name='31'>
                            ims,ime, jms,jme, kms,kme,    &amp;<a name='32'>
                            its,ite, jts,jte, kts,kte    )<a name='33'>
<a name='34'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='35'></font>
<a name='36'>
<font color=#447700>! declarations for the stuff coming in<a name='37'></font>
<a name='38'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='39'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='40'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='41'>
<a name='42'>
  INTEGER,      INTENT(IN   )    :: rk_step<a name='43'>
<a name='44'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT) :: u_1,   &amp;<a name='45'>
                                                              v_1,   &amp;<a name='46'>
                                                              w_1,   &amp;<a name='47'>
                                                              t_1,   &amp;<a name='48'>
                                                              ph_1<a name='49'>
<a name='50'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(  OUT) :: u_save,   &amp;<a name='51'>
                                                              v_save,   &amp;<a name='52'>
                                                              w_save,   &amp;<a name='53'>
                                                              t_save,   &amp;<a name='54'>
                                                              ph_save<a name='55'>
<a name='56'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT) :: u_2,   &amp;<a name='57'>
                                                              v_2,   &amp;<a name='58'>
                                                              w_2,   &amp;<a name='59'>
                                                              t_2,   &amp;<a name='60'>
                                                              ph_2<a name='61'>
<a name='62'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(  OUT) :: c2a, &amp;<a name='63'>
                                                               ww_save<a name='64'>
<a name='65'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::  pb,  &amp;<a name='66'>
                                                                p,   &amp;<a name='67'>
                                                                alt, &amp;<a name='68'>
                                                                ww<a name='69'>
<a name='70'>
<font color=#447700>! pjj/cray<a name='71'></font>
<font color=#447700>! REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(INOUT) :: mu_1<a name='72'></font>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(INOUT) :: mu_1,mu_2<a name='73'>
<a name='74'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(INout) :: mub,  &amp;<a name='75'>
                                                               muu,  &amp;<a name='76'>
                                                               muv,  &amp;<a name='77'>
                                                               mut,  &amp;<a name='78'>
                                                               msfu, &amp;<a name='79'>
                                                               msfv, &amp;<a name='80'>
                                                               msft<a name='81'>
<a name='82'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(  OUT) :: muus, &amp;<a name='83'>
                                                               muvs, &amp;<a name='84'>
                                                               muts, &amp;<a name='85'>
<font color=#447700>!pjj/cray<a name='86'></font>
<font color=#447700>!                                                              mu_2, &amp;<a name='87'></font>
                                                               mudf<a name='88'>
<a name='89'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(  OUT) :: mu_save<a name='90'>
<a name='91'>
  REAL, DIMENSION(kms:kme, jms:jme)         , INTENT(IN   ) :: dnw<a name='92'>
<a name='93'>
  LOGICAL, INTENT(IN   ) :: leapfrog<a name='94'>
<a name='95'>
<font color=#447700>! local variables<a name='96'></font>
<a name='97'>
  INTEGER :: i, j, k<a name='98'>
  INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='99'>
  INTEGER :: i_endu, j_endv<a name='100'>
<a name='101'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='102'></font>
<font color=#447700>!<a name='103'></font>
<font color=#447700>!  small_step_prep prepares the prognostic variables for the small timestep.<a name='104'></font>
<font color=#447700>!  This includes switching time-levels in the arrays and computing coupled <a name='105'></font>
<font color=#447700>!  perturbation variables for the small timestep <a name='106'></font>
<font color=#447700>!  (i.e. mu*u" = mu(t)*u(t)-mu(*)*u(*); mu*u" is advanced during the small <a name='107'></font>
<font color=#447700>!  timesteps<a name='108'></font>
<font color=#447700>!<a name='109'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='110'></font>
<a name='111'>
    i_start = its<a name='112'>
    i_end   = ite<a name='113'>
    j_start = jts<a name='114'>
    j_end   = jte<a name='115'>
    k_start = kts<a name='116'>
    k_end = min(kte,kde-1)<a name='117'>
<a name='118'>
    i_endu = i_end<a name='119'>
    j_endv = j_end<a name='120'>
<a name='121'>
    IF(i_end == ide) i_end = i_end - 1<a name='122'>
    IF(j_end == jde) j_end = j_end - 1<a name='123'>
<a name='124'>
    <font color=#447700>!  if this is the first RK step, reset *_1 to *_2<a name='125'></font>
    <font color=#447700>!  (we are replacing the t-dt fields with the time t fields)<a name='126'></font>
<a name='127'>
    IF ((rk_step == 1) .and. (.not.leapfrog)) THEN<a name='128'>
<a name='129'>
<font color=#447700>! 1 jun 2001 -&gt; added boundary copy to 2D boundary condition routines,<a name='130'></font>
<font color=#447700>!  should be OK now without the following data copy<a name='131'></font>
<font color=#447700>!#if 0<a name='132'></font>
<font color=#447700>!     DO j=j_start, j_end<a name='133'></font>
<font color=#447700>!       mu_2(0,j)=mu_2(1,j)<a name='134'></font>
<font color=#447700>!       mu_2(i_endu,j)=mu_2(i_end,j)<a name='135'></font>
<font color=#447700>!       mu_1(0,j)=mu_2(1,j)<a name='136'></font>
<font color=#447700>!       mu_1(i_endu,j)=mu_2(i_end,j)<a name='137'></font>
<font color=#447700>!       mub(0,j)=mub(1,j)<a name='138'></font>
<font color=#447700>!       mub(i_endu,j)=mub(i_end,j)<a name='139'></font>
<font color=#447700>!     ENDDO<a name='140'></font>
<font color=#447700>!     DO i=i_start, i_end<a name='141'></font>
<font color=#447700>!       mu_2(i,0)=mu_2(i,1)<a name='142'></font>
<font color=#447700>!       mu_2(i,j_endv)=mu_2(i,j_end)<a name='143'></font>
<font color=#447700>!       mu_1(i,0)=mu_2(i,1)<a name='144'></font>
<font color=#447700>!       mu_1(i,j_endv)=mu_2(i,j_end)<a name='145'></font>
<font color=#447700>!       mub(i,0)=mub(i,1)<a name='146'></font>
<font color=#447700>!       mub(i,j_endv)=mub(i,j_end)<a name='147'></font>
<font color=#447700>!     ENDDO<a name='148'></font>
<font color=#447700>!#endif<a name='149'></font>
<a name='150'>
      DO j=j_start, j_end<a name='151'>
      DO i=i_start, i_end<a name='152'>
        mu_1(i,j)=mu_2(i,j)<a name='153'>
        ww_save(i,kde,j) = 0.<a name='154'>
        ww_save(i,1,j) = 0.<a name='155'>
        mudf(i,j) = 0.  <font color=#447700>!  initialize external mode div damp to zero<a name='156'></font>
      ENDDO<a name='157'>
      ENDDO<a name='158'>
<a name='159'>
      DO j=j_start, j_end<a name='160'>
      DO k=k_start, k_end<a name='161'>
      DO i=i_start, i_endu<a name='162'>
        u_1(i,k,j) = u_2(i,k,j)<a name='163'>
      ENDDO<a name='164'>
      ENDDO<a name='165'>
      ENDDO<a name='166'>
<a name='167'>
      DO j=j_start, j_endv<a name='168'>
      DO k=k_start, k_end<a name='169'>
      DO i=i_start, i_end<a name='170'>
        v_1(i,k,j) = v_2(i,k,j)<a name='171'>
      ENDDO<a name='172'>
      ENDDO<a name='173'>
      ENDDO<a name='174'>
<a name='175'>
      DO j=j_start, j_end<a name='176'>
      DO k=k_start, k_end<a name='177'>
      DO i=i_start, i_end<a name='178'>
        t_1(i,k,j) = t_2(i,k,j)<a name='179'>
      ENDDO<a name='180'>
      ENDDO<a name='181'>
      ENDDO<a name='182'>
<a name='183'>
      DO j=j_start, j_end<a name='184'>
      DO k=k_start, min(kde,kte)<a name='185'>
      DO i=i_start, i_end<a name='186'>
        w_1(i,k,j)  = w_2(i,k,j)<a name='187'>
        ph_1(i,k,j) = ph_2(i,k,j)<a name='188'>
      ENDDO<a name='189'>
      ENDDO<a name='190'>
      ENDDO<a name='191'>
<a name='192'>
    DO j=j_start, j_end<a name='193'>
      DO i=i_start, i_end<a name='194'>
        muts(i,j)=mub(i,j)+mu_2(i,j)<a name='195'>
      ENDDO<a name='196'>
      DO i=i_start, i_endu<a name='197'>
<font color=#447700>!  rk_step==1, not leapfrog, WCS fix for tiling<a name='198'></font>
<font color=#447700>!        muus(i,j)=0.5*(mub(i,j)+mu_2(i,j)+mub(i-1,j)+mu_2(i-1,j))<a name='199'></font>
        muus(i,j) = muu(i,j)<a name='200'>
      ENDDO<a name='201'>
    ENDDO<a name='202'>
<a name='203'>
    DO j=j_start, j_endv<a name='204'>
    DO i=i_start, i_end<a name='205'>
<font color=#447700>!  rk_step==1, not leapfrog, WCS fix for tiling<a name='206'></font>
<font color=#447700>!      muvs(i,j)=0.5*(mub(i,j)+mu_2(i,j)+mub(i,j-1)+mu_2(i,j-1))<a name='207'></font>
        muvs(i,j) = muv(i,j)<a name='208'>
    ENDDO<a name='209'>
    ENDDO<a name='210'>
<a name='211'>
    DO j=j_start, j_end<a name='212'>
      DO i=i_start, i_end<a name='213'>
        mu_save(i,j)=mu_2(i,j)<a name='214'>
        mu_2(i,j)=mu_2(i,j)-mu_2(i,j)<a name='215'>
      ENDDO<a name='216'>
    ENDDO<a name='217'>
<a name='218'>
    ELSE<a name='219'>
<a name='220'>
    DO j=j_start, j_end<a name='221'>
      DO i=i_start, i_end<a name='222'>
        muts(i,j)=mub(i,j)+mu_1(i,j)<a name='223'>
      ENDDO<a name='224'>
      DO i=i_start, i_endu<a name='225'>
        muus(i,j)=0.5*(mub(i,j)+mu_1(i,j)+mub(i-1,j)+mu_1(i-1,j))<a name='226'>
      ENDDO<a name='227'>
    ENDDO<a name='228'>
<a name='229'>
    DO j=j_start, j_endv<a name='230'>
    DO i=i_start, i_end<a name='231'>
      muvs(i,j)=0.5*(mub(i,j)+mu_1(i,j)+mub(i,j-1)+mu_1(i,j-1))<a name='232'>
    ENDDO<a name='233'>
    ENDDO<a name='234'>
<a name='235'>
    DO j=j_start, j_end<a name='236'>
      DO i=i_start, i_end<a name='237'>
        mu_save(i,j)=mu_2(i,j)<a name='238'>
        mu_2(i,j)=mu_1(i,j)-mu_2(i,j)<a name='239'>
      ENDDO<a name='240'>
    ENDDO<a name='241'>
<a name='242'>
<a name='243'>
    END IF<a name='244'>
<a name='245'>
    <font color=#447700>! set up the small timestep variables<a name='246'></font>
<a name='247'>
      DO j=j_start, j_end<a name='248'>
      DO i=i_start, i_end<a name='249'>
        ww_save(i,kde,j) = 0.<a name='250'>
        ww_save(i,1,j) = 0.<a name='251'>
      ENDDO<a name='252'>
      ENDDO<a name='253'>
<a name='254'>
    DO j=j_start, j_end<a name='255'>
    DO k=k_start, k_end<a name='256'>
    DO i=i_start, i_end<a name='257'>
      c2a(i,k,j) = cpovcv*(pb(i,k,j)+p(i,k,j))/alt(i,k,j)<a name='258'>
    ENDDO<a name='259'>
    ENDDO<a name='260'>
    ENDDO<a name='261'>
<a name='262'>
    DO j=j_start, j_end<a name='263'>
    DO k=k_start, k_end<a name='264'>
    DO i=i_start, i_endu<a name='265'>
      u_save(i,k,j) = u_2(i,k,j)<a name='266'>
      u_2(i,k,j) = (muus(i,j)*u_1(i,k,j)-muu(i,j)*u_2(i,k,j))/msfu(i,j)<a name='267'>
    ENDDO<a name='268'>
    ENDDO<a name='269'>
    ENDDO<a name='270'>
<a name='271'>
    DO j=j_start, j_endv<a name='272'>
    DO k=k_start, k_end<a name='273'>
    DO i=i_start, i_end<a name='274'>
      v_save(i,k,j) = v_2(i,k,j)<a name='275'>
      v_2(i,k,j) = (muvs(i,j)*v_1(i,k,j)-muv(i,j)*v_2(i,k,j))/msfv(i,j)<a name='276'>
    ENDDO<a name='277'>
    ENDDO<a name='278'>
    ENDDO<a name='279'>
<a name='280'>
    DO j=j_start, j_end<a name='281'>
    DO k=k_start, k_end<a name='282'>
    DO i=i_start, i_end<a name='283'>
      t_save(i,k,j) = t_2(i,k,j)<a name='284'>
      t_2(i,k,j) = muts(i,j)*t_1(i,k,j)-mut(i,j)*t_2(i,k,j)<a name='285'>
    ENDDO<a name='286'>
    ENDDO<a name='287'>
    ENDDO<a name='288'>
<a name='289'>
    DO j=j_start, j_end<a name='290'>
<font color=#447700>!    DO k=k_start, min(kde,kte)<a name='291'></font>
    DO k=k_start, kde<a name='292'>
    DO i=i_start, i_end<a name='293'>
      w_save(i,k,j) = w_2(i,k,j)<a name='294'>
      w_2(i,k,j)  = (muts(i,j)* w_1(i,k,j)-mut(i,j)* w_2(i,k,j))/msft(i,j)<a name='295'>
      ph_save(i,k,j) = ph_2(i,k,j)<a name='296'>
      ph_2(i,k,j) = ph_1(i,k,j)-ph_2(i,k,j)<a name='297'>
    ENDDO<a name='298'>
    ENDDO<a name='299'>
    ENDDO<a name='300'>
<a name='301'>
      DO j=j_start, j_end<a name='302'>
<font color=#447700>!      DO k=k_start, min(kde,kte)<a name='303'></font>
      DO k=k_start, kde<a name='304'>
      DO i=i_start, i_end<a name='305'>
        ww_save(i,k,j) = ww(i,k,j)<a name='306'>
      ENDDO<a name='307'>
      ENDDO<a name='308'>
      ENDDO<a name='309'>
<a name='310'>
END SUBROUTINE small_step_prep<a name='311'>
<a name='312'>
<font color=#447700>!-------------------------------------------------------------------------<a name='313'></font>
<a name='314'>
<a name='315'>
<A NAME='SMALL_STEP_FINISH'><A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_FINISH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='316'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>small_step_finish</font>( u_2, u_1, v_2, v_1, w_2, w_1,    &amp; <A href='../../call_to/SMALL_STEP_FINISH.html' TARGET='index'>9</A><a name='317'>
                              t_2, t_1, ph_2, ph_1, ww, ww1,   &amp;<a name='318'>
                              mu_2, mu_1,                      &amp;<a name='319'>
                              mut, muts, muu, muus, muv, muvs, &amp;<a name='320'>
                              u_save, v_save, w_save,          &amp;<a name='321'>
                              t_save, ph_save, mu_save,        &amp;<a name='322'>
                              msfu, msfv, msft,                &amp;<a name='323'>
                              h_diabatic,                      &amp;<a name='324'>
                              number_of_small_timesteps,dts,   &amp;<a name='325'>
                              ids,ide, jds,jde, kds,kde,       &amp;<a name='326'>
                              ims,ime, jms,jme, kms,kme,       &amp;<a name='327'>
                              its,ite, jts,jte, kts,kte       )<a name='328'>
<a name='329'>
<a name='330'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='331'></font>
<a name='332'>
<font color=#447700>!  stuff passed in<a name='333'></font>
<a name='334'>
  INTEGER,                  INTENT(IN   ) :: ids,ide, jds,jde, kds,kde<a name='335'>
  INTEGER,                  INTENT(IN   ) :: ims,ime, jms,jme, kms,kme<a name='336'>
  INTEGER,                  INTENT(IN   ) :: its,ite, jts,jte, kts,kte<a name='337'>
  INTEGER,                  INTENT(IN   ) :: number_of_small_timesteps<a name='338'>
  REAL,                     INTENT(IN   ) :: dts<a name='339'>
<a name='340'>
  REAL,   DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN   ) :: u_1, &amp;<a name='341'>
                                                                 v_1, &amp;<a name='342'>
                                                                 w_1, &amp;<a name='343'>
                                                                 t_1, &amp;<a name='344'>
                                                                 ww1, &amp;<a name='345'>
                                                                 ph_1<a name='346'>
<a name='347'>
  REAL,   DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: u_2, &amp;<a name='348'>
                                                                 v_2, &amp;<a name='349'>
                                                                 w_2, &amp;<a name='350'>
                                                                 t_2, &amp;<a name='351'>
                                                                 ww,  &amp;<a name='352'>
                                                                 ph_2<a name='353'>
<a name='354'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(IN   ) :: u_save,   &amp;<a name='355'>
                                                              v_save,   &amp;<a name='356'>
                                                              w_save,   &amp;<a name='357'>
                                                              t_save,   &amp;<a name='358'>
                                                              ph_save,  &amp;<a name='359'>
                                                             h_diabatic<a name='360'>
<a name='361'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: muus, muvs<a name='362'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: mu_2, mu_1<a name='363'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: mut, muts, &amp;<a name='364'>
                                                        muu, muv, mu_save<a name='365'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(IN   ) :: msfu, msfv, msft<a name='366'>
<a name='367'>
<a name='368'>
<font color=#447700>! local stuff<a name='369'></font>
<a name='370'>
  INTEGER         :: i,j,k<a name='371'>
  INTEGER :: i_start, i_end, j_start, j_end, i_endu, j_endv<a name='372'>
<a name='373'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='374'></font>
<font color=#447700>!<a name='375'></font>
<font color=#447700>!  small_step_finish reconstructs the full uncoupled prognostic variables<a name='376'></font>
<font color=#447700>!  from the coupled perturbation variables used in the small timesteps.<a name='377'></font>
<font color=#447700>!<a name='378'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='379'></font>
<a name='380'>
  i_start = its<a name='381'>
  i_end   = ite<a name='382'>
  j_start = jts<a name='383'>
  j_end   = jte<a name='384'>
<a name='385'>
  i_endu = i_end<a name='386'>
  j_endv = j_end<a name='387'>
<a name='388'>
  IF(i_end == ide) i_end = i_end - 1<a name='389'>
  IF(j_end == jde) j_end = j_end - 1<a name='390'>
<a name='391'>
<a name='392'>
<font color=#447700>! 1 jun 2001 -&gt; added boundary copy to 2D boundary condition routines,<a name='393'></font>
<font color=#447700>!  should be OK now without the following data copy<a name='394'></font>
<a name='395'>
<font color=#447700>!#if 0<a name='396'></font>
<font color=#447700>! DO j=j_start, j_end<a name='397'></font>
<font color=#447700>!   muts(0,j)=muts(1,j)<a name='398'></font>
<font color=#447700>!   muts(i_endu,j)=muts(i_end,j)<a name='399'></font>
<font color=#447700>! ENDDO<a name='400'></font>
<font color=#447700>! DO i=i_start, i_end<a name='401'></font>
<font color=#447700>!   muts(i,0)=muts(i,1)<a name='402'></font>
<font color=#447700>!   muts(i,j_endv)=muts(i,j_end)<a name='403'></font>
<font color=#447700>! ENDDO<a name='404'></font>
<a name='405'>
<font color=#447700>! DO j = j_start, j_endv<a name='406'></font>
<font color=#447700>! DO i = i_start, i_end<a name='407'></font>
<font color=#447700>!   muvs(i,j) = 0.5*(muts(i,j) + muts(i,j-1))<a name='408'></font>
<font color=#447700>! ENDDO<a name='409'></font>
<font color=#447700>! ENDDO<a name='410'></font>
<a name='411'>
<font color=#447700>! DO j = j_start, j_end<a name='412'></font>
<font color=#447700>! DO i = i_start, i_endu<a name='413'></font>
<font color=#447700>!   muus(i,j) = 0.5*(muts(i,j) + muts(i-1,j))<a name='414'></font>
<font color=#447700>! ENDDO<a name='415'></font>
<font color=#447700>! ENDDO<a name='416'></font>
<font color=#447700>!#endif<a name='417'></font>
<a name='418'>
<font color=#447700>!    addition of time level t back into variables<a name='419'></font>
<a name='420'>
  DO j = j_start, j_endv<a name='421'>
  DO k = kds, kde-1<a name='422'>
  DO i = i_start, i_end<a name='423'>
    v_2(i,k,j) = (msfv(i,j)*v_2(i,k,j) + v_save(i,k,j)*muv(i,j))/muvs(i,j)<a name='424'>
  ENDDO<a name='425'>
  ENDDO<a name='426'>
  ENDDO<a name='427'>
<a name='428'>
  DO j = j_start, j_end<a name='429'>
  DO k = kds, kde-1<a name='430'>
  DO i = i_start, i_endu<a name='431'>
    u_2(i,k,j) = (msfu(i,j)*u_2(i,k,j) + u_save(i,k,j)*muu(i,j))/muus(i,j)<a name='432'>
  ENDDO<a name='433'>
  ENDDO<a name='434'>
  ENDDO<a name='435'>
<a name='436'>
  DO j = j_start, j_end<a name='437'>
  DO k = kds, kde<a name='438'>
  DO i = i_start, i_end<a name='439'>
    w_2(i,k,j) = (msft(i,j)*w_2(i,k,j) + w_save(i,k,j)*mut(i,j))/muts(i,j)<a name='440'>
    ph_2(i,k,j) = ph_2(i,k,j) + ph_save(i,k,j)<a name='441'>
    ww(i,k,j) = ww(i,k,j) + ww1(i,k,j)<a name='442'>
  ENDDO<a name='443'>
  ENDDO<a name='444'>
  ENDDO<a name='445'>
<a name='446'>
  DO j = j_start, j_end<a name='447'>
  DO k = kds, kde-1<a name='448'>
  DO i = i_start, i_end<a name='449'>
    t_2(i,k,j) = (t_2(i,k,j) - dts*number_of_small_timesteps*mut(i,j)*h_diabatic(i,k,j) &amp;<a name='450'>
                  + t_save(i,k,j)*mut(i,j))/muts(i,j)<a name='451'>
  ENDDO<a name='452'>
  ENDDO<a name='453'>
  ENDDO<a name='454'>
<a name='455'>
  DO j = j_start, j_end<a name='456'>
  DO i = i_start, i_end<a name='457'>
    mu_2(i,j) = mu_2(i,j) + mu_save(i,j)<a name='458'>
  ENDDO<a name='459'>
  ENDDO<a name='460'>
<a name='461'>
END SUBROUTINE small_step_finish<a name='462'>
<a name='463'>
<font color=#447700>!-----------------------------------------------------------------------<a name='464'></font>
<a name='465'>
<A NAME='CALC_P_RHO'><A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_P_RHO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='466'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_p_rho</font>( al, p, ph,                    &amp; <A href='../../call_to/CALC_P_RHO.html' TARGET='index'>21</A><a name='467'>
                       alt, t_2, t_1, c2a, pm1,      &amp;<a name='468'>
                       mu, muts, znu, t0,            &amp;<a name='469'>
                       rdnw, dnw, smdiv,             &amp;<a name='470'>
                       non_hydrostatic, step,        &amp;<a name='471'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='472'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='473'>
                       its,ite, jts,jte, kts,kte    )<a name='474'>
<a name='475'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='476'></font>
<a name='477'>
<font color=#447700>! declarations for the stuff coming in<a name='478'></font>
<a name='479'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='480'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='481'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='482'>
<a name='483'>
  INTEGER,      INTENT(IN   )    :: step<a name='484'>
<a name='485'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(  OUT) :: al,   &amp;<a name='486'>
                                                               p<a name='487'>
<font color=#447700>! pjj/cray<a name='488'></font>
<font color=#447700>!                                                             p,    &amp;<a name='489'></font>
<font color=#447700>!                                                             pm1<a name='490'></font>
<a name='491'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(IN   ) :: alt,   &amp;<a name='492'>
                                                              t_2,   &amp;<a name='493'>
                                                              t_1,   &amp;<a name='494'>
                                                              c2a<a name='495'>
<a name='496'>
<font color=#447700>! pjj/cray<a name='497'></font>
<font color=#447700>! REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT) :: ph<a name='498'></font>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT) :: ph, pm1<a name='499'>
<a name='500'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(IN   ) :: mu,   &amp;<a name='501'>
                                                               muts<a name='502'>
<a name='503'>
  REAL, DIMENSION(kms:kme)         , INTENT(IN   ) :: dnw,  &amp;<a name='504'>
                                                      rdnw, &amp;<a name='505'>
                                                      znu<a name='506'>
<a name='507'>
  REAL,                                       INTENT(IN   ) :: t0, smdiv<a name='508'>
<a name='509'>
  LOGICAL, INTENT(IN   )  :: non_hydrostatic<a name='510'>
<a name='511'>
<font color=#447700>! local variables<a name='512'></font>
<a name='513'>
  INTEGER :: i, j, k<a name='514'>
  INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='515'>
  REAL    :: ptmp<a name='516'>
<a name='517'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='518'></font>
<font color=#447700>!<a name='519'></font>
<font color=#447700>!  For the nonhydrostatic option,<a name='520'></font>
<font color=#447700>!  calc_p_rho computes the perturbation inverse density and <a name='521'></font>
<font color=#447700>!  perturbation pressure from the hydrostatic relation and the <a name='522'></font>
<font color=#447700>!  linearized equation of state, respectively.<a name='523'></font>
<font color=#447700>!<a name='524'></font>
<font color=#447700>!  For the hydrostatic option,<a name='525'></font>
<font color=#447700>!  calc_p_rho computes the perturbation pressure, perturbation density,<a name='526'></font>
<font color=#447700>!  and perturbation geopotential<a name='527'></font>
<font color=#447700>!  from the vertical coordinate definition, linearized equation of state <a name='528'></font>
<font color=#447700>!  and the hydrostatic relation, respectively.<a name='529'></font>
<font color=#447700>!<a name='530'></font>
<font color=#447700>!  forward weighting of the pressure (divergence damping) is also<a name='531'></font>
<font color=#447700>!  computed here.<a name='532'></font>
<font color=#447700>!<a name='533'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='534'></font>
<a name='535'>
   i_start = its<a name='536'>
   i_end   = ite<a name='537'>
   j_start = jts<a name='538'>
   j_end   = jte<a name='539'>
   k_start = kts<a name='540'>
   k_end = min(kte,kde-1)<a name='541'>
<a name='542'>
   IF(i_end == ide) i_end = i_end - 1<a name='543'>
   IF(j_end == jde) j_end = j_end - 1<a name='544'>
<a name='545'>
   IF (non_hydrostatic) THEN<a name='546'>
     DO j=j_start, j_end<a name='547'>
     DO k=k_start, k_end<a name='548'>
     DO i=i_start, i_end<a name='549'>
<a name='550'>
<font color=#447700>!  al computation is all dry, so ok with moisture<a name='551'></font>
<a name='552'>
      al(i,k,j)=-1./muts(i,j)*(alt(i,k,j)*mu(i,j)  &amp;<a name='553'>
             +rdnw(k)*(ph(i,k+1,j)-ph(i,k,j)))<a name='554'>
<a name='555'>
<font color=#447700>!  this is temporally linearized p, no moisture correction needed<a name='556'></font>
<a name='557'>
      p(i,k,j)=c2a(i,k,j)*(alt(i,k,j)*(t_2(i,k,j)-mu(i,j)*t_1(i,k,j))  &amp;<a name='558'>
                       /(muts(i,j)*(t0+t_1(i,k,j)))-al (i,k,j))<a name='559'>
<a name='560'>
     ENDDO<a name='561'>
     ENDDO<a name='562'>
     ENDDO<a name='563'>
<a name='564'>
   ELSE  <font color=#447700>! hydrostatic calculation<a name='565'></font>
<a name='566'>
       DO j=j_start, j_end<a name='567'>
       DO k=k_start, k_end<a name='568'>
       DO i=i_start, i_end<a name='569'>
         p(i,k,j)=mu(i,j)*znu(k)<a name='570'>
         al(i,k,j)=alt(i,k,j)*(t_2(i,k,j)-mu(i,j)*t_1(i,k,j))            &amp;<a name='571'>
                      /(muts(i,j)*(t0+t_1(i,k,j)))-p(i,k,j)/c2a(i,k,j)<a name='572'>
         ph(i,k+1,j)=ph(i,k,j)-dnw(k)*(muts(i,j)*al (i,k,j)              &amp;<a name='573'>
                          +mu(i,j)*alt(i,k,j))<a name='574'>
       ENDDO<a name='575'>
       ENDDO<a name='576'>
       ENDDO<a name='577'>
<a name='578'>
   END IF<a name='579'>
<a name='580'>
<font color=#447700>!  divergence damping setup<a name='581'></font>
 <a name='582'>
     IF (step == 0) then   <font color=#447700>! we're initializing small timesteps<a name='583'></font>
       DO j=j_start, j_end<a name='584'>
       DO k=k_start, k_end<a name='585'>
       DO i=i_start, i_end<a name='586'>
         pm1(i,k,j)=p(i,k,j)<a name='587'>
       ENDDO<a name='588'>
       ENDDO<a name='589'>
       ENDDO <a name='590'>
     ELSE                     <font color=#447700>! we're in the small timesteps <a name='591'></font>
       DO j=j_start, j_end    <font color=#447700>! and adding div damping component<a name='592'></font>
       DO k=k_start, k_end<a name='593'>
       DO i=i_start, i_end<a name='594'>
         ptmp = p(i,k,j)<a name='595'>
         p(i,k,j) = p(i,k,j) + smdiv*(p(i,k,j)-pm1(i,k,j))<a name='596'>
         pm1(i,k,j) = ptmp<a name='597'>
       ENDDO<a name='598'>
       ENDDO<a name='599'>
       ENDDO<a name='600'>
     END IF<a name='601'>
<a name='602'>
END SUBROUTINE calc_p_rho<a name='603'>
<a name='604'>
<font color=#447700>!----------------------------------------------------------------------<a name='605'></font>
<a name='606'>
<A NAME='CALC_COEF_W'><A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_COEF_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='607'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_coef_w</font>( a,alpha,gamma,              &amp; <A href='../../call_to/CALC_COEF_W.html' TARGET='index'>11</A><a name='608'>
                        mut, cqw,                   &amp;<a name='609'>
                        rdn, rdnw, c2a,             &amp;<a name='610'>
                        dts, g, epssm,              &amp;<a name='611'>
                        ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='612'></font>
                        ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='613'></font>
                        its,ite, jts,jte, kts,kte  )  <font color=#447700>! tile   dims<a name='614'></font>
                                                   <a name='615'>
      IMPLICIT NONE  <font color=#447700>! religion first<a name='616'></font>
<a name='617'>
<font color=#447700>!  passed in through the call<a name='618'></font>
<a name='619'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='620'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='621'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='622'>
<a name='623'>
<a name='624'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN   ) :: c2a,  &amp;<a name='625'>
                                                               cqw<a name='626'>
<a name='627'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: alpha, &amp;<a name='628'>
                                                               gamma, &amp;<a name='629'>
                                                               a<a name='630'>
<a name='631'>
  REAL, DIMENSION(ims:ime, jms:jme),          INTENT(IN   ) :: mut<a name='632'>
<a name='633'>
  REAL, DIMENSION(kms:kme),                   INTENT(IN   ) :: rdn,   &amp;<a name='634'>
                                                               rdnw<a name='635'>
<a name='636'>
  REAL,                                       INTENT(IN   ) :: epssm, &amp;<a name='637'>
                                                               dts,   &amp;<a name='638'>
                                                               g<a name='639'>
<a name='640'>
<font color=#447700>!  Local stack data.<a name='641'></font>
<a name='642'>
  REAL, DIMENSION(ims:ime)                         :: cof<a name='643'>
  REAL  :: b, c<a name='644'>
<a name='645'>
  INTEGER :: i, j, k, i_start, i_end, j_start, j_end, k_start, k_end<a name='646'>
  INTEGER :: ij, ijp, ijm<a name='647'>
<a name='648'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='649'></font>
<font color=#447700>!<a name='650'></font>
<font color=#447700>!  calc_coef_w calculates the coefficients needed for the <a name='651'></font>
<font color=#447700>!  implicit solution of the vertical momentum and geopotential equations.<a name='652'></font>
<font color=#447700>!  This requires solution of a tri-diagonal equation.<a name='653'></font>
<font color=#447700>!<a name='654'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='655'></font>
<a name='656'>
                                                 <a name='657'>
      i_start = its<a name='658'>
      i_end   = ite<a name='659'>
      j_start = jts<a name='660'>
      j_end   = jte<a name='661'>
      k_start = kts<a name='662'>
      k_end   = kte-1<a name='663'>
<a name='664'>
      IF(j_end == jde) j_end = j_end - 1<a name='665'>
      IF(i_end == ide) i_end = i_end - 1<a name='666'>
<a name='667'>
     outer_j_loop:  DO j = j_start, j_end<a name='668'>
<a name='669'>
        DO i = i_start, i_end<a name='670'>
          cof(i)  = (.5*dts*g*(1.+epssm)/mut(i,j))**2<a name='671'>
          a(i, 2 ,j) = 0.<a name='672'>
          a(i,kde,j) =-2.*cof(i)*rdnw(kde-1)**2*c2a(i,kde-1,j)<a name='673'>
          gamma(i,1 ,j) = 0.<a name='674'>
        ENDDO<a name='675'>
<a name='676'>
        DO k=3,kde-1<a name='677'>
        DO i=i_start, i_end<a name='678'>
          a(i,k,j) =   -cqw(i,k,j)*cof(i)*rdn(k)* rdnw(k-1)*c2a(i,k-1,j)    <a name='679'>
        ENDDO<a name='680'>
        ENDDO<a name='681'>
<a name='682'>
<a name='683'>
        DO k=2,kde-1<a name='684'>
        DO i=i_start, i_end<a name='685'>
          b = 1.+cqw(i,k,j)*cof(i)*rdn(k)*(rdnw(k  )*c2a(i,k,j  )  &amp;<a name='686'>
                                       +rdnw(k-1)*c2a(i,k-1,j))<a name='687'>
          c =   -cqw(i,k,j)*cof(i)*rdn(k)*rdnw(k  )*c2a(i,k,j  )<a name='688'>
          alpha(i,k,j) = 1./(b-a(i,k,j)*gamma(i,k-1,j))<a name='689'>
          gamma(i,k,j) = c*alpha(i,k,j)<a name='690'>
        ENDDO<a name='691'>
        ENDDO<a name='692'>
<a name='693'>
        DO i=i_start, i_end<a name='694'>
          b = 1.+2.*cof(i)*rdnw(kde-1)**2*c2a(i,kde-1,j)<a name='695'>
          c = 0.<a name='696'>
          alpha(i,kde,j) = 1./(b-a(i,kde,j)*gamma(i,kde-1,j))<a name='697'>
          gamma(i,kde,j) = c*alpha(i,kde,j)<a name='698'>
        ENDDO<a name='699'>
<a name='700'>
      ENDDO outer_j_loop<a name='701'>
<a name='702'>
END SUBROUTINE calc_coef_w<a name='703'>
<a name='704'>
<font color=#447700>!----------------------------------------------------------------------<a name='705'></font>
<a name='706'>
<A NAME='ADVANCE_UV'><A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_UV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='707'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advance_uv</font> ( u, ru_tend, v, rv_tend,        &amp; <A href='../../call_to/ADVANCE_UV.html' TARGET='index'>12</A><a name='708'>
                        p, pb,                         &amp;<a name='709'>
                        ph, php, alt, al, mu,          &amp;<a name='710'>
                        muu, cqu, muv, cqv, mudf,      &amp;<a name='711'>
                        rdx, rdy, dts,                 &amp;<a name='712'>
                        cf1, cf2, cf3, fnm, fnp,       &amp;<a name='713'>
                        emdiv,                         &amp;<a name='714'>
                        rdnw, config_flags, spec_zone, &amp;<a name='715'>
                        non_hydrostatic,               &amp;<a name='716'>
                        ids, ide, jds, jde, kds, kde,  &amp;<a name='717'>
                        ims, ime, jms, jme, kms, kme,  &amp;<a name='718'>
                        its, ite, jts, jte, kts, kte  )<a name='719'>
<a name='720'>
<a name='721'>
<a name='722'>
      IMPLICIT NONE  <font color=#447700>! religion first<a name='723'></font>
<a name='724'>
<font color=#447700>! stuff coming in<a name='725'></font>
<a name='726'>
      TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='727'>
<a name='728'>
      LOGICAL, INTENT(IN   ) :: non_hydrostatic<a name='729'>
<a name='730'>
      INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='731'>
      INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='732'>
      INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='733'>
      INTEGER,      INTENT(IN   )    :: spec_zone<a name='734'>
<a name='735'>
      REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),  &amp;<a name='736'>
            INTENT(INOUT) ::                          &amp;<a name='737'>
                                                  u,  &amp;<a name='738'>
                                                  v<a name='739'>
<a name='740'>
      REAL, DIMENSION( ims:ime , kms:kme, jms:jme ), &amp;<a name='741'>
            INTENT(IN   ) ::                          &amp;<a name='742'>
                                             ru_tend, &amp;<a name='743'>
                                             rv_tend, &amp;<a name='744'>
                                             ph,      &amp;<a name='745'>
                                             php,     &amp;<a name='746'>
                                             p,       &amp;<a name='747'>
                                             pb,      &amp;<a name='748'>
                                             alt,     &amp;<a name='749'>
                                             al,      &amp;<a name='750'>
                                             cqu,     &amp;<a name='751'>
                                             cqv<a name='752'>
<a name='753'>
<a name='754'>
      REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(IN   ) :: muu,  &amp;<a name='755'>
                                                                muv,  &amp;<a name='756'>
                                                                mu,   &amp;<a name='757'>
                                                                mudf<a name='758'>
<a name='759'>
<a name='760'>
      REAL, DIMENSION( kms:kme ),              INTENT(IN   ) :: fnm,    &amp;<a name='761'>
                                                                fnp ,   &amp;<a name='762'>
                                                                rdnw<a name='763'>
<a name='764'>
      REAL,                                    INTENT(IN   ) :: rdx,    &amp;<a name='765'>
                                                                rdy,    &amp;<a name='766'>
                                                                dts,    &amp;<a name='767'>
                                            cf1,    &amp;<a name='768'>
                                            cf2,    &amp;<a name='769'>
                                        cf3,    &amp;<a name='770'>
                                      emdiv<a name='771'>
    <a name='772'>
<a name='773'>
<font color=#447700>!  Local 3d array from the stack (note tile size)<a name='774'></font>
<a name='775'>
      REAL, DIMENSION (its:ite, kts:kte) :: dpn, dpxy<a name='776'>
      REAL, DIMENSION (its:ite) :: mudf_xy<a name='777'>
      REAL                      :: dx, dy<a name='778'>
<a name='779'>
      INTEGER :: i,j,k, i_start, i_end, j_start, j_end, k_start, k_end<a name='780'>
      INTEGER :: i_endu, j_endv, k_endw<a name='781'>
      INTEGER :: i_start_up, i_end_up, j_start_up, j_end_up<a name='782'>
      INTEGER :: i_start_vp, i_end_vp, j_start_vp, j_end_vp<a name='783'>
      INTEGER :: i_start_u_tend, i_end_u_tend, j_start_v_tend, j_end_v_tend<a name='784'>
<a name='785'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='786'></font>
<font color=#447700>!<a name='787'></font>
<font color=#447700>!  advance_uv advances the explicit perturbation horizontal momentum <a name='788'></font>
<font color=#447700>!  equations (u,v) by adding in the large-timestep tendency along with <a name='789'></font>
<font color=#447700>!  the small timestep pressure gradient tendency.<a name='790'></font>
<font color=#447700>!<a name='791'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='792'></font>
<a name='793'>
<font color=#447700>!  now, the real work.<a name='794'></font>
<font color=#447700>!  set the loop bounds taking into account boundary conditions.<a name='795'></font>
<a name='796'>
<a name='797'>
    IF( config_flags%nested .or. config_flags%specified ) THEN<a name='798'>
      i_start = max( its,ids+spec_zone )<a name='799'>
      i_end   = min( ite,ide-spec_zone-1 )<a name='800'>
      j_start = max( jts,jds+spec_zone )<a name='801'>
      j_end   = min( jte,jde-spec_zone-1 )<a name='802'>
      k_start = kts<a name='803'>
      k_end   = min( kte, kde-1 )<a name='804'>
<a name='805'>
      i_endu = min( ite,ide-spec_zone )<a name='806'>
      j_endv = min( jte,jde-spec_zone )<a name='807'>
      k_endw = k_end<a name='808'>
    ELSE<a name='809'>
      i_start = its<a name='810'>
      i_end   = ite<a name='811'>
      j_start = jts<a name='812'>
      j_end   = jte<a name='813'>
      k_start = kts<a name='814'>
      k_end   = kte-1<a name='815'>
<a name='816'>
      i_endu = i_end<a name='817'>
      j_endv = j_end<a name='818'>
      k_endw = k_end<a name='819'>
<a name='820'>
      IF(j_end == jde) j_end = j_end - 1<a name='821'>
      IF(i_end == ide) i_end = i_end - 1<a name='822'>
    ENDIF<a name='823'>
<a name='824'>
      i_start_up = i_start<a name='825'>
      i_end_up   = i_endu<a name='826'>
      j_start_up = j_start<a name='827'>
      j_end_up   = j_end<a name='828'>
<a name='829'>
      i_start_vp = i_start<a name='830'>
      i_end_vp   = i_end<a name='831'>
      j_start_vp = j_start<a name='832'>
      j_end_vp   = j_endv<a name='833'>
<a name='834'>
      IF ( (config_flags%open_xs   .or.     &amp;<a name='835'>
            config_flags%symmetric_xs   )   &amp;<a name='836'>
            .and. (its == ids) )            &amp;<a name='837'>
                 i_start_up = i_start_up + 1<a name='838'>
<a name='839'>
      IF ( (config_flags%open_xe    .or.  &amp;<a name='840'>
            config_flags%symmetric_xe   ) &amp;<a name='841'>
             .and. (ite == ide) )         &amp;<a name='842'>
                 i_end_up   = i_end_up - 1<a name='843'>
<a name='844'>
      IF ( (config_flags%open_ys    .or.   &amp;<a name='845'>
            config_flags%symmetric_ys   )  &amp;<a name='846'>
                     .and. (jts == jds) )  &amp;<a name='847'>
                 j_start_vp = j_start_vp + 1<a name='848'>
<a name='849'>
      IF ( (config_flags%open_ye     .or. &amp;<a name='850'>
            config_flags%symmetric_ye   ) &amp;<a name='851'>
            .and. (jte == jde) )          &amp;<a name='852'>
                 j_end_vp   = j_end_vp - 1<a name='853'>
<a name='854'>
      i_start_u_tend = i_start<a name='855'>
      i_end_u_tend   = i_endu<a name='856'>
      j_start_v_tend = j_start<a name='857'>
      j_end_v_tend   = j_endv<a name='858'>
<a name='859'>
      IF ( config_flags%symmetric_xs .and. (its == ids) ) &amp;<a name='860'>
                     i_start_u_tend = i_start_u_tend+1<a name='861'>
      IF ( config_flags%symmetric_xe .and. (ite == ide) ) &amp;<a name='862'>
                     i_end_u_tend = i_end_u_tend-1<a name='863'>
      IF ( config_flags%symmetric_ys .and. (jts == jds) ) &amp;<a name='864'>
                     j_start_v_tend = j_start_v_tend+1<a name='865'>
      IF ( config_flags%symmetric_ye .and. (jte == jde) ) &amp;<a name='866'>
                     j_end_v_tend = j_end_v_tend-1<a name='867'>
<a name='868'>
   dx = 1./rdx<a name='869'>
   dy = 1./rdy<a name='870'>
<a name='871'>
<font color=#447700>!  start real calculations.<a name='872'></font>
<font color=#447700>!  first, u<a name='873'></font>
<a name='874'>
  u_outer_j_loop: DO j = j_start, j_end<a name='875'>
<a name='876'>
   DO k = k_start, k_end<a name='877'>
   DO i = i_start_u_tend, i_end_u_tend<a name='878'>
     u(i,k,j) = u(i,k,j) + dts*ru_tend(i,k,j)<a name='879'>
   ENDDO<a name='880'>
   ENDDO<a name='881'>
<a name='882'>
   DO i = i_start_up, i_end_up<a name='883'>
     mudf_xy(i)= -emdiv*dx*(mudf(i,j)-mudf(i-1,j))<a name='884'>
   ENDDO<a name='885'>
<a name='886'>
   DO k = k_start, k_end<a name='887'>
   DO i = i_start_up, i_end_up<a name='888'>
<a name='889'>
     dpxy(i,k)= .5*rdx*muu(i,j)*(                               &amp;<a name='890'>
       ((ph (i,k+1,j)-ph (i-1,k+1,j))+(ph (i,k,j)-ph (i-1,k,j)))  &amp;<a name='891'>
      +(alt(i,k  ,j)+alt(i-1,k  ,j))*(p  (i,k,j)-p  (i-1,k,j))  &amp;<a name='892'>
      +(al (i,k  ,j)+al (i-1,k  ,j))*(pb (i,k,j)-pb (i-1,k,j)) ) <a name='893'>
<a name='894'>
   ENDDO<a name='895'>
   ENDDO<a name='896'>
<a name='897'>
   IF (non_hydrostatic) THEN<a name='898'>
<a name='899'>
     DO i = i_start_up, i_end_up<a name='900'>
       dpn(i,1) = .5*( cf1*(p(i,1,j)+p(i-1,1,j))  &amp;<a name='901'>
                      +cf2*(p(i,2,j)+p(i-1,2,j))  &amp;<a name='902'>
                      +cf3*(p(i,3,j)+p(i-1,3,j)) )<a name='903'>
       dpn(i,kde) = 0.<a name='904'>
     ENDDO<a name='905'>
<a name='906'>
     DO k = k_start+1, k_end<a name='907'>
       DO i = i_start_up, i_end_up<a name='908'>
         dpn(i,k) = .5*( fnm(k)*(p(i,k  ,j)+p(i-1,k  ,j))   &amp;<a name='909'>
                        +fnp(k)*(p(i,k-1,j)+p(i-1,k-1,j)) )<a name='910'>
       ENDDO<a name='911'>
     ENDDO<a name='912'>
<a name='913'>
     DO k = k_start, k_end<a name='914'>
       DO i = i_start_up, i_end_up<a name='915'>
         dpxy(i,k)=dpxy(i,k) + rdx*(php(i,k,j)-php(i-1,k,j))*        &amp;<a name='916'>
           (rdnw(k)*(dpn(i,k+1)-dpn(i,k))-.5*(mu(i-1,j)+mu(i,j)))<a name='917'>
       ENDDO<a name='918'>
     ENDDO<a name='919'>
<a name='920'>
 <a name='921'>
   END IF<a name='922'>
<a name='923'>
<a name='924'>
   DO k = k_start, k_end<a name='925'>
     DO i = i_start_up, i_end_up<a name='926'>
       u(i,k,j)=u(i,k,j)-dts*cqu(i,k,j)*dpxy(i,k)+mudf_xy(i)<a name='927'>
     ENDDO<a name='928'>
   ENDDO<a name='929'>
<a name='930'>
   ENDDO u_outer_j_loop<a name='931'>
<a name='932'>
<font color=#447700>! now v<a name='933'></font>
<a name='934'>
  v_outer_j_loop: DO j = j_start_v_tend, j_end_v_tend<a name='935'>
<a name='936'>
   DO k = k_start, k_end<a name='937'>
   DO i = i_start, i_end<a name='938'>
     v(i,k,j) = v(i,k,j) + dts*rv_tend(i,k,j)<a name='939'>
   ENDDO<a name='940'>
   ENDDO<a name='941'>
<a name='942'>
   DO i = i_start, i_end<a name='943'>
     mudf_xy(i)= -emdiv*dy*(mudf(i,j)-mudf(i,j-1))<a name='944'>
   ENDDO<a name='945'>
<a name='946'>
   IF (     ( j &gt;= j_start_vp)  &amp;<a name='947'>
       .and.( j &lt;= j_end_vp  ) )  THEN<a name='948'>
<a name='949'>
     DO k = k_start, k_end<a name='950'>
     DO i = i_start, i_end<a name='951'>
<a name='952'>
       dpxy(i,k)= .5*rdy*muv(i,j)*(                               &amp;<a name='953'>
        ((ph(i,k+1,j)-ph(i,k+1,j-1))+(ph (i,k,j)-ph (i,k,j-1)))   &amp;<a name='954'>
        +(alt(i,k  ,j)+alt(i,k  ,j-1))*(p  (i,k,j)-p  (i,k,j-1))  &amp;<a name='955'>
        +(al (i,k  ,j)+al (i,k  ,j-1))*(pb (i,k,j)-pb (i,k,j-1)) ) <a name='956'>
<a name='957'>
     ENDDO<a name='958'>
     ENDDO<a name='959'>
<a name='960'>
     IF (non_hydrostatic) THEN<a name='961'>
<a name='962'>
       DO i = i_start, i_end     <a name='963'>
         dpn(i,1) = .5*( cf1*(p(i,1,j)+p(i,1,j-1))  &amp;<a name='964'>
                        +cf2*(p(i,2,j)+p(i,2,j-1))  &amp;<a name='965'>
                        +cf3*(p(i,3,j)+p(i,3,j-1)) )<a name='966'>
         dpn(i,kde) = 0.<a name='967'>
       ENDDO<a name='968'>
<a name='969'>
       DO k = k_start+1, k_end<a name='970'>
         DO i = i_start, i_end<a name='971'>
           dpn(i,k) = .5*( fnm(k)*(p(i,k  ,j)+p(i,k  ,j-1))  &amp;<a name='972'>
                          +fnp(k)*(p(i,k-1,j)+p(i,k-1,j-1)) )<a name='973'>
         ENDDO<a name='974'>
       ENDDO<a name='975'>
<a name='976'>
       DO k = k_start, k_end<a name='977'>
         DO i = i_start, i_end<a name='978'>
           dpxy(i,k)=dpxy(i,k) + rdy*(php(i,k,j)-php(i,k,j-1))*    &amp;<a name='979'>
             (rdnw(k)*(dpn(i,k+1)-dpn(i,k))-.5*(mu(i,j-1)+mu(i,j)))<a name='980'>
         ENDDO<a name='981'>
       ENDDO<a name='982'>
<a name='983'>
<a name='984'>
     END IF<a name='985'>
<a name='986'>
<a name='987'>
     DO k = k_start, k_end<a name='988'>
       DO i = i_start, i_end<a name='989'>
         v(i,k,j)=v(i,k,j)-dts*cqv(i,k,j)*dpxy(i,k)+mudf_xy(i)<a name='990'>
       ENDDO<a name='991'>
     ENDDO<a name='992'>
<a name='993'>
   END IF<a name='994'>
<a name='995'>
  ENDDO  v_outer_j_loop<a name='996'>
<a name='997'>
<a name='998'>
END SUBROUTINE advance_uv<a name='999'>
<a name='1000'>
<font color=#447700>!---------------------------------------------------------------------<a name='1001'></font>
<a name='1002'>
<A NAME='ADVANCE_MU_T'><A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_MU_T' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1003'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advance_mu_t</font>( ww, ww_1, u, u_1, v, v_1,            &amp; <A href='../../call_to/ADVANCE_MU_T.html' TARGET='index'>12</A><a name='1004'>
                         mu, mut, muave, muts, muu, muv,      &amp;<a name='1005'>
                         mudf, uam, vam, wwam, t, t_1,        &amp;<a name='1006'>
                         t_ave, ft, mu_tend,                  &amp;<a name='1007'>
                         rdx, rdy, dts, epssm,                &amp;<a name='1008'>
                         dnw, fnm, fnp, rdnw,                 &amp;<a name='1009'>
                         msfu, msfv, msft,                    &amp;<a name='1010'>
                         step, config_flags,                  &amp;<a name='1011'>
                         ids, ide, jds, jde, kds, kde,        &amp;<a name='1012'>
                         ims, ime, jms, jme, kms, kme,        &amp;<a name='1013'>
                         its, ite, jts, jte, kts, kte        )<a name='1014'>
<a name='1015'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='1016'></font>
<a name='1017'>
<font color=#447700>! stuff coming in<a name='1018'></font>
<a name='1019'>
  TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='1020'>
<a name='1021'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='1022'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='1023'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='1024'>
<a name='1025'>
  INTEGER,      INTENT(IN   )    :: step<a name='1026'>
<a name='1027'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),   &amp;<a name='1028'>
            INTENT(IN   ) ::                       &amp;<a name='1029'>
                                              u,   &amp;<a name='1030'>
                                              v,   &amp;<a name='1031'>
                                              u_1, &amp;<a name='1032'>
                                              v_1, &amp;<a name='1033'>
                                              t_1, &amp;<a name='1034'>
                                              ft<a name='1035'>
<a name='1036'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),      &amp;<a name='1037'>
            INTENT(INOUT) ::                          &amp;<a name='1038'>
                                              ww,     &amp;<a name='1039'>
                                              ww_1,   &amp;<a name='1040'>
                                              t,      &amp;<a name='1041'>
                                              t_ave,  &amp;<a name='1042'>
                                              uam,    &amp;<a name='1043'>
                                              vam,    &amp;<a name='1044'>
                                              wwam<a name='1045'>
                                              <a name='1046'>
  REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(IN   ) :: muu,  &amp;<a name='1047'>
                                                            muv,  &amp;<a name='1048'>
                                                            mut,  &amp;<a name='1049'>
                                                            msfu, &amp;<a name='1050'>
                                                            msfv, &amp;<a name='1051'>
                                                            msft, &amp;<a name='1052'>
                                                            mu_tend<a name='1053'>
<a name='1054'>
  REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(  OUT) :: muave, &amp;<a name='1055'>
                                                            muts,  &amp;<a name='1056'>
                                                            mudf<a name='1057'>
<a name='1058'>
  REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(INOUT) :: mu<a name='1059'>
<a name='1060'>
  REAL, DIMENSION( kms:kme ),              INTENT(IN   ) :: fnm,    &amp;<a name='1061'>
                                                            fnp,    &amp;<a name='1062'>
                                                            dnw,    &amp;<a name='1063'>
                                                            rdnw<a name='1064'>
<a name='1065'>
<a name='1066'>
  REAL,                                    INTENT(IN   ) :: rdx,    &amp;<a name='1067'>
                                                            rdy,    &amp;<a name='1068'>
                                                            dts,    &amp;<a name='1069'>
                                                            epssm<a name='1070'>
<a name='1071'>
<font color=#447700>!  Local 3d array from the stack (note tile size)<a name='1072'></font>
<a name='1073'>
  REAL, DIMENSION (its:ite, kts:kte) :: wdtn, dvdxi<a name='1074'>
  REAL, DIMENSION (its:ite) :: dmdt<a name='1075'>
<a name='1076'>
  INTEGER :: i,j,k, i_start, i_end, j_start, j_end, k_start, k_end<a name='1077'>
  INTEGER :: i_endu, j_endv<a name='1078'>
  REAL    :: acc<a name='1079'>
<a name='1080'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1081'></font>
<font color=#447700>!<a name='1082'></font>
<font color=#447700>!  advance_mu_t advances the explicit perturbation theta equation and the mass<a name='1083'></font>
<font color=#447700>!  conservation equation.  In addition, the small timestep omega is updated,<a name='1084'></font>
<font color=#447700>!  and some quantities needed in other places are squirrelled away.<a name='1085'></font>
<font color=#447700>!<a name='1086'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1087'></font>
<a name='1088'>
<font color=#447700>!  now, the real work.<a name='1089'></font>
<font color=#447700>!  set the loop bounds taking into account boundary conditions.<a name='1090'></font>
<a name='1091'>
  i_start = its<a name='1092'>
  i_end   = ite<a name='1093'>
  j_start = jts<a name='1094'>
  j_end   = jte<a name='1095'>
  k_start = kts<a name='1096'>
  k_end   = kte-1<a name='1097'>
<a name='1098'>
<a name='1099'>
     <a name='1100'>
  i_endu = i_end<a name='1101'>
  j_endv = j_end<a name='1102'>
<a name='1103'>
  IF(j_end == jde) j_end = j_end - 1<a name='1104'>
  IF(i_end == ide) i_end = i_end - 1<a name='1105'>
<a name='1106'>
  IF ( (config_flags%specified .or. config_flags%nested) .and. (its == ids) ) &amp;<a name='1107'>
             i_start = i_start + 1<a name='1108'>
<a name='1109'>
  IF ( (config_flags%specified .or. config_flags%nested) .and. (ite == ide) ) &amp;<a name='1110'>
             i_end   = i_end - 1<a name='1111'>
<a name='1112'>
  IF ( (config_flags%specified .or. config_flags%nested) .and. (jts == jds) ) &amp;<a name='1113'>
             j_start = j_start + 1<a name='1114'>
<a name='1115'>
  IF ( (config_flags%specified .or. config_flags%nested) .and. (jte == jde) ) &amp;<a name='1116'>
             j_end   = j_end - 1<a name='1117'>
<a name='1118'>
<font color=#447700>!        CALCULATION OF WW (dETA/dt)<a name='1119'></font>
   DO j = j_start, j_end<a name='1120'>
<a name='1121'>
     DO i=i_start, i_end<a name='1122'>
       dmdt(i) = 0.<a name='1123'>
     ENDDO<a name='1124'>
<font color=#447700>!  NOTE:  mu is not coupled with the map scale factor.<a name='1125'></font>
<font color=#447700>!         ww (omega) IS coupled with the map scale factor.<a name='1126'></font>
<font color=#447700>!         Being coupled with the map scale factor means <a name='1127'></font>
<font color=#447700>!           multiplication by (1/msft) in this case.<a name='1128'></font>
<a name='1129'>
     DO k=k_start, k_end<a name='1130'>
     DO i=i_start, i_end<a name='1131'>
        dvdxi(i,k) = msft(i,j)*msft(i,j)*(                        &amp;<a name='1132'>
                     rdy*( (v(i,k,j+1)+muv(i,j+1)*v_1(i,k,j+1)/msfv(i,j+1))   &amp;<a name='1133'>
                          -(v(i,k,j  )+muv(i,j  )*v_1(i,k,j  )/msfv(i,j  )) ) &amp; <a name='1134'>
                    +rdx*( (u(i+1,k,j)+muu(i+1,j)*u_1(i+1,k,j)/msfu(i+1,j))   &amp;<a name='1135'>
                          -(u(i,k,j  )+muu(i  ,j)*u_1(i,k,j  )/msfu(i  ,j)) ) )<a name='1136'>
        dmdt(i)    = dmdt(i) + dnw(k)*dvdxi(i,k)<a name='1137'>
     ENDDO<a name='1138'>
     ENDDO<a name='1139'>
     DO i=i_start, i_end<a name='1140'>
       muave(i,j) = mu(i,j)<a name='1141'>
       mu(i,j) = mu(i,j)+dts*(dmdt(i)+mu_tend(i,j))<a name='1142'>
       mudf(i,j) = (dmdt(i)+mu_tend(i,j)) <font color=#447700>! save tendency for div damp filter<a name='1143'></font>
       muts(i,j) = mut(i,j)+mu(i,j)<a name='1144'>
       muave(i,j) =.5*((1.+epssm)*mu(i,j)+(1.-epssm)*muave(i,j))<a name='1145'>
     ENDDO<a name='1146'>
<a name='1147'>
     DO k=2,k_end<a name='1148'>
     DO i=i_start, i_end<a name='1149'>
       ww(i,k,j)=ww(i,k-1,j)-dnw(k-1)*(dmdt(i)+dvdxi(i,k-1)+mu_tend(i,j))/msft(i,j)<a name='1150'>
     ENDDO<a name='1151'>
     END DO<a name='1152'>
<a name='1153'>
<font color=#447700>!  NOTE:  ww_1 (large timestep ww) is already coupled with the <a name='1154'></font>
<font color=#447700>!         map scale factor<a name='1155'></font>
<a name='1156'>
     DO k=1,k_end<a name='1157'>
     DO i=i_start, i_end<a name='1158'>
       ww(i,k,j)=ww(i,k,j)-ww_1(i,k,j)<a name='1159'>
     END DO<a name='1160'>
     END DO<a name='1161'>
<a name='1162'>
   ENDDO<a name='1163'>
<a name='1164'>
<font color=#447700>! CALCULATION OF THETA<a name='1165'></font>
<a name='1166'>
<font color=#447700>! NOTE: theta'' is not coupled with the map-scale factor, <a name='1167'></font>
<font color=#447700>!       while the theta'' tendency is coupled (i.e., mult by 1/msft)<a name='1168'></font>
<a name='1169'>
   DO j=j_start, j_end<a name='1170'>
     DO k=1,k_end<a name='1171'>
     DO i=i_start, i_end<a name='1172'>
       t_ave(i,k,j) = t(i,k,j)<a name='1173'>
       t   (i,k,j) = t(i,k,j) + msft(i,j)*dts*ft(i,k,j)<a name='1174'>
     END DO<a name='1175'>
     END DO<a name='1176'>
   ENDDO   <a name='1177'>
<a name='1178'>
   DO j=j_start, j_end<a name='1179'>
<a name='1180'>
     DO i=i_start, i_end<a name='1181'>
       wdtn(i,1  )=0.<a name='1182'>
       wdtn(i,kde)=0.<a name='1183'>
     ENDDO<a name='1184'>
<a name='1185'>
     DO k=2,k_end<a name='1186'>
     DO i=i_start, i_end<a name='1187'>
        wdtn(i,k)= ww(i,k,j)*(fnm(k)*t_1(i,k  ,j)+fnp(k)*t_1(i,k-1,j))<a name='1188'>
     ENDDO<a name='1189'>
     ENDDO<a name='1190'>
<a name='1191'>
     DO k=1,k_end<a name='1192'>
     DO i=i_start, i_end<a name='1193'>
       t(i,k,j) = t(i,k,j) - dts*msft(i,j)*(               &amp;<a name='1194'>
                          msft(i,j)*(                      &amp;<a name='1195'>
               .5*rdy*                                     &amp;<a name='1196'>
              ( v(i,k,j+1)*(t_1(i,k,j+1)+t_1(i,k, j ))     &amp;<a name='1197'>
               -v(i,k,j  )*(t_1(i,k, j )+t_1(i,k,j-1)) )   &amp;<a name='1198'>
             + .5*rdx*                                     &amp;<a name='1199'>
              ( u(i+1,k,j)*(t_1(i+1,k,j)+t_1(i  ,k,j))     &amp;<a name='1200'>
               -u(i  ,k,j)*(t_1(i  ,k,j)+t_1(i-1,k,j)) ) ) &amp;<a name='1201'>
             + rdnw(k)*( wdtn(i,k+1)-wdtn(i,k) ) )       <a name='1202'>
     ENDDO<a name='1203'>
     ENDDO<a name='1204'>
<a name='1205'>
   ENDDO<a name='1206'>
<a name='1207'>
END SUBROUTINE advance_mu_t<a name='1208'>
          <a name='1209'>
<a name='1210'>
<a name='1211'>
<font color=#447700>!------------------------------------------------------------<a name='1212'></font>
<a name='1213'>
<A NAME='ADVANCE_W'><A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1214'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advance_w</font>( w, rw_tend, ww, u, v,       &amp; <A href='../../call_to/ADVANCE_W.html' TARGET='index'>12</A><a name='1215'>
                      mu1, mut, muave, muts,      &amp;<a name='1216'>
                      t_2ave, t_2, t_1,           &amp;<a name='1217'>
                      ph, ph_1, phb, ph_tend,     &amp;<a name='1218'>
                      ht, c2a, cqw, alt, alb,     &amp;<a name='1219'>
                      a, alpha, gamma,            &amp;<a name='1220'>
                      rdx, rdy, dts, t0, epssm,   &amp;<a name='1221'>
                      dnw, fnm, fnp, rdnw, rdn,   &amp;<a name='1222'>
                      cf1, cf2, cf3, msft,        &amp;<a name='1223'>
                      config_flags,               &amp;<a name='1224'>
                      ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1225'></font>
                      ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1226'></font>
                      its,ite, jts,jte, kts,kte  )  <font color=#447700>! tile   dims<a name='1227'></font>
<a name='1228'>
  IMPLICIT NONE <font color=#447700>! religion first<a name='1229'></font>
      <a name='1230'>
<font color=#447700>! stuff coming in<a name='1231'></font>
<a name='1232'>
<a name='1233'>
  TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='1234'>
<a name='1235'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='1236'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='1237'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='1238'>
<a name='1239'>
      REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), &amp;<a name='1240'>
            INTENT(INOUT) ::                          &amp;<a name='1241'>
                                             t_2ave,  &amp;<a name='1242'>
                                             w,       &amp;<a name='1243'>
                                             ph<a name='1244'>
<a name='1245'>
<a name='1246'>
      REAL, DIMENSION(  ims:ime , kms:kme, jms:jme ), &amp;<a name='1247'>
            INTENT(IN   ) ::                          &amp;<a name='1248'>
                                             rw_tend, &amp;<a name='1249'>
                                             ww,     &amp;<a name='1250'>
                                             u,       &amp;<a name='1251'>
                                             v,       &amp;<a name='1252'>
                                             t_2,     &amp;<a name='1253'>
                                             t_1,     &amp;<a name='1254'>
                                             ph_1,    &amp;<a name='1255'>
                                             phb,     &amp;<a name='1256'>
                                             ph_tend, &amp;<a name='1257'>
                                             alpha,   &amp;<a name='1258'>
                                             gamma,   &amp;<a name='1259'>
                                             a,       &amp;<a name='1260'>
                                             c2a,     &amp;<a name='1261'>
                                             cqw,     &amp;<a name='1262'>
                                             alb,     &amp;<a name='1263'>
                                             alt<a name='1264'>
<a name='1265'>
      REAL, DIMENSION( ims:ime , jms:jme ), &amp;<a name='1266'>
            INTENT(IN   )  ::               &amp;<a name='1267'>
                                   mu1,     &amp;<a name='1268'>
                                   mut,     &amp;<a name='1269'>
                                   muave,   &amp;<a name='1270'>
                                   muts,    &amp;<a name='1271'>
                                   ht,      &amp;<a name='1272'>
                                   msft<a name='1273'>
<a name='1274'>
      REAL, DIMENSION( kms:kme ),  INTENT(IN   )  :: fnp,     &amp;<a name='1275'>
                                                     fnm,     &amp;<a name='1276'>
                                                     rdnw,    &amp;<a name='1277'>
                                                     rdn,     &amp;<a name='1278'>
                                                     dnw<a name='1279'>
<a name='1280'>
      REAL,   INTENT(IN   )  :: rdx,     &amp;<a name='1281'>
                                rdy,     &amp;<a name='1282'>
                                dts,     &amp;<a name='1283'>
                                cf1,     &amp;<a name='1284'>
                                cf2,     &amp;<a name='1285'>
                                cf3,     &amp;<a name='1286'>
                                t0,      &amp;<a name='1287'>
                                epssm<a name='1288'>
<a name='1289'>
<font color=#447700>!  Stack based 3d data, tile size.<a name='1290'></font>
<a name='1291'>
      REAL, DIMENSION( its:ite ) :: mut_inv, msft_inv<a name='1292'>
      REAL, DIMENSION( its:ite, kts:kte ) :: rhs, wdwn<a name='1293'>
      INTEGER :: i,j,k, i_start, i_end, j_start, j_end, k_start, k_end<a name='1294'>
<a name='1295'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1296'></font>
<font color=#447700>!<a name='1297'></font>
<font color=#447700>!  advance_w advances the implicit w and geopotential equations.<a name='1298'></font>
<font color=#447700>!<a name='1299'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1300'></font>
<a name='1301'>
<font color=#447700>!  set loop limits.<a name='1302'></font>
<font color=#447700>!  currently set for periodic boundary conditions<a name='1303'></font>
      <a name='1304'>
      i_start = its<a name='1305'>
      i_end   = ite<a name='1306'>
      j_start = jts<a name='1307'>
      j_end   = jte<a name='1308'>
      k_start = kts<a name='1309'>
      k_end   = kte-1<a name='1310'>
<a name='1311'>
<a name='1312'>
      IF(j_end == jde) j_end = j_end - 1<a name='1313'>
      IF(i_end == ide) i_end = i_end - 1<a name='1314'>
<a name='1315'>
  IF ( (config_flags%specified .or. config_flags%nested) .and. (its == ids) ) &amp;<a name='1316'>
             i_start = i_start + 1<a name='1317'>
<a name='1318'>
  IF ( (config_flags%specified .or. config_flags%nested) .and. (ite == ide) ) &amp;<a name='1319'>
             i_end   = i_end - 1<a name='1320'>
<a name='1321'>
  IF ( (config_flags%specified .or. config_flags%nested) .and. (jts == jds) ) &amp;<a name='1322'>
             j_start = j_start + 1<a name='1323'>
<a name='1324'>
  IF ( (config_flags%specified .or. config_flags%nested) .and. (jte == jde) ) &amp;<a name='1325'>
             j_end   = j_end - 1<a name='1326'>
<a name='1327'>
<a name='1328'>
<font color=#447700>! calculation of phi and w equations<a name='1329'></font>
<a name='1330'>
    DO i=i_start, i_end<a name='1331'>
      rhs(i,1) = 0.<a name='1332'>
    ENDDO<a name='1333'>
<a name='1334'>
  j_loop_w:  DO j = j_start, j_end<a name='1335'>
    DO i=i_start, i_end<a name='1336'>
       mut_inv(i) = 1./mut(i,j)<a name='1337'>
       msft_inv(i) = 1./msft(i,j)<a name='1338'>
    ENDDO<a name='1339'>
    DO k=1, k_end<a name='1340'>
    DO i=i_start, i_end<a name='1341'>
      t_2ave(i,k,j)=.5*((1.+epssm)*t_2(i,k,j)       &amp;<a name='1342'>
                    +(1.-epssm)*t_2ave(i,k,j))<a name='1343'>
      t_2ave(i,k,j)=(t_2ave(i,k,j)-mu1(i,j)*t_1(i,k,j)) &amp;<a name='1344'>
                    /(muts(i,j)*(t0+t_1(i,k,j)))<a name='1345'>
    ENDDO<a name='1346'>
    ENDDO<a name='1347'>
<a name='1348'>
<a name='1349'>
    DO k=2,k_end+1<a name='1350'>
    DO i=i_start, i_end<a name='1351'>
      wdwn(i,k)=.5*(ww(i,k,j)+ww(i,k-1,j))*rdnw(k-1)    &amp;<a name='1352'>
           *(ph_1(i,k,j)-ph_1(i,k-1,j)+phb(i,k,j)-phb(i,k-1,j))<a name='1353'>
      rhs(i,k) = dts*(ph_tend(i,k,j) + .5*g*(1.-epssm)*w(i,k,j))<a name='1354'>
    ENDDO<a name='1355'>
    ENDDO<a name='1356'>
<a name='1357'>
    DO k=2,k_end<a name='1358'>
    DO i=i_start, i_end<a name='1359'>
       rhs(i,k) = rhs(i,k)-dts*( fnm(k)*wdwn(i,k+1)  &amp;<a name='1360'>
                                +fnp(k)*wdwn(i,k  ) )<a name='1361'>
    ENDDO<a name='1362'>
    ENDDO<a name='1363'>
<a name='1364'>
<font color=#447700>!  NOTE:  phi'' is not coupled with the map-scale factor  (1/m), <a name='1365'></font>
<font color=#447700>!         but it's tendency is, so must multiply by msft here<a name='1366'></font>
<a name='1367'>
    DO k=2,k_end+1<a name='1368'>
    DO i=i_start, i_end<a name='1369'>
      rhs(i,k) = ph(i,k,j) + msft(i,j)*rhs(i,k)*mut_inv(i)<a name='1370'>
    ENDDO<a name='1371'>
    ENDDO<a name='1372'>
<a name='1373'>
<font color=#447700>!  lower boundary condition on w<a name='1374'></font>
<a name='1375'>
    DO i=i_start, i_end<a name='1376'>
       w(i,1,j)=                                           &amp;<a name='1377'>
<a name='1378'>
                .5*rdy*(                                   &amp;<a name='1379'>
                         (ht(i,j+1)-ht(i,j  ))             &amp;<a name='1380'>
        *(cf1*v(i,1,j+1)+cf2*v(i,2,j+1)+cf3*v(i,3,j+1))    &amp;<a name='1381'>
                        +(ht(i,j  )-ht(i,j-1))             &amp;<a name='1382'>
        *(cf1*v(i,1,j  )+cf2*v(i,2,j  )+cf3*v(i,3,j  ))  ) &amp;<a name='1383'>
<a name='1384'>
               +.5*rdx*(                                   &amp;<a name='1385'>
                         (ht(i+1,j)-ht(i,j  ))             &amp;<a name='1386'>
        *(cf1*u(i+1,1,j)+cf2*u(i+1,2,j)+cf3*u(i+1,3,j))    &amp;<a name='1387'>
                        +(ht(i,j  )-ht(i-1,j))             &amp;<a name='1388'>
        *(cf1*u(i  ,1,j)+cf2*u(i  ,2,j)+cf3*u(i  ,3,j))  ) <a name='1389'>
<a name='1390'>
     ENDDO<a name='1391'>
<font color=#447700>!<a name='1392'></font>
<font color=#447700>! Jammed 3 doubly nested loops over k/i into 1 for slight improvement<a name='1393'></font>
<font color=#447700>! in efficiency.  No change in results (bit-for-bit). JM 20040514<a name='1394'></font>
<font color=#447700>! (left a blank line where the other two k/i-loops were)<a name='1395'></font>
<font color=#447700>!<a name='1396'></font>
    DO k=2,k_end<a name='1397'>
      DO i=i_start, i_end<a name='1398'>
        w(i,k,j)=w(i,k,j)+dts*rw_tend(i,k,j)                       &amp;<a name='1399'>
<a name='1400'>
                 + msft_inv(i)*cqw(i,k,j)*(                        &amp;<a name='1401'>
            +.5*dts*g*mut_inv(i)*rdn(k)*                           &amp;<a name='1402'>
             (c2a(i,k  ,j)*rdnw(k  )                               &amp;<a name='1403'>
        *((1.+epssm)*(rhs(i,k+1  )-rhs(i,k    ))                   &amp;<a name='1404'>
         +(1.-epssm)*(ph(i,k+1,j)-ph(i,k  ,j)))                    &amp;<a name='1405'>
             -c2a(i,k-1,j)*rdnw(k-1)                               &amp;<a name='1406'>
        *((1.+epssm)*(rhs(i,k    )-rhs(i,k-1  ))                   &amp;<a name='1407'>
         +(1.-epssm)*(ph(i,k  ,j)-ph(i,k-1,j)))))                  &amp;<a name='1408'>
<a name='1409'>
                +dts*g*msft_inv(i)*(rdn(k)*                        &amp;<a name='1410'>
             (c2a(i,k  ,j)*alt(i,k  ,j)*t_2ave(i,k  ,j)            &amp;<a name='1411'>
             -c2a(i,k-1,j)*alt(i,k-1,j)*t_2ave(i,k-1,j))           &amp;<a name='1412'>
               +(rdn(k)*(c2a(i,k  ,j)*alb(i,k  ,j)                 &amp;<a name='1413'>
                        -c2a(i,k-1,j)*alb(i,k-1,j))*mut_inv(i)-1.) &amp;<a name='1414'>
                     *muave(i,j))<a name='1415'>
      ENDDO<a name='1416'>
    ENDDO<a name='1417'>
<a name='1418'>
    K=k_end+1<a name='1419'>
<a name='1420'>
    DO i=i_start, i_end<a name='1421'>
       w(i,k,j)=w(i,k,j)+dts*rw_tend(i,k,j)                         &amp;<a name='1422'>
           +msft_inv(i)*(                                        &amp;<a name='1423'>
         -.5*dts*g*mut_inv(i)*rdnw(k-1)**2*2.*c2a(i,k-1,j)            &amp;<a name='1424'>
             *((1.+epssm)*(rhs(i,k  )-rhs(i,k-1  ))                 &amp;<a name='1425'>
              +(1.-epssm)*(ph(i,k,j)-ph(i,k-1,j)))                  &amp;<a name='1426'>
         -dts*g*(2.*rdnw(k-1)*                                      &amp;<a name='1427'>
                   c2a(i,k-1,j)*alt(i,k-1,j)*t_2ave(i,k-1,j)        &amp;<a name='1428'>
             +(1.+2.*rdnw(k-1)*c2a(i,k-1,j)*alb(i,k-1,j)*mut_inv(i))  &amp;<a name='1429'>
                        *muave(i,j)) )<a name='1430'>
    ENDDO<a name='1431'>
<a name='1432'>
    DO k=2,k_end+1<a name='1433'>
    DO i=i_start, i_end<a name='1434'>
       w(i,k,j)=(w(i,k,j)-a(i,k,j)*w(i,k-1,j))*alpha(i,k,j)<a name='1435'>
    ENDDO<a name='1436'>
    ENDDO<a name='1437'>
<a name='1438'>
    DO k=k_end,2,-1<a name='1439'>
    DO i=i_start, i_end<a name='1440'>
       w (i,k,j)=w (i,k,j)-gamma(i,k,j)*w(i,k+1,j)<a name='1441'>
    ENDDO<a name='1442'>
    ENDDO<a name='1443'>
<a name='1444'>
<font color=#447700>! NOTE:  phi'' is not coupled with the map-scale factor (1/m),<a name='1445'></font>
<font color=#447700>!        but the tendency is, so...<a name='1446'></font>
<font color=#447700>!        we must multiply tendency by msft here<a name='1447'></font>
<a name='1448'>
    DO k=2,k_end+1<a name='1449'>
    DO i=i_start, i_end<a name='1450'>
      ph(i,k,j) = rhs(i,k)+msft(i,j)*.5*dts*g*(1.+epssm) &amp;<a name='1451'>
                      *w(i,k,j)/muts(i,j)<a name='1452'>
    ENDDO<a name='1453'>
    ENDDO<a name='1454'>
<a name='1455'>
  ENDDO j_loop_w<a name='1456'>
<a name='1457'>
END SUBROUTINE advance_w<a name='1458'>
<a name='1459'>
<font color=#447700>!---------------------------------------------------------------------<a name='1460'></font>
<a name='1461'>
<A NAME='SUMFLUX'><A href='../../html_code/dyn_em/module_small_step_em.F.html#SUMFLUX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1462'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>sumflux</font> ( ru, rv, ww,                             &amp; <A href='../../call_to/SUMFLUX.html' TARGET='index'>12</A><a name='1463'>
                     u_lin, v_lin, ww_lin,                   &amp;<a name='1464'>
                     muu, muv,                               &amp;<a name='1465'>
                     ru_m, rv_m, ww_m, epssm,                &amp;<a name='1466'>
                     msfu, msfv,                             &amp;<a name='1467'>
                     iteration , number_of_small_timesteps,  &amp;<a name='1468'>
                     ids,ide, jds,jde, kds,kde,              &amp;<a name='1469'>
                     ims,ime, jms,jme, kms,kme,              &amp;<a name='1470'>
                     its,ite, jts,jte, kts,kte              )<a name='1471'>
<a name='1472'>
<a name='1473'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='1474'></font>
<a name='1475'>
<font color=#447700>! declarations for the stuff coming in<a name='1476'></font>
<a name='1477'>
  INTEGER,      INTENT(IN   )    :: number_of_small_timesteps<a name='1478'>
  INTEGER,      INTENT(IN   )    :: iteration<a name='1479'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='1480'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='1481'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='1482'>
<a name='1483'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),  INTENT(IN   ) :: ru, &amp;<a name='1484'>
                                                                rv, &amp;<a name='1485'>
                                                                ww, &amp;<a name='1486'>
                                                                u_lin,  &amp;<a name='1487'>
                                                                v_lin,  &amp;<a name='1488'>
                                                                ww_lin<a name='1489'>
<a name='1490'>
<a name='1491'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme) , INTENT(INOUT) :: ru_m, &amp;<a name='1492'>
                                                                rv_m, &amp;<a name='1493'>
                                                                ww_m<a name='1494'>
  REAL, DIMENSION(ims:ime, jms:jme) , INTENT(IN   ) :: muu, muv, msfu, msfv<a name='1495'>
<a name='1496'>
  REAL, INTENT(IN   )  ::  epssm<a name='1497'>
  INTEGER   :: i,j,k<a name='1498'>
<a name='1499'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1500'></font>
<font color=#447700>!<a name='1501'></font>
<font color=#447700>!  update the small-timestep time-averaged mass fluxes;  these<a name='1502'></font>
<font color=#447700>!  are needed for consistent mass-conserving scalar advection.<a name='1503'></font>
<font color=#447700>!<a name='1504'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1505'></font>
<a name='1506'>
    IF (iteration == 1 )THEN<a name='1507'>
      DO  j = jts, jte<a name='1508'>
      DO  k = kts, kte<a name='1509'>
      DO  i = its, ite<a name='1510'>
        ru_m(i,k,j)  = 0.<a name='1511'>
        rv_m(i,k,j)  = 0.<a name='1512'>
        ww_m(i,k,j)  = 0.<a name='1513'>
      ENDDO<a name='1514'>
      ENDDO<a name='1515'>
      ENDDO<a name='1516'>
    ENDIF<a name='1517'>
<a name='1518'>
    DO  j = jts, min(jde-1,jte)<a name='1519'>
    DO  k = kts, min(kde-1,kte)<a name='1520'>
    DO  i = its, ite<a name='1521'>
      ru_m(i,k,j)  = ru_m(i,k,j) + ru(i,k,j)<a name='1522'>
    ENDDO<a name='1523'>
    ENDDO<a name='1524'>
    ENDDO<a name='1525'>
<a name='1526'>
    DO  j = jts, jte<a name='1527'>
    DO  k = kts, min(kde-1,kte)<a name='1528'>
    DO  i = its, min(ide-1,ite)<a name='1529'>
      rv_m(i,k,j)  = rv_m(i,k,j) + rv(i,k,j)<a name='1530'>
    ENDDO<a name='1531'>
    ENDDO<a name='1532'>
    ENDDO<a name='1533'>
<a name='1534'>
    DO  j = jts, min(jde-1,jte)<a name='1535'>
    DO  k = kts, kte<a name='1536'>
    DO  i = its, min(ide-1,ite)<a name='1537'>
      ww_m(i,k,j)  = ww_m(i,k,j) + ww(i,k,j)<a name='1538'>
    ENDDO<a name='1539'>
    ENDDO<a name='1540'>
    ENDDO<a name='1541'>
<a name='1542'>
  IF (iteration == number_of_small_timesteps) THEN<a name='1543'>
<a name='1544'>
    DO  j = jts, min(jde-1,jte)<a name='1545'>
    DO  k = kts, min(kde-1,kte)<a name='1546'>
    DO  i = its, ite<a name='1547'>
      ru_m(i,k,j)  = ru_m(i,k,j) / number_of_small_timesteps   &amp;<a name='1548'>
                     + muu(i,j)*u_lin(i,k,j)/msfu(i,j)<a name='1549'>
   <a name='1550'>
    ENDDO<a name='1551'>
    ENDDO<a name='1552'>
    ENDDO<a name='1553'>
<a name='1554'>
    DO  j = jts, jte<a name='1555'>
    DO  k = kts, min(kde-1,kte)<a name='1556'>
    DO  i = its, min(ide-1,ite)<a name='1557'>
      rv_m(i,k,j)  = rv_m(i,k,j) / number_of_small_timesteps   &amp;<a name='1558'>
                     + muv(i,j)*v_lin(i,k,j)/msfv(i,j)<a name='1559'>
    ENDDO<a name='1560'>
    ENDDO<a name='1561'>
    ENDDO<a name='1562'>
<a name='1563'>
    DO  j = jts, min(jde-1,jte)<a name='1564'>
    DO  k = kts, kte<a name='1565'>
    DO  i = its, min(ide-1,ite)<a name='1566'>
      ww_m(i,k,j)  = ww_m(i,k,j) / number_of_small_timesteps   &amp;<a name='1567'>
                     + ww_lin(i,k,j)<a name='1568'>
    ENDDO<a name='1569'>
    ENDDO<a name='1570'>
    ENDDO<a name='1571'>
<a name='1572'>
  ENDIF<a name='1573'>
<a name='1574'>
<a name='1575'>
END SUBROUTINE sumflux <a name='1576'>
<a name='1577'>
<font color=#447700>!---------------------------------------------------------------------<a name='1578'></font>
<a name='1579'>
<A NAME='INIT_MODULE_SMALL_STEP'><A href='../../html_code/dyn_em/module_small_step_em.F.html#INIT_MODULE_SMALL_STEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1580'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_module_small_step</font><a name='1581'>
  END SUBROUTINE init_module_small_step<a name='1582'>
<a name='1583'>
END MODULE module_small_step_em<a name='1584'>
</pre></body></html>