<HTML> <BODY BGCOLOR=#cceeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:DYNAMICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_ADVECT_EM'><A href='../../html_code/dyn_em/module_advect_em.F.html#MODULE_ADVECT_EM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>module_advect_em</font> <A href='../../call_to/MODULE_ADVECT_EM.html' TARGET='index'>5</A><a name='5'>
<a name='6'>
  USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/dyn_em/module_advect_em.F.html#module_advect_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_2"><a name='7'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_advect_em.F.html#module_advect_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_1"><a name='8'>
  USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/dyn_em/module_advect_em.F.html#module_advect_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_1"><a name='9'>
<a name='10'>
CONTAINS<a name='11'>
<a name='12'>
<a name='13'>
<A NAME='MASS_FLUX_DIVERGENCE'><A href='../../html_code/dyn_em/module_advect_em.F.html#MASS_FLUX_DIVERGENCE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='14'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>mass_flux_divergence</font> ( field, field_old, tendency,    &amp;<a name='15'>
                                  ru, rv, rom,                   &amp;<a name='16'>
                                  mut, config_flags,             &amp;<a name='17'>
                                  msfu, msfv, msft,              &amp;<a name='18'>
                                  fzm, fzp,                      &amp;<a name='19'>
                                  rdx, rdy, rdzw,                &amp;<a name='20'>
                                  ids, ide, jds, jde, kds, kde,  &amp;<a name='21'>
                                  ims, ime, jms, jme, kms, kme,  &amp;<a name='22'>
                                  its, ite, jts, jte, kts, kte  )<a name='23'>
<a name='24'>
   IMPLICIT NONE<a name='25'>
   <a name='26'>
   <font color=#447700>! Input data<a name='27'></font>
   <a name='28'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='29'>
<a name='30'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='31'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='32'>
                                              its, ite, jts, jte, kts, kte<a name='33'>
<a name='34'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field,     &amp;<a name='35'>
                                                                      field_old, &amp;<a name='36'>
                                                                      ru,        &amp;<a name='37'>
                                                                      rv,        &amp;<a name='38'>
                                                                      rom<a name='39'>
<a name='40'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='41'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='42'>
<a name='43'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfu,  &amp;<a name='44'>
                                                                    msfv,  &amp;<a name='45'>
                                                                    msft<a name='46'>
<a name='47'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='48'>
                                                                  fzp,  &amp;<a name='49'>
                                                                  rdzw<a name='50'>
<a name='51'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='52'>
                                                                  rdy<a name='53'>
<a name='54'>
   <font color=#447700>! Local data<a name='55'></font>
   <a name='56'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='57'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='58'>
   INTEGER :: imin, imax, jmin, jmax<a name='59'>
<a name='60'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw<a name='61'>
   REAL , DIMENSION(its:ite,kts:kte) :: vflux<a name='62'>
<a name='63'>
   LOGICAL :: specified<a name='64'>
<a name='65'>
<font color=#447700>!--------------- horizontal flux<a name='66'></font>
<a name='67'>
   specified = .false.<a name='68'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='69'>
<a name='70'>
   ktf=MIN(kte,kde-1)<a name='71'>
   i_start = its<a name='72'>
   i_end   = MIN(ite,ide-1)<a name='73'>
   j_start = jts<a name='74'>
   j_end   = MIN(jte,jde-1)<a name='75'>
<a name='76'>
   DO j = j_start, j_end<a name='77'>
   DO k = kts, ktf<a name='78'>
   DO i = i_start, i_end<a name='79'>
      mrdx=msft(i,j)*rdx<a name='80'>
      tendency(i,k,j)=tendency(i,k,j)-mrdx*0.5 &amp;<a name='81'>
                      *(ru(i+1,k,j)*(field(i+1,k,j)+field(i  ,k,j)) &amp;<a name='82'>
                       -ru(i  ,k,j)*(field(i  ,k,j)+field(i-1,k,j)))<a name='83'>
   ENDDO<a name='84'>
   ENDDO<a name='85'>
   ENDDO<a name='86'>
<a name='87'>
   DO j = j_start, j_end<a name='88'>
   DO k = kts, ktf<a name='89'>
   DO i = i_start, i_end<a name='90'>
      mrdy=msft(i,j)*rdy<a name='91'>
      tendency(i,k,j)=tendency(i,k,j) -mrdy*0.5 &amp;<a name='92'>
                      *(rv(i,k,j+1)*(field(i,k,j+1)+field(i,k,j  )) &amp;<a name='93'>
                       -rv(i,k,j  )*(field(i,k,j  )+field(i,k,j-1))) <a name='94'>
   ENDDO<a name='95'>
   ENDDO<a name='96'>
   ENDDO<a name='97'>
   <a name='98'>
<font color=#447700>!----------------  vertical flux divergence<a name='99'></font>
<a name='100'>
<a name='101'>
   DO i = i_start, i_end<a name='102'>
      vflux(i,kts)=0.<a name='103'>
      vflux(i,kte)=0.<a name='104'>
   ENDDO<a name='105'>
<a name='106'>
   DO j = j_start, j_end<a name='107'>
<a name='108'>
      DO k = kts+1, ktf<a name='109'>
      DO i = i_start, i_end<a name='110'>
         vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='111'>
      ENDDO<a name='112'>
      ENDDO<a name='113'>
<a name='114'>
      DO k = kts, ktf<a name='115'>
      DO i = i_start, i_end<a name='116'>
         tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='117'>
      ENDDO<a name='118'>
      ENDDO<a name='119'>
<a name='120'>
   ENDDO<a name='121'>
   <a name='122'>
END SUBROUTINE mass_flux_divergence<a name='123'>
<a name='124'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='125'></font>
<a name='126'>
<A NAME='ADVECT_U'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_U' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='127'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_u</font>   ( u, u_old, tendency,            &amp; <A href='../../call_to/ADVECT_U.html' TARGET='index'>2</A>,<A href='../../call_from/ADVECT_U.html' TARGET='index'>2</A><a name='128'>
                        ru, rv, rom,                   &amp;<a name='129'>
                        mut, config_flags,             &amp;<a name='130'>
                        msfu, msfv, msft,              &amp;<a name='131'>
                        fzm, fzp,                      &amp;<a name='132'>
                        rdx, rdy, rdzw,                &amp;<a name='133'>
                        ids, ide, jds, jde, kds, kde,  &amp;<a name='134'>
                        ims, ime, jms, jme, kms, kme,  &amp;<a name='135'>
                        its, ite, jts, jte, kts, kte  )<a name='136'>
<a name='137'>
   IMPLICIT NONE<a name='138'>
   <a name='139'>
   <font color=#447700>! Input data<a name='140'></font>
   <a name='141'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='142'>
<a name='143'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='144'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='145'>
                                              its, ite, jts, jte, kts, kte<a name='146'>
<a name='147'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: u,     &amp;<a name='148'>
                                                                      u_old, &amp;<a name='149'>
                                                                      ru,    &amp;<a name='150'>
                                                                      rv,    &amp;<a name='151'>
                                                                      rom<a name='152'>
<a name='153'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='154'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='155'>
<a name='156'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfu,  &amp;<a name='157'>
                                                                    msfv,  &amp;<a name='158'>
                                                                    msft<a name='159'>
<a name='160'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='161'>
                                                                  fzp,  &amp;<a name='162'>
                                                                  rdzw<a name='163'>
<a name='164'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='165'>
                                                                  rdy<a name='166'>
<a name='167'>
   <font color=#447700>! Local data<a name='168'></font>
   <a name='169'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='170'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='171'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='172'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax, im, ip<a name='173'>
   INTEGER :: jp1, jp0, jtmp<a name='174'>
<a name='175'>
   INTEGER :: horz_order, vert_order<a name='176'>
<a name='177'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw, dvm, dvp<a name='178'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='179'>
<a name='180'>
<a name='181'>
   REAL,  DIMENSION( its-1:ite+1, kts:kte ) :: fqx<a name='182'>
   REAL,  DIMENSION( its:ite, kts:kte, 2) :: fqy<a name='183'>
   <a name='184'>
   LOGICAL :: degrade_xs, degrade_ys<a name='185'>
   LOGICAL :: degrade_xe, degrade_ye<a name='186'>
<a name='187'>
<font color=#447700>! definition of flux operators, 3rd, 4rth, 5th or 6th order<a name='188'></font>
<a name='189'>
   REAL    :: flux3, flux4, flux5, flux6<a name='190'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='191'>
<a name='192'>
   flux4(q_im2, q_im1, q_i, q_ip1, ua) =                         &amp;<a name='193'>
            (7./12.)*(q_i + q_im1) - (1./12.)*(q_ip1 + q_im2)<a name='194'>
<a name='195'>
   flux3(q_im2, q_im1, q_i, q_ip1, ua) =                         &amp;<a name='196'>
            flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='197'>
            sign(1.,ua)*(1./12.)*((q_ip1 - q_im2)-3.*(q_i-q_im1))<a name='198'>
<a name='199'>
   flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =           &amp;<a name='200'>
            (37./60.)*(q_i+q_im1) - (2./15.)*(q_ip1+q_im2)       &amp;<a name='201'>
            +(1./60.)*(q_ip2+q_im3)<a name='202'>
<a name='203'>
   flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =           &amp;<a name='204'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)     &amp;<a name='205'>
            -sign(1.,ua)*(1./60.)*(                              &amp;<a name='206'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )<a name='207'>
<a name='208'>
<a name='209'>
   LOGICAL :: specified<a name='210'>
<a name='211'>
   specified = .false.<a name='212'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='213'>
<a name='214'>
<font color=#447700>!  set order for vertical and horzontal flux operators<a name='215'></font>
<a name='216'>
   horz_order = config_flags%h_mom_adv_order<a name='217'>
   vert_order = config_flags%v_mom_adv_order<a name='218'>
<a name='219'>
   ktf=MIN(kte,kde-1)<a name='220'>
<a name='221'>
<font color=#447700>!  begin with horizontal flux divergence<a name='222'></font>
<a name='223'>
   horizontal_order_test : IF( horz_order == 6 ) THEN<a name='224'>
<a name='225'>
<font color=#447700>!  determine boundary mods for flux operators<a name='226'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='227'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='228'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='229'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='230'></font>
<font color=#447700>!   of the higher order flux stencils<a name='231'></font>
<a name='232'>
      degrade_xs = .true.<a name='233'>
      degrade_xe = .true.<a name='234'>
      degrade_ys = .true.<a name='235'>
      degrade_ye = .true.<a name='236'>
<a name='237'>
      IF( config_flags%periodic_x   .or. &amp;<a name='238'>
          config_flags%symmetric_xs .or. &amp;<a name='239'>
          (its &gt; ids+2)                ) degrade_xs = .false.<a name='240'>
      IF( config_flags%periodic_x   .or. &amp;<a name='241'>
          config_flags%symmetric_xe .or. &amp;<a name='242'>
          (ite &lt; ide-2)                ) degrade_xe = .false.<a name='243'>
      IF( config_flags%periodic_y   .or. &amp;<a name='244'>
          config_flags%symmetric_ys .or. &amp;<a name='245'>
          (jts &gt; jds+2)                ) degrade_ys = .false.<a name='246'>
      IF( config_flags%periodic_y   .or. &amp;<a name='247'>
          config_flags%symmetric_ye .or. &amp;<a name='248'>
          (jte &lt; jde-3)                ) degrade_ye = .false.<a name='249'>
<a name='250'>
<font color=#447700>!--------------- y - advection first<a name='251'></font>
<a name='252'>
      i_start = its<a name='253'>
      i_end   = ite<a name='254'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='255'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='256'>
<a name='257'>
      j_start = jts<a name='258'>
      j_end   = MIN(jte,jde-1)<a name='259'>
<a name='260'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='261'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='262'></font>
<a name='263'>
      j_start_f = j_start<a name='264'>
      j_end_f   = j_end+1<a name='265'>
<a name='266'>
      IF(degrade_ys) then<a name='267'>
        j_start = MAX(jts,jds+1)<a name='268'>
        j_start_f = jds+3<a name='269'>
      ENDIF<a name='270'>
<a name='271'>
      IF(degrade_ye) then<a name='272'>
        j_end = MIN(jte,jde-2)<a name='273'>
        j_end_f = jde-3<a name='274'>
      ENDIF<a name='275'>
<a name='276'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='277'></font>
<a name='278'>
     jp1 = 2<a name='279'>
     jp0 = 1<a name='280'>
<a name='281'>
     j_loop_y_flux_6 : DO j = j_start, j_end+1<a name='282'>
<a name='283'>
        IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN  <font color=#447700>! use full stencil<a name='284'></font>
<a name='285'>
           DO k=kts,ktf<a name='286'>
           DO i = i_start, i_end<a name='287'>
              vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='288'>
              fqy( i, k, jp1 ) = vel*flux6(                                &amp;<a name='289'>
                                 u(i,k,j-3), u(i,k,j-2), u(i,k,j-1),       &amp;<a name='290'>
                                 u(i,k,j  ), u(i,k,j+1), u(i,k,j+2),  vel )<a name='291'>
           ENDDO<a name='292'>
           ENDDO<a name='293'>
<a name='294'>
<font color=#447700>!  we must be close to some boundary where we need to reduce the order of the stencil<a name='295'></font>
<a name='296'>
        ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='297'></font>
<a name='298'>
           DO k=kts,ktf<a name='299'>
           DO i = i_start, i_end<a name='300'>
              fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))  &amp;<a name='301'>
                                    *(u(i,k,j)+u(i,k,j-1))<a name='302'>
           ENDDO<a name='303'>
           ENDDO<a name='304'>
<a name='305'>
        ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4rth order flux 2 in from south boundary<a name='306'></font>
<a name='307'>
           DO k=kts,ktf<a name='308'>
           DO i = i_start, i_end<a name='309'>
              vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='310'>
              fqy( i, k, jp1 ) = vel*flux4(      &amp;<a name='311'>
                   u(i,k,j-2),u(i,k,j-1), u(i,k,j),u(i,k,j+1),vel )<a name='312'>
           ENDDO<a name='313'>
           ENDDO<a name='314'>
<a name='315'>
        ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='316'></font>
<a name='317'>
           DO k=kts,ktf<a name='318'>
           DO i = i_start, i_end<a name='319'>
              fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))    &amp;<a name='320'>
                     *(u(i,k,j)+u(i,k,j-1))<a name='321'>
           ENDDO<a name='322'>
           ENDDO<a name='323'>
<a name='324'>
        ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4rth order flux 2 in from north boundary<a name='325'></font>
<a name='326'>
           DO k=kts,ktf<a name='327'>
           DO i = i_start, i_end<a name='328'>
              vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='329'>
              fqy( i, k, jp1 ) = vel*flux4(     &amp;<a name='330'>
                   u(i,k,j-2),u(i,k,j-1),    &amp;<a name='331'>
                   u(i,k,j),u(i,k,j+1),vel )<a name='332'>
           ENDDO<a name='333'>
           ENDDO<a name='334'>
<a name='335'>
        END IF<a name='336'>
<a name='337'>
<font color=#447700>!stopped<a name='338'></font>
<a name='339'>
<font color=#447700>!  y flux-divergence into tendency<a name='340'></font>
<a name='341'>
        IF(j &gt; j_start) THEN<a name='342'>
<a name='343'>
          DO k=kts,ktf<a name='344'>
          DO i = i_start, i_end<a name='345'>
            mrdy=msfu(i,j-1)*rdy<a name='346'>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='347'>
          ENDDO<a name='348'>
          ENDDO<a name='349'>
<a name='350'>
        ENDIF<a name='351'>
<a name='352'>
<a name='353'>
        jtmp = jp1<a name='354'>
        jp1 = jp0<a name='355'>
        jp0 = jtmp<a name='356'>
<a name='357'>
   ENDDO j_loop_y_flux_6<a name='358'>
<a name='359'>
<font color=#447700>!  next, x - flux divergence<a name='360'></font>
<a name='361'>
      i_start = its<a name='362'>
      i_end   = ite<a name='363'>
<a name='364'>
      j_start = jts<a name='365'>
      j_end   = MIN(jte,jde-1)<a name='366'>
<a name='367'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='368'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='369'></font>
<a name='370'>
      i_start_f = i_start<a name='371'>
      i_end_f   = i_end+1<a name='372'>
<a name='373'>
      IF(degrade_xs) then<a name='374'>
        i_start = MAX(ids+1,its)<a name='375'>
        i_start_f = ids+3<a name='376'>
      ENDIF<a name='377'>
<a name='378'>
      IF(degrade_xe) then<a name='379'>
        i_end = MIN(ide-1,ite)<a name='380'>
        i_end_f = ide-2<a name='381'>
      ENDIF<a name='382'>
<a name='383'>
<font color=#447700>!  compute fluxes<a name='384'></font>
<a name='385'>
      DO j = j_start, j_end<a name='386'>
<a name='387'>
<font color=#447700>!  5th or 6th order flux<a name='388'></font>
<a name='389'>
        DO k=kts,ktf<a name='390'>
        DO i = i_start_f, i_end_f<a name='391'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='392'>
          fqx( i,k ) = vel*flux6( u(i-3,k,j), u(i-2,k,j),  &amp;<a name='393'>
                                         u(i-1,k,j), u(i  ,k,j),  &amp;<a name='394'>
                                         u(i+1,k,j), u(i+2,k,j),  &amp;<a name='395'>
                                         vel                     )<a name='396'>
        ENDDO<a name='397'>
        ENDDO<a name='398'>
<a name='399'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='400'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='401'></font>
<a name='402'>
        IF( degrade_xs ) THEN<a name='403'>
<a name='404'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='405'></font>
            i = ids+1<a name='406'>
            DO k=kts,ktf<a name='407'>
              ub = u(i-1,k,j)<a name='408'>
              IF (specified .AND. u(i,k,j) .LT. 0.)ub = u(i,k,j)<a name='409'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='410'>
                     *(u(i,k,j)+ub)<a name='411'>
            ENDDO<a name='412'>
          END IF<a name='413'>
<a name='414'>
          i = ids+2<a name='415'>
          DO k=kts,ktf<a name='416'>
            vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='417'>
            fqx( i, k  ) = vel*flux4( u(i-2,k,j), u(i-1,k,j),  &amp;<a name='418'>
                                           u(i  ,k,j), u(i+1,k,j),  &amp;<a name='419'>
                                           vel                     )<a name='420'>
          ENDDO<a name='421'>
<a name='422'>
        ENDIF<a name='423'>
<a name='424'>
        IF( degrade_xe ) THEN<a name='425'>
<a name='426'>
          IF( i_end == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='427'></font>
            i = ide<a name='428'>
            DO k=kts,ktf<a name='429'>
              ub = u(i,k,j)<a name='430'>
              IF (specified .AND. u(i-1,k,j) .GT. 0.)ub = u(i-1,k,j)<a name='431'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='432'>
                     *(u(i-1,k,j)+ub)<a name='433'>
            ENDDO<a name='434'>
          ENDIF<a name='435'>
<a name='436'>
          DO k=kts,ktf<a name='437'>
          i = ide-1<a name='438'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='439'>
          fqx( i,k ) = vel*flux4( u(i-2,k,j), u(i-1,k,j),  &amp;<a name='440'>
                                         u(i  ,k,j), u(i+1,k,j),  &amp;<a name='441'>
                                         vel                     )<a name='442'>
          ENDDO<a name='443'>
<a name='444'>
        ENDIF<a name='445'>
<a name='446'>
<font color=#447700>!  x flux-divergence into tendency<a name='447'></font>
<a name='448'>
        DO k=kts,ktf<a name='449'>
          DO i = i_start, i_end<a name='450'>
            mrdx=msfu(i,j)*rdx<a name='451'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='452'>
          ENDDO<a name='453'>
        ENDDO<a name='454'>
<a name='455'>
      ENDDO<a name='456'>
<a name='457'>
   ELSE IF( horz_order == 5 ) THEN<a name='458'>
<a name='459'>
<font color=#447700>!  5th order horizontal flux calculation<a name='460'></font>
<font color=#447700>!  This code is EXACTLY the same as the 6th order code<a name='461'></font>
<font color=#447700>!  EXCEPT the 5th order and 3rd operators are used in<a name='462'></font>
<font color=#447700>!  place of the 6th and 4rth order operators<a name='463'></font>
<a name='464'>
<font color=#447700>!  determine boundary mods for flux operators<a name='465'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='466'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='467'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='468'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='469'></font>
<font color=#447700>!   of the higher order flux stencils<a name='470'></font>
<a name='471'>
   degrade_xs = .true.<a name='472'>
   degrade_xe = .true.<a name='473'>
   degrade_ys = .true.<a name='474'>
   degrade_ye = .true.<a name='475'>
<a name='476'>
   IF( config_flags%periodic_x   .or. &amp;<a name='477'>
       config_flags%symmetric_xs .or. &amp;<a name='478'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='479'>
   IF( config_flags%periodic_x   .or. &amp;<a name='480'>
       config_flags%symmetric_xe .or. &amp;<a name='481'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='482'>
   IF( config_flags%periodic_y   .or. &amp;<a name='483'>
       config_flags%symmetric_ys .or. &amp;<a name='484'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='485'>
   IF( config_flags%periodic_y   .or. &amp;<a name='486'>
       config_flags%symmetric_ye .or. &amp;<a name='487'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='488'>
<a name='489'>
<font color=#447700>!--------------- y - advection first<a name='490'></font>
<a name='491'>
      i_start = its<a name='492'>
      i_end   = ite<a name='493'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='494'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='495'>
<a name='496'>
      j_start = jts<a name='497'>
      j_end   = MIN(jte,jde-1)<a name='498'>
<a name='499'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='500'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='501'></font>
<a name='502'>
      j_start_f = j_start<a name='503'>
      j_end_f   = j_end+1<a name='504'>
<a name='505'>
      IF(degrade_ys) then<a name='506'>
        j_start = MAX(jts,jds+1)<a name='507'>
        j_start_f = jds+3<a name='508'>
      ENDIF<a name='509'>
<a name='510'>
      IF(degrade_ye) then<a name='511'>
        j_end = MIN(jte,jde-2)<a name='512'>
        j_end_f = jde-3<a name='513'>
      ENDIF<a name='514'>
<a name='515'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='516'></font>
<a name='517'>
     jp1 = 2<a name='518'>
     jp0 = 1<a name='519'>
<a name='520'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='521'>
<a name='522'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN  <font color=#447700>! use full stencil<a name='523'></font>
<a name='524'>
        DO k=kts,ktf<a name='525'>
        DO i = i_start, i_end<a name='526'>
          vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='527'>
          fqy( i, k, jp1 ) = vel*flux5(               &amp;<a name='528'>
                  u(i,k,j-3), u(i,k,j-2), u(i,k,j-1),       &amp;<a name='529'>
                  u(i,k,j  ), u(i,k,j+1), u(i,k,j+2),  vel )<a name='530'>
        ENDDO<a name='531'>
        ENDDO<a name='532'>
<a name='533'>
<font color=#447700>!  we must be close to some boundary where we need to reduce the order of the stencil<a name='534'></font>
<a name='535'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='536'></font>
<a name='537'>
            DO k=kts,ktf<a name='538'>
            DO i = i_start, i_end<a name='539'>
              fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))  &amp;<a name='540'>
                                     *(u(i,k,j)+u(i,k,j-1))<a name='541'>
            ENDDO<a name='542'>
            ENDDO<a name='543'>
<a name='544'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4rth order flux 2 in from south boundary<a name='545'></font>
<a name='546'>
            DO k=kts,ktf<a name='547'>
            DO i = i_start, i_end<a name='548'>
              vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='549'>
              fqy( i, k, jp1 ) = vel*flux3(      &amp;<a name='550'>
                   u(i,k,j-2),u(i,k,j-1), u(i,k,j),u(i,k,j+1),vel )<a name='551'>
            ENDDO<a name='552'>
            ENDDO<a name='553'>
<a name='554'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='555'></font>
<a name='556'>
            DO k=kts,ktf<a name='557'>
            DO i = i_start, i_end<a name='558'>
              fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))    &amp;<a name='559'>
                     *(u(i,k,j)+u(i,k,j-1))<a name='560'>
            ENDDO<a name='561'>
            ENDDO<a name='562'>
<a name='563'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4rth order flux 2 in from north boundary<a name='564'></font>
<a name='565'>
            DO k=kts,ktf<a name='566'>
            DO i = i_start, i_end<a name='567'>
              vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='568'>
              fqy( i, k, jp1 ) = vel*flux3(     &amp;<a name='569'>
                   u(i,k,j-2),u(i,k,j-1),    &amp;<a name='570'>
                   u(i,k,j),u(i,k,j+1),vel )<a name='571'>
            ENDDO<a name='572'>
            ENDDO<a name='573'>
<a name='574'>
      END IF<a name='575'>
<a name='576'>
<font color=#447700>!  y flux-divergence into tendency<a name='577'></font>
<a name='578'>
        IF(j &gt; j_start) THEN<a name='579'>
<a name='580'>
          DO k=kts,ktf<a name='581'>
          DO i = i_start, i_end<a name='582'>
            mrdy=msfu(i,j-1)*rdy<a name='583'>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='584'>
          ENDDO<a name='585'>
          ENDDO<a name='586'>
<a name='587'>
        ENDIF<a name='588'>
<a name='589'>
<a name='590'>
        jtmp = jp1<a name='591'>
        jp1 = jp0<a name='592'>
        jp0 = jtmp<a name='593'>
<a name='594'>
   ENDDO j_loop_y_flux_5<a name='595'>
<a name='596'>
<font color=#447700>!  next, x - flux divergence<a name='597'></font>
<a name='598'>
      i_start = its<a name='599'>
      i_end   = ite<a name='600'>
<a name='601'>
      j_start = jts<a name='602'>
      j_end   = MIN(jte,jde-1)<a name='603'>
<a name='604'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='605'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='606'></font>
<a name='607'>
      i_start_f = i_start<a name='608'>
      i_end_f   = i_end+1<a name='609'>
<a name='610'>
      IF(degrade_xs) then<a name='611'>
        i_start = MAX(ids+1,its)<a name='612'>
        i_start_f = ids+3<a name='613'>
      ENDIF<a name='614'>
<a name='615'>
      IF(degrade_xe) then<a name='616'>
        i_end = MIN(ide-1,ite)<a name='617'>
        i_end_f = ide-2<a name='618'>
      ENDIF<a name='619'>
<a name='620'>
<font color=#447700>!  compute fluxes<a name='621'></font>
<a name='622'>
      DO j = j_start, j_end<a name='623'>
<a name='624'>
<font color=#447700>!  5th or 6th order flux<a name='625'></font>
<a name='626'>
        DO k=kts,ktf<a name='627'>
        DO i = i_start_f, i_end_f<a name='628'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='629'>
          fqx( i,k ) = vel*flux5( u(i-3,k,j), u(i-2,k,j),  &amp;<a name='630'>
                                         u(i-1,k,j), u(i  ,k,j),  &amp;<a name='631'>
                                         u(i+1,k,j), u(i+2,k,j),  &amp;<a name='632'>
                                         vel                     )<a name='633'>
        ENDDO<a name='634'>
        ENDDO<a name='635'>
<a name='636'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='637'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='638'></font>
<a name='639'>
        IF( degrade_xs ) THEN<a name='640'>
<a name='641'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='642'></font>
            i = ids+1<a name='643'>
            DO k=kts,ktf<a name='644'>
              ub = u(i-1,k,j)<a name='645'>
              IF (specified .AND. u(i,k,j) .LT. 0.)ub = u(i,k,j)<a name='646'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='647'>
                     *(u(i,k,j)+ub)<a name='648'>
            ENDDO<a name='649'>
          END IF<a name='650'>
<a name='651'>
          i = ids+2<a name='652'>
          DO k=kts,ktf<a name='653'>
            vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='654'>
            fqx( i, k  ) = vel*flux3( u(i-2,k,j), u(i-1,k,j),  &amp;<a name='655'>
                                           u(i  ,k,j), u(i+1,k,j),  &amp;<a name='656'>
                                           vel                     )<a name='657'>
          ENDDO<a name='658'>
<a name='659'>
        ENDIF<a name='660'>
<a name='661'>
        IF( degrade_xe ) THEN<a name='662'>
<a name='663'>
          IF( i_end == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='664'></font>
            i = ide<a name='665'>
            DO k=kts,ktf<a name='666'>
              ub = u(i,k,j)<a name='667'>
              IF (specified .AND. u(i-1,k,j) .GT. 0.)ub = u(i-1,k,j)<a name='668'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='669'>
                     *(u(i-1,k,j)+ub)<a name='670'>
            ENDDO<a name='671'>
          ENDIF<a name='672'>
<a name='673'>
          DO k=kts,ktf<a name='674'>
          i = ide-1<a name='675'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='676'>
          fqx( i,k ) = vel*flux3( u(i-2,k,j), u(i-1,k,j),  &amp;<a name='677'>
                                         u(i  ,k,j), u(i+1,k,j),  &amp;<a name='678'>
                                         vel                     )<a name='679'>
          ENDDO<a name='680'>
<a name='681'>
        ENDIF<a name='682'>
<a name='683'>
<font color=#447700>!  x flux-divergence into tendency<a name='684'></font>
<a name='685'>
        DO k=kts,ktf<a name='686'>
          DO i = i_start, i_end<a name='687'>
            mrdx=msfu(i,j)*rdx<a name='688'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='689'>
          ENDDO<a name='690'>
        ENDDO<a name='691'>
<a name='692'>
      ENDDO<a name='693'>
<a name='694'>
   ELSE IF( horz_order == 4 ) THEN<a name='695'>
<a name='696'>
<font color=#447700>!  determine boundary mods for flux operators<a name='697'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='698'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='699'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='700'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='701'></font>
<font color=#447700>!   of the higher order flux stencils<a name='702'></font>
<a name='703'>
   degrade_xs = .true.<a name='704'>
   degrade_xe = .true.<a name='705'>
   degrade_ys = .true.<a name='706'>
   degrade_ye = .true.<a name='707'>
<a name='708'>
   IF( config_flags%periodic_x   .or. &amp;<a name='709'>
       config_flags%symmetric_xs .or. &amp;<a name='710'>
       (its &gt; ids+1)                ) degrade_xs = .false.<a name='711'>
   IF( config_flags%periodic_x   .or. &amp;<a name='712'>
       config_flags%symmetric_xe .or. &amp;<a name='713'>
       (ite &lt; ide-1)                ) degrade_xe = .false.<a name='714'>
   IF( config_flags%periodic_y   .or. &amp;<a name='715'>
       config_flags%symmetric_ys .or. &amp;<a name='716'>
       (jts &gt; jds+1)                ) degrade_ys = .false.<a name='717'>
   IF( config_flags%periodic_y   .or. &amp;<a name='718'>
       config_flags%symmetric_ye .or. &amp;<a name='719'>
       (jte &lt; jde-2)                ) degrade_ye = .false.<a name='720'>
<a name='721'>
<font color=#447700>!--------------- x - advection first<a name='722'></font>
<a name='723'>
      i_start = its<a name='724'>
      i_end   = ite<a name='725'>
      j_start = jts<a name='726'>
      j_end   = MIN(jte,jde-1)<a name='727'>
<a name='728'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='729'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='730'></font>
<a name='731'>
      i_start_f = i_start<a name='732'>
      i_end_f   = i_end+1<a name='733'>
<a name='734'>
      IF(degrade_xs) then<a name='735'>
        i_start = ids+1<a name='736'>
        i_start_f = i_start+1<a name='737'>
      ENDIF<a name='738'>
<a name='739'>
      IF(degrade_xe) then<a name='740'>
        i_end = ide-1<a name='741'>
        i_end_f = ide-1<a name='742'>
      ENDIF<a name='743'>
<a name='744'>
<font color=#447700>!  compute fluxes<a name='745'></font>
<a name='746'>
      DO j = j_start, j_end<a name='747'>
<a name='748'>
        DO k=kts,ktf<a name='749'>
        DO i = i_start_f, i_end_f<a name='750'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='751'>
          fqx( i, k ) = vel*flux4( u(i-2,k,j), u(i-1,k,j),      &amp;<a name='752'>
                                   u(i  ,k,j), u(i+1,k,j), vel )<a name='753'>
        ENDDO<a name='754'>
        ENDDO<a name='755'>
<a name='756'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='757'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='758'></font>
<a name='759'>
        IF( degrade_xs ) THEN<a name='760'>
          i = i_start<a name='761'>
          DO k=kts,ktf<a name='762'>
              ub = u(i-1,k,j)<a name='763'>
              IF (specified .AND. u(i,k,j) .LT. 0.)ub = u(i,k,j)<a name='764'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='765'>
                     *(u(i,k,j)+ub)<a name='766'>
          ENDDO<a name='767'>
        ENDIF<a name='768'>
<a name='769'>
        IF( degrade_xe ) THEN<a name='770'>
          i = i_end+1<a name='771'>
          DO k=kts,ktf<a name='772'>
              ub = u(i,k,j)<a name='773'>
              IF (specified .AND. u(i-1,k,j) .GT. 0.)ub = u(i-1,k,j)<a name='774'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='775'>
                     *(u(i-1,k,j)+ub)<a name='776'>
          ENDDO<a name='777'>
        ENDIF<a name='778'>
<a name='779'>
<font color=#447700>!  x flux-divergence into tendency<a name='780'></font>
<a name='781'>
        DO k=kts,ktf<a name='782'>
          DO i = i_start, i_end<a name='783'>
            mrdx=msfu(i,j)*rdx<a name='784'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='785'>
          ENDDO<a name='786'>
        ENDDO<a name='787'>
<a name='788'>
      ENDDO<a name='789'>
<a name='790'>
<font color=#447700>!  y flux divergence<a name='791'></font>
<a name='792'>
      i_start = its<a name='793'>
      i_end   = ite<a name='794'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='795'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='796'>
<a name='797'>
      j_start = jts<a name='798'>
      j_end   = MIN(jte,jde-1)<a name='799'>
<a name='800'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='801'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='802'></font>
<a name='803'>
      j_start_f = j_start<a name='804'>
      j_end_f   = j_end+1<a name='805'>
<a name='806'>
<font color=#447700>!CJM these may not work with tiling because they define j_start and end in terms of domain dim<a name='807'></font>
      IF(degrade_ys) then<a name='808'>
        j_start = jds+1<a name='809'>
        j_start_f = j_start+1<a name='810'>
      ENDIF<a name='811'>
<a name='812'>
      IF(degrade_ye) then<a name='813'>
        j_end = jde-2<a name='814'>
        j_end_f = jde-2<a name='815'>
      ENDIF<a name='816'>
<a name='817'>
<font color=#447700>!  j flux loop for v flux of u momentum<a name='818'></font>
<a name='819'>
     jp1 = 2<a name='820'>
     jp0 = 1<a name='821'>
<a name='822'>
   DO j = j_start, j_end+1<a name='823'>
<a name='824'>
     IF ( (j &lt; j_start_f) .and. degrade_ys) THEN<a name='825'>
       DO k = kts, ktf<a name='826'>
       DO i = i_start, i_end<a name='827'>
         fqy(i, k, jp1) = 0.25*(rv(i,k,j_start)+rv(i-1,k,j_start))  &amp;<a name='828'>
               *(u(i,k,j_start)+u(i,k,j_start-1))<a name='829'>
       ENDDO<a name='830'>
       ENDDO<a name='831'>
     ELSE IF ((j &gt; j_end_f) .and. degrade_ye) THEN<a name='832'>
       DO k = kts, ktf<a name='833'>
       DO i = i_start, i_end<a name='834'>
         fqy(i, k, jp1) = 0.25*(rv(i,k,j_end+1)+rv(i-1,k,j_end+1))    &amp;<a name='835'>
                *(u(i,k,j_end+1)+u(i,k,j_end))<a name='836'>
       ENDDO<a name='837'>
       ENDDO<a name='838'>
     ELSE<a name='839'>
<font color=#447700>!  3rd or 4rth order flux<a name='840'></font>
       DO k = kts, ktf<a name='841'>
       DO i = i_start, i_end<a name='842'>
         vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='843'>
         fqy( i, k, jp1 ) = vel*flux4( u(i,k,j-2), u(i,k,j-1),  &amp;<a name='844'>
                                       u(i,k,j  ), u(i,k,j+1),  &amp;<a name='845'>
                                            vel                )<a name='846'>
       ENDDO<a name='847'>
       ENDDO<a name='848'>
<a name='849'>
     END IF<a name='850'>
<a name='851'>
     IF (j &gt; j_start) THEN<a name='852'>
<a name='853'>
<font color=#447700>!  y flux-divergence into tendency<a name='854'></font>
<a name='855'>
       DO k=kts,ktf<a name='856'>
       DO i = i_start, i_end<a name='857'>
          mrdy=msfu(i,j-1)*rdy<a name='858'>
          tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='859'>
       ENDDO<a name='860'>
       ENDDO<a name='861'>
<a name='862'>
     END IF<a name='863'>
<a name='864'>
     jtmp = jp1<a name='865'>
     jp1 = jp0<a name='866'>
     jp0 = jtmp<a name='867'>
<a name='868'>
  ENDDO<a name='869'>
<a name='870'>
  ELSE IF ( horz_order == 3 ) THEN<a name='871'>
<a name='872'>
<font color=#447700>!  As with the 5th and 6th order flux chioces, the 3rd and 4rth order<a name='873'></font>
<font color=#447700>!  code is EXACTLY the same EXCEPT for the flux operator.<a name='874'></font>
<a name='875'>
<font color=#447700>!  determine boundary mods for flux operators<a name='876'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='877'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='878'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='879'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='880'></font>
<font color=#447700>!   of the higher order flux stencils<a name='881'></font>
<a name='882'>
   degrade_xs = .true.<a name='883'>
   degrade_xe = .true.<a name='884'>
   degrade_ys = .true.<a name='885'>
   degrade_ye = .true.<a name='886'>
<a name='887'>
   IF( config_flags%periodic_x   .or. &amp;<a name='888'>
       config_flags%symmetric_xs .or. &amp;<a name='889'>
       (its &gt; ids+1)                ) degrade_xs = .false.<a name='890'>
   IF( config_flags%periodic_x   .or. &amp;<a name='891'>
       config_flags%symmetric_xe .or. &amp;<a name='892'>
       (ite &lt; ide-1)                ) degrade_xe = .false.<a name='893'>
   IF( config_flags%periodic_y   .or. &amp;<a name='894'>
       config_flags%symmetric_ys .or. &amp;<a name='895'>
       (jts &gt; jds+1)                ) degrade_ys = .false.<a name='896'>
   IF( config_flags%periodic_y   .or. &amp;<a name='897'>
       config_flags%symmetric_ye .or. &amp;<a name='898'>
       (jte &lt; jde-2)                ) degrade_ye = .false.<a name='899'>
<a name='900'>
<font color=#447700>!--------------- x - advection first<a name='901'></font>
<a name='902'>
      i_start = its<a name='903'>
      i_end   = ite<a name='904'>
      j_start = jts<a name='905'>
      j_end   = MIN(jte,jde-1)<a name='906'>
<a name='907'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='908'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='909'></font>
<a name='910'>
      i_start_f = i_start<a name='911'>
      i_end_f   = i_end+1<a name='912'>
<a name='913'>
      IF(degrade_xs) then<a name='914'>
        i_start = ids+1<a name='915'>
        i_start_f = i_start+1<a name='916'>
      ENDIF<a name='917'>
<a name='918'>
      IF(degrade_xe) then<a name='919'>
        i_end = ide-1<a name='920'>
        i_end_f = ide-1<a name='921'>
      ENDIF<a name='922'>
<a name='923'>
<font color=#447700>!  compute fluxes<a name='924'></font>
<a name='925'>
      DO j = j_start, j_end<a name='926'>
<a name='927'>
        DO k=kts,ktf<a name='928'>
        DO i = i_start_f, i_end_f<a name='929'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='930'>
          fqx( i, k ) = vel*flux3( u(i-2,k,j), u(i-1,k,j),      &amp;<a name='931'>
                                   u(i  ,k,j), u(i+1,k,j), vel )<a name='932'>
        ENDDO<a name='933'>
        ENDDO<a name='934'>
<a name='935'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='936'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='937'></font>
<a name='938'>
        IF( degrade_xs ) THEN<a name='939'>
          i = i_start<a name='940'>
          DO k=kts,ktf<a name='941'>
              ub = u(i-1,k,j)<a name='942'>
              IF (specified .AND. u(i,k,j) .LT. 0.)ub = u(i,k,j)<a name='943'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='944'>
                     *(u(i,k,j)+ub)<a name='945'>
          ENDDO<a name='946'>
        ENDIF<a name='947'>
<a name='948'>
        IF( degrade_xe ) THEN<a name='949'>
          i = i_end+1<a name='950'>
          DO k=kts,ktf<a name='951'>
              ub = u(i,k,j)<a name='952'>
              IF (specified .AND. u(i-1,k,j) .GT. 0.)ub = u(i-1,k,j)<a name='953'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='954'>
                     *(u(i-1,k,j)+ub)<a name='955'>
          ENDDO<a name='956'>
        ENDIF<a name='957'>
<a name='958'>
<font color=#447700>!  x flux-divergence into tendency<a name='959'></font>
<a name='960'>
        DO k=kts,ktf<a name='961'>
          DO i = i_start, i_end<a name='962'>
          mrdx=msfu(i,j)*rdx<a name='963'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='964'>
          ENDDO<a name='965'>
        ENDDO<a name='966'>
      ENDDO<a name='967'>
<a name='968'>
<font color=#447700>!  y flux divergence<a name='969'></font>
<a name='970'>
      i_start = its<a name='971'>
      i_end   = ite<a name='972'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='973'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='974'>
<a name='975'>
      j_start = jts<a name='976'>
      j_end   = MIN(jte,jde-1)<a name='977'>
<a name='978'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='979'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='980'></font>
<a name='981'>
      j_start_f = j_start<a name='982'>
      j_end_f   = j_end+1<a name='983'>
<a name='984'>
<font color=#447700>!CJM these may not work with tiling because they define j_start and end in terms of domain dim<a name='985'></font>
      IF(degrade_ys) then<a name='986'>
        j_start = jds+1<a name='987'>
        j_start_f = j_start+1<a name='988'>
      ENDIF<a name='989'>
<a name='990'>
      IF(degrade_ye) then<a name='991'>
        j_end = jde-2<a name='992'>
        j_end_f = jde-2<a name='993'>
      ENDIF<a name='994'>
<a name='995'>
<font color=#447700>!  j flux loop for v flux of u momentum<a name='996'></font>
<a name='997'>
     jp1 = 2<a name='998'>
     jp0 = 1<a name='999'>
<a name='1000'>
   DO j = j_start, j_end+1<a name='1001'>
<a name='1002'>
     IF ( (j &lt; j_start_f) .and. degrade_ys) THEN<a name='1003'>
       DO k = kts, ktf<a name='1004'>
       DO i = i_start, i_end<a name='1005'>
         fqy(i, k, jp1) = 0.25*(rv(i,k,j_start)+rv(i-1,k,j_start))  &amp;<a name='1006'>
               *(u(i,k,j_start)+u(i,k,j_start-1))<a name='1007'>
       ENDDO<a name='1008'>
       ENDDO<a name='1009'>
     ELSE IF ((j &gt; j_end_f) .and. degrade_ye) THEN<a name='1010'>
       DO k = kts, ktf<a name='1011'>
       DO i = i_start, i_end<a name='1012'>
         fqy(i, k, jp1) = 0.25*(rv(i,k,j_end+1)+rv(i-1,k,j_end+1))    &amp;<a name='1013'>
                *(u(i,k,j_end+1)+u(i,k,j_end))<a name='1014'>
       ENDDO<a name='1015'>
       ENDDO<a name='1016'>
     ELSE<a name='1017'>
<font color=#447700>!  3rd or 4rth order flux<a name='1018'></font>
       DO k = kts, ktf<a name='1019'>
       DO i = i_start, i_end<a name='1020'>
         vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='1021'>
         fqy( i, k, jp1 ) = vel*flux3( u(i,k,j-2), u(i,k,j-1),  &amp;<a name='1022'>
                                       u(i,k,j  ), u(i,k,j+1),  &amp;<a name='1023'>
                                            vel                )<a name='1024'>
       ENDDO<a name='1025'>
       ENDDO<a name='1026'>
<a name='1027'>
     END IF<a name='1028'>
<a name='1029'>
     IF (j &gt; j_start) THEN<a name='1030'>
<a name='1031'>
<font color=#447700>!  y flux-divergence into tendency<a name='1032'></font>
<a name='1033'>
       DO k=kts,ktf<a name='1034'>
       DO i = i_start, i_end<a name='1035'>
          mrdy=msfu(i,j-1)*rdy<a name='1036'>
          tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='1037'>
       ENDDO<a name='1038'>
       ENDDO<a name='1039'>
<a name='1040'>
     END IF<a name='1041'>
<a name='1042'>
     jtmp = jp1<a name='1043'>
     jp1 = jp0<a name='1044'>
     jp0 = jtmp<a name='1045'>
<a name='1046'>
  ENDDO<a name='1047'>
<a name='1048'>
  ELSE IF ( horz_order == 2 ) THEN<a name='1049'>
<a name='1050'>
      i_start = its<a name='1051'>
      i_end   = ite<a name='1052'>
      j_start = jts<a name='1053'>
      j_end   = MIN(jte,jde-1)<a name='1054'>
<a name='1055'>
      IF ( config_flags%open_xs ) i_start = MAX(ids+1,its)<a name='1056'>
      IF ( config_flags%open_xe ) i_end   = MIN(ide-1,ite)<a name='1057'>
      IF ( specified ) i_start = MAX(ids+2,its)<a name='1058'>
      IF ( specified ) i_end   = MIN(ide-2,ite)<a name='1059'>
<a name='1060'>
      DO j = j_start, j_end<a name='1061'>
      DO k=kts,ktf<a name='1062'>
      DO i = i_start, i_end<a name='1063'>
         mrdx=msfu(i,j)*rdx<a name='1064'>
         tendency(i,k,j)=tendency(i,k,j)-mrdx*0.25 &amp;<a name='1065'>
                *((ru(i+1,k,j)+ru(i,k,j))*(u(i+1,k,j)+u(i,k,j)) &amp;<a name='1066'>
                -(ru(i,k,j)+ru(i-1,k,j))*(u(i,k,j)+u(i-1,k,j)))<a name='1067'>
      ENDDO<a name='1068'>
      ENDDO<a name='1069'>
      ENDDO<a name='1070'>
<a name='1071'>
      IF ( specified .AND. its .LE. ids+1 ) THEN<a name='1072'>
        DO j = j_start, j_end<a name='1073'>
        DO k=kts,ktf<a name='1074'>
           i = ids+1<a name='1075'>
           mrdx=msfu(i,j)*rdx<a name='1076'>
           ub = u(i-1,k,j)<a name='1077'>
           IF (u(i,k,j) .LT. 0.) ub = u(i,k,j)<a name='1078'>
           tendency(i,k,j)=tendency(i,k,j)-mrdx*0.25 &amp;<a name='1079'>
                  *((ru(i+1,k,j)+ru(i,k,j))*(u(i+1,k,j)+u(i,k,j)) &amp;<a name='1080'>
                  -(ru(i,k,j)+ru(i-1,k,j))*(u(i,k,j)+ub))<a name='1081'>
        ENDDO<a name='1082'>
        ENDDO<a name='1083'>
      ENDIF<a name='1084'>
      IF ( specified .AND. ite .GE. ide-1 ) THEN<a name='1085'>
        DO j = j_start, j_end<a name='1086'>
        DO k=kts,ktf<a name='1087'>
           i = ide-1<a name='1088'>
           mrdx=msfu(i,j)*rdx<a name='1089'>
           ub = u(i+1,k,j)<a name='1090'>
           IF (u(i,k,j) .GT. 0.) ub = u(i,k,j)<a name='1091'>
           tendency(i,k,j)=tendency(i,k,j)-mrdx*0.25 &amp;<a name='1092'>
                  *((ru(i+1,k,j)+ru(i,k,j))*(ub+u(i,k,j)) &amp;<a name='1093'>
                  -(ru(i,k,j)+ru(i-1,k,j))*(u(i,k,j)+u(i-1,k,j)))<a name='1094'>
        ENDDO<a name='1095'>
        ENDDO<a name='1096'>
      ENDIF<a name='1097'>
<a name='1098'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='1099'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='1100'>
<a name='1101'>
      DO j = j_start, j_end<a name='1102'>
      DO k=kts,ktf<a name='1103'>
      DO i = i_start, i_end<a name='1104'>
         mrdy=msfu(i,j)*rdy<a name='1105'>
            tendency(i,k,j)=tendency(i,k,j)-mrdy*0.25 &amp;<a name='1106'>
                *((rv(i,k,j+1)+rv(i-1,k,j+1))*(u(i,k,j+1)+u(i,k,j)) &amp;<a name='1107'>
                 -(rv(i,k,j)+rv(i-1,k,j))*(u(i,k,j)+u(i,k,j-1)))<a name='1108'>
      ENDDO<a name='1109'>
      ENDDO<a name='1110'>
      ENDDO<a name='1111'>
<a name='1112'>
   ELSE<a name='1113'>
<a name='1114'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_u_6a:  h_order not known ',horz_order<a name='1115'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_8"> ( TRIM( wrf_err_message ) )<a name='1116'>
<a name='1117'>
   ENDIF horizontal_order_test<a name='1118'>
<a name='1119'>
<font color=#447700>!  radiative lateral boundary condition in x for normal velocity (u)<a name='1120'></font>
<a name='1121'>
      IF ( (config_flags%open_xs) .and. its == ids ) THEN<a name='1122'>
<a name='1123'>
        j_start = jts<a name='1124'>
        j_end   = MIN(jte,jde-1)<a name='1125'>
<a name='1126'>
        DO j = j_start, j_end<a name='1127'>
        DO k = kts, ktf<a name='1128'>
          ub = MIN(ru(its,k,j)-cb*mut(its,j), 0.)<a name='1129'>
          tendency(its,k,j) = tendency(its,k,j)                    &amp;<a name='1130'>
                      - rdx*ub*(u_old(its+1,k,j) - u_old(its,k,j))<a name='1131'>
        ENDDO<a name='1132'>
        ENDDO<a name='1133'>
<a name='1134'>
      ENDIF<a name='1135'>
<a name='1136'>
      IF ( (config_flags%open_xe) .and. ite == ide ) THEN<a name='1137'>
<a name='1138'>
        j_start = jts<a name='1139'>
        j_end   = MIN(jte,jde-1)<a name='1140'>
<a name='1141'>
        DO j = j_start, j_end<a name='1142'>
        DO k = kts, ktf<a name='1143'>
          ub = MAX(ru(ite,k,j)+cb*mut(ite-1,j), 0.)<a name='1144'>
          tendency(ite,k,j) = tendency(ite,k,j)                    &amp;<a name='1145'>
                      - rdx*ub*(u_old(ite,k,j) - u_old(ite-1,k,j))<a name='1146'>
        ENDDO<a name='1147'>
        ENDDO<a name='1148'>
<a name='1149'>
      ENDIF<a name='1150'>
<a name='1151'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='1152'></font>
<font color=#447700>!  (these are the computations that don't require 'cb')<a name='1153'></font>
<font color=#447700>!  first, set to index ranges<a name='1154'></font>
<a name='1155'>
      i_start = its<a name='1156'>
      i_end   = MIN(ite,ide)<a name='1157'>
      imin    = ids<a name='1158'>
      imax    = ide-1<a name='1159'>
<a name='1160'>
      IF (config_flags%open_xs) THEN<a name='1161'>
        i_start = MAX(ids+1, its)<a name='1162'>
        imin = ids<a name='1163'>
      ENDIF<a name='1164'>
      IF (config_flags%open_xe) THEN<a name='1165'>
        i_end = MIN(ite,ide-1)<a name='1166'>
        imax = ide-1<a name='1167'>
      ENDIF<a name='1168'>
<a name='1169'>
   IF( (config_flags%open_ys) .and. (jts == jds)) THEN<a name='1170'>
<a name='1171'>
      DO i = i_start, i_end<a name='1172'>
<a name='1173'>
         mrdy=msfu(i,jts)*rdy<a name='1174'>
         ip = MIN( imax, i   )<a name='1175'>
         im = MAX( imin, i-1 )<a name='1176'>
<a name='1177'>
         DO k=kts,ktf<a name='1178'>
<a name='1179'>
          vw = 0.5*(rv(ip,k,jts)+rv(im,k,jts))<a name='1180'>
          vb = MIN( vw, 0. )<a name='1181'>
          dvm =  rv(ip,k,jts+1)-rv(ip,k,jts)<a name='1182'>
          dvp =  rv(im,k,jts+1)-rv(im,k,jts)<a name='1183'>
          tendency(i,k,jts)=tendency(i,k,jts)-mrdy*(                &amp;<a name='1184'>
                            vb*(u_old(i,k,jts+1)-u_old(i,k,jts))    &amp;<a name='1185'>
                           +0.5*u(i,k,jts)*(dvm+dvp))<a name='1186'>
         ENDDO<a name='1187'>
      ENDDO<a name='1188'>
<a name='1189'>
   ENDIF<a name='1190'>
<a name='1191'>
   IF( (config_flags%open_ye) .and. (jte == jde)) THEN<a name='1192'>
<a name='1193'>
      DO i = i_start, i_end<a name='1194'>
<a name='1195'>
         mrdy=msfu(i,jte-1)*rdy<a name='1196'>
         ip = MIN( imax, i   )<a name='1197'>
         im = MAX( imin, i-1 )<a name='1198'>
<a name='1199'>
         DO k=kts,ktf<a name='1200'>
<a name='1201'>
          vw = 0.5*(rv(ip,k,jte)+rv(im,k,jte))<a name='1202'>
          vb = MAX( vw, 0. )<a name='1203'>
          dvm =  rv(ip,k,jte)-rv(ip,k,jte-1)<a name='1204'>
          dvp =  rv(im,k,jte)-rv(im,k,jte-1)<a name='1205'>
          tendency(i,k,jte-1)=tendency(i,k,jte-1)-mrdy*(              &amp;<a name='1206'>
                              vb*(u_old(i,k,jte-1)-u_old(i,k,jte-2))  &amp;<a name='1207'>
                             +0.5*u(i,k,jte-1)*(dvm+dvp))<a name='1208'>
         ENDDO<a name='1209'>
      ENDDO<a name='1210'>
<a name='1211'>
   ENDIF<a name='1212'>
<a name='1213'>
<font color=#447700>!-------------------- vertical advection<a name='1214'></font>
<a name='1215'>
   i_start = its<a name='1216'>
   i_end   = ite<a name='1217'>
   j_start = jts<a name='1218'>
   j_end   = min(jte,jde-1)<a name='1219'>
<a name='1220'>
<font color=#447700>!   IF ( config_flags%open_xs ) i_start = MAX(ids+1,its)<a name='1221'></font>
<font color=#447700>!   IF ( config_flags%open_xe ) i_end   = MIN(ide-1,ite)<a name='1222'></font>
<a name='1223'>
   IF ( config_flags%open_ys .or. specified ) i_start = MAX(ids+1,its)<a name='1224'>
   IF ( config_flags%open_ye .or. specified ) i_end   = MIN(ide-1,ite)<a name='1225'>
<a name='1226'>
   DO i = i_start, i_end<a name='1227'>
     vflux(i,kts)=0.<a name='1228'>
     vflux(i,kte)=0.<a name='1229'>
   ENDDO<a name='1230'>
<a name='1231'>
   vert_order_test : IF (vert_order == 6) THEN    <a name='1232'>
<a name='1233'>
      DO j = j_start, j_end<a name='1234'>
<a name='1235'>
         DO k=kts+3,ktf-2<a name='1236'>
         DO i = i_start, i_end<a name='1237'>
           vel=0.5*(rom(i-1,k,j)+rom(i,k,j))<a name='1238'>
           vflux(i,k) = vel*flux6(                     &amp;<a name='1239'>
                   u(i,k-3,j), u(i,k-2,j), u(i,k-1,j),       &amp;<a name='1240'>
                   u(i,k  ,j), u(i,k+1,j), u(i,k+2,j),  -vel )<a name='1241'>
         ENDDO<a name='1242'>
         ENDDO<a name='1243'>
<a name='1244'>
         DO i = i_start, i_end<a name='1245'>
<a name='1246'>
           k=kts+1<a name='1247'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j))  &amp;<a name='1248'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1249'>
           k = kts+2<a name='1250'>
           vel=0.5*(rom(i,k,j)+rom(i-1,k,j)) <a name='1251'>
           vflux(i,k) = vel*flux4(       &amp;<a name='1252'>
                   u(i,k-2,j), u(i,k-1,j),   &amp;<a name='1253'>
                   u(i,k  ,j), u(i,k+1,j), -vel )<a name='1254'>
           k = ktf-1<a name='1255'>
           vel=0.5*(rom(i,k,j)+rom(i-1,k,j)) <a name='1256'>
           vflux(i,k) = vel*flux4(       &amp;<a name='1257'>
                   u(i,k-2,j), u(i,k-1,j),   &amp;<a name='1258'>
                   u(i,k  ,j), u(i,k+1,j), -vel )<a name='1259'>
           k=ktf<a name='1260'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j)) &amp;<a name='1261'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1262'>
<a name='1263'>
         ENDDO<a name='1264'>
         DO k=kts,ktf<a name='1265'>
         DO i = i_start, i_end<a name='1266'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='1267'>
         ENDDO<a name='1268'>
         ENDDO<a name='1269'>
      ENDDO<a name='1270'>
<a name='1271'>
    ELSE IF (vert_order == 5) THEN    <a name='1272'>
<a name='1273'>
      DO j = j_start, j_end<a name='1274'>
<a name='1275'>
         DO k=kts+3,ktf-2<a name='1276'>
         DO i = i_start, i_end<a name='1277'>
           vel=0.5*(rom(i-1,k,j)+rom(i,k,j))<a name='1278'>
           vflux(i,k) = vel*flux5(                     &amp;<a name='1279'>
                   u(i,k-3,j), u(i,k-2,j), u(i,k-1,j),       &amp;<a name='1280'>
                   u(i,k  ,j), u(i,k+1,j), u(i,k+2,j),  -vel )<a name='1281'>
         ENDDO<a name='1282'>
         ENDDO<a name='1283'>
<a name='1284'>
         DO i = i_start, i_end<a name='1285'>
<a name='1286'>
           k=kts+1<a name='1287'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j))  &amp;<a name='1288'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1289'>
           k = kts+2<a name='1290'>
           vel=0.5*(rom(i,k,j)+rom(i-1,k,j)) <a name='1291'>
           vflux(i,k) = vel*flux3(       &amp;<a name='1292'>
                   u(i,k-2,j), u(i,k-1,j),   &amp;<a name='1293'>
                   u(i,k  ,j), u(i,k+1,j), -vel )<a name='1294'>
           k = ktf-1<a name='1295'>
           vel=0.5*(rom(i,k,j)+rom(i-1,k,j)) <a name='1296'>
           vflux(i,k) = vel*flux3(       &amp;<a name='1297'>
                   u(i,k-2,j), u(i,k-1,j),   &amp;<a name='1298'>
                   u(i,k  ,j), u(i,k+1,j), -vel )<a name='1299'>
           k=ktf<a name='1300'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j)) &amp;<a name='1301'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1302'>
<a name='1303'>
         ENDDO<a name='1304'>
         DO k=kts,ktf<a name='1305'>
         DO i = i_start, i_end<a name='1306'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='1307'>
         ENDDO<a name='1308'>
         ENDDO<a name='1309'>
      ENDDO<a name='1310'>
<a name='1311'>
    ELSE IF (vert_order == 4) THEN    <a name='1312'>
<a name='1313'>
      DO j = j_start, j_end<a name='1314'>
<a name='1315'>
         DO k=kts+2,ktf-1<a name='1316'>
         DO i = i_start, i_end<a name='1317'>
           vel=0.5*(rom(i-1,k,j)+rom(i,k,j))<a name='1318'>
           vflux(i,k) = vel*flux4(               &amp;<a name='1319'>
                   u(i,k-2,j), u(i,k-1,j),       &amp;<a name='1320'>
                   u(i,k  ,j), u(i,k+1,j),  -vel )<a name='1321'>
         ENDDO<a name='1322'>
         ENDDO<a name='1323'>
<a name='1324'>
         DO i = i_start, i_end<a name='1325'>
<a name='1326'>
           k=kts+1<a name='1327'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j))  &amp;<a name='1328'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1329'>
           k=ktf<a name='1330'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j)) &amp;<a name='1331'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1332'>
<a name='1333'>
         ENDDO<a name='1334'>
         DO k=kts,ktf<a name='1335'>
         DO i = i_start, i_end<a name='1336'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='1337'>
         ENDDO<a name='1338'>
         ENDDO<a name='1339'>
      ENDDO<a name='1340'>
<a name='1341'>
    ELSE IF (vert_order == 3) THEN    <a name='1342'>
<a name='1343'>
      DO j = j_start, j_end<a name='1344'>
<a name='1345'>
         DO k=kts+2,ktf-1<a name='1346'>
         DO i = i_start, i_end<a name='1347'>
           vel=0.5*(rom(i-1,k,j)+rom(i,k,j))<a name='1348'>
           vflux(i,k) = vel*flux3(               &amp;<a name='1349'>
                   u(i,k-2,j), u(i,k-1,j),       &amp;<a name='1350'>
                   u(i,k  ,j), u(i,k+1,j),  -vel )<a name='1351'>
         ENDDO<a name='1352'>
         ENDDO<a name='1353'>
<a name='1354'>
         DO i = i_start, i_end<a name='1355'>
<a name='1356'>
           k=kts+1<a name='1357'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j))  &amp;<a name='1358'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1359'>
           k=ktf<a name='1360'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j)) &amp;<a name='1361'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1362'>
<a name='1363'>
         ENDDO<a name='1364'>
         DO k=kts,ktf<a name='1365'>
         DO i = i_start, i_end<a name='1366'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='1367'>
         ENDDO<a name='1368'>
         ENDDO<a name='1369'>
      ENDDO<a name='1370'>
<a name='1371'>
    ELSE IF (vert_order == 2) THEN    <a name='1372'>
<a name='1373'>
      DO j = j_start, j_end<a name='1374'>
         DO k=kts+1,ktf<a name='1375'>
         DO i = i_start, i_end<a name='1376'>
               vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j)) &amp;<a name='1377'>
                                *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1378'>
         ENDDO<a name='1379'>
         ENDDO<a name='1380'>
<a name='1381'>
<a name='1382'>
         DO k=kts,ktf<a name='1383'>
         DO i = i_start, i_end<a name='1384'>
               tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='1385'>
         ENDDO<a name='1386'>
         ENDDO<a name='1387'>
<a name='1388'>
      ENDDO<a name='1389'>
<a name='1390'>
   ELSE<a name='1391'>
<a name='1392'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_u_6a: v_order not known ',vert_order<a name='1393'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_9"> ( TRIM( wrf_err_message ) )<a name='1394'>
<a name='1395'>
   ENDIF vert_order_test<a name='1396'>
<a name='1397'>
END SUBROUTINE advect_u<a name='1398'>
<a name='1399'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1400'></font>
<a name='1401'>
<A NAME='ADVECT_V'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1402'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_v</font>   ( v, v_old, tendency,            &amp; <A href='../../call_to/ADVECT_V.html' TARGET='index'>2</A>,<A href='../../call_from/ADVECT_V.html' TARGET='index'>2</A><a name='1403'>
                        ru, rv, rom,                   &amp;<a name='1404'>
                        mut, config_flags,             &amp;<a name='1405'>
                        msfu, msfv, msft,              &amp;<a name='1406'>
                        fzm, fzp,                      &amp;<a name='1407'>
                        rdx, rdy, rdzw,                &amp;<a name='1408'>
                        ids, ide, jds, jde, kds, kde,  &amp;<a name='1409'>
                        ims, ime, jms, jme, kms, kme,  &amp;<a name='1410'>
                        its, ite, jts, jte, kts, kte  )<a name='1411'>
<a name='1412'>
   IMPLICIT NONE<a name='1413'>
   <a name='1414'>
   <font color=#447700>! Input data<a name='1415'></font>
   <a name='1416'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='1417'>
<a name='1418'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1419'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='1420'>
                                              its, ite, jts, jte, kts, kte<a name='1421'>
<a name='1422'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: v,     &amp;<a name='1423'>
                                                                      v_old, &amp;<a name='1424'>
                                                                      ru,    &amp;<a name='1425'>
                                                                      rv,    &amp;<a name='1426'>
                                                                      rom<a name='1427'>
<a name='1428'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='1429'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='1430'>
<a name='1431'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfu,  &amp;<a name='1432'>
                                                                    msfv,  &amp;<a name='1433'>
                                                                    msft<a name='1434'>
<a name='1435'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='1436'>
                                                                  fzp,  &amp;<a name='1437'>
                                                                  rdzw<a name='1438'>
<a name='1439'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='1440'>
                                                                  rdy<a name='1441'>
<a name='1442'>
   <font color=#447700>! Local data<a name='1443'></font>
   <a name='1444'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='1445'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='1446'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='1447'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='1448'>
<a name='1449'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw, dup, dum<a name='1450'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='1451'>
<a name='1452'>
<a name='1453'>
   REAL,  DIMENSION( its:ite+1, kts:kte ) :: fqx<a name='1454'>
   REAL,  DIMENSION( its:ite, kts:kte, 2 ) :: fqy<a name='1455'>
<a name='1456'>
   INTEGER :: horz_order<a name='1457'>
   INTEGER :: vert_order<a name='1458'>
   <a name='1459'>
   LOGICAL :: degrade_xs, degrade_ys<a name='1460'>
   LOGICAL :: degrade_xe, degrade_ye<a name='1461'>
<a name='1462'>
   INTEGER :: jp1, jp0, jtmp<a name='1463'>
<a name='1464'>
<a name='1465'>
<font color=#447700>! definition of flux operators, 3rd, 4rth, 5th or 6th order<a name='1466'></font>
<a name='1467'>
   REAL    :: flux3, flux4, flux5, flux6<a name='1468'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='1469'>
<a name='1470'>
   flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='1471'>
            (7./12.)*(q_i + q_im1) - (1./12.)*(q_ip1 + q_im2)<a name='1472'>
<a name='1473'>
   flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='1474'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='1475'>
           sign(1.,ua)*(1./12.)*((q_ip1 - q_im2)-3.*(q_i-q_im1))<a name='1476'>
<a name='1477'>
   flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='1478'>
            (37./60.)*(q_i+q_im1) - (2./15.)*(q_ip1+q_im2)      &amp;<a name='1479'>
            +(1./60.)*(q_ip2+q_im3)<a name='1480'>
<a name='1481'>
   flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='1482'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='1483'>
            -sign(1.,ua)*(1./60.)*(                             &amp;<a name='1484'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )<a name='1485'>
<a name='1486'>
<a name='1487'>
<a name='1488'>
   LOGICAL :: specified<a name='1489'>
<a name='1490'>
   specified = .false.<a name='1491'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='1492'>
<a name='1493'>
<font color=#447700>! set order for the advection schemes<a name='1494'></font>
<a name='1495'>
   ktf=MIN(kte,kde-1)<a name='1496'>
   horz_order = config_flags%h_mom_adv_order<a name='1497'>
   vert_order = config_flags%v_mom_adv_order<a name='1498'>
<a name='1499'>
<a name='1500'>
<font color=#447700>!  here is the choice of flux operators<a name='1501'></font>
<a name='1502'>
<a name='1503'>
   horizontal_order_test : IF( horz_order == 6 ) THEN<a name='1504'>
<a name='1505'>
<font color=#447700>!  determine boundary mods for flux operators<a name='1506'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='1507'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='1508'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='1509'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='1510'></font>
<font color=#447700>!   of the higher order flux stencils<a name='1511'></font>
<a name='1512'>
      degrade_xs = .true.<a name='1513'>
      degrade_xe = .true.<a name='1514'>
      degrade_ys = .true.<a name='1515'>
      degrade_ye = .true.<a name='1516'>
<a name='1517'>
      IF( config_flags%periodic_x   .or. &amp;<a name='1518'>
          config_flags%symmetric_xs .or. &amp;<a name='1519'>
          (its &gt; ids+2)                ) degrade_xs = .false.<a name='1520'>
      IF( config_flags%periodic_x   .or. &amp;<a name='1521'>
          config_flags%symmetric_xe .or. &amp;<a name='1522'>
          (ite &lt; ide-3)                ) degrade_xe = .false.<a name='1523'>
      IF( config_flags%periodic_y   .or. &amp;<a name='1524'>
          config_flags%symmetric_ys .or. &amp;<a name='1525'>
          (jts &gt; jds+2)                ) degrade_ys = .false.<a name='1526'>
      IF( config_flags%periodic_y   .or. &amp;<a name='1527'>
          config_flags%symmetric_ye .or. &amp;<a name='1528'>
          (jte &lt; jde-2)                ) degrade_ye = .false.<a name='1529'>
<a name='1530'>
<font color=#447700>!--------------- y - advection first<a name='1531'></font>
<a name='1532'>
      ktf=MIN(kte,kde-1)<a name='1533'>
<a name='1534'>
      i_start = its<a name='1535'>
      i_end   = MIN(ite,ide-1)<a name='1536'>
      j_start = jts<a name='1537'>
      j_end   = jte<a name='1538'>
<a name='1539'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='1540'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='1541'></font>
<a name='1542'>
      j_start_f = j_start<a name='1543'>
      j_end_f   = j_end+1<a name='1544'>
<a name='1545'>
      IF(degrade_ys) then<a name='1546'>
         j_start = MAX(jts,jds+1)<a name='1547'>
         j_start_f = jds+3<a name='1548'>
      ENDIF<a name='1549'>
<a name='1550'>
      IF(degrade_ye) then<a name='1551'>
         j_end = MIN(jte,jde-1)<a name='1552'>
         j_end_f = jde-2<a name='1553'>
      ENDIF<a name='1554'>
<a name='1555'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='1556'></font>
<a name='1557'>
      jp1 = 2<a name='1558'>
      jp0 = 1<a name='1559'>
<a name='1560'>
      j_loop_y_flux_6 : DO j = j_start, j_end+1<a name='1561'>
<a name='1562'>
         IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN<a name='1563'>
<a name='1564'>
            DO k=kts,ktf<a name='1565'>
            DO i = i_start, i_end<a name='1566'>
               vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='1567'>
               fqy( i, k, jp1 ) = vel*flux6(                                &amp;<a name='1568'>
                                  v(i,k,j-3), v(i,k,j-2), v(i,k,j-1),       &amp;<a name='1569'>
                                  v(i,k,j  ), v(i,k,j+1), v(i,k,j+2),  vel )<a name='1570'>
            ENDDO<a name='1571'>
            ENDDO<a name='1572'>
<a name='1573'>
<font color=#447700>!  we must be close to some boundary where we need to reduce the order of the stencil<a name='1574'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='1575'></font>
<a name='1576'>
         ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='1577'></font>
<a name='1578'>
            DO k=kts,ktf<a name='1579'>
            DO i = i_start, i_end<a name='1580'>
                vb = v(i,k,j-1)<a name='1581'>
                IF (specified .AND. v(i,k,j) .LT. 0.)vb = v(i,k,j)<a name='1582'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))  &amp;<a name='1583'>
                                 *(v(i,k,j)+vb)<a name='1584'>
            ENDDO<a name='1585'>
            ENDDO<a name='1586'>
<a name='1587'>
         ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4rth order flux 2 in from south boundary<a name='1588'></font>
<a name='1589'>
            DO k=kts,ktf<a name='1590'>
            DO i = i_start, i_end<a name='1591'>
                vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='1592'>
                fqy( i, k, jp1 ) = vel*flux4(      &amp;<a name='1593'>
                                   v(i,k,j-2),v(i,k,j-1),v(i,k,j),v(i,k,j+1),vel )<a name='1594'>
            ENDDO<a name='1595'>
            ENDDO<a name='1596'>
<a name='1597'>
<a name='1598'>
         ELSE IF ( j == jde ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='1599'></font>
<a name='1600'>
            DO k=kts,ktf<a name='1601'>
            DO i = i_start, i_end<a name='1602'>
                vb = v(i,k,j)<a name='1603'>
                IF (specified .AND. v(i,k,j-1) .GT. 0.)vb = v(i,k,j-1)<a name='1604'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))    &amp;<a name='1605'>
                                 *(vb+v(i,k,j-1))<a name='1606'>
            ENDDO<a name='1607'>
            ENDDO<a name='1608'>
<a name='1609'>
         ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 3rd or 4rth order flux 2 in from north boundary<a name='1610'></font>
<a name='1611'>
            DO k=kts,ktf<a name='1612'>
            DO i = i_start, i_end<a name='1613'>
                vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='1614'>
                fqy( i, k, jp1 ) = vel*flux4(     &amp;<a name='1615'>
                                   v(i,k,j-2),v(i,k,j-1),v(i,k,j),v(i,k,j+1),vel )<a name='1616'>
            ENDDO<a name='1617'>
            ENDDO<a name='1618'>
<a name='1619'>
         END IF<a name='1620'>
<a name='1621'>
<font color=#447700>!  y flux-divergence into tendency<a name='1622'></font>
<a name='1623'>
         IF(j &gt; j_start) THEN<a name='1624'>
<a name='1625'>
            DO k=kts,ktf<a name='1626'>
            DO i = i_start, i_end<a name='1627'>
               mrdy=msfv(i,j-1)*rdy<a name='1628'>
               tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='1629'>
            ENDDO<a name='1630'>
            ENDDO<a name='1631'>
<a name='1632'>
         ENDIF<a name='1633'>
<a name='1634'>
         jtmp = jp1<a name='1635'>
         jp1 = jp0<a name='1636'>
         jp0 = jtmp<a name='1637'>
<a name='1638'>
      ENDDO j_loop_y_flux_6<a name='1639'>
<a name='1640'>
<font color=#447700>!  next, x - flux divergence<a name='1641'></font>
<a name='1642'>
      i_start = its<a name='1643'>
      i_end   = MIN(ite,ide-1)<a name='1644'>
<a name='1645'>
      j_start = jts<a name='1646'>
      j_end   = jte<a name='1647'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='1648'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-1,jte)<a name='1649'>
<a name='1650'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='1651'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='1652'></font>
<a name='1653'>
      i_start_f = i_start<a name='1654'>
      i_end_f   = i_end+1<a name='1655'>
<a name='1656'>
      IF(degrade_xs) then<a name='1657'>
         i_start = MAX(ids+1,its)<a name='1658'>
         i_start_f = i_start+2<a name='1659'>
      ENDIF<a name='1660'>
<a name='1661'>
      IF(degrade_xe) then<a name='1662'>
         i_end = MIN(ide-2,ite)<a name='1663'>
         i_end_f = ide-3<a name='1664'>
      ENDIF<a name='1665'>
<a name='1666'>
<font color=#447700>!  compute fluxes<a name='1667'></font>
<a name='1668'>
      DO j = j_start, j_end<a name='1669'>
<a name='1670'>
<font color=#447700>!  5th or 6th order flux<a name='1671'></font>
<a name='1672'>
         DO k=kts,ktf<a name='1673'>
         DO i = i_start_f, i_end_f<a name='1674'>
            vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='1675'>
            fqx( i, k ) = vel*flux6( v(i-3,k,j), v(i-2,k,j),  &amp;<a name='1676'>
                                     v(i-1,k,j), v(i  ,k,j),  &amp;<a name='1677'>
                                     v(i+1,k,j), v(i+2,k,j),  &amp;<a name='1678'>
                                     vel                     )<a name='1679'>
         ENDDO<a name='1680'>
         ENDDO<a name='1681'>
<a name='1682'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='1683'></font>
<a name='1684'>
         IF( degrade_xs ) THEN<a name='1685'>
<a name='1686'>
            IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='1687'></font>
               i = ids+1<a name='1688'>
               DO k=kts,ktf<a name='1689'>
                  fqx(i,k) = 0.25*(ru(i,k,j)+ru(i,k,j-1)) &amp;<a name='1690'>
                                 *(v(i,k,j)+v(i-1,k,j))<a name='1691'>
               ENDDO<a name='1692'>
            ENDIF<a name='1693'>
<a name='1694'>
            i = ids+2<a name='1695'>
            DO k=kts,ktf<a name='1696'>
               vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='1697'>
               fqx( i,k ) = vel*flux4( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='1698'>
                                       v(i  ,k,j), v(i+1,k,j),  &amp;<a name='1699'>
                                       vel                     )<a name='1700'>
            ENDDO<a name='1701'>
<a name='1702'>
         ENDIF<a name='1703'>
<a name='1704'>
         IF( degrade_xe ) THEN<a name='1705'>
<a name='1706'>
            IF( i_end == ide-2 ) THEN <font color=#447700>! second order flux next to the boundary<a name='1707'></font>
               i = ide-1<a name='1708'>
               DO k=kts,ktf<a name='1709'>
                  fqx(i,k) = 0.25*(ru(i_end+1,k,j)+ru(i_end+1,k,j-1))      &amp;<a name='1710'>
                                 *(v(i_end+1,k,j)+v(i_end,k,j))<a name='1711'>
               ENDDO<a name='1712'>
            ENDIF<a name='1713'>
<a name='1714'>
            i = ide-2<a name='1715'>
            DO k=kts,ktf<a name='1716'>
               vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='1717'>
               fqx( i,k ) = vel*flux4( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='1718'>
                                       v(i  ,k,j), v(i+1,k,j),  &amp;<a name='1719'>
                                       vel                     )<a name='1720'>
            ENDDO<a name='1721'>
<a name='1722'>
         ENDIF<a name='1723'>
<a name='1724'>
<font color=#447700>!  x flux-divergence into tendency<a name='1725'></font>
<a name='1726'>
         DO k=kts,ktf<a name='1727'>
            DO i = i_start, i_end<a name='1728'>
            mrdx=msfv(i,j)*rdx<a name='1729'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='1730'>
         ENDDO<a name='1731'>
      ENDDO<a name='1732'>
<a name='1733'>
   ENDDO<a name='1734'>
<a name='1735'>
   ELSE IF( horz_order == 5 ) THEN<a name='1736'>
<a name='1737'>
<font color=#447700>!  5th order horizontal flux calculation<a name='1738'></font>
<font color=#447700>!  This code is EXACTLY the same as the 6th order code<a name='1739'></font>
<font color=#447700>!  EXCEPT the 5th order and 3rd operators are used in<a name='1740'></font>
<font color=#447700>!  place of the 6th and 4rth order operators<a name='1741'></font>
<a name='1742'>
<font color=#447700>!  determine boundary mods for flux operators<a name='1743'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='1744'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='1745'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='1746'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='1747'></font>
<font color=#447700>!   of the higher order flux stencils<a name='1748'></font>
<a name='1749'>
   degrade_xs = .true.<a name='1750'>
   degrade_xe = .true.<a name='1751'>
   degrade_ys = .true.<a name='1752'>
   degrade_ye = .true.<a name='1753'>
<a name='1754'>
   IF( config_flags%periodic_x   .or. &amp;<a name='1755'>
       config_flags%symmetric_xs .or. &amp;<a name='1756'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='1757'>
   IF( config_flags%periodic_x   .or. &amp;<a name='1758'>
       config_flags%symmetric_xe .or. &amp;<a name='1759'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='1760'>
   IF( config_flags%periodic_y   .or. &amp;<a name='1761'>
       config_flags%symmetric_ys .or. &amp;<a name='1762'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='1763'>
   IF( config_flags%periodic_y   .or. &amp;<a name='1764'>
       config_flags%symmetric_ye .or. &amp;<a name='1765'>
       (jte &lt; jde-2)                ) degrade_ye = .false.<a name='1766'>
<a name='1767'>
<font color=#447700>!--------------- y - advection first<a name='1768'></font>
<a name='1769'>
      i_start = its<a name='1770'>
      i_end   = MIN(ite,ide-1)<a name='1771'>
      j_start = jts<a name='1772'>
      j_end   = jte<a name='1773'>
<a name='1774'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='1775'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='1776'></font>
<a name='1777'>
      j_start_f = j_start<a name='1778'>
      j_end_f   = j_end+1<a name='1779'>
<a name='1780'>
      IF(degrade_ys) then<a name='1781'>
        j_start = MAX(jts,jds+1)<a name='1782'>
        j_start_f = jds+3<a name='1783'>
      ENDIF<a name='1784'>
<a name='1785'>
      IF(degrade_ye) then<a name='1786'>
        j_end = MIN(jte,jde-1)<a name='1787'>
        j_end_f = jde-2<a name='1788'>
      ENDIF<a name='1789'>
<a name='1790'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='1791'></font>
<a name='1792'>
     jp1 = 2<a name='1793'>
     jp0 = 1<a name='1794'>
<a name='1795'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='1796'>
<a name='1797'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN<a name='1798'>
<a name='1799'>
        DO k=kts,ktf<a name='1800'>
        DO i = i_start, i_end<a name='1801'>
          vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='1802'>
          fqy( i, k, jp1 ) = vel*flux5(               &amp;<a name='1803'>
                  v(i,k,j-3), v(i,k,j-2), v(i,k,j-1),       &amp;<a name='1804'>
                  v(i,k,j  ), v(i,k,j+1), v(i,k,j+2),  vel )<a name='1805'>
        ENDDO<a name='1806'>
        ENDDO<a name='1807'>
<a name='1808'>
<font color=#447700>!  we must be close to some boundary where we need to reduce the order of the stencil<a name='1809'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='1810'></font>
<a name='1811'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='1812'></font>
<a name='1813'>
            DO k=kts,ktf<a name='1814'>
            DO i = i_start, i_end<a name='1815'>
                vb = v(i,k,j-1)<a name='1816'>
                IF (specified .AND. v(i,k,j) .LT. 0.)vb = v(i,k,j)<a name='1817'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))  &amp;<a name='1818'>
                                 *(v(i,k,j)+vb)<a name='1819'>
            ENDDO<a name='1820'>
            ENDDO<a name='1821'>
<a name='1822'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4rth order flux 2 in from south boundary<a name='1823'></font>
<a name='1824'>
            DO k=kts,ktf<a name='1825'>
            DO i = i_start, i_end<a name='1826'>
              vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='1827'>
              fqy( i, k, jp1 ) = vel*flux3(      &amp;<a name='1828'>
                   v(i,k,j-2),v(i,k,j-1),v(i,k,j),v(i,k,j+1),vel )<a name='1829'>
            ENDDO<a name='1830'>
            ENDDO<a name='1831'>
<a name='1832'>
<a name='1833'>
     ELSE IF ( j == jde ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='1834'></font>
<a name='1835'>
            DO k=kts,ktf<a name='1836'>
            DO i = i_start, i_end<a name='1837'>
                vb = v(i,k,j)<a name='1838'>
                IF (specified .AND. v(i,k,j-1) .GT. 0.)vb = v(i,k,j-1)<a name='1839'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))    &amp;<a name='1840'>
                                 *(vb+v(i,k,j-1))<a name='1841'>
            ENDDO<a name='1842'>
            ENDDO<a name='1843'>
<a name='1844'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 3rd or 4rth order flux 2 in from north boundary<a name='1845'></font>
<a name='1846'>
            DO k=kts,ktf<a name='1847'>
            DO i = i_start, i_end<a name='1848'>
              vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='1849'>
              fqy( i, k, jp1 ) = vel*flux3(     &amp;<a name='1850'>
                   v(i,k,j-2),v(i,k,j-1),v(i,k,j),v(i,k,j+1),vel )<a name='1851'>
            ENDDO<a name='1852'>
            ENDDO<a name='1853'>
<a name='1854'>
      END IF<a name='1855'>
<a name='1856'>
<font color=#447700>!  y flux-divergence into tendency<a name='1857'></font>
<a name='1858'>
        IF(j &gt; j_start) THEN<a name='1859'>
<a name='1860'>
          DO k=kts,ktf<a name='1861'>
          DO i = i_start, i_end<a name='1862'>
            mrdy=msfv(i,j-1)*rdy<a name='1863'>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='1864'>
          ENDDO<a name='1865'>
          ENDDO<a name='1866'>
<a name='1867'>
        ENDIF<a name='1868'>
<a name='1869'>
        jtmp = jp1<a name='1870'>
        jp1 = jp0<a name='1871'>
        jp0 = jtmp<a name='1872'>
<a name='1873'>
   ENDDO j_loop_y_flux_5<a name='1874'>
<a name='1875'>
<font color=#447700>!  next, x - flux divergence<a name='1876'></font>
<a name='1877'>
      i_start = its<a name='1878'>
      i_end   = MIN(ite,ide-1)<a name='1879'>
<a name='1880'>
      j_start = jts<a name='1881'>
      j_end   = jte<a name='1882'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='1883'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-1,jte)<a name='1884'>
<a name='1885'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='1886'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='1887'></font>
<a name='1888'>
      i_start_f = i_start<a name='1889'>
      i_end_f   = i_end+1<a name='1890'>
<a name='1891'>
      IF(degrade_xs) then<a name='1892'>
        i_start = MAX(ids+1,its)<a name='1893'>
        i_start_f = i_start+2<a name='1894'>
      ENDIF<a name='1895'>
<a name='1896'>
      IF(degrade_xe) then<a name='1897'>
        i_end = MIN(ide-2,ite)<a name='1898'>
        i_end_f = ide-3<a name='1899'>
      ENDIF<a name='1900'>
<a name='1901'>
<font color=#447700>!  compute fluxes<a name='1902'></font>
<a name='1903'>
      DO j = j_start, j_end<a name='1904'>
<a name='1905'>
<font color=#447700>!  5th or 6th order flux<a name='1906'></font>
<a name='1907'>
        DO k=kts,ktf<a name='1908'>
        DO i = i_start_f, i_end_f<a name='1909'>
          vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='1910'>
          fqx( i, k ) = vel*flux5( v(i-3,k,j), v(i-2,k,j),  &amp;<a name='1911'>
                                         v(i-1,k,j), v(i  ,k,j),  &amp;<a name='1912'>
                                         v(i+1,k,j), v(i+2,k,j),  &amp;<a name='1913'>
                                         vel                     )<a name='1914'>
        ENDDO<a name='1915'>
        ENDDO<a name='1916'>
<a name='1917'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='1918'></font>
<a name='1919'>
        IF( degrade_xs ) THEN<a name='1920'>
<a name='1921'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='1922'></font>
            i = ids+1<a name='1923'>
            DO k=kts,ktf<a name='1924'>
            fqx(i,k) = 0.25*(ru(i,k,j)+ru(i,k,j-1)) &amp;<a name='1925'>
                   *(v(i,k,j)+v(i-1,k,j))<a name='1926'>
            ENDDO<a name='1927'>
         ENDIF<a name='1928'>
<a name='1929'>
          i = ids+2<a name='1930'>
          DO k=kts,ktf<a name='1931'>
            vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='1932'>
            fqx( i,k ) = vel*flux3( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='1933'>
                                          v(i  ,k,j), v(i+1,k,j),  &amp;<a name='1934'>
                                          vel                     )<a name='1935'>
          ENDDO<a name='1936'>
<a name='1937'>
        ENDIF<a name='1938'>
<a name='1939'>
        IF( degrade_xe ) THEN<a name='1940'>
<a name='1941'>
          IF( i_end == ide-2 ) THEN <font color=#447700>! second order flux next to the boundary<a name='1942'></font>
            i = ide-1<a name='1943'>
            DO k=kts,ktf<a name='1944'>
              fqx(i,k) = 0.25*(ru(i_end+1,k,j)+ru(i_end+1,k,j-1))      &amp;<a name='1945'>
                              *(v(i_end+1,k,j)+v(i_end,k,j))<a name='1946'>
            ENDDO<a name='1947'>
          ENDIF<a name='1948'>
<a name='1949'>
          i = ide-2<a name='1950'>
          DO k=kts,ktf<a name='1951'>
          vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='1952'>
          fqx( i,k ) = vel*flux3( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='1953'>
                                        v(i  ,k,j), v(i+1,k,j),  &amp;<a name='1954'>
                                        vel                     )<a name='1955'>
          ENDDO<a name='1956'>
<a name='1957'>
        ENDIF<a name='1958'>
<a name='1959'>
<font color=#447700>!  x flux-divergence into tendency<a name='1960'></font>
<a name='1961'>
        DO k=kts,ktf<a name='1962'>
          DO i = i_start, i_end<a name='1963'>
            mrdx=msfv(i,j)*rdx<a name='1964'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='1965'>
          ENDDO<a name='1966'>
        ENDDO<a name='1967'>
<a name='1968'>
      ENDDO<a name='1969'>
<a name='1970'>
   ELSE IF( horz_order == 4 ) THEN<a name='1971'>
<a name='1972'>
<font color=#447700>!  determine boundary mods for flux operators<a name='1973'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='1974'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='1975'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='1976'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='1977'></font>
<font color=#447700>!   of the higher order flux stencils<a name='1978'></font>
<a name='1979'>
   degrade_xs = .true.<a name='1980'>
   degrade_xe = .true.<a name='1981'>
   degrade_ys = .true.<a name='1982'>
   degrade_ye = .true.<a name='1983'>
<a name='1984'>
   IF( config_flags%periodic_x   .or. &amp;<a name='1985'>
       config_flags%symmetric_xs .or. &amp;<a name='1986'>
       (its &gt; ids+1)                ) degrade_xs = .false.<a name='1987'>
   IF( config_flags%periodic_x   .or. &amp;<a name='1988'>
       config_flags%symmetric_xe .or. &amp;<a name='1989'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='1990'>
   IF( config_flags%periodic_y   .or. &amp;<a name='1991'>
       config_flags%symmetric_ys .or. &amp;<a name='1992'>
       (jts &gt; jds+1)                ) degrade_ys = .false.<a name='1993'>
   IF( config_flags%periodic_y   .or. &amp;<a name='1994'>
       config_flags%symmetric_ye .or. &amp;<a name='1995'>
       (jte &lt; jde-1)                ) degrade_ye = .false.<a name='1996'>
<a name='1997'>
<font color=#447700>!--------------- y - advection first<a name='1998'></font>
<a name='1999'>
<a name='2000'>
   ktf=MIN(kte,kde-1)<a name='2001'>
<a name='2002'>
      i_start = its<a name='2003'>
      i_end   = MIN(ite,ide-1)<a name='2004'>
      j_start = jts<a name='2005'>
      j_end   = jte<a name='2006'>
<a name='2007'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='2008'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='2009'></font>
<a name='2010'>
      j_start_f = j_start<a name='2011'>
      j_end_f   = j_end+1<a name='2012'>
<a name='2013'>
<font color=#447700>!CJM May not work with tiling because defined in terms of domain dims<a name='2014'></font>
      IF(degrade_ys) then<a name='2015'>
        j_start = jds+1<a name='2016'>
        j_start_f = j_start+1<a name='2017'>
      ENDIF<a name='2018'>
<a name='2019'>
      IF(degrade_ye) then<a name='2020'>
        j_end = jde-1<a name='2021'>
        j_end_f = jde-1<a name='2022'>
      ENDIF<a name='2023'>
<a name='2024'>
<font color=#447700>!  compute fluxes<a name='2025'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='2026'></font>
<a name='2027'>
    jp0 = 1<a name='2028'>
    jp1 = 2<a name='2029'>
<a name='2030'>
    DO j = j_start, j_end+1<a name='2031'>
<a name='2032'>
      IF ((j == j_start) .and. degrade_ys) THEN<a name='2033'>
        DO k = kts,ktf<a name='2034'>
        DO i = i_start, i_end<a name='2035'>
                vb = v(i,k,j-1)<a name='2036'>
                IF (specified .AND. v(i,k,j) .LT. 0.)vb = v(i,k,j)<a name='2037'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))  &amp;<a name='2038'>
                                 *(v(i,k,j)+vb)<a name='2039'>
        ENDDO<a name='2040'>
        ENDDO<a name='2041'>
      ELSE IF ((j == j_end+1) .and. degrade_ye) THEN<a name='2042'>
        DO k = kts, ktf<a name='2043'>
        DO i = i_start, i_end<a name='2044'>
                vb = v(i,k,j)<a name='2045'>
                IF (specified .AND. v(i,k,j-1) .GT. 0.)vb = v(i,k,j-1)<a name='2046'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))    &amp;<a name='2047'>
                                 *(vb+v(i,k,j-1))<a name='2048'>
        ENDDO<a name='2049'>
        ENDDO<a name='2050'>
      ELSE<a name='2051'>
        DO k = kts, ktf<a name='2052'>
        DO i = i_start, i_end<a name='2053'>
          vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='2054'>
          fqy( i,k,jp1 ) = vel*flux4( v(i,k,j-2), v(i,k,j-1),  &amp;<a name='2055'>
                                     v(i,k,j  ), v(i,k,j+1),  &amp;<a name='2056'>
                                      vel                        )<a name='2057'>
        ENDDO<a name='2058'>
        ENDDO<a name='2059'>
      END IF<a name='2060'>
<a name='2061'>
      IF( j &gt; j_start) THEN<a name='2062'>
        DO k = kts, ktf<a name='2063'>
        DO i = i_start, i_end<a name='2064'>
            mrdy=msfv(i,j-1)*rdy<a name='2065'>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='2066'>
        ENDDO<a name='2067'>
        ENDDO<a name='2068'>
      END IF<a name='2069'>
<a name='2070'>
      jtmp = jp1<a name='2071'>
      jp1 = jp0<a name='2072'>
      jp0 = jtmp<a name='2073'>
<a name='2074'>
   ENDDO<a name='2075'>
<a name='2076'>
<font color=#447700>!  next, x - flux divergence<a name='2077'></font>
<a name='2078'>
<a name='2079'>
      i_start = its<a name='2080'>
      i_end   = MIN(ite,ide-1)<a name='2081'>
<a name='2082'>
      j_start = jts<a name='2083'>
      j_end   = jte<a name='2084'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2085'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-1,jte)<a name='2086'>
<a name='2087'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='2088'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='2089'></font>
<a name='2090'>
      i_start_f = i_start<a name='2091'>
      i_end_f   = i_end+1<a name='2092'>
<a name='2093'>
      IF(degrade_xs) then<a name='2094'>
        i_start = ids+1<a name='2095'>
        i_start_f = i_start+1<a name='2096'>
      ENDIF<a name='2097'>
<a name='2098'>
      IF(degrade_xe) then<a name='2099'>
        i_end = ide-2<a name='2100'>
        i_end_f = ide-2<a name='2101'>
      ENDIF<a name='2102'>
<a name='2103'>
<font color=#447700>!  compute fluxes<a name='2104'></font>
<a name='2105'>
      DO j = j_start, j_end<a name='2106'>
<a name='2107'>
<font color=#447700>!  3rd or 4rth order flux<a name='2108'></font>
<a name='2109'>
        DO k=kts,ktf<a name='2110'>
        DO i = i_start_f, i_end_f<a name='2111'>
          vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='2112'>
          fqx( i, k ) = vel*flux4( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='2113'>
                                  v(i  ,k,j), v(i+1,k,j),  &amp;<a name='2114'>
                                  vel                     )<a name='2115'>
        ENDDO<a name='2116'>
        ENDDO<a name='2117'>
<a name='2118'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='2119'></font>
<a name='2120'>
        IF( degrade_xs ) THEN<a name='2121'>
          DO k=kts,ktf<a name='2122'>
            fqx(i_start,k) = 0.25*(ru(i_start,k,j)+ru(i_start,k,j-1)) &amp;<a name='2123'>
                   *(v(i_start,k,j)+v(i_start-1,k,j))<a name='2124'>
          ENDDO<a name='2125'>
        ENDIF<a name='2126'>
<a name='2127'>
        IF( degrade_xe ) THEN<a name='2128'>
          DO k=kts,ktf<a name='2129'>
            fqx(i_end+1,k) = 0.25*(ru(i_end+1,k,j)+ru(i_end+1,k,j-1))      &amp;<a name='2130'>
                   *(v(i_end+1,k,j)+v(i_end,k,j))<a name='2131'>
          ENDDO<a name='2132'>
        ENDIF<a name='2133'>
<a name='2134'>
<font color=#447700>!  x flux-divergence into tendency<a name='2135'></font>
<a name='2136'>
        DO k=kts,ktf<a name='2137'>
        DO i = i_start, i_end<a name='2138'>
            mrdx=msfv(i,j)*rdx<a name='2139'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='2140'>
        ENDDO<a name='2141'>
        ENDDO<a name='2142'>
<a name='2143'>
      ENDDO<a name='2144'>
<a name='2145'>
   ELSE IF( horz_order == 3 ) THEN<a name='2146'>
<a name='2147'>
<font color=#447700>!  determine boundary mods for flux operators<a name='2148'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='2149'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='2150'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='2151'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='2152'></font>
<font color=#447700>!   of the higher order flux stencils<a name='2153'></font>
<a name='2154'>
   degrade_xs = .true.<a name='2155'>
   degrade_xe = .true.<a name='2156'>
   degrade_ys = .true.<a name='2157'>
   degrade_ye = .true.<a name='2158'>
<a name='2159'>
   IF( config_flags%periodic_x   .or. &amp;<a name='2160'>
       config_flags%symmetric_xs .or. &amp;<a name='2161'>
       (its &gt; ids+1)                ) degrade_xs = .false.<a name='2162'>
   IF( config_flags%periodic_x   .or. &amp;<a name='2163'>
       config_flags%symmetric_xe .or. &amp;<a name='2164'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='2165'>
   IF( config_flags%periodic_y   .or. &amp;<a name='2166'>
       config_flags%symmetric_ys .or. &amp;<a name='2167'>
       (jts &gt; jds+1)                ) degrade_ys = .false.<a name='2168'>
   IF( config_flags%periodic_y   .or. &amp;<a name='2169'>
       config_flags%symmetric_ye .or. &amp;<a name='2170'>
       (jte &lt; jde-1)                ) degrade_ye = .false.<a name='2171'>
<a name='2172'>
<font color=#447700>!--------------- y - advection first<a name='2173'></font>
<a name='2174'>
<a name='2175'>
   ktf=MIN(kte,kde-1)<a name='2176'>
<a name='2177'>
      i_start = its<a name='2178'>
      i_end   = MIN(ite,ide-1)<a name='2179'>
      j_start = jts<a name='2180'>
      j_end   = jte<a name='2181'>
<a name='2182'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='2183'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='2184'></font>
<a name='2185'>
      j_start_f = j_start<a name='2186'>
      j_end_f   = j_end+1<a name='2187'>
<a name='2188'>
<font color=#447700>!CJM May not work with tiling because defined in terms of domain dims<a name='2189'></font>
      IF(degrade_ys) then<a name='2190'>
        j_start = jds+1<a name='2191'>
        j_start_f = j_start+1<a name='2192'>
      ENDIF<a name='2193'>
<a name='2194'>
      IF(degrade_ye) then<a name='2195'>
        j_end = jde-1<a name='2196'>
        j_end_f = jde-1<a name='2197'>
      ENDIF<a name='2198'>
<a name='2199'>
<font color=#447700>!  compute fluxes<a name='2200'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='2201'></font>
<a name='2202'>
    jp0 = 1<a name='2203'>
    jp1 = 2<a name='2204'>
<a name='2205'>
    DO j = j_start, j_end+1<a name='2206'>
<a name='2207'>
      IF ((j == j_start) .and. degrade_ys) THEN<a name='2208'>
        DO k = kts,ktf<a name='2209'>
        DO i = i_start, i_end<a name='2210'>
                vb = v(i,k,j-1)<a name='2211'>
                IF (specified .AND. v(i,k,j) .LT. 0.)vb = v(i,k,j)<a name='2212'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))  &amp;<a name='2213'>
                                 *(v(i,k,j)+vb)<a name='2214'>
        ENDDO<a name='2215'>
        ENDDO<a name='2216'>
      ELSE IF ((j == j_end+1) .and. degrade_ye) THEN<a name='2217'>
        DO k = kts, ktf<a name='2218'>
        DO i = i_start, i_end<a name='2219'>
                vb = v(i,k,j)<a name='2220'>
                IF (specified .AND. v(i,k,j-1) .GT. 0.)vb = v(i,k,j-1)<a name='2221'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))    &amp;<a name='2222'>
                                 *(vb+v(i,k,j-1))<a name='2223'>
        ENDDO<a name='2224'>
        ENDDO<a name='2225'>
      ELSE<a name='2226'>
        DO k = kts, ktf<a name='2227'>
        DO i = i_start, i_end<a name='2228'>
          vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='2229'>
          fqy( i,k,jp1 ) = vel*flux3( v(i,k,j-2), v(i,k,j-1),  &amp;<a name='2230'>
                                     v(i,k,j  ), v(i,k,j+1),  &amp;<a name='2231'>
                                      vel                        )<a name='2232'>
        ENDDO<a name='2233'>
        ENDDO<a name='2234'>
      END IF<a name='2235'>
<a name='2236'>
      IF( j &gt; j_start) THEN<a name='2237'>
        DO k = kts, ktf<a name='2238'>
        DO i = i_start, i_end<a name='2239'>
            mrdy=msfv(i,j-1)*rdy<a name='2240'>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='2241'>
        ENDDO<a name='2242'>
        ENDDO<a name='2243'>
      END IF<a name='2244'>
<a name='2245'>
      jtmp = jp1<a name='2246'>
      jp1 = jp0<a name='2247'>
      jp0 = jtmp<a name='2248'>
<a name='2249'>
   ENDDO<a name='2250'>
<a name='2251'>
<font color=#447700>!  next, x - flux divergence<a name='2252'></font>
<a name='2253'>
<a name='2254'>
      i_start = its<a name='2255'>
      i_end   = MIN(ite,ide-1)<a name='2256'>
<a name='2257'>
      j_start = jts<a name='2258'>
      j_end   = jte<a name='2259'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2260'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-1,jte)<a name='2261'>
<a name='2262'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='2263'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='2264'></font>
<a name='2265'>
      i_start_f = i_start<a name='2266'>
      i_end_f   = i_end+1<a name='2267'>
<a name='2268'>
      IF(degrade_xs) then<a name='2269'>
        i_start = ids+1<a name='2270'>
        i_start_f = i_start+1<a name='2271'>
      ENDIF<a name='2272'>
<a name='2273'>
      IF(degrade_xe) then<a name='2274'>
        i_end = ide-2<a name='2275'>
        i_end_f = ide-2<a name='2276'>
      ENDIF<a name='2277'>
<a name='2278'>
<font color=#447700>!  compute fluxes<a name='2279'></font>
<a name='2280'>
      DO j = j_start, j_end<a name='2281'>
<a name='2282'>
<font color=#447700>!  3rd or 4rth order flux<a name='2283'></font>
<a name='2284'>
        DO k=kts,ktf<a name='2285'>
        DO i = i_start_f, i_end_f<a name='2286'>
          vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='2287'>
          fqx( i, k ) = vel*flux3( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='2288'>
                                  v(i  ,k,j), v(i+1,k,j),  &amp;<a name='2289'>
                                  vel                     )<a name='2290'>
        ENDDO<a name='2291'>
        ENDDO<a name='2292'>
<a name='2293'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='2294'></font>
<a name='2295'>
        IF( degrade_xs ) THEN<a name='2296'>
          DO k=kts,ktf<a name='2297'>
            fqx(i_start,k) = 0.25*(ru(i_start,k,j)+ru(i_start,k,j-1)) &amp;<a name='2298'>
                   *(v(i_start,k,j)+v(i_start-1,k,j))<a name='2299'>
          ENDDO<a name='2300'>
        ENDIF<a name='2301'>
<a name='2302'>
        IF( degrade_xe ) THEN<a name='2303'>
          DO k=kts,ktf<a name='2304'>
            fqx(i_end+1,k) = 0.25*(ru(i_end+1,k,j)+ru(i_end+1,k,j-1))      &amp;<a name='2305'>
                   *(v(i_end+1,k,j)+v(i_end,k,j))<a name='2306'>
          ENDDO<a name='2307'>
        ENDIF<a name='2308'>
<a name='2309'>
<font color=#447700>!  x flux-divergence into tendency<a name='2310'></font>
<a name='2311'>
        DO k=kts,ktf<a name='2312'>
        DO i = i_start, i_end<a name='2313'>
            mrdx=msfv(i,j)*rdx<a name='2314'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='2315'>
        ENDDO<a name='2316'>
        ENDDO<a name='2317'>
<a name='2318'>
      ENDDO<a name='2319'>
<a name='2320'>
   ELSE IF( horz_order == 2 ) THEN<a name='2321'>
<a name='2322'>
<a name='2323'>
      i_start = its<a name='2324'>
      i_end   = MIN(ite,ide-1)<a name='2325'>
      j_start = jts<a name='2326'>
      j_end   = jte<a name='2327'>
<a name='2328'>
      IF ( config_flags%open_ys ) j_start = MAX(jds+1,jts)<a name='2329'>
      IF ( config_flags%open_ye ) j_end   = MIN(jde-1,jte)<a name='2330'>
      IF ( specified ) j_start = MAX(jds+2,jts)<a name='2331'>
      IF ( specified ) j_end   = MIN(jde-2,jte)<a name='2332'>
<a name='2333'>
      DO j = j_start, j_end<a name='2334'>
      DO k=kts,ktf<a name='2335'>
      DO i = i_start, i_end<a name='2336'>
<a name='2337'>
         mrdy=msfv(i,j)*rdy<a name='2338'>
<a name='2339'>
            tendency(i,k,j)=tendency(i,k,j) -mrdy*0.25 &amp;<a name='2340'>
                            *((rv(i,k,j+1)+rv(i,k,j  ))*(v(i,k,j+1)+v(i,k,j  )) &amp;<a name='2341'>
                             -(rv(i,k,j  )+rv(i,k,j-1))*(v(i,k,j  )+v(i,k,j-1)))<a name='2342'>
<a name='2343'>
      ENDDO<a name='2344'>
      ENDDO<a name='2345'>
      ENDDO<a name='2346'>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='2347'></font>
<a name='2348'>
      IF ( specified .AND. jts .LE. jds+1 ) THEN<a name='2349'>
        j = jds+1<a name='2350'>
        DO k=kts,ktf<a name='2351'>
        DO i = i_start, i_end<a name='2352'>
           mrdy=msfv(i,j)*rdy<a name='2353'>
           vb = v(i,k,j-1)<a name='2354'>
           IF (v(i,k,j) .LT. 0.) vb = v(i,k,j)<a name='2355'>
<a name='2356'>
              tendency(i,k,j)=tendency(i,k,j) -mrdy*0.25 &amp;<a name='2357'>
                              *((rv(i,k,j+1)+rv(i,k,j  ))*(v(i,k,j+1)+v(i,k,j  )) &amp;<a name='2358'>
                               -(rv(i,k,j  )+rv(i,k,j-1))*(v(i,k,j  )+vb))<a name='2359'>
<a name='2360'>
        ENDDO<a name='2361'>
        ENDDO<a name='2362'>
      ENDIF<a name='2363'>
<a name='2364'>
      IF ( specified .AND. jte .GE. jde-1 ) THEN<a name='2365'>
        j = jde-1<a name='2366'>
        DO k=kts,ktf<a name='2367'>
        DO i = i_start, i_end<a name='2368'>
<a name='2369'>
           mrdy=msfv(i,j)*rdy<a name='2370'>
           vb = v(i,k,j+1)<a name='2371'>
           IF (v(i,k,j) .GT. 0.) vb = v(i,k,j)<a name='2372'>
<a name='2373'>
              tendency(i,k,j)=tendency(i,k,j) -mrdy*0.25 &amp;<a name='2374'>
                              *((rv(i,k,j+1)+rv(i,k,j  ))*(vb+v(i,k,j  )) &amp;<a name='2375'>
                               -(rv(i,k,j  )+rv(i,k,j-1))*(v(i,k,j  )+v(i,k,j-1)))<a name='2376'>
<a name='2377'>
        ENDDO<a name='2378'>
        ENDDO<a name='2379'>
      ENDIF<a name='2380'>
<a name='2381'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2382'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='2383'>
<a name='2384'>
      DO j = j_start, j_end<a name='2385'>
      DO k=kts,ktf<a name='2386'>
      DO i = i_start, i_end<a name='2387'>
<a name='2388'>
         mrdx=msfv(i,j)*rdx<a name='2389'>
<a name='2390'>
            tendency(i,k,j)=tendency(i,k,j)-mrdx*0.25 &amp;<a name='2391'>
                            *((ru(i+1,k,j)+ru(i+1,k,j-1))*(v(i+1,k,j)+v(i  ,k,j)) &amp;<a name='2392'>
                             -(ru(i  ,k,j)+ru(i  ,k,j-1))*(v(i  ,k,j)+v(i-1,k,j)))<a name='2393'>
<a name='2394'>
      ENDDO<a name='2395'>
      ENDDO<a name='2396'>
      ENDDO<a name='2397'>
<a name='2398'>
  ELSE<a name='2399'>
<a name='2400'>
<a name='2401'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_v_6a: h_order not known ',horz_order<a name='2402'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_V' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_10"> ( TRIM( wrf_err_message ) )<a name='2403'>
<a name='2404'>
   ENDIF horizontal_order_test<a name='2405'>
<a name='2406'>
<font color=#447700>!  radiative lateral boundary condition in y for normal velocity (v)<a name='2407'></font>
<a name='2408'>
      IF ( (config_flags%open_ys) .and. jts == jds ) THEN<a name='2409'>
<a name='2410'>
        i_start = its<a name='2411'>
        i_end   = MIN(ite,ide-1)<a name='2412'>
<a name='2413'>
        DO i = i_start, i_end<a name='2414'>
        DO k = kts, ktf<a name='2415'>
          vb = MIN(rv(i,k,jts)-cb*mut(i,jts), 0.)<a name='2416'>
          tendency(i,k,jts) = tendency(i,k,jts)                    &amp;<a name='2417'>
                      - rdy*vb*(v_old(i,k,jts+1) - v_old(i,k,jts))<a name='2418'>
        ENDDO<a name='2419'>
        ENDDO<a name='2420'>
<a name='2421'>
      ENDIF<a name='2422'>
<a name='2423'>
      IF ( (config_flags%open_ye) .and. jte == jde ) THEN<a name='2424'>
<a name='2425'>
        i_start = its<a name='2426'>
        i_end   = MIN(ite,ide-1)<a name='2427'>
<a name='2428'>
        DO i = i_start, i_end<a name='2429'>
        DO k = kts, ktf<a name='2430'>
          vb = MAX(rv(i,k,jte)+cb*mut(i,jte-1), 0.)<a name='2431'>
          tendency(i,k,jte) = tendency(i,k,jte)                    &amp;<a name='2432'>
                      - rdy*vb*(v_old(i,k,jte) - v_old(i,k,jte-1))<a name='2433'>
        ENDDO<a name='2434'>
        ENDDO<a name='2435'>
<a name='2436'>
      ENDIF<a name='2437'>
<a name='2438'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='2439'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='2440'></font>
<font color=#447700>!  first, set to index ranges<a name='2441'></font>
<a name='2442'>
      j_start = jts<a name='2443'>
      j_end   = MIN(jte,jde)<a name='2444'>
<a name='2445'>
      jmin    = jds<a name='2446'>
      jmax    = jde-1<a name='2447'>
<a name='2448'>
      IF (config_flags%open_ys) THEN<a name='2449'>
          j_start = MAX(jds+1, jts)<a name='2450'>
          jmin = jds<a name='2451'>
      ENDIF<a name='2452'>
      IF (config_flags%open_ye) THEN<a name='2453'>
          j_end = MIN(jte,jde-1)<a name='2454'>
          jmax = jde-1<a name='2455'>
      ENDIF<a name='2456'>
<a name='2457'>
<font color=#447700>!  compute x (u) conditions for v, w, or scalar<a name='2458'></font>
<a name='2459'>
   IF( (config_flags%open_xs) .and. (its == ids)) THEN<a name='2460'>
<a name='2461'>
      DO j = j_start, j_end<a name='2462'>
<a name='2463'>
         mrdx=msfv(its,j)*rdx<a name='2464'>
         jp = MIN( jmax, j   )<a name='2465'>
         jm = MAX( jmin, j-1 )<a name='2466'>
<a name='2467'>
         DO k=kts,ktf<a name='2468'>
<a name='2469'>
          uw = 0.5*(ru(its,k,jp)+ru(its,k,jm))<a name='2470'>
          ub = MIN( uw, 0. )<a name='2471'>
          dup =  ru(its+1,k,jp)-ru(its,k,jp)<a name='2472'>
          dum =  ru(its+1,k,jm)-ru(its,k,jm)<a name='2473'>
          tendency(its,k,j)=tendency(its,k,j)-mrdx*(               &amp;<a name='2474'>
                            ub*(v_old(its+1,k,j)-v_old(its,k,j))   &amp;<a name='2475'>
                           +0.5*v(its,k,j)*(dup+dum))<a name='2476'>
         ENDDO<a name='2477'>
      ENDDO<a name='2478'>
<a name='2479'>
   ENDIF<a name='2480'>
<a name='2481'>
   IF( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='2482'>
      DO j = j_start, j_end<a name='2483'>
<a name='2484'>
         mrdx=msfv(ite-1,j)*rdx<a name='2485'>
         jp = MIN( jmax, j   )<a name='2486'>
         jm = MAX( jmin, j-1 )<a name='2487'>
<a name='2488'>
         DO k=kts,ktf<a name='2489'>
<a name='2490'>
          uw = 0.5*(ru(ite,k,jp)+ru(ite,k,jm))<a name='2491'>
          ub = MAX( uw, 0. )<a name='2492'>
          dup = ru(ite,k,jp)-ru(ite-1,k,jp)<a name='2493'>
          dum = ru(ite,k,jm)-ru(ite-1,k,jm)<a name='2494'>
<a name='2495'>
<font color=#447700>!          tendency(ite-1,k,j)=tendency(ite-1,k,j)-mrdx*(              &amp;<a name='2496'></font>
<font color=#447700>!                            ub*(v_old(ite-1,k,j)-v_old(ite-2,k,j))    &amp;<a name='2497'></font>
<font color=#447700>!                           +0.5*v(ite-1,k,j)*                         &amp;<a name='2498'></font>
<font color=#447700>!                                  ( ru(ite,k,jp)-ru(ite-1,k,jp)       &amp;<a name='2499'></font>
<font color=#447700>!                                   +ru(ite,k,jm)-ru(ite-1,k,jm))     )<a name='2500'></font>
          tendency(ite-1,k,j)=tendency(ite-1,k,j)-mrdx*(              &amp;<a name='2501'>
                            ub*(v_old(ite-1,k,j)-v_old(ite-2,k,j))    &amp;<a name='2502'>
                           +0.5*v(ite-1,k,j)*(dup+dum))<a name='2503'>
<a name='2504'>
         ENDDO<a name='2505'>
      ENDDO<a name='2506'>
<a name='2507'>
   ENDIF<a name='2508'>
<a name='2509'>
<font color=#447700>!-------------------- vertical advection<a name='2510'></font>
<a name='2511'>
<a name='2512'>
      i_start = its<a name='2513'>
      i_end   = MIN(ite,ide-1)<a name='2514'>
      j_start = jts<a name='2515'>
      j_end   = jte<a name='2516'>
<a name='2517'>
      DO i = i_start, i_end<a name='2518'>
         vflux(i,kts)=0.<a name='2519'>
         vflux(i,kte)=0.<a name='2520'>
      ENDDO<a name='2521'>
<a name='2522'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2523'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-1,jte)<a name='2524'>
<a name='2525'>
    vert_order_test : IF (vert_order == 6) THEN    <a name='2526'>
<a name='2527'>
      DO j = j_start, j_end<a name='2528'>
<a name='2529'>
<a name='2530'>
         DO k=kts+3,ktf-2<a name='2531'>
         DO i = i_start, i_end<a name='2532'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1))<a name='2533'>
           vflux(i,k) = vel*flux6(                       &amp;<a name='2534'>
                   v(i,k-3,j), v(i,k-2,j), v(i,k-1,j),       &amp;<a name='2535'>
                   v(i,k  ,j), v(i,k+1,j), v(i,k+2,j),  -vel )<a name='2536'>
         ENDDO<a name='2537'>
         ENDDO<a name='2538'>
<a name='2539'>
         DO i = i_start, i_end<a name='2540'>
           k=kts+1<a name='2541'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1))  &amp;<a name='2542'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2543'>
           k = kts+2<a name='2544'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1)) <a name='2545'>
           vflux(i,k) = vel*flux4(       &amp;<a name='2546'>
                   v(i,k-2,j), v(i,k-1,j),   &amp;<a name='2547'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2548'>
           k = ktf-1<a name='2549'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1)) <a name='2550'>
           vflux(i,k) = vel*flux4(       &amp;<a name='2551'>
                   v(i,k-2,j), v(i,k-1,j),   &amp;<a name='2552'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2553'>
           k=ktf<a name='2554'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1)) &amp;<a name='2555'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2556'>
<a name='2557'>
         ENDDO<a name='2558'>
<a name='2559'>
<a name='2560'>
         DO k=kts,ktf<a name='2561'>
         DO i = i_start, i_end<a name='2562'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='2563'>
         ENDDO<a name='2564'>
         ENDDO<a name='2565'>
<a name='2566'>
      ENDDO<a name='2567'>
<a name='2568'>
   ELSE IF (vert_order == 5) THEN    <a name='2569'>
<a name='2570'>
      DO j = j_start, j_end<a name='2571'>
<a name='2572'>
<a name='2573'>
         DO k=kts+3,ktf-2<a name='2574'>
         DO i = i_start, i_end<a name='2575'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1))<a name='2576'>
           vflux(i,k) = vel*flux5(                       &amp;<a name='2577'>
                   v(i,k-3,j), v(i,k-2,j), v(i,k-1,j),       &amp;<a name='2578'>
                   v(i,k  ,j), v(i,k+1,j), v(i,k+2,j),  -vel )<a name='2579'>
         ENDDO<a name='2580'>
         ENDDO<a name='2581'>
<a name='2582'>
         DO i = i_start, i_end<a name='2583'>
           k=kts+1<a name='2584'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1))  &amp;<a name='2585'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2586'>
           k = kts+2<a name='2587'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1)) <a name='2588'>
           vflux(i,k) = vel*flux3(       &amp;<a name='2589'>
                   v(i,k-2,j), v(i,k-1,j),   &amp;<a name='2590'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2591'>
           k = ktf-1<a name='2592'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1)) <a name='2593'>
           vflux(i,k) = vel*flux3(       &amp;<a name='2594'>
                   v(i,k-2,j), v(i,k-1,j),   &amp;<a name='2595'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2596'>
           k=ktf<a name='2597'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1)) &amp;<a name='2598'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2599'>
<a name='2600'>
         ENDDO<a name='2601'>
<a name='2602'>
<a name='2603'>
         DO k=kts,ktf<a name='2604'>
         DO i = i_start, i_end<a name='2605'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='2606'>
         ENDDO<a name='2607'>
         ENDDO<a name='2608'>
<a name='2609'>
      ENDDO<a name='2610'>
<a name='2611'>
    ELSE IF (vert_order == 4) THEN    <a name='2612'>
<a name='2613'>
      DO j = j_start, j_end<a name='2614'>
<a name='2615'>
<a name='2616'>
         DO k=kts+2,ktf-1<a name='2617'>
         DO i = i_start, i_end<a name='2618'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1))<a name='2619'>
           vflux(i,k) = vel*flux4(               &amp;<a name='2620'>
                   v(i,k-2,j), v(i,k-1,j),       &amp;<a name='2621'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2622'>
         ENDDO<a name='2623'>
         ENDDO<a name='2624'>
<a name='2625'>
         DO i = i_start, i_end<a name='2626'>
           k=kts+1<a name='2627'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1))  &amp;<a name='2628'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2629'>
           k=ktf<a name='2630'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1)) &amp;<a name='2631'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2632'>
<a name='2633'>
         ENDDO<a name='2634'>
<a name='2635'>
<a name='2636'>
         DO k=kts,ktf<a name='2637'>
         DO i = i_start, i_end<a name='2638'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='2639'>
         ENDDO<a name='2640'>
         ENDDO<a name='2641'>
<a name='2642'>
      ENDDO<a name='2643'>
<a name='2644'>
    ELSE IF (vert_order == 3) THEN    <a name='2645'>
<a name='2646'>
      DO j = j_start, j_end<a name='2647'>
<a name='2648'>
<a name='2649'>
         DO k=kts+2,ktf-1<a name='2650'>
         DO i = i_start, i_end<a name='2651'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1))<a name='2652'>
           vflux(i,k) = vel*flux3(               &amp;<a name='2653'>
                   v(i,k-2,j), v(i,k-1,j),       &amp;<a name='2654'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2655'>
         ENDDO<a name='2656'>
         ENDDO<a name='2657'>
<a name='2658'>
         DO i = i_start, i_end<a name='2659'>
           k=kts+1<a name='2660'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1))  &amp;<a name='2661'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2662'>
           k=ktf<a name='2663'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1)) &amp;<a name='2664'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2665'>
<a name='2666'>
         ENDDO<a name='2667'>
<a name='2668'>
<a name='2669'>
         DO k=kts,ktf<a name='2670'>
         DO i = i_start, i_end<a name='2671'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='2672'>
         ENDDO<a name='2673'>
         ENDDO<a name='2674'>
<a name='2675'>
      ENDDO<a name='2676'>
<a name='2677'>
<a name='2678'>
    ELSE IF (vert_order == 2) THEN    <a name='2679'>
<a name='2680'>
   DO j = j_start, j_end<a name='2681'>
      DO k=kts+1,ktf<a name='2682'>
      DO i = i_start, i_end<a name='2683'>
<a name='2684'>
            vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1)) &amp;<a name='2685'>
                                    *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2686'>
      ENDDO<a name='2687'>
      ENDDO<a name='2688'>
<a name='2689'>
      DO k=kts,ktf<a name='2690'>
      DO i = i_start, i_end<a name='2691'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='2692'>
<a name='2693'>
      ENDDO<a name='2694'>
      ENDDO<a name='2695'>
   ENDDO<a name='2696'>
<a name='2697'>
   ELSE<a name='2698'>
<a name='2699'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_v_6a: v_order not known ',vert_order<a name='2700'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_V' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_11"> ( TRIM( wrf_err_message ) )<a name='2701'>
<a name='2702'>
   ENDIF vert_order_test<a name='2703'>
<a name='2704'>
END SUBROUTINE advect_v<a name='2705'>
<a name='2706'>
<font color=#447700>!-------------------------------------------------------------------<a name='2707'></font>
<a name='2708'>
<A NAME='ADVECT_SCALAR'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2709'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_scalar</font>   ( field, field_old, tendency,    &amp; <A href='../../call_to/ADVECT_SCALAR.html' TARGET='index'>6</A>,<A href='../../call_from/ADVECT_SCALAR.html' TARGET='index'>2</A><a name='2710'>
                             ru, rv, rom,                   &amp;<a name='2711'>
                             mut, config_flags,             &amp;<a name='2712'>
                             msfu, msfv, msft,              &amp;<a name='2713'>
                             fzm, fzp,                      &amp;<a name='2714'>
                             rdx, rdy, rdzw,                &amp;<a name='2715'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='2716'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='2717'>
                             its, ite, jts, jte, kts, kte  )<a name='2718'>
<a name='2719'>
   IMPLICIT NONE<a name='2720'>
   <a name='2721'>
   <font color=#447700>! Input data<a name='2722'></font>
   <a name='2723'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2724'>
<a name='2725'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2726'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='2727'>
                                              its, ite, jts, jte, kts, kte<a name='2728'>
<a name='2729'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field,     &amp;<a name='2730'>
                                                                      field_old, &amp;<a name='2731'>
                                                                      ru,    &amp;<a name='2732'>
                                                                      rv,    &amp;<a name='2733'>
                                                                      rom<a name='2734'>
<a name='2735'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='2736'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='2737'>
<a name='2738'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfu,  &amp;<a name='2739'>
                                                                    msfv,  &amp;<a name='2740'>
                                                                    msft<a name='2741'>
<a name='2742'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='2743'>
                                                                  fzp,  &amp;<a name='2744'>
                                                                  rdzw<a name='2745'>
<a name='2746'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='2747'>
                                                                  rdy<a name='2748'>
<a name='2749'>
   <font color=#447700>! Local data<a name='2750'></font>
   <a name='2751'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='2752'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2753'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='2754'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='2755'>
<a name='2756'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw<a name='2757'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='2758'>
<a name='2759'>
<a name='2760'>
   REAL,  DIMENSION( its:ite+1, kts:kte  ) :: fqx<a name='2761'>
   REAL,  DIMENSION( its:ite, kts:kte, 2 ) :: fqy<a name='2762'>
<a name='2763'>
   INTEGER :: horz_order, vert_order<a name='2764'>
   <a name='2765'>
   LOGICAL :: degrade_xs, degrade_ys<a name='2766'>
   LOGICAL :: degrade_xe, degrade_ye<a name='2767'>
<a name='2768'>
   INTEGER :: jp1, jp0, jtmp<a name='2769'>
<a name='2770'>
<a name='2771'>
<font color=#447700>! definition of flux operators, 3rd, 4rth, 5th or 6th order<a name='2772'></font>
<a name='2773'>
   REAL    :: flux3, flux4, flux5, flux6<a name='2774'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='2775'>
<a name='2776'>
      flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='2777'>
            (7./12.)*(q_i + q_im1) - (1./12.)*(q_ip1 + q_im2)<a name='2778'>
<a name='2779'>
      flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='2780'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='2781'>
           sign(1.,ua)*(1./12.)*((q_ip1 - q_im2)-3.*(q_i-q_im1))<a name='2782'>
<a name='2783'>
      flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='2784'>
            (37./60.)*(q_i+q_im1) - (2./15.)*(q_ip1+q_im2)      &amp;<a name='2785'>
            +(1./60.)*(q_ip2+q_im3)<a name='2786'>
<a name='2787'>
      flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='2788'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='2789'>
            -sign(1.,ua)*(1./60.)*(                             &amp;<a name='2790'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )<a name='2791'>
<a name='2792'>
<a name='2793'>
   LOGICAL :: specified<a name='2794'>
<a name='2795'>
   specified = .false.<a name='2796'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='2797'>
<a name='2798'>
<font color=#447700>! set order for the advection schemes<a name='2799'></font>
<a name='2800'>
  ktf=MIN(kte,kde-1)<a name='2801'>
  horz_order = config_flags%h_sca_adv_order<a name='2802'>
  vert_order = config_flags%v_sca_adv_order<a name='2803'>
<a name='2804'>
<font color=#447700>!  begin with horizontal flux divergence<a name='2805'></font>
<font color=#447700>!  here is the choice of flux operators<a name='2806'></font>
<a name='2807'>
<a name='2808'>
  horizontal_order_test : IF( horz_order == 6 ) THEN<a name='2809'>
<a name='2810'>
<font color=#447700>!  determine boundary mods for flux operators<a name='2811'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='2812'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='2813'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='2814'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='2815'></font>
<font color=#447700>!   of the higher order flux stencils<a name='2816'></font>
<a name='2817'>
   degrade_xs = .true.<a name='2818'>
   degrade_xe = .true.<a name='2819'>
   degrade_ys = .true.<a name='2820'>
   degrade_ye = .true.<a name='2821'>
<a name='2822'>
   IF( config_flags%periodic_x   .or. &amp;<a name='2823'>
       config_flags%symmetric_xs .or. &amp;<a name='2824'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='2825'>
   IF( config_flags%periodic_x   .or. &amp;<a name='2826'>
       config_flags%symmetric_xe .or. &amp;<a name='2827'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='2828'>
   IF( config_flags%periodic_y   .or. &amp;<a name='2829'>
       config_flags%symmetric_ys .or. &amp;<a name='2830'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='2831'>
   IF( config_flags%periodic_y   .or. &amp;<a name='2832'>
       config_flags%symmetric_ye .or. &amp;<a name='2833'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='2834'>
<a name='2835'>
<font color=#447700>!--------------- y - advection first<a name='2836'></font>
<a name='2837'>
      ktf=MIN(kte,kde-1)<a name='2838'>
      i_start = its<a name='2839'>
      i_end   = MIN(ite,ide-1)<a name='2840'>
      j_start = jts<a name='2841'>
      j_end   = MIN(jte,jde-1)<a name='2842'>
<a name='2843'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='2844'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='2845'></font>
<a name='2846'>
      j_start_f = j_start<a name='2847'>
      j_end_f   = j_end+1<a name='2848'>
<a name='2849'>
      IF(degrade_ys) then<a name='2850'>
        j_start = MAX(jts,jds+1)<a name='2851'>
        j_start_f = jds+3<a name='2852'>
      ENDIF<a name='2853'>
<a name='2854'>
      IF(degrade_ye) then<a name='2855'>
        j_end = MIN(jte,jde-2)<a name='2856'>
        j_end_f = jde-3<a name='2857'>
      ENDIF<a name='2858'>
<a name='2859'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='2860'></font>
<a name='2861'>
     jp1 = 2<a name='2862'>
     jp0 = 1<a name='2863'>
<a name='2864'>
     j_loop_y_flux_6 : DO j = j_start, j_end+1<a name='2865'>
<a name='2866'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN <font color=#447700>! use full stencil<a name='2867'></font>
<a name='2868'>
        DO k=kts,ktf<a name='2869'>
        DO i = i_start, i_end<a name='2870'>
          vel = rv(i,k,j)<a name='2871'>
          fqy( i, k, jp1 ) = vel*flux6(                                &amp;<a name='2872'>
                  field(i,k,j-3), field(i,k,j-2), field(i,k,j-1),       &amp;<a name='2873'>
                  field(i,k,j  ), field(i,k,j+1), field(i,k,j+2),  vel )<a name='2874'>
        ENDDO<a name='2875'>
        ENDDO<a name='2876'>
<a name='2877'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='2878'></font>
<a name='2879'>
            DO k=kts,ktf<a name='2880'>
            DO i = i_start, i_end<a name='2881'>
              fqy(i,k, jp1) = 0.5*rv(i,k,j)*          &amp;<a name='2882'>
                     (field(i,k,j)+field(i,k,j-1))<a name='2883'>
<a name='2884'>
            ENDDO<a name='2885'>
            ENDDO<a name='2886'>
<a name='2887'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4rth order flux 2 in from south boundary<a name='2888'></font>
<a name='2889'>
            DO k=kts,ktf<a name='2890'>
            DO i = i_start, i_end<a name='2891'>
              vel = rv(i,k,j)<a name='2892'>
              fqy( i, k, jp1 ) = vel*flux4(              &amp;<a name='2893'>
                   field(i,k,j-2),field(i,k,j-1),field(i,k,j),field(i,k,j+1),vel )<a name='2894'>
            ENDDO<a name='2895'>
            ENDDO<a name='2896'>
<a name='2897'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='2898'></font>
<a name='2899'>
            DO k=kts,ktf<a name='2900'>
            DO i = i_start, i_end<a name='2901'>
              fqy(i, k, jp1) = 0.5*rv(i,k,j)*      &amp;<a name='2902'>
                     (field(i,k,j)+field(i,k,j-1))<a name='2903'>
            ENDDO<a name='2904'>
            ENDDO<a name='2905'>
<a name='2906'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4rth order flux 2 in from north boundary<a name='2907'></font>
<a name='2908'>
            DO k=kts,ktf<a name='2909'>
            DO i = i_start, i_end<a name='2910'>
              vel = rv(i,k,j)<a name='2911'>
              fqy( i, k, jp1) = vel*flux4(             &amp;<a name='2912'>
                   field(i,k,j-2),field(i,k,j-1),    &amp;<a name='2913'>
                   field(i,k,j),field(i,k,j+1),vel )<a name='2914'>
            ENDDO<a name='2915'>
            ENDDO<a name='2916'>
<a name='2917'>
     ENDIF<a name='2918'>
<a name='2919'>
<font color=#447700>!  y flux-divergence into tendency<a name='2920'></font>
<a name='2921'>
        IF(j &gt; j_start) THEN<a name='2922'>
<a name='2923'>
          DO k=kts,ktf<a name='2924'>
          DO i = i_start, i_end<a name='2925'>
            mrdy=msft(i,j-1)*rdy<a name='2926'>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='2927'>
          ENDDO<a name='2928'>
          ENDDO<a name='2929'>
<a name='2930'>
        ENDIF<a name='2931'>
<a name='2932'>
        jtmp = jp1<a name='2933'>
        jp1 = jp0<a name='2934'>
        jp0 = jtmp<a name='2935'>
<a name='2936'>
      ENDDO j_loop_y_flux_6<a name='2937'>
<a name='2938'>
<font color=#447700>!  next, x - flux divergence<a name='2939'></font>
<a name='2940'>
      i_start = its<a name='2941'>
      i_end   = MIN(ite,ide-1)<a name='2942'>
<a name='2943'>
      j_start = jts<a name='2944'>
      j_end   = MIN(jte,jde-1)<a name='2945'>
<a name='2946'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='2947'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='2948'></font>
<a name='2949'>
      i_start_f = i_start<a name='2950'>
      i_end_f   = i_end+1<a name='2951'>
<a name='2952'>
      IF(degrade_xs) then<a name='2953'>
        i_start = MAX(ids+1,its)<a name='2954'>
        i_start_f = i_start+2<a name='2955'>
      ENDIF<a name='2956'>
<a name='2957'>
      IF(degrade_xe) then<a name='2958'>
        i_end = MIN(ide-2,ite)<a name='2959'>
        i_end_f = ide-3<a name='2960'>
      ENDIF<a name='2961'>
<a name='2962'>
<font color=#447700>!  compute fluxes<a name='2963'></font>
<a name='2964'>
      DO j = j_start, j_end<a name='2965'>
<a name='2966'>
<font color=#447700>!  5th or 6th order flux<a name='2967'></font>
<a name='2968'>
        DO k=kts,ktf<a name='2969'>
        DO i = i_start_f, i_end_f<a name='2970'>
          vel = ru(i,k,j)<a name='2971'>
          fqx( i,k ) = vel*flux6( field(i-3,k,j), field(i-2,k,j),  &amp;<a name='2972'>
                                         field(i-1,k,j), field(i  ,k,j),  &amp;<a name='2973'>
                                         field(i+1,k,j), field(i+2,k,j),  &amp;<a name='2974'>
                                         vel                             )<a name='2975'>
        ENDDO<a name='2976'>
        ENDDO<a name='2977'>
<a name='2978'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='2979'></font>
<a name='2980'>
        IF( degrade_xs ) THEN<a name='2981'>
<a name='2982'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='2983'></font>
            i = ids+1<a name='2984'>
            DO k=kts,ktf<a name='2985'>
              fqx(i,k) = 0.5*(ru(i,k,j)) &amp;<a name='2986'>
                     *(field(i,k,j)+field(i-1,k,j))<a name='2987'>
<a name='2988'>
            ENDDO<a name='2989'>
          ENDIF<a name='2990'>
<a name='2991'>
          i = ids+2<a name='2992'>
          DO k=kts,ktf<a name='2993'>
            vel = ru(i,k,j)<a name='2994'>
            fqx( i,k ) = vel*flux4( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='2995'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='2996'>
                                          vel                     )<a name='2997'>
          ENDDO<a name='2998'>
<a name='2999'>
        ENDIF<a name='3000'>
<a name='3001'>
        IF( degrade_xe ) THEN<a name='3002'>
<a name='3003'>
          IF( i_end == ide-2 ) THEN <font color=#447700>! second order flux next to the boundary<a name='3004'></font>
            i = ide-1<a name='3005'>
            DO k=kts,ktf<a name='3006'>
              fqx(i,k) = 0.5*(ru(i,k,j))      &amp;<a name='3007'>
                     *(field(i,k,j)+field(i-1,k,j))<a name='3008'>
            ENDDO<a name='3009'>
         ENDIF<a name='3010'>
<a name='3011'>
          i = ide-2<a name='3012'>
          DO k=kts,ktf<a name='3013'>
            vel = ru(i,k,j)<a name='3014'>
            fqx( i,k ) = vel*flux4( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='3015'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='3016'>
                                          vel                             )<a name='3017'>
          ENDDO<a name='3018'>
<a name='3019'>
        ENDIF<a name='3020'>
<a name='3021'>
<font color=#447700>!  x flux-divergence into tendency<a name='3022'></font>
<a name='3023'>
          DO k=kts,ktf<a name='3024'>
          DO i = i_start, i_end<a name='3025'>
            mrdx=msft(i,j)*rdx<a name='3026'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='3027'>
          ENDDO<a name='3028'>
          ENDDO<a name='3029'>
<a name='3030'>
      ENDDO<a name='3031'>
<a name='3032'>
  ELSE IF( horz_order == 5 ) THEN<a name='3033'>
<a name='3034'>
<font color=#447700>!  determine boundary mods for flux operators<a name='3035'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='3036'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='3037'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='3038'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='3039'></font>
<font color=#447700>!   of the higher order flux stencils<a name='3040'></font>
<a name='3041'>
   degrade_xs = .true.<a name='3042'>
   degrade_xe = .true.<a name='3043'>
   degrade_ys = .true.<a name='3044'>
   degrade_ye = .true.<a name='3045'>
<a name='3046'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3047'>
       config_flags%symmetric_xs .or. &amp;<a name='3048'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='3049'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3050'>
       config_flags%symmetric_xe .or. &amp;<a name='3051'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='3052'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3053'>
       config_flags%symmetric_ys .or. &amp;<a name='3054'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='3055'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3056'>
       config_flags%symmetric_ye .or. &amp;<a name='3057'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='3058'>
<a name='3059'>
<font color=#447700>!--------------- y - advection first<a name='3060'></font>
<a name='3061'>
      ktf=MIN(kte,kde-1)<a name='3062'>
      i_start = its<a name='3063'>
      i_end   = MIN(ite,ide-1)<a name='3064'>
      j_start = jts<a name='3065'>
      j_end   = MIN(jte,jde-1)<a name='3066'>
<a name='3067'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='3068'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3069'></font>
<a name='3070'>
      j_start_f = j_start<a name='3071'>
      j_end_f   = j_end+1<a name='3072'>
<a name='3073'>
      IF(degrade_ys) then<a name='3074'>
        j_start = MAX(jts,jds+1)<a name='3075'>
        j_start_f = jds+3<a name='3076'>
      ENDIF<a name='3077'>
<a name='3078'>
      IF(degrade_ye) then<a name='3079'>
        j_end = MIN(jte,jde-2)<a name='3080'>
        j_end_f = jde-3<a name='3081'>
      ENDIF<a name='3082'>
<a name='3083'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='3084'></font>
<a name='3085'>
     jp1 = 2<a name='3086'>
     jp0 = 1<a name='3087'>
<a name='3088'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='3089'>
<a name='3090'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN <font color=#447700>! use full stencil<a name='3091'></font>
<a name='3092'>
        DO k=kts,ktf<a name='3093'>
        DO i = i_start, i_end<a name='3094'>
          vel = rv(i,k,j)<a name='3095'>
          fqy( i, k, jp1 ) = vel*flux5(                                &amp;<a name='3096'>
                  field(i,k,j-3), field(i,k,j-2), field(i,k,j-1),       &amp;<a name='3097'>
                  field(i,k,j  ), field(i,k,j+1), field(i,k,j+2),  vel )<a name='3098'>
        ENDDO<a name='3099'>
        ENDDO<a name='3100'>
<a name='3101'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='3102'></font>
<a name='3103'>
            DO k=kts,ktf<a name='3104'>
            DO i = i_start, i_end<a name='3105'>
              fqy(i,k, jp1) = 0.5*rv(i,k,j)*          &amp;<a name='3106'>
                     (field(i,k,j)+field(i,k,j-1))<a name='3107'>
<a name='3108'>
            ENDDO<a name='3109'>
            ENDDO<a name='3110'>
<a name='3111'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4rth order flux 2 in from south boundary<a name='3112'></font>
<a name='3113'>
            DO k=kts,ktf<a name='3114'>
            DO i = i_start, i_end<a name='3115'>
              vel = rv(i,k,j)<a name='3116'>
              fqy( i, k, jp1 ) = vel*flux3(              &amp;<a name='3117'>
                   field(i,k,j-2),field(i,k,j-1),field(i,k,j),field(i,k,j+1),vel )<a name='3118'>
            ENDDO<a name='3119'>
            ENDDO<a name='3120'>
<a name='3121'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='3122'></font>
<a name='3123'>
            DO k=kts,ktf<a name='3124'>
            DO i = i_start, i_end<a name='3125'>
              fqy(i, k, jp1) = 0.5*rv(i,k,j)*      &amp;<a name='3126'>
                     (field(i,k,j)+field(i,k,j-1))<a name='3127'>
            ENDDO<a name='3128'>
            ENDDO<a name='3129'>
<a name='3130'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4rth order flux 2 in from north boundary<a name='3131'></font>
<a name='3132'>
            DO k=kts,ktf<a name='3133'>
            DO i = i_start, i_end<a name='3134'>
              vel = rv(i,k,j)<a name='3135'>
              fqy( i, k, jp1) = vel*flux3(             &amp;<a name='3136'>
                   field(i,k,j-2),field(i,k,j-1),    &amp;<a name='3137'>
                   field(i,k,j),field(i,k,j+1),vel )<a name='3138'>
            ENDDO<a name='3139'>
            ENDDO<a name='3140'>
<a name='3141'>
     ENDIF<a name='3142'>
<a name='3143'>
<font color=#447700>!  y flux-divergence into tendency<a name='3144'></font>
<a name='3145'>
        IF(j &gt; j_start) THEN<a name='3146'>
<a name='3147'>
          DO k=kts,ktf<a name='3148'>
          DO i = i_start, i_end<a name='3149'>
            mrdy=msft(i,j-1)*rdy<a name='3150'>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='3151'>
          ENDDO<a name='3152'>
          ENDDO<a name='3153'>
<a name='3154'>
        ENDIF<a name='3155'>
<a name='3156'>
<a name='3157'>
        jtmp = jp1<a name='3158'>
        jp1 = jp0<a name='3159'>
        jp0 = jtmp<a name='3160'>
<a name='3161'>
      ENDDO j_loop_y_flux_5<a name='3162'>
<a name='3163'>
<font color=#447700>!  next, x - flux divergence<a name='3164'></font>
<a name='3165'>
      i_start = its<a name='3166'>
      i_end   = MIN(ite,ide-1)<a name='3167'>
<a name='3168'>
      j_start = jts<a name='3169'>
      j_end   = MIN(jte,jde-1)<a name='3170'>
<a name='3171'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='3172'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3173'></font>
<a name='3174'>
      i_start_f = i_start<a name='3175'>
      i_end_f   = i_end+1<a name='3176'>
<a name='3177'>
      IF(degrade_xs) then<a name='3178'>
        i_start = MAX(ids+1,its)<a name='3179'>
        i_start_f = i_start+2<a name='3180'>
      ENDIF<a name='3181'>
<a name='3182'>
      IF(degrade_xe) then<a name='3183'>
        i_end = MIN(ide-2,ite)<a name='3184'>
        i_end_f = ide-3<a name='3185'>
      ENDIF<a name='3186'>
<a name='3187'>
<font color=#447700>!  compute fluxes<a name='3188'></font>
<a name='3189'>
      DO j = j_start, j_end<a name='3190'>
<a name='3191'>
<font color=#447700>!  5th or 6th order flux<a name='3192'></font>
<a name='3193'>
        DO k=kts,ktf<a name='3194'>
        DO i = i_start_f, i_end_f<a name='3195'>
          vel = ru(i,k,j)<a name='3196'>
          fqx( i,k ) = vel*flux5( field(i-3,k,j), field(i-2,k,j),  &amp;<a name='3197'>
                                         field(i-1,k,j), field(i  ,k,j),  &amp;<a name='3198'>
                                         field(i+1,k,j), field(i+2,k,j),  &amp;<a name='3199'>
                                         vel                             )<a name='3200'>
        ENDDO<a name='3201'>
        ENDDO<a name='3202'>
<a name='3203'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='3204'></font>
<a name='3205'>
        IF( degrade_xs ) THEN<a name='3206'>
<a name='3207'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='3208'></font>
            i = ids+1<a name='3209'>
            DO k=kts,ktf<a name='3210'>
              fqx(i,k) = 0.5*(ru(i,k,j)) &amp;<a name='3211'>
                     *(field(i,k,j)+field(i-1,k,j))<a name='3212'>
<a name='3213'>
            ENDDO<a name='3214'>
          ENDIF<a name='3215'>
<a name='3216'>
          i = ids+2<a name='3217'>
          DO k=kts,ktf<a name='3218'>
            vel = ru(i,k,j)<a name='3219'>
            fqx( i,k ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='3220'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='3221'>
                                          vel                     )<a name='3222'>
          ENDDO<a name='3223'>
<a name='3224'>
        ENDIF<a name='3225'>
<a name='3226'>
        IF( degrade_xe ) THEN<a name='3227'>
<a name='3228'>
          IF( i_end == ide-2 ) THEN <font color=#447700>! second order flux next to the boundary<a name='3229'></font>
            i = ide-1<a name='3230'>
            DO k=kts,ktf<a name='3231'>
              fqx(i,k) = 0.5*(ru(i,k,j))      &amp;<a name='3232'>
                     *(field(i,k,j)+field(i-1,k,j))<a name='3233'>
            ENDDO<a name='3234'>
         ENDIF<a name='3235'>
<a name='3236'>
          i = ide-2<a name='3237'>
          DO k=kts,ktf<a name='3238'>
            vel = ru(i,k,j)<a name='3239'>
            fqx( i,k ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='3240'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='3241'>
                                          vel                             )<a name='3242'>
          ENDDO<a name='3243'>
<a name='3244'>
        ENDIF<a name='3245'>
<a name='3246'>
<font color=#447700>!  x flux-divergence into tendency<a name='3247'></font>
<a name='3248'>
          DO k=kts,ktf<a name='3249'>
          DO i = i_start, i_end<a name='3250'>
            mrdx=msft(i,j)*rdx<a name='3251'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='3252'>
          ENDDO<a name='3253'>
          ENDDO<a name='3254'>
<a name='3255'>
      ENDDO<a name='3256'>
<a name='3257'>
<a name='3258'>
   ELSE IF( horz_order == 4 ) THEN<a name='3259'>
<a name='3260'>
   degrade_xs = .true.<a name='3261'>
   degrade_xe = .true.<a name='3262'>
   degrade_ys = .true.<a name='3263'>
   degrade_ye = .true.<a name='3264'>
<a name='3265'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3266'>
       config_flags%symmetric_xs .or. &amp;<a name='3267'>
       (its &gt; ids+1)                ) degrade_xs = .false.<a name='3268'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3269'>
       config_flags%symmetric_xe .or. &amp;<a name='3270'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='3271'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3272'>
       config_flags%symmetric_ys .or. &amp;<a name='3273'>
       (jts &gt; jds+1)                ) degrade_ys = .false.<a name='3274'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3275'>
       config_flags%symmetric_ye .or. &amp;<a name='3276'>
       (jte &lt; jde-2)                ) degrade_ye = .false.<a name='3277'>
<a name='3278'>
<font color=#447700>!  begin flux computations<a name='3279'></font>
<font color=#447700>!  start with x flux divergence<a name='3280'></font>
<a name='3281'>
   ktf=MIN(kte,kde-1)<a name='3282'>
<a name='3283'>
      i_start = its<a name='3284'>
      i_end   = MIN(ite,ide-1)<a name='3285'>
      j_start = jts<a name='3286'>
      j_end   = MIN(jte,jde-1)<a name='3287'>
<a name='3288'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='3289'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3290'></font>
<a name='3291'>
      i_start_f = i_start<a name='3292'>
      i_end_f   = i_end+1<a name='3293'>
<a name='3294'>
      IF(degrade_xs) then<a name='3295'>
        i_start = ids+1<a name='3296'>
        i_start_f = i_start+1<a name='3297'>
      ENDIF<a name='3298'>
<a name='3299'>
      IF(degrade_xe) then<a name='3300'>
        i_end = ide-2<a name='3301'>
        i_end_f = ide-2<a name='3302'>
      ENDIF<a name='3303'>
<a name='3304'>
<font color=#447700>!  compute fluxes<a name='3305'></font>
<a name='3306'>
      DO j = j_start, j_end<a name='3307'>
<a name='3308'>
<font color=#447700>!  3rd or 4rth order flux<a name='3309'></font>
<a name='3310'>
        DO k=kts,ktf<a name='3311'>
        DO i = i_start_f, i_end_f<a name='3312'>
<a name='3313'>
          fqx( i, k) = ru(i,k,j)*flux4( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='3314'>
                                        field(i  ,k,j), field(i+1,k,j),  &amp;<a name='3315'>
                                        ru(i,k,j)                       )<a name='3316'>
        ENDDO<a name='3317'>
        ENDDO<a name='3318'>
<a name='3319'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='3320'></font>
<a name='3321'>
        IF( degrade_xs ) THEN<a name='3322'>
          DO k=kts,ktf<a name='3323'>
            fqx(i_start, k) = 0.5*ru(i_start,k,j)             &amp;<a name='3324'>
                   *(field(i_start,k,j)+field(i_start-1,k,j))<a name='3325'>
          ENDDO<a name='3326'>
        ENDIF<a name='3327'>
<a name='3328'>
        IF( degrade_xe ) THEN<a name='3329'>
          DO k=kts,ktf<a name='3330'>
            fqx(i_end+1,k ) = 0.5*ru(i_end+1,k,j)          &amp;<a name='3331'>
                   *(field(i_end+1,k,j)+field(i_end,k,j))<a name='3332'>
          ENDDO<a name='3333'>
        ENDIF<a name='3334'>
<a name='3335'>
<font color=#447700>!  x flux-divergence into tendency<a name='3336'></font>
<a name='3337'>
        DO k=kts,ktf<a name='3338'>
        DO i = i_start, i_end<a name='3339'>
          mrdx=msft(i,j)*rdx<a name='3340'>
          tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='3341'>
        ENDDO<a name='3342'>
        ENDDO<a name='3343'>
<a name='3344'>
      ENDDO<a name='3345'>
<a name='3346'>
<a name='3347'>
<font color=#447700>!  next -&gt; y flux divergence calculation<a name='3348'></font>
<a name='3349'>
      i_start = its<a name='3350'>
      i_end   = MIN(ite,ide-1)<a name='3351'>
      j_start = jts<a name='3352'>
      j_end   = MIN(jte,jde-1)<a name='3353'>
<a name='3354'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='3355'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3356'></font>
<a name='3357'>
      j_start_f = j_start<a name='3358'>
      j_end_f   = j_end+1<a name='3359'>
<a name='3360'>
      IF(degrade_ys) then<a name='3361'>
        j_start = jds+1<a name='3362'>
        j_start_f = j_start+1<a name='3363'>
      ENDIF<a name='3364'>
<a name='3365'>
      IF(degrade_ye) then<a name='3366'>
        j_end = jde-2<a name='3367'>
        j_end_f = jde-2<a name='3368'>
      ENDIF<a name='3369'>
<a name='3370'>
    jp1 = 2<a name='3371'>
    jp0 = 1<a name='3372'>
<a name='3373'>
  DO j = j_start, j_end+1<a name='3374'>
<a name='3375'>
    IF ((j &lt; j_start_f) .and. degrade_ys) THEN<a name='3376'>
      DO k = kts, ktf<a name='3377'>
      DO i = i_start, i_end<a name='3378'>
         fqy(i,k,jp1) = 0.5*rv(i,k,j_start)             &amp;<a name='3379'>
                *(field(i,k,j_start)+field(i,k,j_start-1))<a name='3380'>
      ENDDO<a name='3381'>
      ENDDO<a name='3382'>
    ELSE IF ((j &gt; j_end_f) .and. degrade_ye) THEN<a name='3383'>
      DO k = kts, ktf<a name='3384'>
      DO i = i_start, i_end<a name='3385'>
         fqy(i,k,jp1) = 0.5*rv(i,k,j_end+1)          &amp;<a name='3386'>
                *(field(i,k,j_end+1)+field(i,k,j_end))<a name='3387'>
      ENDDO<a name='3388'>
      ENDDO<a name='3389'>
    ELSE<a name='3390'>
<font color=#447700>!  3rd or 4rth order flux<a name='3391'></font>
      DO k = kts, ktf<a name='3392'>
      DO i = i_start, i_end<a name='3393'>
         fqy( i, k, jp1 ) = rv(i,k,j)*flux4( field(i,k,j-2), field(i,k,j-1),  &amp;<a name='3394'>
                                            field(i,k,j  ), field(i,k,j+1),  &amp;<a name='3395'>
                                            rv(i,k,j)                       )<a name='3396'>
      ENDDO<a name='3397'>
      ENDDO<a name='3398'>
    END IF<a name='3399'>
<a name='3400'>
    IF ( j &gt; j_start ) THEN<a name='3401'>
<font color=#447700>!  y flux-divergence into tendency<a name='3402'></font>
<a name='3403'>
      DO k=kts,ktf<a name='3404'>
      DO i = i_start, i_end<a name='3405'>
        mrdy=msft(i,j-1)*rdy<a name='3406'>
        tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='3407'>
      ENDDO<a name='3408'>
      ENDDO<a name='3409'>
    END IF<a name='3410'>
<a name='3411'>
    jtmp = jp1<a name='3412'>
    jp1 = jp0<a name='3413'>
    jp0 = jtmp<a name='3414'>
<a name='3415'>
  ENDDO<a name='3416'>
<a name='3417'>
<a name='3418'>
   ELSE IF( horz_order == 3 ) THEN<a name='3419'>
<a name='3420'>
   degrade_xs = .true.<a name='3421'>
   degrade_xe = .true.<a name='3422'>
   degrade_ys = .true.<a name='3423'>
   degrade_ye = .true.<a name='3424'>
<a name='3425'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3426'>
       config_flags%symmetric_xs .or. &amp;<a name='3427'>
       (its &gt; ids+1)                ) degrade_xs = .false.<a name='3428'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3429'>
       config_flags%symmetric_xe .or. &amp;<a name='3430'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='3431'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3432'>
       config_flags%symmetric_ys .or. &amp;<a name='3433'>
       (jts &gt; jds+1)                ) degrade_ys = .false.<a name='3434'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3435'>
       config_flags%symmetric_ye .or. &amp;<a name='3436'>
       (jte &lt; jde-2)                ) degrade_ye = .false.<a name='3437'>
<a name='3438'>
<font color=#447700>!  begin flux computations<a name='3439'></font>
<font color=#447700>!  start with x flux divergence<a name='3440'></font>
<a name='3441'>
   ktf=MIN(kte,kde-1)<a name='3442'>
<a name='3443'>
      i_start = its<a name='3444'>
      i_end   = MIN(ite,ide-1)<a name='3445'>
      j_start = jts<a name='3446'>
      j_end   = MIN(jte,jde-1)<a name='3447'>
<a name='3448'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='3449'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3450'></font>
<a name='3451'>
      i_start_f = i_start<a name='3452'>
      i_end_f   = i_end+1<a name='3453'>
<a name='3454'>
      IF(degrade_xs) then<a name='3455'>
        i_start = ids+1<a name='3456'>
        i_start_f = i_start+1<a name='3457'>
      ENDIF<a name='3458'>
<a name='3459'>
      IF(degrade_xe) then<a name='3460'>
        i_end = ide-2<a name='3461'>
        i_end_f = ide-2<a name='3462'>
      ENDIF<a name='3463'>
<a name='3464'>
<font color=#447700>!  compute fluxes<a name='3465'></font>
<a name='3466'>
      DO j = j_start, j_end<a name='3467'>
<a name='3468'>
<font color=#447700>!  3rd or 4rth order flux<a name='3469'></font>
<a name='3470'>
        DO k=kts,ktf<a name='3471'>
        DO i = i_start_f, i_end_f<a name='3472'>
<a name='3473'>
          fqx( i, k) = ru(i,k,j)*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='3474'>
                                        field(i  ,k,j), field(i+1,k,j),  &amp;<a name='3475'>
                                        ru(i,k,j)                       )<a name='3476'>
        ENDDO<a name='3477'>
        ENDDO<a name='3478'>
<a name='3479'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='3480'></font>
<a name='3481'>
        IF( degrade_xs ) THEN<a name='3482'>
          DO k=kts,ktf<a name='3483'>
            fqx(i_start, k) = 0.5*ru(i_start,k,j)             &amp;<a name='3484'>
                   *(field(i_start,k,j)+field(i_start-1,k,j))<a name='3485'>
          ENDDO<a name='3486'>
        ENDIF<a name='3487'>
<a name='3488'>
        IF( degrade_xe ) THEN<a name='3489'>
          DO k=kts,ktf<a name='3490'>
            fqx(i_end+1,k ) = 0.5*ru(i_end+1,k,j)          &amp;<a name='3491'>
                   *(field(i_end+1,k,j)+field(i_end,k,j))<a name='3492'>
          ENDDO<a name='3493'>
        ENDIF<a name='3494'>
<a name='3495'>
<font color=#447700>!  x flux-divergence into tendency<a name='3496'></font>
<a name='3497'>
        DO k=kts,ktf<a name='3498'>
        DO i = i_start, i_end<a name='3499'>
          mrdx=msft(i,j)*rdx<a name='3500'>
          tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='3501'>
        ENDDO<a name='3502'>
        ENDDO<a name='3503'>
<a name='3504'>
      ENDDO<a name='3505'>
<a name='3506'>
<a name='3507'>
<font color=#447700>!  next -&gt; y flux divergence calculation<a name='3508'></font>
<a name='3509'>
      i_start = its<a name='3510'>
      i_end   = MIN(ite,ide-1)<a name='3511'>
      j_start = jts<a name='3512'>
      j_end   = MIN(jte,jde-1)<a name='3513'>
<a name='3514'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='3515'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3516'></font>
<a name='3517'>
      j_start_f = j_start<a name='3518'>
      j_end_f   = j_end+1<a name='3519'>
<a name='3520'>
      IF(degrade_ys) then<a name='3521'>
        j_start = jds+1<a name='3522'>
        j_start_f = j_start+1<a name='3523'>
      ENDIF<a name='3524'>
<a name='3525'>
      IF(degrade_ye) then<a name='3526'>
        j_end = jde-2<a name='3527'>
        j_end_f = jde-2<a name='3528'>
      ENDIF<a name='3529'>
<a name='3530'>
    jp1 = 2<a name='3531'>
    jp0 = 1<a name='3532'>
<a name='3533'>
  DO j = j_start, j_end+1<a name='3534'>
<a name='3535'>
    IF ((j &lt; j_start_f) .and. degrade_ys) THEN<a name='3536'>
      DO k = kts, ktf<a name='3537'>
      DO i = i_start, i_end<a name='3538'>
         fqy(i,k,jp1) = 0.5*rv(i,k,j_start)             &amp;<a name='3539'>
                *(field(i,k,j_start)+field(i,k,j_start-1))<a name='3540'>
      ENDDO<a name='3541'>
      ENDDO<a name='3542'>
    ELSE IF ((j &gt; j_end_f) .and. degrade_ye) THEN<a name='3543'>
      DO k = kts, ktf<a name='3544'>
      DO i = i_start, i_end<a name='3545'>
         fqy(i,k,jp1) = 0.5*rv(i,k,j_end+1)          &amp;<a name='3546'>
                *(field(i,k,j_end+1)+field(i,k,j_end))<a name='3547'>
      ENDDO<a name='3548'>
      ENDDO<a name='3549'>
    ELSE<a name='3550'>
<font color=#447700>!  3rd or 4rth order flux<a name='3551'></font>
      DO k = kts, ktf<a name='3552'>
      DO i = i_start, i_end<a name='3553'>
         fqy( i, k, jp1 ) = rv(i,k,j)*flux3( field(i,k,j-2), field(i,k,j-1),  &amp;<a name='3554'>
                                            field(i,k,j  ), field(i,k,j+1),  &amp;<a name='3555'>
                                            rv(i,k,j)                       )<a name='3556'>
      ENDDO<a name='3557'>
      ENDDO<a name='3558'>
    END IF<a name='3559'>
<a name='3560'>
    IF ( j &gt; j_start ) THEN<a name='3561'>
<font color=#447700>!  y flux-divergence into tendency<a name='3562'></font>
<a name='3563'>
      DO k=kts,ktf<a name='3564'>
      DO i = i_start, i_end<a name='3565'>
        mrdy=msft(i,j-1)*rdy<a name='3566'>
        tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='3567'>
      ENDDO<a name='3568'>
      ENDDO<a name='3569'>
    END IF<a name='3570'>
<a name='3571'>
    jtmp = jp1<a name='3572'>
    jp1 = jp0<a name='3573'>
    jp0 = jtmp<a name='3574'>
<a name='3575'>
  ENDDO<a name='3576'>
<a name='3577'>
   ELSE IF( horz_order == 2 ) THEN<a name='3578'>
<a name='3579'>
      i_start = its<a name='3580'>
      i_end   = MIN(ite,ide-1)<a name='3581'>
      j_start = jts<a name='3582'>
      j_end   = MIN(jte,jde-1)<a name='3583'>
<a name='3584'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='3585'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='3586'>
<a name='3587'>
      DO j = j_start, j_end<a name='3588'>
      DO k = kts, ktf<a name='3589'>
      DO i = i_start, i_end<a name='3590'>
         mrdx=msft(i,j)*rdx<a name='3591'>
         tendency(i,k,j)=tendency(i,k,j)-mrdx*0.5 &amp;<a name='3592'>
                         *(ru(i+1,k,j)*(field(i+1,k,j)+field(i  ,k,j)) &amp;<a name='3593'>
                          -ru(i  ,k,j)*(field(i  ,k,j)+field(i-1,k,j)))<a name='3594'>
      ENDDO<a name='3595'>
      ENDDO<a name='3596'>
      ENDDO<a name='3597'>
<a name='3598'>
      i_start = its<a name='3599'>
      i_end   = MIN(ite,ide-1)<a name='3600'>
<a name='3601'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='3602'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='3603'>
<a name='3604'>
      DO j = j_start, j_end<a name='3605'>
      DO k = kts, ktf<a name='3606'>
      DO i = i_start, i_end<a name='3607'>
         mrdy=msft(i,j)*rdy<a name='3608'>
         tendency(i,k,j)=tendency(i,k,j) -mrdy*0.5 &amp;<a name='3609'>
                         *(rv(i,k,j+1)*(field(i,k,j+1)+field(i,k,j  )) &amp;<a name='3610'>
                          -rv(i,k,j  )*(field(i,k,j  )+field(i,k,j-1))) <a name='3611'>
      ENDDO<a name='3612'>
      ENDDO<a name='3613'>
      ENDDO<a name='3614'>
   <a name='3615'>
   ELSE<a name='3616'>
<a name='3617'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_scalar_6a, h_order not known ',horz_order<a name='3618'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_12"> ( TRIM( wrf_err_message ) )<a name='3619'>
<a name='3620'>
   ENDIF horizontal_order_test<a name='3621'>
<a name='3622'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='3623'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='3624'></font>
<font color=#447700>!  first, set to index ranges<a name='3625'></font>
<a name='3626'>
      i_start = its<a name='3627'>
      i_end   = MIN(ite,ide-1)<a name='3628'>
      j_start = jts<a name='3629'>
      j_end   = MIN(jte,jde-1)<a name='3630'>
<a name='3631'>
<font color=#447700>!  compute x (u) conditions for v, w, or scalar<a name='3632'></font>
<a name='3633'>
   IF( (config_flags%open_xs) .and. (its == ids) ) THEN<a name='3634'>
<a name='3635'>
       DO j = j_start, j_end<a name='3636'>
       DO k = kts, ktf<a name='3637'>
         ub = MIN( 0.5*(ru(its,k,j)+ru(its+1,k,j)), 0. )<a name='3638'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='3639'>
               - rdx*(                                             &amp;<a name='3640'>
                       ub*(   field_old(its+1,k,j)                 &amp;<a name='3641'>
                            - field_old(its  ,k,j)   ) +           &amp;<a name='3642'>
                       field(its,k,j)*(ru(its+1,k,j)-ru(its,k,j))  &amp;<a name='3643'>
                                                                )<a name='3644'>
       ENDDO<a name='3645'>
       ENDDO<a name='3646'>
<a name='3647'>
   ENDIF<a name='3648'>
<a name='3649'>
   IF( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='3650'>
<a name='3651'>
       DO j = j_start, j_end<a name='3652'>
       DO k = kts, ktf<a name='3653'>
         ub = MAX( 0.5*(ru(ite-1,k,j)+ru(ite,k,j)), 0. )<a name='3654'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                   &amp;<a name='3655'>
               - rdx*(                                               &amp;<a name='3656'>
                       ub*(  field_old(i_end  ,k,j)                  &amp;<a name='3657'>
                           - field_old(i_end-1,k,j) ) +              &amp;<a name='3658'>
                       field(i_end,k,j)*(ru(ite,k,j)-ru(ite-1,k,j))  &amp;<a name='3659'>
                                                                    )<a name='3660'>
       ENDDO<a name='3661'>
       ENDDO<a name='3662'>
<a name='3663'>
   ENDIF<a name='3664'>
<a name='3665'>
   IF( (config_flags%open_ys) .and. (jts == jds) ) THEN<a name='3666'>
<a name='3667'>
       DO i = i_start, i_end<a name='3668'>
       DO k = kts, ktf<a name='3669'>
         vb = MIN( 0.5*(rv(i,k,jts)+rv(i,k,jts+1)), 0. )<a name='3670'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='3671'>
               - rdy*(                                             &amp;<a name='3672'>
                       vb*(  field_old(i,k,jts+1)                  &amp;<a name='3673'>
                           - field_old(i,k,jts  ) ) +              &amp;<a name='3674'>
                       field(i,k,jts)*(rv(i,k,jts+1)-rv(i,k,jts))  &amp;<a name='3675'>
                                                                )<a name='3676'>
       ENDDO<a name='3677'>
       ENDDO<a name='3678'>
<a name='3679'>
   ENDIF<a name='3680'>
<a name='3681'>
   IF( (config_flags%open_ye) .and. (jte == jde)) THEN<a name='3682'>
<a name='3683'>
       DO i = i_start, i_end<a name='3684'>
       DO k = kts, ktf<a name='3685'>
         vb = MAX( 0.5*(rv(i,k,jte-1)+rv(i,k,jte)), 0. )<a name='3686'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                   &amp;<a name='3687'>
               - rdy*(                                               &amp;<a name='3688'>
                       vb*(   field_old(i,k,j_end  )                 &amp;<a name='3689'>
                            - field_old(i,k,j_end-1) ) +             &amp;<a name='3690'>
                       field(i,k,j_end)*(rv(i,k,jte)-rv(i,k,jte-1))  &amp;<a name='3691'>
                                                                    )<a name='3692'>
       ENDDO<a name='3693'>
       ENDDO<a name='3694'>
<a name='3695'>
   ENDIF<a name='3696'>
<a name='3697'>
<a name='3698'>
<font color=#447700>!-------------------- vertical advection<a name='3699'></font>
<a name='3700'>
      i_start = its<a name='3701'>
      i_end   = MIN(ite,ide-1)<a name='3702'>
      j_start = jts<a name='3703'>
      j_end   = MIN(jte,jde-1)<a name='3704'>
<a name='3705'>
      DO i = i_start, i_end<a name='3706'>
         vflux(i,kts)=0.<a name='3707'>
         vflux(i,kte)=0.<a name='3708'>
      ENDDO<a name='3709'>
<a name='3710'>
    vert_order_test : IF (vert_order == 6) THEN    <a name='3711'>
<a name='3712'>
      DO j = j_start, j_end<a name='3713'>
<a name='3714'>
         DO k=kts+3,ktf-2<a name='3715'>
         DO i = i_start, i_end<a name='3716'>
           vel=rom(i,k,j)<a name='3717'>
           vflux(i,k) = vel*flux6(                                 &amp;<a name='3718'>
                   field(i,k-3,j), field(i,k-2,j), field(i,k-1,j),       &amp;<a name='3719'>
                   field(i,k  ,j), field(i,k+1,j), field(i,k+2,j),  -vel )<a name='3720'>
         ENDDO<a name='3721'>
         ENDDO<a name='3722'>
<a name='3723'>
         DO i = i_start, i_end<a name='3724'>
<a name='3725'>
           k=kts+1<a name='3726'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='3727'>
                                   <a name='3728'>
           k = kts+2<a name='3729'>
           vel=rom(i,k,j) <a name='3730'>
           vflux(i,k) = vel*flux4(               &amp;<a name='3731'>
                   field(i,k-2,j), field(i,k-1,j),   &amp;<a name='3732'>
                   field(i,k  ,j), field(i,k+1,j), -vel )<a name='3733'>
           k = ktf-1<a name='3734'>
           vel=rom(i,k,j)<a name='3735'>
           vflux(i,k) = vel*flux4(               &amp;<a name='3736'>
                   field(i,k-2,j), field(i,k-1,j),   &amp;<a name='3737'>
                   field(i,k  ,j), field(i,k+1,j), -vel )<a name='3738'>
<a name='3739'>
           k=ktf<a name='3740'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='3741'>
         ENDDO<a name='3742'>
<a name='3743'>
         DO k=kts,ktf<a name='3744'>
         DO i = i_start, i_end<a name='3745'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='3746'>
         ENDDO<a name='3747'>
         ENDDO<a name='3748'>
<a name='3749'>
      ENDDO<a name='3750'>
<a name='3751'>
   ELSE IF (vert_order == 5) THEN    <a name='3752'>
<a name='3753'>
      DO j = j_start, j_end<a name='3754'>
<a name='3755'>
         DO k=kts+3,ktf-2<a name='3756'>
         DO i = i_start, i_end<a name='3757'>
           vel=rom(i,k,j)<a name='3758'>
           vflux(i,k) = vel*flux5(                                 &amp;<a name='3759'>
                   field(i,k-3,j), field(i,k-2,j), field(i,k-1,j),       &amp;<a name='3760'>
                   field(i,k  ,j), field(i,k+1,j), field(i,k+2,j),  -vel )<a name='3761'>
         ENDDO<a name='3762'>
         ENDDO<a name='3763'>
<a name='3764'>
         DO i = i_start, i_end<a name='3765'>
<a name='3766'>
           k=kts+1<a name='3767'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='3768'>
                                   <a name='3769'>
           k = kts+2<a name='3770'>
           vel=rom(i,k,j) <a name='3771'>
           vflux(i,k) = vel*flux3(               &amp;<a name='3772'>
                   field(i,k-2,j), field(i,k-1,j),   &amp;<a name='3773'>
                   field(i,k  ,j), field(i,k+1,j), -vel )<a name='3774'>
           k = ktf-1<a name='3775'>
           vel=rom(i,k,j)<a name='3776'>
           vflux(i,k) = vel*flux3(               &amp;<a name='3777'>
                   field(i,k-2,j), field(i,k-1,j),   &amp;<a name='3778'>
                   field(i,k  ,j), field(i,k+1,j), -vel )<a name='3779'>
<a name='3780'>
           k=ktf<a name='3781'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='3782'>
         ENDDO<a name='3783'>
<a name='3784'>
         DO k=kts,ktf<a name='3785'>
         DO i = i_start, i_end<a name='3786'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='3787'>
         ENDDO<a name='3788'>
         ENDDO<a name='3789'>
<a name='3790'>
      ENDDO<a name='3791'>
<a name='3792'>
   ELSE IF (vert_order == 4) THEN    <a name='3793'>
<a name='3794'>
      DO j = j_start, j_end<a name='3795'>
<a name='3796'>
         DO k=kts+2,ktf-1<a name='3797'>
         DO i = i_start, i_end<a name='3798'>
           vel=rom(i,k,j)<a name='3799'>
           vflux(i,k) = vel*flux4(                                 &amp;<a name='3800'>
                   field(i,k-2,j), field(i,k-1,j),       &amp;<a name='3801'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='3802'>
         ENDDO<a name='3803'>
         ENDDO<a name='3804'>
<a name='3805'>
         DO i = i_start, i_end<a name='3806'>
<a name='3807'>
           k=kts+1<a name='3808'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='3809'>
           k=ktf<a name='3810'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='3811'>
         ENDDO<a name='3812'>
<a name='3813'>
         DO k=kts,ktf<a name='3814'>
         DO i = i_start, i_end<a name='3815'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='3816'>
         ENDDO<a name='3817'>
         ENDDO<a name='3818'>
<a name='3819'>
      ENDDO<a name='3820'>
<a name='3821'>
   ELSE IF (vert_order == 3) THEN    <a name='3822'>
<a name='3823'>
      DO j = j_start, j_end<a name='3824'>
<a name='3825'>
         DO k=kts+2,ktf-1<a name='3826'>
         DO i = i_start, i_end<a name='3827'>
           vel=rom(i,k,j)<a name='3828'>
           vflux(i,k) = vel*flux3(                      &amp;<a name='3829'>
                   field(i,k-2,j), field(i,k-1,j),      &amp;<a name='3830'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='3831'>
         ENDDO<a name='3832'>
         ENDDO<a name='3833'>
<a name='3834'>
         DO i = i_start, i_end<a name='3835'>
<a name='3836'>
           k=kts+1<a name='3837'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='3838'>
           k=ktf<a name='3839'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='3840'>
         ENDDO<a name='3841'>
<a name='3842'>
         DO k=kts,ktf<a name='3843'>
         DO i = i_start, i_end<a name='3844'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='3845'>
         ENDDO<a name='3846'>
         ENDDO<a name='3847'>
<a name='3848'>
      ENDDO<a name='3849'>
<a name='3850'>
<a name='3851'>
   ELSE IF (vert_order == 2) THEN    <a name='3852'>
<a name='3853'>
  DO j = j_start, j_end<a name='3854'>
     DO k = kts+1, ktf<a name='3855'>
     DO i = i_start, i_end<a name='3856'>
            vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='3857'>
     ENDDO<a name='3858'>
     ENDDO<a name='3859'>
<a name='3860'>
     DO k = kts, ktf<a name='3861'>
     DO i = i_start, i_end<a name='3862'>
       tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='3863'>
     ENDDO<a name='3864'>
     ENDDO<a name='3865'>
<a name='3866'>
  ENDDO<a name='3867'>
<a name='3868'>
   ELSE<a name='3869'>
<a name='3870'>
      WRITE (wrf_err_message,*) ' advect_scalar_6a, v_order not known ',vert_order<a name='3871'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_13"> ( wrf_err_message )<a name='3872'>
<a name='3873'>
   ENDIF vert_order_test<a name='3874'>
<a name='3875'>
END SUBROUTINE advect_scalar<a name='3876'>
<a name='3877'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='3878'></font>
<a name='3879'>
<A NAME='ADVECT_W'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3880'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_w</font>    ( w, w_old, tendency,            &amp; <A href='../../call_to/ADVECT_W.html' TARGET='index'>2</A>,<A href='../../call_from/ADVECT_W.html' TARGET='index'>2</A><a name='3881'>
                         ru, rv, rom,                   &amp;<a name='3882'>
                         mut, config_flags,             &amp;<a name='3883'>
                         msfu, msfv, msft,              &amp;<a name='3884'>
                         fzm, fzp,                      &amp;<a name='3885'>
                         rdx, rdy, rdzu,                &amp;<a name='3886'>
                         ids, ide, jds, jde, kds, kde,  &amp;<a name='3887'>
                         ims, ime, jms, jme, kms, kme,  &amp;<a name='3888'>
                         its, ite, jts, jte, kts, kte  )<a name='3889'>
<a name='3890'>
   IMPLICIT NONE<a name='3891'>
   <a name='3892'>
   <font color=#447700>! Input data<a name='3893'></font>
   <a name='3894'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3895'>
<a name='3896'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3897'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='3898'>
                                              its, ite, jts, jte, kts, kte<a name='3899'>
<a name='3900'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: w,     &amp;<a name='3901'>
                                                                      w_old, &amp;<a name='3902'>
                                                                      ru,    &amp;<a name='3903'>
                                                                      rv,    &amp;<a name='3904'>
                                                                      rom<a name='3905'>
<a name='3906'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='3907'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='3908'>
<a name='3909'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfu,  &amp;<a name='3910'>
                                                                    msfv,  &amp;<a name='3911'>
                                                                    msft<a name='3912'>
<a name='3913'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='3914'>
                                                                  fzp,  &amp;<a name='3915'>
                                                                  rdzu<a name='3916'>
<a name='3917'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='3918'>
                                                                  rdy<a name='3919'>
<a name='3920'>
   <font color=#447700>! Local data<a name='3921'></font>
   <a name='3922'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3923'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3924'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='3925'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='3926'>
<a name='3927'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw<a name='3928'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='3929'>
<a name='3930'>
   INTEGER :: horz_order, vert_order<a name='3931'>
<a name='3932'>
   REAL,  DIMENSION( its:ite+1, kts:kte ) :: fqx<a name='3933'>
   REAL,  DIMENSION( its:ite, kts:kte, 2 ) :: fqy<a name='3934'>
   <a name='3935'>
   LOGICAL :: degrade_xs, degrade_ys<a name='3936'>
   LOGICAL :: degrade_xe, degrade_ye<a name='3937'>
<a name='3938'>
   INTEGER :: jp1, jp0, jtmp<a name='3939'>
<a name='3940'>
<font color=#447700>! definition of flux operators, 3rd, 4rth, 5th or 6th order<a name='3941'></font>
<a name='3942'>
   REAL    :: flux3, flux4, flux5, flux6<a name='3943'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='3944'>
<a name='3945'>
      flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='3946'>
            (7./12.)*(q_i + q_im1) - (1./12.)*(q_ip1 + q_im2)<a name='3947'>
<a name='3948'>
      flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='3949'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='3950'>
           sign(1.,ua)*(1./12.)*((q_ip1 - q_im2)-3.*(q_i-q_im1))<a name='3951'>
<a name='3952'>
      flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='3953'>
            (37./60.)*(q_i+q_im1) - (2./15.)*(q_ip1+q_im2)      &amp;<a name='3954'>
            +(1./60.)*(q_ip2+q_im3)<a name='3955'>
<a name='3956'>
      flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='3957'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='3958'>
            -sign(1.,ua)*(1./60.)*(                             &amp;<a name='3959'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )<a name='3960'>
<a name='3961'>
<a name='3962'>
   LOGICAL :: specified<a name='3963'>
<a name='3964'>
   specified = .false.<a name='3965'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3966'>
<a name='3967'>
<font color=#447700>!  set order for the advection scheme<a name='3968'></font>
<a name='3969'>
  ktf=MIN(kte,kde-1)<a name='3970'>
  horz_order = config_flags%h_sca_adv_order<a name='3971'>
  vert_order = config_flags%v_sca_adv_order<a name='3972'>
<a name='3973'>
<font color=#447700>!  here is the choice of flux operators<a name='3974'></font>
<a name='3975'>
<font color=#447700>!  begin with horizontal flux divergence<a name='3976'></font>
<a name='3977'>
  horizontal_order_test : IF( horz_order == 6 ) THEN<a name='3978'>
<a name='3979'>
<font color=#447700>!  determine boundary mods for flux operators<a name='3980'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='3981'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='3982'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='3983'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='3984'></font>
<font color=#447700>!   of the higher order flux stencils<a name='3985'></font>
<a name='3986'>
   degrade_xs = .true.<a name='3987'>
   degrade_xe = .true.<a name='3988'>
   degrade_ys = .true.<a name='3989'>
   degrade_ye = .true.<a name='3990'>
<a name='3991'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3992'>
       config_flags%symmetric_xs .or. &amp;<a name='3993'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='3994'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3995'>
       config_flags%symmetric_xe .or. &amp;<a name='3996'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='3997'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3998'>
       config_flags%symmetric_ys .or. &amp;<a name='3999'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='4000'>
   IF( config_flags%periodic_y   .or. &amp;<a name='4001'>
       config_flags%symmetric_ye .or. &amp;<a name='4002'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='4003'>
<a name='4004'>
<font color=#447700>!--------------- y - advection first<a name='4005'></font>
<a name='4006'>
      i_start = its<a name='4007'>
      i_end   = MIN(ite,ide-1)<a name='4008'>
      j_start = jts<a name='4009'>
      j_end   = MIN(jte,jde-1)<a name='4010'>
<a name='4011'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='4012'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='4013'></font>
<a name='4014'>
      j_start_f = j_start<a name='4015'>
      j_end_f   = j_end+1<a name='4016'>
<a name='4017'>
      IF(degrade_ys) then<a name='4018'>
        j_start = MAX(jts,jds+1)<a name='4019'>
        j_start_f = jds+3<a name='4020'>
      ENDIF<a name='4021'>
<a name='4022'>
      IF(degrade_ye) then<a name='4023'>
        j_end = MIN(jte,jde-2)<a name='4024'>
        j_end_f = jde-3<a name='4025'>
      ENDIF<a name='4026'>
<a name='4027'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='4028'></font>
<a name='4029'>
     jp1 = 2<a name='4030'>
     jp0 = 1<a name='4031'>
<a name='4032'>
     j_loop_y_flux_6 : DO j = j_start, j_end+1<a name='4033'>
<a name='4034'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN<a name='4035'>
<a name='4036'>
        DO k=kts+1,ktf<a name='4037'>
        DO i = i_start, i_end<a name='4038'>
          vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4039'>
          fqy( i, k, jp1 ) = vel*flux6(                     &amp;<a name='4040'>
                  w(i,k,j-3), w(i,k,j-2), w(i,k,j-1),       &amp;<a name='4041'>
                  w(i,k,j  ), w(i,k,j+1), w(i,k,j+2),  vel )<a name='4042'>
        ENDDO<a name='4043'>
        ENDDO<a name='4044'>
<a name='4045'>
        k = ktf+1<a name='4046'>
        DO i = i_start, i_end<a name='4047'>
          vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4048'>
          fqy( i, k, jp1 ) = vel*flux6(                     &amp;<a name='4049'>
                  w(i,k,j-3), w(i,k,j-2), w(i,k,j-1),       &amp;<a name='4050'>
                  w(i,k,j  ), w(i,k,j+1), w(i,k,j+2),  vel )<a name='4051'>
        ENDDO<a name='4052'>
<a name='4053'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='4054'></font>
<a name='4055'>
            DO k=kts+1,ktf<a name='4056'>
            DO i = i_start, i_end<a name='4057'>
              fqy(i, k, jp1) = 0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))*          &amp;<a name='4058'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4059'>
            ENDDO<a name='4060'>
            ENDDO<a name='4061'>
<a name='4062'>
            k = ktf+1<a name='4063'>
            DO i = i_start, i_end<a name='4064'>
              fqy(i, k, jp1) = 0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))* &amp;<a name='4065'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4066'>
            ENDDO<a name='4067'>
<a name='4068'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4rth order flux 2 in from south boundary<a name='4069'></font>
<a name='4070'>
            DO k=kts+1,ktf<a name='4071'>
            DO i = i_start, i_end<a name='4072'>
              vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4073'>
              fqy( i, k, jp1 ) = vel*flux4(              &amp;<a name='4074'>
                   w(i,k,j-2),w(i,k,j-1),w(i,k,j),w(i,k,j+1),vel )<a name='4075'>
            ENDDO<a name='4076'>
            ENDDO<a name='4077'>
<a name='4078'>
            k = ktf+1<a name='4079'>
            DO i = i_start, i_end<a name='4080'>
              vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4081'>
              fqy( i, k, jp1 ) = vel*flux4(              &amp;<a name='4082'>
                   w(i,k,j-2),w(i,k,j-1),w(i,k,j),w(i,k,j+1),vel )<a name='4083'>
            ENDDO<a name='4084'>
<a name='4085'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='4086'></font>
<a name='4087'>
            DO k=kts+1,ktf<a name='4088'>
            DO i = i_start, i_end<a name='4089'>
              fqy(i, k, jp1) = 0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))*      &amp;<a name='4090'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4091'>
            ENDDO<a name='4092'>
            ENDDO<a name='4093'>
<a name='4094'>
            k = ktf+1<a name='4095'>
            DO i = i_start, i_end<a name='4096'>
              fqy(i, k, jp1) = 0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))*      &amp;<a name='4097'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4098'>
            ENDDO<a name='4099'>
<a name='4100'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4rth order flux 2 in from north boundary<a name='4101'></font>
<a name='4102'>
            DO k=kts+1,ktf<a name='4103'>
            DO i = i_start, i_end<a name='4104'>
              vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4105'>
              fqy( i, k, jp1 ) = vel*flux4(             &amp;<a name='4106'>
                   w(i,k,j-2),w(i,k,j-1),    &amp;<a name='4107'>
                   w(i,k,j),w(i,k,j+1),vel )<a name='4108'>
            ENDDO<a name='4109'>
            ENDDO<a name='4110'>
<a name='4111'>
            k = ktf+1<a name='4112'>
            DO i = i_start, i_end<a name='4113'>
              vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4114'>
              fqy( i, k, jp1 ) = vel*flux4(             &amp;<a name='4115'>
                   w(i,k,j-2),w(i,k,j-1),    &amp;<a name='4116'>
                   w(i,k,j),w(i,k,j+1),vel )<a name='4117'>
            ENDDO<a name='4118'>
<a name='4119'>
     ENDIF<a name='4120'>
<a name='4121'>
<font color=#447700>!  y flux-divergence into tendency<a name='4122'></font>
<a name='4123'>
        IF(j &gt; j_start) THEN<a name='4124'>
<a name='4125'>
          DO k=kts+1,ktf+1<a name='4126'>
          DO i = i_start, i_end<a name='4127'>
            mrdy=msft(i,j-1)*rdy<a name='4128'>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='4129'>
          ENDDO<a name='4130'>
          ENDDO<a name='4131'>
<a name='4132'>
       ENDIF<a name='4133'>
<a name='4134'>
        jtmp = jp1<a name='4135'>
        jp1 = jp0<a name='4136'>
        jp0 = jtmp<a name='4137'>
<a name='4138'>
      ENDDO j_loop_y_flux_6<a name='4139'>
<a name='4140'>
<font color=#447700>!  next, x - flux divergence<a name='4141'></font>
<a name='4142'>
      i_start = its<a name='4143'>
      i_end   = MIN(ite,ide-1)<a name='4144'>
<a name='4145'>
      j_start = jts<a name='4146'>
      j_end   = MIN(jte,jde-1)<a name='4147'>
<a name='4148'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='4149'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='4150'></font>
<a name='4151'>
      i_start_f = i_start<a name='4152'>
      i_end_f   = i_end+1<a name='4153'>
<a name='4154'>
      IF(degrade_xs) then<a name='4155'>
        i_start = MAX(ids+1,its)<a name='4156'>
        i_start_f = i_start+2<a name='4157'>
      ENDIF<a name='4158'>
<a name='4159'>
      IF(degrade_xe) then<a name='4160'>
        i_end = MIN(ide-2,ite)<a name='4161'>
        i_end_f = ide-3<a name='4162'>
      ENDIF<a name='4163'>
<a name='4164'>
<font color=#447700>!  compute fluxes<a name='4165'></font>
<a name='4166'>
      DO j = j_start, j_end<a name='4167'>
<a name='4168'>
<font color=#447700>!  5th or 6th order flux<a name='4169'></font>
<a name='4170'>
        DO k=kts+1,ktf<a name='4171'>
        DO i = i_start_f, i_end_f<a name='4172'>
          vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='4173'>
          fqx( i,k ) = vel*flux6( w(i-3,k,j), w(i-2,k,j),  &amp;<a name='4174'>
                                         w(i-1,k,j), w(i  ,k,j),  &amp;<a name='4175'>
                                         w(i+1,k,j), w(i+2,k,j),  &amp;<a name='4176'>
                                         vel                             )<a name='4177'>
        ENDDO<a name='4178'>
        ENDDO<a name='4179'>
<a name='4180'>
        k = ktf+1<a name='4181'>
        DO i = i_start_f, i_end_f<a name='4182'>
          vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='4183'>
          fqx( i,k ) = vel*flux6( w(i-3,k,j), w(i-2,k,j),  &amp;<a name='4184'>
                                         w(i-1,k,j), w(i  ,k,j),  &amp;<a name='4185'>
                                         w(i+1,k,j), w(i+2,k,j),  &amp;<a name='4186'>
                                         vel                             )<a name='4187'>
        ENDDO<a name='4188'>
<a name='4189'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='4190'></font>
<a name='4191'>
        IF( degrade_xs ) THEN<a name='4192'>
<a name='4193'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='4194'></font>
            i = ids+1<a name='4195'>
            DO k=kts+1,ktf<a name='4196'>
              fqx(i,k) = 0.5*(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)) &amp;<a name='4197'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='4198'>
            ENDDO<a name='4199'>
              k = ktf+1<a name='4200'>
              fqx(i,k) = 0.5*((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)) &amp;<a name='4201'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='4202'>
          ENDIF<a name='4203'>
<a name='4204'>
          DO k=kts+1,ktf<a name='4205'>
            i = i_start+1<a name='4206'>
            vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='4207'>
            fqx( i,k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4208'>
                                          w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4209'>
                                          vel                     )<a name='4210'>
          ENDDO<a name='4211'>
<a name='4212'>
            k = ktf+1<a name='4213'>
            vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='4214'>
            fqx( i,k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4215'>
                                          w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4216'>
                                          vel                     )<a name='4217'>
        ENDIF<a name='4218'>
<a name='4219'>
        IF( degrade_xe ) THEN<a name='4220'>
<a name='4221'>
          IF( i_end == ide-2 ) THEN <font color=#447700>! second order flux next to the boundary<a name='4222'></font>
            i = ide-1<a name='4223'>
            DO k=kts+1,ktf<a name='4224'>
              fqx(i,k) = 0.5*(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j))      &amp;<a name='4225'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='4226'>
            ENDDO<a name='4227'>
              k = ktf+1<a name='4228'>
              fqx(i,k) = 0.5*((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j))      &amp;<a name='4229'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='4230'>
          ENDIF<a name='4231'>
<a name='4232'>
          i = ide-2<a name='4233'>
          DO k=kts+1,ktf<a name='4234'>
            vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='4235'>
            fqx( i,k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4236'>
                                          w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4237'>
                                          vel                             )<a name='4238'>
          ENDDO<a name='4239'>
<a name='4240'>
            k = ktf+1<a name='4241'>
            vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='4242'>
            fqx( i,k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4243'>
                                          w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4244'>
                                          vel                             )<a name='4245'>
        ENDIF<a name='4246'>
<a name='4247'>
<font color=#447700>!  x flux-divergence into tendency<a name='4248'></font>
<a name='4249'>
        DO k=kts+1,ktf+1<a name='4250'>
          DO i = i_start, i_end<a name='4251'>
            mrdx=msft(i,j)*rdx<a name='4252'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='4253'>
          ENDDO<a name='4254'>
        ENDDO<a name='4255'>
<a name='4256'>
      ENDDO<a name='4257'>
<a name='4258'>
<a name='4259'>
ELSE IF (horz_order == 5 ) THEN<a name='4260'>
<a name='4261'>
<font color=#447700>!  determine boundary mods for flux operators<a name='4262'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='4263'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='4264'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='4265'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='4266'></font>
<font color=#447700>!   of the higher order flux stencils<a name='4267'></font>
<a name='4268'>
   degrade_xs = .true.<a name='4269'>
   degrade_xe = .true.<a name='4270'>
   degrade_ys = .true.<a name='4271'>
   degrade_ye = .true.<a name='4272'>
<a name='4273'>
   IF( config_flags%periodic_x   .or. &amp;<a name='4274'>
       config_flags%symmetric_xs .or. &amp;<a name='4275'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='4276'>
   IF( config_flags%periodic_x   .or. &amp;<a name='4277'>
       config_flags%symmetric_xe .or. &amp;<a name='4278'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='4279'>
   IF( config_flags%periodic_y   .or. &amp;<a name='4280'>
       config_flags%symmetric_ys .or. &amp;<a name='4281'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='4282'>
   IF( config_flags%periodic_y   .or. &amp;<a name='4283'>
       config_flags%symmetric_ye .or. &amp;<a name='4284'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='4285'>
<a name='4286'>
<font color=#447700>!--------------- y - advection first<a name='4287'></font>
<a name='4288'>
      i_start = its<a name='4289'>
      i_end   = MIN(ite,ide-1)<a name='4290'>
      j_start = jts<a name='4291'>
      j_end   = MIN(jte,jde-1)<a name='4292'>
<a name='4293'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='4294'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='4295'></font>
<a name='4296'>
      j_start_f = j_start<a name='4297'>
      j_end_f   = j_end+1<a name='4298'>
<a name='4299'>
      IF(degrade_ys) then<a name='4300'>
        j_start = MAX(jts,jds+1)<a name='4301'>
        j_start_f = jds+3<a name='4302'>
      ENDIF<a name='4303'>
<a name='4304'>
      IF(degrade_ye) then<a name='4305'>
        j_end = MIN(jte,jde-2)<a name='4306'>
        j_end_f = jde-3<a name='4307'>
      ENDIF<a name='4308'>
<a name='4309'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='4310'></font>
<a name='4311'>
     jp1 = 2<a name='4312'>
     jp0 = 1<a name='4313'>
<a name='4314'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='4315'>
<a name='4316'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN<a name='4317'>
<a name='4318'>
        DO k=kts+1,ktf<a name='4319'>
        DO i = i_start, i_end<a name='4320'>
          vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4321'>
          fqy( i, k, jp1 ) = vel*flux5(                     &amp;<a name='4322'>
                  w(i,k,j-3), w(i,k,j-2), w(i,k,j-1),       &amp;<a name='4323'>
                  w(i,k,j  ), w(i,k,j+1), w(i,k,j+2),  vel )<a name='4324'>
        ENDDO<a name='4325'>
        ENDDO<a name='4326'>
<a name='4327'>
        k = ktf+1<a name='4328'>
        DO i = i_start, i_end<a name='4329'>
          vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4330'>
          fqy( i, k, jp1 ) = vel*flux5(                     &amp;<a name='4331'>
                  w(i,k,j-3), w(i,k,j-2), w(i,k,j-1),       &amp;<a name='4332'>
                  w(i,k,j  ), w(i,k,j+1), w(i,k,j+2),  vel )<a name='4333'>
        ENDDO<a name='4334'>
<a name='4335'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='4336'></font>
<a name='4337'>
            DO k=kts+1,ktf<a name='4338'>
            DO i = i_start, i_end<a name='4339'>
              fqy(i, k, jp1) = 0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))*          &amp;<a name='4340'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4341'>
            ENDDO<a name='4342'>
            ENDDO<a name='4343'>
<a name='4344'>
            k = ktf+1<a name='4345'>
            DO i = i_start, i_end<a name='4346'>
              fqy(i, k, jp1) = 0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))*          &amp;<a name='4347'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4348'>
            ENDDO<a name='4349'>
<a name='4350'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4rth order flux 2 in from south boundary<a name='4351'></font>
<a name='4352'>
            DO k=kts+1,ktf<a name='4353'>
            DO i = i_start, i_end<a name='4354'>
              vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4355'>
              fqy( i, k, jp1 ) = vel*flux3(              &amp;<a name='4356'>
                   w(i,k,j-2),w(i,k,j-1),w(i,k,j),w(i,k,j+1),vel )<a name='4357'>
            ENDDO<a name='4358'>
            ENDDO<a name='4359'>
<a name='4360'>
            k = ktf+1<a name='4361'>
            DO i = i_start, i_end<a name='4362'>
              vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4363'>
              fqy( i, k, jp1 ) = vel*flux3(              &amp;<a name='4364'>
                   w(i,k,j-2),w(i,k,j-1),w(i,k,j),w(i,k,j+1),vel )<a name='4365'>
            ENDDO<a name='4366'>
<a name='4367'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='4368'></font>
<a name='4369'>
            DO k=kts+1,ktf<a name='4370'>
            DO i = i_start, i_end<a name='4371'>
              fqy(i, k, jp1) = 0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))*      &amp;<a name='4372'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4373'>
            ENDDO<a name='4374'>
            ENDDO<a name='4375'>
<a name='4376'>
            k = ktf+1<a name='4377'>
            DO i = i_start, i_end<a name='4378'>
              fqy(i, k, jp1) = 0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))*      &amp;<a name='4379'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4380'>
            ENDDO<a name='4381'>
<a name='4382'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4rth order flux 2 in from north boundary<a name='4383'></font>
<a name='4384'>
            DO k=kts+1,ktf<a name='4385'>
            DO i = i_start, i_end<a name='4386'>
              vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4387'>
              fqy( i, k, jp1 ) = vel*flux3(             &amp;<a name='4388'>
                   w(i,k,j-2),w(i,k,j-1),    &amp;<a name='4389'>
                   w(i,k,j),w(i,k,j+1),vel )<a name='4390'>
            ENDDO<a name='4391'>
            ENDDO<a name='4392'>
<a name='4393'>
            k = ktf+1<a name='4394'>
            DO i = i_start, i_end<a name='4395'>
              vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4396'>
              fqy( i, k, jp1 ) = vel*flux3(             &amp;<a name='4397'>
                   w(i,k,j-2),w(i,k,j-1),    &amp;<a name='4398'>
                   w(i,k,j),w(i,k,j+1),vel )<a name='4399'>
            ENDDO<a name='4400'>
<a name='4401'>
     ENDIF<a name='4402'>
<a name='4403'>
<font color=#447700>!  y flux-divergence into tendency<a name='4404'></font>
<a name='4405'>
        IF(j &gt; j_start) THEN<a name='4406'>
<a name='4407'>
          DO k=kts+1,ktf+1<a name='4408'>
          DO i = i_start, i_end<a name='4409'>
            mrdy=msft(i,j-1)*rdy<a name='4410'>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='4411'>
          ENDDO<a name='4412'>
          ENDDO<a name='4413'>
<a name='4414'>
       ENDIF<a name='4415'>
<a name='4416'>
        jtmp = jp1<a name='4417'>
        jp1 = jp0<a name='4418'>
        jp0 = jtmp<a name='4419'>
<a name='4420'>
      ENDDO j_loop_y_flux_5<a name='4421'>
<a name='4422'>
<font color=#447700>!  next, x - flux divergence<a name='4423'></font>
<a name='4424'>
      i_start = its<a name='4425'>
      i_end   = MIN(ite,ide-1)<a name='4426'>
<a name='4427'>
      j_start = jts<a name='4428'>
      j_end   = MIN(jte,jde-1)<a name='4429'>
<a name='4430'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='4431'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='4432'></font>
<a name='4433'>
      i_start_f = i_start<a name='4434'>
      i_end_f   = i_end+1<a name='4435'>
<a name='4436'>
      IF(degrade_xs) then<a name='4437'>
        i_start = MAX(ids+1,its)<a name='4438'>
        i_start_f = i_start+2<a name='4439'>
      ENDIF<a name='4440'>
<a name='4441'>
      IF(degrade_xe) then<a name='4442'>
        i_end = MIN(ide-2,ite)<a name='4443'>
        i_end_f = ide-3<a name='4444'>
      ENDIF<a name='4445'>
<a name='4446'>
<font color=#447700>!  compute fluxes<a name='4447'></font>
<a name='4448'>
      DO j = j_start, j_end<a name='4449'>
<a name='4450'>
<font color=#447700>!  5th or 6th order flux<a name='4451'></font>
<a name='4452'>
        DO k=kts+1,ktf<a name='4453'>
        DO i = i_start_f, i_end_f<a name='4454'>
          vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='4455'>
          fqx( i,k ) = vel*flux5( w(i-3,k,j), w(i-2,k,j),  &amp;<a name='4456'>
                                  w(i-1,k,j), w(i  ,k,j),  &amp;<a name='4457'>
                                  w(i+1,k,j), w(i+2,k,j),  &amp;<a name='4458'>
                          vel                             )<a name='4459'>
        ENDDO<a name='4460'>
        ENDDO<a name='4461'>
<a name='4462'>
        k = ktf+1<a name='4463'>
        DO i = i_start_f, i_end_f<a name='4464'>
          vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='4465'>
          fqx( i,k ) = vel*flux5( w(i-3,k,j), w(i-2,k,j),  &amp;<a name='4466'>
                                  w(i-1,k,j), w(i  ,k,j),  &amp;<a name='4467'>
                                  w(i+1,k,j), w(i+2,k,j),  &amp;<a name='4468'>
                          vel                             )<a name='4469'>
        ENDDO<a name='4470'>
<a name='4471'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='4472'></font>
<a name='4473'>
        IF( degrade_xs ) THEN<a name='4474'>
<a name='4475'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='4476'></font>
            i = ids+1<a name='4477'>
            DO k=kts+1,ktf<a name='4478'>
              fqx(i,k) = 0.5*(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)) &amp;<a name='4479'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='4480'>
            ENDDO<a name='4481'>
              k = ktf+1<a name='4482'>
              fqx(i,k) = 0.5*((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)) &amp;<a name='4483'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='4484'>
          ENDIF<a name='4485'>
<a name='4486'>
          i = i_start+1<a name='4487'>
          DO k=kts+1,ktf<a name='4488'>
            vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='4489'>
            fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4490'>
                                    w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4491'>
                                          vel                     )<a name='4492'>
          ENDDO<a name='4493'>
            k = ktf+1<a name='4494'>
            vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='4495'>
            fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4496'>
                                    w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4497'>
                                          vel                     )<a name='4498'>
<a name='4499'>
        ENDIF<a name='4500'>
<a name='4501'>
        IF( degrade_xe ) THEN<a name='4502'>
<a name='4503'>
          IF( i_end == ide-2 ) THEN <font color=#447700>! second order flux next to the boundary<a name='4504'></font>
            i = ide-1<a name='4505'>
            DO k=kts+1,ktf<a name='4506'>
              fqx(i,k) = 0.5*(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j))      &amp;<a name='4507'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='4508'>
            ENDDO<a name='4509'>
              k = ktf+1<a name='4510'>
              fqx(i,k) = 0.5*((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j))      &amp;<a name='4511'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='4512'>
          ENDIF<a name='4513'>
<a name='4514'>
          i = ide-2<a name='4515'>
          DO k=kts+1,ktf<a name='4516'>
            vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='4517'>
            fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4518'>
                                          w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4519'>
                                          vel                             )<a name='4520'>
          ENDDO<a name='4521'>
            k = ktf+1<a name='4522'>
            vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='4523'>
            fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4524'>
                                          w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4525'>
                                          vel                             )<a name='4526'>
        ENDIF<a name='4527'>
<a name='4528'>
<font color=#447700>!  x flux-divergence into tendency<a name='4529'></font>
<a name='4530'>
        DO k=kts+1,ktf+1<a name='4531'>
          DO i = i_start, i_end<a name='4532'>
            mrdx=msft(i,j)*rdx<a name='4533'>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='4534'>
          ENDDO<a name='4535'>
        ENDDO<a name='4536'>
<a name='4537'>
      ENDDO<a name='4538'>
<a name='4539'>
ELSE IF ( horz_order == 4 ) THEN<a name='4540'>
<a name='4541'>
   degrade_xs = .true.<a name='4542'>
   degrade_xe = .true.<a name='4543'>
   degrade_ys = .true.<a name='4544'>
   degrade_ye = .true.<a name='4545'>
<a name='4546'>
   IF( config_flags%periodic_x   .or. &amp;<a name='4547'>
       config_flags%symmetric_xs .or. &amp;<a name='4548'>
       (its &gt; ids+1)                ) degrade_xs = .false.<a name='4549'>
   IF( config_flags%periodic_x   .or. &amp;<a name='4550'>
       config_flags%symmetric_xe .or. &amp;<a name='4551'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='4552'>
   IF( config_flags%periodic_y   .or. &amp;<a name='4553'>
       config_flags%symmetric_ys .or. &amp;<a name='4554'>
       (jts &gt; jds+1)                ) degrade_ys = .false.<a name='4555'>
   IF( config_flags%periodic_y   .or. &amp;<a name='4556'>
       config_flags%symmetric_ye .or. &amp;<a name='4557'>
       (jte &lt; jde-2)                ) degrade_ye = .false.<a name='4558'>
<a name='4559'>
<font color=#447700>!  begin flux computations<a name='4560'></font>
<font color=#447700>!  start with x flux divergence<a name='4561'></font>
<a name='4562'>
<font color=#447700>!---------------<a name='4563'></font>
<a name='4564'>
   ktf=MIN(kte,kde-1)<a name='4565'>
<a name='4566'>
      i_start = its<a name='4567'>
      i_end   = MIN(ite,ide-1)<a name='4568'>
      j_start = jts<a name='4569'>
      j_end   = MIN(jte,jde-1)<a name='4570'>
<a name='4571'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='4572'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='4573'></font>
<a name='4574'>
      i_start_f = i_start<a name='4575'>
      i_end_f   = i_end+1<a name='4576'>
<a name='4577'>
      IF(degrade_xs) then<a name='4578'>
        i_start = ids+1<a name='4579'>
        i_start_f = i_start+1<a name='4580'>
      ENDIF<a name='4581'>
<a name='4582'>
      IF(degrade_xe) then<a name='4583'>
        i_end = ide-2<a name='4584'>
        i_end_f = ide-2<a name='4585'>
      ENDIF<a name='4586'>
<a name='4587'>
<font color=#447700>!  compute fluxes<a name='4588'></font>
<a name='4589'>
      DO j = j_start, j_end<a name='4590'>
<a name='4591'>
        DO k=kts+1,ktf<a name='4592'>
        DO i = i_start_f, i_end_f<a name='4593'>
          vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='4594'>
          fqx( i, k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4595'>
                                  w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4596'>
                                  vel                     )<a name='4597'>
        ENDDO<a name='4598'>
        ENDDO<a name='4599'>
<a name='4600'>
        k = ktf+1<a name='4601'>
        DO i = i_start_f, i_end_f<a name='4602'>
          vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='4603'>
          fqx( i, k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4604'>
                                  w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4605'>
                                  vel                     )<a name='4606'>
        ENDDO<a name='4607'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='4608'></font>
<a name='4609'>
        IF( degrade_xs ) THEN<a name='4610'>
          DO k=kts+1,ktf<a name='4611'>
            fqx(i_start, k) =                            &amp;<a name='4612'>
               0.5*(fzm(k)*ru(i_start,k,j)+fzp(k)*ru(i_start,k-1,j))  &amp;<a name='4613'>
                   *(w(i_start,k,j)+w(i_start-1,k,j))<a name='4614'>
          ENDDO<a name='4615'>
            k = ktf+1<a name='4616'>
            fqx(i_start, k) =                            &amp;<a name='4617'>
               0.5*((2.-fzm(k-1))*ru(i_start,k-1,j)-fzp(k-1)*ru(i_start,k-2,j))  &amp;<a name='4618'>
                   *(w(i_start,k,j)+w(i_start-1,k,j))<a name='4619'>
        ENDIF<a name='4620'>
<a name='4621'>
        IF( degrade_xe ) THEN<a name='4622'>
          DO k=kts+1,ktf<a name='4623'>
            fqx(i_end+1, k) =                            &amp;<a name='4624'>
               0.5*(fzm(k)*ru(i_end+1,k,j)+fzp(k)*ru(i_end+1,k-1,j))  &amp;<a name='4625'>
                   *(w(i_end+1,k,j)+w(i_end,k,j))<a name='4626'>
          ENDDO<a name='4627'>
            k = ktf+1<a name='4628'>
            fqx(i_end+1, k) =                            &amp;<a name='4629'>
               0.5*((2.-fzm(k-1))*ru(i_end+1,k-1,j)-fzp(k-1)*ru(i_end+1,k-2,j))  &amp;<a name='4630'>
                   *(w(i_end+1,k,j)+w(i_end,k,j))<a name='4631'>
        ENDIF<a name='4632'>
<a name='4633'>
<font color=#447700>!  x flux-divergence into tendency<a name='4634'></font>
<a name='4635'>
        DO k=kts+1,ktf+1<a name='4636'>
        DO i = i_start, i_end<a name='4637'>
          mrdx=msft(i,j)*rdx<a name='4638'>
          tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='4639'>
        ENDDO<a name='4640'>
        ENDDO<a name='4641'>
<a name='4642'>
      ENDDO<a name='4643'>
<a name='4644'>
<font color=#447700>!  next -&gt; y flux divergence calculation<a name='4645'></font>
<a name='4646'>
      i_start = its<a name='4647'>
      i_end   = MIN(ite,ide-1)<a name='4648'>
      j_start = jts<a name='4649'>
      j_end   = MIN(jte,jde-1)<a name='4650'>
<a name='4651'>
<a name='4652'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='4653'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='4654'></font>
<a name='4655'>
      j_start_f = j_start<a name='4656'>
      j_end_f   = j_end+1<a name='4657'>
<a name='4658'>
      IF(degrade_ys) then<a name='4659'>
        j_start = jds+1<a name='4660'>
        j_start_f = j_start+1<a name='4661'>
      ENDIF<a name='4662'>
<a name='4663'>
      IF(degrade_ye) then<a name='4664'>
        j_end = jde-2<a name='4665'>
        j_end_f = jde-2<a name='4666'>
      ENDIF<a name='4667'>
<a name='4668'>
        jp1 = 2<a name='4669'>
        jp0 = 1<a name='4670'>
<a name='4671'>
      DO j = j_start, j_end+1<a name='4672'>
<a name='4673'>
       IF ((j &lt; j_start_f) .and. degrade_ys)  THEN<a name='4674'>
          DO k = kts+1, ktf<a name='4675'>
          DO i = i_start, i_end<a name='4676'>
            fqy(i, k, jp1) =                             &amp;<a name='4677'>
               0.5*(fzm(k)*rv(i,k,j_start)+fzp(k)*rv(i,k-1,j_start))   &amp;<a name='4678'>
                   *(w(i,k,j_start)+w(i,k,j_start-1))<a name='4679'>
          ENDDO<a name='4680'>
          ENDDO<a name='4681'>
          k = ktf+1<a name='4682'>
          DO i = i_start, i_end<a name='4683'>
            fqy(i, k, jp1) =                             &amp;<a name='4684'>
               0.5*((2.-fzm(k-1))*rv(i,k-1,j_start)-fzp(k-1)*rv(i,k-2,j_start))   &amp;<a name='4685'>
                   *(w(i,k,j_start)+w(i,k,j_start-1))<a name='4686'>
          ENDDO<a name='4687'>
       ELSE IF ((j &gt; j_end_f) .and. degrade_ye)  THEN<a name='4688'>
          DO k = kts+1, ktf<a name='4689'>
          DO i = i_start, i_end<a name='4690'>
            fqy(i, k, jp1) =                             &amp;<a name='4691'>
               0.5*(fzm(k)*rv(i,k,j_end+1)+fzp(k)*rv(i,k-1,j_end+1))     &amp;<a name='4692'>
                   *(w(i,k,j_end+1)+w(i,k,j_end))<a name='4693'>
          ENDDO<a name='4694'>
          ENDDO<a name='4695'>
          k = ktf+1<a name='4696'>
          DO i = i_start, i_end<a name='4697'>
            fqy(i, k, jp1) =                                         &amp;<a name='4698'>
               0.5*((2.-fzm(k-1))*rv(i,k-1,j_end+1)-fzp(k-1)*rv(i,k-2,j_end+1))     &amp;<a name='4699'>
                   *(w(i,k,j_end+1)+w(i,k,j_end))<a name='4700'>
          ENDDO<a name='4701'>
       ELSE<a name='4702'>
<font color=#447700>!  3rd or 4rth order flux<a name='4703'></font>
          DO k = kts+1, ktf<a name='4704'>
          DO i = i_start, i_end<a name='4705'>
            vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4706'>
            fqy( i, k, jp1 ) = vel*flux4( w(i,k,j-2), w(i,k,j-1),  &amp;<a name='4707'>
                                    w(i,k,j  ), w(i,k,j+1),  &amp;<a name='4708'>
                                    vel                     )<a name='4709'>
          ENDDO<a name='4710'>
          ENDDO<a name='4711'>
          k = ktf+1<a name='4712'>
          DO i = i_start, i_end<a name='4713'>
            vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4714'>
            fqy( i, k, jp1 ) = vel*flux4( w(i,k,j-2), w(i,k,j-1),  &amp;<a name='4715'>
                                    w(i,k,j  ), w(i,k,j+1),  &amp;<a name='4716'>
                                    vel                     )<a name='4717'>
          ENDDO<a name='4718'>
       END IF<a name='4719'>
<a name='4720'>
       IF( j &gt; j_start ) THEN<a name='4721'>
<font color=#447700>!  y flux-divergence into tendency<a name='4722'></font>
          DO k = kts+1, ktf+1<a name='4723'>
          DO i = i_start, i_end<a name='4724'>
            mrdy=msft(i,j-1)*rdy<a name='4725'>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='4726'>
          ENDDO<a name='4727'>
          ENDDO<a name='4728'>
       END IF<a name='4729'>
<a name='4730'>
       jtmp = jp1<a name='4731'>
       jp1 = jp0<a name='4732'>
       jp0 = jtmp<a name='4733'>
<a name='4734'>
    ENDDO<a name='4735'>
<a name='4736'>
ELSE IF ( horz_order == 3 ) THEN<a name='4737'>
<a name='4738'>
   degrade_xs = .true.<a name='4739'>
   degrade_xe = .true.<a name='4740'>
   degrade_ys = .true.<a name='4741'>
   degrade_ye = .true.<a name='4742'>
<a name='4743'>
   IF( config_flags%periodic_x   .or. &amp;<a name='4744'>
       config_flags%symmetric_xs .or. &amp;<a name='4745'>
       (its &gt; ids+1)                ) degrade_xs = .false.<a name='4746'>
   IF( config_flags%periodic_x   .or. &amp;<a name='4747'>
       config_flags%symmetric_xe .or. &amp;<a name='4748'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='4749'>
   IF( config_flags%periodic_y   .or. &amp;<a name='4750'>
       config_flags%symmetric_ys .or. &amp;<a name='4751'>
       (jts &gt; jds+1)                ) degrade_ys = .false.<a name='4752'>
   IF( config_flags%periodic_y   .or. &amp;<a name='4753'>
       config_flags%symmetric_ye .or. &amp;<a name='4754'>
       (jte &lt; jde-2)                ) degrade_ye = .false.<a name='4755'>
<a name='4756'>
<font color=#447700>!  begin flux computations<a name='4757'></font>
<font color=#447700>!  start with x flux divergence<a name='4758'></font>
<a name='4759'>
<font color=#447700>!---------------<a name='4760'></font>
<a name='4761'>
   ktf=MIN(kte,kde-1)<a name='4762'>
<a name='4763'>
      i_start = its<a name='4764'>
      i_end   = MIN(ite,ide-1)<a name='4765'>
      j_start = jts<a name='4766'>
      j_end   = MIN(jte,jde-1)<a name='4767'>
<a name='4768'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='4769'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='4770'></font>
<a name='4771'>
      i_start_f = i_start<a name='4772'>
      i_end_f   = i_end+1<a name='4773'>
<a name='4774'>
      IF(degrade_xs) then<a name='4775'>
        i_start = ids+1<a name='4776'>
        i_start_f = i_start+1<a name='4777'>
      ENDIF<a name='4778'>
<a name='4779'>
      IF(degrade_xe) then<a name='4780'>
        i_end = ide-2<a name='4781'>
        i_end_f = ide-2<a name='4782'>
      ENDIF<a name='4783'>
<a name='4784'>
<font color=#447700>!  compute fluxes<a name='4785'></font>
<a name='4786'>
      DO j = j_start, j_end<a name='4787'>
<a name='4788'>
        DO k=kts+1,ktf<a name='4789'>
        DO i = i_start_f, i_end_f<a name='4790'>
          vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='4791'>
          fqx( i, k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4792'>
                                  w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4793'>
                                  vel                     )<a name='4794'>
        ENDDO<a name='4795'>
        ENDDO<a name='4796'>
        k = ktf+1<a name='4797'>
        DO i = i_start_f, i_end_f<a name='4798'>
          vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='4799'>
          fqx( i, k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4800'>
                                  w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4801'>
                                  vel                     )<a name='4802'>
        ENDDO<a name='4803'>
<a name='4804'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='4805'></font>
<a name='4806'>
        IF( degrade_xs ) THEN<a name='4807'>
          DO k=kts+1,ktf<a name='4808'>
            fqx(i_start, k) =                            &amp;<a name='4809'>
               0.5*(fzm(k)*ru(i_start,k,j)+fzp(k)*ru(i_start,k-1,j))  &amp;<a name='4810'>
                   *(w(i_start,k,j)+w(i_start-1,k,j))<a name='4811'>
          ENDDO<a name='4812'>
            k = ktf+1<a name='4813'>
            fqx(i_start, k) =                            &amp;<a name='4814'>
               0.5*((2.-fzm(k-1))*ru(i_start,k-1,j)-fzp(k-1)*ru(i_start,k-2,j))  &amp;<a name='4815'>
                   *(w(i_start,k,j)+w(i_start-1,k,j))<a name='4816'>
        ENDIF<a name='4817'>
<a name='4818'>
        IF( degrade_xe ) THEN<a name='4819'>
          DO k=kts+1,ktf<a name='4820'>
            fqx(i_end+1, k) =                            &amp;<a name='4821'>
               0.5*(fzm(k)*ru(i_end+1,k,j)+fzp(k)*ru(i_end+1,k-1,j))  &amp;<a name='4822'>
                   *(w(i_end+1,k,j)+w(i_end,k,j))<a name='4823'>
          ENDDO<a name='4824'>
            k = ktf+1<a name='4825'>
            fqx(i_end+1, k) =                            &amp;<a name='4826'>
               0.5*((2.-fzm(k-1))*ru(i_end+1,k-1,j)-fzp(k-1)*ru(i_end+1,k-2,j))  &amp;<a name='4827'>
                   *(w(i_end+1,k,j)+w(i_end,k,j))<a name='4828'>
        ENDIF<a name='4829'>
<a name='4830'>
<font color=#447700>!  x flux-divergence into tendency<a name='4831'></font>
<a name='4832'>
        DO k=kts+1,ktf+1<a name='4833'>
        DO i = i_start, i_end<a name='4834'>
          mrdx=msft(i,j)*rdx<a name='4835'>
          tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='4836'>
        ENDDO<a name='4837'>
        ENDDO<a name='4838'>
<a name='4839'>
      ENDDO<a name='4840'>
<a name='4841'>
<font color=#447700>!  next -&gt; y flux divergence calculation<a name='4842'></font>
<a name='4843'>
      i_start = its<a name='4844'>
      i_end   = MIN(ite,ide-1)<a name='4845'>
      j_start = jts<a name='4846'>
      j_end   = MIN(jte,jde-1)<a name='4847'>
<a name='4848'>
<a name='4849'>
<font color=#447700>!  3rd or 4rth order flux has a 5 point stencil, so compute<a name='4850'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='4851'></font>
<a name='4852'>
      j_start_f = j_start<a name='4853'>
      j_end_f   = j_end+1<a name='4854'>
<a name='4855'>
      IF(degrade_ys) then<a name='4856'>
        j_start = jds+1<a name='4857'>
        j_start_f = j_start+1<a name='4858'>
      ENDIF<a name='4859'>
<a name='4860'>
      IF(degrade_ye) then<a name='4861'>
        j_end = jde-2<a name='4862'>
        j_end_f = jde-2<a name='4863'>
      ENDIF<a name='4864'>
<a name='4865'>
        jp1 = 2<a name='4866'>
        jp0 = 1<a name='4867'>
<a name='4868'>
      DO j = j_start, j_end+1<a name='4869'>
<a name='4870'>
       IF ((j &lt; j_start_f) .and. degrade_ys)  THEN<a name='4871'>
          DO k = kts+1, ktf<a name='4872'>
          DO i = i_start, i_end<a name='4873'>
            fqy(i, k, jp1) =                             &amp;<a name='4874'>
               0.5*(fzm(k)*rv(i,k,j_start)+fzp(k)*rv(i,k-1,j_start))   &amp;<a name='4875'>
                   *(w(i,k,j_start)+w(i,k,j_start-1))<a name='4876'>
          ENDDO<a name='4877'>
          ENDDO<a name='4878'>
          k = ktf+1<a name='4879'>
          DO i = i_start, i_end<a name='4880'>
            fqy(i, k, jp1) =                             &amp;<a name='4881'>
               0.5*((2.-fzm(k-1))*rv(i,k-1,j_start)-fzp(k-1)*rv(i,k-2,j_start))   &amp;<a name='4882'>
                   *(w(i,k,j_start)+w(i,k,j_start-1))<a name='4883'>
          ENDDO<a name='4884'>
       ELSE IF ((j &gt; j_end_f) .and. degrade_ye)  THEN<a name='4885'>
          DO k = kts+1, ktf<a name='4886'>
          DO i = i_start, i_end<a name='4887'>
            fqy(i, k, jp1) =                             &amp;<a name='4888'>
               0.5*(fzm(k)*rv(i,k,j_end+1)+fzp(k)*rv(i,k-1,j_end+1))     &amp;<a name='4889'>
                   *(w(i,k,j_end+1)+w(i,k,j_end))<a name='4890'>
          ENDDO<a name='4891'>
          ENDDO<a name='4892'>
          k = ktf+1<a name='4893'>
          DO i = i_start, i_end<a name='4894'>
            fqy(i, k, jp1) =                             &amp;<a name='4895'>
               0.5*((2.-fzm(k-1))*rv(i,k-1,j_end+1)-fzp(k-1)*rv(i,k-2,j_end+1))     &amp;<a name='4896'>
                   *(w(i,k,j_end+1)+w(i,k,j_end))<a name='4897'>
          ENDDO<a name='4898'>
       ELSE<a name='4899'>
<font color=#447700>!  3rd or 4rth order flux<a name='4900'></font>
          DO k = kts+1, ktf<a name='4901'>
          DO i = i_start, i_end<a name='4902'>
            vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4903'>
            fqy( i, k, jp1 ) = vel*flux3( w(i,k,j-2), w(i,k,j-1),  &amp;<a name='4904'>
                                    w(i,k,j  ), w(i,k,j+1),  &amp;<a name='4905'>
                                    vel                     )<a name='4906'>
          ENDDO<a name='4907'>
          ENDDO<a name='4908'>
          k = ktf+1<a name='4909'>
          DO i = i_start, i_end<a name='4910'>
            vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4911'>
            fqy( i, k, jp1 ) = vel*flux3( w(i,k,j-2), w(i,k,j-1),  &amp;<a name='4912'>
                                    w(i,k,j  ), w(i,k,j+1),  &amp;<a name='4913'>
                                    vel                     )<a name='4914'>
          ENDDO<a name='4915'>
       END IF<a name='4916'>
<a name='4917'>
       IF( j &gt; j_start ) THEN<a name='4918'>
<font color=#447700>!  y flux-divergence into tendency<a name='4919'></font>
          DO k = kts+1, ktf+1<a name='4920'>
          DO i = i_start, i_end<a name='4921'>
            mrdy=msft(i,j-1)*rdy<a name='4922'>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='4923'>
          ENDDO<a name='4924'>
          ENDDO<a name='4925'>
       END IF<a name='4926'>
<a name='4927'>
       jtmp = jp1<a name='4928'>
       jp1 = jp0<a name='4929'>
       jp0 = jtmp<a name='4930'>
<a name='4931'>
    ENDDO<a name='4932'>
<a name='4933'>
ELSE IF (horz_order == 2 ) THEN<a name='4934'>
<a name='4935'>
      i_start = its<a name='4936'>
      i_end   = MIN(ite,ide-1)<a name='4937'>
      j_start = jts<a name='4938'>
      j_end   = MIN(jte,jde-1)<a name='4939'>
<a name='4940'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='4941'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='4942'>
<a name='4943'>
      DO j = j_start, j_end<a name='4944'>
      DO k=kts+1,ktf<a name='4945'>
      DO i = i_start, i_end<a name='4946'>
<a name='4947'>
         mrdx=msft(i,j)*rdx<a name='4948'>
<a name='4949'>
            tendency(i,k,j)=tendency(i,k,j)-mrdx*0.5            &amp;<a name='4950'>
                   *((fzm(k)*ru(i+1,k,j)+fzp(k)*ru(i+1,k-1,j))  &amp;<a name='4951'>
                                *(w(i+1,k,j)+w(i,k,j))          &amp;<a name='4952'>
                    -(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j))      &amp;<a name='4953'>
                               *(w(i,k,j)+w(i-1,k,j)))<a name='4954'>
<a name='4955'>
      ENDDO<a name='4956'>
      ENDDO<a name='4957'>
<a name='4958'>
      k = ktf+1<a name='4959'>
      DO i = i_start, i_end<a name='4960'>
<a name='4961'>
         mrdx=msft(i,j)*rdx<a name='4962'>
<a name='4963'>
            tendency(i,k,j)=tendency(i,k,j)-mrdx*0.5            &amp;<a name='4964'>
                   *(((2.-fzm(k-1))*ru(i+1,k-1,j)-fzp(k-1)*ru(i+1,k-2,j))      &amp;<a name='4965'>
                                *(w(i+1,k,j)+w(i,k,j))          &amp;<a name='4966'>
                    -((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j))         &amp;<a name='4967'>
                               *(w(i,k,j)+w(i-1,k,j)))<a name='4968'>
<a name='4969'>
      ENDDO<a name='4970'>
<a name='4971'>
      ENDDO<a name='4972'>
<a name='4973'>
      i_start = its<a name='4974'>
      i_end   = MIN(ite,ide-1)<a name='4975'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='4976'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='4977'>
<a name='4978'>
      DO j = j_start, j_end<a name='4979'>
      DO k=kts+1,ktf<a name='4980'>
      DO i = i_start, i_end<a name='4981'>
<a name='4982'>
         mrdy=msft(i,j)*rdy<a name='4983'>
<a name='4984'>
            tendency(i,k,j)=tendency(i,k,j) -mrdy*0.5           &amp;<a name='4985'>
                   *((fzm(k)*rv(i,k,j+1)+fzp(k)*rv(i,k-1,j+1))* &amp;<a name='4986'>
                                 (w(i,k,j+1)+w(i,k,j))          &amp;<a name='4987'>
                    -(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))      &amp;<a name='4988'>
                                 *(w(i,k,j)+w(i,k,j-1))) <a name='4989'>
<a name='4990'>
      ENDDO<a name='4991'>
      ENDDO<a name='4992'>
<a name='4993'>
      k = ktf+1<a name='4994'>
      DO i = i_start, i_end<a name='4995'>
<a name='4996'>
         mrdy=msft(i,j)*rdy<a name='4997'>
<a name='4998'>
            tendency(i,k,j)=tendency(i,k,j) -mrdy*0.5       &amp;<a name='4999'>
                   *(((2.-fzm(k-1))*rv(i,k-1,j+1)-fzp(k-1)*rv(i,k-2,j+1))* &amp;<a name='5000'>
                                 (w(i,k,j+1)+w(i,k,j))      &amp;<a name='5001'>
                    -((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))      &amp;<a name='5002'>
                                 *(w(i,k,j)+w(i,k,j-1))) <a name='5003'>
<a name='5004'>
      ENDDO<a name='5005'>
<a name='5006'>
      ENDDO<a name='5007'>
<a name='5008'>
   ELSE<a name='5009'>
<a name='5010'>
      WRITE ( wrf_err_message ,*) ' advect_w_6a, h_order not known ',horz_order<a name='5011'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_14"> ( wrf_err_message )<a name='5012'>
<a name='5013'>
   ENDIF horizontal_order_test<a name='5014'>
<a name='5015'>
<a name='5016'>
<font color=#447700>!  pick up the the horizontal radiation boundary conditions.<a name='5017'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='5018'></font>
<font color=#447700>!  first, set to index ranges<a name='5019'></font>
<a name='5020'>
<a name='5021'>
      i_start = its<a name='5022'>
      i_end   = MIN(ite,ide-1)<a name='5023'>
      j_start = jts<a name='5024'>
      j_end   = MIN(jte,jde-1)<a name='5025'>
<a name='5026'>
   IF( (config_flags%open_xs) .and. (its == ids)) THEN<a name='5027'>
<a name='5028'>
       DO j = j_start, j_end<a name='5029'>
       DO k = kts+1, ktf<a name='5030'>
<a name='5031'>
         uw = 0.5*(fzm(k)*(ru(its,k  ,j)+ru(its+1,k  ,j)) +  &amp;<a name='5032'>
                   fzp(k)*(ru(its,k-1,j)+ru(its+1,k-1,j))   )<a name='5033'>
         ub = MIN( uw, 0. )<a name='5034'>
<a name='5035'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='5036'>
               - rdx*(                                             &amp;<a name='5037'>
                       ub*(w_old(its+1,k,j) - w_old(its,k,j)) +    &amp;<a name='5038'>
                       w(its,k,j)*(                                &amp;<a name='5039'>
                       fzm(k)*(ru(its+1,k  ,j)-ru(its,k  ,j))+     &amp;<a name='5040'>
                       fzp(k)*(ru(its+1,k-1,j)-ru(its,k-1,j)))     &amp;<a name='5041'>
                                                                  )<a name='5042'>
       ENDDO<a name='5043'>
       ENDDO<a name='5044'>
<a name='5045'>
       k = ktf+1<a name='5046'>
       DO j = j_start, j_end<a name='5047'>
<a name='5048'>
         uw = 0.5*( (2.-fzm(k-1))*(ru(its,k-1,j)+ru(its+1,k-1,j))   &amp;<a name='5049'>
                   -fzp(k-1)*(ru(its,k-2,j)+ru(its+1,k-2,j))   )<a name='5050'>
         ub = MIN( uw, 0. )<a name='5051'>
<a name='5052'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='5053'>
               - rdx*(                                             &amp;<a name='5054'>
                       ub*(w_old(its+1,k,j) - w_old(its,k,j)) +    &amp;<a name='5055'>
                       w(its,k,j)*(                                &amp;<a name='5056'>
                             (2.-fzm(k-1))*(ru(its+1,k-1,j)-ru(its,k-1,j))-  &amp;<a name='5057'>
                             fzp(k-1)*(ru(its+1,k-2,j)-ru(its,k-2,j)))  &amp;<a name='5058'>
                                                                  )<a name='5059'>
       ENDDO<a name='5060'>
<a name='5061'>
   ENDIF<a name='5062'>
<a name='5063'>
   IF( (config_flags%open_xe) .and. (ite == ide)) THEN<a name='5064'>
<a name='5065'>
       DO j = j_start, j_end<a name='5066'>
       DO k = kts+1, ktf<a name='5067'>
<a name='5068'>
         uw = 0.5*(fzm(k)*(ru(ite-1,k  ,j)+ru(ite,k  ,j)) +  &amp;<a name='5069'>
                   fzp(k)*(ru(ite-1,k-1,j)+ru(ite,k-1,j))   )<a name='5070'>
         ub = MAX( uw, 0. )<a name='5071'>
<a name='5072'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                     &amp;<a name='5073'>
               - rdx*(                                                 &amp;<a name='5074'>
                       ub*(w_old(i_end,k,j) - w_old(i_end-1,k,j)) +    &amp;<a name='5075'>
                       w(i_end,k,j)*(                                  &amp;<a name='5076'>
                            fzm(k)*(ru(ite,k  ,j)-ru(ite-1,k  ,j)) +   &amp;<a name='5077'>
                            fzp(k)*(ru(ite,k-1,j)-ru(ite-1,k-1,j)))    &amp;<a name='5078'>
                                                                    )<a name='5079'>
       ENDDO<a name='5080'>
       ENDDO<a name='5081'>
<a name='5082'>
       k = ktf+1<a name='5083'>
       DO j = j_start, j_end<a name='5084'>
<a name='5085'>
         uw = 0.5*( (2.-fzm(k-1))*(ru(ite-1,k-1,j)+ru(ite,k-1,j))    &amp;<a name='5086'>
                   -fzp(k-1)*(ru(ite-1,k-2,j)+ru(ite,k-2,j))   )<a name='5087'>
         ub = MAX( uw, 0. )<a name='5088'>
<a name='5089'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                     &amp;<a name='5090'>
               - rdx*(                                                 &amp;<a name='5091'>
                       ub*(w_old(i_end,k,j) - w_old(i_end-1,k,j)) +    &amp;<a name='5092'>
                       w(i_end,k,j)*(                                  &amp;<a name='5093'>
                               (2.-fzm(k-1))*(ru(ite,k-1,j)-ru(ite-1,k-1,j)) -   &amp;<a name='5094'>
                               fzp(k-1)*(ru(ite,k-2,j)-ru(ite-1,k-2,j)))    &amp;<a name='5095'>
                                                                    )<a name='5096'>
       ENDDO<a name='5097'>
<a name='5098'>
   ENDIF<a name='5099'>
<a name='5100'>
<a name='5101'>
   IF( (config_flags%open_ys) .and. (jts == jds)) THEN<a name='5102'>
<a name='5103'>
       DO i = i_start, i_end<a name='5104'>
       DO k = kts+1, ktf<a name='5105'>
<a name='5106'>
         vw = 0.5*( fzm(k)*(rv(i,k  ,jts)+rv(i,k  ,jts+1)) +  &amp;<a name='5107'>
                    fzp(k)*(rv(i,k-1,jts)+rv(i,k-1,jts+1))   )<a name='5108'>
         vb = MIN( vw, 0. )<a name='5109'>
<a name='5110'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='5111'>
               - rdy*(                                             &amp;<a name='5112'>
                       vb*(w_old(i,k,jts+1) - w_old(i,k,jts)) +    &amp;<a name='5113'>
                       w(i,k,jts)*(                                &amp;<a name='5114'>
                       fzm(k)*(rv(i,k  ,jts+1)-rv(i,k  ,jts))+     &amp;<a name='5115'>
                       fzp(k)*(rv(i,k-1,jts+1)-rv(i,k-1,jts)))     &amp;<a name='5116'>
                                                                )<a name='5117'>
       ENDDO<a name='5118'>
       ENDDO<a name='5119'>
<a name='5120'>
       k = ktf+1<a name='5121'>
       DO i = i_start, i_end<a name='5122'>
         vw = 0.5*( (2.-fzm(k-1))*(rv(i,k-1,jts)+rv(i,k-1,jts+1))    &amp;<a name='5123'>
                   -fzp(k-1)*(rv(i,k-2,jts)+rv(i,k-2,jts+1))   )<a name='5124'>
         vb = MIN( vw, 0. )<a name='5125'>
<a name='5126'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='5127'>
               - rdy*(                                             &amp;<a name='5128'>
                       vb*(w_old(i,k,jts+1) - w_old(i,k,jts)) +    &amp;<a name='5129'>
                       w(i,k,jts)*(                                &amp;<a name='5130'>
                          (2.-fzm(k-1))*(rv(i,k-1,jts+1)-rv(i,k-1,jts))-     &amp;<a name='5131'>
                          fzp(k-1)*(rv(i,k-2,jts+1)-rv(i,k-2,jts)))     &amp;<a name='5132'>
                                                                )<a name='5133'>
       ENDDO<a name='5134'>
<a name='5135'>
   ENDIF<a name='5136'>
<a name='5137'>
   IF( (config_flags%open_ye) .and. (jte == jde) ) THEN<a name='5138'>
<a name='5139'>
       DO i = i_start, i_end<a name='5140'>
       DO k = kts+1, ktf<a name='5141'>
<a name='5142'>
         vw = 0.5*( fzm(k)*(rv(i,k  ,jte-1)+rv(i,k  ,jte)) +  &amp;<a name='5143'>
                    fzp(k)*(rv(i,k-1,jte-1)+rv(i,k-1,jte))   )<a name='5144'>
         vb = MAX( vw, 0. )<a name='5145'>
<a name='5146'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                     &amp;<a name='5147'>
               - rdy*(                                                 &amp;<a name='5148'>
                       vb*(w_old(i,k,j_end) - w_old(i,k,j_end-1)) +    &amp;<a name='5149'>
                       w(i,k,j_end)*(                                  &amp;<a name='5150'>
                            fzm(k)*(rv(i,k  ,jte)-rv(i,k  ,jte-1))+    &amp;<a name='5151'>
                            fzp(k)*(rv(i,k-1,jte)-rv(i,k-1,jte-1)))    &amp;<a name='5152'>
                                                                      )<a name='5153'>
       ENDDO<a name='5154'>
       ENDDO<a name='5155'>
<a name='5156'>
       k = ktf+1<a name='5157'>
       DO i = i_start, i_end<a name='5158'>
<a name='5159'>
         vw = 0.5*( (2.-fzm(k-1))*(rv(i,k-1,jte-1)+rv(i,k-1,jte))    &amp;<a name='5160'>
                   -fzp(k-1)*(rv(i,k-2,jte-1)+rv(i,k-2,jte))   )<a name='5161'>
         vb = MAX( vw, 0. )<a name='5162'>
<a name='5163'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                     &amp;<a name='5164'>
               - rdy*(                                                 &amp;<a name='5165'>
                       vb*(w_old(i,k,j_end) - w_old(i,k,j_end-1)) +    &amp;<a name='5166'>
                       w(i,k,j_end)*(                                  &amp;<a name='5167'>
                               (2.-fzm(k-1))*(rv(i,k-1,jte)-rv(i,k-1,jte-1))-    &amp;<a name='5168'>
                               fzp(k-1)*(rv(i,k-2,jte)-rv(i,k-2,jte-1)))    &amp;<a name='5169'>
                                                                      )<a name='5170'>
       ENDDO<a name='5171'>
<a name='5172'>
   ENDIF<a name='5173'>
<a name='5174'>
<font color=#447700>!-------------------- vertical advection<a name='5175'></font>
<a name='5176'>
      i_start = its<a name='5177'>
      i_end   = MIN(ite,ide-1)<a name='5178'>
      j_start = jts<a name='5179'>
      j_end   = MIN(jte,jde-1)<a name='5180'>
<a name='5181'>
      DO i = i_start, i_end<a name='5182'>
         vflux(i,kts)=0.<a name='5183'>
         vflux(i,kte)=0.<a name='5184'>
      ENDDO<a name='5185'>
<a name='5186'>
    vert_order_test : IF (vert_order == 6) THEN    <a name='5187'>
<a name='5188'>
      DO j = j_start, j_end<a name='5189'>
<a name='5190'>
         DO k=kts+3,ktf-1<a name='5191'>
         DO i = i_start, i_end<a name='5192'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5193'>
           vflux(i,k) = vel*flux6(                                   &amp;<a name='5194'>
                   w(i,k-3,j), w(i,k-2,j), w(i,k-1,j),       &amp;<a name='5195'>
                   w(i,k  ,j), w(i,k+1,j), w(i,k+2,j),  -vel )<a name='5196'>
         ENDDO<a name='5197'>
         ENDDO<a name='5198'>
<a name='5199'>
         DO i = i_start, i_end<a name='5200'>
<a name='5201'>
           k=kts+1<a name='5202'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5203'>
<a name='5204'>
           k = kts+2<a name='5205'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5206'>
           vflux(i,k) = vel*flux4(               &amp;<a name='5207'>
                   w(i,k-2,j), w(i,k-1,j),   &amp;<a name='5208'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='5209'>
<a name='5210'>
           k = ktf<a name='5211'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5212'>
           vflux(i,k) = vel*flux4(               &amp;<a name='5213'>
                   w(i,k-2,j), w(i,k-1,j),   &amp;<a name='5214'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='5215'>
<a name='5216'>
           k=ktf+1<a name='5217'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5218'>
<a name='5219'>
         ENDDO<a name='5220'>
<a name='5221'>
         DO k=kts+1,ktf<a name='5222'>
         DO i = i_start, i_end<a name='5223'>
            tendency(i,k,j)=tendency(i,k,j)-rdzu(k)*(vflux(i,k+1)-vflux(i,k))<a name='5224'>
         ENDDO<a name='5225'>
         ENDDO<a name='5226'>
<a name='5227'>
<font color=#447700>! pick up flux contribution for w at the lid. wcs, 13 march 2004<a name='5228'></font>
         k = ktf+1<a name='5229'>
         DO i = i_start, i_end<a name='5230'>
           tendency(i,k,j)=tendency(i,k,j)+2.*rdzu(k-1)*(vflux(i,k))<a name='5231'>
         ENDDO<a name='5232'>
<a name='5233'>
      ENDDO<a name='5234'>
<a name='5235'>
 ELSE IF (vert_order == 5) THEN    <a name='5236'>
<a name='5237'>
      DO j = j_start, j_end<a name='5238'>
<a name='5239'>
         DO k=kts+3,ktf-1<a name='5240'>
         DO i = i_start, i_end<a name='5241'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5242'>
           vflux(i,k) = vel*flux5(                                   &amp;<a name='5243'>
                   w(i,k-3,j), w(i,k-2,j), w(i,k-1,j),       &amp;<a name='5244'>
                   w(i,k  ,j), w(i,k+1,j), w(i,k+2,j),  -vel )<a name='5245'>
         ENDDO<a name='5246'>
         ENDDO<a name='5247'>
<a name='5248'>
         DO i = i_start, i_end<a name='5249'>
<a name='5250'>
           k=kts+1<a name='5251'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5252'>
                                   <a name='5253'>
           k = kts+2<a name='5254'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5255'>
           vflux(i,k) = vel*flux3(               &amp;<a name='5256'>
                   w(i,k-2,j), w(i,k-1,j),   &amp;<a name='5257'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='5258'>
           k = ktf<a name='5259'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5260'>
           vflux(i,k) = vel*flux3(               &amp;<a name='5261'>
                   w(i,k-2,j), w(i,k-1,j),   &amp;<a name='5262'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='5263'>
<a name='5264'>
           k=ktf+1<a name='5265'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5266'>
<a name='5267'>
         ENDDO<a name='5268'>
<a name='5269'>
         DO k=kts+1,ktf<a name='5270'>
         DO i = i_start, i_end<a name='5271'>
            tendency(i,k,j)=tendency(i,k,j)-rdzu(k)*(vflux(i,k+1)-vflux(i,k))<a name='5272'>
         ENDDO<a name='5273'>
         ENDDO<a name='5274'>
<a name='5275'>
<font color=#447700>! pick up flux contribution for w at the lid, wcs. 13 march 2004<a name='5276'></font>
         k = ktf+1<a name='5277'>
         DO i = i_start, i_end<a name='5278'>
           tendency(i,k,j)=tendency(i,k,j)+2.*rdzu(k-1)*(vflux(i,k))<a name='5279'>
         ENDDO<a name='5280'>
<a name='5281'>
      ENDDO<a name='5282'>
<a name='5283'>
 ELSE IF (vert_order == 4) THEN    <a name='5284'>
<a name='5285'>
      DO j = j_start, j_end<a name='5286'>
<a name='5287'>
         DO k=kts+2,ktf<a name='5288'>
         DO i = i_start, i_end<a name='5289'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5290'>
           vflux(i,k) = vel*flux4(              &amp;<a name='5291'>
                   w(i,k-2,j), w(i,k-1,j),      &amp;<a name='5292'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='5293'>
         ENDDO<a name='5294'>
         ENDDO<a name='5295'>
<a name='5296'>
         DO i = i_start, i_end<a name='5297'>
<a name='5298'>
           k=kts+1<a name='5299'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5300'>
           k=ktf+1<a name='5301'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5302'>
<a name='5303'>
         ENDDO<a name='5304'>
<a name='5305'>
         DO k=kts+1,ktf<a name='5306'>
         DO i = i_start, i_end<a name='5307'>
            tendency(i,k,j)=tendency(i,k,j)-rdzu(k)*(vflux(i,k+1)-vflux(i,k))<a name='5308'>
         ENDDO<a name='5309'>
         ENDDO<a name='5310'>
<a name='5311'>
<font color=#447700>! pick up flux contribution for w at the lid, wcs. 13 march 2004<a name='5312'></font>
         k = ktf+1<a name='5313'>
         DO i = i_start, i_end<a name='5314'>
           tendency(i,k,j)=tendency(i,k,j)+2.*rdzu(k-1)*(vflux(i,k))<a name='5315'>
         ENDDO<a name='5316'>
<a name='5317'>
      ENDDO<a name='5318'>
<a name='5319'>
 ELSE IF (vert_order == 3) THEN    <a name='5320'>
<a name='5321'>
      DO j = j_start, j_end<a name='5322'>
<a name='5323'>
         DO k=kts+2,ktf<a name='5324'>
         DO i = i_start, i_end<a name='5325'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5326'>
           vflux(i,k) = vel*flux3(              &amp;<a name='5327'>
                   w(i,k-2,j), w(i,k-1,j),      &amp;<a name='5328'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='5329'>
         ENDDO<a name='5330'>
         ENDDO<a name='5331'>
<a name='5332'>
         DO i = i_start, i_end<a name='5333'>
<a name='5334'>
           k=kts+1<a name='5335'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5336'>
           k=ktf+1<a name='5337'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5338'>
<a name='5339'>
         ENDDO<a name='5340'>
<a name='5341'>
         DO k=kts+1,ktf<a name='5342'>
         DO i = i_start, i_end<a name='5343'>
            tendency(i,k,j)=tendency(i,k,j)-rdzu(k)*(vflux(i,k+1)-vflux(i,k))<a name='5344'>
         ENDDO<a name='5345'>
         ENDDO<a name='5346'>
<a name='5347'>
<font color=#447700>! pick up flux contribution for w at the lid, wcs. 13 march 2004<a name='5348'></font>
         k = ktf+1<a name='5349'>
         DO i = i_start, i_end<a name='5350'>
           tendency(i,k,j)=tendency(i,k,j)+2.*rdzu(k-1)*(vflux(i,k))<a name='5351'>
         ENDDO<a name='5352'>
<a name='5353'>
      ENDDO<a name='5354'>
<a name='5355'>
 ELSE IF (vert_order == 2) THEN    <a name='5356'>
<a name='5357'>
  DO j = j_start, j_end<a name='5358'>
     DO k=kts+1,ktf+1<a name='5359'>
     DO i = i_start, i_end<a name='5360'>
<a name='5361'>
            vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5362'>
     ENDDO<a name='5363'>
     ENDDO<a name='5364'>
     DO k=kts+1,ktf<a name='5365'>
     DO i = i_start, i_end<a name='5366'>
            tendency(i,k,j)=tendency(i,k,j)-rdzu(k)*(vflux(i,k+1)-vflux(i,k))<a name='5367'>
<a name='5368'>
     ENDDO<a name='5369'>
     ENDDO<a name='5370'>
<a name='5371'>
<font color=#447700>! pick up flux contribution for w at the lid, wcs. 13 march 2004<a name='5372'></font>
     k = ktf+1<a name='5373'>
     DO i = i_start, i_end<a name='5374'>
       tendency(i,k,j)=tendency(i,k,j)+2.*rdzu(k-1)*(vflux(i,k))<a name='5375'>
     ENDDO<a name='5376'>
<a name='5377'>
  ENDDO<a name='5378'>
<a name='5379'>
   ELSE<a name='5380'>
<a name='5381'>
      WRITE (wrf_err_message ,*) ' advect_w, v_order not known ',vert_order<a name='5382'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_15"> ( wrf_err_message )<a name='5383'>
<a name='5384'>
   ENDIF vert_order_test<a name='5385'>
<a name='5386'>
END SUBROUTINE advect_w<a name='5387'>
<a name='5388'>
<font color=#447700>!----------------------------------------------------------------<a name='5389'></font>
<a name='5390'>
END MODULE module_advect_em<a name='5391'>
<a name='5392'>
</pre></body></html>