<HTML> <BODY BGCOLOR=#cceeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MEDIATION_LAYER:SOLVER<a name='2'></font>
<a name='3'>
<A NAME='SOLVE_EM_TST'><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>solve_em_tst</font> ( grid , config_flags , &amp; <A href='../../call_to/SOLVE_EM_TST.html' TARGET='index'>1</A>,<A href='../../call_from/SOLVE_EM_TST.html' TARGET='index'>171</A><a name='5'>
<font color=#447700>! Actual arguments generated from Registry<a name='6'></font>
#include "<A href='../../html_code/include/em_dummy_args.inc.html'>em_dummy_args.inc</A>"<A NAME="em_dummy_args.inc_1"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='7'>
<font color=#447700>!<a name='8'></font>
                    )<a name='9'>
<a name='10'>
<font color=#447700>! Driver layer modules<a name='11'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_17"><a name='12'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_30"><a name='13'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_5"><a name='14'>
   USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_5"><a name='15'>
   USE <A href='../../html_code/frame/module_tiles.F.html#MODULE_TILES'>module_tiles</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TILES_5"><a name='16'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_14"><a name='17'>
<font color=#447700>! Mediation layer modules<a name='18'></font>
<font color=#447700>! Model layer modules<a name='19'></font>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_26"><a name='20'>
   USE <A href='../../html_code/dyn_em/module_small_step_em.F.html#MODULE_SMALL_STEP_EM'>module_small_step_em</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SMALL_STEP_EM_6"><a name='21'>
   USE <A href='../../html_code/dyn_em/module_em.F.html#MODULE_EM'>module_em</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_EM_6"><a name='22'>
   USE <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_14"><a name='23'>
   USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_23"><a name='24'>
   USE <A href='../../html_code/dyn_em/module_bc_em.F.html#MODULE_BC_EM'>module_bc_em</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_EM_6"><a name='25'>
   USE <A href='../../html_code/dyn_em/module_solvedebug_em.F.html#MODULE_SOLVEDEBUG_EM'>module_solvedebug_em</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SOLVEDEBUG_EM_4"><a name='26'>
   USE <A href='../../html_code/phys/module_physics_addtendc.F.html#MODULE_PHYSICS_ADDTENDC'>module_physics_addtendc</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PHYSICS_ADDTENDC_4"><a name='27'>
   USE <A href='../../html_code/dyn_em/module_diffusion_em.F.html#MODULE_DIFFUSION_EM'>module_diffusion_em</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DIFFUSION_EM_6"><a name='28'>
<font color=#447700>! Registry generated module<a name='29'></font>
   USE module_state_description<a name='30'>
   USE <A href='../../html_code/phys/module_radiation_driver.F.html#MODULE_RADIATION_DRIVER'>module_radiation_driver</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RADIATION_DRIVER_4"><a name='31'>
   USE <A href='../../html_code/phys/module_surface_driver.F.html#MODULE_SURFACE_DRIVER'>module_surface_driver</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SURFACE_DRIVER_4"><a name='32'>
   USE <A href='../../html_code/phys/module_cumulus_driver.F.html#MODULE_CUMULUS_DRIVER'>module_cumulus_driver</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CUMULUS_DRIVER_4"><a name='33'>
   USE <A href='../../html_code/phys/module_cu_du.F.html#MODULE_CU_DU'>module_cu_du</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CU_DU_5"> , only: DUCU<a name='34'>
   USE <A href='../../html_code/phys/module_microphysics_driver.F.html#MODULE_MICROPHYSICS_DRIVER'>module_microphysics_driver</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MICROPHYSICS_DRIVER_4"><a name='35'>
   USE <A href='../../html_code/phys/module_pbl_driver.F.html#MODULE_PBL_DRIVER'>module_pbl_driver</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PBL_DRIVER_4"><a name='36'>
   USE <A href='../../html_code/phys/module_mp_nconvp.F.html#MODULE_MP_NCONVP'>module_mp_nconvp</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_NCONVP_5"> <font color=#447700>!Xiaoyan Zhang<a name='37'></font>
#ifdef WRF_CHEM<a name='38'>
   USE module_input_chem_data<a name='39'>
   USE module_chem_utilities<a name='40'>
#endif<a name='41'>
   USE <A href='../../html_code/dyn_em/module_check.F.html#MODULE_CHECK'>module_check</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CHECK_1"><a name='42'>
<a name='43'>
   IMPLICIT NONE<a name='44'>
<a name='45'>
   <font color=#447700>!  Input data.<a name='46'></font>
<a name='47'>
   TYPE(domain) , TARGET          :: grid<a name='48'>
<a name='49'>
   <font color=#447700>!  Definitions of dummy arguments to this routine (generated from Registry).<a name='50'></font>
#include &lt;<A href='../../html_code/include/em_dummy_decl.inc.html'>em_dummy_decl.inc</A>&gt;<A NAME="em_dummy_decl.inc_2"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='51'>
<a name='52'>
   <font color=#447700>!  Structure that contains run-time configuration (namelist) data for domain<a name='53'></font>
   TYPE (grid_config_rec_type) , INTENT(IN)          :: config_flags<a name='54'>
<a name='55'>
   <font color=#447700>! Local data<a name='56'></font>
<a name='57'>
   INTEGER                         :: k_start , k_end, its, ite, jts, jte<a name='58'>
   INTEGER                         :: ids , ide , jds , jde , kds , kde , &amp;<a name='59'>
                                      ims , ime , jms , jme , kms , kme , &amp; <a name='60'>
                                      ips , ipe , jps , jpe , kps , kpe<a name='61'>
   INTEGER                         :: ij , iteration<a name='62'>
   INTEGER                         :: im , num_3d_m , ic , num_3d_c<a name='63'>
   INTEGER                         :: loop<a name='64'>
   INTEGER                         :: ijds, ijde<a name='65'>
   INTEGER                         :: itmpstep<a name='66'>
   INTEGER                         :: sz<a name='67'>
<a name='68'>
<font color=#447700>! storage for tendencies and decoupled state (generated from Registry)<a name='69'></font>
#include &lt;<A href='../../html_code/include/em_i1_decl.inc.html'>em_i1_decl.inc</A>&gt;<A NAME="em_i1_decl.inc_3"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='70'>
<a name='71'>
   INTEGER :: rc <a name='72'>
   INTEGER :: number_of_small_timesteps, rk_step<a name='73'>
   INTEGER :: klevel,ijm,ijp,i,j,k,size1,size2    <font color=#447700>! for prints/plots only<a name='74'></font>
   INTEGER :: idum1, idum2, dynamics_option<a name='75'>
<a name='76'>
   INTEGER :: rk_order, iwmax, jwmax, kwmax<a name='77'>
   REAL :: dt_rk, dts_rk, dtm, wmax<a name='78'>
   LOGICAL :: leapfrog<a name='79'>
   INTEGER :: l,kte,kk<a name='80'>
<a name='81'>
<font color=#447700>! These are used if -DDEREF_KLUDGE is compiled<a name='82'></font>
<font color=#447700>!  see http://www2.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='83'></font>
   INTEGER     :: sm31  , em31  , sm32  , em32  , sm33  , em33<a name='84'>
   INTEGER     :: sm31x , em31x , sm32x , em32x , sm33x , em33x<a name='85'>
   INTEGER     :: sm31y , em31y , sm32y , em32y , sm33y , em33y<a name='86'>
<a name='87'>
<font color=#447700>! Define benchmarking timers if -DBENCH is compiled<a name='88'></font>
#include &lt;<A href='../../html_code/include/bench_solve_em_def.h.html'>bench_solve_em_def.h</A>&gt;<A NAME="bench_solve_em_def.h_4"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='89'>
<a name='90'>
<font color=#447700>!----------------------<a name='91'></font>
<font color=#447700>! Executable statements<a name='92'></font>
<font color=#447700>!----------------------<a name='93'></font>
<a name='94'>
<font color=#447700>! Trick problematic compilers into not performing copy-in/copy-out by adding<a name='95'></font>
<font color=#447700>! indices to array arguments in the CALL statements in this routine.<a name='96'></font>
<font color=#447700>! It has the effect of passing only the first element of the array, rather <a name='97'></font>
<font color=#447700>! than the entire array.  See:  <a name='98'></font>
<font color=#447700>! http://www2.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='99'></font>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_5"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='100'>
<a name='101'>
<font color=#447700>! Limit the number of arguments if compiled with -DLIMIT_ARGS by copying <a name='102'></font>
<font color=#447700>! scalar (non-array) arguments out of the grid data structure into locally<a name='103'></font>
<font color=#447700>! defined copies (defined in em_dummy_decl.inc, above, as they are if they<a name='104'></font>
<font color=#447700>! are arguments). An equivalent include of em_scalar_derefs.inc appears<a name='105'></font>
<font color=#447700>! at the end of the routine to copy back any chnaged non-array values.<a name='106'></font>
<font color=#447700>! The definition of COPY_IN or COPY_OUT before the include defines the<a name='107'></font>
<font color=#447700>! direction of the copy.  Em_scalar_derefs.inc is generated from Registry<a name='108'></font>
#define COPY_IN<a name='109'>
#include &lt;<A href='../../html_code/include/em_scalar_derefs.inc.html'>em_scalar_derefs.inc</A>&gt;<A NAME="em_scalar_derefs.inc_6"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='110'>
<a name='111'>
<font color=#447700>! Needed by some comm layers, e.g. RSL. If needed, nmm_data_calls.inc is<a name='112'></font>
<font color=#447700>! generated from the registry.  The definition of REGISTER_I1 allows<a name='113'></font>
<font color=#447700>! I1 data to be communicated in this routine if necessary.<a name='114'></font>
#ifdef DM_PARALLEL<a name='115'>
#    define REGISTER_I1<a name='116'>
#      include &lt;<A href='../../html_code/include/em_data_calls.inc.html'>em_data_calls.inc</A>&gt;<A NAME="em_data_calls.inc_7"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='117'>
#endif<a name='118'>
<a name='119'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='120'></font>
<font color=#447700>!&lt;pre&gt;<a name='121'></font>
<font color=#447700>! solve_em is the main driver for advancing a grid a single timestep.<a name='122'></font>
<font color=#447700>! It is a mediation-layer routine -&gt; DM and SM calls are made where <a name='123'></font>
<font color=#447700>! needed for parallel processing.  <a name='124'></font>
<font color=#447700>!<a name='125'></font>
<font color=#447700>! solve_em can integrate the equations using 3 time-integration methods<a name='126'></font>
<font color=#447700>!      <a name='127'></font>
<font color=#447700>!    - 3rd order Runge-Kutta time integration (recommended)<a name='128'></font>
<font color=#447700>!      <a name='129'></font>
<font color=#447700>!    - 2nd order Runge-Kutta time integration<a name='130'></font>
<font color=#447700>!      <a name='131'></font>
<font color=#447700>!    - Leapfrog time integration<a name='132'></font>
<font color=#447700>!      (note: the leapfrog scheme is not correctly implemented<a name='133'></font>
<font color=#447700>!      for most of the physics)<a name='134'></font>
<font color=#447700>!<a name='135'></font>
<font color=#447700>! The main sections of solve_em are<a name='136'></font>
<font color=#447700>!     <a name='137'></font>
<font color=#447700>! (1) Runge-Kutta (RK) loop<a name='138'></font>
<font color=#447700>!     <a name='139'></font>
<font color=#447700>! (2) Non-timesplit physics (i.e., tendencies computed for updating<a name='140'></font>
<font color=#447700>!     model state variables during the first RK sub-step (loop)<a name='141'></font>
<font color=#447700>!     <a name='142'></font>
<font color=#447700>! (3) Small (acoustic, sound) timestep loop - within the RK sub-steps<a name='143'></font>
<font color=#447700>!     <a name='144'></font>
<font color=#447700>! (4) Scalar advance for moist and chem scalar variables (and TKE)<a name='145'></font>
<font color=#447700>!     within the RK sub-steps.<a name='146'></font>
<font color=#447700>!     <a name='147'></font>
<font color=#447700>! (5) time-split physics (after the RK step), currently this includes<a name='148'></font>
<font color=#447700>!     only microphyics<a name='149'></font>
<font color=#447700>!<a name='150'></font>
<font color=#447700>! A more detailed description of these sections follows.<a name='151'></font>
<font color=#447700>!&lt;/pre&gt;<a name='152'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='153'></font>
<a name='154'>
<font color=#447700>! Initialize timers if compiled with -DBENCH<a name='155'></font>
#include &lt;<A href='../../html_code/include/bench_solve_em_init.h.html'>bench_solve_em_init.h</A>&gt;<A NAME="bench_solve_em_init.h_8"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='156'>
<a name='157'>
#ifdef WRFVAR<a name='158'>
<a name='159'>
<font color=#447700>!  set leapfrog or runge-kutta solver (2nd or 3rd order)<a name='160'></font>
<a name='161'>
   dynamics_option = config_flags%rk_ord<a name='162'>
<a name='163'>
<font color=#447700>!  Obtain dimension information stored in the grid data structure.<a name='164'></font>
  CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_8"> (  grid ,                   &amp;<a name='165'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='166'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='167'>
                            ips, ipe, jps, jpe, kps, kpe    )<a name='168'>
<a name='169'>
  k_start         = kps<a name='170'>
  k_end           = kpe<a name='171'>
<a name='172'>
  ijds = min(ids, jds)<a name='173'>
  ijde = max(ide, jde)<a name='174'>
<a name='175'>
  num_3d_m        = num_moist<a name='176'>
  num_3d_c        = num_chem<a name='177'>
<a name='178'>
<font color=#447700>!  Compute these starting and stopping locations for each tile and number of tiles.<a name='179'></font>
<font color=#447700>!  See: http://www2.mmm.ucar.edu/wrf/WG2/topics/settiles<a name='180'></font>
  CALL <A href='../../html_code/frame/module_tiles.F.html#SET_TILES'>set_tiles</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TILES_4"> ( grid , ids , ide , jds , jde , ips , ipe , jps , jpe )<a name='181'>
<a name='182'>
  itimestep = itimestep + 1<a name='183'>
<a name='184'>
<font color=#447700>!**********************************************************************<a name='185'></font>
<font color=#447700>!<a name='186'></font>
<font color=#447700>!  LET US BEGIN.......<a name='187'></font>
<font color=#447700>!<a name='188'></font>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='189'></font>
<font color=#447700>!&lt;pre&gt;<a name='190'></font>
<font color=#447700>! (1) RK integration loop is named the "Runge_Kutta_loop:"<a name='191'></font>
<font color=#447700>!<a name='192'></font>
<font color=#447700>!   Predictor-corrector type time integration.<a name='193'></font>
<font color=#447700>!   Advection terms are evaluated at time t for the predictor step,<a name='194'></font>
<font color=#447700>!   and advection is re-evaluated with the latest predicted value for<a name='195'></font>
<font color=#447700>!   each succeeding time corrector step<a name='196'></font>
<font color=#447700>!<a name='197'></font>
<font color=#447700>!   2nd order Runge Kutta (rk_order = 2):<a name='198'></font>
<font color=#447700>!   Step 1 is taken to the midpoint predictor, step 2 is the full step.<a name='199'></font>
<font color=#447700>!<a name='200'></font>
<font color=#447700>!   3rd order Runge Kutta (rk_order = 3):<a name='201'></font>
<font color=#447700>!   Step 1 is taken to from t to dt/3, step 2 is from t to dt/2,<a name='202'></font>
<font color=#447700>!   and step 3 is from t to dt.<a name='203'></font>
<font color=#447700>!<a name='204'></font>
<font color=#447700>!   non-timesplit physics are evaluated during first RK step and<a name='205'></font>
<font color=#447700>!   these physics tendencies are stored for use in each RK pass.<a name='206'></font>
<font color=#447700>!&lt;/pre&gt;<a name='207'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='208'></font>
<font color=#447700>!**********************************************************************<a name='209'></font>
<a name='210'>
#ifdef WRF_CHEM<a name='211'>
<font color=#447700>!<a name='212'></font>
<font color=#447700>!    prepare chem aerosols for advection before communication<a name='213'></font>
<font color=#447700>!    so far only for RADM2/SORGAM choice<a name='214'></font>
<font color=#447700>!<a name='215'></font>
<a name='216'>
   kte=min(k_end,kde-1)<a name='217'>
<font color=#447700>!<a name='218'></font>
<font color=#447700>! change units for advection to mixing ratio<a name='219'></font>
<font color=#447700>!<a name='220'></font>
      if(imicrogram == 1)then<a name='221'>
<a name='222'>
   if ( p_so4aj &gt;= PARAM_FIRST_SCALAR ) then<a name='223'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='224'></font>
   <font color=#447700>!$OMP PRIVATE ( ij ,its,ite,jts,jte,kte)<a name='225'></font>
   aerosol_decouple_loop : DO ij = 1 , grid%num_tiles<a name='226'>
       its = max(grid%i_start(ij),ids)<a name='227'>
       ite = min(grid%i_end(ij),ide-1)<a name='228'>
       jts = max(grid%j_start(ij),jds)<a name='229'>
       jte = min(grid%j_end(ij),jde-1)<a name='230'>
      do l=p_so4aj,num_chem<a name='231'>
      do j=jts,jte<a name='232'>
      do k=k_start,kte+1 <a name='233'>
      kk=min(k,kde-1)<a name='234'>
      do i=its,ite<a name='235'>
        chem_1(i,k,j,l)=chem_1(i,kk,j,l)*alt(i,kk,j)<a name='236'>
        chem_2(i,k,j,l)=chem_2(i,kk,j,l)*alt(i,kk,j)<a name='237'>
      enddo<a name='238'>
      enddo<a name='239'>
      enddo<a name='240'>
      enddo<a name='241'>
    enddo aerosol_decouple_loop<a name='242'>
    endif<a name='243'>
    imicrogram=0<a name='244'>
    endif<a name='245'>
# ifdef DM_PARALLEL<a name='246'>
   if ( num_chem &gt;= PARAM_FIRST_SCALAR ) then<a name='247'>
<font color=#447700>!-----------------------------------------------------------------------<a name='248'></font>
<font color=#447700>! see above<a name='249'></font>
<font color=#447700>!--------------------------------------------------------------<a name='250'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_CHEM' )<a name='251'>
     IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='252'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_9"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='253'>
     ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='254'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_5.inc.html'>HALO_EM_CHEM_E_5.inc</A>"<A NAME="HALO_EM_CHEM_E_5.inc_10"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='255'>
     ELSE<a name='256'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='257'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_61">(TRIM(wrf_err_message))<a name='258'>
     ENDIF<a name='259'>
   endif<a name='260'>
# endif<a name='261'>
<font color=#447700>!--------------------------------------------------------------<a name='262'></font>
#endif<a name='263'>
<a name='264'>
 rk_order = config_flags%rk_ord<a name='265'>
 leapfrog = .false.<a name='266'>
<a name='267'>
 IF (time_step_sound == 0) THEN<a name='268'>
<font color=#447700>! auto-set option<a name='269'></font>
<font color=#447700>! This function will give 4 for 6*dx and 6 for 10*dx and returns even numbers only<a name='270'></font>
   time_step_sound = max ( 2 * ( INT (300.*dt/dx-0.01) + 1 ), 4 )<a name='271'>
   WRITE(wrf_err_message,*)'dx, dt, time_step_sound=',dx,dt,time_step_sound<a name='272'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_56"> ( 50 , wrf_err_message )<a name='273'>
 ENDIF<a name='274'>
<a name='275'>
 dts = dt/float(time_step_sound)<a name='276'>
<a name='277'>
 IF(rk_ord == 1) leapfrog = .true.<a name='278'>
<a name='279'>
 Runge_Kutta_loop:  DO rk_step = 1, rk_order<a name='280'>
<a name='281'>
   <font color=#447700>!  Set the step size and number of small timesteps for<a name='282'></font>
   <font color=#447700>!  each part of the timestep<a name='283'></font>
<a name='284'>
   dtm = dt<a name='285'>
   IF ( rk_order == 1 ) THEN   <font color=#447700>! Leapfrog<a name='286'></font>
<a name='287'>
       IF (step_number /= 1) THEN<a name='288'>
         number_of_small_timesteps = 2*time_step_sound<a name='289'>
         dt_rk = dt<a name='290'>
         dtm = 2*dt<a name='291'>
       ELSE<a name='292'>
         number_of_small_timesteps = time_step_sound<a name='293'>
         dt_rk = dt/2.<a name='294'>
         dtm = dt<a name='295'>
       END IF<a name='296'>
<a name='297'>
       dts_rk = dts<a name='298'>
<a name='299'>
   ELSE IF ( rk_order == 2 ) THEN   <font color=#447700>! 2nd order Runge-Kutta timestep<a name='300'></font>
<a name='301'>
       IF ( rk_step == 1) THEN<a name='302'>
             dt_rk  = 0.5*dt<a name='303'>
             dts_rk = dts<a name='304'>
             number_of_small_timesteps = time_step_sound/2<a name='305'>
       ELSE<a name='306'>
             dt_rk = dt<a name='307'>
             dts_rk = dts<a name='308'>
             number_of_small_timesteps = time_step_sound<a name='309'>
       ENDIF<a name='310'>
<a name='311'>
   ELSE IF ( rk_order == 3 ) THEN <font color=#447700>! third order Runge-Kutta<a name='312'></font>
<a name='313'>
       IF ( rk_step == 1) THEN<a name='314'>
            dt_rk = dt/3.<a name='315'>
            dts_rk = dt_rk<a name='316'>
            number_of_small_timesteps = 1<a name='317'>
       ELSE IF (rk_step == 2) THEN<a name='318'>
            dt_rk  = 0.5*dt<a name='319'>
            dts_rk = dts<a name='320'>
            number_of_small_timesteps = time_step_sound/2<a name='321'>
       ELSE<a name='322'>
            dt_rk = dt<a name='323'>
            dts_rk = dts<a name='324'>
            number_of_small_timesteps = time_step_sound<a name='325'>
       ENDIF<a name='326'>
<a name='327'>
   ELSE<a name='328'>
<a name='329'>
      write(wrf_err_message,*)' unknown solver, error exit for dynamics_option = ',dynamics_option<a name='330'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_62">( wrf_err_message )<a name='331'>
<a name='332'>
   END IF<a name='333'>
<a name='334'>
<font color=#447700>!<a name='335'></font>
<font color=#447700>!  Time level t is in the *_2 variable in the first part <a name='336'></font>
<font color=#447700>!  of the step, and in the *_1 variable after the predictor.<a name='337'></font>
<font color=#447700>!  the latest predicted values are stored in the *_2 variables.<a name='338'></font>
<font color=#447700>!<a name='339'></font>
   CALL wrf_debug ( 200 , ' call rk_step_prep ' )<a name='340'>
<a name='341'>
BENCH_START(step_prep_tim)<a name='342'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='343'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='344'></font>
<a name='345'>
   DO ij = 1 , grid%num_tiles<a name='346'>
<a name='347'>
      print*,'TEST_rk_step_prep = ',TEST_rk_step_prep<a name='348'>
      if (TEST_rk_step_prep) &amp;<a name='349'>
      CALL <A href='../../html_code/dyn_em/module_check.F.html#T_RK_STEP_PREP'>t_rk_step_prep</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_RK_STEP_PREP_1">  ( config_flags, rk_step,            &amp;<a name='350'>
                           u_2, v_2, w_2, t_2, ph_2, mu_2,   &amp;<a name='351'>
                           moist_2,                          &amp;<a name='352'>
                           ru, rv, rw, ww, php, alt, muu, muv,   &amp;<a name='353'>
                           mub, mut, phb, pb, p, al, alb,    &amp;<a name='354'>
                           cqu, cqv, cqw,                    &amp;<a name='355'>
                           msfu, msfv, msft,                 &amp;<a name='356'>
                           fnm, fnp, dnw, rdx, rdy,          &amp;<a name='357'>
                           num_3d_m,                         &amp;<a name='358'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='359'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='360'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='361'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='362'>
                           k_start, k_end                   )<a name='363'>
<a name='364'>
      CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP'>rk_step_prep</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_STEP_PREP_15">  ( config_flags, rk_step,            &amp;<a name='365'>
                           u_2, v_2, w_2, t_2, ph_2, mu_2,   &amp;<a name='366'>
                           moist_2,                          &amp;<a name='367'>
                           ru, rv, rw, ww, php, alt, muu, muv,   &amp;<a name='368'>
                           mub, mut, phb, pb, p, al, alb,    &amp;<a name='369'>
                           cqu, cqv, cqw,                    &amp;<a name='370'>
                           msfu, msfv, msft,                 &amp;<a name='371'>
                           fnm, fnp, dnw, rdx, rdy,          &amp;<a name='372'>
                           num_3d_m,                         &amp;<a name='373'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='374'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='375'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='376'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='377'>
                           k_start, k_end                   )<a name='378'>
<a name='379'>
   END DO<a name='380'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='381'></font>
BENCH_END(step_prep_tim)<a name='382'>
<a name='383'>
#ifdef DM_PARALLEL<a name='384'>
<font color=#447700>!-----------------------------------------------------------------------<a name='385'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='386'></font>
<font color=#447700>!  Note:  the small size of this halo exchange reflects the <a name='387'></font>
<font color=#447700>!         fact that we are carrying the uncoupled variables <a name='388'></font>
<font color=#447700>!         as state variables in the mass coordinate model, as<a name='389'></font>
<font color=#447700>!         opposed to the coupled variables as in the height<a name='390'></font>
<font color=#447700>!         coordinate model.<a name='391'></font>
<font color=#447700>!<a name='392'></font>
<font color=#447700>!                           * * * * *<a name='393'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='394'></font>
<font color=#447700>!       * + *      * + *    * * + * * <a name='395'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='396'></font>
<font color=#447700>!                           * * * * *<a name='397'></font>
<font color=#447700>!<a name='398'></font>
<font color=#447700>!  3D variables - note staggering!  ru(X), rv(Y), ww(Z), php(Z)<a name='399'></font>
<font color=#447700>!<a name='400'></font>
<font color=#447700>!j ru     x<a name='401'></font>
<font color=#447700>!j rv     x<a name='402'></font>
<font color=#447700>!j ww     x<a name='403'></font>
<font color=#447700>!j php    x<a name='404'></font>
<font color=#447700>!j alt    x<a name='405'></font>
<font color=#447700>!j ph_2   x<a name='406'></font>
<font color=#447700>!j phb    x<a name='407'></font>
<font color=#447700>!<a name='408'></font>
<font color=#447700>!  the following are 2D (xy) variables<a name='409'></font>
<font color=#447700>!<a name='410'></font>
<font color=#447700>!j muu    x<a name='411'></font>
<font color=#447700>!j muv    x<a name='412'></font>
<font color=#447700>!j mut    x<a name='413'></font>
<font color=#447700>!--------------------------------------------------------------<a name='414'></font>
#    include "<A href='../../html_code/include/HALO_EM_A.inc.html'>HALO_EM_A.inc</A>"<A NAME="HALO_EM_A.inc_11"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='415'>
#endif<a name='416'>
<a name='417'>
<font color=#447700>! set boundary conditions on variables <a name='418'></font>
<font color=#447700>! from big_step_prep for use in big_step_proc<a name='419'></font>
<a name='420'>
#ifdef DM_PARALLEL<a name='421'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_A.inc.html'>PERIOD_BDY_EM_A.inc</A>"<A NAME="PERIOD_BDY_EM_A.inc_12"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='422'>
#endif<a name='423'>
<a name='424'>
<font color=#447700>!   CALL set_tiles ( grid , ids , ide , jds , jde , ips-1 , ipe+1 , jps-1 , jpe+1 )<a name='425'></font>
<a name='426'>
BENCH_START(set_phys_bc_tim)<a name='427'>
   if(dyn_opt == DYN_EM) then<a name='428'>
<font color=#447700>!   if(dyn_opt == DYN_EM_TST) then<a name='429'></font>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='430'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='431'></font>
<a name='432'>
   DO ij = 1 , grid%num_tiles<a name='433'>
<a name='434'>
       CALL wrf_debug ( 200 , ' call rk_phys_bc_dry_1' )<a name='435'>
<a name='436'>
        CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RK_PHYS_BC_DRY_1'>rk_phys_bc_dry_1</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_PHYS_BC_DRY_1_3">( config_flags, ru, rv, rw, ww,      &amp; <a name='437'>
                               muu, muv, mut, php, alt, p,        &amp;<a name='438'>
                               ids, ide, jds, jde, kds, kde,      &amp;<a name='439'>
                               ims, ime, jms, jme, kms, kme,      &amp;<a name='440'>
                               ips, ipe, jps, jpe, kps, kpe,      &amp;<a name='441'>
                               grid%i_start(ij), grid%i_end(ij),  &amp;<a name='442'>
                               grid%j_start(ij), grid%j_end(ij),  &amp;<a name='443'>
                               k_start, k_end                )<a name='444'>
<a name='445'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_120">( ph_2, 'w', config_flags,            &amp;<a name='446'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='447'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='448'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='449'>
                               grid%i_start(ij), grid%i_end(ij),        &amp;<a name='450'>
                               grid%j_start(ij), grid%j_end(ij),        &amp;<a name='451'>
                               k_start, k_end                )<a name='452'>
<a name='453'>
   END DO<a name='454'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='455'></font>
   endif<a name='456'>
BENCH_END(set_phys_bc_tim)<a name='457'>
<a name='458'>
    rk_step_is_one : IF (rk_step == 1) THEN <font color=#447700>! only need to initialize diffusion tendencies<a name='459'></font>
<a name='460'>
 <font color=#447700>! initialize all tendencies to zero in order to update physics<a name='461'></font>
 <font color=#447700>! tendencies first (separate from dry dynamics).<a name='462'></font>
 <a name='463'>
BENCH_START(init_zero_tend_tim)<a name='464'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='465'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='466'></font>
<a name='467'>
     DO ij = 1 , grid%num_tiles<a name='468'>
<a name='469'>
        CALL wrf_debug ( 200 , ' call init_zero_tendency' )<a name='470'>
<a name='471'>
        print*,'TEST_init_zero_tendency = ',TEST_init_zero_tendency<a name='472'>
        if(TEST_init_zero_tendency) &amp;<a name='473'>
        CALL <A href='../../html_code/dyn_em/module_check.F.html#T_INIT_ZERO_TENDENCY'>t_init_zero_tendency</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_INIT_ZERO_TENDENCY_1"> ( ru_tendf, rv_tendf, rw_tendf,     &amp;<a name='474'>
                                  ph_tendf, t_tendf, tke_tend,      &amp;<a name='475'>
                                  moist_tend,chem_tend,             &amp;<a name='476'>
                                  num_3d_m,num_3d_c,rk_step,        &amp;<a name='477'>
                                  ids, ide, jds, jde, kds, kde,     &amp;<a name='478'>
                                  ims, ime, jms, jme, kms, kme,     &amp;<a name='479'>
                                  grid%i_start(ij), grid%i_end(ij), &amp;<a name='480'>
                                  grid%j_start(ij), grid%j_end(ij), &amp;<a name='481'>
                                  k_start, k_end                   )<a name='482'>
<a name='483'>
<a name='484'>
        CALL <A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY'>init_zero_tendency</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_ZERO_TENDENCY_14"> ( ru_tendf, rv_tendf, rw_tendf,     &amp;<a name='485'>
                                  ph_tendf, t_tendf, tke_tend,      &amp;<a name='486'>
                                  moist_tend,chem_tend,             &amp;<a name='487'>
                                  num_3d_m,num_3d_c,rk_step,        &amp;<a name='488'>
                                  ids, ide, jds, jde, kds, kde,     &amp;<a name='489'>
                                  ims, ime, jms, jme, kms, kme,     &amp;<a name='490'>
                                  grid%i_start(ij), grid%i_end(ij), &amp;<a name='491'>
                                  grid%j_start(ij), grid%j_end(ij), &amp;<a name='492'>
                                  k_start, k_end                   )<a name='493'>
<a name='494'>
     END DO<a name='495'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='496'></font>
BENCH_END(init_zero_tend_tim)<a name='497'>
<a name='498'>
#ifdef DM_PARALLEL<a name='499'>
#     include "<A href='../../html_code/include/HALO_EM_PHYS_A.inc.html'>HALO_EM_PHYS_A.inc</A>"<A NAME="HALO_EM_PHYS_A.inc_13"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='500'>
#endif<a name='501'>
<a name='502'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='503'></font>
<font color=#447700>!&lt;pre&gt;<a name='504'></font>
<font color=#447700>!(2) The non-timesplit physics begins with a call to "phy_prep"<a name='505'></font>
<font color=#447700>!    (which computes some diagnostic variables such as temperature,<a name='506'></font>
<font color=#447700>!    pressure, u and v at p points, etc).  This is followed by<a name='507'></font>
<font color=#447700>!    calls to the physics drivers:<a name='508'></font>
<font color=#447700>!<a name='509'></font>
<font color=#447700>!              radiation,<a name='510'></font>
<font color=#447700>!              surface,<a name='511'></font>
<font color=#447700>!              pbl,<a name='512'></font>
<font color=#447700>!              cumulus,<a name='513'></font>
<font color=#447700>!              3D TKE and mixing.<a name='514'></font>
<font color=#447700>!&lt;pre&gt;<a name='515'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='516'></font>
<a name='517'>
<a name='518'>
BENCH_START(phy_prep_tim)<a name='519'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='520'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='521'></font>
      DO ij = 1 , grid%num_tiles<a name='522'>
<a name='523'>
          CALL wrf_debug ( 200 , ' call phy_prep' )<a name='524'>
<a name='525'>
          print*,' TEST_phy_prep = ',TEST_phy_prep<a name='526'>
          if(TEST_phy_prep) &amp;<a name='527'>
          CALL <A href='../../html_code/dyn_em/module_check.F.html#T_PHY_PREP'>t_phy_prep</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_PHY_PREP_1"> ( config_flags,                           &amp;<a name='528'>
                         mut, u_2, v_2, p, pb, alt,              &amp;<a name='529'>
                         ph_2, phb, t_2, tsk, moist_2, num_3d_m, &amp;<a name='530'>
                         mu_3d, rho,                             &amp;<a name='531'>
                         th_phy, p_phy, pi_phy, u_phy, v_phy,    &amp;<a name='532'>
                         p8w, t_phy, t8w, z, z_at_w,             &amp;<a name='533'>
                         dz8w, fnm, fnp,                         &amp;<a name='534'>
                         RTHRATEN,                               &amp;<a name='535'>
                         RTHBLTEN, RUBLTEN, RVBLTEN,             &amp;<a name='536'>
                         RQVBLTEN, RQCBLTEN, RQIBLTEN,           &amp;<a name='537'>
                         RTHCUTEN, RQVCUTEN, RQCCUTEN,           &amp;<a name='538'>
                         RQRCUTEN, RQICUTEN, RQSCUTEN,           &amp;<a name='539'>
                         RTHFTEN,  RQVFTEN,                      &amp;<a name='540'>
                         ids, ide, jds, jde, kds, kde,           &amp;<a name='541'>
                         ims, ime, jms, jme, kms, kme,           &amp;<a name='542'>
                         grid%i_start(ij), grid%i_end(ij),       &amp;<a name='543'>
                         grid%j_start(ij), grid%j_end(ij),       &amp;<a name='544'>
                         k_start, k_end                         )<a name='545'>
<a name='546'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PHY_PREP'>phy_prep</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHY_PREP_14"> ( config_flags,                           &amp;<a name='547'>
                         mut, u_2, v_2, p, pb, alt,              &amp;<a name='548'>
                         ph_2, phb, t_2, tsk, moist_2, num_3d_m, &amp;<a name='549'>
                         mu_3d, rho,                             &amp;<a name='550'>
                         th_phy, p_phy, pi_phy, u_phy, v_phy,    &amp;<a name='551'>
                         p8w, t_phy, t8w, z, z_at_w,             &amp;<a name='552'>
                         dz8w, fnm, fnp,                         &amp;    <a name='553'>
                         RTHRATEN,                               &amp;<a name='554'>
                         RTHBLTEN, RUBLTEN, RVBLTEN,             &amp;<a name='555'>
                         RQVBLTEN, RQCBLTEN, RQIBLTEN,           &amp;<a name='556'>
                         RTHCUTEN, RQVCUTEN, RQCCUTEN,           &amp;<a name='557'>
                         RQRCUTEN, RQICUTEN, RQSCUTEN,           &amp;<a name='558'>
                         RTHFTEN,  RQVFTEN,                      &amp;<a name='559'>
                         ids, ide, jds, jde, kds, kde,           &amp;<a name='560'>
                         ims, ime, jms, jme, kms, kme,           &amp;<a name='561'>
                         grid%i_start(ij), grid%i_end(ij),       &amp;<a name='562'>
                         grid%j_start(ij), grid%j_end(ij),       &amp;<a name='563'>
                         k_start, k_end                         )<a name='564'>
      ENDDO<a name='565'>
      <font color=#447700>!$OMP END PARALLEL DO<a name='566'></font>
<a name='567'>
BENCH_END(phy_prep_tim)<a name='568'>
<a name='569'>
<font color=#447700>!  physics to implement<a name='570'></font>
<a name='571'>
<font color=#447700>!      CALL set_tiles ( grid , ids , ide-1 , jds , jde-1 ips , ipe , jps , jpe )<a name='572'></font>
<a name='573'>
<font color=#447700>! Open MP loops are in physics drivers<a name='574'></font>
<font color=#447700>! radiation<a name='575'></font>
<a name='576'>
         CALL wrf_debug ( 200 , ' call radiation_driver' )<a name='577'>
BENCH_START(rad_driver_tim)<a name='578'>
         if(dyn_opt == DYN_EM) then<a name='579'>
<font color=#447700>!         if(dyn_opt == DYN_EM_TST) then<a name='580'></font>
         CALL <A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER'>radiation_driver</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADIATION_DRIVER_3">(itimestep,dt,AER_DRY,AER_WATER,       &amp;<a name='581'>
                    RTHRATENLW,RTHRATENSW,RTHRATEN,GLW,GSW,          &amp;<a name='582'>
                    SWDOWN,                                          &amp;<a name='583'>
                    XLAT,XLONG,ALBEDO,CLDFRA,EMISS,                  &amp;<a name='584'>
                    rho,moist_2,num_3d_m,                            &amp;<a name='585'>
                    p8w,p_phy,pb,pi_phy,dz8w,t_phy,t8w,              &amp;<a name='586'>
                    GMT,JULDAY,config_flags,RADT,STEPRA,ICLOUD,      &amp;<a name='587'>
                    taucldi,taucldc,warm_rain,                       &amp;<a name='588'>
                    XLAND,TSK,HTOP,HBOT,CUPPT,VEGFRA,SNOW,           &amp;<a name='589'>
                    julyr,                                           &amp;<a name='590'>
                    1   ,                                            &amp;<a name='591'>
                    TOTSWDN,TOTLWDN,RSWTOA,RLWTOA,CZMEAN,            &amp;<a name='592'>
                    CFRACL,CFRACM,CFRACH,                            &amp;<a name='593'>
                    ACFRST,NCFRST,ACFRCV,NCFRCV,                     &amp;<a name='594'>
                    ids,ide, jds,jde, kds,kde,                       &amp;<a name='595'>
                    ims,ime, jms,jme, kms,kme,                       &amp;<a name='596'>
                    grid%i_start, min(grid%i_end, ide-1),            &amp;<a name='597'>
                    grid%j_start, min(grid%j_end, jde-1),            &amp;<a name='598'>
                    k_start    , min(k_end,kde-1) , grid%num_tiles   )<a name='599'>
         endif<a name='600'>
BENCH_END(rad_driver_tim)<a name='601'>
<a name='602'>
<a name='603'>
<a name='604'>
<font color=#447700>!********* Surface driver<a name='605'></font>
<font color=#447700>! surface<a name='606'></font>
<a name='607'>
BENCH_START(surf_driver_tim)<a name='608'>
      if(dyn_opt == DYN_EM) then<a name='609'>
<font color=#447700>!      if(dyn_opt == DYN_EM_TST) then<a name='610'></font>
      CALL wrf_debug ( 200 , ' call surface_driver' )<a name='611'>
      CALL <A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER'>surface_driver</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURFACE_DRIVER_3">(                                          &amp;<a name='612'>
     &amp;           ACSNOM,ACSNOW,AKHS,AKMS,ALBEDO,BR,CANWAT,CAPG        &amp;<a name='613'>
     &amp;          ,CHKLOWQ,CONFIG_FLAGS,DT,DX,DZ8W,DZS,EMISS,GLW        &amp;<a name='614'>
     &amp;          ,GRDFLX,GSW,GZ1OZ0,HFX,HOL,HT,IFSNOW,ISFFLX           &amp;<a name='615'>
     &amp;          ,ISLTYP,ITIMESTEP,IVGTYP,LOWLYR,MAVAIL,MOIST_2,MOL,RMOL&amp;<a name='616'>
     &amp;          ,NUM_SOIL_LAYERS,NUM_3D_M,P8W,PBLH,PI_PHY,PSHLTR,PSIH &amp;<a name='617'>
     &amp;          ,PSIM,P_PHY,Q10,Q2,QFX,QSFC,QSHLTR,QZ0,RAINBL         &amp;<a name='618'>
     &amp;          ,RAINCV,RAINNCV,REGIME,RHO,SFCEVP,SFCEXC,SFCRUNOFF    &amp;<a name='619'>
     &amp;          ,SMOIS,SMSTAV,SMSTOT,SNOALB,SNOW,SNOWC,SNOWH,STEPBL   &amp;<a name='620'>
     &amp;          ,T2,TH10,TH2,THC,THZ0,TH_PHY,TMN,TSHLTR,TSK,TSLB      &amp;<a name='621'>
     &amp;          ,T_PHY,U10,UDRUNOFF,UST,UZ0,U_FRAME,U_PHY,V10,VEGFRA  &amp;<a name='622'>
     &amp;          ,VZ0,V_FRAME,V_PHY,WARM_RAIN,WSPD,XICE,XLAND,Z,ZNT,ZS &amp;<a name='623'>
     &amp;          ,CT,TKE_MYJ                                           &amp;<a name='624'>
     &amp;          ,ALBBCK,LH,SH2O,SHDMAX,SHDMIN,Z0                      &amp;<a name='625'>
     &amp;          ,flqc,flhc,qsg,qvg,qcg,soilt1,tsnav                   &amp; <font color=#447700>! for RUC LSM<a name='626'></font>
     &amp;          ,SMFR3D,KEEPFR3DFLAG                                  &amp;<a name='627'>
     &amp;          ,PSFC                                                 &amp;<a name='628'>
     &amp;          ,ids,ide, jds,jde, kds,kde                            &amp;<a name='629'>
     &amp;          ,ims,ime, jms,jme, kms,kme                            &amp;<a name='630'>
     &amp;          ,grid%i_start, min(grid%i_end, ide-1)                 &amp;<a name='631'>
     &amp;          ,grid%j_start, min(grid%j_end, jde-1)                 &amp;<a name='632'>
     &amp;          ,k_start    , min(k_end,kde-1) , grid%num_tiles       )<a name='633'>
      endif<a name='634'>
BENCH_END(surf_driver_tim)<a name='635'>
<a name='636'>
<font color=#447700>!*********<a name='637'></font>
<font color=#447700>! pbl<a name='638'></font>
<a name='639'>
BENCH_START(pbl_driver_tim)<a name='640'>
      if(dyn_opt == DYN_EM) then<a name='641'>
<font color=#447700>!      if(dyn_opt == DYN_EM_TST) then<a name='642'></font>
      CALL wrf_debug ( 200 , ' call pbl_driver' )<a name='643'>
      CALL <A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER'>pbl_driver</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PBL_DRIVER_3">(itimestep,dt,u_frame,v_frame                    &amp;<a name='644'>
     &amp;           ,RUBLTEN,RVBLTEN,RTHBLTEN                            &amp;<a name='645'>
     &amp;           ,RQVBLTEN,RQCBLTEN,RQIBLTEN                          &amp;<a name='646'>
     &amp;           ,TSK,XLAND,ZNT,HT                                    &amp;<a name='647'>
     &amp;           ,UST,HOL,MOL,PBLH                                    &amp;<a name='648'>
     &amp;           ,HFX,QFX,REGIME,GRDFLX                               &amp;<a name='649'>
     &amp;           ,u_phy,v_phy,th_phy,rho,moist_2                      &amp;<a name='650'>
     &amp;           ,p_phy,pi_phy,p8w,t_phy,dz8w,z                       &amp;<a name='651'>
     &amp;           ,TKE_MYJ,EXCH_H,AKHS,AKMS                            &amp;<a name='652'>
     &amp;           ,THZ0,QZ0,UZ0,VZ0,QSFC,LOWLYR                        &amp;<a name='653'>
     &amp;           ,PSIM, PSIH, GZ1OZ0, WSPD, BR, CHKLOWQ               &amp;<a name='654'>
     &amp;           ,config_flags,DX,num_3d_m                            &amp;<a name='655'>
     &amp;           ,STEPBL,warm_rain                                    &amp;<a name='656'>
     &amp;           ,KPBL,CT,LH,SNOW,XICE                                &amp;<a name='657'>
     &amp;           ,ids,ide, jds,jde, kds,kde                           &amp;<a name='658'>
     &amp;           ,ims,ime, jms,jme, kms,kme                           &amp;<a name='659'>
     &amp;           ,grid%i_start, min(grid%i_end,ide-1)                 &amp;<a name='660'>
     &amp;           ,grid%j_start, min(grid%j_end,jde-1)                 &amp;<a name='661'>
     &amp;           ,k_start    , min(k_end,kde-1) , grid%num_tiles  )<a name='662'>
      endif<a name='663'>
BENCH_END(pbl_driver_tim)<a name='664'>
<a name='665'>
<font color=#447700>! cumulus para.<a name='666'></font>
<a name='667'>
BENCH_START(cu_driver_tim)<a name='668'>
       if(dyn_opt == DYN_EM) then<a name='669'>
<font color=#447700>!      if(dyn_opt == DYN_EM_TST) then<a name='670'></font>
<a name='671'>
       DO ij = 1, grid%num_tiles<a name='672'>
<a name='673'>
         CALL wrf_debug ( 200 , ' call dudu' )<a name='674'>
         print *, 'Check the DUCU, TEST_cudu = ', TEST_cudu<a name='675'>
<a name='676'>
         if ( TEST_cudu )      THEN <a name='677'>
         CALL  <A href='../../html_code/dyn_em/module_check.F.html#T_DUCU'>t_DUCU</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_DUCU_1">(                                            &amp;<a name='678'>
               IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde &amp;<a name='679'>
               ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme &amp;<a name='680'>
               ,ITS=grid%i_start(ij),ITE=min(grid%i_end(ij), ide-1)      &amp;<a name='681'>
               ,JTS=grid%j_start(ij),JTE= min(grid%j_end(ij), jde-1)    &amp;<a name='682'>
               ,KTS=k_start,KTE=min(k_end, kde-1) &amp;<a name='683'>
               ,DT=dt ,KTAU=itimestep ,DX=dx                    &amp;<a name='684'>
               ,RHO=rho,RAINCV=raincv, NCA=nca                  &amp;<a name='685'>
               ,U=u_phy ,V=v_phy ,TH=th_phy ,T=t_phy ,W=w_2    &amp;<a name='686'>
               ,DZ8W=dz8w               &amp;<a name='687'>
               ,Z=z, PCPS=p_phy, PI=pi_phy ,W0AVG=grid%W0AVG                 &amp;<a name='688'>
               ,XLV=XLV                                         &amp;<a name='689'>
               ,CP=CP ,RD=R_d ,RV=R_v ,G=G ,EP2=EP_2             &amp;<a name='690'>
               ,SVP1=SVP1 ,SVP2=SVP2 ,SVP3=SVP3 ,SVPT0=SVPT0    &amp;<a name='691'>
               ,STEPCU=stepcu                                   &amp;<a name='692'>
               ,CU_ACT_FLAG=cu_act_flag ,warm_rain=warm_rain    &amp;<a name='693'>
               ,CUTOP=HTOP,CUBOT=HBOT                           &amp;<a name='694'>
               ,QV=moist_2(ims,kms,jms,P_QV)                                                 &amp;<a name='695'>
              <font color=#447700>! optionals<a name='696'></font>
               ,RTHCUTEN=rthcuten                               &amp;<a name='697'>
               ,RQVCUTEN=rqvcuten                               &amp;<a name='698'>
<a name='699'>
                                                                )<a name='700'>
         endif<a name='701'>
         print *, 'Finishing Check the DUCU, TEST_cudu'<a name='702'>
<a name='703'>
         CALL  <A href='../../html_code/phys/module_cu_du.F.html#DUCU'>DUCU</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DUCU_5">(                                            &amp;<a name='704'>
               IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde &amp;<a name='705'>
               ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme &amp;<a name='706'>
               ,ITS=grid%i_start(ij),ITE=min(grid%i_end(ij), ide-1)      &amp;<a name='707'>
               ,JTS=grid%j_start(ij),JTE= min(grid%j_end(ij), jde-1)    &amp;<a name='708'>
               ,KTS=k_start,KTE=min(k_end, kde-1) &amp;<a name='709'>
               ,DT=dt ,KTAU=itimestep ,DX=dx                    &amp;<a name='710'>
               ,RHO=rho,RAINCV=raincv, NCA=nca                  &amp;<a name='711'>
               ,U=u_phy ,V=v_phy ,TH=th_phy ,T=t_phy ,W=w_2    &amp;<a name='712'>
               ,DZ8W=dz8w               &amp;<a name='713'>
               ,Z=z, PCPS=p_phy, PI=pi_phy ,W0AVG=grid%W0AVG                 &amp;<a name='714'>
               ,XLV=XLV                                         &amp;<a name='715'>
               ,CP=CP ,RD=R_d ,RV=R_v ,G=G ,EP2=EP_2             &amp;<a name='716'>
               ,SVP1=SVP1 ,SVP2=SVP2 ,SVP3=SVP3 ,SVPT0=SVPT0    &amp;<a name='717'>
               ,STEPCU=stepcu                                   &amp;<a name='718'>
               ,CU_ACT_FLAG=cu_act_flag ,warm_rain=warm_rain    &amp;<a name='719'>
               ,CUTOP=HTOP,CUBOT=HBOT                           &amp;<a name='720'>
               ,QV=moist_2(ims,kms,jms,P_QV)                                                 &amp;<a name='721'>
              <font color=#447700>! optionals<a name='722'></font>
               ,RTHCUTEN=rthcuten                               &amp;<a name='723'>
               ,RQVCUTEN=rqvcuten                               &amp;<a name='724'>
<a name='725'>
                                                                )<a name='726'>
<a name='727'>
       ENDDO<a name='728'>
<a name='729'>
       endif<a name='730'>
<a name='731'>
       if(dyn_opt == DYN_EM) then<a name='732'>
         CALL wrf_debug ( 200 , ' call cumulus_driver' )<a name='733'>
<a name='734'>
         CALL <A href='../../html_code/phys/module_cumulus_driver.F.html#CUMULUS_DRIVER'>cumulus_driver</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUMULUS_DRIVER_3">(                                          &amp;<a name='735'>
                 <font color=#447700>! Order dependent args: domain, mem, tile dims<a name='736'></font>
                     ids,ide, jds,jde, kds,kde                         &amp;<a name='737'>
                   , ims,ime, jms,jme, kms,kme                         &amp;<a name='738'>
                   , grid%i_start, min(grid%i_end, ide-1)              &amp;<a name='739'>
                   , grid%j_start, min(grid%j_end, jde-1)              &amp;<a name='740'>
                   , k_start  , min(k_end,kde-1) , grid%num_tiles      &amp;<a name='741'>
                 <font color=#447700>! Prognostic variables<a name='742'></font>
                   , U=u_phy   ,V=v_phy   ,TH=th_phy  ,T=t_phy         &amp;<a name='743'>
                   , W=w_2     ,P=p_phy   ,PI=pi_phy  ,RHO=rho         &amp;<a name='744'>
                 <font color=#447700>! Other arguments<a name='745'></font>
                   , ITIMESTEP=itimestep ,DT=dt      ,DX=dx            &amp;<a name='746'>
                   , RAINC=rainc   ,RAINCV=raincv   ,NCA=nca           &amp;<a name='747'>
                   , HTOP=htop     ,HBOT=hbot       ,KPBL=kpbl         &amp;<a name='748'>
                   , DZ8W=dz8w     ,P8W=p8w                            &amp;<a name='749'>
                   , W0AVG=w0avg   ,STEPCU=stepcu                      &amp;<a name='750'>
                   , CLDEFI=cldefi ,LOWLYR=lowlyr ,XLAND=xland         &amp;<a name='751'>
                   , APR_GR=apr_gr ,APR_W=apr_w   ,APR_MC=apr_mc       &amp;<a name='752'>
                   , APR_ST=apr_st ,APR_AS=apr_as ,APR_CAPMA=apr_capma &amp;<a name='753'>
                   , APR_CAPME=apr_capme          ,APR_CAPMI=apr_capmi &amp;<a name='754'>
                   , MASS_FLUX=mass_flux          ,XF_ENS=xf_ens       &amp;<a name='755'>
                   , PR_ENS=pr_ens ,HT=ht                              &amp;<a name='756'>
                   , ENSDIM=ensdim ,MAXIENS=maxiens ,MAXENS=maxens     &amp;<a name='757'>
                   , MAXENS2=maxens2                ,MAXENS3=maxens3   &amp;<a name='758'>
                   , CU_ACT_FLAG=cu_act_flag   ,WARM_RAIN=warm_rain    &amp;<a name='759'>
                 <font color=#447700>! Selection flag<a name='760'></font>
                   , CU_PHYSICS=config_flags%cu_physics                &amp;<a name='761'>
                 <font color=#447700>! Moisture tendency arguments<a name='762'></font>
                   , RQVCUTEN=rqvcuten , RQCCUTEN=rqccuten             &amp;<a name='763'>
                   , RQRCUTEN=rqrcuten , RQVBLTEN=rqvblten             &amp;<a name='764'>
                   , RQVFTEN=rqvften                                   &amp;<a name='765'>
                 <font color=#447700>! Other tendency arguments<a name='766'></font>
                   , RTHRATEN=rthraten , RTHBLTEN=rthblten             &amp;<a name='767'>
                   , RTHCUTEN=rthcuten , RTHFTEN=rthften               &amp;<a name='768'>
                 <font color=#447700>! Moisture tracer arguments<a name='769'></font>
                   , QV_CURR=moist_2(ims,kms,jms,P_QV), F_QV=F_QV      &amp;<a name='770'>
                   , QC_CURR=moist_2(ims,kms,jms,P_QC), F_QC=F_QC      &amp;<a name='771'>
                   , QR_CURR=moist_2(ims,kms,jms,P_QR), F_QR=F_QR      &amp;<a name='772'>
                   , QI_CURR=moist_2(ims,kms,jms,P_QI), F_QI=F_QI      &amp;<a name='773'>
                   , QS_CURR=moist_2(ims,kms,jms,P_QS), F_QS=F_QS      &amp;<a name='774'>
                   , QG_CURR=moist_2(ims,kms,jms,P_QG), F_QG=F_QG      &amp;<a name='775'>
                                                                       )<a name='776'>
       endif<a name='777'>
BENCH_END(cu_driver_tim)<a name='778'>
<a name='779'>
<font color=#447700>! calculate_phy_tend<a name='780'></font>
<a name='781'>
BENCH_START(cal_phy_tend)<a name='782'>
      if(dyn_opt == DYN_EM) then<a name='783'>
<font color=#447700>!      if(dyn_opt == DYN_EM_TST) then<a name='784'></font>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='785'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='786'></font>
<a name='787'>
      DO ij = 1 , grid%num_tiles<a name='788'>
<a name='789'>
          CALL wrf_debug ( 200 , ' call calculate_phy_tend' )<a name='790'>
          CALL <A href='../../html_code/dyn_em/module_em.F.html#CALCULATE_PHY_TEND'>calculate_phy_tend</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_PHY_TEND_3"> (config_flags,mut,pi_phy,            &amp;<a name='791'>
                     RTHRATEN,                                         &amp;<a name='792'>
                     RUBLTEN,RVBLTEN,RTHBLTEN,                         &amp;<a name='793'>
                     RQVBLTEN,RQCBLTEN,RQIBLTEN,                       &amp;<a name='794'>
                     RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN,              &amp;<a name='795'>
                     RQICUTEN,RQSCUTEN,                                &amp;<a name='796'>
                     ids,ide, jds,jde, kds,kde,                        &amp;<a name='797'>
                     ims,ime, jms,jme, kms,kme,                        &amp;<a name='798'>
                     grid%i_start(ij), min(grid%i_end(ij),ide-1),      &amp;<a name='799'>
                     grid%j_start(ij), min(grid%j_end(ij),jde-1),      &amp;<a name='800'>
                     k_start    , min(k_end,kde-1)                     )<a name='801'>
<a name='802'>
      ENDDO<a name='803'>
      <font color=#447700>!$OMP END PARALLEL DO<a name='804'></font>
      endif<a name='805'>
BENCH_END(cal_phy_tend)<a name='806'>
<a name='807'>
<font color=#447700>! tke diffusion<a name='808'></font>
<a name='809'>
     IF(diff_opt .eq. 2 .OR. diff_opt .eq. 1) THEN<a name='810'>
<a name='811'>
BENCH_START(comp_diff_metrics_tim)<a name='812'>
       if(dyn_opt == DYN_EM) then<a name='813'>
<font color=#447700>!       if(dyn_opt == DYN_EM_TST) then<a name='814'></font>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='815'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='816'></font>
<a name='817'>
       DO ij = 1 , grid%num_tiles<a name='818'>
<a name='819'>
          CALL wrf_debug ( 200 , ' call compute_diff_metrics ' )<a name='820'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#COMPUTE_DIFF_METRICS'>compute_diff_metrics</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_DIFF_METRICS_3"> ( config_flags, ph_2, phb, z, rdz, rdzw, &amp;<a name='821'>
                                      zx, zy, rdx, rdy,                      &amp;<a name='822'>
                                      ids, ide, jds, jde, kds, kde,          &amp;<a name='823'>
                                      ims, ime, jms, jme, kms, kme,          &amp;<a name='824'>
                                      grid%i_start(ij), grid%i_end(ij),      &amp;<a name='825'>
                                      grid%j_start(ij), grid%j_end(ij),      &amp;<a name='826'>
                                      k_start    , k_end                    )<a name='827'>
       ENDDO<a name='828'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='829'></font>
       endif<a name='830'>
BENCH_END(comp_diff_metrics_tim)<a name='831'>
<a name='832'>
#ifdef DM_PARALLEL<a name='833'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_A1.inc.html'>PERIOD_BDY_EM_A1.inc</A>"<A NAME="PERIOD_BDY_EM_A1.inc_14"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='834'>
#endif<a name='835'>
<a name='836'>
BENCH_START(tke_diff_bc_tim)<a name='837'>
       if(dyn_opt == DYN_EM) then<a name='838'>
<font color=#447700>!       if(dyn_opt == DYN_EM_TST) then<a name='839'></font>
       DO ij = 1 , grid%num_tiles<a name='840'>
<a name='841'>
          CALL wrf_debug ( 200 , ' call bc for diffusion_metrics ' )<a name='842'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_121">( rdzw , 'w', config_flags,           &amp;<a name='843'>
                                  ids, ide, jds, jde, kds, kde,       &amp;<a name='844'>
                                  ims, ime, jms, jme, kms, kme,       &amp;<a name='845'>
                                  ips, ipe, jps, jpe, kps, kpe,       &amp;<a name='846'>
                                  grid%i_start(ij), grid%i_end(ij),   &amp;<a name='847'>
                                  grid%j_start(ij), grid%j_end(ij),   &amp;<a name='848'>
                                  k_start    , k_end                 )<a name='849'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_122">( rdz , 'w', config_flags,           &amp;<a name='850'>
                                  ids, ide, jds, jde, kds, kde,       &amp;<a name='851'>
                                  ims, ime, jms, jme, kms, kme,       &amp;<a name='852'>
                                  ips, ipe, jps, jpe, kps, kpe,       &amp;<a name='853'>
                                  grid%i_start(ij), grid%i_end(ij),   &amp;<a name='854'>
                                  grid%j_start(ij), grid%j_end(ij),   &amp;<a name='855'>
                                  k_start    , k_end                 )<a name='856'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_123">( z , 'w', config_flags,           &amp;<a name='857'>
                                  ids, ide, jds, jde, kds, kde,       &amp;<a name='858'>
                                  ims, ime, jms, jme, kms, kme,       &amp;<a name='859'>
                                  ips, ipe, jps, jpe, kps, kpe,       &amp;<a name='860'>
                                  grid%i_start(ij), grid%i_end(ij),   &amp;<a name='861'>
                                  grid%j_start(ij), grid%j_end(ij),   &amp;<a name='862'>
                                  k_start    , k_end                 )<a name='863'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_124">( zx , 'w', config_flags,           &amp;<a name='864'>
                                  ids, ide, jds, jde, kds, kde,       &amp;<a name='865'>
                                  ims, ime, jms, jme, kms, kme,       &amp;<a name='866'>
                                  ips, ipe, jps, jpe, kps, kpe,       &amp;<a name='867'>
                                  grid%i_start(ij), grid%i_end(ij),   &amp;<a name='868'>
                                  grid%j_start(ij), grid%j_end(ij),   &amp;<a name='869'>
                                  k_start    , k_end                 )<a name='870'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_125">( zy , 'w', config_flags,           &amp;<a name='871'>
                                  ids, ide, jds, jde, kds, kde,       &amp;<a name='872'>
                                  ims, ime, jms, jme, kms, kme,       &amp;<a name='873'>
                                  ips, ipe, jps, jpe, kps, kpe,       &amp;<a name='874'>
                                  grid%i_start(ij), grid%i_end(ij),   &amp;<a name='875'>
                                  grid%j_start(ij), grid%j_end(ij),   &amp;<a name='876'>
                                  k_start    , k_end                 )<a name='877'>
<a name='878'>
       ENDDO<a name='879'>
       endif<a name='880'>
BENCH_END(tke_diff_bc_tim)<a name='881'>
<a name='882'>
#ifdef DM_PARALLEL<a name='883'>
#     include "<A href='../../html_code/include/HALO_EM_TKE_C.inc.html'>HALO_EM_TKE_C.inc</A>"<A NAME="HALO_EM_TKE_C.inc_15"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='884'>
#endif<a name='885'>
<a name='886'>
BENCH_START(deform_div_tim)<a name='887'>
       if(dyn_opt == DYN_EM) then<a name='888'>
<font color=#447700>!       if(dyn_opt == DYN_EM_TST) then<a name='889'></font>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='890'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='891'></font>
<a name='892'>
       DO ij = 1 , grid%num_tiles<a name='893'>
<a name='894'>
          CALL wrf_debug ( 200 , ' call cal_deform_and_div' )<a name='895'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_DEFORM_AND_DIV'>cal_deform_and_div</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_DEFORM_AND_DIV_3"> ( config_flags,u_2,v_2,w_2,div,        &amp;<a name='896'>
                                    defor11,defor22,defor33,defor12,     &amp;<a name='897'>
                                    defor13,defor23,                     &amp;<a name='898'>
                                    u_base, v_base,msfu,msfv,msft,       &amp;<a name='899'>
                                    rdx, rdy, dn, dnw, rdz, rdzw,        &amp;<a name='900'>
                                    fnm,fnp,cf1,cf2,cf3,zx,zy,           &amp;<a name='901'>
                                    ids, ide, jds, jde, kds, kde,        &amp;<a name='902'>
                                    ims, ime, jms, jme, kms, kme,        &amp;<a name='903'>
                                    grid%i_start(ij), grid%i_end(ij),    &amp;<a name='904'>
                                    grid%j_start(ij), grid%j_end(ij),    &amp;<a name='905'>
                                    k_start    , k_end                  )<a name='906'>
       ENDDO<a name='907'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='908'></font>
       endif<a name='909'>
BENCH_END(deform_div_tim)<a name='910'>
<a name='911'>
<a name='912'>
#ifdef DM_PARALLEL<a name='913'>
#     include "<A href='../../html_code/include/HALO_EM_TKE_D.inc.html'>HALO_EM_TKE_D.inc</A>"<A NAME="HALO_EM_TKE_D.inc_16"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='914'>
#endif<a name='915'>
<a name='916'>
<a name='917'>
<font color=#447700>! calculate tke, kmh, and kmv<a name='918'></font>
<a name='919'>
BENCH_START(calc_tke_tim)<a name='920'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='921'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='922'></font>
<a name='923'>
       DO ij = 1 , grid%num_tiles<a name='924'>
<a name='925'>
          CALL wrf_debug ( 200 , ' call calculate_km_kh' )<a name='926'>
<a name='927'>
          print*,'TEST_calculate_km_kh = ',TEST_calculate_km_kh<a name='928'>
          if(TEST_calculate_km_kh) &amp;<a name='929'>
          CALL <A href='../../html_code/dyn_em/module_check.F.html#T_CALCULATE_KM_KH'>t_calculate_km_kh</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_CALCULATE_KM_KH_1">( config_flags,dt,dampcoef,zdamp,damp_opt,     &amp;<a name='930'>
                                xkmh,xkmhd,xkmv,xkhh,xkhv,BN2,               &amp;<a name='931'>
                                khdif,kvdif,div,                             &amp;<a name='932'>
                                defor11,defor22,defor33,defor12,             &amp;<a name='933'>
                                defor13,defor23,                             &amp;<a name='934'>
                                tke_2(ims,kms,jms),p8w,t8w,th_phy,           &amp;<a name='935'>
                                t_phy,p_phy,moist_2,dn,dnw,                  &amp;<a name='936'>
                                dx,dy,rdz,rdzw,mix_cr_len,num_3d_m,          &amp;<a name='937'>
                                cf1, cf2, cf3, warm_rain,                    &amp;<a name='938'>
                                kh_tke_upper_bound, kv_tke_upper_bound,      &amp;<a name='939'>
                                ids,ide, jds,jde, kds,kde,                   &amp;<a name='940'>
                                ims,ime, jms,jme, kms,kme,                   &amp;<a name='941'>
                                grid%i_start(ij), grid%i_end(ij),            &amp;<a name='942'>
                                grid%j_start(ij), grid%j_end(ij),            &amp;<a name='943'>
                                k_start    , k_end                          )<a name='944'>
<a name='945'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH'>calculate_km_kh</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_KM_KH_14">( config_flags,dt,dampcoef,zdamp,damp_opt,     &amp;<a name='946'>
                                xkmh,xkmhd,xkmv,xkhh,xkhv,BN2,               &amp;<a name='947'>
                                khdif,kvdif,div,                             &amp;<a name='948'>
                                defor11,defor22,defor33,defor12,             &amp;<a name='949'>
                                defor13,defor23,                             &amp;<a name='950'>
                                tke_2(ims,kms,jms),p8w,t8w,th_phy,           &amp;<a name='951'>
                                t_phy,p_phy,moist_2,dn,dnw,                  &amp;<a name='952'>
                                dx,dy,rdz,rdzw,mix_cr_len,num_3d_m,          &amp;<a name='953'>
                                cf1, cf2, cf3, warm_rain,                    &amp;<a name='954'>
                                kh_tke_upper_bound, kv_tke_upper_bound,      &amp;<a name='955'>
                                ids,ide, jds,jde, kds,kde,                   &amp;<a name='956'>
                                ims,ime, jms,jme, kms,kme,                   &amp;<a name='957'>
                                grid%i_start(ij), grid%i_end(ij),            &amp;<a name='958'>
                                grid%j_start(ij), grid%j_end(ij),            &amp;<a name='959'>
                                k_start    , k_end                          )<a name='960'>
       ENDDO<a name='961'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='962'></font>
BENCH_END(calc_tke_tim)<a name='963'>
<a name='964'>
#ifdef DM_PARALLEL<a name='965'>
#     include "<A href='../../html_code/include/HALO_EM_TKE_E.inc.html'>HALO_EM_TKE_E.inc</A>"<A NAME="HALO_EM_TKE_E.inc_17"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='966'>
#endif<a name='967'>
<a name='968'>
     ENDIF<a name='969'>
<a name='970'>
#ifdef DM_PARALLEL<a name='971'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_PHY_BC.inc.html'>PERIOD_BDY_EM_PHY_BC.inc</A>"<A NAME="PERIOD_BDY_EM_PHY_BC.inc_18"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='972'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_CHEM.inc.html'>PERIOD_BDY_EM_CHEM.inc</A>"<A NAME="PERIOD_BDY_EM_CHEM.inc_19"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='973'>
#endif<a name='974'>
<a name='975'>
BENCH_START(phy_bc_tim)<a name='976'>
     if(dyn_opt == DYN_EM) then<a name='977'>
<font color=#447700>!     if(dyn_opt == DYN_EM_TST) then<a name='978'></font>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='979'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='980'></font>
<a name='981'>
     DO ij = 1 , grid%num_tiles<a name='982'>
<a name='983'>
          CALL wrf_debug ( 200 , ' call phy_bc' )<a name='984'>
       CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC'>phy_bc</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHY_BC_3"> (config_flags,div,defor11,defor22,defor33,            &amp;<a name='985'>
                            defor12,defor13,defor23,                     &amp;<a name='986'>
                            xkmh,xkmhd,xkmv,xkhh,xkhv,                   &amp;<a name='987'>
                            tke_2(ims,kms,jms),                          &amp;<a name='988'>
                            RUBLTEN, RVBLTEN,                            &amp;<a name='989'>
                            ids, ide, jds, jde, kds, kde,                &amp;<a name='990'>
                            ims, ime, jms, jme, kms, kme,                &amp;<a name='991'>
                            ips, ipe, jps, jpe, kps, kpe,                &amp;<a name='992'>
                            grid%i_start(ij), grid%i_end(ij),                      &amp;<a name='993'>
                            grid%j_start(ij), grid%j_end(ij),                      &amp;<a name='994'>
                            k_start    , k_end                           )<a name='995'>
     ENDDO<a name='996'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='997'></font>
     endif<a name='998'>
BENCH_END(phy_bc_tim)<a name='999'>
<a name='1000'>
#ifdef DM_PARALLEL<a name='1001'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1002'></font>
<font color=#447700>!<a name='1003'></font>
<font color=#447700>! MPP for some physics tendency, km, kh, deformation, and divergence<a name='1004'></font>
<font color=#447700>!<a name='1005'></font>
<font color=#447700>!               *                     *<a name='1006'></font>
<font color=#447700>!             * + *      * + *        +<a name='1007'></font>
<font color=#447700>!               *                     *<a name='1008'></font>
<font color=#447700>!<a name='1009'></font>
<font color=#447700>! (for PBL)<a name='1010'></font>
<font color=#447700>! RUBLTEN                  x<a name='1011'></font>
<font color=#447700>! RVBLTEN                             x<a name='1012'></font>
<font color=#447700>!<a name='1013'></font>
<font color=#447700>! (for diff_opt &gt;= 1)<a name='1014'></font>
<font color=#447700>! defor11                  x<a name='1015'></font>
<font color=#447700>! defor22                             x<a name='1016'></font>
<font color=#447700>! defor12       x<a name='1017'></font>
<font color=#447700>! defor13                  x<a name='1018'></font>
<font color=#447700>! defor23                             x<a name='1019'></font>
<font color=#447700>! div           x<a name='1020'></font>
<font color=#447700>! xkmv          x<a name='1021'></font>
<font color=#447700>! xkmh          x<a name='1022'></font>
<font color=#447700>! xkmhd         x<a name='1023'></font>
<font color=#447700>! xkhv          x<a name='1024'></font>
<font color=#447700>! xkhh          x<a name='1025'></font>
<font color=#447700>! tke           x<a name='1026'></font>
<font color=#447700>!<a name='1027'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1028'></font>
      IF ( bl_pbl_physics .ge. 1 ) THEN<a name='1029'>
#      include "<A href='../../html_code/include/HALO_EM_PHYS_PBL.inc.html'>HALO_EM_PHYS_PBL.inc</A>"<A NAME="HALO_EM_PHYS_PBL.inc_20"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1030'>
      ENDIF<a name='1031'>
      IF ( diff_opt .ge. 1 ) THEN<a name='1032'>
#      include "<A href='../../html_code/include/HALO_EM_PHYS_DIFFUSION.inc.html'>HALO_EM_PHYS_DIFFUSION.inc</A>"<A NAME="HALO_EM_PHYS_DIFFUSION.inc_21"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1033'>
      ENDIF<a name='1034'>
<a name='1035'>
      IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='1036'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_3.inc.html'>HALO_EM_TKE_3.inc</A>"<A NAME="HALO_EM_TKE_3.inc_22"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1037'>
      ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='1038'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_5.inc.html'>HALO_EM_TKE_5.inc</A>"<A NAME="HALO_EM_TKE_5.inc_23"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1039'>
      ELSE<a name='1040'>
        WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='1041'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_63">(TRIM(wrf_err_message))<a name='1042'>
      ENDIF<a name='1043'>
#endif<a name='1044'>
<a name='1045'>
BENCH_START(update_phy_ten_tim)<a name='1046'>
      if(dyn_opt == DYN_EM) then<a name='1047'>
<font color=#447700>!      if(dyn_opt == DYN_EM_TST) then<a name='1048'></font>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1049'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='1050'></font>
<a name='1051'>
      DO ij = 1 , grid%num_tiles<a name='1052'>
<a name='1053'>
          CALL wrf_debug ( 200 , ' call update_phy_ten' )<a name='1054'>
        CALL <A href='../../html_code/phys/module_physics_addtendc.F.html#UPDATE_PHY_TEN'>update_phy_ten</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPDATE_PHY_TEN_3">(t_tendf, ru_tendf, rv_tendf,moist_tend,        &amp;<a name='1055'>
                          RTHRATEN,RTHBLTEN,RTHCUTEN,RUBLTEN,RVBLTEN,  &amp;<a name='1056'>
                          RQVBLTEN,RQCBLTEN,RQIBLTEN,                  &amp;<a name='1057'>
                          RQVCUTEN,RQCCUTEN,RQRCUTEN,RQICUTEN,RQSCUTEN,&amp;<a name='1058'>
                          num_3d_m,config_flags,rk_step,              &amp;<a name='1059'>
                          ids, ide, jds, jde, kds, kde,                &amp;<a name='1060'>
                          ims, ime, jms, jme, kms, kme,                &amp;<a name='1061'>
                          grid%i_start(ij), grid%i_end(ij),                      &amp;<a name='1062'>
                          grid%j_start(ij), grid%j_end(ij),                      &amp;<a name='1063'>
                          k_start, k_end                               )<a name='1064'>
<a name='1065'>
      END DO<a name='1066'>
      <font color=#447700>!$OMP END PARALLEL DO<a name='1067'></font>
      endif<a name='1068'>
BENCH_END(update_phy_ten_tim)<a name='1069'>
<a name='1070'>
     IF( diff_opt .eq. 2 .and. km_opt .eq. 2 ) THEN<a name='1071'>
<a name='1072'>
BENCH_START(tke_rhs_tim)<a name='1073'>
       if(dyn_opt == DYN_EM) then<a name='1074'>
<font color=#447700>!       if(dyn_opt == DYN_EM_TST) then<a name='1075'></font>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1076'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1077'></font>
<a name='1078'>
       DO ij = 1 , grid%num_tiles<a name='1079'>
<a name='1080'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_RHS'>tke_rhs</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TKE_RHS_3">  ( tke_tend,BN2,                               &amp;<a name='1081'>
                          config_flags,defor11,defor22,defor33,       &amp;<a name='1082'>
                          defor12,defor13,defor23,u_2,v_2,w_2,div,    &amp;<a name='1083'>
                          tke_2(ims,kms,jms),mut,                     &amp;<a name='1084'>
                          th_phy,p_phy,p8w,t8w,z,fnm,fnp,             &amp;<a name='1085'>
                          cf1,cf2,cf3,msft,xkmh,xkmv,xkhv,rdx,rdy,    &amp;<a name='1086'>
                          dx,dy,dt,zx,zy,rdz,rdzw,dn,dnw,mix_cr_len,  &amp;<a name='1087'>
                          ids, ide, jds, jde, kds, kde,               &amp;<a name='1088'>
                          ims, ime, jms, jme, kms, kme,               &amp;<a name='1089'>
                          grid%i_start(ij), grid%i_end(ij),           &amp;<a name='1090'>
                          grid%j_start(ij), grid%j_end(ij),           &amp;<a name='1091'>
                          k_start    , k_end                         )<a name='1092'>
<a name='1093'>
       ENDDO<a name='1094'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1095'></font>
       endif<a name='1096'>
BENCH_END(tke_rhs_tim)<a name='1097'>
<a name='1098'>
     ENDIF<a name='1099'>
<a name='1100'>
<font color=#447700>! calculate vertical diffusion first and then horizontal<a name='1101'></font>
<font color=#447700>! (keep this order)<a name='1102'></font>
<a name='1103'>
     IF(diff_opt .eq. 2) THEN<a name='1104'>
<a name='1105'>
       IF (bl_pbl_physics .eq. 0) THEN<a name='1106'>
<a name='1107'>
BENCH_START(vert_diff_tim)<a name='1108'>
         if(dyn_opt == DYN_EM) then<a name='1109'>
<font color=#447700>!         if(dyn_opt == DYN_EM_TST) then<a name='1110'></font>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1111'></font>
         <font color=#447700>!$OMP PRIVATE ( ij )<a name='1112'></font>
         DO ij = 1 , grid%num_tiles<a name='1113'>
<a name='1114'>
           CALL wrf_debug ( 200 , ' call vertical_diffusion_2 ' )<a name='1115'>
           CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2'>vertical_diffusion_2</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_2_3">( ru_tendf, rv_tendf, rw_tendf,              &amp;<a name='1116'>
                                      t_tendf, tke_tend,                         &amp;<a name='1117'>
                                      moist_tend, num_3d_m,                      &amp;<a name='1118'>
                                      chem_tend, num_3d_c,                       &amp;<a name='1119'>
                                      u_2, v_2,                                  &amp;<a name='1120'>
                                      t_2,u_base,v_base,t_base,qv_base,          &amp;<a name='1121'>
                                      mut,tke_2,config_flags,                    &amp;<a name='1122'>
                                      defor13,defor23,defor33,                   &amp;<a name='1123'>
                                      div, moist_2, chem_2, xkmv, xkhv, km_opt,  &amp;<a name='1124'>
                                      fnm, fnp, dn, dnw, rdz, rdzw,              &amp;<a name='1125'>
                                      ids, ide, jds, jde, kds, kde,              &amp;<a name='1126'>
                                      ims, ime, jms, jme, kms, kme,              &amp;<a name='1127'>
                                      grid%i_start(ij), grid%i_end(ij),          &amp;<a name='1128'>
                                      grid%j_start(ij), grid%j_end(ij),          &amp;<a name='1129'>
                                      k_start    , k_end                        )<a name='1130'>
<a name='1131'>
         ENDDO<a name='1132'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='1133'></font>
         endif<a name='1134'>
BENCH_END(vert_diff_tim)<a name='1135'>
<a name='1136'>
       ENDIF<a name='1137'>
<font color=#447700>!<a name='1138'></font>
BENCH_START(hor_diff_tim)<a name='1139'>
       if(dyn_opt == DYN_EM) then<a name='1140'>
<font color=#447700>!       if(dyn_opt == DYN_EM_TST) then<a name='1141'></font>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1142'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1143'></font>
       DO ij = 1 , grid%num_tiles<a name='1144'>
<a name='1145'>
          CALL wrf_debug ( 200 , ' call horizontal_diffusion_2' )<a name='1146'>
         CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2'>horizontal_diffusion_2</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_2_3">( t_tendf, ru_tendf, rv_tendf, rw_tendf, &amp;<a name='1147'>
                                      tke_tend,                              &amp;<a name='1148'>
                                      moist_tend, num_3d_m,                  &amp;<a name='1149'>
                                      chem_tend, num_3d_c,                   &amp;<a name='1150'>
                                      t_2, th_phy,                           &amp;<a name='1151'>
                                      mut, tke_2, config_flags,              &amp;<a name='1152'>
                                      defor11, defor22, defor12,             &amp;<a name='1153'>
                                      defor13, defor23, div,                 &amp;<a name='1154'>
                                      moist_2, chem_2,                       &amp;<a name='1155'>
                                      msfu, msfv, msft, xkmhd, xkhh, km_opt, &amp;<a name='1156'>
                                      rdx, rdy, rdz, rdzw,                   &amp;<a name='1157'>
                                      fnm, fnp, cf1, cf2, cf3,               &amp;<a name='1158'>
                                      zx, zy, dn, dnw,                       &amp;<a name='1159'>
                                      ids, ide, jds, jde, kds, kde,          &amp;<a name='1160'>
                                      ims, ime, jms, jme, kms, kme,          &amp;<a name='1161'>
                                      grid%i_start(ij), grid%i_end(ij),      &amp;<a name='1162'>
                                      grid%j_start(ij), grid%j_end(ij),      &amp;<a name='1163'>
                                      k_start    , k_end                    )<a name='1164'>
       ENDDO<a name='1165'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1166'></font>
       endif<a name='1167'>
BENCH_END(hor_diff_tim)<a name='1168'>
<a name='1169'>
     ENDIF<a name='1170'>
<a name='1171'>
     END IF rk_step_is_one<a name='1172'>
<a name='1173'>
BENCH_START(rk_tend_tim)<a name='1174'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1175'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='1176'></font>
   DO ij = 1 , grid%num_tiles<a name='1177'>
<a name='1178'>
      CALL wrf_debug ( 200 , ' call rk_tendency' )<a name='1179'>
<a name='1180'>
      print*,'TEST_rk_tendency = ',TEST_rk_tendency<a name='1181'>
      if(TEST_rk_tendency) &amp;<a name='1182'>
      CALL <A href='../../html_code/dyn_em/module_check.F.html#T_RK_TENDENCY'>t_rk_tendency</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_RK_TENDENCY_1"> ( config_flags, rk_step,                           &amp;<a name='1183'>
                         ru_tend, rv_tend, rw_tend, ph_tend, t_tend,      &amp;<a name='1184'>
                         ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='1185'>
                         mu_tend, u_save, v_save, w_save, ph_save,        &amp;<a name='1186'>
                         t_save, mu_save, RTHFTEN,                        &amp;<a name='1187'>
                         ru, rv, rw, ww,                                  &amp;<a name='1188'>
                         u_2, v_2, w_2, t_2, ph_2,                        &amp;<a name='1189'>
                         u_1, v_1, w_1, t_1, ph_1,                        &amp;<a name='1190'>
                         h_diabatic, phb, t_init,                         &amp;<a name='1191'>
                         mu_2, mut, muu, muv, mub,                        &amp;<a name='1192'>
                         al, alt, p, pb, php, cqu, cqv, cqw,              &amp;<a name='1193'>
                         u_base, v_base, t_base, qv_base, z_base,         &amp;<a name='1194'>
                         msfu, msfv, msft, f, e, sina, cosa,              &amp;<a name='1195'>
                         fnm, fnp, rdn, rdnw,                             &amp;<a name='1196'>
                         dt, rdx, rdy, khdif, kvdif, xkmhd,               &amp;<a name='1197'>
                         cf1, cf2, cf3, cfn, cfn1, num_3d_m,              &amp;<a name='1198'>
                         non_hydrostatic, leapfrog,                       &amp;<a name='1199'>
                         ids, ide, jds, jde, kds, kde,                    &amp;<a name='1200'>
                         ims, ime, jms, jme, kms, kme,                    &amp;<a name='1201'>
                         grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1202'>
                         grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1203'>
                         k_start, k_end                                  )<a name='1204'>
<a name='1205'>
<a name='1206'>
      CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY'>rk_tendency</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_TENDENCY_13"> ( config_flags, rk_step,                           &amp;<a name='1207'>
                         ru_tend, rv_tend, rw_tend, ph_tend, t_tend,      &amp;<a name='1208'>
                         ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='1209'>
                         mu_tend, u_save, v_save, w_save, ph_save,        &amp;<a name='1210'>
                         t_save, mu_save, RTHFTEN,                        &amp;<a name='1211'>
                         ru, rv, rw, ww,                                  &amp;<a name='1212'>
                         u_2, v_2, w_2, t_2, ph_2,                        &amp;<a name='1213'>
                         u_1, v_1, w_1, t_1, ph_1,                        &amp;<a name='1214'>
                         h_diabatic, phb, t_init,                         &amp;<a name='1215'>
                         mu_2, mut, muu, muv, mub,                        &amp;<a name='1216'>
                         al, alt, p, pb, php, cqu, cqv, cqw,              &amp;<a name='1217'>
                         u_base, v_base, t_base, qv_base, z_base,         &amp;<a name='1218'>
                         msfu, msfv, msft, f, e, sina, cosa,              &amp;<a name='1219'>
                         fnm, fnp, rdn, rdnw,                             &amp;<a name='1220'>
                         dt, rdx, rdy, khdif, kvdif, xkmhd,               &amp;<a name='1221'>
                         cf1, cf2, cf3, cfn, cfn1, num_3d_m,              &amp;<a name='1222'>
                         non_hydrostatic, leapfrog,                       &amp;<a name='1223'>
                         ids, ide, jds, jde, kds, kde,                    &amp;<a name='1224'>
                         ims, ime, jms, jme, kms, kme,                    &amp;<a name='1225'>
                         grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1226'>
                         grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1227'>
                         k_start, k_end                                  )<a name='1228'>
<a name='1229'>
<a name='1230'>
<font color=#447700>!     IF (rk_step == 1 ) then<a name='1231'></font>
<a name='1232'>
<font color=#447700>!     print*,'TEST_surface_drag = ',TEST_surface_drag<a name='1233'></font>
<font color=#447700>!     if(TEST_surface_drag) &amp;<a name='1234'></font>
<font color=#447700>!       CALL t_surface_drag (ru_tendf, rv_tendf, u_2, v_2, xland,             &amp;<a name='1235'></font>
<font color=#447700>!                               muu, muv,z,z_at_w,&amp;<a name='1236'></font>
<font color=#447700>!                        ids, ide, jds, jde, kds, kde,                    &amp;<a name='1237'></font>
<font color=#447700>!                        ims, ime, jms, jme, kms, kme,                    &amp;<a name='1238'></font>
<font color=#447700>!                        grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1239'></font>
<font color=#447700>!                        grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1240'></font>
<font color=#447700>!                        k_start, k_end                                  )<a name='1241'></font>
<a name='1242'>
<font color=#447700>!          CALL surface_drag (ru_tendf, rv_tendf, u_2, v_2, xland,             &amp;<a name='1243'></font>
<font color=#447700>!                        muu, muv,z,z_at_w,&amp;<a name='1244'></font>
<font color=#447700>!                        ids, ide, jds, jde, kds, kde,                    &amp;<a name='1245'></font>
<font color=#447700>!                        ims, ime, jms, jme, kms, kme,                    &amp;<a name='1246'></font>
<font color=#447700>!                        grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1247'></font>
<font color=#447700>!                        grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1248'></font>
<font color=#447700>!                        k_start, k_end                                  )<a name='1249'></font>
<a name='1250'>
<font color=#447700>!     ENDIF<a name='1251'></font>
<a name='1252'>
      if(TEST_advect_scalar) &amp;<a name='1253'>
         CALL <A href='../../html_code/dyn_em/module_check.F.html#T_ADVECT_SCALAR'>t_advect_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_ADVECT_SCALAR_1"> ( t_2, t_2, t_tend, ru, rv, ww,   &amp;<a name='1254'>
                         mut, config_flags,            &amp;<a name='1255'>
                         msfu, msfv, msft, fnm, fnp,   &amp;<a name='1256'>
                         rdx, rdy, rdnw,               &amp;<a name='1257'>
                         ids, ide, jds, jde, kds, kde, &amp;<a name='1258'>
                         ims, ime, jms, jme, kms, kme, &amp;<a name='1259'>
                         grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1260'>
                         grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1261'>
                         k_start, k_end                                  )<a name='1262'>
<a name='1263'>
<a name='1264'>
   END DO<a name='1265'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1266'></font>
BENCH_END(rk_tend_tim)<a name='1267'>
<a name='1268'>
BENCH_START(relax_bdy_dry_tim)<a name='1269'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1270'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='1271'></font>
   DO ij = 1 , grid%num_tiles<a name='1272'>
<a name='1273'>
     IF( (config_flags%specified .or. config_flags%nested) .and. rk_step == 1 ) THEN <a name='1274'>
<a name='1275'>
 <a name='1276'>
       print*,'TEST_relax_bdy_dry = ',TEST_relax_bdy_dry<a name='1277'>
       if(TEST_relax_bdy_dry) &amp;<a name='1278'>
       CALL <A href='../../html_code/dyn_em/module_check.F.html#T_RELAX_BDY_DRY'>t_relax_bdy_dry</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_RELAX_BDY_DRY_1"> ( config_flags,                                &amp;<a name='1279'>
                            u_save, v_save, ph_save, t_save,             &amp;<a name='1280'>
                            w_save, mu_tend,                             &amp;<a name='1281'>
                            ru, rv, ph_2, t_2,                           &amp;<a name='1282'>
                            w_2, mu_2, mut,                              &amp;<a name='1283'>
                            u_b, v_b, ph_b, t_b, w_b,                    &amp;<a name='1284'>
                            mu_b,                                        &amp;<a name='1285'>
                            u_bt, v_bt, ph_bt, t_bt,                     &amp;<a name='1286'>
                            w_bt, mu_bt,                                 &amp;<a name='1287'>
                            spec_bdy_width, spec_zone, relax_zone,       &amp;<a name='1288'>
                            dtbc, fcx, gcx,             &amp;<a name='1289'>
                            ijds, ijde,                 &amp;<a name='1290'>
                            ids,ide, jds,jde, kds,kde,  &amp;<a name='1291'>
                            ims,ime, jms,jme, kms,kme,  &amp;<a name='1292'>
                            ips,ipe, jps,jpe, kps,kpe,  &amp;<a name='1293'>
                            grid%i_start(ij), grid%i_end(ij),            &amp;<a name='1294'>
                            grid%j_start(ij), grid%j_end(ij),            &amp;<a name='1295'>
                            k_start, k_end                              )<a name='1296'>
<a name='1297'>
       CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_DRY'>relax_bdy_dry</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_DRY_12"> ( config_flags,                                &amp;<a name='1298'>
                            u_save, v_save, ph_save, t_save,             &amp;<a name='1299'>
                            w_save, mu_tend,                             &amp; <a name='1300'>
                            ru, rv, ph_2, t_2,                           &amp;<a name='1301'>
                            w_2, mu_2, mut,                              &amp;<a name='1302'>
                            u_b, v_b, ph_b, t_b, w_b,                    &amp;<a name='1303'>
                            mu_b,                                        &amp;<a name='1304'>
                            u_bt, v_bt, ph_bt, t_bt,                     &amp;<a name='1305'>
                            w_bt, mu_bt,                                 &amp;<a name='1306'>
                            spec_bdy_width, spec_zone, relax_zone,       &amp;<a name='1307'>
                            dtbc, fcx, gcx,             &amp;<a name='1308'>
                            ijds, ijde,                 &amp;<a name='1309'>
                            ids,ide, jds,jde, kds,kde,  &amp;<a name='1310'>
                            ims,ime, jms,jme, kms,kme,  &amp;<a name='1311'>
                            ips,ipe, jps,jpe, kps,kpe,  &amp;<a name='1312'>
                            grid%i_start(ij), grid%i_end(ij),            &amp;<a name='1313'>
                            grid%j_start(ij), grid%j_end(ij),            &amp;<a name='1314'>
                            k_start, k_end                              )<a name='1315'>
<a name='1316'>
<a name='1317'>
     ENDIF<a name='1318'>
<a name='1319'>
     print*,'TEST_rk_addtend_dry = ',TEST_rk_addtend_dry<a name='1320'>
     if(TEST_rk_addtend_dry) &amp;<a name='1321'>
     CALL <A href='../../html_code/dyn_em/module_check.F.html#T_RK_ADDTEND_DRY'>t_rk_addtend_dry</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_RK_ADDTEND_DRY_1">( ru_tend,  rv_tend,  rw_tend,  ph_tend,  t_tend,  &amp;<a name='1322'>
                          ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='1323'>
                          u_save, v_save, w_save, ph_save, t_save, rk_step,&amp;<a name='1324'>
                          h_diabatic, mut, msft, msfu, msfv,               &amp;<a name='1325'>
                          ids,ide, jds,jde, kds,kde,                       &amp;<a name='1326'>
                          ims,ime, jms,jme, kms,kme,                       &amp;<a name='1327'>
                          ips,ipe, jps,jpe, kps,kpe,                       &amp;<a name='1328'>
                          grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1329'>
                          grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1330'>
                          k_start, k_end                                  )<a name='1331'>
<a name='1332'>
     CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_ADDTEND_DRY'>rk_addtend_dry</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_ADDTEND_DRY_12">( ru_tend,  rv_tend,  rw_tend,  ph_tend,  t_tend,  &amp;<a name='1333'>
                          ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='1334'>
                          u_save, v_save, w_save, ph_save, t_save, rk_step,&amp;<a name='1335'>
                          h_diabatic, mut, msft, msfu, msfv,               &amp;<a name='1336'>
                          ids,ide, jds,jde, kds,kde,                       &amp;<a name='1337'>
                          ims,ime, jms,jme, kms,kme,                       &amp;<a name='1338'>
                          ips,ipe, jps,jpe, kps,kpe,                       &amp;<a name='1339'>
                          grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1340'>
                          grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1341'>
                          k_start, k_end                                  )<a name='1342'>
<a name='1343'>
     IF( config_flags%specified .or. config_flags%nested ) THEN <a name='1344'>
<a name='1345'>
       print*,' TEST_spec_bdy_dry = ',TEST_spec_bdy_dry<a name='1346'>
       if(TEST_spec_bdy_dry) &amp;<a name='1347'>
       CALL <A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_DRY'>t_spec_bdy_dry</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_SPEC_BDY_DRY_1"> ( config_flags,                                    &amp;<a name='1348'>
                           ru_tend, rv_tend, ph_tend, t_tend,               &amp;<a name='1349'>
                           rw_tend, mu_tend,                                &amp;<a name='1350'>
                           u_b, v_b, ph_b, t_b,                             &amp;<a name='1351'>
                           w_b, mu_b,                                       &amp;<a name='1352'>
                           u_bt, v_bt, ph_bt, t_bt,                         &amp;<a name='1353'>
                           w_bt, mu_bt,                                     &amp;<a name='1354'>
                           spec_bdy_width, spec_zone,                       &amp;<a name='1355'>
                           ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1356'></font>
                           ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1357'></font>
                           ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1358'></font>
                           ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1359'></font>
                           grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1360'>
                           grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1361'>
                           k_start, k_end                                  )<a name='1362'>
<a name='1363'>
       CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_DRY'>spec_bdy_dry</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_DRY_12"> ( config_flags,                                    &amp;<a name='1364'>
                           ru_tend, rv_tend, ph_tend, t_tend,               &amp;<a name='1365'>
                           rw_tend, mu_tend,                                &amp;<a name='1366'>
                           u_b, v_b, ph_b, t_b,                             &amp;<a name='1367'>
                           w_b, mu_b,                                       &amp;<a name='1368'>
                           u_bt, v_bt, ph_bt, t_bt,                         &amp;<a name='1369'>
                           w_bt, mu_bt,                                     &amp;<a name='1370'>
                           spec_bdy_width, spec_zone,                       &amp;<a name='1371'>
                           ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1372'></font>
                           ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1373'></font>
                           ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1374'></font>
                           ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1375'></font>
                           grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1376'>
                           grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1377'>
                           k_start, k_end                                  )<a name='1378'>
     <a name='1379'>
     ENDIF<a name='1380'>
<a name='1381'>
   END DO<a name='1382'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1383'></font>
BENCH_END(relax_bdy_dry_tim)<a name='1384'>
<a name='1385'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1386'></font>
<font color=#447700>!&lt;pre&gt;<a name='1387'></font>
<font color=#447700>! (3) Small (acoustic,sound) steps.<a name='1388'></font>
<font color=#447700>!<a name='1389'></font>
<font color=#447700>!    Several acoustic steps are taken each RK pass.  A small step <a name='1390'></font>
<font color=#447700>!    sequence begins with calculating perturbation variables <a name='1391'></font>
<font color=#447700>!    and coupling them to the column dry-air-mass mu <a name='1392'></font>
<font color=#447700>!    (call to small_step_prep).  This is followed by computing<a name='1393'></font>
<font color=#447700>!    coefficients for the vertically implicit part of the<a name='1394'></font>
<font color=#447700>!    small timestep (call to calc_coef_w).  <a name='1395'></font>
<font color=#447700>!<a name='1396'></font>
<font color=#447700>!    The small steps are taken<a name='1397'></font>
<font color=#447700>!    in the named loop "small_steps:".  In the small_steps loop, first <a name='1398'></font>
<font color=#447700>!    the horizontal momentum (u and v) are advanced (call to advance_uv),<a name='1399'></font>
<font color=#447700>!    next mu and theta are advanced (call to advance_mu_t) followed by<a name='1400'></font>
<font color=#447700>!    advancing w and the geopotential (call to advance_w).  Diagnostic<a name='1401'></font>
<font color=#447700>!    values for pressure and inverse density are updated at the end of<a name='1402'></font>
<font color=#447700>!    each small_step.<a name='1403'></font>
<font color=#447700>!<a name='1404'></font>
<font color=#447700>!    The small-step section ends with the change of the perturbation variables<a name='1405'></font>
<font color=#447700>!    back to full variables (call to small_step_finish).<a name='1406'></font>
<font color=#447700>!&lt;/pre&gt;<a name='1407'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1408'></font>
<a name='1409'>
BENCH_START(small_step_prep_tim)<a name='1410'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1411'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='1412'></font>
<a name='1413'>
   DO ij = 1 , grid%num_tiles<a name='1414'>
<a name='1415'>
    <font color=#447700>! Calculate coefficients for the vertically implicit acoustic/gravity wave<a name='1416'></font>
    <font color=#447700>! integration.  We only need calculate these for the first pass through -<a name='1417'></font>
    <font color=#447700>! the predictor step.  They are reused as is for the corrector step.<a name='1418'></font>
    <font color=#447700>! For third-order RK, we need to recompute these after the first <a name='1419'></font>
    <font color=#447700>! predictor because we may have changed the small timestep -&gt; dts.<a name='1420'></font>
<a name='1421'>
      CALL wrf_debug ( 200 , ' call calc_coef_w' )<a name='1422'>
      print*,' TEST_small_step_prep = ',TEST_small_step_prep<a name='1423'>
      if(TEST_small_step_prep) &amp;<a name='1424'>
      CALL <A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_PREP'>t_small_step_prep</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_SMALL_STEP_PREP_1">( u_1,u_2,v_1,v_2,w_1,w_2,          &amp;<a name='1425'>
                            t_1,t_2,ph_1,ph_2,                &amp;<a name='1426'>
                            mub, mu_1, mu_2,                  &amp;<a name='1427'>
                            muu, muus, muv, muvs,             &amp;<a name='1428'>
                            mut, muts, mudf,                  &amp; <a name='1429'>
                            u_save, v_save, w_save,           &amp; <a name='1430'>
                            t_save, ph_save, mu_save,         &amp;<a name='1431'>
                            ww, ww1,                          &amp;<a name='1432'>
                            dnw, c2a, pb, p, alt,             &amp;<a name='1433'>
                            msfu, msfv, msft,                 &amp;<a name='1434'>
                            rk_step, leapfrog,                &amp;<a name='1435'>
                            ids, ide, jds, jde, kds, kde,     &amp;<a name='1436'>
                            ims, ime, jms, jme, kms, kme,     &amp;<a name='1437'>
                            grid%i_start(ij), grid%i_end(ij), &amp;<a name='1438'>
                            grid%j_start(ij), grid%j_end(ij), &amp;<a name='1439'>
                            k_start    , k_end               )<a name='1440'>
<a name='1441'>
      CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_PREP'>small_step_prep</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMALL_STEP_PREP_12">( u_1,u_2,v_1,v_2,w_1,w_2,          &amp;<a name='1442'>
                            t_1,t_2,ph_1,ph_2,                &amp;<a name='1443'>
                            mub, mu_1, mu_2,                  &amp;<a name='1444'>
                            muu, muus, muv, muvs,             &amp;<a name='1445'>
                            mut, muts, mudf,                  &amp;<a name='1446'>
                            u_save, v_save, w_save,           &amp;<a name='1447'>
                            t_save, ph_save, mu_save,         &amp;<a name='1448'>
                            ww, ww1,                          &amp;<a name='1449'>
                            dnw, c2a, pb, p, alt,             &amp;<a name='1450'>
                            msfu, msfv, msft,                 &amp;<a name='1451'>
                            rk_step, leapfrog,                &amp;<a name='1452'>
                            ids, ide, jds, jde, kds, kde,     &amp;<a name='1453'>
                            ims, ime, jms, jme, kms, kme,     &amp;<a name='1454'>
                            grid%i_start(ij), grid%i_end(ij), &amp;<a name='1455'>
                            grid%j_start(ij), grid%j_end(ij), &amp;<a name='1456'>
                            k_start    , k_end               )<a name='1457'>
<a name='1458'>
<a name='1459'>
      print*,' TEST_calc_p_rho = ',TEST_calc_p_rho<a name='1460'>
      if(TEST_calc_p_rho) &amp;<a name='1461'>
      CALL <A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO'>t_calc_p_rho</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_CALC_P_RHO_1">( al, p, ph_2,                      &amp;<a name='1462'>
                       alt, t_2, t_save, c2a, pm1,       &amp;<a name='1463'>
                       mu_2, muts, znu, t0,              &amp;<a name='1464'>
                       rdnw, dnw, smdiv,                 &amp;<a name='1465'>
                       non_hydrostatic, 0,               &amp;<a name='1466'>
                       ids, ide, jds, jde, kds, kde,     &amp;<a name='1467'>
                       ims, ime, jms, jme, kms, kme,     &amp;<a name='1468'>
                       grid%i_start(ij), grid%i_end(ij), &amp;<a name='1469'>
                       grid%j_start(ij), grid%j_end(ij), &amp;<a name='1470'>
                       k_start    , k_end               )<a name='1471'>
<a name='1472'>
      CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_P_RHO'>calc_p_rho</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_20">( al, p, ph_2,                      &amp;<a name='1473'>
                       alt, t_2, t_save, c2a, pm1,       &amp;<a name='1474'>
                       mu_2, muts, znu, t0,              &amp;<a name='1475'>
                       rdnw, dnw, smdiv,                 &amp;<a name='1476'>
                       non_hydrostatic, 0,               &amp;<a name='1477'>
                       ids, ide, jds, jde, kds, kde,     &amp;<a name='1478'>
                       ims, ime, jms, jme, kms, kme,     &amp;<a name='1479'>
                       grid%i_start(ij), grid%i_end(ij), &amp;<a name='1480'>
                       grid%j_start(ij), grid%j_end(ij), &amp;<a name='1481'>
                       k_start    , k_end               )<a name='1482'>
<a name='1483'>
<a name='1484'>
      print*,'TEST_calc_coef_w = ',TEST_calc_coef_w<a name='1485'>
      if(non_hydrostatic .and. TEST_calc_coef_w) &amp;<a name='1486'>
      CALL <A href='../../html_code/dyn_em/module_check.F.html#T_CALC_COEF_W'>t_calc_coef_w</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_CALC_COEF_W_1">( a,alpha,gamma,                  &amp;<a name='1487'>
                        mut, cqw,                         &amp;<a name='1488'>
                        rdn, rdnw, c2a,                   &amp;<a name='1489'>
                        dts_rk, g, epssm,                 &amp;<a name='1490'>
                        ids, ide, jds, jde, kds, kde,     &amp;<a name='1491'>
                        ims, ime, jms, jme, kms, kme,     &amp;<a name='1492'>
                        grid%i_start(ij), grid%i_end(ij), &amp;<a name='1493'>
                       grid%j_start(ij), grid%j_end(ij), &amp;<a name='1494'>
                        k_start    , k_end               )<a name='1495'>
<a name='1496'>
      IF (non_hydrostatic)                                &amp;<a name='1497'>
      CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_COEF_W'>calc_coef_w</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_COEF_W_11">( a,alpha,gamma,                    &amp;<a name='1498'>
                        mut, cqw,                         &amp;<a name='1499'>
                        rdn, rdnw, c2a,                   &amp;<a name='1500'>
                        dts_rk, g, epssm,                 &amp;<a name='1501'>
                        ids, ide, jds, jde, kds, kde,     &amp;<a name='1502'>
                        ims, ime, jms, jme, kms, kme,     &amp;<a name='1503'>
                        grid%i_start(ij), grid%i_end(ij), &amp;<a name='1504'>
                        grid%j_start(ij), grid%j_end(ij), &amp;<a name='1505'>
                        k_start    , k_end               )<a name='1506'>
<a name='1507'>
<a name='1508'>
   ENDDO<a name='1509'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1510'></font>
BENCH_END(small_step_prep_tim)<a name='1511'>
<a name='1512'>
<a name='1513'>
#ifdef DM_PARALLEL<a name='1514'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1515'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='1516'></font>
<font color=#447700>!  Note:  the small size of this halo exchange reflects the <a name='1517'></font>
<font color=#447700>!         fact that we are carrying the uncoupled variables <a name='1518'></font>
<font color=#447700>!         as state variables in the mass coordinate model, as<a name='1519'></font>
<font color=#447700>!         opposed to the coupled variables as in the height<a name='1520'></font>
<font color=#447700>!         coordinate model.<a name='1521'></font>
<font color=#447700>!<a name='1522'></font>
<font color=#447700>!                              * * * * *<a name='1523'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='1524'></font>
<font color=#447700>!          * + *      * + *    * * + * * <a name='1525'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='1526'></font>
<font color=#447700>!                              * * * * *<a name='1527'></font>
<font color=#447700>!<a name='1528'></font>
<font color=#447700>!  3D variables - note staggering!  ph_2(Z), u_save(X), v_save(Y)<a name='1529'></font>
<font color=#447700>!<a name='1530'></font>
<font color=#447700>!j ph_2      x<a name='1531'></font>
<font color=#447700>!j al        x<a name='1532'></font>
<font color=#447700>!j p         x<a name='1533'></font>
<font color=#447700>!j t_1       x<a name='1534'></font>
<font color=#447700>!j t_save    x<a name='1535'></font>
<font color=#447700>!j u_save    x<a name='1536'></font>
<font color=#447700>!j v_save    x<a name='1537'></font>
<font color=#447700>!<a name='1538'></font>
<font color=#447700>!  the following are 2D (xy) variables<a name='1539'></font>
<font color=#447700>!<a name='1540'></font>
<font color=#447700>!j mu_1      x<a name='1541'></font>
<font color=#447700>!j mu_2      x<a name='1542'></font>
<font color=#447700>!j mudf      x<a name='1543'></font>
<font color=#447700>!--------------------------------------------------------------<a name='1544'></font>
#      include "<A href='../../html_code/include/HALO_EM_B.inc.html'>HALO_EM_B.inc</A>"<A NAME="HALO_EM_B.inc_24"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1545'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_B.inc.html'>PERIOD_BDY_EM_B.inc</A>"<A NAME="PERIOD_BDY_EM_B.inc_25"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1546'>
#endif<a name='1547'>
<a name='1548'>
BENCH_START(set_phys_bc2_tim)<a name='1549'>
   if(dyn_opt == DYN_EM) then<a name='1550'>
<font color=#447700>!   if(dyn_opt == DYN_EM_TST) then<a name='1551'></font>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1552'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='1553'></font>
<a name='1554'>
   DO ij = 1 , grid%num_tiles<a name='1555'>
<a name='1556'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_126">( ru_tend, 'u', config_flags,          &amp;<a name='1557'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1558'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1559'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1560'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1561'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1562'>
                           k_start    , k_end                     )<a name='1563'>
<a name='1564'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_127">( rv_tend, 'v', config_flags,            &amp;<a name='1565'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1566'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1567'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1568'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1569'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1570'>
                           k_start    , k_end                     )<a name='1571'>
<a name='1572'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_128">( ph_2, 'w', config_flags,          &amp;<a name='1573'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1574'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1575'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1576'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1577'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1578'>
                           k_start    , k_end                     )<a name='1579'>
<a name='1580'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_129">( al, 'p', config_flags,            &amp;<a name='1581'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1582'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1583'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1584'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1585'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1586'>
                           k_start    , k_end                     )<a name='1587'>
<a name='1588'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_130">( p, 'p', config_flags,             &amp;<a name='1589'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1590'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1591'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1592'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1593'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1594'>
                           k_start    , k_end                     )<a name='1595'>
<a name='1596'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_131">( t_1, 'p', config_flags,             &amp;<a name='1597'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1598'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1599'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1600'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1601'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1602'>
                           k_start    , k_end                     )<a name='1603'>
<a name='1604'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_132">( t_save, 't', config_flags,             &amp;<a name='1605'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1606'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1607'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1608'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1609'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1610'>
                           k_start    , k_end                     )<a name='1611'>
<a name='1612'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_22">( mu_1, 't', config_flags,          &amp;<a name='1613'>
                                 ids, ide, jds, jde,               &amp;<a name='1614'>
                                 ims, ime, jms, jme,               &amp;<a name='1615'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1616'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1617'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1618'>
<a name='1619'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_23">( mu_2, 't', config_flags,          &amp;<a name='1620'>
                                 ids, ide, jds, jde,               &amp;<a name='1621'>
                                 ims, ime, jms, jme,               &amp;<a name='1622'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1623'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1624'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1625'>
<a name='1626'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_24">( mudf, 't', config_flags,          &amp;<a name='1627'>
                                 ids, ide, jds, jde,               &amp;<a name='1628'>
                                 ims, ime, jms, jme,               &amp;<a name='1629'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1630'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1631'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1632'>
<a name='1633'>
    END DO<a name='1634'>
    <font color=#447700>!$OMP END PARALLEL DO<a name='1635'></font>
    endif<a name='1636'>
BENCH_END(set_phys_bc2_tim)<a name='1637'>
<a name='1638'>
   small_steps : DO iteration = 1 , number_of_small_timesteps<a name='1639'>
<a name='1640'>
   <font color=#447700>! Boundary condition time (or communication time).  <a name='1641'></font>
<a name='1642'>
#ifdef DM_PARALLEL<a name='1643'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_B.inc.html'>PERIOD_BDY_EM_B.inc</A>"<A NAME="PERIOD_BDY_EM_B.inc_26"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1644'>
#endif<a name='1645'>
<a name='1646'>
<a name='1647'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1648'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='1649'></font>
<a name='1650'>
      DO ij = 1 , grid%num_tiles<a name='1651'>
<a name='1652'>
BENCH_START(advance_uv_tim)<a name='1653'>
<a name='1654'>
         print*,'TEST_advance_uv = ',TEST_advance_uv<a name='1655'>
         if(TEST_advance_uv) &amp;<a name='1656'>
         CALL <A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_UV'>t_advance_uv</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_ADVANCE_UV_1"> ( u_2, ru_tend, v_2, rv_tend,       &amp;<a name='1657'>
                           p, pb,                            &amp;<a name='1658'>
                           ph_2, php, alt, al, mu_2,         &amp;<a name='1659'>
                           muu, cqu, muv, cqv, mudf,         &amp;<a name='1660'>
                           rdx, rdy, dts_rk,                 &amp;<a name='1661'>
                           cf1, cf2, cf3, fnm, fnp,          &amp;<a name='1662'>
                           emdiv,                            &amp;<a name='1663'>
                           rdnw, config_flags,spec_zone,     &amp;<a name='1664'>
                           non_hydrostatic,                  &amp;<a name='1665'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='1666'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='1667'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='1668'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='1669'>
                           k_start    , k_end               )<a name='1670'>
<a name='1671'>
         CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_UV'>advance_uv</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_UV_12"> ( u_2, ru_tend, v_2, rv_tend,       &amp;<a name='1672'>
                           p, pb,                            &amp;<a name='1673'>
                           ph_2, php, alt, al, mu_2,         &amp;<a name='1674'>
                           muu, cqu, muv, cqv, mudf,         &amp;<a name='1675'>
                           rdx, rdy, dts_rk,                 &amp;<a name='1676'>
                           cf1, cf2, cf3, fnm, fnp,          &amp;<a name='1677'>
                           emdiv,                            &amp;<a name='1678'>
                           rdnw, config_flags,spec_zone,     &amp;<a name='1679'>
                           non_hydrostatic,                  &amp;<a name='1680'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='1681'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='1682'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='1683'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='1684'>
                           k_start    , k_end               )<a name='1685'>
BENCH_END(advance_uv_tim)<a name='1686'>
<a name='1687'>
BENCH_START(spec_bdy_uv_tim)<a name='1688'>
         IF( config_flags%specified .or. config_flags%nested ) THEN<a name='1689'>
<a name='1690'>
           print*,'TEST_spec_bdyupdate = ',TEST_spec_bdyupdate<a name='1691'>
           if(TEST_spec_bdyupdate) &amp;<a name='1692'>
           CALL <A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE'>t_spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_SPEC_BDYUPDATE_1">(u_2, ru_tend, dts_rk,      &amp;<a name='1693'>
                               'u'         , config_flags, &amp;<a name='1694'>
                               spec_zone,                  &amp;<a name='1695'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1696'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1697'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1698'></font>
                               grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1699'>
                               grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1700'>
                               k_start    , k_end             )<a name='1701'>
<a name='1702'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_57">(u_2, ru_tend, dts_rk,      &amp;<a name='1703'>
                               'u'         , config_flags, &amp;<a name='1704'>
                               spec_zone,                  &amp;<a name='1705'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1706'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1707'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1708'></font>
                               grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1709'>
                               grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1710'>
                               k_start    , k_end             )<a name='1711'>
<a name='1712'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_58">(v_2, rv_tend, dts_rk,      &amp;<a name='1713'>
                               'v'         , config_flags, &amp;<a name='1714'>
                               spec_zone,                  &amp;<a name='1715'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1716'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1717'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1718'></font>
                               grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1719'>
                               grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1720'>
                               k_start    , k_end             )<a name='1721'>
<a name='1722'>
         ENDIF<a name='1723'>
BENCH_END(spec_bdy_uv_tim)<a name='1724'>
<a name='1725'>
      END DO<a name='1726'>
      <font color=#447700>!$OMP END PARALLEL DO<a name='1727'></font>
<a name='1728'>
#ifdef DM_PARALLEL<a name='1729'>
<font color=#447700>!<a name='1730'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='1731'></font>
<font color=#447700>!<a name='1732'></font>
<font color=#447700>!         *                     *<a name='1733'></font>
<font color=#447700>!       * + *      * + *        +<a name='1734'></font>
<font color=#447700>!         *                     *<a name='1735'></font>
<font color=#447700>!<a name='1736'></font>
<font color=#447700>!  u_2               x<a name='1737'></font>
<font color=#447700>!  v_2                          x<a name='1738'></font>
<font color=#447700>!<a name='1739'></font>
#     include "<A href='../../html_code/include/HALO_EM_C.inc.html'>HALO_EM_C.inc</A>"<A NAME="HALO_EM_C.inc_27"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1740'>
#endif<a name='1741'>
<a name='1742'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1743'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='1744'></font>
<a name='1745'>
      DO ij = 1 , grid%num_tiles<a name='1746'>
<a name='1747'>
        <font color=#447700>!  advance the mass in the column, theta, and calculate ww<a name='1748'></font>
<a name='1749'>
BENCH_START(advance_mu_t_tim)<a name='1750'>
<a name='1751'>
        print*,'TEST_advance_mu_t = ',TEST_advance_mu_t<a name='1752'>
        if(TEST_advance_mu_t) &amp;<a name='1753'>
        CALL <A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_MU_T'>t_advance_mu_t</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_ADVANCE_MU_T_1">( ww, ww1, u_2, u_save, v_2, v_save, &amp;<a name='1754'>
                           mu_2, mut, muave, muts, muu, muv,  &amp;<a name='1755'>
                           mudf, ru_m, rv_m, ww_m,            &amp;<a name='1756'>
                           t_2, t_save, t_2save, t_tend,      &amp;<a name='1757'>
                           mu_tend,                           &amp;<a name='1758'>
                           rdx, rdy, dts_rk, epssm,           &amp;<a name='1759'>
                           dnw, fnm, fnp, rdnw,               &amp;<a name='1760'>
                           msfu, msfv, msft,                  &amp;<a name='1761'>
                           iteration, config_flags,           &amp;<a name='1762'>
                           ids, ide, jds, jde, kds, kde,      &amp;<a name='1763'>
                           ims, ime, jms, jme, kms, kme,      &amp;<a name='1764'>
                           grid%i_start(ij), grid%i_end(ij),  &amp;<a name='1765'>
                           grid%j_start(ij), grid%j_end(ij),  &amp;<a name='1766'>
                           k_start    , k_end                )<a name='1767'>
<a name='1768'>
        CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_MU_T'>advance_mu_t</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_MU_T_12">( ww, ww1, u_2, u_save, v_2, v_save, &amp;<a name='1769'>
                           mu_2, mut, muave, muts, muu, muv,  &amp;<a name='1770'>
                           mudf, ru_m, rv_m, ww_m,            &amp;<a name='1771'>
                           t_2, t_save, t_2save, t_tend,      &amp;<a name='1772'>
                           mu_tend,                           &amp;<a name='1773'>
                           rdx, rdy, dts_rk, epssm,           &amp;<a name='1774'>
                           dnw, fnm, fnp, rdnw,               &amp;<a name='1775'>
                           msfu, msfv, msft,                  &amp;<a name='1776'>
                           iteration, config_flags,           &amp;<a name='1777'>
                           ids, ide, jds, jde, kds, kde,      &amp;<a name='1778'>
                           ims, ime, jms, jme, kms, kme,      &amp;<a name='1779'>
                           grid%i_start(ij), grid%i_end(ij),  &amp;<a name='1780'>
                           grid%j_start(ij), grid%j_end(ij),  &amp;<a name='1781'>
                           k_start    , k_end                )<a name='1782'>
BENCH_END(advance_mu_t_tim)<a name='1783'>
<a name='1784'>
BENCH_START(spec_bdy_t_tim)<a name='1785'>
         IF( config_flags%specified .or. config_flags%nested ) THEN<a name='1786'>
<a name='1787'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_59">(t_2, t_tend, dts_rk,      &amp;<a name='1788'>
                               't'         , config_flags, &amp;<a name='1789'>
                               spec_zone,                  &amp;<a name='1790'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1791'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1792'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1793'></font>
                               grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1794'>
                               grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1795'>
                               k_start    , k_end             )<a name='1796'>
<a name='1797'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_60">(mu_2, mu_tend, dts_rk,      &amp;<a name='1798'>
                               'm'         , config_flags, &amp;<a name='1799'>
                               spec_zone,                  &amp;<a name='1800'>
                               ids,ide, jds,jde, 1  ,1  ,  &amp; <font color=#447700>! domain dims<a name='1801'></font>
                               ims,ime, jms,jme, 1  ,1  ,  &amp; <font color=#447700>! memory dims<a name='1802'></font>
                               ips,ipe, jps,jpe, 1  ,1  ,  &amp; <font color=#447700>! patch  dims<a name='1803'></font>
                               grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1804'>
                               grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1805'>
                               1    , 1             )<a name='1806'>
<a name='1807'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_61">(muts, mu_tend, dts_rk,      &amp;<a name='1808'>
                               'm'         , config_flags, &amp;<a name='1809'>
                               spec_zone,                  &amp;<a name='1810'>
                               ids,ide, jds,jde, 1  ,1  ,  &amp; <font color=#447700>! domain dims<a name='1811'></font>
                               ims,ime, jms,jme, 1  ,1  ,  &amp; <font color=#447700>! memory dims<a name='1812'></font>
                               ips,ipe, jps,jpe, 1  ,1  ,  &amp; <font color=#447700>! patch  dims<a name='1813'></font>
                               grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1814'>
                               grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1815'>
                               1    , 1             )<a name='1816'>
         ENDIF<a name='1817'>
BENCH_END(spec_bdy_t_tim)<a name='1818'>
<a name='1819'>
         <font color=#447700>! sumflux accumulates the time-averged mass flux<a name='1820'></font>
         <font color=#447700>! (time averaged over the acoustic steps) for use<a name='1821'></font>
         <font color=#447700>! in the scalar advection (flux divergence).  Using<a name='1822'></font>
         <font color=#447700>! time averaged values gives us exact scalar conservation.<a name='1823'></font>
<a name='1824'>
BENCH_START(sumflux_tim)<a name='1825'>
<a name='1826'>
         print*,'TEST_sumflux = ',TEST_sumflux<a name='1827'>
         if(TEST_sumflux) &amp;<a name='1828'>
         CALL <A href='../../html_code/dyn_em/module_check.F.html#T_SUMFLUX'>t_sumflux</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_SUMFLUX_1"> ( u_2, v_2, ww,                         &amp;<a name='1829'>
                        u_save, v_save, ww1,                  &amp;<a name='1830'>
                        muu, muv,                             &amp;<a name='1831'>
                        ru_m, rv_m, ww_m, epssm,              &amp;<a name='1832'>
                        msfu, msfv,                           &amp;<a name='1833'>
                        iteration, number_of_small_timesteps, &amp;<a name='1834'>
                        ids, ide, jds, jde, kds, kde,         &amp;<a name='1835'>
                        ims, ime, jms, jme, kms, kme,         &amp;<a name='1836'>
                        grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1837'>
                        grid%j_start(ij), grid%j_end(ij),     &amp;<a name='1838'>
                        k_start    , k_end                   )<a name='1839'>
<a name='1840'>
         CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SUMFLUX'>sumflux</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUMFLUX_12"> ( u_2, v_2, ww,                         &amp;<a name='1841'>
                        u_save, v_save, ww1,                  &amp;<a name='1842'>
                        muu, muv,                             &amp;<a name='1843'>
                        ru_m, rv_m, ww_m, epssm,              &amp;<a name='1844'>
                        msfu, msfv,                           &amp;<a name='1845'>
                        iteration, number_of_small_timesteps, &amp;<a name='1846'>
                        ids, ide, jds, jde, kds, kde,         &amp;<a name='1847'>
                        ims, ime, jms, jme, kms, kme,         &amp;<a name='1848'>
                        grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1849'>
                        grid%j_start(ij), grid%j_end(ij),     &amp;<a name='1850'>
                        k_start    , k_end                   )<a name='1851'>
BENCH_END(sumflux_tim)<a name='1852'>
<a name='1853'>
         <font color=#447700>! small (acoustic) step for the vertical momentum,<a name='1854'></font>
         <font color=#447700>! density and coupled potential temperature.<a name='1855'></font>
<a name='1856'>
<a name='1857'>
BENCH_START(advance_w_tim)<a name='1858'>
        IF ( non_hydrostatic ) THEN<a name='1859'>
<a name='1860'>
          print*,'TEST_advance_w = ',TEST_advance_w<a name='1861'>
          if(TEST_advance_w) &amp;<a name='1862'>
          CALL <A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_W'>t_advance_w</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_ADVANCE_W_1">( w_2, rw_tend, ww, u_2, v_2,       &amp;<a name='1863'>
                          mu_2, mut, muave, muts,           &amp;<a name='1864'>
                          t_2save, t_2, t_save,             &amp;<a name='1865'>
                          ph_2, ph_save, phb, ph_tend,      &amp;<a name='1866'>
                          ht, c2a, cqw, alt, alb,           &amp;<a name='1867'>
                          a, alpha, gamma,                  &amp;<a name='1868'>
                          rdx, rdy, dts_rk, t0, epssm,      &amp;<a name='1869'>
                          dnw, fnm, fnp, rdnw, rdn,         &amp;<a name='1870'>
                          cf1, cf2, cf3, msft,              &amp;<a name='1871'>
                          config_flags,                     &amp;<a name='1872'>
                          ids,ide, jds,jde, kds,kde,        &amp; <font color=#447700>! domain dims<a name='1873'></font>
                          ims,ime, jms,jme, kms,kme,        &amp; <font color=#447700>! memory dims<a name='1874'></font>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='1875'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='1876'>
                          k_start    , k_end               )<a name='1877'>
<a name='1878'>
          CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_W'>advance_w</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_W_12">( w_2, rw_tend, ww, u_2, v_2,       &amp;<a name='1879'>
                          mu_2, mut, muave, muts,           &amp;<a name='1880'>
                          t_2save, t_2, t_save,             &amp;<a name='1881'>
                          ph_2, ph_save, phb, ph_tend,      &amp;<a name='1882'>
                          ht, c2a, cqw, alt, alb,           &amp;<a name='1883'>
                          a, alpha, gamma,                  &amp;<a name='1884'>
                          rdx, rdy, dts_rk, t0, epssm,      &amp;<a name='1885'>
                          dnw, fnm, fnp, rdnw, rdn,         &amp;<a name='1886'>
                          cf1, cf2, cf3, msft,              &amp;<a name='1887'>
                          config_flags,                     &amp;<a name='1888'>
                          ids,ide, jds,jde, kds,kde,        &amp; <font color=#447700>! domain dims<a name='1889'></font>
                          ims,ime, jms,jme, kms,kme,        &amp; <font color=#447700>! memory dims<a name='1890'></font>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='1891'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='1892'>
                          k_start    , k_end               )<a name='1893'>
        ENDIF<a name='1894'>
BENCH_END(advance_w_tim)<a name='1895'>
<a name='1896'>
        IF( config_flags%specified .or. config_flags%nested ) THEN<a name='1897'>
<a name='1898'>
BENCH_START(spec_bdynhyd_tim)<a name='1899'>
           IF (non_hydrostatic)  THEN<a name='1900'>
<a name='1901'>
             print*,'TEST_spec_bdyupdate_ph = ',TEST_spec_bdyupdate_ph<a name='1902'>
             if(TEST_spec_bdyupdate_ph) &amp;<a name='1903'>
             CALL <A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE_PH'>t_spec_bdyupdate_ph</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_SPEC_BDYUPDATE_PH_1">( ph_save, ph_2, ph_tend, mu_tend, muts, dts_rk, &amp;<a name='1904'>
                                     'h'         , config_flags, &amp;<a name='1905'>
                                     spec_zone,                  &amp;<a name='1906'>
                                     ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1907'></font>
                                     ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1908'></font>
                                     ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1909'></font>
                                     grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1910'>
                                     grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1911'>
                                     k_start    , k_end             )<a name='1912'>
<a name='1913'>
<a name='1914'>
             CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDYUPDATE_PH'>spec_bdyupdate_ph</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_PH_12">( ph_save, ph_2, ph_tend, mu_tend, muts, dts_rk, &amp;<a name='1915'>
                                     'h'         , config_flags, &amp;<a name='1916'>
                                     spec_zone,                  &amp;<a name='1917'>
                                     ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1918'></font>
                                     ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1919'></font>
                                     ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1920'></font>
                                     grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1921'>
                                     grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1922'>
                                     k_start    , k_end             )<a name='1923'>
             IF( config_flags%specified ) THEN<a name='1924'>
               if(dyn_opt == DYN_EM) then<a name='1925'>
<font color=#447700>!               if(dyn_opt == DYN_EM_TST) then<a name='1926'></font>
               CALL <A href='../../html_code/share/module_bc.F.html#ZERO_GRAD_BDY'>zero_grad_bdy</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_GRAD_BDY_10"> ( w_2,                        &amp;<a name='1927'>
                                    'w'         , config_flags, &amp;<a name='1928'>
                                    spec_zone,                  &amp;<a name='1929'>
                                    ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1930'></font>
                                    ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1931'></font>
                                    ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1932'></font>
                                    grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1933'>
                                    grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1934'>
                                    k_start    , k_end             )<a name='1935'>
               endif<a name='1936'>
             ELSE<a name='1937'>
               CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_62">   ( w_2, rw_tend, dts_rk,       &amp;<a name='1938'>
                                       'h'         , config_flags, &amp;<a name='1939'>
                                       spec_zone,                  &amp;<a name='1940'>
                                       ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1941'></font>
                                       ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1942'></font>
                                       ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1943'></font>
                                       grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1944'>
                                       grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1945'>
                                       k_start    , k_end             )<a name='1946'>
             ENDIF<a name='1947'>
          ENDIF<a name='1948'>
BENCH_END(spec_bdynhyd_tim)<a name='1949'>
        ENDIF<a name='1950'>
<a name='1951'>
BENCH_START(cald_p_rho_tim)<a name='1952'>
        CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_P_RHO'>calc_p_rho</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_21">( al, p, ph_2,                      &amp;<a name='1953'>
                         alt, t_2, t_save, c2a, pm1,       &amp;<a name='1954'>
                         mu_2, muts, znu, t0,              &amp;<a name='1955'>
                         rdnw, dnw, smdiv,                 &amp;<a name='1956'>
                         non_hydrostatic, iteration,       &amp;<a name='1957'>
                         ids, ide, jds, jde, kds, kde,     &amp;<a name='1958'>
                         ims, ime, jms, jme, kms, kme,     &amp;<a name='1959'>
                         grid%i_start(ij), grid%i_end(ij), &amp;<a name='1960'>
                         grid%j_start(ij), grid%j_end(ij), &amp;<a name='1961'>
                         k_start    , k_end               )<a name='1962'>
BENCH_END(cald_p_rho_tim)<a name='1963'>
<a name='1964'>
   ENDDO<a name='1965'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1966'></font>
<a name='1967'>
#ifdef DM_PARALLEL<a name='1968'>
<font color=#447700>!<a name='1969'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='1970'></font>
<font color=#447700>!<a name='1971'></font>
<font color=#447700>!         *                     *<a name='1972'></font>
<font color=#447700>!       * + *      * + *        +<a name='1973'></font>
<font color=#447700>!         *                     *<a name='1974'></font>
<font color=#447700>!<a name='1975'></font>
<font color=#447700>!  ph_2   x<a name='1976'></font>
<font color=#447700>!  al     x<a name='1977'></font>
<font color=#447700>!  p      x<a name='1978'></font>
<font color=#447700>!<a name='1979'></font>
<font color=#447700>!  2D variables (x,y)<a name='1980'></font>
<font color=#447700>!<a name='1981'></font>
<font color=#447700>!  mu_2   x<a name='1982'></font>
<font color=#447700>!  muts   x<a name='1983'></font>
<font color=#447700>!  mudf   x<a name='1984'></font>
<a name='1985'>
#      include "<A href='../../html_code/include/HALO_EM_C2.inc.html'>HALO_EM_C2.inc</A>"<A NAME="HALO_EM_C2.inc_28"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1986'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_B3.inc.html'>PERIOD_BDY_EM_B3.inc</A>"<A NAME="PERIOD_BDY_EM_B3.inc_29"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1987'>
#endif<a name='1988'>
<a name='1989'>
BENCH_START(phys_bc_tim)<a name='1990'>
      if(dyn_opt == DYN_EM) then<a name='1991'>
<font color=#447700>!      if(dyn_opt == DYN_EM_TST) then<a name='1992'></font>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1993'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='1994'></font>
<a name='1995'>
      DO ij = 1 , grid%num_tiles<a name='1996'>
<a name='1997'>
        <font color=#447700>! boundary condition set for next small timestep<a name='1998'></font>
<a name='1999'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_133">( ph_2, 'w', config_flags,          &amp;<a name='2000'>
                                 ids, ide, jds, jde, kds, kde,     &amp;<a name='2001'>
                                 ims, ime, jms, jme, kms, kme,     &amp;<a name='2002'>
                                 ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='2003'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='2004'>
                                 grid%j_start(ij), grid%j_end(ij), &amp;<a name='2005'>
                                 k_start    , k_end               )<a name='2006'>
<a name='2007'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_134">( al, 'p', config_flags,            &amp;<a name='2008'>
                                 ids, ide, jds, jde, kds, kde,     &amp;<a name='2009'>
                                 ims, ime, jms, jme, kms, kme,     &amp;<a name='2010'>
                                 ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='2011'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='2012'>
                                 grid%j_start(ij), grid%j_end(ij), &amp;<a name='2013'>
                                 k_start    , k_end               )<a name='2014'>
<a name='2015'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_135">( p, 'p', config_flags,             &amp;<a name='2016'>
                                 ids, ide, jds, jde, kds, kde,     &amp;<a name='2017'>
                                 ims, ime, jms, jme, kms, kme,     &amp;<a name='2018'>
                                 ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='2019'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='2020'>
                                 grid%j_start(ij), grid%j_end(ij), &amp;<a name='2021'>
                                 k_start    , k_end               )<a name='2022'>
<a name='2023'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_25">( muts, 't', config_flags,          &amp;<a name='2024'>
                                 ids, ide, jds, jde,               &amp;<a name='2025'>
                                 ims, ime, jms, jme,               &amp;<a name='2026'>
                                 ips, ipe, jps, jpe,               &amp;<a name='2027'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='2028'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='2029'>
<a name='2030'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_26">( mu_2, 't', config_flags,          &amp;<a name='2031'>
                                 ids, ide, jds, jde,               &amp;<a name='2032'>
                                 ims, ime, jms, jme,               &amp;<a name='2033'>
                                 ips, ipe, jps, jpe,               &amp;<a name='2034'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='2035'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='2036'>
<a name='2037'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_27">( mudf, 't', config_flags,          &amp;<a name='2038'>
                                 ids, ide, jds, jde,               &amp;<a name='2039'>
                                 ims, ime, jms, jme,               &amp;<a name='2040'>
                                 ips, ipe, jps, jpe,               &amp;<a name='2041'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='2042'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='2043'>
<a name='2044'>
      END DO<a name='2045'>
      <font color=#447700>!$OMP END PARALLEL DO<a name='2046'></font>
      endif<a name='2047'>
BENCH_END(phys_bc_tim)<a name='2048'>
<a name='2049'>
   END DO small_steps<a name='2050'>
<a name='2051'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2052'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2053'></font>
<a name='2054'>
   DO ij = 1 , grid%num_tiles<a name='2055'>
<a name='2056'>
      CALL wrf_debug ( 200 , ' call rk_small_finish' )<a name='2057'>
<a name='2058'>
      <font color=#447700>! change time-perturbation variables back to <a name='2059'></font>
      <font color=#447700>! full perturbation variables.<a name='2060'></font>
      <font color=#447700>! first get updated mu at u and v points<a name='2061'></font>
<a name='2062'>
BENCH_START(calc_mu_uv_tim)<a name='2063'>
<a name='2064'>
      print*,'TEST_calc_mu_uv_1 = ',TEST_calc_mu_uv_1<a name='2065'>
      if(TEST_calc_mu_uv_1) &amp;<a name='2066'>
      CALL <A href='../../html_code/dyn_em/module_check.F.html#T_CALC_MU_UV_1'>t_calc_mu_uv_1</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_CALC_MU_UV_1_1"> ( config_flags,                     &amp;<a name='2067'>
                          muts, muus, muvs,                 &amp;<a name='2068'>
                          ids, ide, jds, jde, kds, kde,     &amp;<a name='2069'>
                          ims, ime, jms, jme, kms, kme,     &amp;<a name='2070'>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='2071'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='2072'>
                          k_start    , k_end               )<a name='2073'>
<a name='2074'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_UV_1'>calc_mu_uv_1</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_MU_UV_1_10"> ( config_flags,                     &amp;<a name='2075'>
                          muts, muus, muvs,                 &amp;<a name='2076'>
                          ids, ide, jds, jde, kds, kde,     &amp;<a name='2077'>
                          ims, ime, jms, jme, kms, kme,     &amp;<a name='2078'>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='2079'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='2080'>
                          k_start    , k_end               )<a name='2081'>
BENCH_END(calc_mu_uv_tim)<a name='2082'>
BENCH_START(small_step_finish_tim)<a name='2083'>
<a name='2084'>
<a name='2085'>
      print*,'TEST_small_step_finish = ',TEST_small_step_finish<a name='2086'>
      if(TEST_small_step_finish) &amp;<a name='2087'>
      CALL <A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_FINISH'>t_small_step_finish</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_SMALL_STEP_FINISH_1">( u_2, u_1, v_2, v_1, w_2, w_1,     &amp;<a name='2088'>
                              t_2, t_1, ph_2, ph_1, ww, ww1,    &amp;<a name='2089'>
                              mu_2, mu_1,                       &amp;<a name='2090'>
                              mut, muts, muu, muus, muv, muvs,  &amp;<a name='2091'>
                              u_save, v_save, w_save,           &amp;<a name='2092'>
                              t_save, ph_save, mu_save,         &amp;<a name='2093'>
                              msfu, msfv, msft,                 &amp;<a name='2094'>
                              h_diabatic,                       &amp;<a name='2095'>
                              number_of_small_timesteps,dts_rk, &amp;<a name='2096'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='2097'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='2098'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='2099'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='2100'>
                              k_start    , k_end               )<a name='2101'>
<a name='2102'>
      CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_FINISH'>small_step_finish</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMALL_STEP_FINISH_9">( u_2, u_1, v_2, v_1, w_2, w_1,     &amp;<a name='2103'>
                              t_2, t_1, ph_2, ph_1, ww, ww1,    &amp;<a name='2104'>
                              mu_2, mu_1,                       &amp;<a name='2105'>
                              mut, muts, muu, muus, muv, muvs,  &amp; <a name='2106'>
                              u_save, v_save, w_save,           &amp;<a name='2107'>
                              t_save, ph_save, mu_save,         &amp;<a name='2108'>
                              msfu, msfv, msft,                 &amp;<a name='2109'>
                              h_diabatic,                       &amp;<a name='2110'>
                              number_of_small_timesteps,dts_rk, &amp;<a name='2111'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='2112'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='2113'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='2114'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='2115'>
                              k_start    , k_end               )<a name='2116'>
BENCH_END(small_step_finish_tim)<a name='2117'>
<a name='2118'>
   END DO<a name='2119'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2120'></font>
<a name='2121'>
#ifdef DM_PARALLEL<a name='2122'>
<font color=#447700>!<a name='2123'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='2124'></font>
<font color=#447700>!<a name='2125'></font>
<font color=#447700>!<a name='2126'></font>
<font color=#447700>! ru_m      x<a name='2127'></font>
<font color=#447700>! rv_m      x<a name='2128'></font>
<font color=#447700>!<a name='2129'></font>
<font color=#447700>!--------------------------------------------------------------<a name='2130'></font>
<a name='2131'>
#  include "<A href='../../html_code/include/HALO_EM_D.inc.html'>HALO_EM_D.inc</A>"<A NAME="HALO_EM_D.inc_30"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2132'>
#endif<a name='2133'>
<a name='2134'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2135'></font>
<font color=#447700>!&lt;pre&gt;<a name='2136'></font>
<font color=#447700>! (4) Still within the RK loop, the scalar variables are advanced.<a name='2137'></font>
<font color=#447700>!<a name='2138'></font>
<font color=#447700>!    For the moist and chem variables, each one is advanced<a name='2139'></font>
<font color=#447700>!    individually, using named loops "moist_variable_loop:"<a name='2140'></font>
<font color=#447700>!    and "chem_variable_loop:".  Each RK substep begins by<a name='2141'></font>
<font color=#447700>!    calculating the advective tendency, and, for the first RK step, <a name='2142'></font>
<font color=#447700>!    3D mixing (calling rk_scalar_tend) followed by an update<a name='2143'></font>
<font color=#447700>!    of the scalar (calling rk_scalar_update).<a name='2144'></font>
<font color=#447700>!&lt;/pre&gt;<a name='2145'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2146'></font>
<a name='2147'>
<a name='2148'>
  moist_scalar_advance: IF (num_3d_m &gt;= PARAM_FIRST_SCALAR )  THEN<a name='2149'>
<a name='2150'>
   moist_variable_loop: do im = PARAM_FIRST_SCALAR, num_3d_m<a name='2151'>
<a name='2152'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2153'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2154'></font>
<a name='2155'>
   moist_tile_loop_1: DO ij = 1 , grid%num_tiles<a name='2156'>
<a name='2157'>
       CALL wrf_debug ( 200 , ' call rk_scalar_tend' )<a name='2158'>
<a name='2159'>
BENCH_START(rk_scalar_tend_tim)<a name='2160'>
<a name='2161'>
       print*,'TEST_rk_scalar_tend = ',TEST_rk_scalar_tend<a name='2162'>
       if(TEST_rk_scalar_tend) &amp;<a name='2163'>
       CALL <A href='../../html_code/dyn_em/module_check.F.html#T_RK_SCALAR_TEND'>t_rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_RK_SCALAR_TEND_1"> (  im, im, config_flags,             &amp;<a name='2164'>
                              rk_step, dt_rk,                   &amp;<a name='2165'>
                              ru_m, rv_m, ww_m,                 &amp;<a name='2166'>
                              mut, alt,                         &amp;<a name='2167'>
                              moist_1(ims,kms,jms,im),          &amp;<a name='2168'>
                              moist_2(ims,kms,jms,im),          &amp;<a name='2169'>
                              moist_tend(ims,kms,jms,im),       &amp;<a name='2170'>
                              advect_tend,RQVFTEN,              &amp;<a name='2171'>
                              qv_base, .true., fnm, fnp,        &amp;<a name='2172'>
                              msfu, msfv, msft,                 &amp;<a name='2173'>
                              rdx, rdy, rdn, rdnw, khdif,       &amp;<a name='2174'>
                              kvdif, xkmhd,                     &amp;<a name='2175'>
                              leapfrog,                         &amp;<a name='2176'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='2177'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='2178'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='2179'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='2180'>
                              k_start    , k_end               )<a name='2181'>
<a name='2182'>
       CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_14"> (  im, im, config_flags,             &amp;<a name='2183'>
                              rk_step, dt_rk,                   &amp;<a name='2184'>
                              ru_m, rv_m, ww_m,                 &amp;<a name='2185'>
                              mut, alt,                         &amp;<a name='2186'>
                              moist_1(ims,kms,jms,im),          &amp;<a name='2187'>
                              moist_2(ims,kms,jms,im),          &amp;<a name='2188'>
                              moist_tend(ims,kms,jms,im),       &amp;<a name='2189'>
                              advect_tend,RQVFTEN,              &amp;<a name='2190'>
                              qv_base, .true., fnm, fnp,        &amp;<a name='2191'>
                              msfu, msfv, msft,                 &amp;<a name='2192'>
                              rdx, rdy, rdn, rdnw, khdif,       &amp;<a name='2193'>
                              kvdif, xkmhd,                     &amp;<a name='2194'>
                              leapfrog,                         &amp;<a name='2195'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='2196'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='2197'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='2198'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='2199'>
                              k_start    , k_end               )<a name='2200'>
BENCH_END(rk_scalar_tend_tim)<a name='2201'>
<a name='2202'>
BENCH_START(rlx_bdy_scalar_tim)<a name='2203'>
     IF( (config_flags%specified .or. config_flags%nested) .and. rk_step == 1 ) THEN <a name='2204'>
<a name='2205'>
       IF(im .eq. P_QV)THEN<a name='2206'>
<a name='2207'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_13"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='2208'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='2209'>
                                 rqv_b, rqv_bt,                         &amp;<a name='2210'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='2211'>
                                 dtbc, fcx, gcx,             &amp;<a name='2212'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2213'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2214'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2215'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2216'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='2217'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='2218'>
                                 k_start, k_end                        )<a name='2219'>
<a name='2220'>
         print*,' TEST_spec_bdy_scalar =',TEST_spec_bdy_scalar<a name='2221'>
         if(TEST_spec_bdy_scalar) &amp;<a name='2222'>
         CALL <A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_SCALAR'>t_spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_SPEC_BDY_SCALAR_1">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='2223'>
                                 rqv_b, rqv_bt,                             &amp;<a name='2224'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='2225'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2226'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2227'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2228'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2229'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='2230'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='2231'>
                                 k_start, k_end                               )<a name='2232'>
<a name='2233'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_45">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='2234'>
                                 rqv_b, rqv_bt,                             &amp;<a name='2235'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='2236'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2237'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2238'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2239'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2240'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='2241'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='2242'>
                                 k_start, k_end                               )<a name='2243'>
       ENDIF<a name='2244'>
<a name='2245'>
     ENDIF<a name='2246'>
<a name='2247'>
<font color=#447700>!  ugly code for nested b.c for moist scalars other than qv<a name='2248'></font>
<a name='2249'>
     IF( config_flags%nested .and. (rk_step == 1) ) THEN <a name='2250'>
<a name='2251'>
       IF (im .eq. P_QC) THEN<a name='2252'>
<a name='2253'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_14"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='2254'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='2255'>
                                 rqc_b, rqc_bt,                         &amp;<a name='2256'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='2257'>
                                 dtbc, fcx, gcx,             &amp;<a name='2258'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2259'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2260'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2261'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2262'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='2263'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='2264'>
                                 k_start, k_end                        )<a name='2265'>
<a name='2266'>
<a name='2267'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_46">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='2268'>
                                 rqc_b, rqc_bt,                             &amp;<a name='2269'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='2270'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2271'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2272'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2273'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2274'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='2275'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='2276'>
                                 k_start, k_end                               )<a name='2277'>
<a name='2278'>
       ELSE IF (im .eq. P_QR) THEN<a name='2279'>
<a name='2280'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_15"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='2281'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='2282'>
                                 rqr_b, rqr_bt,                         &amp;<a name='2283'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='2284'>
                                 dtbc, fcx, gcx,             &amp;<a name='2285'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2286'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2287'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2288'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2289'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='2290'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='2291'>
                                 k_start, k_end                        )<a name='2292'>
<a name='2293'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_47">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='2294'>
                                 rqr_b, rqr_bt,                             &amp;<a name='2295'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='2296'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2297'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2298'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2299'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2300'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='2301'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='2302'>
                                 k_start, k_end                               )<a name='2303'>
<a name='2304'>
       ELSE IF (im .eq. P_QI) THEN<a name='2305'>
<a name='2306'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_16"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='2307'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='2308'>
                                 rqi_b, rqi_bt,                         &amp;<a name='2309'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='2310'>
                                 dtbc, fcx, gcx,             &amp;<a name='2311'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2312'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2313'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2314'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2315'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='2316'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='2317'>
                                 k_start, k_end                        )<a name='2318'>
<a name='2319'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_48">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='2320'>
                                 rqi_b, rqi_bt,                             &amp;<a name='2321'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='2322'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2323'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2324'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2325'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2326'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='2327'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='2328'>
                                 k_start, k_end                               )<a name='2329'>
<a name='2330'>
       ELSE IF (im .eq. P_QS) THEN<a name='2331'>
<a name='2332'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_17"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='2333'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='2334'>
                                 rqs_b, rqs_bt,                         &amp;<a name='2335'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='2336'>
                                 dtbc, fcx, gcx,             &amp;<a name='2337'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2338'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2339'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2340'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2341'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='2342'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='2343'>
                                 k_start, k_end                        )<a name='2344'>
<a name='2345'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_49">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='2346'>
                                 rqs_b, rqs_bt,                             &amp;<a name='2347'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='2348'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2349'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2350'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2351'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2352'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='2353'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='2354'>
                                 k_start, k_end                               )<a name='2355'>
       ELSE IF (im .eq. P_QG) THEN<a name='2356'>
<a name='2357'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_18"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='2358'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='2359'>
                                 rqg_b, rqg_bt,                         &amp;<a name='2360'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='2361'>
                                 dtbc, fcx, gcx,             &amp;<a name='2362'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2363'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2364'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2365'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2366'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='2367'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='2368'>
                                 k_start, k_end                        )<a name='2369'>
<a name='2370'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_50">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='2371'>
                                 rqg_b, rqg_bt,                             &amp;<a name='2372'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='2373'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2374'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2375'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2376'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2377'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='2378'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='2379'>
                                 k_start, k_end                               )<a name='2380'>
       ENDIF<a name='2381'>
<a name='2382'>
     ENDIF <font color=#447700>! b.c test for moist nested boundary condition<a name='2383'></font>
<a name='2384'>
BENCH_END(rlx_bdy_scalar_tim)<a name='2385'>
<a name='2386'>
   ENDDO moist_tile_loop_1<a name='2387'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2388'></font>
<a name='2389'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2390'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2391'></font>
<a name='2392'>
   moist_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='2393'>
<a name='2394'>
       CALL wrf_debug ( 200 , ' call rk_update_scalar' )<a name='2395'>
<a name='2396'>
BENCH_START(update_scal_tim)<a name='2397'>
<a name='2398'>
<a name='2399'>
       print*,'TEST_rk_update_scalar = ',TEST_rk_update_scalar<a name='2400'>
       if(TEST_rk_update_scalar) &amp;<a name='2401'>
       CALL <A href='../../html_code/dyn_em/module_check.F.html#T_RK_UPDATE_SCALAR'>t_rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_RK_UPDATE_SCALAR_1">( im, im,                           &amp;<a name='2402'>
                              moist_1(ims,kms,jms,im),          &amp;<a name='2403'>
                              moist_2(ims,kms,jms,im),          &amp;<a name='2404'>
                              moist_tend(ims,kms,jms,im),       &amp;<a name='2405'>
                              advect_tend, msft,                &amp;<a name='2406'>
                              mu_1, mu_2, mub,                  &amp;<a name='2407'>
                              rk_step, dt_rk, spec_zone,        &amp;<a name='2408'>
                              epsts, leapfrog,config_flags,     &amp;<a name='2409'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='2410'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='2411'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='2412'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='2413'>
                              k_start    , k_end               )<a name='2414'>
<a name='2415'>
       CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_13">( im, im,                           &amp;<a name='2416'>
                              moist_1(ims,kms,jms,im),          &amp;<a name='2417'>
                              moist_2(ims,kms,jms,im),          &amp;<a name='2418'>
                              moist_tend(ims,kms,jms,im),       &amp;<a name='2419'>
                              advect_tend, msft,                &amp;<a name='2420'>
                              mu_1, mu_2, mub,                  &amp;<a name='2421'>
                              rk_step, dt_rk, spec_zone,        &amp;<a name='2422'>
                              epsts, leapfrog,config_flags,     &amp;<a name='2423'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='2424'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='2425'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='2426'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='2427'>
                              k_start    , k_end               )<a name='2428'>
BENCH_END(update_scal_tim)<a name='2429'>
<a name='2430'>
BENCH_START(flow_depbdy_tim)<a name='2431'>
       if(dyn_opt == DYN_EM) then<a name='2432'>
<font color=#447700>!       if(dyn_opt == DYN_EM_TST) then<a name='2433'></font>
       IF( config_flags%specified ) THEN<a name='2434'>
         IF(im .ne. P_QV)THEN<a name='2435'>
           CALL <A href='../../html_code/share/module_bc.F.html#FLOW_DEP_BDY'>flow_dep_bdy</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLOW_DEP_BDY_7">  (  moist_2(ims,kms,jms,im),                     &amp;<a name='2436'>
                               ru_m, rv_m, config_flags, &amp;<a name='2437'>
                               spec_zone,                  &amp;<a name='2438'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2439'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2440'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2441'></font>
                               grid%i_start(ij), grid%i_end(ij),                      &amp;<a name='2442'>
                               grid%j_start(ij), grid%j_end(ij),                      &amp;<a name='2443'>
                               k_start, k_end                               )<a name='2444'>
         ENDIF<a name='2445'>
       ENDIF<a name='2446'>
       endif<a name='2447'>
BENCH_END(flow_depbdy_tim)<a name='2448'>
<a name='2449'>
   ENDDO moist_tile_loop_2<a name='2450'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2451'></font>
<a name='2452'>
   ENDDO moist_variable_loop<a name='2453'>
<a name='2454'>
 ENDIF moist_scalar_advance<a name='2455'>
<a name='2456'>
BENCH_START(tke_adv_tim)<a name='2457'>
 if(dyn_opt == DYN_EM) then<a name='2458'>
<font color=#447700>! if(dyn_opt == DYN_EM_TST) then<a name='2459'></font>
 TKE_advance: IF (km_opt .eq. 2) then<a name='2460'>
<a name='2461'>
#ifdef DM_PARALLEL<a name='2462'>
      IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2463'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_ADVECT_3.inc.html'>HALO_EM_TKE_ADVECT_3.inc</A>"<A NAME="HALO_EM_TKE_ADVECT_3.inc_31"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2464'>
      ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2465'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_ADVECT_5.inc.html'>HALO_EM_TKE_ADVECT_5.inc</A>"<A NAME="HALO_EM_TKE_ADVECT_5.inc_32"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2466'>
      ELSE<a name='2467'>
        WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2468'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_64">(TRIM(wrf_err_message))<a name='2469'>
      ENDIF<a name='2470'>
#endif<a name='2471'>
<a name='2472'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2473'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2474'></font>
<a name='2475'>
   tke_tile_loop_1: DO ij = 1 , grid%num_tiles<a name='2476'>
<a name='2477'>
     CALL wrf_debug ( 200 , ' call rk_scalar_tend for tke' )<a name='2478'>
     CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_15"> ( 1, 1, config_flags,               &amp;<a name='2479'>
                           rk_step, dt_rk,                   &amp;<a name='2480'>
                           ru_m, rv_m, ww_m,                 &amp;<a name='2481'>
                           mut, alt,                         &amp;<a name='2482'>
                           tke_1(ims,kms,jms),               &amp;<a name='2483'>
                           tke_2(ims,kms,jms),               &amp;<a name='2484'>
                           tke_tend(ims,kms,jms),            &amp;<a name='2485'>
                           advect_tend,RQVFTEN,              &amp;<a name='2486'>
                           qv_base, .false., fnm, fnp,       &amp;<a name='2487'>
                           msfu, msfv, msft,                 &amp;<a name='2488'>
                           rdx, rdy, rdn, rdnw, khdif,       &amp;<a name='2489'>
                           kvdif, xkmhd,                     &amp;<a name='2490'>
                           leapfrog,                         &amp;<a name='2491'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='2492'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='2493'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='2494'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='2495'>
                           k_start    , k_end               )<a name='2496'>
<a name='2497'>
   ENDDO tke_tile_loop_1<a name='2498'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2499'></font>
<a name='2500'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2501'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2502'></font>
<a name='2503'>
   tke_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='2504'>
<a name='2505'>
     CALL wrf_debug ( 200 , ' call rk_update_scalar' )<a name='2506'>
     CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_14">( 1, 1,                             &amp;<a name='2507'>
                            tke_1(ims,kms,jms),               &amp;<a name='2508'>
                            tke_2(ims,kms,jms),               &amp;<a name='2509'>
                            tke_tend(ims,kms,jms),            &amp;<a name='2510'>
                            advect_tend,msft,                 &amp;<a name='2511'>
                            mu_1, mu_2, mub,                  &amp;<a name='2512'>
                            rk_step, dt_rk, spec_zone,        &amp;<a name='2513'>
                            epsts, leapfrog,config_flags,     &amp;<a name='2514'>
                            ids, ide, jds, jde, kds, kde,     &amp;<a name='2515'>
                            ims, ime, jms, jme, kms, kme,     &amp;<a name='2516'>
                            grid%i_start(ij), grid%i_end(ij), &amp;<a name='2517'>
                            grid%j_start(ij), grid%j_end(ij), &amp;<a name='2518'>
                            k_start    , k_end               ) <a name='2519'>
<a name='2520'>
<font color=#447700>! bound the tke (greater than 0, less than tke_upper_bound)<a name='2521'></font>
<a name='2522'>
     CALL <A href='../../html_code/dyn_em/module_em.F.html#BOUND_TKE'>bound_tke</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BOUND_TKE_3">( tke_2(ims,kms,jms), tke_upper_bound, &amp;<a name='2523'>
                     ids, ide, jds, jde, kds, kde,        &amp;<a name='2524'>
                     ims, ime, jms, jme, kms, kme,        &amp;<a name='2525'>
                     grid%i_start(ij), grid%i_end(ij),    &amp;<a name='2526'>
                     grid%j_start(ij), grid%j_end(ij),    &amp;<a name='2527'>
                     k_start    , k_end                  )<a name='2528'>
<a name='2529'>
     IF( config_flags%specified .or. config_flags%nested ) THEN<a name='2530'>
         CALL <A href='../../html_code/share/module_bc.F.html#FLOW_DEP_BDY'>flow_dep_bdy</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLOW_DEP_BDY_8"> (  tke_2(ims,kms,jms),                     &amp;<a name='2531'>
                              ru_m, rv_m, config_flags,               &amp;<a name='2532'>
                              spec_zone,                              &amp;<a name='2533'>
                              ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2534'></font>
                              ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2535'></font>
                              ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2536'></font>
                              grid%i_start(ij), grid%i_end(ij),       &amp;<a name='2537'>
                              grid%j_start(ij), grid%j_end(ij),       &amp;<a name='2538'>
                              k_start, k_end                               )<a name='2539'>
     ENDIF<a name='2540'>
   ENDDO tke_tile_loop_2<a name='2541'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2542'></font>
<a name='2543'>
   END IF TKE_advance<a name='2544'>
   endif<a name='2545'>
BENCH_END(tke_adv_tim)<a name='2546'>
<a name='2547'>
<font color=#447700>!  next the chemical species<a name='2548'></font>
<a name='2549'>
  chem_scalar_advance: IF (num_3d_c &gt;= PARAM_FIRST_SCALAR)  THEN<a name='2550'>
<a name='2551'>
   chem_variable_loop: do ic = PARAM_FIRST_SCALAR, num_3d_c<a name='2552'>
<a name='2553'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2554'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2555'></font>
<a name='2556'>
   chem_tile_loop_1: DO ij = 1 , grid%num_tiles<a name='2557'>
<a name='2558'>
       CALL wrf_debug ( 200 , ' call rk_scalar_tend' )<a name='2559'>
       CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_16"> ( ic, ic, config_flags,                  &amp;<a name='2560'>
                             rk_step, dt_rk,                   &amp;<a name='2561'>
                             ru_m, rv_m, ww_m,                 &amp;<a name='2562'>
                             mut, alt,                         &amp;<a name='2563'>
                             chem_1(ims,kms,jms,ic),           &amp;<a name='2564'>
                             chem_2(ims,kms,jms,ic),           &amp;<a name='2565'>
                             chem_tend(ims,kms,jms,ic),        &amp;<a name='2566'>
                             advect_tend,RQVFTEN,              &amp;<a name='2567'>
                             qv_base, .false., fnm, fnp,       &amp;<a name='2568'>
                             msfu, msfv, msft,                 &amp;<a name='2569'>
                             rdx, rdy, rdn, rdnw,              &amp;<a name='2570'>
                             khdif, kvdif, xkmhd,              &amp;<a name='2571'>
                             leapfrog,                         &amp;<a name='2572'>
                             ids, ide, jds, jde, kds, kde,     &amp;<a name='2573'>
                             ims, ime, jms, jme, kms, kme,     &amp;<a name='2574'>
                             grid%i_start(ij), grid%i_end(ij), &amp;<a name='2575'>
                             grid%j_start(ij), grid%j_end(ij), &amp;<a name='2576'>
                             k_start    , k_end               )<a name='2577'>
<a name='2578'>
   ENDDO chem_tile_loop_1<a name='2579'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2580'></font>
<a name='2581'>
<a name='2582'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2583'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2584'></font>
<a name='2585'>
   chem_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='2586'>
<a name='2587'>
       CALL wrf_debug ( 200 , ' call rk_update_scalar' )<a name='2588'>
       CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_15">( ic, ic,                           &amp;<a name='2589'>
                              chem_1(ims,kms,jms,ic),           &amp;<a name='2590'>
                              chem_2(ims,kms,jms,ic),           &amp;<a name='2591'>
                              chem_tend(ims,kms,jms,ic),        &amp;<a name='2592'>
                              advect_tend, msft,                &amp;<a name='2593'>
                              mu_1, mu_2, mub,                  &amp;<a name='2594'>
                              rk_step, dt_rk, spec_zone,        &amp;<a name='2595'>
                              epsts, leapfrog,config_flags,     &amp;<a name='2596'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='2597'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='2598'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='2599'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='2600'>
                              k_start    , k_end               )<a name='2601'>
<a name='2602'>
<a name='2603'>
       IF( config_flags%specified ) THEN<a name='2604'>
<font color=#447700>! come back to this and figure out why two different routines are needed. JM 20041203<a name='2605'></font>
#ifndef WRF_CHEM<a name='2606'>
           CALL <A href='../../html_code/share/module_bc.F.html#FLOW_DEP_BDY'>flow_dep_bdy</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLOW_DEP_BDY_9">  ( chem_2(ims,kms,jms,ic),     &amp;<a name='2607'>
                                ru_m, rv_m, config_flags,   &amp;<a name='2608'>
                                spec_zone,                  &amp;<a name='2609'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2610'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2611'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2612'></font>
                                grid%i_start(ij), grid%i_end(ij),  &amp;<a name='2613'>
                                grid%j_start(ij), grid%j_end(ij),  &amp;<a name='2614'>
                                k_start, k_end                    )<a name='2615'>
#else<a name='2616'>
           CALL flow_dep_bdy_chem( chem_2(ims,kms,jms,ic),z,&amp;<a name='2617'>
                                ru_m, rv_m, config_flags,alt,   &amp;<a name='2618'>
                                t_1,pb,p,t0,p1000mb,rcp,ph_2,phb,g, &amp;<a name='2619'>
                                spec_zone,ic,               &amp;<a name='2620'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2621'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2622'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2623'></font>
                                grid%i_start(ij), grid%i_end(ij),  &amp;<a name='2624'>
                                grid%j_start(ij), grid%j_end(ij),  &amp;<a name='2625'>
                                k_start, k_end                    )<a name='2626'>
#endif<a name='2627'>
       ENDIF<a name='2628'>
<a name='2629'>
<a name='2630'>
   ENDDO chem_tile_loop_2<a name='2631'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2632'></font>
<a name='2633'>
   ENDDO chem_variable_loop<a name='2634'>
<a name='2635'>
 ENDIF chem_scalar_advance<a name='2636'>
<a name='2637'>
 <font color=#447700>!  update the pressure and density at the new time level<a name='2638'></font>
<a name='2639'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2640'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2641'></font>
   DO ij = 1 , grid%num_tiles<a name='2642'>
<a name='2643'>
BENCH_START(calc_p_rho_tim)<a name='2644'>
<a name='2645'>
     print*,'TEST_calc_p_rho_phi = ',TEST_calc_p_rho_phi<a name='2646'>
     if(TEST_calc_p_rho_phi) &amp;<a name='2647'>
     CALL <A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO_PHI'>t_calc_p_rho_phi</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_CALC_P_RHO_PHI_1">( moist_2, num_3d_m,                &amp;<a name='2648'>
                          al, alb, mu_2, muts,              &amp;<a name='2649'>
                          ph_2, p, pb, t_2,                 &amp;<a name='2650'>
                          p0, t0, znu, dnw, rdnw,           &amp;<a name='2651'>
                          rdn, non_hydrostatic,             &amp;<a name='2652'>
                          ids, ide, jds, jde, kds, kde,     &amp;<a name='2653'>
                          ims, ime, jms, jme, kms, kme,     &amp;<a name='2654'>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='2655'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='2656'>
                          k_start    , k_end               )<a name='2657'>
<a name='2658'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI'>calc_p_rho_phi</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_PHI_9">( moist_2, num_3d_m,                &amp;<a name='2659'>
                          al, alb, mu_2, muts,              &amp;<a name='2660'>
                          ph_2, p, pb, t_2,                 &amp;<a name='2661'>
                          p0, t0, znu, dnw, rdnw,           &amp;<a name='2662'>
                          rdn, non_hydrostatic,             &amp;<a name='2663'>
                          ids, ide, jds, jde, kds, kde,     &amp;<a name='2664'>
                          ims, ime, jms, jme, kms, kme,     &amp;<a name='2665'>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='2666'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='2667'>
                          k_start    , k_end               )<a name='2668'>
BENCH_END(calc_p_rho_tim)<a name='2669'>
<a name='2670'>
BENCH_START(diag_w_tim)<a name='2671'>
     IF (.not. non_hydrostatic) THEN<a name='2672'>
<a name='2673'>
     print*,'TEST_diagnose_w = ',TEST_diagnose_w<a name='2674'>
     if(TEST_diagnose_w) &amp;<a name='2675'>
     CALL <A href='../../html_code/dyn_em/module_check.F.html#T_DIAGNOSE_W'>t_diagnose_w</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_DIAGNOSE_W_1">( ph_tend, ph_2, ph_1, w_2, muts, dt_rk,  &amp;<a name='2676'>
                      u_2, v_2, ht,                           &amp;<a name='2677'>
                      cf1, cf2, cf3, rdx, rdy, msft,          &amp;<a name='2678'>
                      ids, ide, jds, jde, kds, kde,           &amp;<a name='2679'>
                      ims, ime, jms, jme, kms, kme,           &amp;<a name='2680'>
                      grid%i_start(ij), grid%i_end(ij),       &amp;<a name='2681'>
                      grid%j_start(ij), grid%j_end(ij),       &amp;<a name='2682'>
                      k_start    , k_end                     )<a name='2683'>
<a name='2684'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DIAGNOSE_W'>diagnose_w</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIAGNOSE_W_8">( ph_tend, ph_2, ph_1, w_2, muts, dt_rk,  &amp;<a name='2685'>
                      u_2, v_2, ht,                           &amp;<a name='2686'>
                      cf1, cf2, cf3, rdx, rdy, msft,          &amp;<a name='2687'>
                      ids, ide, jds, jde, kds, kde,           &amp;<a name='2688'>
                      ims, ime, jms, jme, kms, kme,           &amp;<a name='2689'>
                      grid%i_start(ij), grid%i_end(ij),       &amp;<a name='2690'>
                      grid%j_start(ij), grid%j_end(ij),       &amp;<a name='2691'>
                      k_start    , k_end                     )<a name='2692'>
     ENDIF<a name='2693'>
BENCH_END(diag_w_tim)<a name='2694'>
<a name='2695'>
   ENDDO<a name='2696'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2697'></font>
<a name='2698'>
<font color=#447700>!  Reset the boundary conditions if there is another corrector step.<a name='2699'></font>
<font color=#447700>!  (rk_step &lt; rk_order), else we'll handle it at the end of everything<a name='2700'></font>
<font color=#447700>!  (after the split physics, before exiting the timestep).<a name='2701'></font>
<a name='2702'>
   rk_step_1_check: IF ( rk_step &lt; rk_order ) THEN<a name='2703'>
<a name='2704'>
<font color=#447700>!-----------------------------------------------------------<a name='2705'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='2706'></font>
<font color=#447700>!<a name='2707'></font>
<font color=#447700>!  here's where we need a wide comm stencil - these are the <a name='2708'></font>
<font color=#447700>!  uncoupled variables so are used for high order calc in<a name='2709'></font>
<font color=#447700>!  advection and mixong routines.<a name='2710'></font>
<font color=#447700>!<a name='2711'></font>
<font color=#447700>!                              * * * * *<a name='2712'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='2713'></font>
<font color=#447700>!          * + *      * + *    * * + * * <a name='2714'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='2715'></font>
<font color=#447700>!                              * * * * *<a name='2716'></font>
<font color=#447700>!<a name='2717'></font>
<font color=#447700>!<a name='2718'></font>
<font color=#447700>! u_2                              x<a name='2719'></font>
<font color=#447700>! v_2                              x<a name='2720'></font>
<font color=#447700>! w_2                              x<a name='2721'></font>
<font color=#447700>! t_2                              x<a name='2722'></font>
<font color=#447700>! ph_2                             x<a name='2723'></font>
<font color=#447700>! al         x<a name='2724'></font>
<font color=#447700>!<a name='2725'></font>
<font color=#447700>!  2D variable<a name='2726'></font>
<font color=#447700>! mu_2       x<a name='2727'></font>
<font color=#447700>!<a name='2728'></font>
<font color=#447700>!  4D variable<a name='2729'></font>
<font color=#447700>! moist_2               x<a name='2730'></font>
<font color=#447700>! chem_2                x<a name='2731'></font>
<a name='2732'>
#ifdef DM_PARALLEL<a name='2733'>
   IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2734'>
#    include "<A href='../../html_code/include/HALO_EM_D2_3.inc.html'>HALO_EM_D2_3.inc</A>"<A NAME="HALO_EM_D2_3.inc_33"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2735'>
   ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2736'>
#    include "<A href='../../html_code/include/HALO_EM_D2_5.inc.html'>HALO_EM_D2_5.inc</A>"<A NAME="HALO_EM_D2_5.inc_34"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2737'>
   ELSE <a name='2738'>
     WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2739'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_65">(TRIM(wrf_err_message))<a name='2740'>
   ENDIF<a name='2741'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_D.inc.html'>PERIOD_BDY_EM_D.inc</A>"<A NAME="PERIOD_BDY_EM_D.inc_35"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2742'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_MOIST2.inc.html'>PERIOD_BDY_EM_MOIST2.inc</A>"<A NAME="PERIOD_BDY_EM_MOIST2.inc_36"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2743'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_CHEM2.inc.html'>PERIOD_BDY_EM_CHEM2.inc</A>"<A NAME="PERIOD_BDY_EM_CHEM2.inc_37"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2744'>
#endif<a name='2745'>
<a name='2746'>
BENCH_START(bc_end_tim)<a name='2747'>
   if(dyn_opt == DYN_EM) then<a name='2748'>
<font color=#447700>!   if(dyn_opt == DYN_EM_TST) then<a name='2749'></font>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2750'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2751'></font>
<a name='2752'>
    tile_bc_loop_1: DO ij = 1 , grid%num_tiles<a name='2753'>
<a name='2754'>
      CALL wrf_debug ( 200 , ' call rk_phys_bc_dry_2' )<a name='2755'>
<a name='2756'>
      CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RK_PHYS_BC_DRY_2'>rk_phys_bc_dry_2</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_PHYS_BC_DRY_2_3">( config_flags,                         &amp;<a name='2757'>
                             u_2, v_2, w_2,                    &amp;<a name='2758'>
                             t_2, ph_2, mu_2,                  &amp;<a name='2759'>
                             ids, ide, jds, jde, kds, kde,     &amp;<a name='2760'>
                             ims, ime, jms, jme, kms, kme,     &amp;<a name='2761'>
                             ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='2762'>
                             grid%i_start(ij), grid%i_end(ij), &amp;<a name='2763'>
                             grid%j_start(ij), grid%j_end(ij), &amp;<a name='2764'>
                             k_start    , k_end               )<a name='2765'>
<a name='2766'>
      IF (num_3d_m &gt;= PARAM_FIRST_SCALAR) THEN<a name='2767'>
<a name='2768'>
        moisture_loop_bdy_1 : DO im = PARAM_FIRST_SCALAR , num_3d_m<a name='2769'>
  <a name='2770'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_136">( moist_2(ims,kms,jms,im), 'p', config_flags,   &amp;<a name='2771'>
                                   ids, ide, jds, jde, kds, kde,             &amp;<a name='2772'>
                                   ims, ime, jms, jme, kms, kme,             &amp;<a name='2773'>
                                   ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='2774'>
                                   grid%i_start(ij), grid%i_end(ij),                   &amp;<a name='2775'>
                                   grid%j_start(ij), grid%j_end(ij),                   &amp;<a name='2776'>
                                   k_start    , k_end                       )<a name='2777'>
         END DO moisture_loop_bdy_1<a name='2778'>
<a name='2779'>
      ENDIF<a name='2780'>
<a name='2781'>
      IF (num_3d_c &gt;= PARAM_FIRST_SCALAR) THEN<a name='2782'>
<a name='2783'>
        chem_species_bdy_loop_1 : DO ic = PARAM_FIRST_SCALAR , num_3d_c<a name='2784'>
<a name='2785'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_137">( chem_2(ims,kms,jms,ic), 'p', config_flags,   &amp;<a name='2786'>
                                  ids, ide, jds, jde, kds, kde,            &amp;<a name='2787'>
                                  ims, ime, jms, jme, kms, kme,            &amp;<a name='2788'>
                                  ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='2789'>
                                  grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='2790'>
                                  grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='2791'>
                                  k_start    , k_end-1                    )<a name='2792'>
<a name='2793'>
        END DO chem_species_bdy_loop_1<a name='2794'>
<a name='2795'>
      END IF<a name='2796'>
<a name='2797'>
      IF (km_opt .eq. 2) THEN<a name='2798'>
<a name='2799'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_138">( tke_2(ims,kms,jms) , 'p', config_flags,  &amp;<a name='2800'>
                                ids, ide, jds, jde, kds, kde,            &amp;<a name='2801'>
                                ims, ime, jms, jme, kms, kme,            &amp;<a name='2802'>
                                ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='2803'>
                                grid%i_start(ij), grid%i_end(ij),        &amp;<a name='2804'>
                                grid%j_start(ij), grid%j_end(ij),        &amp;<a name='2805'>
                                k_start    , k_end                      )<a name='2806'>
      END IF<a name='2807'>
<a name='2808'>
    END DO tile_bc_loop_1<a name='2809'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2810'></font>
   endif<a name='2811'>
BENCH_END(bc_end_tim)<a name='2812'>
<a name='2813'>
<a name='2814'>
#ifdef DM_PARALLEL<a name='2815'>
<a name='2816'>
      IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2817'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_3.inc.html'>HALO_EM_TKE_3.inc</A>"<A NAME="HALO_EM_TKE_3.inc_38"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2818'>
      ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2819'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_5.inc.html'>HALO_EM_TKE_5.inc</A>"<A NAME="HALO_EM_TKE_5.inc_39"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2820'>
      ELSE<a name='2821'>
        WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2822'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_66">(TRIM(wrf_err_message))<a name='2823'>
      ENDIF<a name='2824'>
<a name='2825'>
#if 0<a name='2826'>
   IF (km_opt .eq. 2) THEN<a name='2827'>
#      include  "<A href='../../html_code/include/HALO_EM_TKE_F.inc.html'>HALO_EM_TKE_F.inc</A>"<A NAME="HALO_EM_TKE_F.inc_40"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2828'>
   ENDIF<a name='2829'>
#endif<a name='2830'>
<a name='2831'>
   if ( num_moist .ge. PARAM_FIRST_SCALAR ) then<a name='2832'>
<a name='2833'>
<font color=#447700>!                           * * * * *<a name='2834'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='2835'></font>
<font color=#447700>!       * + *      * + *    * * + * *<a name='2836'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='2837'></font>
<font color=#447700>!                           * * * * *<a name='2838'></font>
<a name='2839'>
<font color=#447700>! moist_2                       x<a name='2840'></font>
<a name='2841'>
     IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2842'>
#      include "<A href='../../html_code/include/HALO_EM_MOIST_E_3.inc.html'>HALO_EM_MOIST_E_3.inc</A>"<A NAME="HALO_EM_MOIST_E_3.inc_41"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2843'>
     ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2844'>
#      include "<A href='../../html_code/include/HALO_EM_MOIST_E_5.inc.html'>HALO_EM_MOIST_E_5.inc</A>"<A NAME="HALO_EM_MOIST_E_5.inc_42"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2845'>
     ELSE<a name='2846'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2847'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_67">(TRIM(wrf_err_message))<a name='2848'>
     ENDIF<a name='2849'>
   endif<a name='2850'>
   if ( num_chem &gt;= PARAM_FIRST_SCALAR ) then<a name='2851'>
<a name='2852'>
<font color=#447700>!                           * * * * *<a name='2853'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='2854'></font>
<font color=#447700>!       * + *      * + *    * * + * *<a name='2855'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='2856'></font>
<font color=#447700>!                           * * * * *<a name='2857'></font>
<a name='2858'>
<font color=#447700>! chem_2                        x<a name='2859'></font>
<a name='2860'>
     IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2861'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_43"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2862'>
     ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2863'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_5.inc.html'>HALO_EM_CHEM_E_5.inc</A>"<A NAME="HALO_EM_CHEM_E_5.inc_44"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2864'>
     ELSE<a name='2865'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2866'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_68">(TRIM(wrf_err_message))<a name='2867'>
     ENDIF<a name='2868'>
   endif<a name='2869'>
#endif<a name='2870'>
<a name='2871'>
   ENDIF rk_step_1_check<a name='2872'>
<a name='2873'>
<a name='2874'>
<font color=#447700>!**********************************************************<a name='2875'></font>
<font color=#447700>!<a name='2876'></font>
<font color=#447700>!  end of RK predictor-corrector loop<a name='2877'></font>
<font color=#447700>!<a name='2878'></font>
<font color=#447700>!**********************************************************<a name='2879'></font>
<a name='2880'>
 END DO Runge_Kutta_loop<a name='2881'>
<a name='2882'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2883'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2884'></font>
<a name='2885'>
   DO ij = 1 , grid%num_tiles<a name='2886'>
<a name='2887'>
BENCH_START(advance_ppt_tim)<a name='2888'>
      CALL wrf_debug ( 200 , ' call advance_ppt' )<a name='2889'>
      CALL <A href='../../html_code/phys/module_physics_addtendc.F.html#ADVANCE_PPT'>advance_ppt</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_PPT_3">(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN, &amp;<a name='2890'>
                     RQICUTEN,RQSCUTEN,RAINC,RAINCV,NCA,    &amp;<a name='2891'>
                     CUPPT, config_flags,                   &amp;<a name='2892'>
                     ids,ide, jds,jde, kds,kde,             &amp;<a name='2893'>
                     ims,ime, jms,jme, kms,kme,             &amp;<a name='2894'>
                     grid%i_start(ij), grid%i_end(ij),      &amp;<a name='2895'>
                     grid%j_start(ij), grid%j_end(ij),      &amp;<a name='2896'>
                     k_start    , k_end                    )<a name='2897'>
BENCH_END(advance_ppt_tim)<a name='2898'>
<a name='2899'>
   ENDDO<a name='2900'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2901'></font>
<a name='2902'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2903'></font>
<font color=#447700>!&lt;pre&gt;<a name='2904'></font>
<font color=#447700>! (5) time-split physics.<a name='2905'></font>
<font color=#447700>!<a name='2906'></font>
<font color=#447700>!     Microphysics are the only time  split physics in the WRF model <a name='2907'></font>
<font color=#447700>!     at this time.  Split-physics begins with the calculation of<a name='2908'></font>
<font color=#447700>!     needed diagnostic quantities (pressure, temperature, etc.)<a name='2909'></font>
<font color=#447700>!     followed by a call to the microphysics driver, <a name='2910'></font>
<font color=#447700>!     and finishes with a clean-up, storing off of a diabatic tendency<a name='2911'></font>
<font color=#447700>!     from the moist physics, and a re-calulation of the  diagnostic<a name='2912'></font>
<font color=#447700>!     quantities pressure and density.<a name='2913'></font>
<font color=#447700>!&lt;/pre&gt;<a name='2914'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2915'></font>
<a name='2916'>
  IF (config_flags%mp_physics == 0)  then<a name='2917'>
<a name='2918'>
   IF( config_flags%specified .or. config_flags%nested ) THEN<a name='2919'>
     sz = spec_zone<a name='2920'>
   ELSE<a name='2921'>
     sz = 0<a name='2922'>
   ENDIF<a name='2923'>
<a name='2924'>
<a name='2925'>
   scalar_tile_loop_1a: DO ij = 1 , grid%num_tiles<a name='2926'>
<a name='2927'>
       its = max(grid%i_start(ij),ids+sz)<a name='2928'>
       ite = min(grid%i_end(ij),ide-1-sz)<a name='2929'>
       jts = max(grid%j_start(ij),jds+sz)<a name='2930'>
       jte = min(grid%j_end(ij),jde-1-sz)<a name='2931'>
<a name='2932'>
       CALL wrf_debug ( 200 , ' call moist_physics_prep' )<a name='2933'>
BENCH_START(moist_physics_prep_tim)<a name='2934'>
       print*,'TEST_moist_physics_prep_em = ',TEST_moist_physics_prep_em<a name='2935'>
       if(TEST_moist_physics_prep_em) &amp;<a name='2936'>
       CALL <A href='../../html_code/dyn_em/module_check.F.html#T_MOIST_PHYSICS_PREP_EM'>t_moist_physics_prep_em</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_MOIST_PHYSICS_PREP_EM_1">( t_2, t_1, t0, rho,                &amp;<a name='2937'>
                                   al, alb, p, p8w, p0, pb,          &amp;<a name='2938'>
                                   ph_2, phb, pi_phy, p_phy,         &amp;<a name='2939'>
                                   z, z_at_w, dz8w,                  &amp;<a name='2940'>
                                   dtm, h_diabatic,                  &amp;<a name='2941'>
                                   config_flags,fnm, fnp,            &amp;<a name='2942'>
                                   ids, ide, jds, jde, kds, kde,     &amp;<a name='2943'>
                                   ims, ime, jms, jme, kms, kme,     &amp;<a name='2944'>
                                   its, ite, jts, jte,               &amp;<a name='2945'>
                                   k_start    , k_end               )<a name='2946'>
<a name='2947'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_PREP_EM'>moist_physics_prep_em</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOIST_PHYSICS_PREP_EM_5">( t_2, t_1, t0, rho,                &amp;<a name='2948'>
                                   al, alb, p, p8w, p0, pb,          &amp;<a name='2949'>
                                   ph_2, phb, pi_phy, p_phy,         &amp;<a name='2950'>
                                   z, z_at_w, dz8w,                  &amp;<a name='2951'>
                                   dtm, h_diabatic,                  &amp;<a name='2952'>
                                   config_flags,fnm, fnp,            &amp;<a name='2953'>
                                   ids, ide, jds, jde, kds, kde,     &amp;<a name='2954'>
                                   ims, ime, jms, jme, kms, kme,     &amp;<a name='2955'>
                                   its, ite, jts, jte,               &amp;<a name='2956'>
                                   k_start    , k_end               )<a name='2957'>
<a name='2958'>
    print*,'TEST_lscond = ',TEST_lscond<a name='2959'>
    IF (TEST_lscond)   &amp;<a name='2960'>
    CALL <A href='../../html_code/dyn_em/module_check.F.html#T_LSCOND'>t_lscond</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="T_LSCOND_1">(t_2, p_phy                                     &amp;<a name='2961'>
                ,moist_2(ims,kms,jms,P_QV)                           &amp;<a name='2962'>
                 ,rho, pi_phy,r_v, xlv, cp                    &amp;<a name='2963'>
                 ,ep_2, svp1, svp2                                  &amp;<a name='2964'>
                 ,svp3, svpt0                                       &amp;<a name='2965'>
                 ,dz8w                                              &amp;<a name='2966'>
                 ,rainnc, rainncv                                   &amp;<a name='2967'>
                 ,ids, ide, jds, jde, kds, kde,              &amp;<a name='2968'>
                 ims, ime, jms, jme, kms, kme,              &amp;<a name='2969'>
                 its, ite, jts, jte,               &amp;<a name='2970'>
                 k_start, min(k_end,kde-1)         &amp;<a name='2971'>
                 , 'solve_em 1')<a name='2972'>
<a name='2973'>
<a name='2974'>
      CALL <A href='../../html_code/phys/module_mp_nconvp.F.html#LSCOND'>lscond</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LSCOND_4">(t_2, p_phy                                         &amp;<a name='2975'>
                    ,moist_2(ims,kms,jms,P_QV)                         &amp;<a name='2976'>
                    ,rho, pi_phy,r_v, xlv, cp                          &amp;<a name='2977'>
                    ,ep_2, svp1, svp2                                  &amp;<a name='2978'>
                    ,svp3, svpt0                                       &amp;<a name='2979'>
                    ,dz8w                                              &amp;<a name='2980'>
                    ,rainnc, rainncv                                   &amp;<a name='2981'>
                    ,ids, ide, jds, jde, kds, kde                      &amp;<a name='2982'>
                    ,ims, ime, jms, jme, kms, kme                      &amp;<a name='2983'>
                    ,its, ite, jts, jte                                &amp;<a name='2984'>
                    ,k_start, min(k_end,kde-1)                         )<a name='2985'>
<a name='2986'>
<a name='2987'>
<a name='2988'>
BENCH_END(moist_physics_prep_tim)<a name='2989'>
   END DO scalar_tile_loop_1a<a name='2990'>
<a name='2991'>
       CALL wrf_debug ( 200 , ' call microphysics_driver' )<a name='2992'>
<a name='2993'>
BENCH_START(micro_driver_tim)<a name='2994'>
       sr = 0.<a name='2995'>
       CALL <A href='../../html_code/phys/module_microphysics_driver.F.html#MICROPHYSICS_DRIVER'>microphysics_driver</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_DRIVER_1">(t_2,moist_2, moist_1, w_2,                  &amp;<a name='2996'>
                                rho, pi_phy, p_phy, RAINNC, RAINNCV,        &amp;<a name='2997'>
                                z, ht, dz8w, p8w, dtm, dx, dy,              &amp;<a name='2998'>
                                config_flags, spec_zone,                    &amp;<a name='2999'>
                                num_3d_m, warm_rain,                        &amp;<a name='3000'>
                                XLAND,itimestep,                            &amp; <a name='3001'>
                                F_ICE_PHY,F_RAIN_PHY,F_RIMEF_PHY,           &amp;<a name='3002'>
                                LOWLYR,SR,                                  &amp;<a name='3003'>
                                ids, ide, jds, jde, kds, kde,               &amp;<a name='3004'>
                                ims, ime, jms, jme, kms, kme,               &amp;<a name='3005'>
                                grid%i_start, min(grid%i_end, ide-1),       &amp;<a name='3006'>
                                grid%j_start, min(grid%j_end, jde-1),       &amp;<a name='3007'>
                                k_start    , min(k_end,kde-1) , grid%num_tiles )<a name='3008'>
BENCH_END(micro_driver_tim)<a name='3009'>
<a name='3010'>
       CALL wrf_debug ( 200 , ' call moist_physics_finish' )<a name='3011'>
BENCH_START(moist_phys_end_tim)<a name='3012'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3013'></font>
   <font color=#447700>!$OMP PRIVATE ( ij, its, ite, jts, jte )<a name='3014'></font>
<a name='3015'>
   scalar_tile_loop_1b: DO ij = 1 , grid%num_tiles<a name='3016'>
<a name='3017'>
       its = max(grid%i_start(ij),ids+sz)<a name='3018'>
       ite = min(grid%i_end(ij),ide-1-sz)<a name='3019'>
       jts = max(grid%j_start(ij),jds+sz)<a name='3020'>
       jte = min(grid%j_end(ij),jde-1-sz)<a name='3021'>
<a name='3022'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_FINISH_EM'>moist_physics_finish_em</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOIST_PHYSICS_FINISH_EM_2">( t_2, t_1, t0, muts,               &amp;<a name='3023'>
                                     h_diabatic, dtm, config_flags,    &amp;<a name='3024'>
                                     ids, ide, jds, jde, kds, kde,     &amp;<a name='3025'>
                                     ims, ime, jms, jme, kms, kme,     &amp;<a name='3026'>
                                     its, ite, jts, jte,               &amp;<a name='3027'>
                                     k_start    , k_end               )<a name='3028'>
<a name='3029'>
<a name='3030'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI'>calc_p_rho_phi</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_PHI_10">( moist_2, num_3d_m,                &amp;<a name='3031'>
                            al, alb, mu_2, muts,              &amp;<a name='3032'>
                            ph_2, p, pb, t_2,                 &amp;<a name='3033'>
                            p0, t0, znu, dnw, rdnw,           &amp;<a name='3034'>
                            rdn, non_hydrostatic,             &amp;<a name='3035'>
                            ids, ide, jds, jde, kds, kde,     &amp;<a name='3036'>
                            ims, ime, jms, jme, kms, kme,     &amp;<a name='3037'>
                            its, ite, jts, jte,               &amp;<a name='3038'>
                            k_start    , k_end               )<a name='3039'>
<a name='3040'>
       IF (.not. non_hydrostatic)                               &amp;<a name='3041'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DIAGNOSE_W'>diagnose_w</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIAGNOSE_W_9">( ph_tend, ph_2, ph_1, w_2, muts, dt_rk,  &amp;<a name='3042'>
                        u_2, v_2, ht,                           &amp;<a name='3043'>
                        cf1, cf2, cf3, rdx, rdy, msft,          &amp;<a name='3044'>
                        ids, ide, jds, jde, kds, kde,           &amp;<a name='3045'>
                        ims, ime, jms, jme, kms, kme,           &amp;<a name='3046'>
                        its, ite, jts, jte,                     &amp;<a name='3047'>
                        k_start    , k_end                     )<a name='3048'>
<a name='3049'>
   END DO scalar_tile_loop_1b<a name='3050'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='3051'></font>
BENCH_END(moist_phys_end_tim)<a name='3052'>
<a name='3053'>
  ENDIF<a name='3054'>
<a name='3055'>
   scalar_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='3056'>
<a name='3057'>
          CALL wrf_debug ( 200 , ' call scalar_tile_loop_2' )<a name='3058'>
<a name='3059'>
     IF ( num_3d_c &gt;= PARAM_FIRST_SCALAR ) then<a name='3060'>
<a name='3061'>
<font color=#447700>!<a name='3062'></font>
<font color=#447700>!  tiled chemistry not here, it is called from solve_interface, and found in chem_driver<a name='3063'></font>
<font color=#447700>!<a name='3064'></font>
<a name='3065'>
     END IF<a name='3066'>
<a name='3067'>
   END DO scalar_tile_loop_2<a name='3068'>
<a name='3069'>
<a name='3070'>
   if(dyn_opt == DYN_EM) then<a name='3071'>
<font color=#447700>!   if(dyn_opt == DYN_EM_TST) then<a name='3072'></font>
   IF (leapfrog ) THEN<a name='3073'>
<a name='3074'>
    <font color=#447700>! do time filter and switch for the dry variables<a name='3075'></font>
<a name='3076'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3077'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='3078'></font>
<a name='3079'>
    DO ij = 1 , grid%num_tiles<a name='3080'>
<a name='3081'>
BENCH_START(time_filt_tim)<a name='3082'>
      call <A href='../../html_code/dyn_em/module_em.F.html#TIME_FILTER'>time_filter</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TIME_FILTER_3">( u_1, u_2, u_save,                 &amp;<a name='3083'>
                        v_1, v_2, v_save,                 &amp;<a name='3084'>
                        w_1, w_2, w_save,                 &amp;<a name='3085'>
                        t_1, t_2, t_save,                 &amp;<a name='3086'>
                        ph_1, ph_2, ph_save,              &amp;<a name='3087'>
                        mu_1, mu_2, mu_save,              &amp;<a name='3088'>
                        epsts,                            &amp;<a name='3089'>
                        ids, ide, jds, jde, kds, kde,     &amp;<a name='3090'>
                        ims, ime, jms, jme, kms, kme,     &amp;<a name='3091'>
                        grid%i_start(ij), grid%i_end(ij), &amp;<a name='3092'>
                        grid%j_start(ij), grid%j_end(ij), &amp;<a name='3093'>
                        k_start    , k_end               )<a name='3094'>
BENCH_END(time_filt_tim)<a name='3095'>
<a name='3096'>
    ENDDO<a name='3097'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='3098'></font>
<a name='3099'>
    END IF<a name='3100'>
    endif<a name='3101'>
<a name='3102'>
   <font color=#447700>!  We're finished except for boundary condition (and patch) update<a name='3103'></font>
<a name='3104'>
   <font color=#447700>! Boundary condition time (or communication time).  At this time, we have<a name='3105'></font>
   <font color=#447700>! implemented periodic and symmetric physical boundary conditions.<a name='3106'></font>
<a name='3107'>
   <font color=#447700>! b.c. routine for data within patch.<a name='3108'></font>
<a name='3109'>
   <font color=#447700>! we need to do both time levels of <a name='3110'></font>
   <font color=#447700>! data because the time filter only works in the physical solution space.<a name='3111'></font>
<a name='3112'>
   <font color=#447700>! First, do patch communications for boundary conditions (periodicity)<a name='3113'></font>
<a name='3114'>
<font color=#447700>!-----------------------------------------------------------<a name='3115'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='3116'></font>
<font color=#447700>!<a name='3117'></font>
<font color=#447700>!  here's where we need a wide comm stencil - these are the <a name='3118'></font>
<font color=#447700>!  uncoupled variables so are used for high order calc in<a name='3119'></font>
<font color=#447700>!  advection and mixong routines.<a name='3120'></font>
<font color=#447700>!<a name='3121'></font>
<font color=#447700>!                              * * * * *<a name='3122'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='3123'></font>
<font color=#447700>!          * + *      * + *    * * + * * <a name='3124'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='3125'></font>
<font color=#447700>!                              * * * * *<a name='3126'></font>
<font color=#447700>!<a name='3127'></font>
<font color=#447700>!   u_1                            x<a name='3128'></font>
<font color=#447700>!   u_2                            x<a name='3129'></font>
<font color=#447700>!   v_1                            x<a name='3130'></font>
<font color=#447700>!   v_2                            x<a name='3131'></font>
<font color=#447700>!   w_1                            x<a name='3132'></font>
<font color=#447700>!   w_2                            x<a name='3133'></font>
<font color=#447700>!   t_1                            x<a name='3134'></font>
<font color=#447700>!   t_2                            x<a name='3135'></font>
<font color=#447700>!  ph_1                            x<a name='3136'></font>
<font color=#447700>!  ph_2                            x<a name='3137'></font>
<font color=#447700>!  tke_1                           x<a name='3138'></font>
<font color=#447700>!  tke_2                           x<a name='3139'></font>
<font color=#447700>!<a name='3140'></font>
<font color=#447700>!    2D variables<a name='3141'></font>
<font color=#447700>!  mu_1     x<a name='3142'></font>
<font color=#447700>!  mu_2     x<a name='3143'></font>
<font color=#447700>!<a name='3144'></font>
<font color=#447700>!    4D variables<a name='3145'></font>
<font color=#447700>!  moist_1                         x<a name='3146'></font>
<font color=#447700>!  moist_2                         x<a name='3147'></font>
<font color=#447700>!   chem_1                         x<a name='3148'></font>
<font color=#447700>!   chem_2                         x<a name='3149'></font>
<font color=#447700>!----------------------------------------------------------<a name='3150'></font>
<a name='3151'>
<a name='3152'>
#ifdef DM_PARALLEL<a name='3153'>
   IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='3154'>
#    include "<A href='../../html_code/include/HALO_EM_D3_3.inc.html'>HALO_EM_D3_3.inc</A>"<A NAME="HALO_EM_D3_3.inc_45"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3155'>
   ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='3156'>
#    include "<A href='../../html_code/include/HALO_EM_D3_5.inc.html'>HALO_EM_D3_5.inc</A>"<A NAME="HALO_EM_D3_5.inc_46"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3157'>
   ELSE <a name='3158'>
     WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='3159'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_69">(TRIM(wrf_err_message))<a name='3160'>
   ENDIF<a name='3161'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_D3.inc.html'>PERIOD_BDY_EM_D3.inc</A>"<A NAME="PERIOD_BDY_EM_D3.inc_47"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3162'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_MOIST.inc.html'>PERIOD_BDY_EM_MOIST.inc</A>"<A NAME="PERIOD_BDY_EM_MOIST.inc_48"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3163'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_CHEM.inc.html'>PERIOD_BDY_EM_CHEM.inc</A>"<A NAME="PERIOD_BDY_EM_CHEM.inc_49"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3164'>
#endif<a name='3165'>
<a name='3166'>
<font color=#447700>!  now set physical b.c on a patch<a name='3167'></font>
<a name='3168'>
BENCH_START(bc_2d_tim)<a name='3169'>
   if(dyn_opt == DYN_EM) then<a name='3170'>
<font color=#447700>!   if(dyn_opt == DYN_EM_TST) then<a name='3171'></font>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3172'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='3173'></font>
<a name='3174'>
   tile_bc_loop_2: DO ij = 1 , grid%num_tiles<a name='3175'>
<a name='3176'>
     CALL wrf_debug ( 200 , ' call set_phys_bc_dry_2' )<a name='3177'>
<a name='3178'>
     CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SET_PHYS_BC_DRY_2'>set_phys_bc_dry_2</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYS_BC_DRY_2_3">( config_flags,                           &amp;<a name='3179'>
                             u_1, u_2, v_1, v_2, w_1, w_2,           &amp;<a name='3180'>
                             t_1, t_2, ph_1, ph_2, mu_1, mu_2,       &amp;<a name='3181'>
                             ids, ide, jds, jde, kds, kde,           &amp;<a name='3182'>
                             ims, ime, jms, jme, kms, kme,           &amp;<a name='3183'>
                             ips, ipe, jps, jpe, kps, kpe,           &amp;<a name='3184'>
                             grid%i_start(ij), grid%i_end(ij),       &amp;<a name='3185'>
                             grid%j_start(ij), grid%j_end(ij),       &amp;<a name='3186'>
                             k_start    , k_end                     )<a name='3187'>
<a name='3188'>
     CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_139">( tke_1(ims,kms,jms), 'p', config_flags,   &amp;<a name='3189'>
                             ids, ide, jds, jde, kds, kde,            &amp;<a name='3190'>
                             ims, ime, jms, jme, kms, kme,            &amp;<a name='3191'>
                             ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='3192'>
                             grid%i_start(ij), grid%i_end(ij),        &amp;<a name='3193'>
                             grid%j_start(ij), grid%j_end(ij),        &amp;<a name='3194'>
                             k_start    , k_end-1                    )<a name='3195'>
     CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_140">( tke_2(ims,kms,jms) , 'p', config_flags,  &amp;<a name='3196'>
                             ids, ide, jds, jde, kds, kde,            &amp;<a name='3197'>
                             ims, ime, jms, jme, kms, kme,            &amp;<a name='3198'>
                             ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='3199'>
                             grid%i_start(ij), grid%i_end(ij),        &amp;<a name='3200'>
                             grid%j_start(ij), grid%j_end(ij),        &amp;<a name='3201'>
                             k_start    , k_end                      )<a name='3202'>
<a name='3203'>
     moisture_loop_bdy_2 : DO im = PARAM_FIRST_SCALAR , num_3d_m<a name='3204'>
<a name='3205'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_141">( moist_1(ims,kms,jms,im), 'p',           &amp;<a name='3206'>
                               config_flags,                           &amp;<a name='3207'>
                               ids, ide, jds, jde, kds, kde,           &amp;<a name='3208'>
                               ims, ime, jms, jme, kms, kme,           &amp;<a name='3209'>
                               ips, ipe, jps, jpe, kps, kpe,           &amp;<a name='3210'>
                               grid%i_start(ij), grid%i_end(ij),       &amp;<a name='3211'>
                               grid%j_start(ij), grid%j_end(ij),       &amp;<a name='3212'>
                               k_start    , k_end                     )<a name='3213'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_142">( moist_2(ims,kms,jms,im), 'p',           &amp;<a name='3214'>
                               config_flags,                           &amp;<a name='3215'>
                               ids, ide, jds, jde, kds, kde,           &amp;<a name='3216'>
                               ims, ime, jms, jme, kms, kme,           &amp;<a name='3217'>
                               ips, ipe, jps, jpe, kps, kpe,           &amp;<a name='3218'>
                               grid%i_start(ij), grid%i_end(ij),       &amp;<a name='3219'>
                               grid%j_start(ij), grid%j_end(ij),       &amp;<a name='3220'>
                               k_start    , k_end                     )<a name='3221'>
<a name='3222'>
     END DO moisture_loop_bdy_2<a name='3223'>
<a name='3224'>
     chem_species_bdy_loop_2 : DO ic = PARAM_FIRST_SCALAR , num_3d_c<a name='3225'>
<a name='3226'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_143">( chem_1(ims,kms,jms,ic), 'p', config_flags,   &amp;<a name='3227'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='3228'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='3229'>
                               ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='3230'>
                               grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='3231'>
                               grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='3232'>
                               k_start    , k_end                    )<a name='3233'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_144">( chem_2(ims,kms,jms,ic) , 'p', config_flags,  &amp;<a name='3234'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='3235'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='3236'>
                               ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='3237'>
                               grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='3238'>
                               grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='3239'>
                               k_start    , k_end                      )<a name='3240'>
<a name='3241'>
     END DO chem_species_bdy_loop_2<a name='3242'>
<a name='3243'>
   END DO tile_bc_loop_2<a name='3244'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='3245'></font>
   endif<a name='3246'>
BENCH_END(bc_2d_tim)<a name='3247'>
<a name='3248'>
   IF( config_flags%specified .or. config_flags%nested ) THEN <a name='3249'>
     dtbc = dtbc + dt<a name='3250'>
   ENDIF<a name='3251'>
<a name='3252'>
#ifdef DM_PARALLEL<a name='3253'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3254'></font>
<font color=#447700>! see above<a name='3255'></font>
<font color=#447700>!--------------------------------------------------------------<a name='3256'></font>
   CALL wrf_debug ( 200 , ' call HALO_RK_E' )<a name='3257'>
   IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='3258'>
#    include "<A href='../../html_code/include/HALO_EM_E_3.inc.html'>HALO_EM_E_3.inc</A>"<A NAME="HALO_EM_E_3.inc_50"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3259'>
   ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='3260'>
#    include "<A href='../../html_code/include/HALO_EM_E_5.inc.html'>HALO_EM_E_5.inc</A>"<A NAME="HALO_EM_E_5.inc_51"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3261'>
   ELSE<a name='3262'>
     WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='3263'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_70">(TRIM(wrf_err_message))<a name='3264'>
   ENDIF<a name='3265'>
#endif<a name='3266'>
<a name='3267'>
#ifdef DM_PARALLEL<a name='3268'>
   if ( num_moist &gt;= PARAM_FIRST_SCALAR  ) then<a name='3269'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3270'></font>
<font color=#447700>! see above<a name='3271'></font>
<font color=#447700>!--------------------------------------------------------------<a name='3272'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_MOIST' )<a name='3273'>
     IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='3274'>
#      include "<A href='../../html_code/include/HALO_EM_MOIST_E_3.inc.html'>HALO_EM_MOIST_E_3.inc</A>"<A NAME="HALO_EM_MOIST_E_3.inc_52"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3275'>
     ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='3276'>
#      include "<A href='../../html_code/include/HALO_EM_MOIST_E_5.inc.html'>HALO_EM_MOIST_E_5.inc</A>"<A NAME="HALO_EM_MOIST_E_5.inc_53"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3277'>
     ELSE<a name='3278'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='3279'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_71">(TRIM(wrf_err_message))<a name='3280'>
     ENDIF<a name='3281'>
   endif<a name='3282'>
   if ( num_chem &gt;= PARAM_FIRST_SCALAR ) then<a name='3283'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3284'></font>
<font color=#447700>! see above<a name='3285'></font>
<font color=#447700>!--------------------------------------------------------------<a name='3286'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_CHEM' )<a name='3287'>
     IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='3288'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_54"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3289'>
     ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='3290'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_5.inc.html'>HALO_EM_CHEM_E_5.inc</A>"<A NAME="HALO_EM_CHEM_E_5.inc_55"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3291'>
     ELSE<a name='3292'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='3293'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_72">(TRIM(wrf_err_message))<a name='3294'>
     ENDIF<a name='3295'>
   endif<a name='3296'>
#endif<a name='3297'>
<a name='3298'>
<font color=#447700>! add diagnoses. hans_xyh huang.<a name='3299'></font>
<a name='3300'>
<font color=#447700>!  DO ij = 1 , grid%num_tiles<a name='3301'></font>
<a name='3302'>
<font color=#447700>!    call calc_dpsdt ( itimestep, dt, psfc, psfcm, 'ps', &amp;<a name='3303'></font>
<font color=#447700>!                      avg_abs_dpsdt, dpsdt,             &amp;<a name='3304'></font>
<font color=#447700>!                      ids, ide, jds, jde,               &amp;<a name='3305'></font>
<font color=#447700>!                      ims, ime, jms, jme,               &amp;<a name='3306'></font>
<font color=#447700>!                      grid%i_start(ij), grid%i_end(ij), &amp;<a name='3307'></font>
<font color=#447700>!                      grid%j_start(ij), grid%j_end(ij)  )<a name='3308'></font>
<font color=#447700>!    call calc_dpsdt ( itimestep, dt, mu_2, mu_1, 'mu',  &amp;<a name='3309'></font>
<font color=#447700>!                      avg_abs_dmudt, dmudt,             &amp;<a name='3310'></font>
<font color=#447700>!                      ids, ide, jds, jde,               &amp;<a name='3311'></font>
<font color=#447700>!                      ims, ime, jms, jme,               &amp;<a name='3312'></font>
<font color=#447700>!                      grid%i_start(ij), grid%i_end(ij), &amp;<a name='3313'></font>
<font color=#447700>!                      grid%j_start(ij), grid%j_end(ij)  )<a name='3314'></font>
<a name='3315'>
<font color=#447700>!    call calc_q_conv_3d ( moist_1, moist_2, dt,             &amp;<a name='3316'></font>
<font color=#447700>!                          q_conve_3d,                       &amp;<a name='3317'></font>
<font color=#447700>!                          num_3d_m,                         &amp;<a name='3318'></font>
<font color=#447700>!                          ids, ide, jds, jde, kds, kde,     &amp;<a name='3319'></font>
<font color=#447700>!                          ims, ime, jms, jme, kms, kme,     &amp;<a name='3320'></font>
<font color=#447700>!                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='3321'></font>
<font color=#447700>!                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='3322'></font>
<font color=#447700>!                          k_start, k_end                    )<a name='3323'></font>
<font color=#447700>!    call calc_q_conv_2d ( moist_2, u_2, v_2,                &amp;<a name='3324'></font>
<font color=#447700>!                          dt, DX, q_conve_2d,               &amp;<a name='3325'></font>
<font color=#447700>!                          num_3d_m,                         &amp;<a name='3326'></font>
<font color=#447700>!                          ids, ide, jds, jde, kds, kde,     &amp;<a name='3327'></font>
<font color=#447700>!                          ims, ime, jms, jme, kms, kme,     &amp;<a name='3328'></font>
<font color=#447700>!                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='3329'></font>
<font color=#447700>!                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='3330'></font>
<font color=#447700>!                          k_start, k_end                    )<a name='3331'></font>
<a name='3332'>
<font color=#447700>!  ENDDO<a name='3333'></font>
<a name='3334'>
   CALL wrf_debug ( 200 , ' call end of solve_em' )<a name='3335'>
<a name='3336'>
<font color=#447700>! Finish timers if compiled with -DBENCH.<a name='3337'></font>
#include &lt;<A href='../../html_code/include/bench_solve_em_end.h.html'>bench_solve_em_end.h</A>&gt;<A NAME="bench_solve_em_end.h_56"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3338'>
<a name='3339'>
<font color=#447700>! See comment before earlier #include of this file.<a name='3340'></font>
#define COPY_OUT<a name='3341'>
#include &lt;<A href='../../html_code/include/em_scalar_derefs.inc.html'>em_scalar_derefs.inc</A>&gt;<A NAME="em_scalar_derefs.inc_57"><A href='../../html_code/dyn_em/solve_em_tst.F.html#SOLVE_EM_TST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3342'>
<a name='3343'>
   RETURN<a name='3344'>
<a name='3345'>
#endif<a name='3346'>
<a name='3347'>
END SUBROUTINE solve_em_tst<a name='3348'>
<a name='3349'>
</pre></body></html>