<HTML> <BODY BGCOLOR=#cceeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!REAL:MODEL_LAYER:INITIALIZATION<a name='2'></font>
<a name='3'>
<font color=#447700>!  This MODULE holds the routines which are used to perform various initializations<a name='4'></font>
<font color=#447700>!  for the individual domains, specifically for the Eulerian, mass-based coordinate.<a name='5'></font>
<a name='6'>
<font color=#447700>!-----------------------------------------------------------------------<a name='7'></font>
<a name='8'>
<A NAME='MODULE_INITIALIZE'><A href='../../html_code/dyn_em/module_initialize_real.F.html#MODULE_INITIALIZE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='9'>
<font color=#993300>MODULE </font><font color=#cc0000>module_initialize</font> <A href='../../call_to/MODULE_INITIALIZE.html' TARGET='index'>7</A><a name='10'>
<a name='11'>
   USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/dyn_em/module_initialize_real.F.html#module_initialize_real.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_17"><a name='12'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_initialize_real.F.html#module_initialize_real.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_18"><a name='13'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/module_initialize_real.F.html#module_initialize_real.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_10"><a name='14'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/dyn_em/module_initialize_real.F.html#module_initialize_real.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_5"><a name='15'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_initialize_real.F.html#module_initialize_real.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_17"><a name='16'>
   USE module_state_description<a name='17'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/dyn_em/module_initialize_real.F.html#module_initialize_real.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_5"><a name='18'>
   USE <A href='../../html_code/share/module_soil_pre.F.html#MODULE_SOIL_PRE'>module_soil_pre</A><A href='../../html_code/dyn_em/module_initialize_real.F.html#module_initialize_real.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SOIL_PRE_1"><a name='19'>
#ifdef DM_PARALLEL<a name='20'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/module_initialize_real.F.html#module_initialize_real.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_8"><a name='21'>
#endif<a name='22'>
<a name='23'>
<a name='24'>
CONTAINS<a name='25'>
<a name='26'>
<font color=#447700>!-------------------------------------------------------------------<a name='27'></font>
<a name='28'>
<A NAME='INIT_DOMAIN'><A href='../../html_code/dyn_em/module_initialize_real.F.html#INIT_DOMAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='29'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_domain</font> ( grid ) <A href='../../call_to/INIT_DOMAIN.html' TARGET='index'>3</A>,<A href='../../call_from/INIT_DOMAIN.html' TARGET='index'>24</A><a name='30'>
<a name='31'>
      IMPLICIT NONE<a name='32'>
<a name='33'>
      <font color=#447700>!  Input space and data.  No gridded meteorological data has been stored, though.<a name='34'></font>
<a name='35'>
<font color=#447700>!     TYPE (domain), POINTER :: grid <a name='36'></font>
      TYPE (domain)          :: grid <a name='37'>
<a name='38'>
      <font color=#447700>!  Local data.<a name='39'></font>
<a name='40'>
      INTEGER :: dyn_opt <a name='41'>
      INTEGER :: idum1, idum2<a name='42'>
<a name='43'>
#ifdef DEREF_KLUDGE<a name='44'>
<font color=#447700>!  see http://www2.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='45'></font>
   INTEGER     :: sm31 , em31 , sm32 , em32 , sm33 , em33<a name='46'>
   INTEGER     :: sm31x, em31x, sm32x, em32x, sm33x, em33x<a name='47'>
   INTEGER     :: sm31y, em31y, sm32y, em32y, sm33y, em33y<a name='48'>
#endif<a name='49'>
<a name='50'>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_1"><A href='../../html_code/dyn_exp/module_initialize_exp.F.html#INIT_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='51'>
<a name='52'>
      CALL nl_get_dyn_opt ( 1, dyn_opt )<a name='53'>
      <a name='54'>
      CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/dyn_exp/module_initialize_exp.F.html#INIT_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_5"> ( head_grid%id , idum1, idum2 )<a name='55'>
<a name='56'>
      IF (      dyn_opt .eq. 1 &amp;<a name='57'>
           .or. dyn_opt .eq. 2 &amp;<a name='58'>
           .or. dyn_opt .eq. 3 &amp;<a name='59'>
                                          ) THEN<a name='60'>
        CALL <A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK'>init_domain_rk</A><A href='../../html_code/dyn_exp/module_initialize_exp.F.html#INIT_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_DOMAIN_RK_5">( grid, &amp;<a name='61'>
<font color=#447700>!<a name='62'></font>
#include &lt;<A href='../../html_code/include/em_actual_args.inc.html'>em_actual_args.inc</A>&gt;<A NAME="em_actual_args.inc_2"><A href='../../html_code/dyn_exp/module_initialize_exp.F.html#INIT_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='63'>
<font color=#447700>!<a name='64'></font>
      )<a name='65'>
<a name='66'>
      ELSE<a name='67'>
         WRITE(0,*)' init_domain: unknown or unimplemented dyn_opt = ',dyn_opt<a name='68'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_exp/module_initialize_exp.F.html#INIT_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_26"> ( 'ERROR-dyn_opt-wrong-in-namelist' )<a name='69'>
      ENDIF<a name='70'>
<a name='71'>
   END SUBROUTINE init_domain<a name='72'>
<a name='73'>
<font color=#447700>!-------------------------------------------------------------------<a name='74'></font>
<a name='75'>
<A NAME='INIT_DOMAIN_RK'><A href='../../html_code/dyn_em/module_initialize_real.F.html#INIT_DOMAIN_RK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='76'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_domain_rk</font> ( grid, &amp; <A href='../../call_to/INIT_DOMAIN_RK.html' TARGET='index'>7</A>,<A href='../../call_from/INIT_DOMAIN_RK.html' TARGET='index'>128</A><a name='77'>
<font color=#447700>!<a name='78'></font>
# include &lt;<A href='../../html_code/include/em_dummy_args.inc.html'>em_dummy_args.inc</A>&gt;<A NAME="em_dummy_args.inc_3"><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='79'>
<font color=#447700>!<a name='80'></font>
   )<a name='81'>
<a name='82'>
      USE <A href='../../html_code/share/module_optional_si_input.F.html#MODULE_OPTIONAL_SI_INPUT'>module_optional_si_input</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_OPTIONAL_SI_INPUT_1"><a name='83'>
      IMPLICIT NONE<a name='84'>
<a name='85'>
      <font color=#447700>!  Input space and data.  No gridded meteorological data has been stored, though.<a name='86'></font>
<a name='87'>
<font color=#447700>!     TYPE (domain), POINTER :: grid<a name='88'></font>
      TYPE (domain)          :: grid<a name='89'>
<a name='90'>
# include &lt;<A href='../../html_code/include/em_dummy_decl.inc.html'>em_dummy_decl.inc</A>&gt;<A NAME="em_dummy_decl.inc_4"><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='91'>
<a name='92'>
      TYPE (grid_config_rec_type)              :: config_flags<a name='93'>
<a name='94'>
      <font color=#447700>!  Local domain indices and counters.<a name='95'></font>
<a name='96'>
      INTEGER :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='97'>
      INTEGER :: loop , num_seaice_changes<a name='98'>
<a name='99'>
      INTEGER                             ::                       &amp;<a name='100'>
                                     ids, ide, jds, jde, kds, kde, &amp;<a name='101'>
                                     ims, ime, jms, jme, kms, kme, &amp;<a name='102'>
                                     its, ite, jts, jte, kts, kte, &amp;<a name='103'>
                                     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='104'>
                                     i, j, k<a name='105'>
<a name='106'>
      <font color=#447700>!  Local data<a name='107'></font>
<a name='108'>
      INTEGER :: error<a name='109'>
      REAL    :: p_surf, p_level<a name='110'>
      REAL    :: cof1, cof2<a name='111'>
      REAL    :: qvf , qvf1 , qvf2 , pd_surf<a name='112'>
      REAL    :: p00 , t00 , a<a name='113'>
      REAL    :: hold_znw<a name='114'>
      LOGICAL :: were_bad<a name='115'>
<a name='116'>
      LOGICAL :: stretch_grid, dry_sounding, debug<a name='117'>
<a name='118'>
<font color=#447700>!      INTEGER , PARAMETER :: nl_max = 1000<a name='119'></font>
<font color=#447700>!      REAL , DIMENSION(nl_max) :: dn<a name='120'></font>
<a name='121'>
<a name='122'>
integer::oops1,oops2<a name='123'>
<a name='124'>
#ifdef DEREF_KLUDGE<a name='125'>
<font color=#447700>!  see http://www2.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='126'></font>
      INTEGER     :: sm31 , em31 , sm32 , em32 , sm33 , em33<a name='127'>
      INTEGER     :: sm31x, em31x, sm32x, em32x, sm33x, em33x<a name='128'>
      INTEGER     :: sm31y, em31y, sm32y, em32y, sm33y, em33y<a name='129'>
#endif<a name='130'>
<a name='131'>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_5"><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='132'>
<a name='133'>
#define COPY_IN<a name='134'>
#include &lt;<A href='../../html_code/include/em_scalar_derefs.inc.html'>em_scalar_derefs.inc</A>&gt;<A NAME="em_scalar_derefs.inc_6"><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='135'>
#ifdef DM_PARALLEL<a name='136'>
#    include &lt;<A href='../../html_code/include/em_data_calls.inc.html'>em_data_calls.inc</A>&gt;<A NAME="em_data_calls.inc_7"><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='137'>
#endif<a name='138'>
<a name='139'>
      SELECT CASE ( model_data_order )<a name='140'>
         CASE ( DATA_ORDER_ZXY )<a name='141'>
            kds = grid%sd31 ; kde = grid%ed31 ;<a name='142'>
            ids = grid%sd32 ; ide = grid%ed32 ;<a name='143'>
            jds = grid%sd33 ; jde = grid%ed33 ;<a name='144'>
<a name='145'>
            kms = grid%sm31 ; kme = grid%em31 ;<a name='146'>
            ims = grid%sm32 ; ime = grid%em32 ;<a name='147'>
            jms = grid%sm33 ; jme = grid%em33 ;<a name='148'>
<a name='149'>
            kts = grid%sp31 ; kte = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='150'></font>
            its = grid%sp32 ; ite = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='151'></font>
            jts = grid%sp33 ; jte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='152'></font>
<a name='153'>
         CASE ( DATA_ORDER_XYZ )<a name='154'>
            ids = grid%sd31 ; ide = grid%ed31 ;<a name='155'>
            jds = grid%sd32 ; jde = grid%ed32 ;<a name='156'>
            kds = grid%sd33 ; kde = grid%ed33 ;<a name='157'>
<a name='158'>
            ims = grid%sm31 ; ime = grid%em31 ;<a name='159'>
            jms = grid%sm32 ; jme = grid%em32 ;<a name='160'>
            kms = grid%sm33 ; kme = grid%em33 ;<a name='161'>
<a name='162'>
            its = grid%sp31 ; ite = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='163'></font>
            jts = grid%sp32 ; jte = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='164'></font>
            kts = grid%sp33 ; kte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='165'></font>
<a name='166'>
         CASE ( DATA_ORDER_XZY )<a name='167'>
            ids = grid%sd31 ; ide = grid%ed31 ;<a name='168'>
            kds = grid%sd32 ; kde = grid%ed32 ;<a name='169'>
            jds = grid%sd33 ; jde = grid%ed33 ;<a name='170'>
<a name='171'>
            ims = grid%sm31 ; ime = grid%em31 ;<a name='172'>
            kms = grid%sm32 ; kme = grid%em32 ;<a name='173'>
            jms = grid%sm33 ; jme = grid%em33 ;<a name='174'>
<a name='175'>
            its = grid%sp31 ; ite = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='176'></font>
            kts = grid%sp32 ; kte = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='177'></font>
            jts = grid%sp33 ; jte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='178'></font>
<a name='179'>
      END SELECT<a name='180'>
<a name='181'>
      CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_5"> ( grid%id , model_config_rec , config_flags )<a name='182'>
<a name='183'>
      <font color=#447700>!  Check to see if the boundary conditions are set properly in the namelist file.<a name='184'></font>
      <font color=#447700>!  This checks for sufficiency and redundancy.<a name='185'></font>
<a name='186'>
      CALL <A href='../../html_code/share/module_bc.F.html#BOUNDARY_CONDITION_CHECK'>boundary_condition_check</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BOUNDARY_CONDITION_CHECK_5">( config_flags, bdyzone, error, grid%id )<a name='187'>
<a name='188'>
      <font color=#447700>!  Some sort of "this is the first time" initialization.  Who knows.<a name='189'></font>
<a name='190'>
      step_number = 0<a name='191'>
      grid%itimestep=0<a name='192'>
<a name='193'>
      <font color=#447700>!  Pull in the info in the namelist to compare it to the input data.<a name='194'></font>
<a name='195'>
      real_data_init_type = model_config_rec%real_data_init_type<a name='196'>
<a name='197'>
      <font color=#447700>!  Save the TSK field for later use in the sea ice surface temperature<a name='198'></font>
      <font color=#447700>!  for the Noah LSM scheme.<a name='199'></font>
<a name='200'>
       DO j = jts, MIN(jte,jde-1)<a name='201'>
         DO i = its, MIN(ite,ide-1)<a name='202'>
            tsk_save(i,j) = tsk(i,j)<a name='203'>
         END DO<a name='204'>
      END DO<a name='205'>
<a name='206'>
      <font color=#447700>!  Take the data from the input file and store it in the variables that<a name='207'></font>
      <font color=#447700>!  use the WRF naming and ordering conventions.<a name='208'></font>
<a name='209'>
       DO j = jts, MIN(jte,jde-1)<a name='210'>
         DO i = its, MIN(ite,ide-1)<a name='211'>
            IF ( snow(i,j) .GE. 10. ) then<a name='212'>
               snowc(i,j) = 1.<a name='213'>
            ELSE<a name='214'>
               snowc(i,j) = 0.0<a name='215'>
            END IF<a name='216'>
         END DO<a name='217'>
      END DO<a name='218'>
<a name='219'>
      <font color=#447700>!  Set flag integers for presence of snowh and soilw fields<a name='220'></font>
<a name='221'>
      ifndsnowh = flag_snowh<a name='222'>
      IF (num_sw_levels_input .GE. 1) THEN<a name='223'>
         ifndsoilw = 1<a name='224'>
      ELSE<a name='225'>
         ifndsoilw = 0<a name='226'>
      END IF<a name='227'>
<a name='228'>
      <font color=#447700>!  For sf_surface_physics = 1, we want to use close to a 10 cm value<a name='229'></font>
      <font color=#447700>!  for the bottom level of the soil temps.<a name='230'></font>
<a name='231'>
      fix_bottom_level_for_temp : SELECT CASE ( model_config_rec%sf_surface_physics(grid%id) )<a name='232'>
<a name='233'>
         CASE (SLABSCHEME)<a name='234'>
            IF      ( flag_st000010 .EQ. 1 ) THEN<a name='235'>
               DO j = jts , MIN(jde-1,jte)<a name='236'>
                  DO i = its , MIN(ide-1,ite)<a name='237'>
                     tmn(i,j) = st000010(i,j)<a name='238'>
                  END DO<a name='239'>
               END DO<a name='240'>
            ELSE IF ( flag_soilt020 .EQ. 1 ) THEN<a name='241'>
               DO j = jts , MIN(jde-1,jte)<a name='242'>
                  DO i = its , MIN(ide-1,ite)<a name='243'>
                     tmn(i,j) = soilt020(i,j)<a name='244'>
                  END DO<a name='245'>
               END DO<a name='246'>
            END IF<a name='247'>
<a name='248'>
         CASE (LSMSCHEME)<a name='249'>
<a name='250'>
         CASE (RUCLSMSCHEME)<a name='251'>
<a name='252'>
      END SELECT fix_bottom_level_for_temp<a name='253'>
<a name='254'>
      <font color=#447700>!  Adjustments for the seaice field PRIOR to the TSLB computations.  This is<a name='255'></font>
      <font color=#447700>!  is for the 5-layer scheme.<a name='256'></font>
<a name='257'>
      num_veg_cat      = SIZE ( landusef , DIM=2 )<a name='258'>
      num_soil_top_cat = SIZE ( soilctop , DIM=2 )<a name='259'>
      num_soil_bot_cat = SIZE ( soilcbot , DIM=2 )<a name='260'>
      CALL nl_get_seaice_threshold ( grid%id , seaice_threshold ) <a name='261'>
      CALL nl_get_isice ( grid%id , isice )<a name='262'>
      CALL nl_get_iswater ( grid%id , iswater )<a name='263'>
      CALL <A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE'>adjust_for_seaice_pre</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_FOR_SEAICE_PRE_1"> ( xice , landmask , tsk , ivgtyp , vegcat , lu_index , &amp;<a name='264'>
                                   xland , landusef , isltyp , soilcat , soilctop , &amp;<a name='265'>
                                   soilcbot , tmn , &amp;<a name='266'>
                                   seaice_threshold , &amp;<a name='267'>
                                   num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='268'>
                                   iswater , isice , &amp;<a name='269'>
                                   model_config_rec%sf_surface_physics(grid%id) , &amp; <a name='270'>
                                   ids , ide , jds , jde , kds , kde , &amp; <a name='271'>
                                   ims , ime , jms , jme , kms , kme , &amp; <a name='272'>
                                   its , ite , jts , jte , kts , kte ) <a name='273'>
<a name='274'>
      <font color=#447700>!  surface_input_source=1 =&gt; use data from static file (fractional category as input)<a name='275'></font>
      <font color=#447700>!  surface_input_source=2 =&gt; use data from grib file (dominant category as input)<a name='276'></font>
  <a name='277'>
      IF ( config_flags%surface_input_source .EQ. 1 ) THEN<a name='278'>
         vegcat (its,jts) = 0<a name='279'>
         soilcat(its,jts) = 0<a name='280'>
      END IF<a name='281'>
<a name='282'>
      <font color=#447700>!  Generate the vegetation and soil category information from the fractional input<a name='283'></font>
      <font color=#447700>!  data, or use the existing dominant category fields if they exist.<a name='284'></font>
<a name='285'>
      IF ( ( soilcat(its,jts) .LT. 0.5 ) .AND. ( vegcat(its,jts) .LT. 0.5 ) ) THEN<a name='286'>
<a name='287'>
         num_veg_cat      = SIZE ( landusef , DIM=2 )<a name='288'>
         num_soil_top_cat = SIZE ( soilctop , DIM=2 )<a name='289'>
         num_soil_bot_cat = SIZE ( soilcbot , DIM=2 )<a name='290'>
   <a name='291'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW'>process_percent_cat_new</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PROCESS_PERCENT_CAT_NEW_1"> ( landmask , &amp;               <a name='292'>
                                    landusef , soilctop , soilcbot , &amp;<a name='293'>
                                    isltyp , ivgtyp , &amp;<a name='294'>
                                    num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='295'>
                                    ids , ide , jds , jde , kds , kde , &amp;<a name='296'>
                                    ims , ime , jms , jme , kms , kme , &amp;<a name='297'>
                                    its , ite , jts , jte , kts , kte , &amp;<a name='298'>
                                    model_config_rec%iswater(grid%id) )<a name='299'>
<a name='300'>
         <font color=#447700>!  Make all the veg/soil parms the same so as not to confuse the developer.<a name='301'></font>
<a name='302'>
         DO j = jts , MIN(jde-1,jte)<a name='303'>
            DO i = its , MIN(ide-1,ite)<a name='304'>
               vegcat(i,j)  = ivgtyp(i,j)<a name='305'>
               soilcat(i,j) = isltyp(i,j)<a name='306'>
            END DO<a name='307'>
         END DO<a name='308'>
<a name='309'>
      ELSE<a name='310'>
<a name='311'>
         <font color=#447700>!  Do we have dominant soil and veg data from the input already?<a name='312'></font>
   <a name='313'>
         IF ( soilcat(its,jts) .GT. 0.5 ) THEN<a name='314'>
            DO j = jts, MIN(jde-1,jte)<a name='315'>
               DO i = its, MIN(ide-1,ite)<a name='316'>
                  isltyp(i,j) = NINT( soilcat(i,j) )<a name='317'>
               END DO<a name='318'>
            END DO<a name='319'>
         END IF<a name='320'>
         IF ( vegcat(its,jts) .GT. 0.5 ) THEN<a name='321'>
            DO j = jts, MIN(jde-1,jte)<a name='322'>
               DO i = its, MIN(ide-1,ite)<a name='323'>
                  ivgtyp(i,j) = NINT( vegcat(i,j) )<a name='324'>
               END DO<a name='325'>
            END DO<a name='326'>
         END IF<a name='327'>
<a name='328'>
      END IF<a name='329'>
         <a name='330'>
      <font color=#447700>!  Land use assignment.<a name='331'></font>
<a name='332'>
      DO j = jts, MIN(jde-1,jte)<a name='333'>
         DO i = its, MIN(ide-1,ite)<a name='334'>
            lu_index(i,j) = ivgtyp(i,j)<a name='335'>
            IF ( lu_index(i,j) .NE. model_config_rec%iswater(grid%id) ) THEN<a name='336'>
               landmask(i,j) = 1<a name='337'>
               xland(i,j)    = 1<a name='338'>
            ELSE<a name='339'>
               landmask(i,j) = 0<a name='340'>
               xland(i,j)    = 2<a name='341'>
            END IF<a name='342'>
         END DO<a name='343'>
      END DO<a name='344'>
<a name='345'>
      <font color=#447700>!  Adjust the various soil temperature values depending on the difference in<a name='346'></font>
      <font color=#447700>!  in elevation between the current model's elevation and the incoming data's<a name='347'></font>
      <font color=#447700>!  orography.<a name='348'></font>
         <a name='349'>
      IF ( flag_toposoil .EQ. 1 ) THEN<a name='350'>
         adjust_soil : SELECT CASE ( model_config_rec%sf_surface_physics(grid%id) )<a name='351'>
<a name='352'>
            CASE ( SLABSCHEME , LSMSCHEME , RUCLSMSCHEME )<a name='353'>
               CALL <A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW'>adjust_soil_temp_new</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_SOIL_TEMP_NEW_1"> ( tmn , model_config_rec%sf_surface_physics(grid%id) , &amp;<a name='354'>
                                           tsk , ht , toposoil , landmask , flag_toposoil , &amp;<a name='355'>
                                           st000010 , st010040 , st040100 , st100200 , st010200 , &amp;<a name='356'>
                                           flag_st000010 , flag_st010040 , flag_st040100 , flag_st100200 , flag_st010200 , &amp;<a name='357'>
                                           soilt000 , soilt005 , soilt020 , soilt040 , soilt160 , soilt300 , &amp;<a name='358'>
                                           flag_soilt000 , flag_soilt005 , flag_soilt020 , flag_soilt040 , &amp;<a name='359'>
                                           flag_soilt160 , flag_soilt300 , &amp;<a name='360'>
                                           ids , ide , jds , jde , kds , kde , &amp;<a name='361'>
                                           ims , ime , jms , jme , kms , kme , &amp;<a name='362'>
                                           its , ite , jts , jte , kts , kte )<a name='363'>
<a name='364'>
         END SELECT adjust_soil<a name='365'>
      END IF<a name='366'>
<a name='367'>
      <font color=#447700>!  Fix tmn and tsk.<a name='368'></font>
<a name='369'>
      fix_tsk_tmn : SELECT CASE ( model_config_rec%sf_surface_physics(grid%id) )<a name='370'>
<a name='371'>
         CASE ( SLABSCHEME , LSMSCHEME , RUCLSMSCHEME )<a name='372'>
            DO j = jts, MIN(jde-1,jte)<a name='373'>
               DO i = its, MIN(ide-1,ite)<a name='374'>
                  IF ( ( landmask(i,j) .LT. 0.5 ) .AND. ( flag_sst .EQ. 1 ) ) THEN<a name='375'>
                     tmn(i,j) = sst(i,j)<a name='376'>
                     tsk(i,j) = sst(i,j)<a name='377'>
                  ELSE IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='378'>
                     tmn(i,j) = tsk(i,j)<a name='379'>
                  END IF<a name='380'>
               END DO<a name='381'>
            END DO<a name='382'>
      END SELECT fix_tsk_tmn<a name='383'>
    <a name='384'>
      <font color=#447700>!  Is the TSK reasonable?<a name='385'></font>
<a name='386'>
      DO j = jts, MIN(jde-1,jte)<a name='387'>
         DO i = its, MIN(ide-1,ite)<a name='388'>
            IF ( tsk(i,j) .LT. 170 .or. tsk(i,j) .GT. 400. ) THEN<a name='389'>
               print *,'error in the TSK'<a name='390'>
               print *,'i,j=',i,j<a name='391'>
               print *,'landmask=',landmask(i,j)<a name='392'>
               print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='393'>
               if(tmn(i,j).gt.170. .and. tmn(i,j).lt.400.)then<a name='394'>
                  tsk(i,j)=tmn(i,j)<a name='395'>
               else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='396'>
                  tsk(i,j)=sst(i,j)<a name='397'>
               else<a name='398'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_27"> ( 'TSK unreasonable' )<a name='399'>
               end if<a name='400'>
            END IF<a name='401'>
         END DO<a name='402'>
      END DO<a name='403'>
<a name='404'>
      <font color=#447700>!  Is the TMN reasonable?<a name='405'></font>
<a name='406'>
      DO j = jts, MIN(jde-1,jte)<a name='407'>
         DO i = its, MIN(ide-1,ite)<a name='408'>
            IF ( ( ( tmn(i,j) .LT. 170. ) .OR. ( tmn(i,j) .GT. 400. ) ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='409'>
                  print *,'error in the TMN'<a name='410'>
                  print *,'i,j=',i,j<a name='411'>
                  print *,'landmask=',landmask(i,j)<a name='412'>
                  print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='413'>
               if(tsk(i,j).gt.170. .and. tsk(i,j).lt.400.)then<a name='414'>
                  tmn(i,j)=tsk(i,j)<a name='415'>
               else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='416'>
                  tmn(i,j)=sst(i,j)<a name='417'>
               else<a name='418'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_28"> ( 'TMN unreasonable' )<a name='419'>
               endif<a name='420'>
            END IF<a name='421'>
         END DO<a name='422'>
      END DO<a name='423'>
   <a name='424'>
      interpolate_soil_tmw : SELECT CASE ( model_config_rec%sf_surface_physics(grid%id) )<a name='425'>
<a name='426'>
         CASE ( SLABSCHEME , LSMSCHEME , RUCLSMSCHEME )<a name='427'>
            CALL <A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL'>process_soil_real</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PROCESS_SOIL_REAL_1"> ( tsk , tmn , &amp;<a name='428'>
                                  landmask , sst , &amp;<a name='429'>
                                  st_input , sm_input , sw_input , st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='430'>
                                  zs , dzs , tslb , smois , sh2o , &amp;<a name='431'>
                                  flag_sst , flag_soilt000, flag_soilm000, &amp;<a name='432'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='433'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='434'>
                                  its , ite , jts , jte , kts , kte , &amp;<a name='435'>
                                  model_config_rec%sf_surface_physics(grid%id) , &amp;<a name='436'>
                                  model_config_rec%num_soil_layers , &amp;<a name='437'>
                                  model_config_rec%real_data_init_type , &amp;<a name='438'>
                                  num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='439'>
                                  num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc )<a name='440'>
<a name='441'>
      END SELECT interpolate_soil_tmw<a name='442'>
<a name='443'>
      <font color=#447700>!  Is the TSLB reasonable?<a name='444'></font>
<a name='445'>
      DO j = jts, MIN(jde-1,jte)<a name='446'>
         DO i = its, MIN(ide-1,ite)<a name='447'>
            IF ( ( ( tslb(i,1,j) .LT. 170. ) .OR. ( tslb(i,1,j) .GT. 400. ) ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='448'>
                  print *,'error in the TSLB'<a name='449'>
                  print *,'i,j=',i,j<a name='450'>
                  print *,'landmask=',landmask(i,j)<a name='451'>
                  print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='452'>
                  print *,'tslb = ',tslb(i,:,j)<a name='453'>
                  print *,'old smois = ',smois(i,:,j)<a name='454'>
                  smois(i,1,j) = 0.3<a name='455'>
                  smois(i,2,j) = 0.3<a name='456'>
                  smois(i,3,j) = 0.3<a name='457'>
                  smois(i,4,j) = 0.3<a name='458'>
                  if(tsk(i,j).gt.170. .and. tsk(i,j).lt.400.)then<a name='459'>
                     tslb(i,1,j)=tsk(i,j)<a name='460'>
                     tslb(i,2,j)=tsk(i,j)<a name='461'>
                     tslb(i,3,j)=tsk(i,j)<a name='462'>
                     tslb(i,4,j)=tsk(i,j)<a name='463'>
                  else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='464'>
                     tslb(i,1,j)=sst(i,j)<a name='465'>
                     tslb(i,2,j)=sst(i,j)<a name='466'>
                     tslb(i,3,j)=sst(i,j)<a name='467'>
                     tslb(i,4,j)=sst(i,j)<a name='468'>
                  else if(tmn(i,j).gt.170. .and. tmn(i,j).lt.400.)then<a name='469'>
                     tslb(i,1,j)=tmn(i,j)<a name='470'>
                     tslb(i,2,j)=tmn(i,j)<a name='471'>
                     tslb(i,3,j)=tmn(i,j)<a name='472'>
                     tslb(i,4,j)=tmn(i,j)<a name='473'>
                  else<a name='474'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_29"> ( 'TSLB unreasonable' )<a name='475'>
                  endif<a name='476'>
            END IF<a name='477'>
         END DO<a name='478'>
      END DO<a name='479'>
<a name='480'>
      <font color=#447700>!  Adjustments for the seaice field AFTER the TSLB computations.  This is<a name='481'></font>
      <font color=#447700>!  is for the Noah LSM scheme.<a name='482'></font>
<a name='483'>
      num_veg_cat      = SIZE ( landusef , DIM=2 )<a name='484'>
      num_soil_top_cat = SIZE ( soilctop , DIM=2 )<a name='485'>
      num_soil_bot_cat = SIZE ( soilcbot , DIM=2 )<a name='486'>
      CALL nl_get_seaice_threshold ( grid%id , seaice_threshold ) <a name='487'>
      CALL nl_get_isice ( grid%id , isice )<a name='488'>
      CALL nl_get_iswater ( grid%id , iswater )<a name='489'>
      CALL <A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST'>adjust_for_seaice_post</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_FOR_SEAICE_POST_1"> ( xice , landmask , tsk , tsk_save , ivgtyp , vegcat , lu_index , &amp;<a name='490'>
                                    xland , landusef , isltyp , soilcat , soilctop , &amp;<a name='491'>
                                    soilcbot , tmn , vegfra , &amp;<a name='492'>
                                    tslb , smois , sh2o , &amp;<a name='493'>
                                    seaice_threshold , &amp;<a name='494'>
                                    num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='495'>
                                    model_config_rec%num_soil_layers , &amp;<a name='496'>
                                    iswater , isice , &amp;<a name='497'>
                                    model_config_rec%sf_surface_physics(grid%id) , &amp; <a name='498'>
                                    ids , ide , jds , jde , kds , kde , &amp; <a name='499'>
                                    ims , ime , jms , jme , kms , kme , &amp; <a name='500'>
                                    its , ite , jts , jte , kts , kte ) <a name='501'>
<a name='502'>
      <font color=#447700>!  Let us make sure (again) that the landmask and the veg/soil categories match.<a name='503'></font>
<a name='504'>
oops1=0<a name='505'>
oops2=0<a name='506'>
      DO j = jts, MIN(jde-1,jte)<a name='507'>
         DO i = its, MIN(ide-1,ite)<a name='508'>
            IF ( ( ( landmask(i,j) .LT. 0.5 ) .AND. ( ivgtyp(i,j) .NE. config_flags%iswater .OR. isltyp(i,j) .NE. 14 ) ) .OR. &amp;<a name='509'>
                 ( ( landmask(i,j) .GT. 0.5 ) .AND. ( ivgtyp(i,j) .EQ. config_flags%iswater .OR. isltyp(i,j) .EQ. 14 ) ) ) THEN<a name='510'>
               IF ( tslb(i,1,j) .GT. 1. ) THEN<a name='511'>
oops1=oops1+1<a name='512'>
                  ivgtyp(i,j) = 5<a name='513'>
                  isltyp(i,j) = 8<a name='514'>
                  landmask(i,j) = 1<a name='515'>
                  xland(i,j) = 1<a name='516'>
               ELSE IF ( sst(i,j) .GT. 1. ) THEN<a name='517'>
oops2=oops2+1<a name='518'>
                  ivgtyp(i,j) = config_flags%iswater<a name='519'>
                  isltyp(i,j) = 14<a name='520'>
                  landmask(i,j) = 0<a name='521'>
                  xland(i,j) = 2<a name='522'>
               ELSE<a name='523'>
                  print *,'the landmask and soil/veg cats do not match'<a name='524'>
                  print *,'i,j=',i,j<a name='525'>
                  print *,'landmask=',landmask(i,j)<a name='526'>
                  print *,'ivgtyp=',ivgtyp(i,j)<a name='527'>
                  print *,'isltyp=',isltyp(i,j)<a name='528'>
                  print *,'iswater=', config_flags%iswater<a name='529'>
                  print *,'tslb=',tslb(i,:,j)<a name='530'>
                  print *,'sst=',sst(i,j)<a name='531'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_30"> ( 'mismatch_landmask_ivgtyp' )<a name='532'>
               END IF<a name='533'>
            END IF<a name='534'>
         END DO<a name='535'>
      END DO<a name='536'>
if (oops1.gt.0) then<a name='537'>
print *,'points artificially set to land : ',oops1<a name='538'>
endif<a name='539'>
if(oops2.gt.0) then<a name='540'>
print *,'points artificially set to water: ',oops2<a name='541'>
endif<a name='542'>
<a name='543'>
      <font color=#447700>!  From the full level data, we can get the half levels, reciprocals, and layer<a name='544'></font>
      <font color=#447700>!  thicknesses.  These are all defined at half level locations, so one less level.<a name='545'></font>
      <font color=#447700>!  We allow the vertical coordinate to *accidently* come in upside down.  We want<a name='546'></font>
      <font color=#447700>!  the first full level to be the ground surface.<a name='547'></font>
<a name='548'>
      <font color=#447700>!  Check whether ZNW (full level) data are truly full levels. If not, we need to adjust them<a name='549'></font>
      <font color=#447700>!  to be full levels.<a name='550'></font>
      <font color=#447700>!  in this test, we check if znw(1) is neither 0 nor 1 (within a tolerance of 10**-5)<a name='551'></font>
<a name='552'>
      were_bad = .false.<a name='553'>
      IF ( ( (znw(1).LT.(1-1.E-5) ) .OR. ( znw(1).GT.(1+1.E-5) ) ).AND. &amp;<a name='554'>
           ( (znw(1).LT.(0-1.E-5) ) .OR. ( znw(1).GT.(0+1.E-5) ) ) ) THEN<a name='555'>
         were_bad = .true.<a name='556'>
         print *,'Your ZNW input values are probably half-levels. '<a name='557'>
         print *,ZNW<a name='558'>
         print *,'WRF expects ZNW values to be full levels. '<a name='559'>
         print *,'Adjusting now to full levels...'<a name='560'>
         <font color=#447700>!  We want to ignore the first value if it's negative<a name='561'></font>
         IF (znw(1).LT.0) THEN<a name='562'>
            znw(1)=0<a name='563'>
         END IF<a name='564'>
         DO k=2,kde<a name='565'>
            znw(k)=2*znw(k)-znw(k-1)<a name='566'>
         END DO<a name='567'>
      END IF<a name='568'>
<a name='569'>
      <font color=#447700>!  Let's check our changes<a name='570'></font>
<a name='571'>
      IF ( ( ( znw(1) .LT. (1-1.E-5) ) .OR. ( znw(1) .GT. (1+1.E-5) ) ).AND. &amp;<a name='572'>
           ( ( znw(1) .LT. (0-1.E-5) ) .OR. ( znw(1) .GT. (0+1.E-5) ) ) ) THEN<a name='573'>
         print *,'The input ZNW height values were half-levels or erroneous. '<a name='574'>
         print *,'Attempts to treat the values as half-levels and change them '<a name='575'>
         print *,'to valid full levels failed.'<a name='576'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_31">("bad ZNW values from input files")<a name='577'>
      ELSE IF ( were_bad ) THEN<a name='578'>
         print *,'...adjusted. ZNW array now contains full eta level values. '<a name='579'>
      ENDIF<a name='580'>
<a name='581'>
<a name='582'>
      IF ( znw(1) .LT. znw(kde) ) THEN<a name='583'>
         DO k=1, kde/2<a name='584'>
            hold_znw = znw(k)<a name='585'>
            znw(k)=znw(kde+1-k)<a name='586'>
            znw(kde+1-k)=hold_znw<a name='587'>
         END DO<a name='588'>
      END IF<a name='589'>
<a name='590'>
      DO k=1, kde-1<a name='591'>
         dnw(k) = znw(k+1) - znw(k)<a name='592'>
         rdnw(k) = 1./dnw(k)<a name='593'>
         znu(k) = 0.5*(znw(k+1)+znw(k))<a name='594'>
      END DO<a name='595'>
<a name='596'>
      <font color=#447700>!  Now the same sort of computations with the half eta levels, even ANOTHER<a name='597'></font>
      <font color=#447700>!  level less than the one above.<a name='598'></font>
<a name='599'>
      DO k=2, kde-1<a name='600'>
         dn(k) = 0.5*(dnw(k)+dnw(k-1))<a name='601'>
         rdn(k) = 1./dn(k)<a name='602'>
         fnp(k) = .5* dnw(k  )/dn(k)<a name='603'>
         fnm(k) = .5* dnw(k-1)/dn(k)<a name='604'>
      END DO<a name='605'>
<a name='606'>
      <font color=#447700>!  Scads of vertical coefficients.<a name='607'></font>
<a name='608'>
      cof1 = (2.*dn(2)+dn(3))/(dn(2)+dn(3))*dnw(1)/dn(2) <a name='609'>
      cof2 =     dn(2)        /(dn(2)+dn(3))*dnw(1)/dn(3) <a name='610'>
<a name='611'>
      cf1  = fnp(2) + cof1<a name='612'>
      cf2  = fnm(2) - cof1 - cof2<a name='613'>
      cf3  = cof2       <a name='614'>
<a name='615'>
      cfn  = (.5*dnw(kde-1)+dn(kde-1))/dn(kde-1)<a name='616'>
      cfn1 = -.5*dnw(kde-1)/dn(kde-1)<a name='617'>
<a name='618'>
      <font color=#447700>!  Inverse grid distances.<a name='619'></font>
<a name='620'>
      rdx = 1./dx<a name='621'>
      rdy = 1./dy<a name='622'>
<a name='623'>
      <font color=#447700>!  Some of the many weird geopotential initializations that we'll see today: ph0 is total, <a name='624'></font>
      <font color=#447700>!  and ph_2 is a perturbation from the base state geopotential.  We set the base geopotential <a name='625'></font>
      <font color=#447700>!  at the lowest level to terrain elevation * gravity.<a name='626'></font>
<a name='627'>
      DO j=jts,jte<a name='628'>
         DO i=its,ite<a name='629'>
            ph0(i,1,j) = ht(i,j) * g<a name='630'>
            ph_2(i,1,j) = 0.<a name='631'>
         END DO<a name='632'>
      END DO<a name='633'>
<a name='634'>
      <font color=#447700>!  To define the base state, we call a USER MODIFIED routine to set the three<a name='635'></font>
      <font color=#447700>!  necessary constants:  p00 (sea level pressure, Pa), t00 (sea level temperature, K), <a name='636'></font>
      <font color=#447700>!  and A (temperature difference, from 1000 mb to 300 mb, K).<a name='637'></font>
<a name='638'>
      CALL <A href='../../html_code/dyn_em/module_initialize_real.F.html#CONST_MODULE_INITIALIZE'>const_module_initialize</A><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONST_MODULE_INITIALIZE_1"> ( p00 , t00 , a ) <a name='639'>
<a name='640'>
      <font color=#447700>!  Base state potential temperature and inverse density (alpha = 1/rho) from<a name='641'></font>
      <font color=#447700>!  the half eta levels and the base-profile surface pressure.  Compute 1/rho <a name='642'></font>
      <font color=#447700>!  from equation of state.  The potential temperature is a perturbation from t0.<a name='643'></font>
<a name='644'>
      DO j = jts, MIN(jte,jde-1)<a name='645'>
         DO i = its, MIN(ite,ide-1)<a name='646'>
<a name='647'>
            <font color=#447700>!  Base state pressure is a function of eta level and terrain, only, plus<a name='648'></font>
            <font color=#447700>!  the hand full of constants: p00 (sea level pressure, Pa), t00 (sea level<a name='649'></font>
            <font color=#447700>!  temperature, K), and A (temperature difference, from 1000 mb to 300 mb, K).<a name='650'></font>
<a name='651'>
            p_surf = p00 * EXP ( -t00/a + ( (t00/a)**2 - 2.*g*ht(i,j)/a/r_d ) **0.5 ) <a name='652'>
<a name='653'>
<a name='654'>
            DO k = 1, kte-1<a name='655'>
               pb(i,k,j) = znu(k)*(p_surf - p_top) + p_top<a name='656'>
               t_init(i,k,j) = (t00 + A*LOG(pb(i,k,j)/p00))*(p00/pb(i,k,j))**(r_d/cp) - t0<a name='657'>
               alb(i,k,j) = (r_d/p1000mb)*(t_init(i,k,j)+t0)*(pb(i,k,j)/p1000mb)**cvpm<a name='658'>
            END DO<a name='659'>
       <a name='660'>
            <font color=#447700>!  Base state mu is defined as base state surface pressure minus p_top<a name='661'></font>
<a name='662'>
            mub(i,j) = p_surf - p_top<a name='663'>
       <a name='664'>
            <font color=#447700>!  Dry surface pressure is defined as the following (this mu is from the input file<a name='665'></font>
            <font color=#447700>!  computed from the dry pressure).  Here the dry pressure is just reconstituted.<a name='666'></font>
<a name='667'>
            pd_surf = mu0(i,j) + p_top<a name='668'>
       <a name='669'>
            <font color=#447700>!  Compute the perturbation mass and the full mass from the base surface pressure<a name='670'></font>
            <font color=#447700>!  (a function of elevation) and the dry surface pressure.<a name='671'></font>
       <a name='672'>
            mu_2(i,j) = pd_surf-p_surf<a name='673'>
<a name='674'>
            <font color=#447700>!  Integrate base geopotential, starting at terrain elevation.  This assures that <a name='675'></font>
            <font color=#447700>!  the base state is in exact hydrostatic balance with respect to the model equations.<a name='676'></font>
            <font color=#447700>!  This field is on full levels.<a name='677'></font>
<a name='678'>
            phb(i,1,j) = ht(i,j) * g<a name='679'>
            DO k  = 2,kte<a name='680'>
               phb(i,k,j) = phb(i,k-1,j) - dnw(k-1)*mub(i,j)*alb(i,k-1,j)<a name='681'>
            END DO<a name='682'>
         END DO<a name='683'>
      END DO<a name='684'>
<a name='685'>
      <font color=#447700>!  Fill in the outer rows and columns to allow us to be sloppy.<a name='686'></font>
<a name='687'>
      IF ( ite .EQ. ide ) THEN<a name='688'>
      i = ide<a name='689'>
      DO j = jts, MIN(jde-1,jte)<a name='690'>
         mub(i,j) = mub(i-1,j)<a name='691'>
         mu_2(i,j) = mu_2(i-1,j)<a name='692'>
         DO k = 1, kte-1<a name='693'>
            pb(i,k,j) = pb(i-1,k,j)<a name='694'>
            t_init(i,k,j) = t_init(i-1,k,j)<a name='695'>
            alb(i,k,j) = alb(i-1,k,j)<a name='696'>
         END DO<a name='697'>
         DO k = 1, kte<a name='698'>
            phb(i,k,j) = phb(i-1,k,j)<a name='699'>
         END DO<a name='700'>
      END DO<a name='701'>
      END IF<a name='702'>
<a name='703'>
      IF ( jte .EQ. jde ) THEN<a name='704'>
      j = jde<a name='705'>
      DO i = its, ite<a name='706'>
         mub(i,j) = mub(i,j-1)<a name='707'>
         mu_2(i,j) = mu_2(i,j-1)<a name='708'>
         DO k = 1, kte-1<a name='709'>
            pb(i,k,j) = pb(i,k,j-1)<a name='710'>
            t_init(i,k,j) = t_init(i,k,j-1)<a name='711'>
            alb(i,k,j) = alb(i,k,j-1)<a name='712'>
         END DO<a name='713'>
         DO k = 1, kte<a name='714'>
            phb(i,k,j) = phb(i,k,j-1)<a name='715'>
         END DO<a name='716'>
      END DO<a name='717'>
      END IF<a name='718'>
<a name='719'>
      DO j = jts, min(jde-1,jte)<a name='720'>
         DO i = its, min(ide-1,ite)<a name='721'>
<a name='722'>
            <font color=#447700>!  Assign the potential temperature (perturbation from t0) and qv on all the mass<a name='723'></font>
            <font color=#447700>!  point locations.<a name='724'></font>
<a name='725'>
            DO k =  1 , kde-1<a name='726'>
               t_2(i,k,j)          = t_2(i,k,j) - t0<a name='727'>
            END DO<a name='728'>
      <a name='729'>
            <font color=#447700>!  Integrate the hydrostatic equation (from the RHS of the bigstep vertical momentum <a name='730'></font>
            <font color=#447700>!  equation) down from the top to get the pressure perturbation.  First get the pressure<a name='731'></font>
            <font color=#447700>!  perturbation, moisture, and inverse density (total and perturbation) at the top-most level.<a name='732'></font>
      <a name='733'>
            k = kte-1<a name='734'>
      <a name='735'>
            qvf1 = 0.5*(moist_2(i,k,j,P_QV)+moist_2(i,k,j,P_QV))<a name='736'>
            qvf2 = 1./(1.+qvf1)<a name='737'>
            qvf1 = qvf1*qvf2<a name='738'>
      <a name='739'>
            p(i,k,j) = - 0.5*(mu_2(i,j)+qvf1*mub(i,j))/rdnw(k)/qvf2<a name='740'>
            qvf = 1. + rvovrd*moist_2(i,k,j,P_QV)<a name='741'>
            alt(i,k,j) = (r_d/p1000mb)*(t_2(i,k,j)+t0)*qvf*(((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm)<a name='742'>
            al(i,k,j) = alt(i,k,j) - alb(i,k,j)<a name='743'>
      <a name='744'>
            <font color=#447700>!  Now, integrate down the column to compute the pressure perturbation, and diagnose the two<a name='745'></font>
            <font color=#447700>!  inverse density fields (total and perturbation).<a name='746'></font>
      <a name='747'>
            DO k=kte-2,1,-1<a name='748'>
               qvf1 = 0.5*(moist_2(i,k,j,P_QV)+moist_2(i,k+1,j,P_QV))<a name='749'>
               qvf2 = 1./(1.+qvf1)<a name='750'>
               qvf1 = qvf1*qvf2<a name='751'>
               p(i,k,j) = p(i,k+1,j) - (mu_2(i,j) + qvf1*mub(i,j))/qvf2/rdn(k+1)<a name='752'>
               qvf = 1. + rvovrd*moist_2(i,k,j,P_QV)<a name='753'>
               alt(i,k,j) = (r_d/p1000mb)*(t_2(i,k,j)+t0)*qvf* &amp;<a name='754'>
                           (((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm)<a name='755'>
               al(i,k,j) = alt(i,k,j) - alb(i,k,j)<a name='756'>
            END DO<a name='757'>
      <a name='758'>
            <font color=#447700>!  This is the hydrostatic equation used in the model after the small timesteps.  In <a name='759'></font>
            <font color=#447700>!  the model, al (inverse density) is computed from the geopotential.<a name='760'></font>
      <a name='761'>
            DO k  = 2,kte<a name='762'>
               ph_2(i,k,j) = ph_2(i,k-1,j) - &amp;<a name='763'>
                             dnw(k-1) * ( (mub(i,j)+mu_2(i,j))*al(i,k-1,j) + mu_2(i,j)*alb(i,k-1,j) )<a name='764'>
               ph0(i,k,j) = ph_2(i,k,j) + phb(i,k,j)<a name='765'>
            END DO<a name='766'>
       <a name='767'>
         END DO<a name='768'>
      END DO<a name='769'>
<a name='770'>
      DO j = jts, min(jde-1,jte)<a name='771'>
         DO i = its, min(ide,ite)<a name='772'>
            u10(i,j)=u_2(i,1,j)<a name='773'>
         END DO<a name='774'>
      END DO<a name='775'>
<a name='776'>
      DO j = jts, min(jde,jte)<a name='777'>
         DO i = its, min(ide-1,ite)<a name='778'>
            v10(i,j)=v_2(i,1,j)<a name='779'>
         END DO<a name='780'>
      END DO<a name='781'>
<a name='782'>
      DO j = jts, min(jde-1,jte)<a name='783'>
         DO i = its, min(ide-1,ite)<a name='784'>
            p_surf = p00 * EXP ( -t00/a + ( (t00/a)**2 - 2.*g*ht(i,j)/a/r_d ) **0.5 ) <a name='785'>
            psfc(i,j)=p_surf + p(i,1,j)<a name='786'>
            q2(i,j)=moist_2(i,1,j,P_QV)<a name='787'>
            th2(i,j)=t_2(i,1,j)+300.<a name='788'>
            t2(i,j)=th2(i,j)*(((p(i,1,j)+pb(i,1,j))/p00)**(r_d/cp))<a name='789'>
         END DO<a name='790'>
      END DO<a name='791'>
<a name='792'>
      ips = its ; ipe = ite ; jps = jts ; jpe = jte ; kps = kts ; kpe = kte<a name='793'>
#ifdef DM_PARALLEL<a name='794'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_1.inc.html'>HALO_EM_INIT_1.inc</A>"<A NAME="HALO_EM_INIT_1.inc_8"><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='795'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_2.inc.html'>HALO_EM_INIT_2.inc</A>"<A NAME="HALO_EM_INIT_2.inc_9"><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='796'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_3.inc.html'>HALO_EM_INIT_3.inc</A>"<A NAME="HALO_EM_INIT_3.inc_10"><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='797'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_4.inc.html'>HALO_EM_INIT_4.inc</A>"<A NAME="HALO_EM_INIT_4.inc_11"><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='798'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_5.inc.html'>HALO_EM_INIT_5.inc</A>"<A NAME="HALO_EM_INIT_5.inc_12"><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='799'>
#endif<a name='800'>
<a name='801'>
#define COPY_OUT<a name='802'>
#include &lt;<A href='../../html_code/include/em_scalar_derefs.inc.html'>em_scalar_derefs.inc</A>&gt;<A NAME="em_scalar_derefs.inc_13"><A href='../../html_code/dyn_em/module_initialize_squall2d_y.F.html#INIT_DOMAIN_RK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='803'>
      RETURN<a name='804'>
<a name='805'>
   END SUBROUTINE init_domain_rk<a name='806'>
<a name='807'>
<font color=#447700>!---------------------------------------------------------------------<a name='808'></font>
<a name='809'>
<A NAME='CONST_MODULE_INITIALIZE'><A href='../../html_code/dyn_em/module_initialize_real.F.html#CONST_MODULE_INITIALIZE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='810'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>const_module_initialize</font> ( p00 , t00 , a )  <A href='../../call_to/CONST_MODULE_INITIALIZE.html' TARGET='index'>2</A>,<A href='../../call_from/CONST_MODULE_INITIALIZE.html' TARGET='index'>1</A><a name='811'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_initialize_real.F.html#CONST_MODULE_INITIALIZE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_19"><a name='812'>
      IMPLICIT NONE<a name='813'>
      <font color=#447700>!  For the real-data-cases only.<a name='814'></font>
      REAL , INTENT(OUT) :: p00 , t00 , a<a name='815'>
      CALL nl_get_base_pres  ( 1 , p00 )<a name='816'>
      CALL nl_get_base_temp  ( 1 , t00 )<a name='817'>
      CALL nl_get_base_lapse ( 1 , a   )<a name='818'>
   END SUBROUTINE const_module_initialize<a name='819'>
<a name='820'>
<font color=#447700>!-------------------------------------------------------------------<a name='821'></font>
<a name='822'>
<A NAME='REBALANCE_DRIVER'><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='823'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>rebalance_driver</font> ( grid )  <A href='../../call_to/REBALANCE_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/REBALANCE_DRIVER.html' TARGET='index'>1</A><a name='824'>
<a name='825'>
      IMPLICIT NONE<a name='826'>
<a name='827'>
      TYPE (domain)          :: grid <a name='828'>
<a name='829'>
#ifdef DEREF_KLUDGE<a name='830'>
<font color=#447700>!  see http://www2.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='831'></font>
      INTEGER     :: sm31 , em31 , sm32 , em32 , sm33 , em33<a name='832'>
      INTEGER     :: sm31x, em31x, sm32x, em32x, sm33x, em33x<a name='833'>
      INTEGER     :: sm31y, em31y, sm32y, em32y, sm33y, em33y<a name='834'>
#endif<a name='835'>
<a name='836'>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_14"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='837'>
<a name='838'>
      CALL <A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE'>rebalance</A><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REBALANCE_1">( grid, &amp;<a name='839'>
<font color=#447700>!<a name='840'></font>
#include &lt;<A href='../../html_code/include/em_actual_args.inc.html'>em_actual_args.inc</A>&gt;<A NAME="em_actual_args.inc_15"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='841'>
<font color=#447700>!<a name='842'></font>
      )<a name='843'>
<a name='844'>
   END SUBROUTINE rebalance_driver<a name='845'>
<a name='846'>
<font color=#447700>!---------------------------------------------------------------------<a name='847'></font>
<a name='848'>
<A NAME='REBALANCE'><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='849'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>rebalance</font> ( grid , &amp; <A href='../../call_to/REBALANCE.html' TARGET='index'>1</A>,<A href='../../call_from/REBALANCE.html' TARGET='index'>1</A><a name='850'>
<font color=#447700>!<a name='851'></font>
#include &lt;<A href='../../html_code/include/em_dummy_args.inc.html'>em_dummy_args.inc</A>&gt;<A NAME="em_dummy_args.inc_16"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='852'>
<font color=#447700>!<a name='853'></font>
                        )<a name='854'>
      IMPLICIT NONE<a name='855'>
<a name='856'>
      TYPE (domain)          :: grid<a name='857'>
<a name='858'>
#include &lt;<A href='../../html_code/include/em_dummy_decl.inc.html'>em_dummy_decl.inc</A>&gt;<A NAME="em_dummy_decl.inc_17"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='859'>
<a name='860'>
      TYPE (grid_config_rec_type)              :: config_flags<a name='861'>
<a name='862'>
      REAL :: p_surf ,  pd_surf, p_surf_int , pb_int , ht_hold<a name='863'>
      REAL :: qvf , qvf1 , qvf2<a name='864'>
      REAL :: p00 , t00 , a<a name='865'>
      REAL , DIMENSION(:,:,:) , ALLOCATABLE :: t_init_int<a name='866'>
<a name='867'>
      <font color=#447700>!  Local domain indices and counters.<a name='868'></font>
<a name='869'>
      INTEGER :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='870'>
<a name='871'>
      INTEGER                             ::                       &amp;<a name='872'>
                                     ids, ide, jds, jde, kds, kde, &amp;<a name='873'>
                                     ims, ime, jms, jme, kms, kme, &amp;<a name='874'>
                                     its, ite, jts, jte, kts, kte, &amp;<a name='875'>
                                     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='876'>
                                     i, j, k<a name='877'>
<a name='878'>
#ifdef DEREF_KLUDGE<a name='879'>
<font color=#447700>!  see http://www2.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='880'></font>
      INTEGER     :: sm31 , em31 , sm32 , em32 , sm33 , em33<a name='881'>
      INTEGER     :: sm31x, em31x, sm32x, em32x, sm33x, em33x<a name='882'>
      INTEGER     :: sm31y, em31y, sm32y, em32y, sm33y, em33y<a name='883'>
#endif<a name='884'>
<a name='885'>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_18"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='886'>
<a name='887'>
#define COPY_IN<a name='888'>
#include &lt;<A href='../../html_code/include/em_scalar_derefs.inc.html'>em_scalar_derefs.inc</A>&gt;<A NAME="em_scalar_derefs.inc_19"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='889'>
#ifdef DM_PARALLEL<a name='890'>
#    include &lt;<A href='../../html_code/include/em_data_calls.inc.html'>em_data_calls.inc</A>&gt;<A NAME="em_data_calls.inc_20"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='891'>
#endif<a name='892'>
<a name='893'>
      SELECT CASE ( model_data_order )<a name='894'>
         CASE ( DATA_ORDER_ZXY )<a name='895'>
            kds = grid%sd31 ; kde = grid%ed31 ;<a name='896'>
            ids = grid%sd32 ; ide = grid%ed32 ;<a name='897'>
            jds = grid%sd33 ; jde = grid%ed33 ;<a name='898'>
<a name='899'>
            kms = grid%sm31 ; kme = grid%em31 ;<a name='900'>
            ims = grid%sm32 ; ime = grid%em32 ;<a name='901'>
            jms = grid%sm33 ; jme = grid%em33 ;<a name='902'>
<a name='903'>
            kts = grid%sp31 ; kte = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='904'></font>
            its = grid%sp32 ; ite = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='905'></font>
            jts = grid%sp33 ; jte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='906'></font>
<a name='907'>
         CASE ( DATA_ORDER_XYZ )<a name='908'>
            ids = grid%sd31 ; ide = grid%ed31 ;<a name='909'>
            jds = grid%sd32 ; jde = grid%ed32 ;<a name='910'>
            kds = grid%sd33 ; kde = grid%ed33 ;<a name='911'>
<a name='912'>
            ims = grid%sm31 ; ime = grid%em31 ;<a name='913'>
            jms = grid%sm32 ; jme = grid%em32 ;<a name='914'>
            kms = grid%sm33 ; kme = grid%em33 ;<a name='915'>
<a name='916'>
            its = grid%sp31 ; ite = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='917'></font>
            jts = grid%sp32 ; jte = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='918'></font>
            kts = grid%sp33 ; kte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='919'></font>
<a name='920'>
         CASE ( DATA_ORDER_XZY )<a name='921'>
            ids = grid%sd31 ; ide = grid%ed31 ;<a name='922'>
            kds = grid%sd32 ; kde = grid%ed32 ;<a name='923'>
            jds = grid%sd33 ; jde = grid%ed33 ;<a name='924'>
<a name='925'>
            ims = grid%sm31 ; ime = grid%em31 ;<a name='926'>
            kms = grid%sm32 ; kme = grid%em32 ;<a name='927'>
            jms = grid%sm33 ; jme = grid%em33 ;<a name='928'>
<a name='929'>
            its = grid%sp31 ; ite = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='930'></font>
            kts = grid%sp32 ; kte = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='931'></font>
            jts = grid%sp33 ; jte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='932'></font>
<a name='933'>
      END SELECT<a name='934'>
<a name='935'>
      ALLOCATE ( t_init_int(ims:ime,kms:kme,jms:jme) )<a name='936'>
<a name='937'>
      <font color=#447700>!  Some of the many weird geopotential initializations that we'll see today: ph0 is total, <a name='938'></font>
      <font color=#447700>!  and ph_2 is a perturbation from the base state geopotential.  We set the base geopotential <a name='939'></font>
      <font color=#447700>!  at the lowest level to terrain elevation * gravity.<a name='940'></font>
<a name='941'>
      DO j=jts,jte<a name='942'>
         DO i=its,ite<a name='943'>
            ph0(i,1,j) = ht_fine(i,j) * g<a name='944'>
            ph_2(i,1,j) = 0.<a name='945'>
         END DO<a name='946'>
      END DO<a name='947'>
<a name='948'>
      <font color=#447700>!  To define the base state, we call a USER MODIFIED routine to set the three<a name='949'></font>
      <font color=#447700>!  necessary constants:  p00 (sea level pressure, Pa), t00 (sea level temperature, K), <a name='950'></font>
      <font color=#447700>!  and A (temperature difference, from 1000 mb to 300 mb, K).<a name='951'></font>
<a name='952'>
      CALL <A href='../../html_code/dyn_em/module_initialize_real.F.html#CONST_MODULE_INITIALIZE'>const_module_initialize</A><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONST_MODULE_INITIALIZE_2"> ( p00 , t00 , a ) <a name='953'>
<a name='954'>
      <font color=#447700>!  Base state potential temperature and inverse density (alpha = 1/rho) from<a name='955'></font>
      <font color=#447700>!  the half eta levels and the base-profile surface pressure.  Compute 1/rho <a name='956'></font>
      <font color=#447700>!  from equation of state.  The potential temperature is a perturbation from t0.<a name='957'></font>
<a name='958'>
      DO j = jts, MIN(jte,jde-1)<a name='959'>
         DO i = its, MIN(ite,ide-1)<a name='960'>
<a name='961'>
            <font color=#447700>!  Base state pressure is a function of eta level and terrain, only, plus<a name='962'></font>
            <font color=#447700>!  the hand full of constants: p00 (sea level pressure, Pa), t00 (sea level<a name='963'></font>
            <font color=#447700>!  temperature, K), and A (temperature difference, from 1000 mb to 300 mb, K).<a name='964'></font>
            <font color=#447700>!  The fine grid terrain is ht_fine, the interpolated is ht.<a name='965'></font>
<a name='966'>
            p_surf     = p00 * EXP ( -t00/a + ( (t00/a)**2 - 2.*g*ht_fine(i,j)/a/r_d ) **0.5 ) <a name='967'>
            p_surf_int = p00 * EXP ( -t00/a + ( (t00/a)**2 - 2.*g*ht(i,j)     /a/r_d ) **0.5 ) <a name='968'>
<a name='969'>
            DO k = 1, kte-1<a name='970'>
               pb(i,k,j) = znu(k)*(p_surf     - p_top) + p_top<a name='971'>
               pb_int    = znu(k)*(p_surf_int - p_top) + p_top<a name='972'>
               t_init(i,k,j)    = (t00 + A*LOG(pb(i,k,j)/p00))*(p00/pb(i,k,j))**(r_d/cp) - t0<a name='973'>
               t_init_int(i,k,j)= (t00 + A*LOG(pb_int   /p00))*(p00/pb_int   )**(r_d/cp) - t0<a name='974'>
               alb(i,k,j) = (r_d/p1000mb)*(t_init(i,k,j)+t0)*(pb(i,k,j)/p1000mb)**cvpm<a name='975'>
            END DO<a name='976'>
       <a name='977'>
            <font color=#447700>!  Base state mu is defined as base state surface pressure minus p_top<a name='978'></font>
<a name='979'>
            mub(i,j) = p_surf - p_top<a name='980'>
       <a name='981'>
            <font color=#447700>!  Dry surface pressure is defined as the following (this mu is from the input file<a name='982'></font>
            <font color=#447700>!  computed from the dry pressure).  Here the dry pressure is just reconstituted.<a name='983'></font>
<a name='984'>
            pd_surf = ( mub(i,j) + mu_2(i,j) ) + p_top<a name='985'>
       <a name='986'>
            <font color=#447700>!  Integrate base geopotential, starting at terrain elevation.  This assures that <a name='987'></font>
            <font color=#447700>!  the base state is in exact hydrostatic balance with respect to the model equations.<a name='988'></font>
            <font color=#447700>!  This field is on full levels.<a name='989'></font>
<a name='990'>
            phb(i,1,j) = ht_fine(i,j) * g<a name='991'>
            DO k  = 2,kte<a name='992'>
               phb(i,k,j) = phb(i,k-1,j) - dnw(k-1)*mub(i,j)*alb(i,k-1,j)<a name='993'>
            END DO<a name='994'>
         END DO<a name='995'>
      END DO<a name='996'>
<a name='997'>
      <font color=#447700>!  Replace interpolated terrain with fine grid values.<a name='998'></font>
<a name='999'>
      DO j = jts, MIN(jte,jde-1)<a name='1000'>
         DO i = its, MIN(ite,ide-1)<a name='1001'>
            ht(i,j) = ht_fine(i,j)<a name='1002'>
         END DO<a name='1003'>
      END DO<a name='1004'>
<a name='1005'>
      <font color=#447700>!  Perturbation fields.<a name='1006'></font>
<a name='1007'>
      DO j = jts, min(jde-1,jte)<a name='1008'>
         DO i = its, min(ide-1,ite)<a name='1009'>
<a name='1010'>
            <font color=#447700>!  The potential temperature is THETAnest = THETAinterp + ( TBARnest - TBARinterp)<a name='1011'></font>
<a name='1012'>
            DO k =  1 , kde-1<a name='1013'>
               t_2(i,k,j) = t_2(i,k,j) + ( t_init(i,k,j) - t_init_int(i,k,j) ) <a name='1014'>
            END DO<a name='1015'>
      <a name='1016'>
            <font color=#447700>!  Integrate the hydrostatic equation (from the RHS of the bigstep vertical momentum <a name='1017'></font>
            <font color=#447700>!  equation) down from the top to get the pressure perturbation.  First get the pressure<a name='1018'></font>
            <font color=#447700>!  perturbation, moisture, and inverse density (total and perturbation) at the top-most level.<a name='1019'></font>
      <a name='1020'>
            k = kte-1<a name='1021'>
      <a name='1022'>
            qvf1 = 0.5*(moist_2(i,k,j,P_QV)+moist_2(i,k,j,P_QV))<a name='1023'>
            qvf2 = 1./(1.+qvf1)<a name='1024'>
            qvf1 = qvf1*qvf2<a name='1025'>
      <a name='1026'>
            p(i,k,j) = - 0.5*(mu_2(i,j)+qvf1*mub(i,j))/rdnw(k)/qvf2<a name='1027'>
            qvf = 1. + rvovrd*moist_2(i,k,j,P_QV)<a name='1028'>
            alt(i,k,j) = (r_d/p1000mb)*(t_2(i,k,j)+t0)*qvf*(((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm)<a name='1029'>
            al(i,k,j) = alt(i,k,j) - alb(i,k,j)<a name='1030'>
      <a name='1031'>
            <font color=#447700>!  Now, integrate down the column to compute the pressure perturbation, and diagnose the two<a name='1032'></font>
            <font color=#447700>!  inverse density fields (total and perturbation).<a name='1033'></font>
      <a name='1034'>
            DO k=kte-2,1,-1<a name='1035'>
               qvf1 = 0.5*(moist_2(i,k,j,P_QV)+moist_2(i,k+1,j,P_QV))<a name='1036'>
               qvf2 = 1./(1.+qvf1)<a name='1037'>
               qvf1 = qvf1*qvf2<a name='1038'>
               p(i,k,j) = p(i,k+1,j) - (mu_2(i,j) + qvf1*mub(i,j))/qvf2/rdn(k+1)<a name='1039'>
               qvf = 1. + rvovrd*moist_2(i,k,j,P_QV)<a name='1040'>
               alt(i,k,j) = (r_d/p1000mb)*(t_2(i,k,j)+t0)*qvf* &amp;<a name='1041'>
                           (((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm)<a name='1042'>
               al(i,k,j) = alt(i,k,j) - alb(i,k,j)<a name='1043'>
            END DO<a name='1044'>
      <a name='1045'>
            <font color=#447700>!  This is the hydrostatic equation used in the model after the small timesteps.  In <a name='1046'></font>
            <font color=#447700>!  the model, al (inverse density) is computed from the geopotential.<a name='1047'></font>
      <a name='1048'>
            DO k  = 2,kte<a name='1049'>
               ph_2(i,k,j) = ph_2(i,k-1,j) - &amp;<a name='1050'>
                             dnw(k-1) * ( (mub(i,j)+mu_2(i,j))*al(i,k-1,j) + mu_2(i,j)*alb(i,k-1,j) )<a name='1051'>
               ph0(i,k,j) = ph_2(i,k,j) + phb(i,k,j)<a name='1052'>
            END DO<a name='1053'>
       <a name='1054'>
         END DO<a name='1055'>
      END DO<a name='1056'>
<a name='1057'>
      DEALLOCATE ( t_init_int ) <a name='1058'>
<a name='1059'>
      ips = its ; ipe = ite ; jps = jts ; jpe = jte ; kps = kts ; kpe = kte<a name='1060'>
#ifdef DM_PARALLEL<a name='1061'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_1.inc.html'>HALO_EM_INIT_1.inc</A>"<A NAME="HALO_EM_INIT_1.inc_21"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1062'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_2.inc.html'>HALO_EM_INIT_2.inc</A>"<A NAME="HALO_EM_INIT_2.inc_22"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1063'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_3.inc.html'>HALO_EM_INIT_3.inc</A>"<A NAME="HALO_EM_INIT_3.inc_23"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1064'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_4.inc.html'>HALO_EM_INIT_4.inc</A>"<A NAME="HALO_EM_INIT_4.inc_24"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1065'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_5.inc.html'>HALO_EM_INIT_5.inc</A>"<A NAME="HALO_EM_INIT_5.inc_25"><A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1066'>
#endif<a name='1067'>
   END SUBROUTINE rebalance<a name='1068'>
<a name='1069'>
<font color=#447700>!---------------------------------------------------------------------<a name='1070'></font>
<a name='1071'>
<A NAME='INIT_MODULE_INITIALIZE'><A href='../../html_code/dyn_em/module_initialize_real.F.html#INIT_MODULE_INITIALIZE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1072'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_module_initialize</font>,<A href='../../call_from/INIT_MODULE_INITIALIZE.html' TARGET='index'>8</A><a name='1073'>
   END SUBROUTINE init_module_initialize<a name='1074'>
<a name='1075'>
<font color=#447700>!---------------------------------------------------------------------<a name='1076'></font>
<a name='1077'>
END MODULE module_initialize<a name='1078'>
</pre></body></html>