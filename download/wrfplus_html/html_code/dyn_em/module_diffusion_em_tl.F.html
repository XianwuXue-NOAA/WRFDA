<HTML> <BODY BGCOLOR=#cceeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!                           DISCLAIMER<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!   This file was generated by TAF version 1.7.18<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>!   FASTOPT DISCLAIMS  ALL  WARRANTIES,  EXPRESS  OR  IMPLIED,<a name='6'></font>
<font color=#447700>!   INCLUDING (WITHOUT LIMITATION) ALL IMPLIED  WARRANTIES  OF<a name='7'></font>
<font color=#447700>!   MERCHANTABILITY  OR FITNESS FOR A PARTICULAR PURPOSE, WITH<a name='8'></font>
<font color=#447700>!   RESPECT TO THE SOFTWARE AND USER PROGRAMS.   IN  NO  EVENT<a name='9'></font>
<font color=#447700>!   SHALL  FASTOPT BE LIABLE FOR ANY LOST OR ANTICIPATED PROF-<a name='10'></font>
<font color=#447700>!   ITS, OR ANY INDIRECT, INCIDENTAL, EXEMPLARY,  SPECIAL,  OR<a name='11'></font>
<font color=#447700>!   CONSEQUENTIAL  DAMAGES, WHETHER OR NOT FASTOPT WAS ADVISED<a name='12'></font>
<font color=#447700>!   OF THE POSSIBILITY OF SUCH DAMAGES.<a name='13'></font>
<font color=#447700>!<a name='14'></font>
<font color=#447700>!                           Haftungsbeschraenkung<a name='15'></font>
<font color=#447700>!   FastOpt gibt ausdruecklich keine Gewaehr, explizit oder indirekt,<a name='16'></font>
<font color=#447700>!   bezueglich der Brauchbarkeit  der Software  fuer einen bestimmten<a name='17'></font>
<font color=#447700>!   Zweck.   Unter  keinen  Umstaenden   ist  FastOpt   haftbar  fuer<a name='18'></font>
<font color=#447700>!   irgendeinen Verlust oder nicht eintretenden erwarteten Gewinn und<a name='19'></font>
<font color=#447700>!   allen indirekten,  zufaelligen,  exemplarischen  oder  speziellen<a name='20'></font>
<font color=#447700>!   Schaeden  oder  Folgeschaeden  unabhaengig  von einer eventuellen<a name='21'></font>
<font color=#447700>!   Mitteilung darueber an FastOpt.<a name='22'></font>
<font color=#447700>!<a name='23'></font>
<A NAME='G_MODULE_DIFFUSION_EM'><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_MODULE_DIFFUSION_EM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='24'>
<font color=#993300>module     </font><font color=#cc0000>g_module_diffusion_em</font> <A href='../../call_to/G_MODULE_DIFFUSION_EM.html' TARGET='index'>3</A><a name='25'>
<font color=#447700>!******************************************************************<a name='26'></font>
<font color=#447700>!******************************************************************<a name='27'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='28'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='29'></font>
<font color=#447700>!******************************************************************<a name='30'></font>
<font color=#447700>!******************************************************************<a name='31'></font>
<font color=#447700>!==============================================<a name='32'></font>
<font color=#447700>! referencing used modules<a name='33'></font>
<font color=#447700>!==============================================<a name='34'></font>
use <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#module_diffusion_em_tl.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_13"><a name='35'>
use <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#module_diffusion_em_tl.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_12"><a name='36'>
use <A href='../../html_code/dyn_em/module_bc_tl.F.html#G_MODULE_BC'>g_module_bc</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#module_diffusion_em_tl.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_MODULE_BC_3"><a name='37'>
use module_state_description<a name='38'>
use <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#module_diffusion_em_tl.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_7"><a name='39'>
use <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_MODULE_BIG_STEP_UTILITIES_EM'>g_module_big_step_utilities_em</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#module_diffusion_em_tl.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_MODULE_BIG_STEP_UTILITIES_EM_2"><a name='40'>
use <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#module_diffusion_em_tl.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_9"><a name='41'>
use <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#module_diffusion_em_tl.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_11"><a name='42'>
use <A href='../../html_code/dyn_em/module_diffusion_em.F.html#MODULE_DIFFUSION_EM'>module_diffusion_em</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#module_diffusion_em_tl.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DIFFUSION_EM_2"><a name='43'>
<a name='44'>
<font color=#447700>!==============================================<a name='45'></font>
<font color=#447700>! all entries are defined explicitly<a name='46'></font>
<font color=#447700>!==============================================<a name='47'></font>
implicit none<a name='48'>
<a name='49'>
contains<a name='50'>
<A NAME='G_CAL_DAMPKM'><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CAL_DAMPKM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='51'>
<font color=#993300>subroutine </font><font color=#cc0000>g_cal_dampkm</font>( xkmhd, g_xkmhd, xkmh, xkhh, xkmv, xkhv, dx, dt, dampcoef, rdz, rdzw, zdamp, ide, jde, kde, ims, ime, jms, &amp; <A href='../../call_to/G_CAL_DAMPKM.html' TARGET='index'>1</A><a name='52'>
&amp;jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='53'>
<font color=#447700>!******************************************************************<a name='54'></font>
<font color=#447700>!******************************************************************<a name='55'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='56'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='57'></font>
<font color=#447700>!******************************************************************<a name='58'></font>
<font color=#447700>!******************************************************************<a name='59'></font>
<font color=#447700>!==============================================<a name='60'></font>
<font color=#447700>! all entries are defined explicitly<a name='61'></font>
<font color=#447700>!==============================================<a name='62'></font>
implicit none<a name='63'>
<a name='64'>
<font color=#447700>!==============================================<a name='65'></font>
<font color=#447700>! declare arguments<a name='66'></font>
<font color=#447700>!==============================================<a name='67'></font>
real, intent(in) :: dampcoef<a name='68'>
real, intent(in) :: dt<a name='69'>
real, intent(in) :: dx<a name='70'>
integer, intent(in) :: ime<a name='71'>
integer, intent(in) :: ims<a name='72'>
integer, intent(in) :: jme<a name='73'>
integer, intent(in) :: jms<a name='74'>
integer, intent(in) :: kme<a name='75'>
integer, intent(in) :: kms<a name='76'>
real, intent(inout) :: g_xkmhd(ims:ime,kms:kme,jms:jme)<a name='77'>
integer, intent(in) :: ide<a name='78'>
integer, intent(in) :: ite<a name='79'>
integer, intent(in) :: its<a name='80'>
integer, intent(in) :: jde<a name='81'>
integer, intent(in) :: jte<a name='82'>
integer, intent(in) :: jts<a name='83'>
integer, intent(in) :: kde<a name='84'>
integer, intent(in) :: kte<a name='85'>
integer, intent(in) :: kts<a name='86'>
real, intent(in) :: rdz(ims:ime,kms:kme,jms:jme)<a name='87'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='88'>
real, intent(inout) :: xkhh(ims:ime,kms:kme,jms:jme)<a name='89'>
real, intent(inout) :: xkhv(ims:ime,kms:kme,jms:jme)<a name='90'>
real, intent(inout) :: xkmh(ims:ime,kms:kme,jms:jme)<a name='91'>
real, intent(inout) :: xkmhd(ims:ime,kms:kme,jms:jme)<a name='92'>
real, intent(inout) :: xkmv(ims:ime,kms:kme,jms:jme)<a name='93'>
real, intent(in) :: zdamp<a name='94'>
<a name='95'>
<font color=#447700>!==============================================<a name='96'></font>
<font color=#447700>! declare local variables<a name='97'></font>
<font color=#447700>!==============================================<a name='98'></font>
real dampk(its:ite,kts:kte,jts:jte)<a name='99'>
real degrad90<a name='100'>
real deltaz(its:ite)<a name='101'>
real dz<a name='102'>
integer i<a name='103'>
integer i_end<a name='104'>
integer i_start<a name='105'>
integer j<a name='106'>
integer j_end<a name='107'>
integer j_start<a name='108'>
integer k<a name='109'>
real kmmax<a name='110'>
integer ktf<a name='111'>
integer ktfm1<a name='112'>
real tmp<a name='113'>
<a name='114'>
<font color=#447700>!----------------------------------------------<a name='115'></font>
<font color=#447700>! TANGENT LINEAR AND FUNCTION STATEMENTS<a name='116'></font>
<font color=#447700>!----------------------------------------------<a name='117'></font>
ktf = min(kte,kde-1)<a name='118'>
ktfm1 = ktf-1<a name='119'>
i_start = its<a name='120'>
i_end = min(ite,ide-1)<a name='121'>
j_start = jts<a name='122'>
j_end = min(jte,jde-1)<a name='123'>
kmmax = dx*dx/dt<a name='124'>
degrad90 = degrad*90.<a name='125'>
do j = j_start, j_end<a name='126'>
  k = ktf<a name='127'>
  do i = i_start, i_end<a name='128'>
    dz = 1./rdzw(i,k,j)<a name='129'>
    deltaz(i) = 0.5*dz<a name='130'>
    tmp = min(deltaz(i)/zdamp,1.)<a name='131'>
    dampk(i,k,j) = cos(degrad90*tmp)*kmmax*dampcoef<a name='132'>
  end do<a name='133'>
  do k = ktfm1, kts, -1<a name='134'>
    do i = i_start, i_end<a name='135'>
      dz = 1./rdz(i,k,j)<a name='136'>
      deltaz(i) = deltaz(i)+dz<a name='137'>
      tmp = min(deltaz(i)/zdamp,1.)<a name='138'>
      dampk(i,k,j) = cos(degrad90*tmp)*kmmax*dampcoef<a name='139'>
    end do<a name='140'>
  end do<a name='141'>
end do<a name='142'>
do j = j_start, j_end<a name='143'>
  do k = kts, ktf<a name='144'>
    do i = i_start, i_end<a name='145'>
      g_xkmhd(i,k,j) = g_xkmhd(i,k,j)*(0.5+sign(0.5,xkmhd(i,k,j)-dampk(i,k,j)))<a name='146'>
      xkmhd(i,k,j) = max(xkmhd(i,k,j),dampk(i,k,j))<a name='147'>
    end do<a name='148'>
  end do<a name='149'>
end do<a name='150'>
<a name='151'>
end subroutine g_cal_dampkm<a name='152'>
<a name='153'>
<a name='154'>
<A NAME='G_CALC_L_SCALE'><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALC_L_SCALE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='155'>
<font color=#993300>subroutine </font><font color=#cc0000>g_calc_l_scale</font>( tke, bn2, g_bn2, l_scale, g_l_scale, i_start, i_end, ktf, j_start, j_end, dx, dy, rdzw, ims, ime, jms, &amp; <A href='../../call_to/G_CALC_L_SCALE.html' TARGET='index'>1</A><a name='156'>
&amp;jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='157'>
<font color=#447700>!******************************************************************<a name='158'></font>
<font color=#447700>!******************************************************************<a name='159'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='160'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='161'></font>
<font color=#447700>!******************************************************************<a name='162'></font>
<font color=#447700>!******************************************************************<a name='163'></font>
<font color=#447700>!==============================================<a name='164'></font>
<font color=#447700>! all entries are defined explicitly<a name='165'></font>
<font color=#447700>!==============================================<a name='166'></font>
implicit none<a name='167'>
<a name='168'>
<font color=#447700>!==============================================<a name='169'></font>
<font color=#447700>! declare arguments<a name='170'></font>
<font color=#447700>!==============================================<a name='171'></font>
integer, intent(in) :: ime<a name='172'>
integer, intent(in) :: ims<a name='173'>
integer, intent(in) :: jme<a name='174'>
integer, intent(in) :: jms<a name='175'>
integer, intent(in) :: kme<a name='176'>
integer, intent(in) :: kms<a name='177'>
real, intent(in) :: bn2(ims:ime,kms:kme,jms:jme)<a name='178'>
real, intent(in) :: dx<a name='179'>
real, intent(in) :: dy<a name='180'>
real, intent(in) :: g_bn2(ims:ime,kms:kme,jms:jme)<a name='181'>
integer, intent(in) :: ite<a name='182'>
integer, intent(in) :: its<a name='183'>
integer, intent(in) :: jte<a name='184'>
integer, intent(in) :: jts<a name='185'>
integer, intent(in) :: kte<a name='186'>
integer, intent(in) :: kts<a name='187'>
real, intent(out) :: g_l_scale(its:ite,kts:kte,jts:jte)<a name='188'>
integer, intent(in) :: i_end<a name='189'>
integer, intent(in) :: i_start<a name='190'>
integer, intent(in) :: j_end<a name='191'>
integer, intent(in) :: j_start<a name='192'>
integer, intent(in) :: ktf<a name='193'>
real, intent(out) :: l_scale(its:ite,kts:kte,jts:jte)<a name='194'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='195'>
real, intent(in) :: tke(ims:ime,kms:kme,jms:jme)<a name='196'>
<a name='197'>
<font color=#447700>!==============================================<a name='198'></font>
<font color=#447700>! declare local variables<a name='199'></font>
<font color=#447700>!==============================================<a name='200'></font>
real deltas<a name='201'>
integer i<a name='202'>
integer j<a name='203'>
integer k<a name='204'>
real tmp<a name='205'>
<a name='206'>
<font color=#447700>!----------------------------------------------<a name='207'></font>
<font color=#447700>! TANGENT LINEAR AND FUNCTION STATEMENTS<a name='208'></font>
<font color=#447700>!----------------------------------------------<a name='209'></font>
do j = j_start, j_end<a name='210'>
  do k = kts, ktf<a name='211'>
    do i = i_start, i_end<a name='212'>
      deltas = (dx*dy/rdzw(i,k,j))**0.33333333<a name='213'>
      g_l_scale(i,k,j) = 0.<a name='214'>
      l_scale(i,k,j) = deltas<a name='215'>
      if (bn2(i,k,j) .gt. 1.e-6) then<a name='216'>
        tmp = sqrt(max(tke(i,k,j),1.e-6))<a name='217'>
        g_l_scale(i,k,j) = -(g_bn2(i,k,j)*(0.76*tmp*(1./(2.*sqrt(bn2(i,k,j))))/(sqrt(bn2(i,k,j))*sqrt(bn2(i,k,j)))))<a name='218'>
        l_scale(i,k,j) = 0.76*tmp/sqrt(bn2(i,k,j))<a name='219'>
        g_l_scale(i,k,j) = g_l_scale(i,k,j)*(0.5+sign(0.5,deltas-l_scale(i,k,j)))<a name='220'>
        l_scale(i,k,j) = min(l_scale(i,k,j),deltas)<a name='221'>
        g_l_scale(i,k,j) = g_l_scale(i,k,j)*(0.5+sign(0.5,l_scale(i,k,j)-0.001*deltas))<a name='222'>
        l_scale(i,k,j) = max(l_scale(i,k,j),0.001*deltas)<a name='223'>
      endif<a name='224'>
    end do<a name='225'>
  end do<a name='226'>
end do<a name='227'>
<a name='228'>
end subroutine g_calc_l_scale<a name='229'>
<a name='230'>
<a name='231'>
<A NAME='G_CALCULATE_KM_KH'><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALCULATE_KM_KH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='232'>
<font color=#993300>subroutine </font><font color=#cc0000>g_calculate_km_kh</font>( config_flags, dt, dampcoef, zdamp, damp_opt, xkmh, xkmhd, g_xkmhd, xkmv, xkhh, xkhv, bn2, g_bn2, &amp; <A href='../../call_to/G_CALCULATE_KM_KH.html' TARGET='index'>3</A>,<A href='../../call_from/G_CALCULATE_KM_KH.html' TARGET='index'>6</A><a name='233'>
&amp;khdif, defor11, defor22, defor33, defor12, defor13, defor23, tke, p8w, g_p8w, t8w, g_t8w, theta, g_theta, t, g_t, p, g_p, moist, &amp;<a name='234'>
&amp;g_moist, dx, dy, rdz, rdzw, n_moist, cf1, cf2, cf3, kh_tke_upper_bound, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, &amp;<a name='235'>
&amp;its, ite, jts, jte, kts, kte )<a name='236'>
<font color=#447700>!******************************************************************<a name='237'></font>
<font color=#447700>!******************************************************************<a name='238'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='239'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='240'></font>
<font color=#447700>!******************************************************************<a name='241'></font>
<font color=#447700>!******************************************************************<a name='242'></font>
<font color=#447700>!==============================================<a name='243'></font>
<font color=#447700>! all entries are defined explicitly<a name='244'></font>
<font color=#447700>!==============================================<a name='245'></font>
implicit none<a name='246'>
<a name='247'>
<font color=#447700>!==============================================<a name='248'></font>
<font color=#447700>! declare arguments<a name='249'></font>
<font color=#447700>!==============================================<a name='250'></font>
integer, intent(in) :: ime<a name='251'>
integer, intent(in) :: ims<a name='252'>
integer, intent(in) :: jme<a name='253'>
integer, intent(in) :: jms<a name='254'>
integer, intent(in) :: kme<a name='255'>
integer, intent(in) :: kms<a name='256'>
real, intent(inout) :: bn2(ims:ime,kms:kme,jms:jme)<a name='257'>
real, intent(in) :: cf1<a name='258'>
real, intent(in) :: cf2<a name='259'>
real, intent(in) :: cf3<a name='260'>
type (grid_config_rec_type), intent(in) :: config_flags<a name='261'>
integer, intent(in) :: damp_opt<a name='262'>
real, intent(in) :: dampcoef<a name='263'>
real, intent(in) :: defor11(ims:ime,kms:kme,jms:jme)<a name='264'>
real, intent(in) :: defor12(ims:ime,kms:kme,jms:jme)<a name='265'>
real, intent(in) :: defor13(ims:ime,kms:kme,jms:jme)<a name='266'>
real, intent(in) :: defor22(ims:ime,kms:kme,jms:jme)<a name='267'>
real, intent(in) :: defor23(ims:ime,kms:kme,jms:jme)<a name='268'>
real, intent(in) :: defor33(ims:ime,kms:kme,jms:jme)<a name='269'>
real, intent(in) :: dt<a name='270'>
real, intent(in) :: dx<a name='271'>
real, intent(in) :: dy<a name='272'>
real, intent(inout) :: g_bn2(ims:ime,kms:kme,jms:jme)<a name='273'>
integer, intent(in) :: n_moist<a name='274'>
real, intent(inout) :: g_moist(ims:ime,kms:kme,jms:jme,n_moist)<a name='275'>
real, intent(in) :: g_p(ims:ime,kms:kme,jms:jme)<a name='276'>
real, intent(in) :: g_p8w(ims:ime,kms:kme,jms:jme)<a name='277'>
real, intent(in) :: g_t(ims:ime,kms:kme,jms:jme)<a name='278'>
real, intent(in) :: g_t8w(ims:ime,kms:kme,jms:jme)<a name='279'>
real, intent(in) :: g_theta(ims:ime,kms:kme,jms:jme)<a name='280'>
real, intent(inout) :: g_xkmhd(ims:ime,kms:kme,jms:jme)<a name='281'>
integer, intent(in) :: ide<a name='282'>
integer, intent(in) :: ids<a name='283'>
integer, intent(in) :: ite<a name='284'>
integer, intent(in) :: its<a name='285'>
integer, intent(in) :: jde<a name='286'>
integer, intent(in) :: jds<a name='287'>
integer, intent(in) :: jte<a name='288'>
integer, intent(in) :: jts<a name='289'>
integer, intent(in) :: kde<a name='290'>
real, intent(in) :: kh_tke_upper_bound<a name='291'>
real, intent(in) :: khdif<a name='292'>
integer, intent(in) :: kte<a name='293'>
integer, intent(in) :: kts<a name='294'>
real, intent(inout) :: moist(ims:ime,kms:kme,jms:jme,n_moist)<a name='295'>
real, intent(in) :: p(ims:ime,kms:kme,jms:jme)<a name='296'>
real, intent(in) :: p8w(ims:ime,kms:kme,jms:jme)<a name='297'>
real, intent(in) :: rdz(ims:ime,kms:kme,jms:jme)<a name='298'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='299'>
real, intent(in) :: t(ims:ime,kms:kme,jms:jme)<a name='300'>
real, intent(in) :: t8w(ims:ime,kms:kme,jms:jme)<a name='301'>
real, intent(in) :: theta(ims:ime,kms:kme,jms:jme)<a name='302'>
real, intent(inout) :: tke(ims:ime,kms:kme,jms:jme)<a name='303'>
real, intent(inout) :: xkhh(ims:ime,kms:kme,jms:jme)<a name='304'>
real, intent(inout) :: xkhv(ims:ime,kms:kme,jms:jme)<a name='305'>
real, intent(inout) :: xkmh(ims:ime,kms:kme,jms:jme)<a name='306'>
real, intent(inout) :: xkmhd(ims:ime,kms:kme,jms:jme)<a name='307'>
real, intent(inout) :: xkmv(ims:ime,kms:kme,jms:jme)<a name='308'>
real, intent(in) :: zdamp<a name='309'>
<a name='310'>
<font color=#447700>!==============================================<a name='311'></font>
<font color=#447700>! declare local variables<a name='312'></font>
<font color=#447700>!==============================================<a name='313'></font>
real g_xkmhh(ims:ime,kms:kme,jms:jme)<a name='314'>
real g_xkmhi(ims:ime,kms:kme,jms:jme)<a name='315'>
real g_xkmhj(ims:ime,kms:kme,jms:jme)<a name='316'>
<a name='317'>
<font color=#447700>!----------------------------------------------<a name='318'></font>
<font color=#447700>! TANGENT LINEAR AND FUNCTION STATEMENTS<a name='319'></font>
<font color=#447700>!----------------------------------------------<a name='320'></font>
call <A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALCULATE_N2'>g_calculate_n2</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALCULATE_N2_1">( config_flags,bn2,g_bn2,moist,g_moist,theta,g_theta,t,g_t,p,g_p,p8w,g_p8w,t8w,g_t8w,rdz,rdzw,n_moist,cf1,cf2,&amp;<a name='321'>
&amp;cf3,ids,ide,jds,jde,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='322'>
km_coeg: select case ( config_flags%km_opt )<a name='323'>
case (1) km_coeg<a name='324'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_ISOTROPIC_KM'>g_isotropic_km</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_ISOTROPIC_KM_1">( xkmh,xkmhd,g_xkmhd,xkmv,xkhh,xkhv,khdif,ide,jde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='325'>
case (2) km_coeg<a name='326'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_TKE_KM'>g_tke_km</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_TKE_KM_1">( config_flags,xkmh,g_xkmhh,xkmhd,g_xkmhd,xkmv,xkhh,xkhv,bn2,g_bn2,tke,rdzw,dx,dy,kh_tke_upper_bound,ids,ide,jds,&amp;<a name='327'>
&amp;jde,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='328'>
case (3) km_coeg<a name='329'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_SMAG_KM'>g_smag_km</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SMAG_KM_1">( config_flags,xkmh,g_xkmhi,xkmhd,g_xkmhd,xkmv,xkhh,xkhv,bn2,g_bn2,defor11,defor22,defor33,defor12,defor13,defor23,&amp;<a name='330'>
&amp;rdzw,dx,dy,ids,ide,jds,jde,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='331'>
case (4) km_coeg<a name='332'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_SMAG2D_KM'>g_smag2d_km</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SMAG2D_KM_1">( config_flags,xkmh,g_xkmhj,xkmhd,g_xkmhd,xkmv,xkhh,xkhv,defor11,defor22,defor12,dx,dy,ids,ide,jds,jde,kde,ims,&amp;<a name='333'>
&amp;ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='334'>
end select km_coeg<a name='335'>
if (damp_opt .eq. 1) then<a name='336'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CAL_DAMPKM'>g_cal_dampkm</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CAL_DAMPKM_1">( xkmhd,g_xkmhd,xkmh,xkhh,xkmv,xkhv,dx,dt,dampcoef,rdz,rdzw,zdamp,ide,jde,kde,ims,ime,jms,jme,kms,kme,its,ite,&amp;<a name='337'>
&amp;jts,jte,kts,kte )<a name='338'>
endif<a name='339'>
<a name='340'>
end subroutine g_calculate_km_kh<a name='341'>
<a name='342'>
<a name='343'>
<A NAME='G_CALCULATE_N2'><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALCULATE_N2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='344'>
<font color=#993300>subroutine </font><font color=#cc0000>g_calculate_n2</font>( config_flags, bn2, g_bn2, moist, g_moist, theta, g_theta, t, g_t, p, g_p, p8w, g_p8w, t8w, g_t8w, rdz, &amp; <A href='../../call_to/G_CALCULATE_N2.html' TARGET='index'>1</A><a name='345'>
&amp;rdzw, n_moist, cf1, cf2, cf3, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='346'>
<font color=#447700>!******************************************************************<a name='347'></font>
<font color=#447700>!******************************************************************<a name='348'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='349'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='350'></font>
<font color=#447700>!******************************************************************<a name='351'></font>
<font color=#447700>!******************************************************************<a name='352'></font>
<font color=#447700>!==============================================<a name='353'></font>
<font color=#447700>! all entries are defined explicitly<a name='354'></font>
<font color=#447700>!==============================================<a name='355'></font>
implicit none<a name='356'>
<a name='357'>
<font color=#447700>!==============================================<a name='358'></font>
<font color=#447700>! declare arguments<a name='359'></font>
<font color=#447700>!==============================================<a name='360'></font>
integer, intent(in) :: ime<a name='361'>
integer, intent(in) :: ims<a name='362'>
integer, intent(in) :: jme<a name='363'>
integer, intent(in) :: jms<a name='364'>
integer, intent(in) :: kme<a name='365'>
integer, intent(in) :: kms<a name='366'>
real, intent(inout) :: bn2(ims:ime,kms:kme,jms:jme)<a name='367'>
real, intent(in) :: cf1<a name='368'>
real, intent(in) :: cf2<a name='369'>
real, intent(in) :: cf3<a name='370'>
type (grid_config_rec_type), intent(in) :: config_flags<a name='371'>
real, intent(inout) :: g_bn2(ims:ime,kms:kme,jms:jme)<a name='372'>
integer, intent(in) :: n_moist<a name='373'>
real, intent(inout) :: g_moist(ims:ime,kms:kme,jms:jme,n_moist)<a name='374'>
real, intent(in) :: g_p(ims:ime,kms:kme,jms:jme)<a name='375'>
real, intent(in) :: g_p8w(ims:ime,kms:kme,jms:jme)<a name='376'>
real, intent(in) :: g_t(ims:ime,kms:kme,jms:jme)<a name='377'>
real, intent(in) :: g_t8w(ims:ime,kms:kme,jms:jme)<a name='378'>
real, intent(in) :: g_theta(ims:ime,kms:kme,jms:jme)<a name='379'>
integer, intent(in) :: ide<a name='380'>
integer, intent(in) :: ids<a name='381'>
integer, intent(in) :: ite<a name='382'>
integer, intent(in) :: its<a name='383'>
integer, intent(in) :: jde<a name='384'>
integer, intent(in) :: jds<a name='385'>
integer, intent(in) :: jte<a name='386'>
integer, intent(in) :: jts<a name='387'>
integer, intent(in) :: kde<a name='388'>
integer, intent(in) :: kte<a name='389'>
integer, intent(in) :: kts<a name='390'>
real, intent(inout) :: moist(ims:ime,kms:kme,jms:jme,n_moist)<a name='391'>
real, intent(in) :: p(ims:ime,kms:kme,jms:jme)<a name='392'>
real, intent(in) :: p8w(ims:ime,kms:kme,jms:jme)<a name='393'>
real, intent(in) :: rdz(ims:ime,kms:kme,jms:jme)<a name='394'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='395'>
real, intent(in) :: t(ims:ime,kms:kme,jms:jme)<a name='396'>
real, intent(in) :: t8w(ims:ime,kms:kme,jms:jme)<a name='397'>
real, intent(in) :: theta(ims:ime,kms:kme,jms:jme)<a name='398'>
<a name='399'>
<font color=#447700>!==============================================<a name='400'></font>
<font color=#447700>! declare local variables<a name='401'></font>
<font color=#447700>!==============================================<a name='402'></font>
real coefa<a name='403'>
real es<a name='404'>
real g_coefa<a name='405'>
real g_es<a name='406'>
real g_qctmp(its:ite,kts:kte,jts:jte)<a name='407'>
real g_qvs(its:ite,kts:kte,jts:jte)<a name='408'>
real g_qvsfc<a name='409'>
real g_tc<a name='410'>
real g_thetaem1<a name='411'>
real g_thetaep1<a name='412'>
real g_thetaesfc<a name='413'>
real g_thetasfc<a name='414'>
real g_tmp1(its:ite,kts:kte,jts:jte)<a name='415'>
real g_tmp1sfc(its:ite,jts:jte)<a name='416'>
real g_xlvqv<a name='417'>
integer i<a name='418'>
integer i_end<a name='419'>
integer i_start<a name='420'>
integer ispe<a name='421'>
integer j<a name='422'>
integer j_end<a name='423'>
integer j_start<a name='424'>
integer k<a name='425'>
integer ktf<a name='426'>
real qc_cr<a name='427'>
real qctmp(its:ite,kts:kte,jts:jte)<a name='428'>
real qvs(its:ite,kts:kte,jts:jte)<a name='429'>
real qvsfc<a name='430'>
real tc<a name='431'>
real thetaem1<a name='432'>
real thetaep1<a name='433'>
real thetaesfc<a name='434'>
real thetasfc<a name='435'>
real tmp1(its:ite,kts:kte,jts:jte)<a name='436'>
real tmp1sfc(its:ite,jts:jte)<a name='437'>
real tmpdz<a name='438'>
real xlvqv<a name='439'>
<a name='440'>
<font color=#447700>!----------------------------------------------<a name='441'></font>
<font color=#447700>! TANGENT LINEAR AND FUNCTION STATEMENTS<a name='442'></font>
<font color=#447700>!----------------------------------------------<a name='443'></font>
qc_cr = 0.00001<a name='444'>
ktf = min(kte,kde-1)<a name='445'>
i_start = its<a name='446'>
i_end = min(ite,ide-1)<a name='447'>
j_start = jts<a name='448'>
j_end = min(jte,jde-1)<a name='449'>
if (config_flags%open_xs .or. config_flags%specified .or. config_flags%nested) then<a name='450'>
  i_start = max(ids+1,its)<a name='451'>
endif<a name='452'>
if (config_flags%open_xe .or. config_flags%specified .or. config_flags%nested) then<a name='453'>
  i_end = min(ide-2,ite)<a name='454'>
endif<a name='455'>
if (config_flags%open_ys .or. config_flags%specified .or. config_flags%nested) then<a name='456'>
  j_start = max(jds+1,jts)<a name='457'>
endif<a name='458'>
if (config_flags%open_ye .or. config_flags%specified .or. config_flags%nested) then<a name='459'>
  j_end = min(jde-2,jte)<a name='460'>
endif<a name='461'>
if (p_qc .gt. param_first_scalar) then<a name='462'>
  do j = j_start, j_end<a name='463'>
    do k = kts, ktf<a name='464'>
      do i = i_start, i_end<a name='465'>
        g_qctmp(i,k,j) = g_moist(i,k,j,p_qc)<a name='466'>
        qctmp(i,k,j) = moist(i,k,j,p_qc)<a name='467'>
      end do<a name='468'>
    end do<a name='469'>
  end do<a name='470'>
else<a name='471'>
  do j = j_start, j_end<a name='472'>
    do k = kts, ktf<a name='473'>
      do i = i_start, i_end<a name='474'>
        g_qctmp(i,k,j) = 0.<a name='475'>
        qctmp(i,k,j) = 0.<a name='476'>
      end do<a name='477'>
    end do<a name='478'>
  end do<a name='479'>
endif<a name='480'>
do j = jts, jte<a name='481'>
  do k = kts, kte<a name='482'>
    do i = its, ite<a name='483'>
      g_tmp1(i,k,j) = 0.<a name='484'>
      tmp1(i,k,j) = 0.<a name='485'>
    end do<a name='486'>
  end do<a name='487'>
end do<a name='488'>
do j = jts, jte<a name='489'>
  do i = its, ite<a name='490'>
    g_tmp1sfc(i,j) = 0.<a name='491'>
    tmp1sfc(i,j) = 0.<a name='492'>
  end do<a name='493'>
end do<a name='494'>
do ispe = param_first_scalar, n_moist<a name='495'>
  if (ispe .eq. p_qv .or. ispe .eq. p_qc .or. ispe .eq. p_qi) then<a name='496'>
    do j = j_start, j_end<a name='497'>
      do k = kts, ktf<a name='498'>
        do i = i_start, i_end<a name='499'>
          g_tmp1(i,k,j) = g_moist(i,k,j,ispe)+g_tmp1(i,k,j)<a name='500'>
          tmp1(i,k,j) = tmp1(i,k,j)+moist(i,k,j,ispe)<a name='501'>
        end do<a name='502'>
      end do<a name='503'>
    end do<a name='504'>
    do j = j_start, j_end<a name='505'>
      do i = i_start, i_end<a name='506'>
        g_tmp1sfc(i,j) = g_moist(i,3,j,ispe)*cf3+g_moist(i,2,j,ispe)*cf2+g_moist(i,1,j,ispe)*cf1+g_tmp1sfc(i,j)<a name='507'>
        tmp1sfc(i,j) = tmp1sfc(i,j)+cf1*moist(i,1,j,ispe)+cf2*moist(i,2,j,ispe)+cf3*moist(i,3,j,ispe)<a name='508'>
      end do<a name='509'>
    end do<a name='510'>
  endif<a name='511'>
end do<a name='512'>
do j = j_start, j_end<a name='513'>
  do k = kts, ktf<a name='514'>
    do i = i_start, i_end<a name='515'>
      g_tc = g_t(i,k,j)<a name='516'>
      tc = t(i,k,j)-svpt0<a name='517'>
      g_es = (-(1000.*g_t(i,k,j)*svp1*(svp2*tc/((t(i,k,j)-svp3)*(t(i,k,j)-svp3)))*exp(svp2*tc/(t(i,k,j)-svp3))))+1000.*g_tc*svp1*&amp;<a name='518'>
&amp;(svp2/(t(i,k,j)-svp3))*exp(svp2*tc/(t(i,k,j)-svp3))<a name='519'>
      es = 1000.*svp1*exp(svp2*tc/(t(i,k,j)-svp3))<a name='520'>
      g_qvs(i,k,j) = g_es*(ep_2/(p(i,k,j)-es)+ep_2*es/((p(i,k,j)-es)*(p(i,k,j)-es)))-g_p(i,k,j)*(ep_2*es/((p(i,k,j)-es)*(p(i,k,j)-&amp;<a name='521'>
&amp;es)))<a name='522'>
      qvs(i,k,j) = ep_2*es/(p(i,k,j)-es)<a name='523'>
    end do<a name='524'>
  end do<a name='525'>
end do<a name='526'>
do j = j_start, j_end<a name='527'>
  do k = kts+1, ktf-1<a name='528'>
    do i = i_start, i_end<a name='529'>
      tmpdz = 1./rdz(i,k,j)+1./rdz(i,k+1,j)<a name='530'>
      if (moist(i,k,j,p_qv) .ge. qvs(i,k,j) .or. qctmp(i,k,j) .ge. qc_cr) then<a name='531'>
        g_xlvqv = g_moist(i,k,j,p_qv)*xlv<a name='532'>
        xlvqv = xlv*moist(i,k,j,p_qv)<a name='533'>
        g_coefa = g_t(i,k,j)*(((-(xlvqv/r_d/(t(i,k,j)*t(i,k,j))/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))))+(1.+xlvqv/r_d/t(i,k,j))*&amp;<a name='534'>
&amp;(xlv*xlvqv/cp/r_v/(t(i,k,j)*t(i,k,j))/t(i,k,j)+xlv*xlvqv/cp/r_v/t(i,k,j)/(t(i,k,j)*t(i,k,j)))/((1.+xlv*xlvqv/cp/r_v/t(i,k,&amp;<a name='535'>
&amp;j)/t(i,k,j))*(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))))/theta(i,k,j))-g_theta(i,k,j)*((1.+xlvqv/r_d/t(i,k,j))/(1.+xlv*&amp;<a name='536'>
&amp;xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))/(theta(i,k,j)*theta(i,k,j)))+g_xlvqv*((1/r_d/t(i,k,j)/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,&amp;<a name='537'>
&amp;j))-(1.+xlvqv/r_d/t(i,k,j))*(xlv/cp/r_v/t(i,k,j)/t(i,k,j))/((1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))*(1.+xlv*xlvqv/cp/r_v/&amp;<a name='538'>
&amp;t(i,k,j)/t(i,k,j))))/theta(i,k,j))<a name='539'>
        coefa = (1.+xlvqv/r_d/t(i,k,j))/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))/theta(i,k,j)<a name='540'>
        g_thetaep1 = g_qvs(i,k+1,j)*theta(i,k+1,j)*(xlv/cp/t(i,k+1,j))-g_t(i,k+1,j)*theta(i,k+1,j)*(xlv*qvs(i,k+1,j)/cp/(t(i,k+1,j)&amp;<a name='541'>
&amp;*t(i,k+1,j)))+g_theta(i,k+1,j)*(1+xlv*qvs(i,k+1,j)/cp/t(i,k+1,j))<a name='542'>
        thetaep1 = theta(i,k+1,j)*(1.+xlv*qvs(i,k+1,j)/cp/t(i,k+1,j))<a name='543'>
        g_thetaem1 = g_qvs(i,k-1,j)*theta(i,k-1,j)*(xlv/cp/t(i,k-1,j))-g_t(i,k-1,j)*theta(i,k-1,j)*(xlv*qvs(i,k-1,j)/cp/(t(i,k-1,j)&amp;<a name='544'>
&amp;*t(i,k-1,j)))+g_theta(i,k-1,j)*(1+xlv*qvs(i,k-1,j)/cp/t(i,k-1,j))<a name='545'>
        thetaem1 = theta(i,k-1,j)*(1.+xlv*qvs(i,k-1,j)/cp/t(i,k-1,j))<a name='546'>
        g_bn2(i,k,j) = g_coefa*g*((thetaep1-thetaem1)/tmpdz)-g_thetaem1*g*(coefa/tmpdz)+g_thetaep1*g*(coefa/tmpdz)+g_tmp1(i,k-1,j)*&amp;<a name='547'>
&amp;(g/tmpdz)-g_tmp1(i,k+1,j)*(g/tmpdz)<a name='548'>
        bn2(i,k,j) = g*(coefa*(thetaep1-thetaem1)/tmpdz-(tmp1(i,k+1,j)-tmp1(i,k-1,j))/tmpdz)<a name='549'>
      else<a name='550'>
        g_bn2(i,k,j) = g_moist(i,k-1,j,p_qv)*g*((-1.61)/tmpdz)+g_moist(i,k+1,j,p_qv)*g*(1.61/tmpdz)+g_theta(i,k-1,j)*g*((-1)/&amp;<a name='551'>
&amp;theta(i,k,j)/tmpdz)+g_theta(i,k+1,j)*g*(1/theta(i,k,j)/tmpdz)-g_theta(i,k,j)*g*((theta(i,k+1,j)-theta(i,k-1,j))/(theta(i,&amp;<a name='552'>
&amp;k,j)*theta(i,k,j))/tmpdz)+g_tmp1(i,k-1,j)*(g/tmpdz)-g_tmp1(i,k+1,j)*(g/tmpdz)<a name='553'>
        bn2(i,k,j) = g*((theta(i,k+1,j)-theta(i,k-1,j))/theta(i,k,j)/tmpdz+1.61*(moist(i,k+1,j,p_qv)-moist(i,k-1,j,p_qv))/tmpdz-&amp;<a name='554'>
&amp;(tmp1(i,k+1,j)-tmp1(i,k-1,j))/tmpdz)<a name='555'>
      endif<a name='556'>
    end do<a name='557'>
  end do<a name='558'>
end do<a name='559'>
k = kts<a name='560'>
do j = j_start, j_end<a name='561'>
  do i = i_start, i_end<a name='562'>
    tmpdz = 1./rdz(i,k+1,j)+0.5/rdzw(i,k,j)<a name='563'>
    g_thetasfc = (-(g_p8w(i,k,j)*(t8w(i,kts,j)/p1000mb*r_d/cp*(p8w(i,k,j)/p1000mb)**(r_d/cp-1)/((p8w(i,k,j)/p1000mb)**(r_d/cp)*&amp;<a name='564'>
&amp;(p8w(i,k,j)/p1000mb)**(r_d/cp)))))+g_t8w(i,kts,j)/(p8w(i,k,j)/p1000mb)**(r_d/cp)<a name='565'>
    thetasfc = t8w(i,kts,j)/(p8w(i,k,j)/p1000mb)**(r_d/cp)<a name='566'>
    if (moist(i,k,j,p_qv) .ge. qvs(i,k,j) .or. qctmp(i,k,j) .ge. qc_cr) then<a name='567'>
      g_qvsfc = g_qvs(i,3,j)*cf3+g_qvs(i,2,j)*cf2+g_qvs(i,1,j)*cf1<a name='568'>
      qvsfc = cf1*qvs(i,1,j)+cf2*qvs(i,2,j)+cf3*qvs(i,3,j)<a name='569'>
      g_xlvqv = g_moist(i,k,j,p_qv)*xlv<a name='570'>
      xlvqv = xlv*moist(i,k,j,p_qv)<a name='571'>
      g_coefa = g_t(i,k,j)*(((-(xlvqv/r_d/(t(i,k,j)*t(i,k,j))/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))))+(1.+xlvqv/r_d/t(i,k,j))*&amp;<a name='572'>
&amp;(xlv*xlvqv/cp/r_v/(t(i,k,j)*t(i,k,j))/t(i,k,j)+xlv*xlvqv/cp/r_v/t(i,k,j)/(t(i,k,j)*t(i,k,j)))/((1.+xlv*xlvqv/cp/r_v/t(i,k,j)&amp;<a name='573'>
&amp;/t(i,k,j))*(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))))/theta(i,k,j))-g_theta(i,k,j)*((1.+xlvqv/r_d/t(i,k,j))/(1.+xlv*xlvqv/cp/&amp;<a name='574'>
&amp;r_v/t(i,k,j)/t(i,k,j))/(theta(i,k,j)*theta(i,k,j)))+g_xlvqv*((1/r_d/t(i,k,j)/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))-(1.+&amp;<a name='575'>
&amp;xlvqv/r_d/t(i,k,j))*(xlv/cp/r_v/t(i,k,j)/t(i,k,j))/((1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))*(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/&amp;<a name='576'>
&amp;t(i,k,j))))/theta(i,k,j))<a name='577'>
      coefa = (1.+xlvqv/r_d/t(i,k,j))/(1.+xlv*xlvqv/cp/r_v/t(i,k,j)/t(i,k,j))/theta(i,k,j)<a name='578'>
      g_thetaep1 = g_qvs(i,k+1,j)*theta(i,k+1,j)*(xlv/cp/t(i,k+1,j))-g_t(i,k+1,j)*theta(i,k+1,j)*(xlv*qvs(i,k+1,j)/cp/(t(i,k+1,j)*&amp;<a name='579'>
&amp;t(i,k+1,j)))+g_theta(i,k+1,j)*(1+xlv*qvs(i,k+1,j)/cp/t(i,k+1,j))<a name='580'>
      thetaep1 = theta(i,k+1,j)*(1.+xlv*qvs(i,k+1,j)/cp/t(i,k+1,j))<a name='581'>
      g_thetaesfc = g_qvsfc*thetasfc*(xlv/cp/t8w(i,kts,j))-g_t8w(i,kts,j)*thetasfc*(xlv*qvsfc/cp/(t8w(i,kts,j)*t8w(i,kts,j)))+&amp;<a name='582'>
&amp;g_thetasfc*(1+xlv*qvsfc/cp/t8w(i,kts,j))<a name='583'>
      thetaesfc = thetasfc*(1.+xlv*qvsfc/cp/t8w(i,kts,j))<a name='584'>
      g_bn2(i,k,j) = g_coefa*g*((thetaep1-thetaesfc)/tmpdz)+g_thetaep1*g*(coefa/tmpdz)-g_thetaesfc*g*(coefa/tmpdz)-g_tmp1(i,k+1,j)*&amp;<a name='585'>
&amp;(g/tmpdz)+g_tmp1sfc(i,j)*(g/tmpdz)<a name='586'>
      bn2(i,k,j) = g*(coefa*(thetaep1-thetaesfc)/tmpdz-(tmp1(i,k+1,j)-tmp1sfc(i,j))/tmpdz)<a name='587'>
    else<a name='588'>
      g_qvsfc = g_moist(i,3,j,p_qv)*cf3+g_moist(i,2,j,p_qv)*cf2+g_moist(i,1,j,p_qv)*cf1<a name='589'>
      qvsfc = cf1*moist(i,1,j,p_qv)+cf2*moist(i,2,j,p_qv)+cf3*moist(i,3,j,p_qv)<a name='590'>
      tmpdz = 1./rdzw(i,k,j)<a name='591'>
      g_bn2(i,k,j) = g_moist(i,k+1,j,p_qv)*g*(1.61/tmpdz)+g_qvsfc*g*((-1.61)/tmpdz)+g_theta(i,k+1,j)*g*(1/theta(i,k,j)/tmpdz)+&amp;<a name='592'>
&amp;g_theta(i,k,j)*g*(((-1)/theta(i,k,j)-(theta(i,k+1,j)-theta(i,k,j))/(theta(i,k,j)*theta(i,k,j)))/tmpdz)-g_tmp1(i,k+1,j)*(g/&amp;<a name='593'>
&amp;tmpdz)+g_tmp1sfc(i,j)*(g/tmpdz)<a name='594'>
      bn2(i,k,j) = g*((theta(i,k+1,j)-theta(i,k,j))/theta(i,k,j)/tmpdz+1.61*(moist(i,k+1,j,p_qv)-qvsfc)/tmpdz-(tmp1(i,k+1,j)-&amp;<a name='595'>
&amp;tmp1sfc(i,j))/tmpdz)<a name='596'>
    endif<a name='597'>
  end do<a name='598'>
end do<a name='599'>
do j = j_start, j_end<a name='600'>
  do i = i_start, i_end<a name='601'>
    g_bn2(i,ktf,j) = g_bn2(i,ktf-1,j)<a name='602'>
    bn2(i,ktf,j) = bn2(i,ktf-1,j)<a name='603'>
  end do<a name='604'>
end do<a name='605'>
<a name='606'>
end subroutine g_calculate_n2<a name='607'>
<a name='608'>
<a name='609'>
<A NAME='G_ISOTROPIC_KM'><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_ISOTROPIC_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='610'>
<font color=#993300>subroutine </font><font color=#cc0000>g_isotropic_km</font>( xkmh, xkmhd, g_xkmhd, xkmv, xkhh, xkhv, khdif, ide, jde, ims, ime, jms, jme, kms, kme, its, ite, jts, &amp; <A href='../../call_to/G_ISOTROPIC_KM.html' TARGET='index'>1</A><a name='611'>
&amp;jte, kts, kte )<a name='612'>
<font color=#447700>!******************************************************************<a name='613'></font>
<font color=#447700>!******************************************************************<a name='614'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='615'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='616'></font>
<font color=#447700>!******************************************************************<a name='617'></font>
<font color=#447700>!******************************************************************<a name='618'></font>
<font color=#447700>!==============================================<a name='619'></font>
<font color=#447700>! all entries are defined explicitly<a name='620'></font>
<font color=#447700>!==============================================<a name='621'></font>
implicit none<a name='622'>
<a name='623'>
<font color=#447700>!==============================================<a name='624'></font>
<font color=#447700>! declare arguments<a name='625'></font>
<font color=#447700>!==============================================<a name='626'></font>
integer, intent(in) :: ime<a name='627'>
integer, intent(in) :: ims<a name='628'>
integer, intent(in) :: jme<a name='629'>
integer, intent(in) :: jms<a name='630'>
integer, intent(in) :: kme<a name='631'>
integer, intent(in) :: kms<a name='632'>
real, intent(inout) :: g_xkmhd(ims:ime,kms:kme,jms:jme)<a name='633'>
integer, intent(in) :: ide<a name='634'>
integer, intent(in) :: ite<a name='635'>
integer, intent(in) :: its<a name='636'>
integer, intent(in) :: jde<a name='637'>
integer, intent(in) :: jte<a name='638'>
integer, intent(in) :: jts<a name='639'>
real, intent(in) :: khdif<a name='640'>
integer, intent(in) :: kte<a name='641'>
integer, intent(in) :: kts<a name='642'>
real, intent(inout) :: xkhh(ims:ime,kms:kme,jms:jme)<a name='643'>
real, intent(inout) :: xkhv(ims:ime,kms:kme,jms:jme)<a name='644'>
real, intent(inout) :: xkmh(ims:ime,kms:kme,jms:jme)<a name='645'>
real, intent(inout) :: xkmhd(ims:ime,kms:kme,jms:jme)<a name='646'>
real, intent(inout) :: xkmv(ims:ime,kms:kme,jms:jme)<a name='647'>
<a name='648'>
<font color=#447700>!==============================================<a name='649'></font>
<font color=#447700>! declare local variables<a name='650'></font>
<font color=#447700>!==============================================<a name='651'></font>
integer i<a name='652'>
integer i_end<a name='653'>
integer i_start<a name='654'>
integer j<a name='655'>
integer j_end<a name='656'>
integer j_start<a name='657'>
integer k<a name='658'>
integer ktf<a name='659'>
<a name='660'>
<font color=#447700>!----------------------------------------------<a name='661'></font>
<font color=#447700>! TANGENT LINEAR AND FUNCTION STATEMENTS<a name='662'></font>
<font color=#447700>!----------------------------------------------<a name='663'></font>
ktf = kte<a name='664'>
i_start = its<a name='665'>
i_end = min(ite,ide-1)<a name='666'>
j_start = jts<a name='667'>
j_end = min(jte,jde-1)<a name='668'>
do j = j_start, j_end<a name='669'>
  do k = kts, ktf<a name='670'>
    do i = i_start, i_end<a name='671'>
      g_xkmhd(i,k,j) = 0.<a name='672'>
      xkmhd(i,k,j) = khdif<a name='673'>
    end do<a name='674'>
  end do<a name='675'>
end do<a name='676'>
<a name='677'>
end subroutine g_isotropic_km<a name='678'>
<a name='679'>
<a name='680'>
<A NAME='G_SMAG2D_KM'><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_SMAG2D_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='681'>
<font color=#993300>subroutine </font><font color=#cc0000>g_smag2d_km</font>( config_flags, xkmh, g_xkmh, xkmhd, g_xkmhd, xkmv, xkhh, xkhv, defor11, defor22, defor12, dx, dy, ids, ide, &amp; <A href='../../call_to/G_SMAG2D_KM.html' TARGET='index'>1</A><a name='682'>
&amp;jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='683'>
<font color=#447700>!******************************************************************<a name='684'></font>
<font color=#447700>!******************************************************************<a name='685'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='686'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='687'></font>
<font color=#447700>!******************************************************************<a name='688'></font>
<font color=#447700>!******************************************************************<a name='689'></font>
<font color=#447700>!==============================================<a name='690'></font>
<font color=#447700>! all entries are defined explicitly<a name='691'></font>
<font color=#447700>!==============================================<a name='692'></font>
implicit none<a name='693'>
<a name='694'>
<font color=#447700>!==============================================<a name='695'></font>
<font color=#447700>! declare arguments<a name='696'></font>
<font color=#447700>!==============================================<a name='697'></font>
type (grid_config_rec_type), intent(in) :: config_flags<a name='698'>
integer, intent(in) :: ime<a name='699'>
integer, intent(in) :: ims<a name='700'>
integer, intent(in) :: jme<a name='701'>
integer, intent(in) :: jms<a name='702'>
integer, intent(in) :: kme<a name='703'>
integer, intent(in) :: kms<a name='704'>
real, intent(in) :: defor11(ims:ime,kms:kme,jms:jme)<a name='705'>
real, intent(in) :: defor12(ims:ime,kms:kme,jms:jme)<a name='706'>
real, intent(in) :: defor22(ims:ime,kms:kme,jms:jme)<a name='707'>
real, intent(in) :: dx<a name='708'>
real, intent(in) :: dy<a name='709'>
real, intent(inout) :: g_xkmh(ims:ime,kms:kme,jms:jme)<a name='710'>
real, intent(inout) :: g_xkmhd(ims:ime,kms:kme,jms:jme)<a name='711'>
integer, intent(in) :: ide<a name='712'>
integer, intent(in) :: ids<a name='713'>
integer, intent(in) :: ite<a name='714'>
integer, intent(in) :: its<a name='715'>
integer, intent(in) :: jde<a name='716'>
integer, intent(in) :: jds<a name='717'>
integer, intent(in) :: jte<a name='718'>
integer, intent(in) :: jts<a name='719'>
integer, intent(in) :: kde<a name='720'>
integer, intent(in) :: kte<a name='721'>
integer, intent(in) :: kts<a name='722'>
real, intent(inout) :: xkhh(ims:ime,kms:kme,jms:jme)<a name='723'>
real, intent(inout) :: xkhv(ims:ime,kms:kme,jms:jme)<a name='724'>
real, intent(inout) :: xkmh(ims:ime,kms:kme,jms:jme)<a name='725'>
real, intent(inout) :: xkmhd(ims:ime,kms:kme,jms:jme)<a name='726'>
real, intent(inout) :: xkmv(ims:ime,kms:kme,jms:jme)<a name='727'>
<a name='728'>
<font color=#447700>!==============================================<a name='729'></font>
<font color=#447700>! declare local variables<a name='730'></font>
<font color=#447700>!==============================================<a name='731'></font>
real def2(its:ite,kts:kte,jts:jte)<a name='732'>
integer i<a name='733'>
integer i_end<a name='734'>
integer i_start<a name='735'>
integer j<a name='736'>
integer j_end<a name='737'>
integer j_start<a name='738'>
integer k<a name='739'>
integer ktf<a name='740'>
real mlen_h<a name='741'>
real tmp<a name='742'>
<a name='743'>
<font color=#447700>!----------------------------------------------<a name='744'></font>
<font color=#447700>! TANGENT LINEAR AND FUNCTION STATEMENTS<a name='745'></font>
<font color=#447700>!----------------------------------------------<a name='746'></font>
ktf = min(kte,kde-1)<a name='747'>
i_start = its<a name='748'>
i_end = min(ite,ide-1)<a name='749'>
j_start = jts<a name='750'>
j_end = min(jte,jde-1)<a name='751'>
if (config_flags%open_xs .or. config_flags%specified .or. config_flags%nested) then<a name='752'>
  i_start = max(ids+1,its)<a name='753'>
endif<a name='754'>
if (config_flags%open_xe .or. config_flags%specified .or. config_flags%nested) then<a name='755'>
  i_end = min(ide-2,ite)<a name='756'>
endif<a name='757'>
if (config_flags%open_ys .or. config_flags%specified .or. config_flags%nested) then<a name='758'>
  j_start = max(jds+1,jts)<a name='759'>
endif<a name='760'>
if (config_flags%open_ye .or. config_flags%specified .or. config_flags%nested) then<a name='761'>
  j_end = min(jde-2,jte)<a name='762'>
endif<a name='763'>
do j = j_start, j_end<a name='764'>
  do k = kts, ktf<a name='765'>
    do i = i_start, i_end<a name='766'>
      def2(i,k,j) = 0.25*(defor11(i,k,j)-defor22(i,k,j))**2+defor12(i,k,j)*defor12(i,k,j)<a name='767'>
    end do<a name='768'>
  end do<a name='769'>
end do<a name='770'>
mlen_h = sqrt(dx*dy)<a name='771'>
do j = j_start, j_end<a name='772'>
  do k = kts, ktf<a name='773'>
    do i = i_start, i_end<a name='774'>
      tmp = def2(i,k,j)**0.5<a name='775'>
      g_xkmh(i,k,j) = 0.<a name='776'>
      xkmh(i,k,j) = c_s*c_s*mlen_h*mlen_h*tmp<a name='777'>
      g_xkmh(i,k,j) = g_xkmh(i,k,j)*(0.5+sign(0.5,10.*mlen_h-xkmh(i,k,j)))<a name='778'>
      xkmh(i,k,j) = min(xkmh(i,k,j),10.*mlen_h)<a name='779'>
      g_xkmhd(i,k,j) = g_xkmh(i,k,j)<a name='780'>
      xkmhd(i,k,j) = xkmh(i,k,j)<a name='781'>
    end do<a name='782'>
  end do<a name='783'>
end do<a name='784'>
<a name='785'>
end subroutine g_smag2d_km<a name='786'>
<a name='787'>
<a name='788'>
<A NAME='G_SMAG_KM'><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_SMAG_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='789'>
<font color=#993300>subroutine </font><font color=#cc0000>g_smag_km</font>( config_flags, xkmh, g_xkmh, xkmhd, g_xkmhd, xkmv, xkhh, xkhv, bn2, g_bn2, defor11, defor22, defor33, defor12,&amp; <A href='../../call_to/G_SMAG_KM.html' TARGET='index'>1</A><a name='790'>
&amp; defor13, defor23, rdzw, dx, dy, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='791'>
<font color=#447700>!******************************************************************<a name='792'></font>
<font color=#447700>!******************************************************************<a name='793'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='794'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='795'></font>
<font color=#447700>!******************************************************************<a name='796'></font>
<font color=#447700>!******************************************************************<a name='797'></font>
<font color=#447700>!==============================================<a name='798'></font>
<font color=#447700>! all entries are defined explicitly<a name='799'></font>
<font color=#447700>!==============================================<a name='800'></font>
implicit none<a name='801'>
<a name='802'>
<font color=#447700>!==============================================<a name='803'></font>
<font color=#447700>! declare arguments<a name='804'></font>
<font color=#447700>!==============================================<a name='805'></font>
integer, intent(in) :: ime<a name='806'>
integer, intent(in) :: ims<a name='807'>
integer, intent(in) :: jme<a name='808'>
integer, intent(in) :: jms<a name='809'>
integer, intent(in) :: kme<a name='810'>
integer, intent(in) :: kms<a name='811'>
real, intent(in) :: bn2(ims:ime,kms:kme,jms:jme)<a name='812'>
type (grid_config_rec_type), intent(in) :: config_flags<a name='813'>
real, intent(in) :: defor11(ims:ime,kms:kme,jms:jme)<a name='814'>
real, intent(in) :: defor12(ims:ime,kms:kme,jms:jme)<a name='815'>
real, intent(in) :: defor13(ims:ime,kms:kme,jms:jme)<a name='816'>
real, intent(in) :: defor22(ims:ime,kms:kme,jms:jme)<a name='817'>
real, intent(in) :: defor23(ims:ime,kms:kme,jms:jme)<a name='818'>
real, intent(in) :: defor33(ims:ime,kms:kme,jms:jme)<a name='819'>
real, intent(in) :: dx<a name='820'>
real, intent(in) :: dy<a name='821'>
real, intent(in) :: g_bn2(ims:ime,kms:kme,jms:jme)<a name='822'>
real, intent(inout) :: g_xkmh(ims:ime,kms:kme,jms:jme)<a name='823'>
real, intent(inout) :: g_xkmhd(ims:ime,kms:kme,jms:jme)<a name='824'>
integer, intent(in) :: ide<a name='825'>
integer, intent(in) :: ids<a name='826'>
integer, intent(in) :: ite<a name='827'>
integer, intent(in) :: its<a name='828'>
integer, intent(in) :: jde<a name='829'>
integer, intent(in) :: jds<a name='830'>
integer, intent(in) :: jte<a name='831'>
integer, intent(in) :: jts<a name='832'>
integer, intent(in) :: kde<a name='833'>
integer, intent(in) :: kte<a name='834'>
integer, intent(in) :: kts<a name='835'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='836'>
real, intent(inout) :: xkhh(ims:ime,kms:kme,jms:jme)<a name='837'>
real, intent(inout) :: xkhv(ims:ime,kms:kme,jms:jme)<a name='838'>
real, intent(inout) :: xkmh(ims:ime,kms:kme,jms:jme)<a name='839'>
real, intent(inout) :: xkmhd(ims:ime,kms:kme,jms:jme)<a name='840'>
real, intent(inout) :: xkmv(ims:ime,kms:kme,jms:jme)<a name='841'>
<a name='842'>
<font color=#447700>!==============================================<a name='843'></font>
<font color=#447700>! declare local variables<a name='844'></font>
<font color=#447700>!==============================================<a name='845'></font>
real cr_len<a name='846'>
real def2(its:ite,kts:kte,jts:jte)<a name='847'>
real deltas<a name='848'>
real g_tmp<a name='849'>
integer i<a name='850'>
integer i_end<a name='851'>
integer i_start<a name='852'>
integer j<a name='853'>
integer j_end<a name='854'>
integer j_start<a name='855'>
integer k<a name='856'>
integer ktf<a name='857'>
real mlen_h<a name='858'>
real pr<a name='859'>
real tmp<a name='860'>
<a name='861'>
<font color=#447700>!----------------------------------------------<a name='862'></font>
<font color=#447700>! TANGENT LINEAR AND FUNCTION STATEMENTS<a name='863'></font>
<font color=#447700>!----------------------------------------------<a name='864'></font>
ktf = min(kte,kde-1)<a name='865'>
i_start = its<a name='866'>
i_end = min(ite,ide-1)<a name='867'>
j_start = jts<a name='868'>
j_end = min(jte,jde-1)<a name='869'>
if (config_flags%open_xs .or. config_flags%specified .or. config_flags%nested) then<a name='870'>
  i_start = max(ids+1,its)<a name='871'>
endif<a name='872'>
if (config_flags%open_xe .or. config_flags%specified .or. config_flags%nested) then<a name='873'>
  i_end = min(ide-2,ite)<a name='874'>
endif<a name='875'>
if (config_flags%open_ys .or. config_flags%specified .or. config_flags%nested) then<a name='876'>
  j_start = max(jds+1,jts)<a name='877'>
endif<a name='878'>
if (config_flags%open_ye .or. config_flags%specified .or. config_flags%nested) then<a name='879'>
  j_end = min(jde-2,jte)<a name='880'>
endif<a name='881'>
pr = 1./3.<a name='882'>
do j = j_start, j_end<a name='883'>
  do k = kts, ktf<a name='884'>
    do i = i_start, i_end<a name='885'>
      def2(i,k,j) = 0.5*(defor11(i,k,j)*defor11(i,k,j)+defor22(i,k,j)*defor22(i,k,j)+defor33(i,k,j)*defor33(i,k,j))<a name='886'>
    end do<a name='887'>
  end do<a name='888'>
end do<a name='889'>
do j = j_start, j_end<a name='890'>
  do k = kts, ktf<a name='891'>
    do i = i_start, i_end<a name='892'>
      g_tmp = 0.<a name='893'>
      tmp = 0.25*(defor12(i,k,j)+defor12(i,k,j+1)+defor12(i+1,k,j)+defor12(i+1,k,j+1))<a name='894'>
      def2(i,k,j) = def2(i,k,j)+0.5*tmp*tmp<a name='895'>
    end do<a name='896'>
  end do<a name='897'>
end do<a name='898'>
do j = j_start, j_end<a name='899'>
  do k = kts, ktf<a name='900'>
    do i = i_start, i_end<a name='901'>
      g_tmp = 0.<a name='902'>
      tmp = 0.25*(defor13(i,k+1,j)+defor13(i,k,j)+defor13(i+1,k+1,j)+defor13(i+1,k,j))<a name='903'>
      def2(i,k,j) = def2(i,k,j)+0.5*tmp*tmp<a name='904'>
    end do<a name='905'>
  end do<a name='906'>
end do<a name='907'>
do j = j_start, j_end<a name='908'>
  do k = kts, ktf<a name='909'>
    do i = i_start, i_end<a name='910'>
      g_tmp = 0.<a name='911'>
      tmp = 0.25*(defor23(i,k+1,j)+defor23(i,k,j)+defor23(i,k+1,j+1)+defor23(i,k,j+1))<a name='912'>
      def2(i,k,j) = def2(i,k,j)+0.5*tmp*tmp<a name='913'>
    end do<a name='914'>
  end do<a name='915'>
end do<a name='916'>
cr_len = dx+1.<a name='917'>
if (dx .gt. cr_len) then<a name='918'>
  mlen_h = sqrt(dx*dy)<a name='919'>
  do j = j_start, j_end<a name='920'>
    do k = kts, ktf<a name='921'>
      do i = i_start, i_end<a name='922'>
        g_tmp = -(g_bn2(i,k,j)*((0.5-sign(0.5,0.-(def2(i,k,j)-bn2(i,k,j)/pr)))/pr))<a name='923'>
        tmp = max(0.,def2(i,k,j)-bn2(i,k,j)/pr)<a name='924'>
        g_tmp = 0.5*g_tmp*tmp**(-0.5)<a name='925'>
        tmp = tmp**0.5<a name='926'>
        g_xkmh(i,k,j) = g_tmp*(0.5+sign(0.5,c_s*c_s*mlen_h*mlen_h*tmp-1.e-6*mlen_h*mlen_h))*c_s*c_s*mlen_h*mlen_h<a name='927'>
        xkmh(i,k,j) = max(c_s*c_s*mlen_h*mlen_h*tmp,1.e-6*mlen_h*mlen_h)<a name='928'>
        g_xkmh(i,k,j) = g_xkmh(i,k,j)*(0.5+sign(0.5,10.*mlen_h-xkmh(i,k,j)))<a name='929'>
        xkmh(i,k,j) = min(xkmh(i,k,j),10.*mlen_h)<a name='930'>
        g_xkmhd(i,k,j) = g_xkmh(i,k,j)<a name='931'>
        xkmhd(i,k,j) = xkmh(i,k,j)<a name='932'>
      end do<a name='933'>
    end do<a name='934'>
  end do<a name='935'>
else<a name='936'>
  do j = j_start, j_end<a name='937'>
    do k = kts, ktf<a name='938'>
      do i = i_start, i_end<a name='939'>
        deltas = (dx*dy/rdzw(i,k,j))**0.33333333<a name='940'>
        g_tmp = -(g_bn2(i,k,j)*((0.5-sign(0.5,0.-(def2(i,k,j)-bn2(i,k,j)/pr)))/pr))<a name='941'>
        tmp = max(0.,def2(i,k,j)-bn2(i,k,j)/pr)<a name='942'>
        g_tmp = 0.5*g_tmp*tmp**(-0.5)<a name='943'>
        tmp = tmp**0.5<a name='944'>
        g_xkmh(i,k,j) = g_tmp*(0.5+sign(0.5,c_s*c_s*deltas*deltas*tmp-1.e-6*deltas*deltas))*c_s*c_s*deltas*deltas<a name='945'>
        xkmh(i,k,j) = max(c_s*c_s*deltas*deltas*tmp,1.e-6*deltas*deltas)<a name='946'>
        g_xkmh(i,k,j) = g_xkmh(i,k,j)*(0.5+sign(0.5,10.*deltas-xkmh(i,k,j)))<a name='947'>
        xkmh(i,k,j) = min(xkmh(i,k,j),10.*deltas)<a name='948'>
        g_xkmhd(i,k,j) = g_xkmh(i,k,j)<a name='949'>
        xkmhd(i,k,j) = xkmh(i,k,j)<a name='950'>
      end do<a name='951'>
    end do<a name='952'>
  end do<a name='953'>
endif<a name='954'>
<a name='955'>
end subroutine g_smag_km<a name='956'>
<a name='957'>
<a name='958'>
<A NAME='G_TKE_KM'><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_TKE_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='959'>
<font color=#993300>subroutine </font><font color=#cc0000>g_tke_km</font>( config_flags, xkmh, g_xkmh, xkmhd, g_xkmhd, xkmv, xkhh, xkhv, bn2, g_bn2, tke, rdzw, dx, dy, &amp; <A href='../../call_to/G_TKE_KM.html' TARGET='index'>1</A>,<A href='../../call_from/G_TKE_KM.html' TARGET='index'>1</A><a name='960'>
&amp;kh_tke_upper_bound, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='961'>
<font color=#447700>!******************************************************************<a name='962'></font>
<font color=#447700>!******************************************************************<a name='963'></font>
<font color=#447700>!** This routine was generated by Automatic differentiation.     **<a name='964'></font>
<font color=#447700>!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.7.18  **<a name='965'></font>
<font color=#447700>!******************************************************************<a name='966'></font>
<font color=#447700>!******************************************************************<a name='967'></font>
<font color=#447700>!==============================================<a name='968'></font>
<font color=#447700>! all entries are defined explicitly<a name='969'></font>
<font color=#447700>!==============================================<a name='970'></font>
implicit none<a name='971'>
<a name='972'>
<font color=#447700>!==============================================<a name='973'></font>
<font color=#447700>! declare parameters<a name='974'></font>
<font color=#447700>!==============================================<a name='975'></font>
real epsilon<a name='976'>
parameter ( epsilon = 1.e-10 )<a name='977'>
real tke_seed_value<a name='978'>
parameter ( tke_seed_value = 1.e-6 )<a name='979'>
<a name='980'>
<font color=#447700>!==============================================<a name='981'></font>
<font color=#447700>! declare arguments<a name='982'></font>
<font color=#447700>!==============================================<a name='983'></font>
integer, intent(in) :: ime<a name='984'>
integer, intent(in) :: ims<a name='985'>
integer, intent(in) :: jme<a name='986'>
integer, intent(in) :: jms<a name='987'>
integer, intent(in) :: kme<a name='988'>
integer, intent(in) :: kms<a name='989'>
real, intent(in) :: bn2(ims:ime,kms:kme,jms:jme)<a name='990'>
type (grid_config_rec_type), intent(in) :: config_flags<a name='991'>
real, intent(in) :: dx<a name='992'>
real, intent(in) :: dy<a name='993'>
real, intent(in) :: g_bn2(ims:ime,kms:kme,jms:jme)<a name='994'>
real, intent(inout) :: g_xkmh(ims:ime,kms:kme,jms:jme)<a name='995'>
real, intent(inout) :: g_xkmhd(ims:ime,kms:kme,jms:jme)<a name='996'>
integer, intent(in) :: ide<a name='997'>
integer, intent(in) :: ids<a name='998'>
integer, intent(in) :: ite<a name='999'>
integer, intent(in) :: its<a name='1000'>
integer, intent(in) :: jde<a name='1001'>
integer, intent(in) :: jds<a name='1002'>
integer, intent(in) :: jte<a name='1003'>
integer, intent(in) :: jts<a name='1004'>
integer, intent(in) :: kde<a name='1005'>
real, intent(in) :: kh_tke_upper_bound<a name='1006'>
integer, intent(in) :: kte<a name='1007'>
integer, intent(in) :: kts<a name='1008'>
real, intent(in) :: rdzw(ims:ime,kms:kme,jms:jme)<a name='1009'>
real, intent(in) :: tke(ims:ime,kms:kme,jms:jme)<a name='1010'>
real, intent(inout) :: xkhh(ims:ime,kms:kme,jms:jme)<a name='1011'>
real, intent(inout) :: xkhv(ims:ime,kms:kme,jms:jme)<a name='1012'>
real, intent(inout) :: xkmh(ims:ime,kms:kme,jms:jme)<a name='1013'>
real, intent(inout) :: xkmhd(ims:ime,kms:kme,jms:jme)<a name='1014'>
real, intent(inout) :: xkmv(ims:ime,kms:kme,jms:jme)<a name='1015'>
<a name='1016'>
<font color=#447700>!==============================================<a name='1017'></font>
<font color=#447700>! declare local variables<a name='1018'></font>
<font color=#447700>!==============================================<a name='1019'></font>
real cr_len<a name='1020'>
real g_l_scale(its:ite,kts:kte,jts:jte)<a name='1021'>
integer i<a name='1022'>
integer i_end<a name='1023'>
integer i_start<a name='1024'>
integer j<a name='1025'>
integer j_end<a name='1026'>
integer j_start<a name='1027'>
integer k<a name='1028'>
integer ktf<a name='1029'>
real l_scale(its:ite,kts:kte,jts:jte)<a name='1030'>
real mlen_h<a name='1031'>
real tke_seed<a name='1032'>
real tmp<a name='1033'>
<a name='1034'>
<font color=#447700>!----------------------------------------------<a name='1035'></font>
<font color=#447700>! TANGENT LINEAR AND FUNCTION STATEMENTS<a name='1036'></font>
<font color=#447700>!----------------------------------------------<a name='1037'></font>
ktf = min(kte,kde-1)<a name='1038'>
i_start = its<a name='1039'>
i_end = min(ite,ide-1)<a name='1040'>
j_start = jts<a name='1041'>
j_end = min(jte,jde-1)<a name='1042'>
if (config_flags%open_xs .or. config_flags%specified .or. config_flags%nested) then<a name='1043'>
  i_start = max(ids+1,its)<a name='1044'>
endif<a name='1045'>
if (config_flags%open_xe .or. config_flags%specified .or. config_flags%nested) then<a name='1046'>
  i_end = min(ide-2,ite)<a name='1047'>
endif<a name='1048'>
if (config_flags%open_ys .or. config_flags%specified .or. config_flags%nested) then<a name='1049'>
  j_start = max(jds+1,jts)<a name='1050'>
endif<a name='1051'>
if (config_flags%open_ye .or. config_flags%specified .or. config_flags%nested) then<a name='1052'>
  j_end = min(jde-2,jte)<a name='1053'>
endif<a name='1054'>
tke_seed = tke_seed_value<a name='1055'>
if (config_flags%tke_drag_coefficient .gt. epsilon .or. config_flags%tke_heat_flux .gt. epsilon) then<a name='1056'>
  tke_seed = 0.<a name='1057'>
endif<a name='1058'>
cr_len = dx+1.<a name='1059'>
if (dx .gt. cr_len) then<a name='1060'>
  mlen_h = sqrt(dx*dy)<a name='1061'>
  do j = j_start, j_end<a name='1062'>
    do k = kts, ktf<a name='1063'>
      do i = i_start, i_end<a name='1064'>
        tmp = sqrt(max(tke(i,k,j),tke_seed))<a name='1065'>
        g_xkmh(i,k,j) = 0.<a name='1066'>
        xkmh(i,k,j) = max(c_k*tmp*mlen_h,1.e-6*mlen_h*mlen_h)<a name='1067'>
        g_xkmh(i,k,j) = g_xkmh(i,k,j)*(0.5+sign(0.5,10.*mlen_h-xkmh(i,k,j)))<a name='1068'>
        xkmh(i,k,j) = min(xkmh(i,k,j),10.*mlen_h)<a name='1069'>
        g_xkmhd(i,k,j) = g_xkmh(i,k,j)<a name='1070'>
        xkmhd(i,k,j) = xkmh(i,k,j)<a name='1071'>
      end do<a name='1072'>
    end do<a name='1073'>
  end do<a name='1074'>
else<a name='1075'>
  call <A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALC_L_SCALE'>g_calc_l_scale</A><A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_TKE_KM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALC_L_SCALE_1">( tke,bn2,g_bn2,l_scale,g_l_scale,i_start,i_end,ktf,j_start,j_end,dx,dy,rdzw,ims,ime,jms,jme,kms,kme,its,ite,&amp;<a name='1076'>
&amp;jts,jte,kts,kte )<a name='1077'>
  do j = j_start, j_end<a name='1078'>
    do k = kts, ktf<a name='1079'>
      do i = i_start, i_end<a name='1080'>
        tmp = sqrt(max(tke(i,k,j),tke_seed))<a name='1081'>
        g_xkmh(i,k,j) = g_l_scale(i,k,j)*c_k*tmp<a name='1082'>
        xkmh(i,k,j) = c_k*tmp*l_scale(i,k,j)<a name='1083'>
        g_xkmh(i,k,j) = g_xkmh(i,k,j)*(0.5-sign(0.5,xkmh(i,k,j)-kh_tke_upper_bound))<a name='1084'>
        xkmh(i,k,j) = min(kh_tke_upper_bound,xkmh(i,k,j))<a name='1085'>
        g_xkmhd(i,k,j) = g_xkmh(i,k,j)<a name='1086'>
        xkmhd(i,k,j) = xkmh(i,k,j)<a name='1087'>
      end do<a name='1088'>
    end do<a name='1089'>
  end do<a name='1090'>
endif<a name='1091'>
<a name='1092'>
end subroutine g_tke_km<a name='1093'>
<a name='1094'>
<a name='1095'>
end module     g_module_diffusion_em<a name='1096'>
<a name='1097'>
<a name='1098'>
</pre></body></html>