<HTML> <BODY BGCOLOR=#cceeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:DYNAMICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='MODULE_CHECK'><A href='../../html_code/dyn_em/module_check.F.html#MODULE_CHECK' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_check</font> <A href='../../call_to/MODULE_CHECK.html' TARGET='index'>1</A><a name='6'>
<a name='7'>
   USE <A href='../../html_code/dyn_em/module_advect_em_tl.F.html#G_MODULE_ADVECT_EM'>g_module_advect_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_MODULE_ADVECT_EM_1"><a name='8'>
   USE <A href='../../html_code/dyn_em/module_advect_em_ad.F.html#A_MODULE_ADVECT_EM'>a_module_advect_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_MODULE_ADVECT_EM_1"><a name='9'>
   USE <A href='../../html_code/dyn_em/module_em_tl.F.html#G_MODULE_EM'>g_module_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_MODULE_EM_1"><a name='10'>
   USE <A href='../../html_code/dyn_em/module_em_ad.F.html#A_MODULE_EM'>a_module_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_MODULE_EM_1"><a name='11'>
   USE <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_MODULE_BIG_STEP_UTILITIES_EM'>g_module_big_step_utilities_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_MODULE_BIG_STEP_UTILITIES_EM_1"><a name='12'>
   USE <A href='../../html_code/dyn_em/module_big_step_utilities_em_ad.F.html#A_MODULE_BIG_STEP_UTILITIES_EM'>a_module_big_step_utilities_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_MODULE_BIG_STEP_UTILITIES_EM_1"><a name='13'>
   USE <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_MODULE_SMALL_STEP_EM'>g_module_small_step_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_MODULE_SMALL_STEP_EM_1"><a name='14'>
   USE <A href='../../html_code/dyn_em/module_small_step_em_ad.F.html#A_MODULE_SMALL_STEP_EM'>a_module_small_step_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_MODULE_SMALL_STEP_EM_1"><a name='15'>
   USE <A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_MODULE_DIFFUSION_EM'>g_module_diffusion_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_MODULE_DIFFUSION_EM_1"><a name='16'>
   USE <A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_MODULE_DIFFUSION_EM'>a_module_diffusion_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_MODULE_DIFFUSION_EM_1"><a name='17'>
   USE <A href='../../html_code/dyn_em/module_bc_em_tl.F.html#G_MODULE_BC_EM'>g_module_bc_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_MODULE_BC_EM_1"><a name='18'>
   USE <A href='../../html_code/dyn_em/module_bc_em_ad.F.html#A_MODULE_BC_EM'>a_module_bc_em</A><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_MODULE_BC_EM_1"><a name='19'>
<a name='20'>
#ifdef DM_PARALLEL<a name='21'>
   include "<A href='../../html_code/include/mpif.h.html'>mpif.h</A>"<A NAME="mpif.h_1"><A href='../../html_code/dyn_em/module_check.F.html#module_check.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='22'>
   REAL     ::  nsum<a name='23'>
   INTEGER  ::  comm, ierror<a name='24'>
#endif<a name='25'>
<a name='26'>
<a name='27'>
CONTAINS<a name='28'>
<a name='29'>
<font color=#447700>!------------------------------------------------------------------------<a name='30'></font>
<a name='31'>
<A NAME='T_ADVECT_SCALAR'><A href='../../html_code/dyn_em/module_check.F.html#T_ADVECT_SCALAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='32'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_advect_scalar</font> ( field, field_old, tendency, ru, rv, rom, &amp; <A href='../../call_to/T_ADVECT_SCALAR.html' TARGET='index'>1</A>,<A href='../../call_from/T_ADVECT_SCALAR.html' TARGET='index'>5</A><a name='33'>
                         mut, config_flags,            &amp;<a name='34'>
                         msfu, msfv, msft, fzm, fzp,   &amp;<a name='35'>
                         rdx, rdy, rdzw,               &amp;<a name='36'>
                         ids, ide, jds, jde, kds, kde, &amp;<a name='37'>
                         ims, ime, jms, jme, kms, kme, &amp;<a name='38'>
                         its, ite, jts, jte, kts, kte )<a name='39'>
<a name='40'>
<font color=#447700>!  Input variables: field, field_old, tendency, ru, rv, rom, mut<a name='41'></font>
<font color=#447700>!  Output variable: tendency<a name='42'></font>
<font color=#447700>!  Contants: All others<a name='43'></font>
<a name='44'>
   IMPLICIT NONE<a name='45'>
  <a name='46'>
   <font color=#447700>! Input data<a name='47'></font>
  <a name='48'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='49'>
<a name='50'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='51'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='52'>
                                              its, ite, jts, jte, kts, kte<a name='53'>
<a name='54'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )                 :: field,     &amp;<a name='55'>
                                                                      field_old, &amp;<a name='56'>
                                                                      ru,    &amp;<a name='57'>
                                                                      rv,    &amp;<a name='58'>
                                                                      rom<a name='59'>
<a name='60'>
   REAL , DIMENSION( ims:ime , jms:jme )                 :: mut<a name='61'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )                 :: tendency<a name='62'>
<a name='63'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfu,  &amp;<a name='64'>
                                                                    msfv,  &amp;<a name='65'>
                                                                    msft<a name='66'>
<a name='67'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='68'>
                                                                  fzp,  &amp;<a name='69'>
                                                                  rdzw<a name='70'>
<a name='71'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='72'>
                                                                  rdy<a name='73'>
<a name='74'>
   <font color=#447700>! Local data<a name='75'></font>
  <a name='76'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='77'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='78'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='79'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='80'>
<a name='81'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw<a name='82'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='83'>
<a name='84'>
   REAL,  DIMENSION( its:ite+1, kts:kte  ) :: fqx<a name='85'>
   REAL,  DIMENSION( its:ite, kts:kte, 2 ) :: fqy<a name='86'>
<a name='87'>
   INTEGER :: horz_order, vert_order<a name='88'>
  <a name='89'>
   LOGICAL :: degrade_xs, degrade_ys<a name='90'>
   LOGICAL :: degrade_xe, degrade_ye<a name='91'>
<a name='92'>
   INTEGER :: jp1, jp0, jtmp<a name='93'>
<a name='94'>
<a name='95'>
<font color=#447700>! definition of flux operators, 3rd, 4rth, 5th or 6th order<a name='96'></font>
<a name='97'>
   REAL    :: flux3, flux4, flux5, flux6<a name='98'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='99'>
   LOGICAL :: specified <font color=#447700>! changed by Thomas Nehrkorn, AER<a name='100'></font>
<a name='101'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )                 :: S_field,     &amp;<a name='102'>
                                                                      S_field_old, &amp;<a name='103'>
                                                                      S_ru,    &amp;<a name='104'>
                                                                      S_rv,    &amp;<a name='105'>
                                                                      S_rom<a name='106'>
   REAL , DIMENSION( ims:ime , jms:jme )                           :: S_mut<a name='107'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )                 :: S_tendency<a name='108'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )                 :: P_field,     &amp;<a name='109'>
                                                                      P_field_old, &amp;<a name='110'>
                                                                      P_ru,    &amp;<a name='111'>
                                                                      P_rv,    &amp;<a name='112'>
                                                                      P_rom<a name='113'>
   REAL , DIMENSION( ims:ime , jms:jme )                           :: P_mut<a name='114'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )                 :: P_tendency<a name='115'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )                 :: B_field,     &amp;<a name='116'>
                                                                      B_field_old, &amp;<a name='117'>
                                                                      B_ru,    &amp;<a name='118'>
                                                                      B_rv,    &amp;<a name='119'>
                                                                      B_rom<a name='120'>
   REAL , DIMENSION( ims:ime , jms:jme )                           :: B_mut<a name='121'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )                 :: B_tendency<a name='122'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )                 :: K_tendency<a name='123'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='124'>
   INTEGER :: NT<a name='125'>
<a name='126'>
<font color=#447700>!  TGL test<a name='127'></font>
<a name='128'>
   S_field(:,:,:)=field(:,:,:)<a name='129'>
   S_field_old(:,:,:)=field_old(:,:,:)<a name='130'>
   S_ru(:,:,:)=ru(:,:,:)<a name='131'>
   S_rv(:,:,:)=rv(:,:,:)<a name='132'>
   S_rom(:,:,:)=rom(:,:,:)<a name='133'>
   S_mut(:,:)=mut(:,:)<a name='134'>
   S_tendency(:,:,:)=tendency(:,:,:)<a name='135'>
   K_tendency(:,:,:)=tendency(:,:,:)<a name='136'>
<a name='137'>
   P_field(:,:,:)=field(:,:,:)<a name='138'>
   P_field_old(:,:,:)=field_old(:,:,:)<a name='139'>
   P_ru(:,:,:)=ru(:,:,:)<a name='140'>
   P_rv(:,:,:)=rv(:,:,:)<a name='141'>
   P_rom(:,:,:)=rom(:,:,:)<a name='142'>
   P_mut(:,:)=mut(:,:)<a name='143'>
   P_tendency(:,:,:)=tendency(:,:,:)<a name='144'>
<a name='145'>
<font color=#447700>!  NLM<a name='146'></font>
<a name='147'>
   CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR'>advect_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVECT_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_1">   ( field, field_old, tendency,       &amp;<a name='148'>
                             ru, rv, rom,                   &amp;<a name='149'>
                             mut, config_flags,             &amp;<a name='150'>
                             msfu, msfv, msft,              &amp;<a name='151'>
                             fzm, fzp,                      &amp;<a name='152'>
                             rdx, rdy, rdzw,                &amp;<a name='153'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='154'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='155'>
                             its, ite, jts, jte, kts, kte  )<a name='156'>
<a name='157'>
   B_tendency(:,:,:)=tendency(:,:,:)<a name='158'>
<a name='159'>
<font color=#447700>!  TGL<a name='160'></font>
<a name='161'>
   CALL <A href='../../html_code/dyn_em/module_advect_em_tl.F.html#G_ADVECT_SCALAR'>g_advect_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVECT_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_ADVECT_SCALAR_1"> (field, P_field, field_old, P_field_old, K_tendency, P_tendency, &amp;<a name='162'>
                        ru, P_ru, rv, P_rv, rom, P_rom,  &amp;<a name='163'>
                        config_flags,                    &amp;<a name='164'>
                        msft,                            &amp;<a name='165'>
                        fzm, fzp,                        &amp;<a name='166'>
                        rdx, rdy, rdzw,                  &amp;<a name='167'>
                        ids, ide, jds, jde, kde,         &amp;<a name='168'>
                        ims, ime, jms, jme, kms, kme,    &amp;<a name='169'>
                        its, ite, jts, jte, kts, kte  )<a name='170'>
<a name='171'>
   SAVE_L=sum(P_tendency(:,:,:)*P_tendency(:,:,:))<a name='172'>
<a name='173'>
   ALPHA=1.<a name='174'>
   DO NT=1,11<a name='175'>
      ALPHA=0.1*ALPHA<a name='176'>
      FACTOR=1.+ALPHA<a name='177'>
      P_field(:,:,:)=FACTOR*S_field(:,:,:)<a name='178'>
      P_field_old(:,:,:)=FACTOR*S_field_old(:,:,:)<a name='179'>
      P_ru(:,:,:)=FACTOR*S_ru(:,:,:)<a name='180'>
      P_rv(:,:,:)=FACTOR*S_rv(:,:,:)<a name='181'>
      P_rom(:,:,:)=FACTOR*S_rom(:,:,:)<a name='182'>
      P_mut(:,:)=FACTOR*S_mut(:,:)<a name='183'>
      P_tendency(:,:,:)=FACTOR*S_tendency(:,:,:)<a name='184'>
      CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR'>advect_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVECT_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_2">   ( P_field, P_field_old, P_tendency, &amp;<a name='185'>
                             P_ru, P_rv, P_rom,                &amp;<a name='186'>
                             P_mut, config_flags,              &amp;<a name='187'>
                             msfu, msfv, msft,                 &amp;<a name='188'>
                             fzm, fzp,                         &amp;<a name='189'>
                             rdx, rdy, rdzw,                   &amp;<a name='190'>
                             ids, ide, jds, jde, kds, kde,     &amp;<a name='191'>
                             ims, ime, jms, jme, kms, kme,     &amp;<a name='192'>
                             its, ite, jts, jte, kts, kte  )<a name='193'>
      VAL_N=sum((P_tendency(:,:,:)-B_tendency(:,:,:))*  &amp;<a name='194'>
                     (P_tendency(:,:,:)-B_tendency(:,:,:)))<a name='195'>
      VAL_L=SAVE_L*ALPHA**2<a name='196'>
      COEF=VAL_N/VAL_L<a name='197'>
<a name='198'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='199'>
         'g_advect_scalar: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='200'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='201'>
   ENDDO<a name='202'>
<a name='203'>
<font color=#447700>!  ADJ test<a name='204'></font>
<a name='205'>
   FACTOR=0.1<a name='206'>
   field(:,:,:)=S_field(:,:,:)<a name='207'>
   field_old(:,:,:)=S_field_old(:,:,:)<a name='208'>
   ru(:,:,:)=S_ru(:,:,:)<a name='209'>
   rv(:,:,:)=S_rv(:,:,:)<a name='210'>
   rom(:,:,:)=S_rom(:,:,:)<a name='211'>
   mut(:,:)=S_mut(:,:)<a name='212'>
   tendency(:,:,:)=S_tendency(:,:,:)<a name='213'>
<a name='214'>
   P_field(:,:,:)=FACTOR*S_field(:,:,:)<a name='215'>
   P_field_old(:,:,:)=FACTOR*S_field_old(:,:,:)<a name='216'>
   P_ru(:,:,:)=FACTOR*S_ru(:,:,:)<a name='217'>
   P_rv(:,:,:)=FACTOR*S_rv(:,:,:)<a name='218'>
   P_rom(:,:,:)=FACTOR*S_rom(:,:,:)<a name='219'>
   P_mut(:,:)=FACTOR*S_mut(:,:)<a name='220'>
   P_tendency(:,:,:)=FACTOR*S_tendency(:,:,:)<a name='221'>
<a name='222'>
   B_field(:,:,:)=P_field(:,:,:)<a name='223'>
   B_field_old(:,:,:)=P_field_old(:,:,:)<a name='224'>
   B_ru(:,:,:)=P_ru(:,:,:)<a name='225'>
   B_rv(:,:,:)=P_rv(:,:,:)<a name='226'>
   B_rom(:,:,:)=P_rom(:,:,:)<a name='227'>
   B_mut(:,:)=P_mut(:,:)<a name='228'>
   B_tendency(:,:,:)=P_tendency(:,:,:)<a name='229'>
<a name='230'>
<font color=#447700>!  TGL<a name='231'></font>
<a name='232'>
   call <A href='../../html_code/dyn_em/module_advect_em_tl.F.html#G_ADVECT_SCALAR'>g_advect_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVECT_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_ADVECT_SCALAR_2"> (field, P_field, field_old, P_field_old, tendency, P_tendency, &amp;<a name='233'>
                        ru, P_ru, rv, P_rv, rom, P_rom,  &amp;<a name='234'>
                        config_flags,                    &amp;<a name='235'>
                        msft,                            &amp;<a name='236'>
                        fzm, fzp,                        &amp;<a name='237'>
                        rdx, rdy, rdzw,                  &amp;<a name='238'>
                        ids, ide, jds, jde, kde,         &amp;<a name='239'>
                        ims, ime, jms, jme, kms, kme,    &amp;<a name='240'>
                        its, ite, jts, jte, kts, kte  )<a name='241'>
<a name='242'>
   VAL_L=sum(P_tendency(:,:,:)*P_tendency(:,:,:))<a name='243'>
<a name='244'>
   P_field(:,:,:)=0.<a name='245'>
   P_field_old(:,:,:)=0.<a name='246'>
   P_ru(:,:,:)=0.<a name='247'>
   P_rv(:,:,:)=0.<a name='248'>
   P_rom(:,:,:)=0.<a name='249'>
   P_mut(:,:)=0.<a name='250'>
<a name='251'>
<font color=#447700>!  ADJ<a name='252'></font>
<a name='253'>
   call <A href='../../html_code/dyn_em/module_advect_em_ad.F.html#A_ADVECT_SCALAR'>a_advect_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVECT_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_ADVECT_SCALAR_1"> (field, P_field, field_old, P_field_old, P_tendency, &amp;<a name='254'>
                        ru, P_ru, rv, P_rv, rom, P_rom,  &amp;<a name='255'>
                        config_flags,                    &amp;<a name='256'>
                        msft,                            &amp;<a name='257'>
                        fzm, fzp,                        &amp;<a name='258'>
                        rdx, rdy, rdzw,                  &amp;<a name='259'>
                        ids, ide, jds, jde, kde,         &amp;<a name='260'>
                        ims, ime, jms, jme, kms, kme,    &amp;<a name='261'>
                        its, ite, jts, jte, kts, kte  )<a name='262'>
   VAL_A=sum(P_field(:,:,:)*B_field(:,:,:)) + &amp;<a name='263'>
         sum(P_field_old(:,:,:)*B_field_old(:,:,:))+ &amp;<a name='264'>
         sum(P_tendency(:,:,:)*B_tendency(:,:,:)) + &amp;<a name='265'>
         sum(P_ru(:,:,:)*B_ru(:,:,:)) +  &amp;<a name='266'>
         sum(P_rv(:,:,:)*B_rv(:,:,:))+ &amp;<a name='267'>
         sum(P_rom(:,:,:)*B_rom(:,:,:))<a name='268'>
<a name='269'>
   print*, '                '<a name='270'>
   write(6,*) 'a_advect_scalar: '<a name='271'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='272'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='273'>
<a name='274'>
<font color=#447700>!  RECOVER<a name='275'></font>
<a name='276'>
   field(:,:,:)=S_field(:,:,:)<a name='277'>
   field_old(:,:,:)=S_field_old(:,:,:)<a name='278'>
   ru(:,:,:)=S_ru(:,:,:)<a name='279'>
   rv(:,:,:)=S_rv(:,:,:)<a name='280'>
   rom(:,:,:)=S_rom(:,:,:)<a name='281'>
   mut(:,:)=S_mut(:,:)<a name='282'>
   tendency(:,:,:)=S_tendency(:,:,:)<a name='283'>
<a name='284'>
END SUBROUTINE t_advect_scalar<a name='285'>
<a name='286'>
<font color=#447700>!===================================================================================!<a name='287'></font>
<a name='288'>
<A NAME='T_RK_TENDENCY'><A href='../../html_code/dyn_em/module_check.F.html#T_RK_TENDENCY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='289'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_rk_tendency</font> ( config_flags, rk_step,                         &amp; <A href='../../call_to/T_RK_TENDENCY.html' TARGET='index'>1</A>,<A href='../../call_from/T_RK_TENDENCY.html' TARGET='index'>6</A><a name='290'>
                         ru_tend, rv_tend, rw_tend, ph_tend, t_tend,      &amp;<a name='291'>
                         ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='292'>
                         mu_tend, u_save, v_save, w_save, ph_save,        &amp;<a name='293'>
                         t_save, mu_save, RTHFTEN,                        &amp;<a name='294'>
                         ru, rv, rw, ww,                                  &amp;<a name='295'>
                         u, v, w, t, ph,                                  &amp;<a name='296'>
                         u_old, v_old, w_old, t_old, ph_old,              &amp;<a name='297'>
                         h_diabatic, phb,t_init,                          &amp;<a name='298'>
                         mu, mut, muu, muv, mub,                          &amp;<a name='299'>
                         al, alt, p, pb, php, cqu, cqv, cqw,              &amp;<a name='300'>
                         u_base, v_base, t_base, qv_base, z_base,         &amp;<a name='301'>
                         msfu, msfv, msft, f, e, sina, cosa,              &amp;<a name='302'>
                         fnm, fnp, rdn, rdnw,                             &amp;<a name='303'>
                         dt, rdx, rdy, khdif, kvdif, xkmhd,               &amp;<a name='304'>
                         cf1, cf2, cf3, cfn, cfn1, n_moist,               &amp;<a name='305'>
                         non_hydrostatic, leapfrog,                       &amp;<a name='306'>
                         ids, ide, jds, jde, kds, kde,                    &amp;<a name='307'>
                         ims, ime, jms, jme, kms, kme,                    &amp;<a name='308'>
                         its, ite, jts, jte, kts, kte                    )<a name='309'>
<a name='310'>
<a name='311'>
<font color=#447700>! Input variables : ru,rv,rw,ww,u,v,w,t,ph,u_old,v_old,w_old,t_old,ph_old<a name='312'></font>
<font color=#447700>!                 : phb,al,alt,p,pb,php,cqu,cqv,t_init,xkmhd, h_diabatic <a name='313'></font>
<a name='314'>
<font color=#447700>! Output variables: ru_tend, rv_tend, rw_tend, t_tend, ph_tend, RTHFTEN<a name='315'></font>
<font color=#447700>!                 : u_save, v_save, w_save, ph_save, t_save<a name='316'></font>
<font color=#447700>!                 : mu_tend, mu_save<a name='317'></font>
<a name='318'>
<font color=#447700>! InOut variables : ru_tendf, rv_tendf, rw_tendf, t_tendf, ph_tendf, cqw<a name='319'></font>
<a name='320'>
<font color=#447700>! Contants        : All others<a name='321'></font>
<a name='322'>
<a name='323'>
<a name='324'>
<font color=#447700>! Input variables : ru,rv,rw,ww,u,v,w,t,ph,u_old,v_old,w_old,t_old,ph_old<a name='325'></font>
<font color=#447700>!                 : al,alt,p,php,cqu,cqv,xkmhd<a name='326'></font>
<font color=#447700>!                 : mu,mut,muu,muv,<a name='327'></font>
<a name='328'>
<font color=#447700>! Output variables: ru_tend, rv_tend, rw_tend, t_tend, ph_tend<a name='329'></font>
<font color=#447700>!                 : u_save, v_save, w_save, ph_save, t_save<a name='330'></font>
<font color=#447700>!                 : mu_tend<a name='331'></font>
<a name='332'>
<font color=#447700>! InOut variables : ru_tendf, rv_tendf, rw_tendf, t_tendf, cqw<a name='333'></font>
<a name='334'>
<a name='335'>
   IMPLICIT NONE<a name='336'>
<a name='337'>
   <font color=#447700>!  Input data.<a name='338'></font>
<a name='339'>
   TYPE(grid_config_rec_type)    ,           INTENT(IN   ) :: config_flags<a name='340'>
<a name='341'>
   INTEGER ,               INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='342'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='343'>
                                            its, ite, jts, jte, kts, kte<a name='344'>
<a name='345'>
   LOGICAL ,               INTENT(IN   ) :: non_hydrostatic, leapfrog<a name='346'>
<a name='347'>
   INTEGER ,               INTENT(IN   ) :: n_moist, rk_step<a name='348'>
<a name='349'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )    :: ru,      &amp;<a name='350'>
                                                         rv,      &amp;<a name='351'>
                                                         rw,      &amp;<a name='352'>
                                                         ww,      &amp;<a name='353'>
                                                         u,       &amp;<a name='354'>
                                                         v,       &amp;<a name='355'>
                                                         w,       &amp;<a name='356'>
                                                         t,       &amp;<a name='357'>
                                                         ph,      &amp;<a name='358'>
                                                         u_old,   &amp;<a name='359'>
                                                         v_old,   &amp;<a name='360'>
                                                         w_old,   &amp;<a name='361'>
                                                         t_old,   &amp;<a name='362'>
                                                         ph_old,  &amp;<a name='363'>
                                                         phb,     &amp;<a name='364'>
                                                         al,      &amp;<a name='365'>
                                                         alt,     &amp;<a name='366'>
                                                         p,       &amp;<a name='367'>
                                                         pb,      &amp;<a name='368'>
                                                         php,     &amp;<a name='369'>
                                                         cqu,     &amp;<a name='370'>
                                                         cqv,     &amp;<a name='371'>
                                                         t_init,  &amp;<a name='372'>
                                                         xkmhd,  &amp;<a name='373'>
                                                         h_diabatic<a name='374'>
<a name='375'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) ,              &amp;<a name='376'>
                                        INTENT(OUT  ) :: ru_tend, &amp;<a name='377'>
                                                         rv_tend, &amp;<a name='378'>
                                                         rw_tend, &amp;<a name='379'>
                                                         t_tend,  &amp;<a name='380'>
                                                         ph_tend, &amp;<a name='381'>
                                                         RTHFTEN, &amp;<a name='382'>
                                                          u_save, &amp;<a name='383'>
                                                          v_save, &amp;<a name='384'>
                                                          w_save, &amp;<a name='385'>
                                                         ph_save, &amp;<a name='386'>
                                                          t_save<a name='387'>
<a name='388'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )    :: ru_tendf, &amp;<a name='389'>
                                                         rv_tendf, &amp;<a name='390'>
                                                         rw_tendf, &amp;<a name='391'>
                                                         t_tendf,  &amp;<a name='392'>
                                                         ph_tendf, &amp;<a name='393'>
                                                         cqw<a name='394'>
<a name='395'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(  OUT) :: mu_tend, &amp;<a name='396'>
                                                                    mu_save<a name='397'>
<a name='398'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,   INTENT(IN   )       :: msfu,    &amp;<a name='399'>
                                                                    msfv,    &amp;<a name='400'>
                                                                    msft,    &amp;<a name='401'>
                                                                    f,       &amp;<a name='402'>
                                                                    e,       &amp;<a name='403'>
                                                                    sina,    &amp;<a name='404'>
                                                                    cosa,    &amp;<a name='405'>
                                                                    mub<a name='406'>
   REAL , DIMENSION( ims:ime , jms:jme )                         :: mu,      &amp;<a name='407'>
                                                                    mut,     &amp;<a name='408'>
                                                                    muu,     &amp;<a name='409'>
                                                                    muv<a name='410'>
<a name='411'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fnm,     &amp;<a name='412'>
                                                                  fnp,     &amp;<a name='413'>
                                                                  rdn,     &amp;<a name='414'>
                                                                  rdnw,    &amp;<a name='415'>
                                                                  u_base,  &amp;<a name='416'>
                                                                  v_base,  &amp;<a name='417'>
                                                                  t_base,  &amp;<a name='418'>
                                                                  qv_base, &amp;<a name='419'>
                                                                  z_base<a name='420'>
<a name='421'>
   REAL ,                                      INTENT(IN   ) :: rdx,     &amp;<a name='422'>
                                                                rdy,     &amp;<a name='423'>
                                                                dt,      &amp;<a name='424'>
                                                                khdif,   &amp;<a name='425'>
                                                                kvdif<a name='426'>
<a name='427'>
   REAL    :: kdift, khdq, kvdq, cfn, cfn1, cf1, cf2, cf3<a name='428'>
   INTEGER :: i,j,k<a name='429'>
<a name='430'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )    :: S_ru,      &amp;<a name='431'>
                                                         S_rv,      &amp;<a name='432'>
                                                         S_rw,      &amp;<a name='433'>
                                                         S_ww,      &amp;<a name='434'>
                                                         S_u,       &amp;<a name='435'>
                                                         S_v,       &amp;<a name='436'>
                                                         S_w,       &amp;<a name='437'>
                                                         S_t,       &amp;<a name='438'>
                                                         S_ph,      &amp;<a name='439'>
                                                         S_u_old,   &amp;<a name='440'>
                                                         S_v_old,   &amp;<a name='441'>
                                                         S_w_old,   &amp;<a name='442'>
                                                         S_t_old,   &amp;<a name='443'>
                                                         S_ph_old,  &amp;<a name='444'>
                                                         S_al,      &amp;<a name='445'>
                                                         S_alt,     &amp;<a name='446'>
                                                         S_p,       &amp;<a name='447'>
                                                         S_php,     &amp;<a name='448'>
                                                         S_cqu,     &amp;<a name='449'>
                                                         S_cqv,     &amp;<a name='450'>
                                                         S_xkmhd<a name='451'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )    :: P_ru,      &amp;<a name='452'>
                                                         P_rv,      &amp;<a name='453'>
                                                         P_rw,      &amp;<a name='454'>
                                                         P_ww,      &amp;<a name='455'>
                                                         P_u,       &amp;<a name='456'>
                                                         P_v,       &amp;<a name='457'>
                                                         P_w,       &amp;<a name='458'>
                                                         P_t,       &amp;<a name='459'>
                                                         P_ph,      &amp;<a name='460'>
                                                         P_u_old,   &amp;<a name='461'>
                                                         P_v_old,   &amp;<a name='462'>
                                                         P_w_old,   &amp;<a name='463'>
                                                         P_t_old,   &amp;<a name='464'>
                                                         P_ph_old,  &amp;<a name='465'>
                                                         P_al,      &amp;<a name='466'>
                                                         P_alt,     &amp;<a name='467'>
                                                         P_p,       &amp;<a name='468'>
                                                         P_php,     &amp;<a name='469'>
                                                         P_cqu,     &amp;<a name='470'>
                                                         P_cqv,     &amp;<a name='471'>
                                                         P_xkmhd<a name='472'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )    :: B_ru,      &amp;<a name='473'>
                                                         B_rv,      &amp;<a name='474'>
                                                         B_rw,      &amp;<a name='475'>
                                                         B_ww,      &amp;<a name='476'>
                                                         B_u,       &amp;<a name='477'>
                                                         B_v,       &amp;<a name='478'>
                                                         B_w,       &amp;<a name='479'>
                                                         B_t,       &amp;<a name='480'>
                                                         B_ph,      &amp;<a name='481'>
                                                         B_u_old,   &amp;<a name='482'>
                                                         B_v_old,   &amp;<a name='483'>
                                                         B_w_old,   &amp;<a name='484'>
                                                         B_t_old,   &amp;<a name='485'>
                                                         B_ph_old,  &amp;<a name='486'>
                                                         B_al,      &amp;<a name='487'>
                                                         B_alt,     &amp;<a name='488'>
                                                         B_p,       &amp;<a name='489'>
                                                         B_php,     &amp;<a name='490'>
                                                         B_cqu,     &amp;<a name='491'>
                                                         B_cqv,     &amp;<a name='492'>
                                                         B_xkmhd<a name='493'>
<a name='494'>
   REAL , DIMENSION( ims:ime , jms:jme )              :: S_mu,      &amp;<a name='495'>
                                                         S_mut,     &amp;<a name='496'>
                                                         S_muu,     &amp;<a name='497'>
                                                         S_muv<a name='498'>
   REAL , DIMENSION( ims:ime , jms:jme )              :: P_mu,      &amp;<a name='499'>
                                                         P_mut,     &amp;<a name='500'>
                                                         P_muu,     &amp;<a name='501'>
                                                         P_muv<a name='502'>
   REAL , DIMENSION( ims:ime , jms:jme )              :: B_mu,      &amp;<a name='503'>
                                                         B_mut,     &amp;<a name='504'>
                                                         B_muu,     &amp;<a name='505'>
                                                         B_muv<a name='506'>
<font color=#447700>! INOUT varibales<a name='507'></font>
<a name='508'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )    :: S_ru_tendf, &amp;<a name='509'>
                                                         S_rv_tendf, &amp;<a name='510'>
                                                         S_rw_tendf, &amp;<a name='511'>
                                                         S_t_tendf,  &amp;<a name='512'>
                                                         S_cqw<a name='513'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )    :: P_ru_tendf, &amp;<a name='514'>
                                                         P_rv_tendf, &amp;<a name='515'>
                                                         P_rw_tendf, &amp;<a name='516'>
                                                         P_t_tendf,  &amp;<a name='517'>
                                                         P_cqw<a name='518'>
<a name='519'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )    :: K_ru_tendf, &amp;<a name='520'>
                                                         K_rv_tendf, &amp;<a name='521'>
                                                         K_rw_tendf, &amp;<a name='522'>
                                                         K_t_tendf,  &amp;<a name='523'>
                                                         K_cqw<a name='524'>
<a name='525'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )    :: B_ru_tendf, &amp;<a name='526'>
                                                         B_rv_tendf, &amp;<a name='527'>
                                                         B_rw_tendf, &amp;<a name='528'>
                                                         B_t_tendf,  &amp;<a name='529'>
                                                         B_cqw<a name='530'>
<a name='531'>
<font color=#447700>!  OUT varibales<a name='532'></font>
<a name='533'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )    :: P_ru_tend, &amp;<a name='534'>
                                                         P_rv_tend, &amp;<a name='535'>
                                                         P_rw_tend, &amp;<a name='536'>
                                                         P_t_tend,  &amp;<a name='537'>
                                                         P_ph_tend, &amp;<a name='538'>
                                                         P_u_save, &amp;<a name='539'>
                                                         P_v_save, &amp;<a name='540'>
                                                         P_w_save, &amp;<a name='541'>
                                                         P_ph_save, &amp;<a name='542'>
                                                         P_t_save<a name='543'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )    :: B_ru_tend, &amp;<a name='544'>
                                                         B_rv_tend, &amp;<a name='545'>
                                                         B_rw_tend, &amp;<a name='546'>
                                                         B_t_tend,  &amp;<a name='547'>
                                                         B_ph_tend, &amp;<a name='548'>
                                                         B_u_save, &amp;<a name='549'>
                                                         B_v_save, &amp;<a name='550'>
                                                         B_w_save, &amp;<a name='551'>
                                                         B_ph_save, &amp;<a name='552'>
                                                         B_t_save<a name='553'>
   REAL , DIMENSION( ims:ime , jms:jme )           :: P_mu_tend<a name='554'>
   REAL , DIMENSION( ims:ime , jms:jme )           :: B_mu_tend<a name='555'>
<a name='556'>
<a name='557'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='558'>
   INTEGER :: NT<a name='559'>
<a name='560'>
<font color=#447700>!TGL test<a name='561'></font>
<a name='562'>
   do i=ims,ime<a name='563'>
   do k=kms,kme<a name='564'>
   do j=jms,jme<a name='565'>
      S_ru(i,k,j)=ru(i,k,j)<a name='566'>
      S_rv(i,k,j)=rv(i,k,j)<a name='567'>
      S_rw(i,k,j)=rw(i,k,j)<a name='568'>
      S_ww(i,k,j)=ww(i,k,j)<a name='569'>
      S_u(i,k,j)=u(i,k,j)<a name='570'>
      S_v(i,k,j)=v(i,k,j)<a name='571'>
      S_w(i,k,j)=w(i,k,j)<a name='572'>
      S_t(i,k,j)=t(i,k,j)<a name='573'>
      S_ph(i,k,j)=ph(i,k,j)<a name='574'>
      S_u_old(i,k,j)=u_old(i,k,j)<a name='575'>
      S_v_old(i,k,j)=v_old(i,k,j)<a name='576'>
      S_w_old(i,k,j)=w_old(i,k,j)<a name='577'>
      S_t_old(i,k,j)=t_old(i,k,j)<a name='578'>
      S_ph_old(i,k,j)=ph_old(i,k,j)<a name='579'>
      S_al(i,k,j)=al(i,k,j)<a name='580'>
      S_alt(i,k,j)=alt(i,k,j)<a name='581'>
      S_p(i,k,j)=p(i,k,j)<a name='582'>
      S_php(i,k,j)=php(i,k,j)<a name='583'>
      S_cqu(i,k,j)=cqu(i,k,j)<a name='584'>
      S_cqv(i,k,j)=cqv(i,k,j)<a name='585'>
      S_xkmhd(i,k,j)=xkmhd(i,k,j)<a name='586'>
<a name='587'>
      P_ru(i,k,j)=ru(i,k,j)<a name='588'>
      P_rv(i,k,j)=rv(i,k,j)<a name='589'>
      P_rw(i,k,j)=rw(i,k,j)<a name='590'>
      P_ww(i,k,j)=ww(i,k,j)<a name='591'>
      P_u(i,k,j)=u(i,k,j)<a name='592'>
      P_v(i,k,j)=v(i,k,j)<a name='593'>
      P_w(i,k,j)=w(i,k,j)<a name='594'>
      P_t(i,k,j)=t(i,k,j)<a name='595'>
      P_ph(i,k,j)=ph(i,k,j)<a name='596'>
      P_u_old(i,k,j)=u_old(i,k,j)<a name='597'>
      P_v_old(i,k,j)=v_old(i,k,j)<a name='598'>
      P_w_old(i,k,j)=w_old(i,k,j)<a name='599'>
      P_t_old(i,k,j)=t_old(i,k,j)<a name='600'>
      P_ph_old(i,k,j)=ph_old(i,k,j)<a name='601'>
      P_al(i,k,j)=al(i,k,j)<a name='602'>
      P_alt(i,k,j)=alt(i,k,j)<a name='603'>
      P_p(i,k,j)=p(i,k,j)<a name='604'>
      P_php(i,k,j)=php(i,k,j)<a name='605'>
      P_cqu(i,k,j)=cqu(i,k,j)<a name='606'>
      P_cqv(i,k,j)=cqv(i,k,j)<a name='607'>
      P_xkmhd(i,k,j)=xkmhd(i,k,j)<a name='608'>
   enddo<a name='609'>
   enddo<a name='610'>
   enddo<a name='611'>
<a name='612'>
   do i=ims,ime<a name='613'>
   do k=kms,kme<a name='614'>
   do j=jms,jme<a name='615'>
      S_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='616'>
      S_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='617'>
      S_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='618'>
      S_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='619'>
      S_cqw(i,k,j)=cqw(i,k,j)<a name='620'>
<a name='621'>
      P_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='622'>
      P_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='623'>
      P_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='624'>
      P_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='625'>
      P_cqw(i,k,j)=cqw(i,k,j)<a name='626'>
<a name='627'>
      K_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='628'>
      K_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='629'>
      K_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='630'>
      K_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='631'>
      K_cqw(i,k,j)=cqw(i,k,j)<a name='632'>
<a name='633'>
   enddo<a name='634'>
   enddo<a name='635'>
   enddo<a name='636'>
<a name='637'>
   do i=ims,ime<a name='638'>
   do j=jms,jme<a name='639'>
      S_mu(i,j)=mu(i,j)<a name='640'>
      S_mut(i,j)=mut(i,j)<a name='641'>
      S_muu(i,j)=muu(i,j)<a name='642'>
      S_muv(i,j)=muv(i,j)<a name='643'>
<a name='644'>
      P_mu(i,j)=mu(i,j)<a name='645'>
      P_mut(i,j)=mut(i,j)<a name='646'>
      P_muu(i,j)=muu(i,j)<a name='647'>
      P_muv(i,j)=muv(i,j)<a name='648'>
   enddo<a name='649'>
   enddo<a name='650'>
<a name='651'>
<a name='652'>
<font color=#447700>!NLM<a name='653'></font>
<a name='654'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY'>rk_tendency</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_TENDENCY_1"> ( config_flags, rk_step,                           &amp;<a name='655'>
                         ru_tend, rv_tend, rw_tend, ph_tend, t_tend,      &amp;<a name='656'>
                         ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='657'>
                         mu_tend, u_save, v_save, w_save, ph_save,        &amp;<a name='658'>
                         t_save, mu_save, RTHFTEN,                        &amp;<a name='659'>
                         ru, rv, rw, ww,                                  &amp;<a name='660'>
                         u, v, w, t, ph,                                  &amp;<a name='661'>
                         u_old, v_old, w_old, t_old, ph_old,              &amp;<a name='662'>
                         h_diabatic, phb,t_init,                          &amp;<a name='663'>
                         mu, mut, muu, muv, mub,                          &amp;<a name='664'>
                         al, alt, p, pb, php, cqu, cqv, cqw,              &amp;<a name='665'>
                         u_base, v_base, t_base, qv_base, z_base,         &amp;<a name='666'>
                         msfu, msfv, msft, f, e, sina, cosa,              &amp;<a name='667'>
                         fnm, fnp, rdn, rdnw,                             &amp;<a name='668'>
                         dt, rdx, rdy, khdif, kvdif, xkmhd,               &amp;<a name='669'>
                         cf1, cf2, cf3, cfn, cfn1, n_moist,               &amp;<a name='670'>
                         non_hydrostatic, leapfrog,                       &amp;<a name='671'>
                         ids, ide, jds, jde, kds, kde,                    &amp;<a name='672'>
                         ims, ime, jms, jme, kms, kme,                    &amp;<a name='673'>
                         its, ite, jts, jte, kts, kte                    )<a name='674'>
<a name='675'>
   do i=ims,ime<a name='676'>
   do k=kms,kme<a name='677'>
   do j=jms,jme<a name='678'>
      B_ru_tend(i,k,j)=ru_tend(i,k,j)<a name='679'>
      B_rv_tend(i,k,j)=rv_tend(i,k,j)<a name='680'>
      B_rw_tend(i,k,j)=rw_tend(i,k,j)<a name='681'>
      B_t_tend(i,k,j)=t_tend(i,k,j)<a name='682'>
      B_ph_tend(i,k,j)=ph_tend(i,k,j)<a name='683'>
      B_u_save(i,k,j)=u_save(i,k,j)<a name='684'>
      B_v_save(i,k,j)=v_save(i,k,j)<a name='685'>
      B_w_save(i,k,j)=w_save(i,k,j)<a name='686'>
      B_ph_save(i,k,j)=ph_save(i,k,j)<a name='687'>
      B_t_save(i,k,j)=t_save(i,k,j)<a name='688'>
   enddo<a name='689'>
   enddo<a name='690'>
   enddo<a name='691'>
<a name='692'>
   do i=ims,ime<a name='693'>
   do k=kms,kme<a name='694'>
   do j=jms,jme<a name='695'>
      B_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='696'>
      B_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='697'>
      B_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='698'>
      B_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='699'>
      B_cqw(i,k,j)=cqw(i,k,j)<a name='700'>
   enddo<a name='701'>
   enddo<a name='702'>
   enddo<a name='703'>
<a name='704'>
   do i=ims,ime<a name='705'>
   do j=jms,jme<a name='706'>
      B_mu_tend(i,j)=mu_tend(i,j)<a name='707'>
   enddo<a name='708'>
   enddo<a name='709'>
<a name='710'>
<a name='711'>
<font color=#447700>!  TCL<a name='712'></font>
<a name='713'>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_RK_TENDENCY'>g_rk_tendency</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RK_TENDENCY_1">( config_flags, rk_step, ru_tend, P_ru_tend, rv_tend, P_rv_tend, rw_tend, P_rw_tend, ph_tend, P_ph_tend, &amp;<a name='714'>
&amp;t_tend, P_t_tend, K_ru_tendf, P_ru_tendf, K_rv_tendf, P_rv_tendf, K_rw_tendf, P_rw_tendf, K_t_tendf, P_t_tendf, mu_tend, P_mu_tend, &amp;<a name='715'>
&amp;u_save, P_u_save, v_save, P_v_save, w_save, P_w_save, ph_save, P_ph_save, t_save, P_t_save, ru, P_ru, rv, P_rv, rw, P_rw, ww, &amp;<a name='716'>
&amp;P_ww, u, P_u, v, P_v, w, P_w, t, P_t, ph, P_ph, u_old, P_u_old, v_old, P_v_old, w_old, P_w_old, t_old, P_t_old, ph_old, P_ph_old, &amp;<a name='717'>
&amp;phb, t_init, mu, P_mu, mut, P_mut, muu, P_muu, muv, P_muv, mub, al, P_al, alt, P_alt, p, P_p, pb, php, P_php, cqu, P_cqu, cqv, &amp;<a name='718'>
&amp;P_cqv, K_cqw, P_cqw, u_base, v_base, z_base, msfu, msfv, msft, f, e, sina, cosa, fnm, fnp, rdn, rdnw, dt, rdx, rdy, kvdif, xkmhd, &amp;<a name='719'>
&amp;P_xkmhd, cf1, cf2, cf3, cfn, cfn1, non_hydrostatic, leapfrog, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, &amp;<a name='720'>
&amp;jts, jte, kts, kte )<a name='721'>
<a name='722'>
   SAVE_L=0.<a name='723'>
   do i=its,ite<a name='724'>
   do k=kts,kte<a name='725'>
   do j=jts,jte<a name='726'>
      SAVE_L=SAVE_L + P_ru_tend(i,k,j)*P_ru_tend(i,k,j)  &amp;<a name='727'>
                    + P_rv_tend(i,k,j)*P_rv_tend(i,k,j)  &amp;<a name='728'>
                    + P_rw_tend(i,k,j)*P_rw_tend(i,k,j)  &amp;<a name='729'>
                    + P_t_tend(i,k,j)*P_t_tend(i,k,j)    &amp;<a name='730'>
                    + P_ph_tend(i,k,j)*P_ph_tend(i,k,j)  &amp;<a name='731'>
                    + P_u_save(i,k,j)*P_u_save(i,k,j)    &amp;<a name='732'>
                    + P_v_save(i,k,j)*P_v_save(i,k,j)    &amp;<a name='733'>
                    + P_w_save(i,k,j)*P_w_save(i,k,j)    &amp;<a name='734'>
                    + P_ph_save(i,k,j)*P_ph_save(i,k,j)  &amp;<a name='735'>
                    + P_t_save(i,k,j)*P_t_save(i,k,j)   <a name='736'>
   enddo<a name='737'>
   enddo<a name='738'>
   enddo<a name='739'>
   do i=its,ite<a name='740'>
   do k=kts,kte<a name='741'>
   do j=jts,jte<a name='742'>
      SAVE_L=SAVE_L + P_ru_tendf(i,k,j) *P_ru_tendf(i,k,j) &amp;<a name='743'>
                    + P_rv_tendf(i,k,j) *P_rv_tendf(i,k,j) &amp;<a name='744'>
                    + P_rw_tendf(i,k,j) *P_rw_tendf(i,k,j) &amp;<a name='745'>
                    + P_t_tendf(i,k,j) *P_t_tendf(i,k,j)   &amp;<a name='746'>
                    + P_cqw(i,k,j) *P_cqw(i,k,j) <a name='747'>
   enddo<a name='748'>
   enddo<a name='749'>
   enddo<a name='750'>
   do i=its,ite<a name='751'>
   do j=jts,jte<a name='752'>
      SAVE_L=SAVE_L + P_mu_tend(i,j) *P_mu_tend(i,j) <a name='753'>
   enddo<a name='754'>
   enddo<a name='755'>
<a name='756'>
#ifdef DM_PARALLEL<a name='757'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='758'>
                       comm, IERROR )<a name='759'>
   SAVE_L = nsum<a name='760'>
#endif<a name='761'>
<a name='762'>
   ALPHA=1.<a name='763'>
   DO NT=1,11<a name='764'>
      ALPHA=0.1*ALPHA<a name='765'>
      FACTOR=1.+ALPHA<a name='766'>
   do i=ims,ime<a name='767'>
   do k=kms,kme<a name='768'>
   do j=jms,jme<a name='769'>
      P_ru(i,k,j)=FACTOR*S_ru(i,k,j)<a name='770'>
      P_rv(i,k,j)=FACTOR*S_rv(i,k,j)<a name='771'>
      P_rw(i,k,j)=FACTOR*S_rw(i,k,j)<a name='772'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='773'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='774'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='775'>
      P_w(i,k,j)=FACTOR*S_w(i,k,j)<a name='776'>
      P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='777'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='778'>
      P_u_old(i,k,j)=FACTOR*S_u_old(i,k,j)<a name='779'>
      P_v_old(i,k,j)=FACTOR*S_v_old(i,k,j)<a name='780'>
      P_w_old(i,k,j)=FACTOR*S_w_old(i,k,j)<a name='781'>
      P_t_old(i,k,j)=FACTOR*S_t_old(i,k,j)<a name='782'>
      P_ph_old(i,k,j)=FACTOR*S_ph_old(i,k,j)<a name='783'>
      P_al(i,k,j)=FACTOR*S_al(i,k,j)<a name='784'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='785'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='786'>
      P_php(i,k,j)=FACTOR*S_php(i,k,j)<a name='787'>
      P_cqu(i,k,j)=FACTOR*S_cqu(i,k,j)<a name='788'>
      P_cqv(i,k,j)=FACTOR*S_cqv(i,k,j)<a name='789'>
      P_xkmhd(i,k,j)=FACTOR*S_xkmhd(i,k,j)<a name='790'>
   enddo<a name='791'>
   enddo<a name='792'>
   enddo<a name='793'>
<a name='794'>
   do i=ims,ime<a name='795'>
   do k=kms,kme<a name='796'>
   do j=jms,jme<a name='797'>
      P_ru_tendf(i,k,j)=FACTOR*S_ru_tendf(i,k,j)<a name='798'>
      P_rv_tendf(i,k,j)=FACTOR*S_rv_tendf(i,k,j)<a name='799'>
      P_rw_tendf(i,k,j)=FACTOR*S_rw_tendf(i,k,j)<a name='800'>
      P_t_tendf(i,k,j)=FACTOR*S_t_tendf(i,k,j)<a name='801'>
      P_cqw(i,k,j)=FACTOR*S_cqw(i,k,j)<a name='802'>
   enddo<a name='803'>
   enddo<a name='804'>
   enddo<a name='805'>
<a name='806'>
   do i=ims,ime<a name='807'>
   do j=jms,jme<a name='808'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='809'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='810'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='811'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='812'>
   enddo<a name='813'>
   enddo<a name='814'>
<a name='815'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY'>rk_tendency</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_TENDENCY_2"> ( config_flags, rk_step,                                        &amp;<a name='816'>
                         P_ru_tend, P_rv_tend, P_rw_tend, P_ph_tend, P_t_tend,      &amp;<a name='817'>
                         P_ru_tendf, P_rv_tendf, P_rw_tendf, ph_tendf, P_t_tendf, &amp;<a name='818'>
                         P_mu_tend, P_u_save, P_v_save, P_w_save, P_ph_save,        &amp;<a name='819'>
                         P_t_save, mu_save, RTHFTEN,                            &amp;<a name='820'>
                         P_ru, P_rv, P_rw, P_ww,                                    &amp;<a name='821'>
                         P_u, P_v, P_w, P_t, P_ph,                                  &amp;<a name='822'>
                         P_u_old, P_v_old, P_w_old, P_t_old, P_ph_old,              &amp;<a name='823'>
                         h_diabatic, phb,t_init,                              &amp;<a name='824'>
                         P_mu, P_mut, P_muu, P_muv, mub,                                    &amp;<a name='825'>
                         P_al, P_alt, P_p, pb, P_php, P_cqu, P_cqv, P_cqw,        &amp;<a name='826'>
                         u_base, v_base, t_base, qv_base, z_base,                   &amp;<a name='827'>
                         msfu, msfv, msft, f, e, sina, cosa,                        &amp;<a name='828'>
                         fnm, fnp, rdn, rdnw,                                       &amp;<a name='829'>
                         dt, rdx, rdy, khdif, kvdif, P_xkmhd,                         &amp;<a name='830'>
                         cf1, cf2, cf3, cfn, cfn1, n_moist,                         &amp;<a name='831'>
                         non_hydrostatic, leapfrog,                                 &amp;<a name='832'>
                         ids, ide, jds, jde, kds, kde,                              &amp;<a name='833'>
                         ims, ime, jms, jme, kms, kme,                              &amp;<a name='834'>
                         its, ite, jts, jte, kts, kte                    )<a name='835'>
<a name='836'>
<a name='837'>
      VAL_N=0.<a name='838'>
      do i=its,ite<a name='839'>
      do k=kts,kte<a name='840'>
      do j=jts,jte<a name='841'>
         VAL_N=VAL_N+(P_ru_tend(i,k,j)- B_ru_tend(i,k,j))*(P_ru_tend(i,k,j)- B_ru_tend(i,k,j))  &amp;<a name='842'>
                    +(P_rv_tend(i,k,j)- B_rv_tend(i,k,j))*(P_rv_tend(i,k,j)- B_rv_tend(i,k,j))   &amp;<a name='843'>
                    +(P_rw_tend(i,k,j)- B_rw_tend(i,k,j))*(P_rw_tend(i,k,j)- B_rw_tend(i,k,j))   &amp;<a name='844'>
                    +(P_t_tend(i,k,j)- B_t_tend(i,k,j))*(P_t_tend(i,k,j)- B_t_tend(i,k,j))       &amp;<a name='845'>
                    +(P_ph_tend(i,k,j)- B_ph_tend(i,k,j))*(P_ph_tend(i,k,j)- B_ph_tend(i,k,j))   &amp;<a name='846'>
                    +(P_u_save(i,k,j)- B_u_save(i,k,j))*(P_u_save(i,k,j)- B_u_save(i,k,j))       &amp;<a name='847'>
                    +(P_v_save(i,k,j)- B_v_save(i,k,j))*(P_v_save(i,k,j)- B_v_save(i,k,j))       &amp;<a name='848'>
                    +(P_w_save(i,k,j)- B_w_save(i,k,j))*(P_w_save(i,k,j)- B_w_save(i,k,j))       &amp;<a name='849'>
                    +(P_ph_save(i,k,j)- B_ph_save(i,k,j))*(P_ph_save(i,k,j)- B_ph_save(i,k,j))    &amp;<a name='850'>
                    +(P_t_save(i,k,j)- B_t_save(i,k,j))*(P_t_save(i,k,j)- B_t_save(i,k,j))     <a name='851'>
      enddo<a name='852'>
      enddo<a name='853'>
      enddo<a name='854'>
<a name='855'>
      do i=its,ite<a name='856'>
      do k=kts,kte<a name='857'>
      do j=jts,jte<a name='858'>
         VAL_N=VAL_N+(P_ru_tendf(i,k,j)- B_ru_tendf(i,k,j))*(P_ru_tendf(i,k,j)- B_ru_tendf(i,k,j))  &amp;<a name='859'>
                    +(P_rv_tendf(i,k,j)- B_rv_tendf(i,k,j))*(P_rv_tendf(i,k,j)- B_rv_tendf(i,k,j))  &amp;<a name='860'>
                    +(P_rw_tendf(i,k,j)- B_rw_tendf(i,k,j))*(P_rw_tendf(i,k,j)- B_rw_tendf(i,k,j))  &amp;<a name='861'>
                    +(P_t_tendf(i,k,j)- B_t_tendf(i,k,j))*(P_t_tendf(i,k,j)- B_t_tendf(i,k,j))      &amp;<a name='862'>
                    +(P_cqw(i,k,j)- B_cqw(i,k,j))*(P_cqw(i,k,j)- B_cqw(i,k,j))<a name='863'>
      enddo<a name='864'>
      enddo<a name='865'>
      enddo<a name='866'>
<a name='867'>
      do i=its,ite<a name='868'>
      do j=jts,jte<a name='869'>
         VAL_N=VAL_N+(P_mu_tend(i,j)- B_mu_tend(i,j))*(P_mu_tend(i,j)- B_mu_tend(i,j))   <a name='870'>
      enddo<a name='871'>
      enddo<a name='872'>
<a name='873'>
#ifdef DM_PARALLEL<a name='874'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='875'>
                       comm, IERROR )<a name='876'>
   VAL_N = nsum<a name='877'>
#endif<a name='878'>
<a name='879'>
      VAL_L=SAVE_L*ALPHA**2<a name='880'>
      COEF=VAL_N/VAL_L<a name='881'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='882'>
         'g_rk_tendency: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='883'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='884'>
   ENDDO<a name='885'>
<a name='886'>
<font color=#447700>!  ADJ test<a name='887'></font>
<a name='888'>
   FACTOR=0.1<a name='889'>
   do i=ims,ime<a name='890'>
   do k=kms,kme<a name='891'>
   do j=jms,jme<a name='892'>
<a name='893'>
      ru(i,k,j)=S_ru(i,k,j)<a name='894'>
      rv(i,k,j)=S_rv(i,k,j)<a name='895'>
      rw(i,k,j)=S_rw(i,k,j)<a name='896'>
      ww(i,k,j)=S_ww(i,k,j)<a name='897'>
      u(i,k,j)=S_u(i,k,j)<a name='898'>
      v(i,k,j)=S_v(i,k,j)<a name='899'>
      w(i,k,j)=S_w(i,k,j)<a name='900'>
      t(i,k,j)=S_t(i,k,j)<a name='901'>
      ph(i,k,j)=S_ph(i,k,j)<a name='902'>
      u_old(i,k,j)=S_u_old(i,k,j)<a name='903'>
      v_old(i,k,j)=S_v_old(i,k,j)<a name='904'>
      w_old(i,k,j)=S_w_old(i,k,j)<a name='905'>
      t_old(i,k,j)=S_t_old(i,k,j)<a name='906'>
      ph_old(i,k,j)=S_ph_old(i,k,j)<a name='907'>
      al(i,k,j)=S_al(i,k,j)<a name='908'>
      alt(i,k,j)=S_alt(i,k,j)<a name='909'>
      p(i,k,j)=S_p(i,k,j)<a name='910'>
      php(i,k,j)=S_php(i,k,j)<a name='911'>
      cqu(i,k,j)=S_cqu(i,k,j)<a name='912'>
      cqv(i,k,j)=S_cqv(i,k,j)<a name='913'>
      xkmhd(i,k,j)=S_xkmhd(i,k,j)<a name='914'>
<a name='915'>
<a name='916'>
      P_ru(i,k,j)=FACTOR*S_ru(i,k,j)<a name='917'>
      P_rv(i,k,j)=FACTOR*S_rv(i,k,j)<a name='918'>
      P_rw(i,k,j)=FACTOR*S_rw(i,k,j)<a name='919'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='920'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='921'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='922'>
      P_w(i,k,j)=FACTOR*S_w(i,k,j)<a name='923'>
      P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='924'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='925'>
      P_u_old(i,k,j)=FACTOR*S_u_old(i,k,j)<a name='926'>
      P_v_old(i,k,j)=FACTOR*S_v_old(i,k,j)<a name='927'>
      P_w_old(i,k,j)=FACTOR*S_w_old(i,k,j)<a name='928'>
      P_t_old(i,k,j)=FACTOR*S_t_old(i,k,j)<a name='929'>
      P_ph_old(i,k,j)=FACTOR*S_ph_old(i,k,j)<a name='930'>
      P_al(i,k,j)=FACTOR*S_al(i,k,j)<a name='931'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='932'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='933'>
      P_php(i,k,j)=FACTOR*S_php(i,k,j)<a name='934'>
      P_cqu(i,k,j)=FACTOR*S_cqu(i,k,j)<a name='935'>
      P_cqv(i,k,j)=FACTOR*S_cqv(i,k,j)<a name='936'>
      P_xkmhd(i,k,j)=FACTOR*S_xkmhd(i,k,j)<a name='937'>
<a name='938'>
      B_ru(i,k,j)=P_ru(i,k,j)<a name='939'>
      B_rv(i,k,j)=P_rv(i,k,j)<a name='940'>
      B_rw(i,k,j)=P_rw(i,k,j)<a name='941'>
      B_ww(i,k,j)=P_ww(i,k,j)<a name='942'>
      B_u(i,k,j)=P_u(i,k,j)<a name='943'>
      B_v(i,k,j)=P_v(i,k,j)<a name='944'>
      B_w(i,k,j)=P_w(i,k,j)<a name='945'>
      B_t(i,k,j)=P_t(i,k,j)<a name='946'>
      B_ph(i,k,j)=P_ph(i,k,j)<a name='947'>
      B_u_old(i,k,j)=P_u_old(i,k,j)<a name='948'>
      B_v_old(i,k,j)=P_v_old(i,k,j)<a name='949'>
      B_w_old(i,k,j)=P_w_old(i,k,j)<a name='950'>
      B_t_old(i,k,j)=P_t_old(i,k,j)<a name='951'>
      B_ph_old(i,k,j)=P_ph_old(i,k,j)<a name='952'>
      B_al(i,k,j)=P_al(i,k,j)<a name='953'>
      B_alt(i,k,j)=P_alt(i,k,j)<a name='954'>
      B_p(i,k,j)=P_p(i,k,j)<a name='955'>
      B_php(i,k,j)=P_php(i,k,j)<a name='956'>
      B_cqu(i,k,j)=P_cqu(i,k,j)<a name='957'>
      B_cqv(i,k,j)=P_cqv(i,k,j)<a name='958'>
      B_xkmhd(i,k,j)=P_xkmhd(i,k,j)<a name='959'>
<a name='960'>
   enddo<a name='961'>
   enddo<a name='962'>
   enddo<a name='963'>
<a name='964'>
   do i=ims,ime<a name='965'>
   do k=kms,kme<a name='966'>
   do j=jms,jme<a name='967'>
<a name='968'>
      ru_tendf(i,k,j)=S_ru_tendf(i,k,j)<a name='969'>
      rv_tendf(i,k,j)=S_rv_tendf(i,k,j)<a name='970'>
      rw_tendf(i,k,j)=S_rw_tendf(i,k,j)<a name='971'>
      t_tendf(i,k,j)=S_t_tendf(i,k,j)<a name='972'>
      cqw(i,k,j)=S_cqw(i,k,j)<a name='973'>
<a name='974'>
      P_ru_tendf(i,k,j)=FACTOR*S_ru_tendf(i,k,j)<a name='975'>
      P_rv_tendf(i,k,j)=FACTOR*S_rv_tendf(i,k,j)<a name='976'>
      P_rw_tendf(i,k,j)=FACTOR*S_rw_tendf(i,k,j)<a name='977'>
      P_t_tendf(i,k,j)=FACTOR*S_t_tendf(i,k,j)<a name='978'>
      P_cqw(i,k,j)=FACTOR*S_cqw(i,k,j)<a name='979'>
<a name='980'>
      B_ru_tendf(i,k,j)=P_ru_tendf(i,k,j)<a name='981'>
      B_rv_tendf(i,k,j)=P_rv_tendf(i,k,j)<a name='982'>
      B_rw_tendf(i,k,j)=P_rw_tendf(i,k,j)<a name='983'>
      B_t_tendf(i,k,j)=P_t_tendf(i,k,j)<a name='984'>
      B_cqw(i,k,j)=P_cqw(i,k,j)<a name='985'>
<a name='986'>
      K_cqw(i,k,j)=cqw(i,k,j)<a name='987'>
   enddo<a name='988'>
   enddo<a name='989'>
   enddo<a name='990'>
<a name='991'>
   do i=ims,ime<a name='992'>
   do j=jms,jme<a name='993'>
<a name='994'>
      mu(i,j)=S_mu(i,j)<a name='995'>
      mut(i,j)=S_mut(i,j)<a name='996'>
      muu(i,j)=S_muu(i,j)<a name='997'>
      muv(i,j)=S_muv(i,j)<a name='998'>
<a name='999'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='1000'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='1001'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='1002'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='1003'>
<a name='1004'>
      B_mu(i,j)=P_mu(i,j)<a name='1005'>
      B_mut(i,j)=P_mut(i,j)<a name='1006'>
      B_muu(i,j)=P_muu(i,j)<a name='1007'>
      B_muv(i,j)=P_muv(i,j)<a name='1008'>
<a name='1009'>
   enddo<a name='1010'>
   enddo<a name='1011'>
<a name='1012'>
<font color=#447700>!  TGL<a name='1013'></font>
<a name='1014'>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_RK_TENDENCY'>g_rk_tendency</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RK_TENDENCY_2">( config_flags, rk_step, ru_tend, P_ru_tend, rv_tend, P_rv_tend, rw_tend, P_rw_tend, ph_tend, P_ph_tend, &amp;<a name='1015'>
&amp;t_tend, P_t_tend, ru_tendf, P_ru_tendf, rv_tendf, P_rv_tendf, rw_tendf, P_rw_tendf, t_tendf, P_t_tendf, mu_tend, P_mu_tend, &amp;<a name='1016'>
&amp;u_save, P_u_save, v_save, P_v_save, w_save, P_w_save, ph_save, P_ph_save, t_save, P_t_save, ru, P_ru, rv, P_rv, rw, P_rw, ww, &amp;<a name='1017'>
&amp;P_ww, u, P_u, v, P_v, w, P_w, t, P_t, ph, P_ph, u_old, P_u_old, v_old, P_v_old, w_old, P_w_old, t_old, P_t_old, ph_old, P_ph_old, &amp;<a name='1018'>
&amp;phb, t_init, mu, P_mu, mut, P_mut, muu, P_muu, muv, P_muv, mub, al, P_al, alt, P_alt, p, P_p, pb, php, P_php, cqu, P_cqu, cqv, &amp;<a name='1019'>
&amp;P_cqv, cqw, P_cqw, u_base, v_base, z_base, msfu, msfv, msft, f, e, sina, cosa, fnm, fnp, rdn, rdnw, dt, rdx, rdy, kvdif, xkmhd, &amp;<a name='1020'>
&amp;P_xkmhd, cf1, cf2, cf3, cfn, cfn1, non_hydrostatic, leapfrog, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, &amp;<a name='1021'>
&amp;jts, jte, kts, kte )<a name='1022'>
<a name='1023'>
   VAL_L=0.<a name='1024'>
   do i=its,ite<a name='1025'>
   do k=kts,kte<a name='1026'>
   do j=jts,jte<a name='1027'>
      VAL_L=VAL_L + P_ru_tend(i,k,j)*P_ru_tend(i,k,j)  &amp;<a name='1028'>
                    + P_rv_tend(i,k,j)*P_rv_tend(i,k,j)  &amp;<a name='1029'>
                    + P_rw_tend(i,k,j)*P_rw_tend(i,k,j)  &amp;<a name='1030'>
                    + P_t_tend(i,k,j)*P_t_tend(i,k,j)    &amp;<a name='1031'>
                    + P_ph_tend(i,k,j)*P_ph_tend(i,k,j)  &amp;<a name='1032'>
                    + P_u_save(i,k,j)*P_u_save(i,k,j)    &amp;<a name='1033'>
                    + P_v_save(i,k,j)*P_v_save(i,k,j)    &amp;<a name='1034'>
                    + P_w_save(i,k,j)*P_w_save(i,k,j)    &amp;<a name='1035'>
                    + P_ph_save(i,k,j)*P_ph_save(i,k,j)  &amp;<a name='1036'>
                    + P_t_save(i,k,j)*P_t_save(i,k,j)<a name='1037'>
   enddo<a name='1038'>
   enddo<a name='1039'>
   enddo<a name='1040'>
   do i=its,ite<a name='1041'>
   do k=kts,kte<a name='1042'>
   do j=jts,jte<a name='1043'>
      VAL_L=VAL_L  + P_ru_tendf(i,k,j) *P_ru_tendf(i,k,j) &amp;<a name='1044'>
                    + P_rv_tendf(i,k,j) *P_rv_tendf(i,k,j) &amp;<a name='1045'>
                    + P_rw_tendf(i,k,j) *P_rw_tendf(i,k,j) &amp;<a name='1046'>
                    + P_t_tendf(i,k,j) *P_t_tendf(i,k,j)   &amp;<a name='1047'>
                    + P_cqw(i,k,j) *P_cqw(i,k,j)<a name='1048'>
   enddo<a name='1049'>
   enddo<a name='1050'>
   enddo<a name='1051'>
   do i=its,ite<a name='1052'>
   do j=jts,jte<a name='1053'>
      VAL_L=VAL_L + P_mu_tend(i,j) *P_mu_tend(i,j)<a name='1054'>
   enddo<a name='1055'>
   enddo<a name='1056'>
<a name='1057'>
#ifdef DM_PARALLEL<a name='1058'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='1059'>
                       comm, IERROR )<a name='1060'>
   VAL_L = nsum<a name='1061'>
#endif<a name='1062'>
<a name='1063'>
   do i=ims,ime<a name='1064'>
   do k=kms,kme<a name='1065'>
   do j=jms,jme<a name='1066'>
      P_ru(i,k,j)=0.0<a name='1067'>
      P_rv(i,k,j)=0.0<a name='1068'>
      P_rw(i,k,j)=0.0<a name='1069'>
      P_ww(i,k,j)=0.0<a name='1070'>
      P_u(i,k,j)=0.0<a name='1071'>
      P_v(i,k,j)=0.0<a name='1072'>
      P_w(i,k,j)=0.0<a name='1073'>
      P_t(i,k,j)=0.0<a name='1074'>
      P_ph(i,k,j)=0.0<a name='1075'>
      P_u_old(i,k,j)=0.0<a name='1076'>
      P_v_old(i,k,j)=0.0<a name='1077'>
      P_w_old(i,k,j)=0.0<a name='1078'>
      P_t_old(i,k,j)=0.0<a name='1079'>
      P_ph_old(i,k,j)=0.0<a name='1080'>
      P_al(i,k,j)=0.0<a name='1081'>
      P_alt(i,k,j)=0.0<a name='1082'>
      P_p(i,k,j)=0.0<a name='1083'>
      P_php(i,k,j)=0.0<a name='1084'>
      P_cqu(i,k,j)=0.0<a name='1085'>
      P_cqv(i,k,j)=0.0<a name='1086'>
      P_xkmhd(i,k,j)=0.0<a name='1087'>
   enddo<a name='1088'>
   enddo<a name='1089'>
   enddo<a name='1090'>
   do i=ims,ime<a name='1091'>
   do j=jms,jme<a name='1092'>
      P_mu(i,j)=0.0<a name='1093'>
      P_mut(i,j)=0.0<a name='1094'>
      P_muu(i,j)=0.0<a name='1095'>
      P_muv(i,j)=0.0<a name='1096'>
   enddo<a name='1097'>
   enddo<a name='1098'>
<a name='1099'>
<a name='1100'>
<font color=#447700>!  ADJ<a name='1101'></font>
<a name='1102'>
   CALL <A href='../../html_code/dyn_em/module_em_ad.F.html#A_RK_TENDENCY1'>a_rk_tendency1</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_RK_TENDENCY1_1">( config_flags, rk_step, P_ru_tend, P_rv_tend, P_rw_tend, P_ph_tend, P_t_tend, P_ru_tendf, P_rv_tendf, &amp;<a name='1103'>
&amp;P_rw_tendf, P_t_tendf, P_mu_tend, P_u_save, P_v_save, P_w_save, P_ph_save, P_t_save, ru, P_ru, rv, P_rv, rw, P_rw, ww, P_ww, u, &amp;<a name='1104'>
&amp;P_u, v, P_v, w, P_w, t, P_t, ph, P_ph, u_old, P_u_old, v_old, P_v_old, w_old, P_w_old, t_old, P_t_old, ph_old, P_ph_old, phb, &amp;<a name='1105'>
&amp;t_init, mu, P_mu, mut, P_mut, muu, P_muu, muv, P_muv, mub, al, P_al, alt, P_alt, p, P_p, pb, php, P_php, cqu, P_cqu, cqv, P_cqv, &amp;<a name='1106'>
&amp;K_cqw, P_cqw, u_base, v_base, z_base, msfu, msfv, msft, f, e, sina, cosa, fnm, fnp, rdn, rdnw, dt, rdx, rdy, kvdif, xkmhd, P_xkmhd, &amp;<a name='1107'>
&amp;cf1, cf2, cf3, cfn, cfn1, non_hydrostatic, leapfrog, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, &amp;<a name='1108'>
&amp;kts, kte )<a name='1109'>
<a name='1110'>
#ifdef DM_PARALLEL<a name='1111'>
<font color=#447700>!lineno = __LINE__<a name='1112'></font>
<font color=#447700>!#    include "HALO_3803.inc"<a name='1113'></font>
<a name='1114'>
#endif<a name='1115'>
<a name='1116'>
   CALL <A href='../../html_code/dyn_em/module_em_ad.F.html#A_RK_TENDENCY2'>a_rk_tendency2</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_RK_TENDENCY2_1">( config_flags, rk_step, P_ru_tend, P_rv_tend, P_rw_tend, P_ph_tend, P_t_tend, P_ru_tendf, P_rv_tendf, &amp;<a name='1117'>
&amp;P_rw_tendf, P_t_tendf, P_mu_tend, P_u_save, P_v_save, P_w_save, P_ph_save, P_t_save, ru, P_ru, rv, P_rv, rw, P_rw, ww, P_ww, u, &amp;<a name='1118'>
&amp;P_u, v, P_v, w, P_w, t, P_t, ph, P_ph, u_old, P_u_old, v_old, P_v_old, w_old, P_w_old, t_old, P_t_old, ph_old, P_ph_old, phb, &amp;<a name='1119'>
&amp;t_init, mu, P_mu, mut, P_mut, muu, P_muu, muv, P_muv, mub, al, P_al, alt, P_alt, p, P_p, pb, php, P_php, cqu, P_cqu, cqv, P_cqv, &amp;<a name='1120'>
&amp;K_cqw, P_cqw, u_base, v_base, z_base, msfu, msfv, msft, f, e, sina, cosa, fnm, fnp, rdn, rdnw, dt, rdx, rdy, kvdif, xkmhd, P_xkmhd, &amp;<a name='1121'>
&amp;cf1, cf2, cf3, cfn, cfn1, non_hydrostatic, leapfrog, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, &amp;<a name='1122'>
&amp;kts, kte )<a name='1123'>
<a name='1124'>
<a name='1125'>
   VAL_A=0.<a name='1126'>
   do i=its,ite<a name='1127'>
   do k=kts,kte<a name='1128'>
   do j=jts,jte<a name='1129'>
      VAL_A=VAL_A +P_ru(i,k,j)*B_ru(i,k,j)         &amp;  <a name='1130'>
               +P_rv(i,k,j)*B_rv(i,k,j)            &amp;<a name='1131'>
               +P_rw(i,k,j)*B_rw(i,k,j)            &amp;<a name='1132'>
               +P_ww(i,k,j)*B_ww(i,k,j)            &amp;<a name='1133'>
               +P_u(i,k,j)*B_u(i,k,j)              &amp;<a name='1134'>
               +P_v(i,k,j)*B_v(i,k,j)              &amp;<a name='1135'>
               +P_w(i,k,j)*B_w(i,k,j)              &amp;<a name='1136'>
               +P_t(i,k,j)*B_t(i,k,j)              &amp;<a name='1137'>
               +P_ph(i,k,j)*B_ph(i,k,j)            &amp;<a name='1138'>
               +P_u_old(i,k,j)*B_u_old(i,k,j)      &amp;<a name='1139'>
               +P_v_old(i,k,j)*B_v_old(i,k,j)      &amp;<a name='1140'>
               +P_w_old(i,k,j)*B_w_old(i,k,j)      &amp;<a name='1141'>
               +P_t_old(i,k,j)*B_t_old(i,k,j)      &amp;<a name='1142'>
               +P_ph_old(i,k,j)*B_ph_old(i,k,j)    &amp;<a name='1143'>
               +P_al(i,k,j)*B_al(i,k,j)            &amp;<a name='1144'>
               +P_alt(i,k,j)*B_alt(i,k,j)          &amp;<a name='1145'>
               +P_p(i,k,j)*B_p(i,k,j)              &amp;<a name='1146'>
               +P_php(i,k,j)*B_php(i,k,j)          &amp;<a name='1147'>
               +P_cqu(i,k,j)*B_cqu(i,k,j)          &amp;<a name='1148'>
               +P_cqv(i,k,j)*B_cqv(i,k,j)          &amp;<a name='1149'>
               +P_xkmhd(i,k,j)*B_xkmhd(i,k,j)<a name='1150'>
   enddo<a name='1151'>
   enddo<a name='1152'>
   enddo<a name='1153'>
<a name='1154'>
   do i=its,ite<a name='1155'>
   do k=kts,kte<a name='1156'>
   do j=jts,jte<a name='1157'>
      VAL_A=VAL_A +P_ru_tendf(i,k,j)*B_ru_tendf(i,k,j)   &amp;<a name='1158'>
               +P_rv_tendf(i,k,j)*B_rv_tendf(i,k,j)      &amp;<a name='1159'>
               +P_rw_tendf(i,k,j)*B_rw_tendf(i,k,j)      &amp;<a name='1160'>
               +P_t_tendf(i,k,j)*B_t_tendf(i,k,j)        &amp;<a name='1161'>
               +P_cqw(i,k,j)*B_cqw(i,k,j)<a name='1162'>
   enddo<a name='1163'>
   enddo<a name='1164'>
   enddo<a name='1165'>
<a name='1166'>
   do i=its,ite<a name='1167'>
   do j=jts,jte<a name='1168'>
      VAL_A=VAL_A +P_mu(i,j)*B_mu(i,j)   &amp;<a name='1169'>
               +P_mut(i,j)*B_mut(i,j)    &amp;<a name='1170'>
               +P_muu(i,j)*B_muu(i,j)    &amp;<a name='1171'>
               +P_muv(i,j)*B_muv(i,j)<a name='1172'>
   enddo<a name='1173'>
   enddo<a name='1174'>
<a name='1175'>
#ifdef DM_PARALLEL<a name='1176'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='1177'>
                       comm, IERROR )<a name='1178'>
   VAL_A = nsum<a name='1179'>
#endif<a name='1180'>
<a name='1181'>
   print*, '                '<a name='1182'>
   write(6,*) 'a_rk_tendency: '<a name='1183'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='1184'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='1185'>
<a name='1186'>
<font color=#447700>!  RECOVER<a name='1187'></font>
<a name='1188'>
   do i=ims,ime<a name='1189'>
   do k=kms,kme<a name='1190'>
   do j=jms,jme<a name='1191'>
      ru(i,k,j)=S_ru(i,k,j)<a name='1192'>
      rv(i,k,j)=S_rv(i,k,j)<a name='1193'>
      rw(i,k,j)=S_rw(i,k,j)<a name='1194'>
      ww(i,k,j)=S_ww(i,k,j)<a name='1195'>
      u(i,k,j)=S_u(i,k,j)<a name='1196'>
      v(i,k,j)=S_v(i,k,j)<a name='1197'>
      w(i,k,j)=S_w(i,k,j)<a name='1198'>
      t(i,k,j)=S_t(i,k,j)<a name='1199'>
      ph(i,k,j)=S_ph(i,k,j)<a name='1200'>
      u_old(i,k,j)=S_u_old(i,k,j)<a name='1201'>
      v_old(i,k,j)=S_v_old(i,k,j)<a name='1202'>
      w_old(i,k,j)=S_w_old(i,k,j)<a name='1203'>
      t_old(i,k,j)=S_t_old(i,k,j)<a name='1204'>
      ph_old(i,k,j)=S_ph_old(i,k,j)<a name='1205'>
      al(i,k,j)=S_al(i,k,j)<a name='1206'>
      alt(i,k,j)=S_alt(i,k,j)<a name='1207'>
      p(i,k,j)=S_p(i,k,j)<a name='1208'>
      php(i,k,j)=S_php(i,k,j)<a name='1209'>
      cqu(i,k,j)=S_cqu(i,k,j)<a name='1210'>
      cqv(i,k,j)=S_cqv(i,k,j)<a name='1211'>
      xkmhd(i,k,j)=S_xkmhd(i,k,j)<a name='1212'>
   enddo<a name='1213'>
   enddo<a name='1214'>
   enddo<a name='1215'>
<a name='1216'>
   do i=ims,ime<a name='1217'>
   do k=kms,kme<a name='1218'>
   do j=jms,jme<a name='1219'>
      ru_tendf(i,k,j)=S_ru_tendf(i,k,j)<a name='1220'>
      rv_tendf(i,k,j)=S_rv_tendf(i,k,j)<a name='1221'>
      rw_tendf(i,k,j)=S_rw_tendf(i,k,j)<a name='1222'>
      t_tendf(i,k,j)=S_t_tendf(i,k,j)<a name='1223'>
      cqw(i,k,j)=S_cqw(i,k,j)<a name='1224'>
   enddo<a name='1225'>
   enddo<a name='1226'>
   enddo<a name='1227'>
<a name='1228'>
   do i=ims,ime<a name='1229'>
   do j=jms,jme<a name='1230'>
      mu(i,j)=S_mu(i,j)<a name='1231'>
      mut(i,j)=S_mut(i,j)<a name='1232'>
      muu(i,j)=S_muu(i,j)<a name='1233'>
      muv(i,j)=S_muv(i,j)<a name='1234'>
   enddo<a name='1235'>
   enddo<a name='1236'>
<a name='1237'>
END SUBROUTINE t_rk_tendency<a name='1238'>
<a name='1239'>
<a name='1240'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='1241'></font>
<a name='1242'>
<a name='1243'>
<A NAME='T_RK_STEP_PREP'><A href='../../html_code/dyn_em/module_check.F.html#T_RK_STEP_PREP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1244'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_rk_step_prep</font>  ( config_flags, rk_step,           &amp; <A href='../../call_to/T_RK_STEP_PREP.html' TARGET='index'>1</A>,<A href='../../call_from/T_RK_STEP_PREP.html' TARGET='index'>6</A><a name='1245'>
                           u, v, w, t, ph, mu,              &amp;<a name='1246'>
                           moist,                           &amp;<a name='1247'>
                           ru, rv, rw, ww, php, alt, muu, muv,  &amp;<a name='1248'>
                           mub, mut, phb, pb, p, al, alb,   &amp;<a name='1249'>
                           cqu, cqv, cqw,                   &amp;<a name='1250'>
                           msfu, msfv, msft,                &amp;<a name='1251'>
                           fnm, fnp, dnw, rdx, rdy,         &amp;<a name='1252'>
                           n_moist,                         &amp;<a name='1253'>
                           ids, ide, jds, jde, kds, kde,    &amp;<a name='1254'>
                           ims, ime, jms, jme, kms, kme,    &amp;<a name='1255'>
                           its, ite, jts, jte, kts, kte    )<a name='1256'>
<a name='1257'>
   IMPLICIT NONE<a name='1258'>
<a name='1259'>
<a name='1260'>
   <font color=#447700>!  Input data.<a name='1261'></font>
<a name='1262'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='1263'>
<a name='1264'>
   INTEGER ,       INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1265'>
                                    ims, ime, jms, jme, kms, kme, &amp;<a name='1266'>
                                    its, ite, jts, jte, kts, kte<a name='1267'>
<a name='1268'>
   INTEGER ,       INTENT(IN   ) :: n_moist, rk_step<a name='1269'>
<a name='1270'>
   REAL ,          INTENT(IN   ) :: rdx, rdy<a name='1271'>
<a name='1272'>
   REAL , DIMENSION(  ims:ime , kms:kme, jms:jme ),INTENT(IN ):: t,       &amp;<a name='1273'>
                                                                 phb,     &amp;<a name='1274'>
                                                                 pb,      &amp;<a name='1275'>
                                                                 alb<a name='1276'>
<a name='1277'>
   REAL , DIMENSION(  ims:ime , kms:kme, jms:jme )           ::  u,       &amp;<a name='1278'>
                                                                 v,       &amp;<a name='1279'>
                                                                 w,       &amp;<a name='1280'>
                                                                 ph,      &amp;<a name='1281'>
                                                                 al<a name='1282'>
<a name='1283'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme  ) ,                     &amp;<a name='1284'>
                                               INTENT(  OUT) ::  ru,      &amp;<a name='1285'>
                                                                 rv,      &amp;<a name='1286'>
                                                                 rw,      &amp;<a name='1287'>
                                                                 ww,      &amp;<a name='1288'>
                                                                 php,     &amp;<a name='1289'>
                                                                 cqu,     &amp;<a name='1290'>
                                                                 cqv,     &amp;<a name='1291'>
                                                                 cqw,     &amp;<a name='1292'>
                                                                 alt<a name='1293'>
<a name='1294'>
   REAL , DIMENSION(  ims:ime , kms:kme, jms:jme )           ::  p<a name='1295'>
<a name='1296'>
<a name='1297'>
<a name='1298'>
<a name='1299'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist )   :: moist<a name='1300'>
<a name='1301'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,    INTENT(IN   ) :: msft,   &amp;<a name='1302'>
                                                               msfu,   &amp;<a name='1303'>
                                                               msfv,   &amp;<a name='1304'>
                                                               mub<a name='1305'>
   REAL , DIMENSION( ims:ime , jms:jme )                    :: mu<a name='1306'>
<a name='1307'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,    INTENT(  OUT) :: muu,    &amp;<a name='1308'>
                                                               muv,    &amp;<a name='1309'>
                                                               mut<a name='1310'>
<a name='1311'>
   REAL , DIMENSION( kms:kme ) ,    INTENT(IN   ) :: fnm, fnp, dnw<a name='1312'>
<a name='1313'>
   integer :: i,j,k,h<a name='1314'>
<a name='1315'>
<font color=#447700>!  IN variable<a name='1316'></font>
<a name='1317'>
   REAL , DIMENSION(  ims:ime , kms:kme, jms:jme )           ::  S_u,       &amp;<a name='1318'>
                                                                 S_v,       &amp;<a name='1319'>
                                                                 S_w,       &amp;<a name='1320'>
                                                                 S_ph,      &amp;<a name='1321'>
                                                                 S_al<a name='1322'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist )    ::  S_moist<a name='1323'>
   REAL , DIMENSION( ims:ime , jms:jme )                     ::  S_mu<a name='1324'>
   REAL , DIMENSION(  ims:ime , kms:kme, jms:jme )           ::  P_u,       &amp;<a name='1325'>
                                                                 P_v,       &amp;<a name='1326'>
                                                                 P_w,       &amp;<a name='1327'>
                                                                 P_ph,      &amp;<a name='1328'>
                                                                 P_al<a name='1329'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist )    ::  P_moist<a name='1330'>
   REAL , DIMENSION( ims:ime , jms:jme )                     ::  P_mu<a name='1331'>
<a name='1332'>
   REAL , DIMENSION(  ims:ime , kms:kme, jms:jme )           ::  B_u,       &amp;<a name='1333'>
                                                                 B_v,       &amp;<a name='1334'>
                                                                 B_w,       &amp;<a name='1335'>
                                                                 B_ph,      &amp;<a name='1336'>
                                                                 B_al<a name='1337'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist )    ::  B_moist<a name='1338'>
   REAL , DIMENSION( ims:ime , jms:jme )                     ::  B_mu<a name='1339'>
<a name='1340'>
<a name='1341'>
<font color=#447700>!OUT variable<a name='1342'></font>
<a name='1343'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme  )          ::  P_ru,      &amp;<a name='1344'>
                                                                 P_rv,      &amp;<a name='1345'>
                                                                 P_rw,      &amp;<a name='1346'>
                                                                 P_ww,      &amp;<a name='1347'>
                                                                 P_php,     &amp;<a name='1348'>
                                                                 P_cqu,     &amp;<a name='1349'>
                                                                 P_cqv,     &amp;<a name='1350'>
                                                                 P_cqw,     &amp;<a name='1351'>
                                                                 P_alt<a name='1352'>
   REAL , DIMENSION( ims:ime , jms:jme )                    :: P_muu,    &amp;<a name='1353'>
                                                               P_muv,    &amp;<a name='1354'>
                                                               P_mut<a name='1355'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme  )          ::  B_ru,      &amp;<a name='1356'>
                                                                 B_rv,      &amp;<a name='1357'>
                                                                 B_rw,      &amp;<a name='1358'>
                                                                 B_ww,      &amp;<a name='1359'>
                                                                 B_php,     &amp;<a name='1360'>
                                                                 B_cqu,     &amp;<a name='1361'>
                                                                 B_cqv,     &amp;<a name='1362'>
                                                                 B_cqw,     &amp;<a name='1363'>
                                                                 B_alt<a name='1364'>
   REAL , DIMENSION( ims:ime , jms:jme )                    :: B_muu,    &amp;<a name='1365'>
                                                               B_muv,    &amp;<a name='1366'>
                                                               B_mut<a name='1367'>
<a name='1368'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='1369'>
   INTEGER :: NT<a name='1370'>
<a name='1371'>
<font color=#447700>!TGL test<a name='1372'></font>
<a name='1373'>
   do i=ims,ime<a name='1374'>
   do k=kms,kme<a name='1375'>
   do j=jms,jme<a name='1376'>
      S_u(i,k,j)=u(i,k,j)<a name='1377'>
      S_v(i,k,j)=v(i,k,j)<a name='1378'>
      S_w(i,k,j)=w(i,k,j)<a name='1379'>
      S_ph(i,k,j)=ph(i,k,j)<a name='1380'>
      S_al(i,k,j)=al(i,k,j)<a name='1381'>
<a name='1382'>
      P_u(i,k,j)=u(i,k,j)<a name='1383'>
      P_v(i,k,j)=v(i,k,j)<a name='1384'>
      P_w(i,k,j)=w(i,k,j)<a name='1385'>
      P_ph(i,k,j)=ph(i,k,j)<a name='1386'>
      P_al(i,k,j)=al(i,k,j)<a name='1387'>
   enddo<a name='1388'>
   enddo<a name='1389'>
   enddo<a name='1390'>
<a name='1391'>
   do i=ims,ime<a name='1392'>
   do k=kms,kme<a name='1393'>
   do j=jms,jme<a name='1394'>
   do h=1  ,n_moist<a name='1395'>
      S_moist(i,k,j,h)=moist(i,k,j,h)<a name='1396'>
<a name='1397'>
      P_moist(i,k,j,h)=moist(i,k,j,h)<a name='1398'>
   enddo<a name='1399'>
   enddo<a name='1400'>
   enddo<a name='1401'>
   enddo<a name='1402'>
<a name='1403'>
   do i=ims,ime<a name='1404'>
   do j=jms,jme<a name='1405'>
      S_mu(i,j)=mu(i,j)<a name='1406'>
<a name='1407'>
      P_mu(i,j)=mu(i,j)<a name='1408'>
   enddo<a name='1409'>
   enddo<a name='1410'>
<a name='1411'>
<font color=#447700>!NLM<a name='1412'></font>
<a name='1413'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP'>rk_step_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_STEP_PREP_1">  ( config_flags, rk_step,           &amp;<a name='1414'>
                           u, v, w, t, ph, mu,              &amp;<a name='1415'>
                           moist,                           &amp;<a name='1416'>
                           ru, rv, rw, ww, php, alt, muu, muv,  &amp;<a name='1417'>
                           mub, mut, phb, pb, p, al, alb,   &amp;<a name='1418'>
                           cqu, cqv, cqw,                   &amp;<a name='1419'>
                           msfu, msfv, msft,                &amp;<a name='1420'>
                           fnm, fnp, dnw, rdx, rdy,         &amp;<a name='1421'>
                           n_moist,                         &amp;<a name='1422'>
                           ids, ide, jds, jde, kds, kde,    &amp;<a name='1423'>
                           ims, ime, jms, jme, kms, kme,    &amp;<a name='1424'>
                           its, ite, jts, jte, kts, kte    )<a name='1425'>
<a name='1426'>
   do i=its,ite<a name='1427'>
   do k=kts,kte<a name='1428'>
   do j=jts,jte<a name='1429'>
      B_ru(i,k,j)=ru(i,k,j)<a name='1430'>
      B_rv(i,k,j)=rv(i,k,j)<a name='1431'>
      B_rw(i,k,j)=rw(i,k,j)<a name='1432'>
      B_ww(i,k,j)=ww(i,k,j)<a name='1433'>
      B_php(i,k,j)=php(i,k,j)<a name='1434'>
      B_cqu(i,k,j)=cqu(i,k,j)<a name='1435'>
      B_cqv(i,k,j)=cqv(i,k,j)<a name='1436'>
      B_cqw(i,k,j)=cqw(i,k,j)<a name='1437'>
      B_alt(i,k,j)=alt(i,k,j)<a name='1438'>
   enddo<a name='1439'>
   enddo<a name='1440'>
   enddo<a name='1441'>
<a name='1442'>
   do i=its,ite<a name='1443'>
   do j=jts,jte<a name='1444'>
      B_muu(i,j)=muu(i,j)<a name='1445'>
      B_muv(i,j)=muv(i,j)<a name='1446'>
      B_mut(i,j)=mut(i,j)<a name='1447'>
   enddo<a name='1448'>
   enddo<a name='1449'>
<a name='1450'>
<font color=#447700>!  TCL<a name='1451'></font>
<a name='1452'>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_RK_STEP_PREP'>g_rk_step_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RK_STEP_PREP_1">( config_flags, u, P_u, v, P_v, w, P_w, ph, P_ph, mu, P_mu, moist, P_moist, ru, P_ru, rv, P_rv, rw, P_rw, &amp;<a name='1453'>
&amp;ww, P_ww, php, P_php, alt, P_alt, muu, P_muu, muv, P_muv, mub, mut, P_mut, phb, al, P_al, alb, cqu, P_cqu, cqv, P_cqv, cqw, P_cqw,&amp;<a name='1454'>
&amp; msfu, msfv, msft, dnw, rdx, rdy, n_moist, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='1455'>
<a name='1456'>
   SAVE_L=0.<a name='1457'>
   do i=its,ite<a name='1458'>
   do k=kts,kte<a name='1459'>
   do j=jts,jte<a name='1460'>
      SAVE_L=SAVE_L + P_ru(i,k,j)*P_ru(i,k,j)     &amp;<a name='1461'>
                    + P_rv(i,k,j)*P_rv(i,k,j)     &amp;<a name='1462'>
                    + P_rw(i,k,j)*P_rw(i,k,j)     &amp;<a name='1463'>
                    + P_ww(i,k,j)*P_ww(i,k,j)     &amp;<a name='1464'>
                    + P_php(i,k,j)*P_php(i,k,j)     &amp;<a name='1465'>
                    + P_cqu(i,k,j)*P_cqu(i,k,j)     &amp;<a name='1466'>
                    + P_cqv(i,k,j)*P_cqv(i,k,j)     &amp;<a name='1467'>
                    + P_cqw(i,k,j)*P_cqw(i,k,j)     &amp;<a name='1468'>
                    + P_alt(i,k,j)*P_alt(i,k,j)<a name='1469'>
<a name='1470'>
   enddo<a name='1471'>
   enddo<a name='1472'>
   enddo<a name='1473'>
<a name='1474'>
   do i=its,ite<a name='1475'>
   do j=jts,jte<a name='1476'>
      SAVE_L=SAVE_L + P_muu(i,j)*P_muu(i,j)      &amp;<a name='1477'>
                    + P_muv(i,j)*P_muv(i,j)      &amp;<a name='1478'>
                    + P_mut(i,j)*P_mut(i,j)<a name='1479'>
   enddo<a name='1480'>
   enddo<a name='1481'>
<a name='1482'>
#ifdef DM_PARALLEL      <a name='1483'>
   call <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_3">(comm)<a name='1484'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='1485'>
                       comm, IERROR )<a name='1486'>
   SAVE_L = nsum        <a name='1487'>
#endif                  <a name='1488'>
<a name='1489'>
   ALPHA=1.<a name='1490'>
   DO NT=1,11<a name='1491'>
      ALPHA=0.1*ALPHA<a name='1492'>
      FACTOR=1.+ALPHA<a name='1493'>
<a name='1494'>
   do i=ims,ime<a name='1495'>
   do k=kms,kme<a name='1496'>
   do j=jms,jme<a name='1497'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='1498'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='1499'>
      P_w(i,k,j)=FACTOR*S_w(i,k,j)<a name='1500'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='1501'>
      P_al(i,k,j)=FACTOR*S_al(i,k,j)<a name='1502'>
   enddo<a name='1503'>
   enddo<a name='1504'>
   enddo<a name='1505'>
<a name='1506'>
   do i=ims,ime<a name='1507'>
   do k=kms,kme<a name='1508'>
   do j=jms,jme<a name='1509'>
   do h=1  ,n_moist<a name='1510'>
      P_moist(i,k,j,h)=FACTOR*S_moist(i,k,j,h)<a name='1511'>
   enddo<a name='1512'>
   enddo<a name='1513'>
   enddo<a name='1514'>
   enddo<a name='1515'>
<a name='1516'>
   do i=ims,ime<a name='1517'>
   do j=jms,jme<a name='1518'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='1519'>
   enddo<a name='1520'>
   enddo<a name='1521'>
<a name='1522'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP'>rk_step_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_STEP_PREP_2">  ( config_flags, rk_step,           &amp;<a name='1523'>
                           P_u, P_v, P_w, t, P_ph, P_mu,              &amp;<a name='1524'>
                           P_moist,                           &amp;<a name='1525'>
                           P_ru, P_rv, P_rw, P_ww, P_php, P_alt, P_muu, P_muv,  &amp;<a name='1526'>
                           mub, P_mut, phb, pb, p, P_al, alb,   &amp;<a name='1527'>
                           P_cqu, P_cqv, P_cqw,                   &amp;<a name='1528'>
                           msfu, msfv, msft,                &amp;<a name='1529'>
                           fnm, fnp, dnw, rdx, rdy,         &amp;<a name='1530'>
                           n_moist,                         &amp;<a name='1531'>
                           ids, ide, jds, jde, kds, kde,    &amp;<a name='1532'>
                           ims, ime, jms, jme, kms, kme,    &amp;<a name='1533'>
                           its, ite, jts, jte, kts, kte    )<a name='1534'>
<a name='1535'>
<a name='1536'>
      VAL_N=0.<a name='1537'>
      do i=its,ite<a name='1538'>
      do k=kts,kte<a name='1539'>
      do j=jts,jte<a name='1540'>
         VAL_N=VAL_N +(P_ru(i,k,j) - B_ru(i,k,j))*(P_ru(i,k,j) - B_ru(i,k,j))    &amp;<a name='1541'>
               +(P_rv(i,k,j) - B_rv(i,k,j))*(P_rv(i,k,j) - B_rv(i,k,j))          &amp;<a name='1542'>
               +(P_rw(i,k,j) - B_rw(i,k,j))*(P_rw(i,k,j) - B_rw(i,k,j))          &amp;<a name='1543'>
               +(P_ww(i,k,j) - B_ww(i,k,j))*(P_ww(i,k,j) - B_ww(i,k,j))          &amp;<a name='1544'>
               +(P_php(i,k,j) - B_php(i,k,j))*(P_php(i,k,j) - B_php(i,k,j))      &amp;<a name='1545'>
               +(P_cqu(i,k,j) - B_cqu(i,k,j))*(P_cqu(i,k,j) - B_cqu(i,k,j))      &amp;<a name='1546'>
               +(P_cqv(i,k,j) - B_cqv(i,k,j))*(P_cqv(i,k,j) - B_cqv(i,k,j))      &amp;<a name='1547'>
               +(P_cqw(i,k,j) - B_cqw(i,k,j))*(P_cqw(i,k,j) - B_cqw(i,k,j))      &amp;<a name='1548'>
               +(P_alt(i,k,j) - B_alt(i,k,j))*(P_alt(i,k,j) - B_alt(i,k,j))<a name='1549'>
      enddo<a name='1550'>
      enddo<a name='1551'>
      enddo<a name='1552'>
      do i=its,ite<a name='1553'>
      do j=jts,jte<a name='1554'>
         VAL_N=VAL_N+(P_muu(i,j) - B_muu(i,j))*(P_muu(i,j) - B_muu(i,j))    &amp;<a name='1555'>
               +(P_muv(i,j) - B_muv(i,j))*(P_muv(i,j) - B_muv(i,j))         &amp;<a name='1556'>
               +(P_mut(i,j) - B_mut(i,j))*(P_mut(i,j) - B_mut(i,j))<a name='1557'>
      enddo<a name='1558'>
      enddo<a name='1559'>
<a name='1560'>
#ifdef DM_PARALLEL      <a name='1561'>
      call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='1562'>
                          comm, IERROR )<a name='1563'>
      VAL_N = nsum        <a name='1564'>
#endif                  <a name='1565'>
<a name='1566'>
      VAL_L=SAVE_L*ALPHA**2<a name='1567'>
      COEF=VAL_N/VAL_L<a name='1568'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='1569'>
         'g_rk_step_prep: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='1570'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='1571'>
   ENDDO<a name='1572'>
<a name='1573'>
<font color=#447700>!  ADJ test<a name='1574'></font>
<a name='1575'>
   FACTOR=0.1<a name='1576'>
   do i=ims,ime<a name='1577'>
   do k=kms,kme<a name='1578'>
   do j=jms,jme<a name='1579'>
      u(i,k,j)=S_u(i,k,j)<a name='1580'>
      v(i,k,j)=S_v(i,k,j)<a name='1581'>
      w(i,k,j)=S_w(i,k,j)<a name='1582'>
      ph(i,k,j)=S_ph(i,k,j)<a name='1583'>
      al(i,k,j)=S_al(i,k,j)<a name='1584'>
<a name='1585'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='1586'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='1587'>
      P_w(i,k,j)=FACTOR*S_w(i,k,j)<a name='1588'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='1589'>
      P_al(i,k,j)=FACTOR*S_al(i,k,j)<a name='1590'>
<a name='1591'>
      B_u(i,k,j)=P_u(i,k,j)<a name='1592'>
      B_v(i,k,j)=P_v(i,k,j)<a name='1593'>
      B_w(i,k,j)=P_w(i,k,j)<a name='1594'>
      B_ph(i,k,j)=P_ph(i,k,j)<a name='1595'>
      B_al(i,k,j)=P_al(i,k,j)<a name='1596'>
<a name='1597'>
   enddo<a name='1598'>
   enddo<a name='1599'>
   enddo<a name='1600'>
<a name='1601'>
   do i=ims,ime<a name='1602'>
   do k=kms,kme<a name='1603'>
   do j=jms,jme<a name='1604'>
   do h=1  ,n_moist<a name='1605'>
      moist(i,k,j,h)=S_moist(i,k,j,h)<a name='1606'>
<a name='1607'>
      P_moist(i,k,j,h)=FACTOR*S_moist(i,k,j,h)<a name='1608'>
<a name='1609'>
      B_moist(i,k,j,h)=P_moist(i,k,j,h)<a name='1610'>
   enddo<a name='1611'>
   enddo<a name='1612'>
   enddo<a name='1613'>
   enddo<a name='1614'>
<a name='1615'>
   do i=ims,ime<a name='1616'>
   do j=jms,jme<a name='1617'>
      mu(i,j)=S_mu(i,j)<a name='1618'>
<a name='1619'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='1620'>
<a name='1621'>
      B_mu(i,j)=P_mu(i,j)<a name='1622'>
   enddo<a name='1623'>
   enddo<a name='1624'>
<a name='1625'>
<font color=#447700>!  TGL<a name='1626'></font>
<a name='1627'>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_RK_STEP_PREP'>g_rk_step_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RK_STEP_PREP_2">( config_flags, u, P_u, v, P_v, w, P_w, ph, P_ph, mu, P_mu, moist, P_moist, ru, P_ru, rv, P_rv, rw, P_rw, &amp;<a name='1628'>
&amp;ww, P_ww, php, P_php, alt, P_alt, muu, P_muu, muv, P_muv, mub, mut, P_mut, phb, al, P_al, alb, cqu, P_cqu, cqv, P_cqv, cqw, P_cqw,&amp;<a name='1629'>
&amp; msfu, msfv, msft, dnw, rdx, rdy, n_moist, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='1630'>
<a name='1631'>
   VAL_L=0.<a name='1632'>
   do i=its,ite<a name='1633'>
   do k=kts,kte<a name='1634'>
   do j=jts,jte<a name='1635'>
      VAL_L=VAL_L   + P_ru(i,k,j)*P_ru(i,k,j)     &amp;<a name='1636'>
                    + P_rv(i,k,j)*P_rv(i,k,j)     &amp;<a name='1637'>
                    + P_rw(i,k,j)*P_rw(i,k,j)     &amp;<a name='1638'>
                    + P_ww(i,k,j)*P_ww(i,k,j)     &amp;<a name='1639'>
                    + P_php(i,k,j)*P_php(i,k,j)     &amp;<a name='1640'>
                    + P_cqu(i,k,j)*P_cqu(i,k,j)     &amp;<a name='1641'>
                    + P_cqv(i,k,j)*P_cqv(i,k,j)     &amp;<a name='1642'>
                    + P_cqw(i,k,j)*P_cqw(i,k,j)     &amp;<a name='1643'>
                    + P_alt(i,k,j)*P_alt(i,k,j)<a name='1644'>
<a name='1645'>
   enddo<a name='1646'>
   enddo<a name='1647'>
   enddo<a name='1648'>
<a name='1649'>
   do i=its,ite<a name='1650'>
   do j=jts,jte<a name='1651'>
      VAL_L=VAL_L   + P_muu(i,j)*P_muu(i,j)      &amp;<a name='1652'>
                    + P_muv(i,j)*P_muv(i,j)      &amp;<a name='1653'>
                    + P_mut(i,j)*P_mut(i,j)<a name='1654'>
   enddo<a name='1655'>
   enddo<a name='1656'>
<a name='1657'>
#ifdef DM_PARALLEL      <a name='1658'>
      call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='1659'>
                          comm, IERROR )<a name='1660'>
      VAL_L = nsum<a name='1661'>
#endif  <a name='1662'>
<a name='1663'>
   do i=ims,ime<a name='1664'>
   do k=kms,kme<a name='1665'>
   do j=jms,jme<a name='1666'>
      P_u(i,k,j)=0.0<a name='1667'>
      P_v(i,k,j)=0.0<a name='1668'>
      P_w(i,k,j)=0.0<a name='1669'>
      P_ph(i,k,j)=0.0<a name='1670'>
      P_al(i,k,j)=0.0<a name='1671'>
   enddo<a name='1672'>
   enddo<a name='1673'>
   enddo<a name='1674'>
<a name='1675'>
   do i=ims,ime<a name='1676'>
   do k=kms,kme<a name='1677'>
   do j=jms,jme<a name='1678'>
   do h=1  ,n_moist<a name='1679'>
      P_moist(i,k,j,h)=0.0<a name='1680'>
   enddo<a name='1681'>
   enddo<a name='1682'>
   enddo<a name='1683'>
   enddo<a name='1684'>
<a name='1685'>
   do i=ims,ime<a name='1686'>
   do j=jms,jme<a name='1687'>
      P_mu(i,j)=0.0<a name='1688'>
   enddo<a name='1689'>
   enddo<a name='1690'>
<a name='1691'>
<font color=#447700>!  ADJ<a name='1692'></font>
<a name='1693'>
    CALL <A href='../../html_code/dyn_em/module_em_ad.F.html#A_RK_STEP_PREP'>a_rk_step_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_RK_STEP_PREP_1">( config_flags, u, P_u, v, P_v, w, P_w, P_ph, mu, P_mu, moist, P_moist, P_ru, P_rv, P_rw, P_ww, P_php, &amp;<a name='1694'>
&amp;P_alt, muu, P_muu, muv, P_muv, mub, mut, P_mut, P_al, P_cqu, P_cqv, P_cqw, msfu, msfv, msft, dnw, rdx, rdy, n_moist, ids, ide, &amp;<a name='1695'>
&amp;jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='1696'>
<a name='1697'>
   VAL_A=0.<a name='1698'>
   do i=its,ite<a name='1699'>
   do k=kts,kte<a name='1700'>
   do j=jts,jte<a name='1701'>
      VAL_A=VAL_A + P_u(i,k,j)*B_u(i,k,j)      &amp;<a name='1702'>
                  + P_v(i,k,j)*B_v(i,k,j)      &amp;<a name='1703'>
                  + P_w(i,k,j)*B_w(i,k,j)      &amp;<a name='1704'>
                  + P_ph(i,k,j)*B_ph(i,k,j)      &amp;<a name='1705'>
                  + P_al(i,k,j)*B_al(i,k,j)<a name='1706'>
   enddo<a name='1707'>
   enddo<a name='1708'>
   enddo<a name='1709'>
<a name='1710'>
   do i=its,ite<a name='1711'>
   do k=kts,kte<a name='1712'>
   do j=jts,jte<a name='1713'>
   do h=1  ,n_moist<a name='1714'>
      VAL_A=VAL_A + P_moist(i,k,j,h)*B_moist(i,k,j,h)<a name='1715'>
   enddo<a name='1716'>
   enddo<a name='1717'>
   enddo<a name='1718'>
   enddo<a name='1719'>
<a name='1720'>
   do i=its,ite<a name='1721'>
   do j=jts,jte<a name='1722'>
      VAL_A=VAL_A + P_mu(i,j)*B_mu(i,j)<a name='1723'>
   enddo<a name='1724'>
   enddo<a name='1725'>
<a name='1726'>
#ifdef DM_PARALLEL      <a name='1727'>
      call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='1728'>
                          comm, IERROR )<a name='1729'>
      VAL_A = nsum<a name='1730'>
#endif  <a name='1731'>
<a name='1732'>
   print*, '                '<a name='1733'>
   write(6,*) 'a_rk_step_prep: '<a name='1734'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='1735'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='1736'>
<a name='1737'>
<font color=#447700>!  RECOVER<a name='1738'></font>
<a name='1739'>
   do i=ims,ime<a name='1740'>
   do k=kms,kme<a name='1741'>
   do j=jms,jme<a name='1742'>
      u(i,k,j)=S_u(i,k,j)<a name='1743'>
      v(i,k,j)=S_v(i,k,j)<a name='1744'>
      w(i,k,j)=S_w(i,k,j)<a name='1745'>
      ph(i,k,j)=S_ph(i,k,j)<a name='1746'>
      al(i,k,j)=S_al(i,k,j)<a name='1747'>
   enddo<a name='1748'>
   enddo<a name='1749'>
   enddo<a name='1750'>
<a name='1751'>
   do i=ims,ime<a name='1752'>
   do k=kms,kme<a name='1753'>
   do j=jms,jme<a name='1754'>
   do h=1  ,n_moist<a name='1755'>
      moist(i,k,j,h)=S_moist(i,k,j,h)<a name='1756'>
   enddo<a name='1757'>
   enddo<a name='1758'>
   enddo<a name='1759'>
   enddo<a name='1760'>
<a name='1761'>
   do i=ims,ime<a name='1762'>
   do j=jms,jme<a name='1763'>
      mu(i,j)=S_mu(i,j)<a name='1764'>
   enddo<a name='1765'>
   enddo<a name='1766'>
<a name='1767'>
END SUBROUTINE t_rk_step_prep<a name='1768'>
<a name='1769'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='1770'></font>
<a name='1771'>
<A NAME='T_INIT_ZERO_TENDENCY'><A href='../../html_code/dyn_em/module_check.F.html#T_INIT_ZERO_TENDENCY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1772'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_init_zero_tendency</font>(ru_tendf, rv_tendf, rw_tendf, ph_tendf,  &amp; <A href='../../call_to/T_INIT_ZERO_TENDENCY.html' TARGET='index'>1</A>,<A href='../../call_from/T_INIT_ZERO_TENDENCY.html' TARGET='index'>5</A><a name='1773'>
                              t_tendf,  tke_tendf,                     &amp;<a name='1774'>
                              moist_tendf,chem_tendf,                  &amp;<a name='1775'>
                              n_moist,n_chem,rk_step,                  &amp;<a name='1776'>
                              ids, ide, jds, jde, kds, kde,            &amp;<a name='1777'>
                              ims, ime, jms, jme, kms, kme,            &amp;<a name='1778'>
                              its, ite, jts, jte, kts, kte             )<a name='1779'>
   IMPLICIT NONE<a name='1780'>
<a name='1781'>
   INTEGER ,       INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1782'>
                                    ims, ime, jms, jme, kms, kme, &amp;<a name='1783'>
                                    its, ite, jts, jte, kts, kte<a name='1784'>
<a name='1785'>
   INTEGER ,       INTENT(IN   ) :: n_moist,n_chem,rk_step<a name='1786'>
<a name='1787'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) , INTENT(INOUT) ::  &amp;<a name='1788'>
                                                             ru_tendf, &amp;<a name='1789'>
                                                             rv_tendf, &amp;<a name='1790'>
                                                             rw_tendf, &amp;<a name='1791'>
                                                             ph_tendf, &amp;<a name='1792'>
                                                              t_tendf, &amp;<a name='1793'>
                                                            tke_tendf<a name='1794'>
<a name='1795'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_moist),INTENT(INOUT)::&amp;<a name='1796'>
                                                          moist_tendf<a name='1797'>
<a name='1798'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_chem ),INTENT(INOUT)::&amp;<a name='1799'>
                                                          chem_tendf<a name='1800'>
<a name='1801'>
<font color=#447700>! LOCAL VARS<a name='1802'></font>
<a name='1803'>
   INTEGER :: im, ic,i,j,k,h<a name='1804'>
<a name='1805'>
<font color=#447700>! INOUT variables<a name='1806'></font>
<a name='1807'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )        :: S_ru_tendf, &amp;<a name='1808'>
                                                             S_rv_tendf, &amp;<a name='1809'>
                                                             S_rw_tendf, &amp;<a name='1810'>
                                                             S_ph_tendf, &amp;<a name='1811'>
                                                             S_t_tendf<a name='1812'>
<a name='1813'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )        :: P_ru_tendf, &amp;<a name='1814'>
                                                             P_rv_tendf, &amp;<a name='1815'>
                                                             P_rw_tendf, &amp;<a name='1816'>
                                                             P_ph_tendf, &amp;<a name='1817'>
                                                             P_t_tendf<a name='1818'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )        :: B_ru_tendf, &amp;<a name='1819'>
                                                             B_rv_tendf, &amp;<a name='1820'>
                                                             B_rw_tendf, &amp;<a name='1821'>
                                                             B_ph_tendf, &amp;<a name='1822'>
                                                             B_t_tendf<a name='1823'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )        :: K_ru_tendf, &amp;<a name='1824'>
                                                             K_rv_tendf, &amp;<a name='1825'>
                                                             K_rw_tendf, &amp;<a name='1826'>
                                                             K_ph_tendf, &amp;<a name='1827'>
                                                             K_t_tendf<a name='1828'>
<a name='1829'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_moist)  :: S_moist_tendf, &amp;<a name='1830'>
                                                            P_moist_tendf, &amp;<a name='1831'>
                                                            B_moist_tendf, &amp;<a name='1832'>
                                                            K_moist_tendf<a name='1833'>
<a name='1834'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='1835'>
   INTEGER :: NT<a name='1836'>
<a name='1837'>
<font color=#447700>!TGL test<a name='1838'></font>
<a name='1839'>
   do i=ims,ime<a name='1840'>
   do k=kms,kme<a name='1841'>
   do j=jms,jme<a name='1842'>
       S_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='1843'>
       S_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='1844'>
       S_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='1845'>
       S_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='1846'>
       S_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='1847'>
<a name='1848'>
<font color=#447700>!      P_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='1849'></font>
<font color=#447700>!      P_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='1850'></font>
<font color=#447700>!      P_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='1851'></font>
<font color=#447700>!      P_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='1852'></font>
<font color=#447700>!      P_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='1853'></font>
<a name='1854'>
<font color=#447700>!      K_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='1855'></font>
<font color=#447700>!      K_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='1856'></font>
<font color=#447700>!      K_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='1857'></font>
<font color=#447700>!      K_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='1858'></font>
<font color=#447700>!      K_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='1859'></font>
   enddo<a name='1860'>
   enddo<a name='1861'>
   enddo<a name='1862'>
<a name='1863'>
   do i=ims,ime<a name='1864'>
   do k=kms,kme<a name='1865'>
   do j=jms,jme<a name='1866'>
   do h=1  ,n_moist<a name='1867'>
       S_moist_tendf(i,k,j,h)=moist_tendf(i,k,j,h)<a name='1868'>
<font color=#447700>!      P_moist_tendf(i,k,j,h)=moist_tendf(i,k,j,h)<a name='1869'></font>
<font color=#447700>!      K_moist_tendf(i,k,j,h)=moist_tendf(i,k,j,h)<a name='1870'></font>
   enddo<a name='1871'>
   enddo<a name='1872'>
   enddo<a name='1873'>
   enddo<a name='1874'>
<a name='1875'>
<font color=#447700>!NLM<a name='1876'></font>
<a name='1877'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY'>init_zero_tendency</A><A href='../../html_code/dyn_em/module_check.F.html#T_INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_ZERO_TENDENCY_1">(ru_tendf, rv_tendf, rw_tendf, ph_tendf,  &amp;<a name='1878'>
                              t_tendf,  tke_tendf,                     &amp;<a name='1879'>
                              moist_tendf,chem_tendf,                  &amp;<a name='1880'>
                              n_moist,n_chem,rk_step,                  &amp;<a name='1881'>
                              ids, ide, jds, jde, kds, kde,            &amp;<a name='1882'>
                              ims, ime, jms, jme, kms, kme,            &amp;<a name='1883'>
                              its, ite, jts, jte, kts, kte             )<a name='1884'>
<a name='1885'>
   do i=its,ite<a name='1886'>
   do k=kts,kte<a name='1887'>
   do j=jts,jte<a name='1888'>
      B_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='1889'>
      B_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='1890'>
      B_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='1891'>
      B_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='1892'>
      B_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='1893'>
   enddo<a name='1894'>
   enddo<a name='1895'>
   enddo<a name='1896'>
   do i=its,ite<a name='1897'>
   do k=kts,kte<a name='1898'>
   do j=jts,jte<a name='1899'>
   do h=1  ,n_moist<a name='1900'>
      B_moist_tendf(i,k,j,h)=moist_tendf(i,k,j,h)<a name='1901'>
   enddo<a name='1902'>
   enddo<a name='1903'>
   enddo<a name='1904'>
   enddo<a name='1905'>
<a name='1906'>
<font color=#447700>!  TGL<a name='1907'></font>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_INIT_ZERO_TENDENCY'>g_init_zero_tendency</A><A href='../../html_code/dyn_em/module_check.F.html#T_INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_INIT_ZERO_TENDENCY_1">( ru_tendf, P_ru_tendf, rv_tendf, P_rv_tendf, rw_tendf, P_rw_tendf, ph_tendf, P_ph_tendf, t_tendf, &amp;<a name='1908'>
&amp;P_t_tendf, moist_tendf, P_moist_tendf, n_moist, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='1909'>
<a name='1910'>
   SAVE_L=0.<a name='1911'>
   do i=its,ite<a name='1912'>
   do k=kts,kte<a name='1913'>
   do j=jts,jte<a name='1914'>
      SAVE_L=SAVE_L+ P_ru_tendf(i,k,j)*P_ru_tendf(i,k,j)    &amp;<a name='1915'>
                   + P_rv_tendf(i,k,j)*P_rv_tendf(i,k,j)    &amp;<a name='1916'>
                   + P_rw_tendf(i,k,j)*P_rw_tendf(i,k,j)    &amp;<a name='1917'>
                   + P_ph_tendf(i,k,j)*P_ph_tendf(i,k,j)    &amp;<a name='1918'>
                   + P_t_tendf(i,k,j)*P_t_tendf(i,k,j)<a name='1919'>
   enddo<a name='1920'>
   enddo<a name='1921'>
   enddo<a name='1922'>
   do i=its,ite<a name='1923'>
   do k=kts,kte<a name='1924'>
   do j=jts,jte<a name='1925'>
   do h=1  ,n_moist<a name='1926'>
      SAVE_L=SAVE_L + P_moist_tendf(i,k,j,h)*P_moist_tendf(i,k,j,h)<a name='1927'>
   enddo<a name='1928'>
   enddo<a name='1929'>
   enddo<a name='1930'>
   enddo<a name='1931'>
<a name='1932'>
#ifdef DM_PARALLEL<a name='1933'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='1934'>
                       comm, IERROR )<a name='1935'>
   SAVE_L = nsum<a name='1936'>
#endif<a name='1937'>
<a name='1938'>
   ALPHA=1.<a name='1939'>
   DO NT=1,11<a name='1940'>
      ALPHA=0.1*ALPHA<a name='1941'>
      FACTOR=1.+ALPHA<a name='1942'>
<a name='1943'>
      do i=ims,ime<a name='1944'>
      do k=kms,kme<a name='1945'>
      do j=jms,jme<a name='1946'>
<font color=#447700>!          P_ru_tendf(i,k,j)=FACTOR*S_ru_tendf(i,k,j)<a name='1947'></font>
<font color=#447700>!          P_rv_tendf(i,k,j)=FACTOR*S_rv_tendf(i,k,j)<a name='1948'></font>
<font color=#447700>!          P_rw_tendf(i,k,j)=FACTOR*S_rw_tendf(i,k,j)<a name='1949'></font>
<font color=#447700>!          P_ph_tendf(i,k,j)=FACTOR*S_ph_tendf(i,k,j)<a name='1950'></font>
<font color=#447700>!          P_t_tendf(i,k,j)=FACTOR*S_t_tendf(i,k,j)<a name='1951'></font>
      enddo<a name='1952'>
      enddo<a name='1953'>
      enddo<a name='1954'>
   do i=ims,ime<a name='1955'>
   do k=kms,kme<a name='1956'>
   do j=jms,jme<a name='1957'>
   do h=1  ,n_moist<a name='1958'>
<font color=#447700>!          P_moist_tendf(i,k,j,h)=FACTOR*S_moist_tendf(i,k,j,h)<a name='1959'></font>
   enddo<a name='1960'>
   enddo<a name='1961'>
   enddo<a name='1962'>
   enddo<a name='1963'>
<a name='1964'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY'>init_zero_tendency</A><A href='../../html_code/dyn_em/module_check.F.html#T_INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_ZERO_TENDENCY_2">(P_ru_tendf, P_rv_tendf, P_rw_tendf, P_ph_tendf,  &amp;<a name='1965'>
                              P_t_tendf,  tke_tendf,                     &amp;<a name='1966'>
                              P_moist_tendf,chem_tendf,                  &amp;<a name='1967'>
                              n_moist,n_chem,rk_step,                  &amp;<a name='1968'>
                              ids, ide, jds, jde, kds, kde,            &amp;<a name='1969'>
                              ims, ime, jms, jme, kms, kme,            &amp;<a name='1970'>
                              its, ite, jts, jte, kts, kte             )<a name='1971'>
<a name='1972'>
   VAL_N=0.<a name='1973'>
   do i=its,ite<a name='1974'>
   do k=kts,kte<a name='1975'>
   do j=jts,jte<a name='1976'>
      VAL_N=VAL_N +(P_ru_tendf(i,k,j)-B_ru_tendf(i,k,j))*(P_ru_tendf(i,k,j)-B_ru_tendf(i,k,j))   &amp;<a name='1977'>
                  +(P_rv_tendf(i,k,j)-B_rv_tendf(i,k,j))*(P_rv_tendf(i,k,j)-B_rv_tendf(i,k,j))      &amp;<a name='1978'>
                  +(P_rw_tendf(i,k,j)-B_rw_tendf(i,k,j))*(P_rw_tendf(i,k,j)-B_rw_tendf(i,k,j))      &amp;<a name='1979'>
                  +(P_ph_tendf(i,k,j)-B_ph_tendf(i,k,j))*(P_ph_tendf(i,k,j)-B_ph_tendf(i,k,j))      &amp;<a name='1980'>
                  +(P_t_tendf(i,k,j)-B_t_tendf(i,k,j))*(P_t_tendf(i,k,j)-B_t_tendf(i,k,j))<a name='1981'>
   enddo<a name='1982'>
   enddo<a name='1983'>
   enddo<a name='1984'>
   do i=its,ite<a name='1985'>
   do k=kts,kte<a name='1986'>
   do j=jts,jte<a name='1987'>
   do h=1  ,n_moist<a name='1988'>
      VAL_N=VAL_N +(P_moist_tendf(i,k,j,h)-B_moist_tendf(i,k,j,h))*(P_moist_tendf(i,k,j,h)-B_moist_tendf(i,k,j,h))<a name='1989'>
   enddo<a name='1990'>
   enddo<a name='1991'>
   enddo<a name='1992'>
   enddo<a name='1993'>
<a name='1994'>
#ifdef DM_PARALLEL<a name='1995'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='1996'>
                       comm, IERROR )<a name='1997'>
   VAL_N = nsum<a name='1998'>
#endif<a name='1999'>
<a name='2000'>
      VAL_L=SAVE_L*ALPHA**2<a name='2001'>
      if(VAL_L == 0.) then<a name='2002'>
         COEF = 1.<a name='2003'>
      else<a name='2004'>
         COEF=VAL_N/VAL_L<a name='2005'>
      endif<a name='2006'>
<a name='2007'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='2008'>
         'g_init_zero_tendency: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='2009'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='2010'>
   ENDDO<a name='2011'>
<a name='2012'>
<font color=#447700>!  ADJ test<a name='2013'></font>
<a name='2014'>
   FACTOR=0.1<a name='2015'>
   do i=ims,ime<a name='2016'>
   do k=kms,kme<a name='2017'>
   do j=jms,jme<a name='2018'>
<font color=#447700>!          ru_tendf(i,k,j)=S_ru_tendf(i,k,j)<a name='2019'></font>
<font color=#447700>!          rv_tendf(i,k,j)=S_rv_tendf(i,k,j)<a name='2020'></font>
<font color=#447700>!          rw_tendf(i,k,j)=S_rw_tendf(i,k,j)<a name='2021'></font>
<font color=#447700>!          ph_tendf(i,k,j)=S_ph_tendf(i,k,j)<a name='2022'></font>
<font color=#447700>!          t_tendf(i,k,j)=S_t_tendf(i,k,j)<a name='2023'></font>
<a name='2024'>
<font color=#447700>!          P_ru_tendf(i,k,j)=FACTOR*S_ru_tendf(i,k,j)<a name='2025'></font>
<font color=#447700>!          P_rv_tendf(i,k,j)=FACTOR*S_rv_tendf(i,k,j)<a name='2026'></font>
<font color=#447700>!          P_rw_tendf(i,k,j)=FACTOR*S_rw_tendf(i,k,j)<a name='2027'></font>
<font color=#447700>!          P_ph_tendf(i,k,j)=FACTOR*S_ph_tendf(i,k,j)<a name='2028'></font>
<font color=#447700>!          P_t_tendf(i,k,j)=FACTOR*S_t_tendf(i,k,j)<a name='2029'></font>
<a name='2030'>
<font color=#447700>!          B_ru_tendf(i,k,j)=P_ru_tendf(i,k,j)<a name='2031'></font>
<font color=#447700>!          B_rv_tendf(i,k,j)=P_rv_tendf(i,k,j)<a name='2032'></font>
<font color=#447700>!          B_rw_tendf(i,k,j)=P_rw_tendf(i,k,j)<a name='2033'></font>
<font color=#447700>!          B_ph_tendf(i,k,j)=P_ph_tendf(i,k,j)<a name='2034'></font>
<font color=#447700>!          B_t_tendf(i,k,j)=P_t_tendf(i,k,j)<a name='2035'></font>
<font color=#447700>!<a name='2036'></font>
   enddo<a name='2037'>
   enddo<a name='2038'>
   enddo<a name='2039'>
   do i=ims,ime<a name='2040'>
   do k=kms,kme<a name='2041'>
   do j=jms,jme<a name='2042'>
   do h=1  ,n_moist<a name='2043'>
<font color=#447700>!          moist_tendf(i,k,j,h)=S_moist_tendf(i,k,j,h)<a name='2044'></font>
<font color=#447700>!          P_moist_tendf(i,k,j,h)=FACTOR*S_moist_tendf(i,k,j,h)<a name='2045'></font>
<font color=#447700>!          B_moist_tendf(i,k,j,h)=P_moist_tendf(i,k,j,h)<a name='2046'></font>
   enddo<a name='2047'>
   enddo<a name='2048'>
   enddo<a name='2049'>
   enddo<a name='2050'>
<a name='2051'>
<font color=#447700>!  TGL<a name='2052'></font>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_INIT_ZERO_TENDENCY'>g_init_zero_tendency</A><A href='../../html_code/dyn_em/module_check.F.html#T_INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_INIT_ZERO_TENDENCY_2">( ru_tendf, P_ru_tendf, rv_tendf, P_rv_tendf, rw_tendf, P_rw_tendf, ph_tendf, P_ph_tendf, t_tendf, &amp;<a name='2053'>
&amp;P_t_tendf, moist_tendf, P_moist_tendf, n_moist, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='2054'>
<a name='2055'>
   VAL_L=0.<a name='2056'>
   do i=its,ite<a name='2057'>
   do k=kts,kte<a name='2058'>
   do j=jts,jte<a name='2059'>
      VAL_L=VAL_L +P_ru_tendf(i,k,j)*P_ru_tendf(i,k,j)   &amp;<a name='2060'>
                  +P_rv_tendf(i,k,j)*P_rv_tendf(i,k,j)   &amp;<a name='2061'>
                  +P_rw_tendf(i,k,j)*P_rw_tendf(i,k,j)   &amp;<a name='2062'>
                  +P_ph_tendf(i,k,j)*P_ph_tendf(i,k,j)   &amp;<a name='2063'>
                  +P_t_tendf(i,k,j)*P_t_tendf(i,k,j)<a name='2064'>
   enddo<a name='2065'>
   enddo<a name='2066'>
   enddo<a name='2067'>
   do i=its,ite<a name='2068'>
   do k=kts,kte<a name='2069'>
   do j=jts,jte<a name='2070'>
   do h=1  ,n_moist<a name='2071'>
      VAL_L=VAL_L +P_moist_tendf(i,k,j,h)*P_moist_tendf(i,k,j,h)<a name='2072'>
   enddo<a name='2073'>
   enddo<a name='2074'>
   enddo<a name='2075'>
   enddo<a name='2076'>
<a name='2077'>
#ifdef DM_PARALLEL<a name='2078'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp; <a name='2079'>
                       comm, IERROR )<a name='2080'>
   VAL_L = nsum              <a name='2081'>
#endif                 <a name='2082'>
<a name='2083'>
<font color=#447700>!  ADJ<a name='2084'></font>
<a name='2085'>
   CALL <A href='../../html_code/dyn_em/module_em_ad.F.html#A_INIT_ZERO_TENDENCY'>a_init_zero_tendency</A><A href='../../html_code/dyn_em/module_check.F.html#T_INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_INIT_ZERO_TENDENCY_1">( P_ru_tendf, P_rv_tendf, P_rw_tendf, P_ph_tendf, P_t_tendf, P_moist_tendf, n_moist, ims, ime, jms, &amp;<a name='2086'>
&amp;jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='2087'>
<a name='2088'>
   VAL_A=0.<a name='2089'>
   DO I=its,ite<a name='2090'>
   DO K=kts,kte<a name='2091'>
   DO J=jts,jte<a name='2092'>
<font color=#447700>!      VAL_A=VAL_A +P_ru_tendf(i,k,j)*B_ru_tendf(i,k,j)  &amp;<a name='2093'></font>
<font color=#447700>!                  +P_rv_tendf(i,k,j)*B_rv_tendf(i,k,j)  &amp;<a name='2094'></font>
<font color=#447700>!                  +P_rw_tendf(i,k,j)*B_rw_tendf(i,k,j)  &amp;<a name='2095'></font>
<font color=#447700>!                  +P_ph_tendf(i,k,j)*B_ph_tendf(i,k,j)  &amp;<a name='2096'></font>
<font color=#447700>!                  +P_t_tendf(i,k,j)*B_t_tendf(i,k,j)<a name='2097'></font>
   enddo<a name='2098'>
   enddo<a name='2099'>
   enddo<a name='2100'>
   do i=its,ite<a name='2101'>
   do k=kts,kte<a name='2102'>
   do j=jts,jte<a name='2103'>
   do h=1  ,n_moist<a name='2104'>
<font color=#447700>!      VAL_A=VAL_A +P_moist_tendf(i,k,j,h)*B_moist_tendf(i,k,j,h)<a name='2105'></font>
   enddo<a name='2106'>
   enddo<a name='2107'>
   enddo<a name='2108'>
   enddo<a name='2109'>
<a name='2110'>
#ifdef DM_PARALLEL<a name='2111'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp; <a name='2112'>
                       comm, IERROR )<a name='2113'>
   VAL_A = nsum              <a name='2114'>
#endif                 <a name='2115'>
<a name='2116'>
   print*, '                '<a name='2117'>
   write(6,*) 'a_init_zero_tendency: '<a name='2118'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='2119'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='2120'>
<a name='2121'>
<font color=#447700>!  RECOVER<a name='2122'></font>
<a name='2123'>
   do i=ims,ime<a name='2124'>
   do k=kms,kme<a name='2125'>
   do j=jms,jme<a name='2126'>
          ru_tendf(i,k,j)=S_ru_tendf(i,k,j)<a name='2127'>
          rv_tendf(i,k,j)=S_rv_tendf(i,k,j)<a name='2128'>
          rw_tendf(i,k,j)=S_rw_tendf(i,k,j)<a name='2129'>
          ph_tendf(i,k,j)=S_ph_tendf(i,k,j)<a name='2130'>
          t_tendf(i,k,j)=S_t_tendf(i,k,j)<a name='2131'>
   enddo<a name='2132'>
   enddo<a name='2133'>
   enddo<a name='2134'>
   do i=ims,ime<a name='2135'>
   do k=kms,kme<a name='2136'>
   do j=jms,jme<a name='2137'>
   do h=1  ,n_moist<a name='2138'>
          moist_tendf(i,k,j,h)=S_moist_tendf(i,k,j,h)<a name='2139'>
   enddo<a name='2140'>
   enddo<a name='2141'>
   enddo<a name='2142'>
   enddo<a name='2143'>
<a name='2144'>
END SUBROUTINE t_init_zero_tendency<a name='2145'>
<a name='2146'>
<font color=#447700>!------------------------------------------------------------------------------------------------------------<a name='2147'></font>
<a name='2148'>
<A NAME='T_PHY_PREP'><A href='../../html_code/dyn_em/module_check.F.html#T_PHY_PREP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2149'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_phy_prep</font> ( config_flags,                                &amp;  <font color=#447700>! input <A href='../../call_to/T_PHY_PREP.html' TARGET='index'>1</A>,<A href='../../call_from/T_PHY_PREP.html' TARGET='index'>5</A><a name='2150'></font>
                         mu, u, v, p, pb, alt, ph,                    &amp;  <font color=#447700>! input<a name='2151'></font>
                         phb, t, tsk, moist, n_moist,                 &amp;  <font color=#447700>! input<a name='2152'></font>
                         mu_3d, rho, th_phy, p_phy , pi_phy ,         &amp;  <font color=#447700>! output<a name='2153'></font>
                         u_phy, v_phy, p8w, t_phy, t8w,               &amp;  <font color=#447700>! output<a name='2154'></font>
                         z, z_at_w, dz8w,                             &amp;  <font color=#447700>! output<a name='2155'></font>
                         fzm, fzp,                                    &amp;  <font color=#447700>! params<a name='2156'></font>
                         RTHRATEN,                                    &amp;<a name='2157'>
                         RTHBLTEN, RUBLTEN, RVBLTEN,                  &amp;<a name='2158'>
                         RQVBLTEN, RQCBLTEN, RQIBLTEN,                &amp;<a name='2159'>
                         RTHCUTEN, RQVCUTEN, RQCCUTEN,                &amp;<a name='2160'>
                         RQRCUTEN, RQICUTEN, RQSCUTEN,                &amp;<a name='2161'>
                         RTHFTEN,  RQVFTEN,                           &amp;<a name='2162'>
                         ids, ide, jds, jde, kds, kde,                &amp;<a name='2163'>
                         ims, ime, jms, jme, kms, kme,                &amp;<a name='2164'>
                         its, ite, jts, jte, kts, kte                )<a name='2165'>
<a name='2166'>
   IMPLICIT NONE<a name='2167'>
<font color=#447700>!----------------------------------------------------------------------<a name='2168'></font>
<a name='2169'>
   TYPE(grid_config_rec_type) ,     INTENT(IN   ) :: config_flags<a name='2170'>
<a name='2171'>
   INTEGER ,        INTENT(IN   ) ::   ids, ide, jds, jde, kds, kde, &amp;<a name='2172'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='2173'>
                                       its, ite, jts, jte, kts, kte<a name='2174'>
   INTEGER ,          INTENT(IN   ) :: n_moist<a name='2175'>
<a name='2176'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme , n_moist ), INTENT(IN) :: moist<a name='2177'>
<a name='2178'>
<a name='2179'>
   REAL , DIMENSION( ims:ime, jms:jme ), INTENT(IN   )   ::     TSK, mu<a name='2180'>
<a name='2181'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                 &amp;<a name='2182'>
          INTENT(  OUT)                                  ::   u_phy, &amp;<a name='2183'>
                                                              v_phy, &amp;<a name='2184'>
                                                             pi_phy, &amp;<a name='2185'>
                                                              p_phy, &amp;<a name='2186'>
                                                                p8w, &amp;<a name='2187'>
                                                              t_phy, &amp;<a name='2188'>
                                                             th_phy, &amp;<a name='2189'>
                                                                t8w, &amp;<a name='2190'>
                                                              mu_3d, &amp;<a name='2191'>
                                                                rho, &amp;<a name='2192'>
                                                                  z, &amp;<a name='2193'>
                                                               dz8w, &amp;<a name='2194'>
                                                              z_at_w<a name='2195'>
<a name='2196'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                 &amp;<a name='2197'>
          INTENT(IN   )                                  ::      pb, &amp;<a name='2198'>
                                                                  u, &amp;<a name='2199'>
                                                                  v, &amp;<a name='2200'>
                                                                alt, &amp;<a name='2201'>
                                                                phb<a name='2202'>
<a name='2203'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )      ::       p,ph,t<a name='2204'>
<a name='2205'>
   REAL , DIMENSION( kms:kme ) ,           INTENT(IN   ) ::     fzm,   &amp;<a name='2206'>
                                                                fzp<a name='2207'>
<a name='2208'>
   REAL,  DIMENSION( ims:ime , kms:kme, jms:jme ),                   &amp;<a name='2209'>
          INTENT(INOUT)   ::                               RTHRATEN<a name='2210'>
<a name='2211'>
   REAL,  DIMENSION( ims:ime , kms:kme, jms:jme ),                   &amp;<a name='2212'>
          INTENT(INOUT)   ::                               RTHCUTEN, &amp;<a name='2213'>
                                                           RQVCUTEN, &amp;<a name='2214'>
                                                           RQCCUTEN, &amp;<a name='2215'>
                                                           RQRCUTEN, &amp;<a name='2216'>
                                                           RQICUTEN, &amp;<a name='2217'>
                                                           RQSCUTEN<a name='2218'>
<a name='2219'>
   REAL,  DIMENSION( ims:ime, kms:kme, jms:jme )                   , &amp;<a name='2220'>
          INTENT(INOUT)   ::                                RUBLTEN, &amp;<a name='2221'>
                                                            RVBLTEN, &amp;<a name='2222'>
                                                           RTHBLTEN, &amp;<a name='2223'>
                                                           RQVBLTEN, &amp;<a name='2224'>
                                                           RQCBLTEN, &amp;<a name='2225'>
                                                           RQIBLTEN<a name='2226'>
<a name='2227'>
   REAL,  DIMENSION( ims:ime, kms:kme, jms:jme )                   , &amp;<a name='2228'>
          INTENT(INOUT)   ::                                RTHFTEN, &amp;<a name='2229'>
                                                            RQVFTEN<a name='2230'>
<a name='2231'>
   INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='2232'>
   INTEGER :: i, j, k<a name='2233'>
   REAL    :: w1, w2, z0, z1, z2<a name='2234'>
<a name='2235'>
<font color=#447700>!  IN variables<a name='2236'></font>
<a name='2237'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )       ::       S_p,  &amp;<a name='2238'>
                                                                  S_ph, &amp;<a name='2239'>
                                                                  S_t<a name='2240'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )       ::       P_p,  &amp;<a name='2241'>
                                                                  P_ph, &amp;<a name='2242'>
                                                                  P_t<a name='2243'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )       ::       B_p,  &amp;<a name='2244'>
                                                                  B_ph, &amp;<a name='2245'>
                                                                  B_t<a name='2246'>
<font color=#447700>!  OUT variables<a name='2247'></font>
<a name='2248'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )       ::     P_pi_phy, &amp;<a name='2249'>
                                                                P_p_phy,  &amp;<a name='2250'>
                                                                P_p8w,    &amp;<a name='2251'>
                                                                P_t_phy,  &amp;<a name='2252'>
                                                                P_th_phy, &amp;<a name='2253'>
                                                                P_t8w,    &amp;<a name='2254'>
                                                                P_z,      &amp;<a name='2255'>
                                                                P_z_at_w<a name='2256'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme )       ::     B_pi_phy, &amp;<a name='2257'>
                                                                B_p_phy,  &amp;<a name='2258'>
                                                                B_p8w,    &amp;<a name='2259'>
                                                                B_t_phy,  &amp;<a name='2260'>
                                                                B_th_phy, &amp;<a name='2261'>
                                                                B_t8w,    &amp;<a name='2262'>
                                                                B_z,      &amp;<a name='2263'>
                                                                B_z_at_w<a name='2264'>
<a name='2265'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='2266'>
   INTEGER :: NT<a name='2267'>
<a name='2268'>
<font color=#447700>!TGL test<a name='2269'></font>
<a name='2270'>
   do i=ims,ime<a name='2271'>
   do k=kms,kme<a name='2272'>
   do j=jms,jme<a name='2273'>
      S_p(i,k,j)=p(i,k,j)<a name='2274'>
      S_ph(i,k,j)=ph(i,k,j)<a name='2275'>
      S_t(i,k,j)=t(i,k,j)<a name='2276'>
<a name='2277'>
      P_p(i,k,j)=p(i,k,j)<a name='2278'>
      P_ph(i,k,j)=ph(i,k,j)<a name='2279'>
      P_t(i,k,j)=t(i,k,j)<a name='2280'>
   enddo<a name='2281'>
   enddo<a name='2282'>
   enddo<a name='2283'>
<a name='2284'>
<font color=#447700>!  NLM<a name='2285'></font>
<a name='2286'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PHY_PREP'>phy_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_PHY_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHY_PREP_1"> ( config_flags,                                &amp;  <font color=#447700>! input<a name='2287'></font>
                         mu, u, v, p, pb, alt, ph,                    &amp;  <font color=#447700>! input<a name='2288'></font>
                         phb, t, tsk, moist, n_moist,                 &amp;  <font color=#447700>! input<a name='2289'></font>
                         mu_3d, rho, th_phy, p_phy , pi_phy ,         &amp;  <font color=#447700>! output<a name='2290'></font>
                         u_phy, v_phy, p8w, t_phy, t8w,               &amp;  <font color=#447700>! output<a name='2291'></font>
                         z, z_at_w, dz8w,                             &amp;  <font color=#447700>! output<a name='2292'></font>
                         fzm, fzp,                                    &amp;  <font color=#447700>! params<a name='2293'></font>
                         RTHRATEN,                                    &amp;<a name='2294'>
                         RTHBLTEN, RUBLTEN, RVBLTEN,                  &amp;<a name='2295'>
                         RQVBLTEN, RQCBLTEN, RQIBLTEN,                &amp;<a name='2296'>
                         RTHCUTEN, RQVCUTEN, RQCCUTEN,                &amp;<a name='2297'>
                         RQRCUTEN, RQICUTEN, RQSCUTEN,                &amp;<a name='2298'>
                         RTHFTEN,  RQVFTEN,                           &amp;<a name='2299'>
                         ids, ide, jds, jde, kds, kde,                &amp;<a name='2300'>
                         ims, ime, jms, jme, kms, kme,                &amp;<a name='2301'>
                         its, ite, jts, jte, kts, kte                )<a name='2302'>
<a name='2303'>
<a name='2304'>
   do i=its,ite<a name='2305'>
   do k=kts,kte<a name='2306'>
   do j=jts,jte<a name='2307'>
      B_pi_phy(i,k,j)=pi_phy(i,k,j)<a name='2308'>
      B_p_phy(i,k,j)=p_phy(i,k,j)<a name='2309'>
      B_p8w(i,k,j)=p8w(i,k,j)<a name='2310'>
      B_t_phy(i,k,j)=t_phy(i,k,j)<a name='2311'>
      B_th_phy(i,k,j)=th_phy(i,k,j)<a name='2312'>
      B_t8w(i,k,j)=t8w(i,k,j)<a name='2313'>
      B_z(i,k,j)=z(i,k,j)<a name='2314'>
      B_z_at_w(i,k,j)=z_at_w(i,k,j)<a name='2315'>
   enddo<a name='2316'>
   enddo<a name='2317'>
   enddo<a name='2318'>
<a name='2319'>
<font color=#447700>!  TGL<a name='2320'></font>
<a name='2321'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_PHY_PREP'>g_phy_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_PHY_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_PHY_PREP_1">( p, P_p, pb, ph, P_ph, phb, t, P_t, mu_3d, rho, th_phy, P_th_phy, p_phy, P_p_phy, pi_phy, P_pi_phy, u_phy, &amp;<a name='2322'>
&amp;v_phy, p8w, P_p8w, t_phy, P_t_phy, t8w, P_t8w, z, P_z, z_at_w, P_z_at_w, dz8w, fzm, fzp, rthraten, rthblten, rublten, rvblten, &amp;<a name='2323'>
&amp;rqvblten, rqcblten, rqiblten, rthcuten, rqvcuten, rqccuten, rqrcuten, rqicuten, rqscuten, rthften, rqvften, ide, jde, kde, ims, &amp;<a name='2324'>
&amp;ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='2325'>
<a name='2326'>
   SAVE_L=0.<a name='2327'>
   do i=its,ite<a name='2328'>
   do k=kts,kte<a name='2329'>
   do j=jts,jte<a name='2330'>
      SAVE_L=SAVE_L + P_pi_phy(i,k,j)*P_pi_phy(i,k,j)    &amp;<a name='2331'>
                    + P_p_phy(i,k,j)*P_p_phy(i,k,j)      &amp;<a name='2332'>
                    + P_p8w(i,k,j)*P_p8w(i,k,j)          &amp;<a name='2333'>
                    + P_t_phy(i,k,j)*P_t_phy(i,k,j)      &amp;<a name='2334'>
                    + P_th_phy(i,k,j)*P_th_phy(i,k,j)    &amp;<a name='2335'>
                    + P_t8w(i,k,j)*P_t8w(i,k,j)          &amp;<a name='2336'>
                    + P_z(i,k,j)*P_z(i,k,j)              &amp;<a name='2337'>
                    + P_z_at_w(i,k,j)*P_z_at_w(i,k,j)<a name='2338'>
<a name='2339'>
   enddo<a name='2340'>
   enddo<a name='2341'>
   enddo<a name='2342'>
<a name='2343'>
#ifdef DM_PARALLEL<a name='2344'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp; <a name='2345'>
                       comm, IERROR )<a name='2346'>
   SAVE_L = nsum              <a name='2347'>
#endif                 <a name='2348'>
<a name='2349'>
   ALPHA=1.<a name='2350'>
   DO NT=1,11<a name='2351'>
      ALPHA=0.1*ALPHA<a name='2352'>
      FACTOR=1.+ALPHA<a name='2353'>
      do i=ims,ime<a name='2354'>
      do k=kms,kme<a name='2355'>
      do j=jms,jme<a name='2356'>
         P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='2357'>
         P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='2358'>
         P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='2359'>
      enddo<a name='2360'>
      enddo<a name='2361'>
      enddo<a name='2362'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PHY_PREP'>phy_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_PHY_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHY_PREP_2"> ( config_flags,                                &amp;  <font color=#447700>! input<a name='2363'></font>
                         mu, u, v, P_p, pb, alt, P_ph,                    &amp;  <font color=#447700>! input<a name='2364'></font>
                         phb, P_t, tsk, moist, n_moist,                 &amp;  <font color=#447700>! input<a name='2365'></font>
                         mu_3d, rho, P_th_phy, P_p_phy , P_pi_phy ,         &amp;  <font color=#447700>! output<a name='2366'></font>
                         u_phy, v_phy, P_p8w, P_t_phy, P_t8w,               &amp;  <font color=#447700>! output<a name='2367'></font>
                         P_z, P_z_at_w, dz8w,                             &amp;  <font color=#447700>! output<a name='2368'></font>
                         fzm, fzp,                                    &amp;  <font color=#447700>! params<a name='2369'></font>
                         RTHRATEN,                                    &amp;<a name='2370'>
                         RTHBLTEN, RUBLTEN, RVBLTEN,                  &amp;<a name='2371'>
                         RQVBLTEN, RQCBLTEN, RQIBLTEN,                &amp;<a name='2372'>
                         RTHCUTEN, RQVCUTEN, RQCCUTEN,                &amp;<a name='2373'>
                         RQRCUTEN, RQICUTEN, RQSCUTEN,                &amp;<a name='2374'>
                         RTHFTEN,  RQVFTEN,                           &amp;<a name='2375'>
                         ids, ide, jds, jde, kds, kde,                &amp;<a name='2376'>
                         ims, ime, jms, jme, kms, kme,                &amp;<a name='2377'>
                         its, ite, jts, jte, kts, kte                )<a name='2378'>
<a name='2379'>
      VAL_N=0.<a name='2380'>
      do i=its,ite<a name='2381'>
      do k=kts,kte<a name='2382'>
      do j=jts,jte<a name='2383'>
         VAL_N=VAL_N + (P_pi_phy(i,k,j)-B_pi_phy(i,k,j))*(P_pi_phy(i,k,j)-B_pi_phy(i,k,j))    &amp;<a name='2384'>
                     + (P_p_phy(i,k,j)-B_p_phy(i,k,j))*(P_p_phy(i,k,j)-B_p_phy(i,k,j))        &amp;<a name='2385'>
                     + (P_p8w(i,k,j)-B_p8w(i,k,j))*(P_p8w(i,k,j)-B_p8w(i,k,j))                &amp;<a name='2386'>
                     + (P_t_phy(i,k,j)-B_t_phy(i,k,j))*(P_t_phy(i,k,j)-B_t_phy(i,k,j))        &amp;<a name='2387'>
                     + (P_th_phy(i,k,j)-B_th_phy(i,k,j))*(P_th_phy(i,k,j)-B_th_phy(i,k,j))    &amp;<a name='2388'>
                     + (P_t8w(i,k,j)-B_t8w(i,k,j))*(P_t8w(i,k,j)-B_t8w(i,k,j))                &amp;<a name='2389'>
                     + (P_z(i,k,j)-B_z(i,k,j))*(P_z(i,k,j)-B_z(i,k,j))                        &amp;<a name='2390'>
                     + (P_z_at_w(i,k,j)-B_z_at_w(i,k,j))*(P_z_at_w(i,k,j)-B_z_at_w(i,k,j))<a name='2391'>
<a name='2392'>
                     <a name='2393'>
      enddo<a name='2394'>
      enddo<a name='2395'>
      enddo<a name='2396'>
<a name='2397'>
#ifdef DM_PARALLEL<a name='2398'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp; <a name='2399'>
                       comm, IERROR )<a name='2400'>
   VAL_N = nsum              <a name='2401'>
#endif                 <a name='2402'>
<a name='2403'>
      VAL_L=SAVE_L*ALPHA**2<a name='2404'>
      COEF=VAL_N/VAL_L<a name='2405'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='2406'>
         'g_phy_prep: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='2407'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='2408'>
   ENDDO<a name='2409'>
<a name='2410'>
<font color=#447700>!  ADJ test<a name='2411'></font>
<a name='2412'>
   FACTOR=0.1<a name='2413'>
   do i=ims,ime<a name='2414'>
   do k=kms,kme<a name='2415'>
   do j=jms,jme<a name='2416'>
      p(i,k,j)=S_p(i,k,j)<a name='2417'>
      ph(i,k,j)=S_ph(i,k,j)<a name='2418'>
      t(i,k,j)=S_t(i,k,j)<a name='2419'>
<a name='2420'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='2421'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='2422'>
      P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='2423'>
<a name='2424'>
      B_p(i,k,j)=P_p(i,k,j)<a name='2425'>
      B_ph(i,k,j)=P_ph(i,k,j)<a name='2426'>
      B_t(i,k,j)=P_t(i,k,j)<a name='2427'>
   enddo<a name='2428'>
   enddo<a name='2429'>
   enddo<a name='2430'>
<a name='2431'>
<font color=#447700>!  TGL<a name='2432'></font>
<a name='2433'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_PHY_PREP'>g_phy_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_PHY_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_PHY_PREP_2">( p, P_p, pb, ph, P_ph, phb, t, P_t, mu_3d, rho, th_phy, P_th_phy, p_phy, P_p_phy, pi_phy, P_pi_phy, u_phy, &amp;<a name='2434'>
&amp;v_phy, p8w, P_p8w, t_phy, P_t_phy, t8w, P_t8w, z, P_z, z_at_w, P_z_at_w, dz8w, fzm, fzp, rthraten, rthblten, rublten, rvblten, &amp;<a name='2435'>
&amp;rqvblten, rqcblten, rqiblten, rthcuten, rqvcuten, rqccuten, rqrcuten, rqicuten, rqscuten, rthften, rqvften, ide, jde, kde, ims, &amp;<a name='2436'>
&amp;ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='2437'>
<a name='2438'>
   VAL_L=0.<a name='2439'>
   do i=its,ite<a name='2440'>
   do k=kts,kte<a name='2441'>
   do j=jts,jte<a name='2442'>
      VAL_L=VAL_L + P_pi_phy(i,k,j)*P_pi_phy(i,k,j)    &amp;<a name='2443'>
                    + P_p_phy(i,k,j)*P_p_phy(i,k,j)      &amp;<a name='2444'>
                    + P_p8w(i,k,j)*P_p8w(i,k,j)          &amp;<a name='2445'>
                    + P_t_phy(i,k,j)*P_t_phy(i,k,j)      &amp;<a name='2446'>
                    + P_th_phy(i,k,j)*P_th_phy(i,k,j)    &amp;<a name='2447'>
                    + P_t8w(i,k,j)*P_t8w(i,k,j)          &amp;<a name='2448'>
                    + P_z(i,k,j)*P_z(i,k,j)              &amp;<a name='2449'>
                    + P_z_at_w(i,k,j)*P_z_at_w(i,k,j)<a name='2450'>
<a name='2451'>
   enddo<a name='2452'>
   enddo<a name='2453'>
   enddo<a name='2454'>
<a name='2455'>
#ifdef DM_PARALLEL<a name='2456'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='2457'>
                       comm, IERROR )<a name='2458'>
   VAL_L = nsum <a name='2459'>
#endif<a name='2460'>
<a name='2461'>
   do i=ims,ime<a name='2462'>
   do k=kms,kme<a name='2463'>
   do j=jms,jme<a name='2464'>
      P_p(i,k,j)=0.0<a name='2465'>
      P_ph(i,k,j)=0.0<a name='2466'>
      P_t(i,k,j)=0.0<a name='2467'>
   enddo<a name='2468'>
   enddo<a name='2469'>
   enddo<a name='2470'>
<a name='2471'>
<font color=#447700>!  ADJ<a name='2472'></font>
   call <A href='../../html_code/dyn_em/module_big_step_utilities_em_ad.F.html#A_PHY_PREP'>a_phy_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_PHY_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_PHY_PREP_1">( p, P_p, pb, ph, P_ph, phb, t, P_t, th_phy, P_th_phy, p_phy, P_p_phy, pi_phy, P_pi_phy, P_p8w, t_phy, &amp;<a name='2473'>
&amp;P_t_phy, P_t8w, z, P_z, z_at_w, P_z_at_w, fzm, fzp, ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='2474'>
<a name='2475'>
   VAL_A=0.<a name='2476'>
   DO I=its,ite<a name='2477'>
   DO K=kts,kte<a name='2478'>
   DO J=jts,jte<a name='2479'>
      VAL_A=VAL_A    + P_p(i,k,j)*B_p(i,k,j)      &amp;<a name='2480'>
                     + P_ph(i,k,j)*B_ph(i,k,j)  &amp;<a name='2481'>
                     + P_t(i,k,j)*B_t(i,k,j)<a name='2482'>
<a name='2483'>
   enddo<a name='2484'>
   enddo<a name='2485'>
   enddo<a name='2486'>
<a name='2487'>
#ifdef DM_PARALLEL<a name='2488'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='2489'>
                       comm, IERROR )<a name='2490'>
   VAL_A = nsum <a name='2491'>
#endif<a name='2492'>
<a name='2493'>
   print*, '                '<a name='2494'>
   write(6,*) 'a_phy_prep: '<a name='2495'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='2496'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='2497'>
<a name='2498'>
<font color=#447700>!  RECOVER<a name='2499'></font>
<a name='2500'>
   do i=ims,ime<a name='2501'>
   do k=kms,kme<a name='2502'>
   do j=jms,jme<a name='2503'>
      p(i,k,j)=S_p(i,k,j)<a name='2504'>
      ph(i,k,j)=S_ph(i,k,j)<a name='2505'>
      t(i,k,j)=S_t(i,k,j)<a name='2506'>
   enddo<a name='2507'>
   enddo<a name='2508'>
   enddo<a name='2509'>
<a name='2510'>
END SUBROUTINE t_phy_prep<a name='2511'>
<a name='2512'>
<font color=#447700>!------------------------------------------------------------------------------------------------------<a name='2513'></font>
<a name='2514'>
<A NAME='T_CALCULATE_KM_KH'><A href='../../html_code/dyn_em/module_check.F.html#T_CALCULATE_KM_KH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2515'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_calculate_km_kh</font>( config_flags, dt,                        &amp; <A href='../../call_to/T_CALCULATE_KM_KH.html' TARGET='index'>1</A>,<A href='../../call_from/T_CALCULATE_KM_KH.html' TARGET='index'>5</A><a name='2516'>
                                dampcoef, zdamp, damp_opt,               &amp;<a name='2517'>
                                xkmh, xkmhd, xkmv, xkhh, xkhv,           &amp;<a name='2518'>
                                BN2, khdif, kvdif, div,                  &amp;<a name='2519'>
                                defor11, defor22, defor33,               &amp;<a name='2520'>
                                defor12, defor13, defor23,               &amp;<a name='2521'>
                                tke, p8w, t8w, theta, t, p, moist,       &amp;<a name='2522'>
                                dn, dnw, dx, dy, rdz, rdzw, cr_len,      &amp;<a name='2523'>
                                n_moist, cf1, cf2, cf3, warm_rain,       &amp;<a name='2524'>
                                kh_tke_upper_bound, kv_tke_upper_bound,  &amp;<a name='2525'>
                                ids, ide, jds, jde, kds, kde,            &amp;<a name='2526'>
                                ims, ime, jms, jme, kms, kme,            &amp;<a name='2527'>
                                its, ite, jts, jte, kts, kte             )<a name='2528'>
<a name='2529'>
    IMPLICIT NONE<a name='2530'>
<a name='2531'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='2532'>
    :: config_flags<a name='2533'>
<a name='2534'>
    INTEGER, INTENT( IN )  &amp;<a name='2535'>
    :: n_moist, damp_opt,             &amp;<a name='2536'>
       ids, ide, jds, jde, kds, kde,  &amp;<a name='2537'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='2538'>
       its, ite, jts, jte, kts, kte<a name='2539'>
<a name='2540'>
    LOGICAL, INTENT( IN )  &amp;<a name='2541'>
    :: warm_rain<a name='2542'>
<a name='2543'>
    REAL, INTENT( IN )  &amp;<a name='2544'>
    :: cr_len, dx, dy, zdamp, dt, dampcoef, cf1, cf2, cf3, khdif, kvdif<a name='2545'>
<a name='2546'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='2547'>
    :: dnw, dn<a name='2548'>
<a name='2549'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme, n_moist )    :: moist<a name='2550'>
<a name='2551'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='2552'>
    :: xkmv, xkmh, xkhv, xkhh<a name='2553'>
<a name='2554'>
    REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),  INTENT( IN )  &amp;<a name='2555'>
    :: defor11, defor22, defor33, defor12, defor13, defor23,      &amp;<a name='2556'>
       div, rdz, rdzw<a name='2557'>
<a name='2558'>
    REAL, DIMENSION( ims:ime , kms:kme, jms:jme )     ::  p8w, t8w, theta, t, p,xkmhd,BN2<a name='2559'>
<a name='2560'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='2561'>
    :: tke<a name='2562'>
<a name='2563'>
    REAL, INTENT( IN )  &amp;<a name='2564'>
    :: kh_tke_upper_bound, kv_tke_upper_bound<a name='2565'>
<a name='2566'>
<font color=#447700>! Local variables.<a name='2567'></font>
<a name='2568'>
    INTEGER  &amp;<a name='2569'>
    :: i_start, i_end, j_start, j_end, ktf, i, j, k<a name='2570'>
<a name='2571'>
<font color=#447700>!  IN variables<a name='2572'></font>
<a name='2573'>
    REAL, DIMENSION( ims:ime , kms:kme, jms:jme )     ::  S_p8w, S_t8w, S_theta, S_t, S_p<a name='2574'>
    REAL, DIMENSION( ims:ime , kms:kme, jms:jme )     ::  P_p8w, P_t8w, P_theta, P_t, P_p<a name='2575'>
    REAL, DIMENSION( ims:ime , kms:kme, jms:jme )     ::  B_p8w, B_t8w, B_theta, B_t, B_p<a name='2576'>
<a name='2577'>
<font color=#447700>!  INOUT variables<a name='2578'></font>
<a name='2579'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme, n_moist )   :: S_moist,P_moist,B_moist,K_moist<a name='2580'>
<a name='2581'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme )      :: S_xkmhd,S_BN2,P_xkmhd,P_BN2,B_xkmhd,B_BN2,K_xkmhd,K_BN2<a name='2582'>
<a name='2583'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='2584'>
   INTEGER :: NT,h<a name='2585'>
<a name='2586'>
<font color=#447700>!  TGL test<a name='2587'></font>
<a name='2588'>
   do i=ims,ime<a name='2589'>
   do k=kms,kme<a name='2590'>
   do j=jms,jme<a name='2591'>
      S_p8w(i,k,j)=p8w(i,k,j)<a name='2592'>
      S_t8w(i,k,j)=t8w(i,k,j)<a name='2593'>
      S_theta(i,k,j)=theta(i,k,j)<a name='2594'>
      S_t(i,k,j)=t(i,k,j)<a name='2595'>
      S_p(i,k,j)=p(i,k,j)<a name='2596'>
<a name='2597'>
      P_p8w(i,k,j)=p8w(i,k,j)<a name='2598'>
      P_t8w(i,k,j)=t8w(i,k,j)<a name='2599'>
      P_theta(i,k,j)=theta(i,k,j)<a name='2600'>
      P_t(i,k,j)=t(i,k,j)<a name='2601'>
      P_p(i,k,j)=p(i,k,j)<a name='2602'>
   enddo<a name='2603'>
   enddo<a name='2604'>
   enddo<a name='2605'>
<a name='2606'>
   do i=ims,ime<a name='2607'>
   do k=kms,kme<a name='2608'>
   do j=jms,jme<a name='2609'>
   do h=1  ,n_moist<a name='2610'>
      S_moist(i,k,j,h)=moist(i,k,j,h)<a name='2611'>
<a name='2612'>
      P_moist(i,k,j,h)=moist(i,k,j,h)<a name='2613'>
<a name='2614'>
      K_moist(i,k,j,h)=moist(i,k,j,h)<a name='2615'>
   enddo<a name='2616'>
   enddo<a name='2617'>
   enddo<a name='2618'>
   enddo<a name='2619'>
<a name='2620'>
   do i=ims,ime<a name='2621'>
   do k=kms,kme<a name='2622'>
   do j=jms,jme<a name='2623'>
      S_xkmhd(i,k,j)=xkmhd(i,k,j)<a name='2624'>
      S_bn2(i,k,j)=bn2(i,k,j)<a name='2625'>
<a name='2626'>
      P_xkmhd(i,k,j)=xkmhd(i,k,j)<a name='2627'>
      P_bn2(i,k,j)=bn2(i,k,j)<a name='2628'>
<a name='2629'>
      K_xkmhd(i,k,j)=xkmhd(i,k,j)<a name='2630'>
      K_bn2(i,k,j)=bn2(i,k,j)<a name='2631'>
   enddo<a name='2632'>
   enddo<a name='2633'>
   enddo<a name='2634'>
<a name='2635'>
<font color=#447700>!  NLM<a name='2636'></font>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH'>calculate_km_kh</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_KM_KH_1">( config_flags, dt,                        &amp;<a name='2637'>
                                dampcoef, zdamp, damp_opt,               &amp;<a name='2638'>
                                xkmh, xkmhd, xkmv, xkhh, xkhv,           &amp;<a name='2639'>
                                BN2, khdif, kvdif, div,                  &amp;<a name='2640'>
                                defor11, defor22, defor33,               &amp;<a name='2641'>
                                defor12, defor13, defor23,               &amp;<a name='2642'>
                                tke, p8w, t8w, theta, t, p, moist,       &amp;<a name='2643'>
                                dn, dnw, dx, dy, rdz, rdzw, cr_len,      &amp;<a name='2644'>
                                n_moist, cf1, cf2, cf3, warm_rain,       &amp;<a name='2645'>
                                kh_tke_upper_bound, kv_tke_upper_bound,  &amp;<a name='2646'>
                                ids, ide, jds, jde, kds, kde,            &amp;<a name='2647'>
                                ims, ime, jms, jme, kms, kme,            &amp;<a name='2648'>
                                its, ite, jts, jte, kts, kte             )<a name='2649'>
   do i=its,ite<a name='2650'>
   do k=kts,kte<a name='2651'>
   do j=jts,jte<a name='2652'>
   do h=1  ,n_moist<a name='2653'>
      B_moist(i,k,j,h)=moist(i,k,j,h)<a name='2654'>
   enddo<a name='2655'>
   enddo<a name='2656'>
   enddo<a name='2657'>
   enddo<a name='2658'>
<a name='2659'>
   do i=its,ite<a name='2660'>
   do k=kts,kte<a name='2661'>
   do j=jts,jte<a name='2662'>
      B_xkmhd(i,k,j)=xkmhd(i,k,j)<a name='2663'>
      B_bn2(i,k,j)=bn2(i,k,j)<a name='2664'>
   enddo<a name='2665'>
   enddo<a name='2666'>
   enddo<a name='2667'>
<a name='2668'>
<font color=#447700>!  TGL<a name='2669'></font>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALCULATE_KM_KH'>g_calculate_km_kh</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALCULATE_KM_KH_1">( config_flags, dt, dampcoef, zdamp, damp_opt, xkmh, K_xkmhd, P_xkmhd, xkmv, xkhh, xkhv, K_bn2, P_bn2, &amp;<a name='2670'>
&amp;khdif, defor11, defor22, defor33, defor12, defor13, defor23, tke, p8w, P_p8w, t8w, P_t8w, theta, P_theta, t, P_t, p, P_p, K_moist, &amp;<a name='2671'>
&amp;P_moist, dx, dy, rdz, rdzw, n_moist, cf1, cf2, cf3, kh_tke_upper_bound, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, &amp;<a name='2672'>
&amp;its, ite, jts, jte, kts, kte )<a name='2673'>
<a name='2674'>
   SAVE_L=0.<a name='2675'>
   do i=its,ite<a name='2676'>
   do k=kts,kte<a name='2677'>
   do j=jts,jte<a name='2678'>
   do h=1  ,n_moist<a name='2679'>
      SAVE_L=SAVE_L+P_moist(i,k,j,h)*P_moist(i,k,j,h)<a name='2680'>
   enddo<a name='2681'>
   enddo<a name='2682'>
   enddo<a name='2683'>
   enddo<a name='2684'>
<a name='2685'>
   do i=its,ite<a name='2686'>
   do k=kts,kte<a name='2687'>
   do j=jts,jte<a name='2688'>
      SAVE_L=SAVE_L+P_xkmhd(i,k,j)*P_xkmhd(i,k,j)  +P_bn2(i,k,j)*P_bn2(i,k,j)<a name='2689'>
   enddo<a name='2690'>
   enddo<a name='2691'>
   enddo<a name='2692'>
<a name='2693'>
#ifdef DM_PARALLEL<a name='2694'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='2695'>
                       comm, IERROR )<a name='2696'>
   SAVE_L = nsum <a name='2697'>
#endif<a name='2698'>
<a name='2699'>
   ALPHA=1.<a name='2700'>
   DO NT=1,11<a name='2701'>
      ALPHA=0.1*ALPHA<a name='2702'>
      FACTOR=1.+ALPHA<a name='2703'>
      do i=ims,ime<a name='2704'>
      do k=kms,kme<a name='2705'>
      do j=jms,jme<a name='2706'>
      P_p8w(i,k,j)=FACTOR*S_p8w(i,k,j)<a name='2707'>
      P_t8w(i,k,j)=FACTOR*S_t8w(i,k,j)<a name='2708'>
      P_theta(i,k,j)=FACTOR*S_theta(i,k,j)<a name='2709'>
      P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='2710'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='2711'>
   enddo<a name='2712'>
   enddo<a name='2713'>
   enddo<a name='2714'>
   do i=ims,ime<a name='2715'>
   do k=kms,kme<a name='2716'>
   do j=jms,jme<a name='2717'>
   do h=1  ,n_moist<a name='2718'>
      P_moist(i,k,j,h)=FACTOR*S_moist(i,k,j,h)<a name='2719'>
   enddo<a name='2720'>
   enddo<a name='2721'>
   enddo<a name='2722'>
   enddo<a name='2723'>
   do i=ims,ime<a name='2724'>
   do k=kms,kme<a name='2725'>
   do j=jms,jme<a name='2726'>
      P_xkmhd(i,k,j)=FACTOR*S_xkmhd(i,k,j)<a name='2727'>
      P_bn2(i,k,j)=FACTOR*S_bn2(i,k,j)<a name='2728'>
   enddo<a name='2729'>
   enddo<a name='2730'>
   enddo<a name='2731'>
<a name='2732'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH'>calculate_km_kh</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_KM_KH_2">( config_flags, dt,                        &amp;<a name='2733'>
                                dampcoef, zdamp, damp_opt,               &amp;<a name='2734'>
                                xkmh, P_xkmhd, xkmv, xkhh, xkhv,           &amp;<a name='2735'>
                                P_BN2, khdif, kvdif, div,                  &amp;<a name='2736'>
                                defor11, defor22, defor33,               &amp;<a name='2737'>
                                defor12, defor13, defor23,               &amp;<a name='2738'>
                                tke, P_p8w, P_t8w, P_theta, P_t, P_p, P_moist,       &amp;<a name='2739'>
                                dn, dnw, dx, dy, rdz, rdzw, cr_len,      &amp;<a name='2740'>
                                n_moist, cf1, cf2, cf3, warm_rain,       &amp;<a name='2741'>
                                kh_tke_upper_bound, kv_tke_upper_bound,  &amp;<a name='2742'>
                                ids, ide, jds, jde, kds, kde,            &amp;<a name='2743'>
                                ims, ime, jms, jme, kms, kme,            &amp;<a name='2744'>
                                its, ite, jts, jte, kts, kte             )<a name='2745'>
      VAL_N=0.<a name='2746'>
      do i=its,ite<a name='2747'>
      do k=kts,kte<a name='2748'>
      do j=jts,jte<a name='2749'>
      do h=1  ,n_moist<a name='2750'>
         VAL_N=VAL_N+(P_moist(i,k,j,h)-B_moist(i,k,j,h))*(P_moist(i,k,j,h)-B_moist(i,k,j,h))<a name='2751'>
      enddo<a name='2752'>
      enddo<a name='2753'>
      enddo<a name='2754'>
      enddo<a name='2755'>
<a name='2756'>
      do i=its,ite<a name='2757'>
      do k=kts,kte<a name='2758'>
      do j=jts,jte<a name='2759'>
         VAL_N=VAL_N + (P_xkmhd(i,k,j)-B_xkmhd(i,k,j))*(P_xkmhd(i,k,j)-B_xkmhd(i,k,j))   &amp; <a name='2760'>
                     + (P_bn2(i,k,j) -B_bn2(i,k,j))*(P_bn2(i,k,j) -B_bn2(i,k,j))<a name='2761'>
      enddo<a name='2762'>
      enddo<a name='2763'>
      enddo<a name='2764'>
<a name='2765'>
#ifdef DM_PARALLEL<a name='2766'>
      call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='2767'>
                          comm, IERROR )<a name='2768'>
      VAL_N = nsum <a name='2769'>
#endif<a name='2770'>
<a name='2771'>
      VAL_L=SAVE_L*ALPHA**2<a name='2772'>
      COEF=VAL_N/VAL_L<a name='2773'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='2774'>
         'g_calculate_km_kh: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='2775'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='2776'>
   ENDDO<a name='2777'>
<a name='2778'>
<font color=#447700>!  ADJ test<a name='2779'></font>
<a name='2780'>
   FACTOR=0.1<a name='2781'>
   do i=ims,ime<a name='2782'>
   do k=kms,kme<a name='2783'>
   do j=jms,jme<a name='2784'>
      p8w(i,k,j)=S_p8w(i,k,j)<a name='2785'>
      t8w(i,k,j)=S_t8w(i,k,j)<a name='2786'>
      theta(i,k,j)=S_theta(i,k,j)<a name='2787'>
      t(i,k,j)=S_t(i,k,j)<a name='2788'>
      p(i,k,j)=S_p(i,k,j)<a name='2789'>
<a name='2790'>
      P_p8w(i,k,j)=FACTOR*S_p8w(i,k,j)<a name='2791'>
      P_t8w(i,k,j)=FACTOR*S_t8w(i,k,j)<a name='2792'>
      P_theta(i,k,j)=FACTOR*S_theta(i,k,j)<a name='2793'>
      P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='2794'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='2795'>
<a name='2796'>
      B_p8w(i,k,j)=P_p8w(i,k,j)<a name='2797'>
      B_t8w(i,k,j)=P_t8w(i,k,j)<a name='2798'>
      B_theta(i,k,j)=P_theta(i,k,j)<a name='2799'>
      B_t(i,k,j)=P_t(i,k,j)<a name='2800'>
      B_p(i,k,j)=P_p(i,k,j)<a name='2801'>
   enddo<a name='2802'>
   enddo<a name='2803'>
   enddo<a name='2804'>
   do i=ims,ime<a name='2805'>
   do k=kms,kme<a name='2806'>
   do j=jms,jme<a name='2807'>
   do h=1  ,n_moist<a name='2808'>
      moist(i,k,j,h)=S_moist(i,k,j,h)<a name='2809'>
      K_moist(i,k,j,h)=S_moist(i,k,j,h)<a name='2810'>
<a name='2811'>
      P_moist(i,k,j,h)=FACTOR*S_moist(i,k,j,h)<a name='2812'>
<a name='2813'>
      B_moist(i,k,j,h)=P_moist(i,k,j,h)<a name='2814'>
   enddo<a name='2815'>
   enddo<a name='2816'>
   enddo<a name='2817'>
   enddo<a name='2818'>
<a name='2819'>
   do i=ims,ime<a name='2820'>
   do k=kms,kme<a name='2821'>
   do j=jms,jme<a name='2822'>
      xkmhd(i,k,j)=S_xkmhd(i,k,j)<a name='2823'>
      bn2(i,k,j)=S_bn2(i,k,j)<a name='2824'>
      K_xkmhd(i,k,j)=S_xkmhd(i,k,j)<a name='2825'>
      K_bn2(i,k,j)=S_bn2(i,k,j)<a name='2826'>
<a name='2827'>
      P_xkmhd(i,k,j)=FACTOR*S_xkmhd(i,k,j)<a name='2828'>
      P_bn2(i,k,j)=FACTOR*S_bn2(i,k,j)<a name='2829'>
<a name='2830'>
      B_xkmhd(i,k,j)=P_xkmhd(i,k,j)<a name='2831'>
      B_bn2(i,k,j)=P_bn2(i,k,j)<a name='2832'>
   enddo<a name='2833'>
   enddo<a name='2834'>
   enddo<a name='2835'>
<a name='2836'>
<font color=#447700>!  TGL<a name='2837'></font>
<a name='2838'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em_tl.F.html#G_CALCULATE_KM_KH'>g_calculate_km_kh</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALCULATE_KM_KH_2">( config_flags, dt, dampcoef, zdamp, damp_opt, xkmh, xkmhd, P_xkmhd, xkmv, xkhh, xkhv, bn2, P_bn2, &amp;<a name='2839'>
&amp;khdif, defor11, defor22, defor33, defor12, defor13, defor23, tke, p8w, P_p8w, t8w, P_t8w, theta, P_theta, t, P_t, p, P_p, moist, &amp;<a name='2840'>
&amp;P_moist, dx, dy, rdz, rdzw, n_moist, cf1, cf2, cf3, kh_tke_upper_bound, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, &amp;<a name='2841'>
&amp;its, ite, jts, jte, kts, kte )<a name='2842'>
<a name='2843'>
   VAL_L=0.<a name='2844'>
   do i=its,ite<a name='2845'>
   do k=kts,kte<a name='2846'>
   do j=jts,jte<a name='2847'>
<font color=#447700>!      VAL_L=VAL_L + P_p8w(i,k,j)*P_p8w(i,k,j)       &amp;<a name='2848'></font>
<font color=#447700>!                  + P_t8w(i,k,j)*P_t8w(i,k,j)       &amp;<a name='2849'></font>
<font color=#447700>!                  + P_theta(i,k,j)*P_theta(i,k,j)   &amp;<a name='2850'></font>
<font color=#447700>!                  + P_t(i,k,j)*P_t(i,k,j)           &amp;<a name='2851'></font>
<font color=#447700>!                  + P_p(i,k,j)*P_p(i,k,j)<a name='2852'></font>
   enddo<a name='2853'>
   enddo<a name='2854'>
   enddo<a name='2855'>
   do i=its,ite<a name='2856'>
   do k=kts,kte<a name='2857'>
   do j=jts,jte<a name='2858'>
   do h=1  ,n_moist<a name='2859'>
      VAL_L=VAL_L+P_moist(i,k,j,h)*P_moist(i,k,j,h)<a name='2860'>
   enddo<a name='2861'>
   enddo<a name='2862'>
   enddo<a name='2863'>
   enddo<a name='2864'>
<a name='2865'>
   do i=its,ite<a name='2866'>
   do k=kts,kte<a name='2867'>
   do j=jts,jte<a name='2868'>
      VAL_L=VAL_L+P_xkmhd(i,k,j)*P_xkmhd(i,k,j)  +P_bn2(i,k,j)*P_bn2(i,k,j)<a name='2869'>
   enddo<a name='2870'>
   enddo<a name='2871'>
   enddo<a name='2872'>
<a name='2873'>
#ifdef DM_PARALLEL<a name='2874'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='2875'>
                       comm, IERROR )<a name='2876'>
   VAL_L = nsum <a name='2877'>
#endif<a name='2878'>
<a name='2879'>
   do i=ims,ime<a name='2880'>
   do k=kms,kme<a name='2881'>
   do j=jms,jme<a name='2882'>
      P_p8w(i,k,j)=0.0<a name='2883'>
      P_t8w(i,k,j)=0.0<a name='2884'>
      P_theta(i,k,j)=0.0<a name='2885'>
      P_t(i,k,j)=0.0<a name='2886'>
      P_p(i,k,j)=0.0<a name='2887'>
   enddo<a name='2888'>
   enddo<a name='2889'>
   enddo<a name='2890'>
<a name='2891'>
<font color=#447700>!  ADJ<a name='2892'></font>
<a name='2893'>
   call <A href='../../html_code/dyn_em/module_diffusion_em_ad.F.html#A_CALCULATE_KM_KH'>a_calculate_km_kh</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_CALCULATE_KM_KH_1">( config_flags, dt, dampcoef, zdamp, damp_opt, xkmh, K_xkmhd, P_xkmhd, xkmv, xkhh, xkhv, K_bn2, P_bn2, &amp;<a name='2894'>
&amp;khdif, div, defor11, defor22, defor33, defor12, defor13, defor23, tke, p8w, P_p8w, t8w, P_t8w, theta, P_theta, t, P_t, p, P_p, &amp;<a name='2895'>
&amp;K_moist, P_moist, dn, dnw, dx, dy, rdz, rdzw, n_moist, cf1, cf2, cf3, kh_tke_upper_bound, ids, ide, jds, jde, kde, ims, ime, jms, &amp;<a name='2896'>
&amp;jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='2897'>
<a name='2898'>
   VAL_A=0.<a name='2899'>
   DO I=its,ite<a name='2900'>
   DO K=kts,kte<a name='2901'>
   DO J=jts,jte<a name='2902'>
      VAL_A=VAL_A + P_p8w(i,k,j)*B_p8w(i,k,j)      &amp; <a name='2903'>
                  + P_t8w(i,k,j)*B_t8w(i,k,j)      &amp;<a name='2904'>
                  + P_theta(i,k,j)*B_theta(i,k,j)  &amp;<a name='2905'>
                  + P_t(i,k,j) *B_t(i,k,j)         &amp;<a name='2906'>
                  + P_p(i,k,j) *B_p(i,k,j)<a name='2907'>
   END DO<a name='2908'>
   END DO<a name='2909'>
   END DO<a name='2910'>
<a name='2911'>
   do i=its,ite<a name='2912'>
   do k=kts,kte<a name='2913'>
   do j=jts,jte<a name='2914'>
   do h=1  ,n_moist<a name='2915'>
      VAL_A=VAL_A + P_moist(i,k,j,h)*B_moist(i,k,j,h)<a name='2916'>
   enddo<a name='2917'>
   enddo<a name='2918'>
   enddo<a name='2919'>
   enddo<a name='2920'>
<a name='2921'>
   do i=its,ite<a name='2922'>
   do k=kts,kte<a name='2923'>
   do j=jts,jte<a name='2924'>
      VAL_A=VAL_A + P_xkmhd(i,k,j)*B_xkmhd(i,k,j) +P_bn2(i,k,j)*B_bn2(i,k,j)<a name='2925'>
   enddo<a name='2926'>
   enddo<a name='2927'>
   enddo<a name='2928'>
<a name='2929'>
#ifdef DM_PARALLEL<a name='2930'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='2931'>
                       comm, IERROR )<a name='2932'>
   VAL_A = nsum <a name='2933'>
#endif<a name='2934'>
<a name='2935'>
   print*, '                '<a name='2936'>
   write(6,*) 'a_calculate_km_kh: '<a name='2937'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='2938'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='2939'>
<a name='2940'>
<font color=#447700>!  RECOVER<a name='2941'></font>
<a name='2942'>
<a name='2943'>
   do i=ims,ime<a name='2944'>
   do k=kms,kme<a name='2945'>
   do j=jms,jme<a name='2946'>
      p8w(i,k,j)=S_p8w(i,k,j)<a name='2947'>
      t8w(i,k,j)=S_t8w(i,k,j)<a name='2948'>
      theta(i,k,j)=S_theta(i,k,j)<a name='2949'>
      t(i,k,j)=S_t(i,k,j)<a name='2950'>
      p(i,k,j)=S_p(i,k,j)<a name='2951'>
<a name='2952'>
   enddo<a name='2953'>
   enddo<a name='2954'>
   enddo<a name='2955'>
   do i=ims,ime<a name='2956'>
   do k=kms,kme<a name='2957'>
   do j=jms,jme<a name='2958'>
   do h=1  ,n_moist<a name='2959'>
      moist(i,k,j,h)=S_moist(i,k,j,h)<a name='2960'>
   enddo<a name='2961'>
   enddo<a name='2962'>
   enddo<a name='2963'>
   enddo<a name='2964'>
<a name='2965'>
   do i=ims,ime<a name='2966'>
   do k=kms,kme<a name='2967'>
   do j=jms,jme<a name='2968'>
      xkmhd(i,k,j)=S_xkmhd(i,k,j)<a name='2969'>
      bn2(i,k,j)=S_bn2(i,k,j)<a name='2970'>
   enddo<a name='2971'>
   enddo<a name='2972'>
   enddo<a name='2973'>
<a name='2974'>
END SUBROUTINE t_calculate_km_kh<a name='2975'>
<a name='2976'>
<font color=#447700>!--------------------------------------------------------------------------------------------------------<a name='2977'></font>
<a name='2978'>
<A NAME='T_RELAX_BDY_DRY'><A href='../../html_code/dyn_em/module_check.F.html#T_RELAX_BDY_DRY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2979'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_relax_bdy_dry</font> ( config_flags,                                    &amp; <A href='../../call_to/T_RELAX_BDY_DRY.html' TARGET='index'>1</A>,<A href='../../call_from/T_RELAX_BDY_DRY.html' TARGET='index'>5</A><a name='2980'>
                              ru_tendf, rv_tendf, ph_tendf, t_tendf,           &amp;<a name='2981'>
                              rw_tendf, mu_tend,                               &amp;<a name='2982'>
                              ru, rv, ph, t,                                   &amp;<a name='2983'>
                              w, mu, mut,                                      &amp;<a name='2984'>
                              u_b, v_b, ph_b, t_b,                             &amp;<a name='2985'>
                              w_b, mu_b,                                       &amp;<a name='2986'>
                              u_bt, v_bt, ph_bt, t_bt,                         &amp;<a name='2987'>
                              w_bt, mu_bt,                                     &amp;<a name='2988'>
                              spec_bdy_width, spec_zone, relax_zone,           &amp;<a name='2989'>
                              dtbc, fcx, gcx,             &amp;<a name='2990'>
                              ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='2991'></font>
                              ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2992'></font>
                              ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2993'></font>
                              ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2994'></font>
                              its, ite, jts, jte, kts, kte)<a name='2995'>
<a name='2996'>
   IMPLICIT NONE<a name='2997'>
<a name='2998'>
   <font color=#447700>!  Input data.<a name='2999'></font>
   TYPE( grid_config_rec_type ) config_flags<a name='3000'>
<a name='3001'>
   INTEGER ,               INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3002'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='3003'>
                                            ips, ipe, jps, jpe, kps, kpe, &amp;<a name='3004'>
                                            its, ite, jts, jte, kts, kte<a name='3005'>
   INTEGER ,               INTENT(IN   ) :: ijds, ijde<a name='3006'>
   INTEGER ,               INTENT(IN   ) :: spec_bdy_width, spec_zone, relax_zone<a name='3007'>
<a name='3008'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )      :: ru,     &amp;<a name='3009'>
                                                                      rv,     &amp;<a name='3010'>
                                                                      ph,     &amp;<a name='3011'>
                                                                      w,      &amp;<a name='3012'>
                                                                      t<a name='3013'>
   REAL , DIMENSION( ims:ime , jms:jme  )               :: mu  , &amp;<a name='3014'>
                                                                      mut<a name='3015'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )  :: ru_tendf, &amp;<a name='3016'>
                                                                      rv_tendf, &amp;<a name='3017'>
                                                                      ph_tendf, &amp;<a name='3018'>
                                                                      rw_tendf, &amp;<a name='3019'>
                                                                      t_tendf<a name='3020'>
   REAL , DIMENSION( ims:ime , jms:jme  )            :: mu_tend<a name='3021'>
   REAL , DIMENSION( spec_bdy_width) , INTENT(IN   ) :: fcx, gcx<a name='3022'>
<a name='3023'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 )   :: u_b, &amp;<a name='3024'>
                                                                                 v_b, &amp;<a name='3025'>
                                                                                 ph_b, &amp;<a name='3026'>
                                                                                  w_b, &amp;<a name='3027'>
                                                                                 t_b, &amp;<a name='3028'>
                                                                                 u_bt, &amp;<a name='3029'>
                                                                                 v_bt, &amp;<a name='3030'>
                                                                                 ph_bt, &amp;<a name='3031'>
                                                                                  w_bt, &amp;<a name='3032'>
                                                                                 t_bt<a name='3033'>
<a name='3034'>
   REAL,  DIMENSION( ijds:ijde , 1:1     , spec_bdy_width, 4 )     :: mu_b, &amp;<a name='3035'>
                                                                                 mu_bt<a name='3036'>
   REAL, INTENT(IN   ) :: dtbc<a name='3037'>
<a name='3038'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) :: rfield<a name='3039'>
   INTEGER :: i_start, i_end, j_start, j_end, i, j, k<a name='3040'>
<a name='3041'>
<font color=#447700>!  IN variables<a name='3042'></font>
<a name='3043'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: S_ru,     &amp;<a name='3044'>
                                                                      S_rv,     &amp;<a name='3045'>
                                                                      S_ph,     &amp;<a name='3046'>
                                                                      S_w,      &amp;<a name='3047'>
                                                                      S_t<a name='3048'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: P_ru,     &amp;<a name='3049'>
                                                                      P_rv,     &amp;<a name='3050'>
                                                                      P_ph,     &amp;<a name='3051'>
                                                                      P_w,      &amp;<a name='3052'>
                                                                      P_t<a name='3053'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: B_ru,     &amp;<a name='3054'>
                                                                      B_rv,     &amp;<a name='3055'>
                                                                      B_ph,     &amp;<a name='3056'>
                                                                      B_w,      &amp;<a name='3057'>
                                                                      B_t<a name='3058'>
<a name='3059'>
   REAL , DIMENSION( ims:ime , jms:jme  )         :: S_mu, S_mut,P_mu, P_mut,B_mu, B_mut<a name='3060'>
<a name='3061'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 )                :: S_u_b, &amp;<a name='3062'>
                                                                                 S_v_b, &amp;<a name='3063'>
                                                                                 S_ph_b, &amp;<a name='3064'>
                                                                                 S_w_b, &amp;<a name='3065'>
                                                                                 S_t_b, &amp;<a name='3066'>
                                                                                 S_u_bt, &amp;<a name='3067'>
                                                                                 S_v_bt, &amp;<a name='3068'>
                                                                                 S_ph_bt, &amp;<a name='3069'>
                                                                                 S_w_bt, &amp;<a name='3070'>
                                                                                 S_t_bt<a name='3071'>
<a name='3072'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 )                :: P_u_b, &amp;<a name='3073'>
                                                                                 P_v_b, &amp;<a name='3074'>
                                                                                 P_ph_b, &amp;<a name='3075'>
                                                                                 P_w_b, &amp;<a name='3076'>
                                                                                 P_t_b, &amp;<a name='3077'>
                                                                                 P_u_bt, &amp;<a name='3078'>
                                                                                 P_v_bt, &amp;<a name='3079'>
                                                                                 P_ph_bt, &amp;<a name='3080'>
                                                                                 P_w_bt, &amp;<a name='3081'>
                                                                                 P_t_bt<a name='3082'>
<a name='3083'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 )                :: B_u_b, &amp;<a name='3084'>
                                                                                 B_v_b, &amp;<a name='3085'>
                                                                                 B_ph_b, &amp;<a name='3086'>
                                                                                 B_w_b, &amp;<a name='3087'>
                                                                                 B_t_b, &amp;<a name='3088'>
                                                                                 B_u_bt, &amp;<a name='3089'>
                                                                                 B_v_bt, &amp;<a name='3090'>
                                                                                 B_ph_bt, &amp;<a name='3091'>
                                                                                 B_w_bt, &amp;<a name='3092'>
                                                                                 B_t_bt<a name='3093'>
<a name='3094'>
   REAL,  DIMENSION( ijds:ijde , 1:1 , spec_bdy_width, 4 )  :: S_mu_b, S_mu_bt,P_mu_b, P_mu_bt,B_mu_b, B_mu_bt<a name='3095'>
<a name='3096'>
<font color=#447700>!  INOUT variables<a name='3097'></font>
<a name='3098'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: S_ru_tendf, &amp;<a name='3099'>
                                                                      S_rv_tendf, &amp;<a name='3100'>
                                                                      S_ph_tendf, &amp;<a name='3101'>
                                                                      S_rw_tendf, &amp;<a name='3102'>
                                                                      S_t_tendf<a name='3103'>
<a name='3104'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: P_ru_tendf, &amp;<a name='3105'>
                                                                      P_rv_tendf, &amp;<a name='3106'>
                                                                      P_ph_tendf, &amp;<a name='3107'>
                                                                      P_rw_tendf, &amp;<a name='3108'>
                                                                      P_t_tendf<a name='3109'>
<a name='3110'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: K_ru_tendf, &amp;<a name='3111'>
                                                                      K_rv_tendf, &amp;<a name='3112'>
                                                                      K_ph_tendf, &amp;<a name='3113'>
                                                                      K_rw_tendf, &amp;<a name='3114'>
                                                                      K_t_tendf<a name='3115'>
<a name='3116'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: B_ru_tendf, &amp;<a name='3117'>
                                                                      B_rv_tendf, &amp;<a name='3118'>
                                                                      B_ph_tendf, &amp;<a name='3119'>
                                                                      B_rw_tendf, &amp;<a name='3120'>
                                                                      B_t_tendf<a name='3121'>
<a name='3122'>
   REAL , DIMENSION( ims:ime , jms:jme  )  :: S_mu_tend,P_mu_tend,K_mu_tend,B_mu_tend<a name='3123'>
<a name='3124'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='3125'>
   INTEGER :: NT,h<a name='3126'>
<a name='3127'>
   do i=ims,ime<a name='3128'>
   do k=kms,kme<a name='3129'>
   do j=jms,jme<a name='3130'>
      S_ru(i,k,j)=ru(i,k,j)<a name='3131'>
      S_rv(i,k,j)=rv(i,k,j)<a name='3132'>
      S_w(i,k,j)=w(i,k,j)<a name='3133'>
      S_t(i,k,j)=t(i,k,j)<a name='3134'>
      S_ph(i,k,j)=ph(i,k,j)<a name='3135'>
<a name='3136'>
      P_ru(i,k,j)=ru(i,k,j)<a name='3137'>
      P_rv(i,k,j)=rv(i,k,j)<a name='3138'>
      P_w(i,k,j)=w(i,k,j)<a name='3139'>
      P_t(i,k,j)=t(i,k,j)<a name='3140'>
      P_ph(i,k,j)=ph(i,k,j)<a name='3141'>
   enddo<a name='3142'>
   enddo<a name='3143'>
   enddo<a name='3144'>
<a name='3145'>
   do i=ims,ime<a name='3146'>
   do j=jms,jme<a name='3147'>
      S_mu(i,j)=mu(i,j)<a name='3148'>
      S_mut(i,j)=mut(i,j)<a name='3149'>
<a name='3150'>
      P_mu(i,j)=mu(i,j)<a name='3151'>
      P_mut(i,j)=mut(i,j)<a name='3152'>
   enddo<a name='3153'>
   enddo<a name='3154'>
<a name='3155'>
   do i=ijds,ijde<a name='3156'>
   do k=kds,kde<a name='3157'>
   do j=1,spec_bdy_width<a name='3158'>
   do h=1,4<a name='3159'>
      S_u_b(i,k,j,h)=u_b(i,k,j,h)<a name='3160'>
      S_v_b(i,k,j,h)=v_b(i,k,j,h)<a name='3161'>
      S_ph_b(i,k,j,h)=ph_b(i,k,j,h)<a name='3162'>
      S_w_b(i,k,j,h)=w_b(i,k,j,h)<a name='3163'>
      S_t_b(i,k,j,h)=t_b(i,k,j,h)<a name='3164'>
      S_u_bt(i,k,j,h)=u_bt(i,k,j,h)<a name='3165'>
      S_v_bt(i,k,j,h)=v_bt(i,k,j,h)<a name='3166'>
      S_ph_bt(i,k,j,h)=ph_bt(i,k,j,h)<a name='3167'>
      S_w_bt(i,k,j,h)=w_bt(i,k,j,h)<a name='3168'>
      S_t_bt(i,k,j,h)=t_bt(i,k,j,h)<a name='3169'>
<a name='3170'>
      P_u_b(i,k,j,h)=u_b(i,k,j,h)<a name='3171'>
      P_v_b(i,k,j,h)=v_b(i,k,j,h)<a name='3172'>
      P_ph_b(i,k,j,h)=ph_b(i,k,j,h)<a name='3173'>
      P_w_b(i,k,j,h)=w_b(i,k,j,h)<a name='3174'>
      P_t_b(i,k,j,h)=t_b(i,k,j,h)<a name='3175'>
      P_u_bt(i,k,j,h)=u_bt(i,k,j,h)<a name='3176'>
      P_v_bt(i,k,j,h)=v_bt(i,k,j,h)<a name='3177'>
      P_ph_bt(i,k,j,h)=ph_bt(i,k,j,h)<a name='3178'>
      P_w_bt(i,k,j,h)=w_bt(i,k,j,h)<a name='3179'>
      P_t_bt(i,k,j,h)=t_bt(i,k,j,h)<a name='3180'>
   enddo<a name='3181'>
   enddo<a name='3182'>
   enddo<a name='3183'>
   enddo<a name='3184'>
<a name='3185'>
   do i=ijds,ijde<a name='3186'>
   do k=1,1<a name='3187'>
   do j=1,spec_bdy_width<a name='3188'>
   do h=1,4<a name='3189'>
      S_mu_b(i,k,j,h)=mu_b(i,k,j,h)<a name='3190'>
      S_mu_bt(i,k,j,h)=mu_bt(i,k,j,h)<a name='3191'>
<a name='3192'>
      P_mu_b(i,k,j,h)=mu_b(i,k,j,h)<a name='3193'>
      P_mu_bt(i,k,j,h)=mu_bt(i,k,j,h)<a name='3194'>
   enddo<a name='3195'>
   enddo<a name='3196'>
   enddo<a name='3197'>
   enddo<a name='3198'>
<a name='3199'>
   do i=ims,ime<a name='3200'>
   do k=kms,kme<a name='3201'>
   do j=jms,jme<a name='3202'>
      S_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='3203'>
      S_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='3204'>
      S_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='3205'>
      S_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='3206'>
      S_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='3207'>
<a name='3208'>
      P_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='3209'>
      P_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='3210'>
      P_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='3211'>
      P_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='3212'>
      P_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='3213'>
<a name='3214'>
      K_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='3215'>
      K_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='3216'>
      K_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='3217'>
      K_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='3218'>
      K_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='3219'>
   enddo<a name='3220'>
   enddo<a name='3221'>
   enddo<a name='3222'>
<a name='3223'>
   do i=ims,ime<a name='3224'>
   do j=jms,jme<a name='3225'>
      S_mu_tend(i,j)=mu_tend(i,j)<a name='3226'>
      P_mu_tend(i,j)=mu_tend(i,j)<a name='3227'>
      K_mu_tend(i,j)=mu_tend(i,j)<a name='3228'>
   enddo<a name='3229'>
   enddo<a name='3230'>
<a name='3231'>
<font color=#447700>!NLM<a name='3232'></font>
<a name='3233'>
   CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_DRY'>relax_bdy_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_RELAX_BDY_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_DRY_1"> ( config_flags,                                    &amp;<a name='3234'>
                              ru_tendf, rv_tendf, ph_tendf, t_tendf,           &amp;<a name='3235'>
                              rw_tendf, mu_tend,                               &amp;<a name='3236'>
                              ru, rv, ph, t,                                   &amp;<a name='3237'>
                              w, mu, mut,                                      &amp;<a name='3238'>
                              u_b, v_b, ph_b, t_b,                             &amp;<a name='3239'>
                              w_b, mu_b,                                       &amp;<a name='3240'>
                              u_bt, v_bt, ph_bt, t_bt,                         &amp;<a name='3241'>
                              w_bt, mu_bt,                                     &amp;<a name='3242'>
                              spec_bdy_width, spec_zone, relax_zone,           &amp;<a name='3243'>
                              dtbc, fcx, gcx,             &amp;<a name='3244'>
                              ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='3245'></font>
                              ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='3246'></font>
                              ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='3247'></font>
                              ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='3248'></font>
                              its, ite, jts, jte, kts, kte)<a name='3249'>
<a name='3250'>
   do i=its,ite<a name='3251'>
   do k=kts,kte<a name='3252'>
   do j=jts,jte<a name='3253'>
      B_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='3254'>
      B_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='3255'>
      B_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='3256'>
      B_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='3257'>
      B_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='3258'>
   enddo<a name='3259'>
   enddo<a name='3260'>
   enddo<a name='3261'>
<a name='3262'>
   do i=its,ite<a name='3263'>
   do j=jts,jte<a name='3264'>
      B_mu_tend(i,j)=mu_tend(i,j)<a name='3265'>
   enddo<a name='3266'>
   enddo<a name='3267'>
<a name='3268'>
<font color=#447700>!  TCL<a name='3269'></font>
<a name='3270'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_tl.F.html#G_RELAX_BDY_DRY'>g_relax_bdy_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_RELAX_BDY_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RELAX_BDY_DRY_1">( config_flags, K_ru_tendf, P_ru_tendf, K_rv_tendf, P_rv_tendf, K_ph_tendf, P_ph_tendf, K_t_tendf, P_t_tendf, &amp;<a name='3271'>
&amp;K_rw_tendf, P_rw_tendf, K_mu_tend, P_mu_tend, ru, P_ru, rv, P_rv, ph, P_ph, t, P_t, w, P_w, mu, P_mu, mut, P_mut, u_b, P_u_b, v_b, &amp;<a name='3272'>
&amp;P_v_b, ph_b, P_ph_b, t_b, P_t_b, w_b, P_w_b, mu_b, P_mu_b, u_bt, P_u_bt, v_bt, P_v_bt, ph_bt, P_ph_bt, t_bt, P_t_bt, w_bt, P_w_bt,&amp;<a name='3273'>
&amp; mu_bt, P_mu_bt, spec_bdy_width, spec_zone, relax_zone, dtbc, fcx, gcx, ijds, ijde, ids, ide, jds, jde, kds, kde, ims, ime, jms, &amp;<a name='3274'>
&amp;jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='3275'>
<a name='3276'>
   SAVE_L=0.<a name='3277'>
   do i=its,ite<a name='3278'>
   do k=kts,kte<a name='3279'>
   do j=jts,jte<a name='3280'>
      SAVE_L=SAVE_L + P_ru_tendf(i,k,j)*P_ru_tendf(i,k,j)   &amp;<a name='3281'>
                    + P_rv_tendf(i,k,j)*P_rv_tendf(i,k,j)   &amp;<a name='3282'>
                    + P_rw_tendf(i,k,j)*P_rw_tendf(i,k,j)   &amp;<a name='3283'>
                    + P_t_tendf(i,k,j)*P_t_tendf(i,k,j)     &amp;<a name='3284'>
                    + P_ph_tendf(i,k,j)*P_ph_tendf(i,k,j)<a name='3285'>
   enddo<a name='3286'>
   enddo<a name='3287'>
   enddo<a name='3288'>
   do i=its,ite<a name='3289'>
   do j=jts,jte<a name='3290'>
      SAVE_L=SAVE_L + P_mu_tend(i,j)*P_mu_tend(i,j)<a name='3291'>
   enddo<a name='3292'>
   enddo<a name='3293'>
<a name='3294'>
#ifdef DM_PARALLEL<a name='3295'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='3296'>
                       comm, IERROR )<a name='3297'>
   SAVE_L = nsum <a name='3298'>
#endif<a name='3299'>
<a name='3300'>
   ALPHA=1.<a name='3301'>
   DO NT=1,11<a name='3302'>
      ALPHA=0.1*ALPHA<a name='3303'>
      FACTOR=1.+ALPHA<a name='3304'>
   do i=ims,ime<a name='3305'>
   do k=kms,kme<a name='3306'>
   do j=jms,jme<a name='3307'>
      P_ru(i,k,j)=FACTOR*S_ru(i,k,j)<a name='3308'>
      P_rv(i,k,j)=FACTOR*S_rv(i,k,j)<a name='3309'>
      P_w(i,k,j)=FACTOR*S_w(i,k,j)<a name='3310'>
      P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='3311'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='3312'>
   enddo<a name='3313'>
   enddo<a name='3314'>
   enddo<a name='3315'>
<a name='3316'>
   do i=ims,ime<a name='3317'>
   do j=jms,jme<a name='3318'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='3319'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='3320'>
   enddo<a name='3321'>
   enddo<a name='3322'>
   do i=ijds,ijde<a name='3323'>
   do k=kds,kde<a name='3324'>
   do j=1,spec_bdy_width<a name='3325'>
   do h=1,4<a name='3326'>
      P_u_b(i,k,j,h)=FACTOR*S_u_b(i,k,j,h)<a name='3327'>
      P_v_b(i,k,j,h)=FACTOR*S_v_b(i,k,j,h)<a name='3328'>
      P_ph_b(i,k,j,h)=FACTOR*S_ph_b(i,k,j,h)<a name='3329'>
      P_w_b(i,k,j,h)=FACTOR*S_w_b(i,k,j,h)<a name='3330'>
      P_t_b(i,k,j,h)=FACTOR*S_t_b(i,k,j,h)<a name='3331'>
      P_u_bt(i,k,j,h)=FACTOR*S_u_bt(i,k,j,h)<a name='3332'>
      P_v_bt(i,k,j,h)=FACTOR*S_v_bt(i,k,j,h)<a name='3333'>
      P_ph_bt(i,k,j,h)=FACTOR*S_ph_bt(i,k,j,h)<a name='3334'>
      P_w_bt(i,k,j,h)=FACTOR*S_w_bt(i,k,j,h)<a name='3335'>
      P_t_bt(i,k,j,h)=FACTOR*S_t_bt(i,k,j,h)<a name='3336'>
   enddo<a name='3337'>
   enddo<a name='3338'>
   enddo<a name='3339'>
   enddo<a name='3340'>
<a name='3341'>
   do i=ijds,ijde<a name='3342'>
   do k=1,1<a name='3343'>
   do j=1,spec_bdy_width<a name='3344'>
   do h=1,4<a name='3345'>
      P_mu_b(i,k,j,h)=FACTOR*S_mu_b(i,k,j,h)<a name='3346'>
      P_mu_bt(i,k,j,h)=FACTOR*S_mu_bt(i,k,j,h)<a name='3347'>
   enddo<a name='3348'>
   enddo<a name='3349'>
   enddo<a name='3350'>
   enddo<a name='3351'>
   do i=ims,ime<a name='3352'>
   do k=kms,kme<a name='3353'>
   do j=jms,jme<a name='3354'>
      P_ru_tendf(i,k,j)=FACTOR*S_ru_tendf(i,k,j)<a name='3355'>
      P_rv_tendf(i,k,j)=FACTOR*S_rv_tendf(i,k,j)<a name='3356'>
      P_rw_tendf(i,k,j)=FACTOR*S_rw_tendf(i,k,j)<a name='3357'>
      P_t_tendf(i,k,j)=FACTOR*S_t_tendf(i,k,j)<a name='3358'>
      P_ph_tendf(i,k,j)=FACTOR*S_ph_tendf(i,k,j)<a name='3359'>
   enddo<a name='3360'>
   enddo<a name='3361'>
   enddo<a name='3362'>
<a name='3363'>
   do i=ims,ime<a name='3364'>
   do j=jms,jme<a name='3365'>
      P_mu_tend(i,j)=FACTOR*S_mu_tend(i,j)<a name='3366'>
   enddo<a name='3367'>
   enddo<a name='3368'>
<a name='3369'>
   CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_DRY'>relax_bdy_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_RELAX_BDY_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_DRY_2"> ( config_flags,                                    &amp;<a name='3370'>
                              P_ru_tendf, P_rv_tendf, P_ph_tendf, P_t_tendf,           &amp;<a name='3371'>
                              P_rw_tendf, P_mu_tend,                               &amp;<a name='3372'>
                              P_ru, P_rv, P_ph, P_t,                                   &amp;<a name='3373'>
                              P_w, P_mu, P_mut,                                      &amp;<a name='3374'>
                              P_u_b, P_v_b, P_ph_b, P_t_b,                             &amp;<a name='3375'>
                              P_w_b, P_mu_b,                                       &amp;<a name='3376'>
                              P_u_bt, P_v_bt, P_ph_bt, P_t_bt,                         &amp;<a name='3377'>
                              P_w_bt, P_mu_bt,                                     &amp;<a name='3378'>
                              spec_bdy_width, spec_zone, relax_zone,           &amp;<a name='3379'>
                              dtbc, fcx, gcx,             &amp;<a name='3380'>
                              ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='3381'></font>
                              ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='3382'></font>
                              ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='3383'></font>
                              ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='3384'></font>
                              its, ite, jts, jte, kts, kte)<a name='3385'>
<a name='3386'>
      VAL_N=0.<a name='3387'>
      do i=its,ite<a name='3388'>
      do k=kts,kte<a name='3389'>
      do j=jts,jte<a name='3390'>
         VAL_N=VAL_N + (P_ru_tendf(i,k,j)-B_ru_tendf(i,k,j))*(P_ru_tendf(i,k,j)-B_ru_tendf(i,k,j))  &amp;<a name='3391'>
                     + (P_rv_tendf(i,k,j)-B_rv_tendf(i,k,j))*(P_rv_tendf(i,k,j)-B_rv_tendf(i,k,j))  &amp;<a name='3392'>
                     + (P_rw_tendf(i,k,j)-B_rw_tendf(i,k,j))*(P_rw_tendf(i,k,j)-B_rw_tendf(i,k,j))  &amp;<a name='3393'>
                     + (P_t_tendf(i,k,j)-B_t_tendf(i,k,j))*(P_t_tendf(i,k,j)-B_t_tendf(i,k,j))      &amp;<a name='3394'>
                     + (P_ph_tendf(i,k,j)-B_ph_tendf(i,k,j))*(P_ph_tendf(i,k,j)-B_ph_tendf(i,k,j))<a name='3395'>
   enddo<a name='3396'>
   enddo<a name='3397'>
   enddo<a name='3398'>
   do i=its,ite<a name='3399'>
   do j=jts,jte<a name='3400'>
         VAL_N=VAL_N + (P_mu_tend(i,j)-B_mu_tend(i,j))*(P_mu_tend(i,j)-B_mu_tend(i,j))<a name='3401'>
   enddo<a name='3402'>
   enddo<a name='3403'>
<a name='3404'>
#ifdef DM_PARALLEL<a name='3405'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='3406'>
                       comm, IERROR )<a name='3407'>
   VAL_N = nsum <a name='3408'>
#endif<a name='3409'>
<a name='3410'>
      VAL_L=SAVE_L*ALPHA**2<a name='3411'>
      COEF=VAL_N/VAL_L<a name='3412'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='3413'>
         'g_relax_bdy_dry: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='3414'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='3415'>
   ENDDO<a name='3416'>
<a name='3417'>
<font color=#447700>!  ADJ test<a name='3418'></font>
<a name='3419'>
   FACTOR=0.1<a name='3420'>
   do i=ims,ime<a name='3421'>
   do k=kms,kme<a name='3422'>
   do j=jms,jme<a name='3423'>
      ru(i,k,j)=S_ru(i,k,j)<a name='3424'>
      rv(i,k,j)=S_rv(i,k,j)<a name='3425'>
      w(i,k,j)=S_w(i,k,j)<a name='3426'>
      t(i,k,j)=S_t(i,k,j)<a name='3427'>
      ph(i,k,j)=S_ph(i,k,j)<a name='3428'>
<a name='3429'>
      P_ru(i,k,j)=FACTOR*S_ru(i,k,j)<a name='3430'>
      P_rv(i,k,j)=FACTOR*S_rv(i,k,j)<a name='3431'>
      P_w(i,k,j)=FACTOR*S_w(i,k,j)<a name='3432'>
      P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='3433'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='3434'>
<a name='3435'>
      B_ru(i,k,j)=P_ru(i,k,j)<a name='3436'>
      B_rv(i,k,j)=P_rv(i,k,j)<a name='3437'>
      B_w(i,k,j)=P_w(i,k,j)<a name='3438'>
      B_t(i,k,j)=P_t(i,k,j)<a name='3439'>
      B_ph(i,k,j)=P_ph(i,k,j)<a name='3440'>
   enddo<a name='3441'>
   enddo<a name='3442'>
   enddo<a name='3443'>
<a name='3444'>
   do i=ims,ime<a name='3445'>
   do j=jms,jme<a name='3446'>
      mu(i,j)=S_mu(i,j)<a name='3447'>
      mut(i,j)=S_mut(i,j)<a name='3448'>
<a name='3449'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='3450'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='3451'>
<a name='3452'>
      B_mu(i,j)=P_mu(i,j)<a name='3453'>
      B_mut(i,j)=P_mut(i,j)<a name='3454'>
   enddo<a name='3455'>
   enddo<a name='3456'>
<a name='3457'>
   do i=ijds,ijde<a name='3458'>
   do k=kds,kde<a name='3459'>
   do j=1,spec_bdy_width<a name='3460'>
   do h=1,4<a name='3461'>
      u_b(i,k,j,h)=S_u_b(i,k,j,h)<a name='3462'>
      v_b(i,k,j,h)=S_v_b(i,k,j,h)<a name='3463'>
      ph_b(i,k,j,h)=S_ph_b(i,k,j,h)<a name='3464'>
      w_b(i,k,j,h)=S_w_b(i,k,j,h)<a name='3465'>
      t_b(i,k,j,h)=S_t_b(i,k,j,h)<a name='3466'>
      u_bt(i,k,j,h)=S_u_bt(i,k,j,h)<a name='3467'>
      v_bt(i,k,j,h)=S_v_bt(i,k,j,h)<a name='3468'>
      ph_bt(i,k,j,h)=S_ph_bt(i,k,j,h)<a name='3469'>
      w_bt(i,k,j,h)=S_w_bt(i,k,j,h)<a name='3470'>
      t_bt(i,k,j,h)=S_t_bt(i,k,j,h)<a name='3471'>
<a name='3472'>
      P_u_b(i,k,j,h)=FACTOR*S_u_b(i,k,j,h)<a name='3473'>
      P_v_b(i,k,j,h)=FACTOR*S_v_b(i,k,j,h)<a name='3474'>
      P_ph_b(i,k,j,h)=FACTOR*S_ph_b(i,k,j,h)<a name='3475'>
      P_w_b(i,k,j,h)=FACTOR*S_w_b(i,k,j,h)<a name='3476'>
      P_t_b(i,k,j,h)=FACTOR*S_t_b(i,k,j,h)<a name='3477'>
      P_u_bt(i,k,j,h)=FACTOR*S_u_bt(i,k,j,h)<a name='3478'>
      P_v_bt(i,k,j,h)=FACTOR*S_v_bt(i,k,j,h)<a name='3479'>
      P_ph_bt(i,k,j,h)=FACTOR*S_ph_bt(i,k,j,h)<a name='3480'>
      P_w_bt(i,k,j,h)=FACTOR*S_w_bt(i,k,j,h)<a name='3481'>
      P_t_bt(i,k,j,h)=FACTOR*S_t_bt(i,k,j,h)<a name='3482'>
<a name='3483'>
      B_u_b(i,k,j,h)=P_u_b(i,k,j,h)<a name='3484'>
      B_v_b(i,k,j,h)=P_v_b(i,k,j,h)<a name='3485'>
      B_ph_b(i,k,j,h)=P_ph_b(i,k,j,h)<a name='3486'>
      B_w_b(i,k,j,h)=P_w_b(i,k,j,h)<a name='3487'>
      B_t_b(i,k,j,h)=P_t_b(i,k,j,h)<a name='3488'>
      B_u_bt(i,k,j,h)=P_u_bt(i,k,j,h)<a name='3489'>
      B_v_bt(i,k,j,h)=P_v_bt(i,k,j,h)<a name='3490'>
      B_ph_bt(i,k,j,h)=P_ph_bt(i,k,j,h)<a name='3491'>
      B_w_bt(i,k,j,h)=P_w_bt(i,k,j,h)<a name='3492'>
      B_t_bt(i,k,j,h)=P_t_bt(i,k,j,h)<a name='3493'>
   enddo<a name='3494'>
   enddo<a name='3495'>
   enddo<a name='3496'>
   enddo<a name='3497'>
<a name='3498'>
   do i=ijds,ijde<a name='3499'>
   do k=1,1<a name='3500'>
   do j=1,spec_bdy_width<a name='3501'>
   do h=1,4<a name='3502'>
      mu_b(i,k,j,h)=S_mu_b(i,k,j,h)<a name='3503'>
      mu_bt(i,k,j,h)=S_mu_bt(i,k,j,h)<a name='3504'>
<a name='3505'>
      P_mu_b(i,k,j,h)=FACTOR*S_mu_b(i,k,j,h)<a name='3506'>
      P_mu_bt(i,k,j,h)=FACTOR*S_mu_bt(i,k,j,h)<a name='3507'>
<a name='3508'>
      B_mu_b(i,k,j,h)=P_mu_b(i,k,j,h)<a name='3509'>
      B_mu_bt(i,k,j,h)=P_mu_bt(i,k,j,h)<a name='3510'>
   enddo<a name='3511'>
   enddo<a name='3512'>
   enddo<a name='3513'>
   enddo<a name='3514'>
   do i=ims,ime<a name='3515'>
   do k=kms,kme<a name='3516'>
   do j=jms,jme<a name='3517'>
      ru_tendf(i,k,j)=S_ru_tendf(i,k,j)<a name='3518'>
      rv_tendf(i,k,j)=S_rv_tendf(i,k,j)<a name='3519'>
      rw_tendf(i,k,j)=S_rw_tendf(i,k,j)<a name='3520'>
      t_tendf(i,k,j)=S_t_tendf(i,k,j)<a name='3521'>
      ph_tendf(i,k,j)=S_ph_tendf(i,k,j)<a name='3522'>
<a name='3523'>
      P_ru_tendf(i,k,j)=FACTOR*S_ru_tendf(i,k,j)<a name='3524'>
      P_rv_tendf(i,k,j)=FACTOR*S_rv_tendf(i,k,j)<a name='3525'>
      P_rw_tendf(i,k,j)=FACTOR*S_rw_tendf(i,k,j)<a name='3526'>
      P_t_tendf(i,k,j)=FACTOR*S_t_tendf(i,k,j)<a name='3527'>
      P_ph_tendf(i,k,j)=FACTOR*S_ph_tendf(i,k,j)<a name='3528'>
<a name='3529'>
      B_ru_tendf(i,k,j)=P_ru_tendf(i,k,j)<a name='3530'>
      B_rv_tendf(i,k,j)=P_rv_tendf(i,k,j)<a name='3531'>
      B_rw_tendf(i,k,j)=P_rw_tendf(i,k,j)<a name='3532'>
      B_t_tendf(i,k,j)=P_t_tendf(i,k,j)<a name='3533'>
      B_ph_tendf(i,k,j)=P_ph_tendf(i,k,j)<a name='3534'>
   enddo<a name='3535'>
   enddo<a name='3536'>
   enddo<a name='3537'>
<a name='3538'>
   do i=ims,ime<a name='3539'>
   do j=jms,jme<a name='3540'>
      mu_tend(i,j)=S_mu_tend(i,j)<a name='3541'>
      P_mu_tend(i,j)=FACTOR*S_mu_tend(i,j)<a name='3542'>
      B_mu_tend(i,j)=P_mu_tend(i,j)<a name='3543'>
   enddo<a name='3544'>
   enddo<a name='3545'>
<a name='3546'>
<font color=#447700>!  TGL<a name='3547'></font>
<a name='3548'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_tl.F.html#G_RELAX_BDY_DRY'>g_relax_bdy_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_RELAX_BDY_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RELAX_BDY_DRY_2">( config_flags, ru_tendf, P_ru_tendf, rv_tendf, P_rv_tendf, ph_tendf, P_ph_tendf, t_tendf, P_t_tendf, &amp;<a name='3549'>
&amp;rw_tendf, P_rw_tendf, mu_tend, P_mu_tend, ru, P_ru, rv, P_rv, ph, P_ph, t, P_t, w, P_w, mu, P_mu, mut, P_mut, u_b, P_u_b, v_b, &amp;<a name='3550'>
&amp;P_v_b, ph_b, P_ph_b, t_b, P_t_b, w_b, P_w_b, mu_b, P_mu_b, u_bt, P_u_bt, v_bt, P_v_bt, ph_bt, P_ph_bt, t_bt, P_t_bt, w_bt, P_w_bt,&amp;<a name='3551'>
&amp; mu_bt, P_mu_bt, spec_bdy_width, spec_zone, relax_zone, dtbc, fcx, gcx, ijds, ijde, ids, ide, jds, jde, kds, kde, ims, ime, jms, &amp;<a name='3552'>
&amp;jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='3553'>
<a name='3554'>
   VAL_L=0.<a name='3555'>
   do i=its,ite<a name='3556'>
   do k=kts,kte<a name='3557'>
   do j=jts,jte<a name='3558'>
      VAL_L=VAL_L + P_ru_tendf(i,k,j)*P_ru_tendf(i,k,j)   &amp;<a name='3559'>
                    + P_rv_tendf(i,k,j)*P_rv_tendf(i,k,j)   &amp;<a name='3560'>
                    + P_rw_tendf(i,k,j)*P_rw_tendf(i,k,j)   &amp;<a name='3561'>
                    + P_t_tendf(i,k,j)*P_t_tendf(i,k,j)     &amp;<a name='3562'>
                    + P_ph_tendf(i,k,j)*P_ph_tendf(i,k,j)<a name='3563'>
   enddo<a name='3564'>
   enddo<a name='3565'>
   enddo<a name='3566'>
   do i=its,ite<a name='3567'>
   do j=jts,jte<a name='3568'>
      VAL_L=VAL_L + P_mu_tend(i,j)*P_mu_tend(i,j)<a name='3569'>
   enddo<a name='3570'>
   enddo<a name='3571'>
<a name='3572'>
#ifdef DM_PARALLEL<a name='3573'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='3574'>
                       comm, IERROR )<a name='3575'>
   VAL_L = nsum <a name='3576'>
#endif<a name='3577'>
<a name='3578'>
   do i=ims,ime<a name='3579'>
   do k=kms,kme<a name='3580'>
   do j=jms,jme<a name='3581'>
      P_ru(i,k,j)=0.0<a name='3582'>
      P_rv(i,k,j)=0.0<a name='3583'>
      P_w(i,k,j)=0.0<a name='3584'>
      P_t(i,k,j)=0.0<a name='3585'>
      P_ph(i,k,j)=0.0<a name='3586'>
   enddo<a name='3587'>
   enddo<a name='3588'>
   enddo<a name='3589'>
<a name='3590'>
   do i=ims,ime<a name='3591'>
   do j=jms,jme<a name='3592'>
      P_mu(i,j)=0.0<a name='3593'>
      P_mut(i,j)=0.0<a name='3594'>
   enddo<a name='3595'>
   enddo<a name='3596'>
   do i=ijds,ijde<a name='3597'>
   do k=kds,kde<a name='3598'>
   do j=1,spec_bdy_width<a name='3599'>
   do h=1,4<a name='3600'>
      P_u_b(i,k,j,h)=0.0<a name='3601'>
      P_v_b(i,k,j,h)=0.0<a name='3602'>
      P_ph_b(i,k,j,h)=0.0<a name='3603'>
      P_w_b(i,k,j,h)=0.0<a name='3604'>
      P_t_b(i,k,j,h)=0.0<a name='3605'>
      P_u_bt(i,k,j,h)=0.0<a name='3606'>
      P_v_bt(i,k,j,h)=0.0<a name='3607'>
      P_ph_bt(i,k,j,h)=0.0<a name='3608'>
      P_w_bt(i,k,j,h)=0.0<a name='3609'>
      P_t_bt(i,k,j,h)=0.0<a name='3610'>
   enddo<a name='3611'>
   enddo<a name='3612'>
   enddo<a name='3613'>
   enddo<a name='3614'>
   do i=ijds,ijde<a name='3615'>
   do k=1,1<a name='3616'>
   do j=1,spec_bdy_width<a name='3617'>
   do h=1,4<a name='3618'>
      P_mu_b(i,k,j,h)=0.0<a name='3619'>
      P_mu_bt(i,k,j,h)=0.0<a name='3620'>
   enddo<a name='3621'>
   enddo<a name='3622'>
   enddo<a name='3623'>
   enddo<a name='3624'>
<a name='3625'>
<font color=#447700>!  ADJ<a name='3626'></font>
<a name='3627'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_ad.F.html#A_RELAX_BDY_DRY'>a_relax_bdy_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_RELAX_BDY_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_RELAX_BDY_DRY_1">( config_flags, P_ru_tendf, P_rv_tendf, P_ph_tendf, P_t_tendf, P_rw_tendf, P_mu_tend, P_ru, P_rv, ph, &amp;<a name='3628'>
&amp;P_ph, t, P_t, w, P_w, P_mu, mut, P_mut, P_u_b, P_v_b, P_ph_b, P_t_b, P_w_b, P_mu_b, P_u_bt, P_v_bt, P_ph_bt, P_t_bt, P_w_bt, &amp;<a name='3629'>
&amp;P_mu_bt, spec_bdy_width, spec_zone, relax_zone, dtbc, fcx, gcx, ijds, ijde, ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms,&amp;<a name='3630'>
&amp; kme, its, ite, jts, jte, kts, kte )<a name='3631'>
<a name='3632'>
   VAL_A=0.<a name='3633'>
   do i=its,ite<a name='3634'>
   do k=kts,kte<a name='3635'>
   do j=jts,jte<a name='3636'>
      VAL_A=VAL_A + P_ru(i,k,j)*B_ru(i,k,j)    &amp;<a name='3637'>
              + P_rv(i,k,j)*B_rv(i,k,j)        &amp;<a name='3638'>
              + P_w(i,k,j)*B_w(i,k,j)          &amp;<a name='3639'>
              + P_t(i,k,j)*B_t(i,k,j)          &amp;<a name='3640'>
              + P_ph(i,k,j)*B_ph(i,k,j)<a name='3641'>
   enddo<a name='3642'>
   enddo<a name='3643'>
   enddo<a name='3644'>
<a name='3645'>
   do i=its,ite<a name='3646'>
   do j=jts,jte<a name='3647'>
      VAL_A=VAL_A + P_mu(i,j)*B_mu(i,j)    &amp;<a name='3648'>
              + P_mut(i,j)*B_mut(i,j)<a name='3649'>
   enddo<a name='3650'>
   enddo<a name='3651'>
<a name='3652'>
   do i=ijds,ijde<a name='3653'>
   do k=kds,kde<a name='3654'>
   do j=1,spec_bdy_width<a name='3655'>
   do h=1,4<a name='3656'>
      VAL_A=VAL_A + P_u_b(i,k,j,h)*B_u_b(i,k,j,h)       &amp;<a name='3657'>
              + P_v_b(i,k,j,h)*B_v_b(i,k,j,h)       &amp;<a name='3658'>
              + P_ph_b(i,k,j,h)*B_ph_b(i,k,j,h)       &amp;<a name='3659'>
              + P_w_b(i,k,j,h)*B_w_b(i,k,j,h)       &amp;<a name='3660'>
              + P_t_b(i,k,j,h)*B_t_b(i,k,j,h)       &amp;<a name='3661'>
              + P_u_bt(i,k,j,h)*B_u_bt(i,k,j,h)       &amp;<a name='3662'>
              + P_v_bt(i,k,j,h)*B_v_bt(i,k,j,h)       &amp;<a name='3663'>
              + P_ph_bt(i,k,j,h)*B_ph_bt(i,k,j,h)       &amp;<a name='3664'>
              + P_w_bt(i,k,j,h)*B_w_bt(i,k,j,h)       &amp;<a name='3665'>
              + P_t_bt(i,k,j,h)*B_t_bt(i,k,j,h)       <a name='3666'>
   enddo<a name='3667'>
   enddo<a name='3668'>
   enddo<a name='3669'>
   enddo<a name='3670'>
<a name='3671'>
   do i=ijds,ijde<a name='3672'>
   do k=1,1<a name='3673'>
   do j=1,spec_bdy_width<a name='3674'>
   do h=1,4<a name='3675'>
      VAL_A=VAL_A + P_mu_b(i,k,j,h)*B_mu_b(i,k,j,h)    &amp;<a name='3676'>
              + P_mu_bt(i,k,j,h)*B_mu_bt(i,k,j,h)<a name='3677'>
   enddo<a name='3678'>
   enddo<a name='3679'>
   enddo<a name='3680'>
   enddo<a name='3681'>
   do i=its,ite<a name='3682'>
   do k=kts,kte<a name='3683'>
   do j=jts,jte<a name='3684'>
      VAL_A=VAL_A + P_ru_tendf(i,k,j)*B_ru_tendf(i,k,j)    &amp;<a name='3685'>
              + P_rv_tendf(i,k,j)*B_rv_tendf(i,k,j)    &amp;<a name='3686'>
              + P_rw_tendf(i,k,j)*B_rw_tendf(i,k,j)    &amp;<a name='3687'>
              + P_t_tendf(i,k,j)*B_t_tendf(i,k,j)    &amp;<a name='3688'>
              + P_ph_tendf(i,k,j)*B_ph_tendf(i,k,j)<a name='3689'>
   enddo<a name='3690'>
   enddo<a name='3691'>
   enddo<a name='3692'>
   do i=its,ite<a name='3693'>
   do j=jts,jte<a name='3694'>
      VAL_A=VAL_A + P_mu_tend(i,j)*B_mu_tend(i,j)<a name='3695'>
   enddo<a name='3696'>
   enddo<a name='3697'>
<a name='3698'>
#ifdef DM_PARALLEL<a name='3699'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='3700'>
                       comm, IERROR )<a name='3701'>
   VAL_A = nsum <a name='3702'>
#endif<a name='3703'>
<a name='3704'>
   print*, '                '<a name='3705'>
   write(6,*) 'a_relax_bdy_dry: '<a name='3706'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='3707'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='3708'>
<a name='3709'>
<font color=#447700>!  RECOVER<a name='3710'></font>
<a name='3711'>
   do i=ims,ime<a name='3712'>
   do k=kms,kme<a name='3713'>
   do j=jms,jme<a name='3714'>
      ru(i,k,j)=S_ru(i,k,j)<a name='3715'>
      rv(i,k,j)=S_rv(i,k,j)<a name='3716'>
      w(i,k,j)=S_w(i,k,j)<a name='3717'>
      t(i,k,j)=S_t(i,k,j)<a name='3718'>
      ph(i,k,j)=S_ph(i,k,j)<a name='3719'>
   enddo<a name='3720'>
   enddo<a name='3721'>
   enddo<a name='3722'>
<a name='3723'>
   do i=ims,ime<a name='3724'>
   do j=jms,jme<a name='3725'>
      mu(i,j)=S_mu(i,j)<a name='3726'>
      mut(i,j)=S_mut(i,j)<a name='3727'>
   enddo<a name='3728'>
   enddo<a name='3729'>
   do i=ijds,ijde<a name='3730'>
   do k=kds,kde<a name='3731'>
   do j=1,spec_bdy_width<a name='3732'>
   do h=1,4<a name='3733'>
      u_b(i,k,j,h)=S_u_b(i,k,j,h)<a name='3734'>
      v_b(i,k,j,h)=S_v_b(i,k,j,h)<a name='3735'>
      ph_b(i,k,j,h)=S_ph_b(i,k,j,h)<a name='3736'>
      w_b(i,k,j,h)=S_w_b(i,k,j,h)<a name='3737'>
      t_b(i,k,j,h)=S_t_b(i,k,j,h)<a name='3738'>
      u_bt(i,k,j,h)=S_u_bt(i,k,j,h)<a name='3739'>
      v_bt(i,k,j,h)=S_v_bt(i,k,j,h)<a name='3740'>
      ph_bt(i,k,j,h)=S_ph_bt(i,k,j,h)<a name='3741'>
      w_bt(i,k,j,h)=S_w_bt(i,k,j,h)<a name='3742'>
      t_bt(i,k,j,h)=S_t_bt(i,k,j,h)<a name='3743'>
   enddo<a name='3744'>
   enddo<a name='3745'>
   enddo<a name='3746'>
   enddo<a name='3747'>
<a name='3748'>
   do i=ijds,ijde<a name='3749'>
   do k=1,1<a name='3750'>
   do j=1,spec_bdy_width<a name='3751'>
   do h=1,4<a name='3752'>
      mu_b(i,k,j,h)=S_mu_b(i,k,j,h)<a name='3753'>
      mu_bt(i,k,j,h)=S_mu_bt(i,k,j,h)<a name='3754'>
   enddo<a name='3755'>
   enddo<a name='3756'>
   enddo<a name='3757'>
   enddo<a name='3758'>
   do i=ims,ime<a name='3759'>
   do k=kms,kme<a name='3760'>
   do j=jms,jme<a name='3761'>
      ru_tendf(i,k,j)=S_ru_tendf(i,k,j)<a name='3762'>
      rv_tendf(i,k,j)=S_rv_tendf(i,k,j)<a name='3763'>
      rw_tendf(i,k,j)=S_rw_tendf(i,k,j)<a name='3764'>
      t_tendf(i,k,j)=S_t_tendf(i,k,j)<a name='3765'>
      ph_tendf(i,k,j)=S_ph_tendf(i,k,j)<a name='3766'>
   enddo<a name='3767'>
   enddo<a name='3768'>
   enddo<a name='3769'>
<a name='3770'>
   do i=ims,ime<a name='3771'>
   do j=jms,jme<a name='3772'>
      mu_tend(i,j)=S_mu_tend(i,j)<a name='3773'>
   enddo<a name='3774'>
   enddo<a name='3775'>
<a name='3776'>
<a name='3777'>
END SUBROUTINE t_relax_bdy_dry<a name='3778'>
<a name='3779'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='3780'></font>
<a name='3781'>
<A NAME='T_RK_ADDTEND_DRY'><A href='../../html_code/dyn_em/module_check.F.html#T_RK_ADDTEND_DRY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3782'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_rk_addtend_dry</font> ( ru_tend, rv_tend, rw_tend, ph_tend, t_tend,      &amp; <A href='../../call_to/T_RK_ADDTEND_DRY.html' TARGET='index'>1</A>,<A href='../../call_from/T_RK_ADDTEND_DRY.html' TARGET='index'>5</A><a name='3783'>
                            ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='3784'>
                            u_save, v_save, w_save, ph_save, t_save, rk_step,&amp;<a name='3785'>
                            h_diabatic, mut, msft, msfu, msfv,               &amp;<a name='3786'>
                            ids,ide, jds,jde, kds,kde,                       &amp;<a name='3787'>
                            ims,ime, jms,jme, kms,kme,                       &amp;<a name='3788'>
                            ips,ipe, jps,jpe, kps,kpe,                       &amp;<a name='3789'>
                            its,ite, jts,jte, kts,kte                       )<a name='3790'>
<a name='3791'>
<a name='3792'>
   IMPLICIT NONE<a name='3793'>
<a name='3794'>
   <font color=#447700>!  Input data.<a name='3795'></font>
<a name='3796'>
   INTEGER ,               INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3797'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='3798'>
                                            ips, ipe, jps, jpe, kps, kpe, &amp;<a name='3799'>
                                            its, ite, jts, jte, kts, kte<a name='3800'>
   INTEGER ,               INTENT(IN   ) :: rk_step<a name='3801'>
<a name='3802'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: ru_tend, &amp;<a name='3803'>
                                                                      rv_tend, &amp;<a name='3804'>
                                                                      rw_tend, &amp;<a name='3805'>
                                                                      ph_tend, &amp;<a name='3806'>
                                                                      t_tend,  &amp;<a name='3807'>
                                                                      ru_tendf, &amp;<a name='3808'>
                                                                      rv_tendf, &amp;<a name='3809'>
                                                                      rw_tendf, &amp;<a name='3810'>
                                                                      ph_tendf, &amp;<a name='3811'>
                                                                      t_tendf<a name='3812'>
<a name='3813'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 ::  u_save,  &amp;<a name='3814'>
                                                                       v_save,  &amp;<a name='3815'>
                                                                       w_save,  &amp;<a name='3816'>
                                                                      ph_save,  &amp;<a name='3817'>
                                                                       t_save<a name='3818'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )     :: h_diabatic<a name='3819'>
<a name='3820'>
   REAL , DIMENSION( ims:ime , jms:jme )              :: mut<a name='3821'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msft, &amp;<a name='3822'>
                                                                    msfu, &amp;<a name='3823'>
                                                                    msfv<a name='3824'>
<a name='3825'>
<a name='3826'>
<font color=#447700>! Local<a name='3827'></font>
   INTEGER :: i, j, k<a name='3828'>
<a name='3829'>
<font color=#447700>!  IN variables<a name='3830'></font>
<a name='3831'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 ::  S_u_save,  &amp;<a name='3832'>
                                                                       S_v_save,  &amp;<a name='3833'>
                                                                       S_w_save,  &amp;<a name='3834'>
                                                                       S_ph_save,  &amp;<a name='3835'>
                                                                       S_t_save<a name='3836'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 ::  P_u_save,  &amp;<a name='3837'>
                                                                       P_v_save,  &amp;<a name='3838'>
                                                                       P_w_save,  &amp;<a name='3839'>
                                                                       P_ph_save,  &amp;<a name='3840'>
                                                                       P_t_save<a name='3841'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 ::  B_u_save,  &amp;<a name='3842'>
                                                                       B_v_save,  &amp;<a name='3843'>
                                                                       B_w_save,  &amp;<a name='3844'>
                                                                       B_ph_save,  &amp;<a name='3845'>
                                                                       B_t_save<a name='3846'>
<a name='3847'>
   REAL , DIMENSION( ims:ime , jms:jme )                         :: S_mut,P_mut,B_mut<a name='3848'>
<a name='3849'>
<font color=#447700>!  INOUT variables<a name='3850'></font>
<a name='3851'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: S_ru_tend, &amp;<a name='3852'>
                                                                      S_rv_tend, &amp;<a name='3853'>
                                                                      S_rw_tend, &amp;<a name='3854'>
                                                                      S_ph_tend, &amp;<a name='3855'>
                                                                      S_t_tend,  &amp;<a name='3856'>
                                                                      S_ru_tendf, &amp;<a name='3857'>
                                                                      S_rv_tendf, &amp;<a name='3858'>
                                                                      S_rw_tendf, &amp;<a name='3859'>
                                                                      S_ph_tendf, &amp;<a name='3860'>
                                                                      S_t_tendf<a name='3861'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: P_ru_tend, &amp;<a name='3862'>
                                                                      P_rv_tend, &amp;<a name='3863'>
                                                                      P_rw_tend, &amp;<a name='3864'>
                                                                      P_ph_tend, &amp;<a name='3865'>
                                                                      P_t_tend,  &amp;<a name='3866'>
                                                                      P_ru_tendf, &amp;<a name='3867'>
                                                                      P_rv_tendf, &amp;<a name='3868'>
                                                                      P_rw_tendf, &amp;<a name='3869'>
                                                                      P_ph_tendf, &amp;<a name='3870'>
                                                                      P_t_tendf<a name='3871'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: B_ru_tend, &amp;<a name='3872'>
                                                                      B_rv_tend, &amp;<a name='3873'>
                                                                      B_rw_tend, &amp;<a name='3874'>
                                                                      B_ph_tend, &amp;<a name='3875'>
                                                                      B_t_tend,  &amp;<a name='3876'>
                                                                      B_ru_tendf, &amp;<a name='3877'>
                                                                      B_rv_tendf, &amp;<a name='3878'>
                                                                      B_rw_tendf, &amp;<a name='3879'>
                                                                      B_ph_tendf, &amp;<a name='3880'>
                                                                      B_t_tendf<a name='3881'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: K_ru_tend, &amp;<a name='3882'>
                                                                      K_rv_tend, &amp;<a name='3883'>
                                                                      K_rw_tend, &amp;<a name='3884'>
                                                                      K_ph_tend, &amp;<a name='3885'>
                                                                      K_t_tend,  &amp;<a name='3886'>
                                                                      K_ru_tendf, &amp;<a name='3887'>
                                                                      K_rv_tendf, &amp;<a name='3888'>
                                                                      K_rw_tendf, &amp;<a name='3889'>
                                                                      K_ph_tendf, &amp;<a name='3890'>
                                                                      K_t_tendf<a name='3891'>
<a name='3892'>
<a name='3893'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='3894'>
   INTEGER :: NT<a name='3895'>
<a name='3896'>
<font color=#447700>!TGL test<a name='3897'></font>
<a name='3898'>
   do i=ims,ime<a name='3899'>
   do k=kms,kme<a name='3900'>
   do j=jms,jme<a name='3901'>
      S_u_save(i,k,j)=u_save(i,k,j)<a name='3902'>
      S_v_save(i,k,j)=v_save(i,k,j)<a name='3903'>
      S_w_save(i,k,j)=w_save(i,k,j)<a name='3904'>
      S_t_save(i,k,j)=t_save(i,k,j)<a name='3905'>
      S_ph_save(i,k,j)=ph_save(i,k,j)<a name='3906'>
<a name='3907'>
      P_u_save(i,k,j)=u_save(i,k,j)<a name='3908'>
      P_v_save(i,k,j)=v_save(i,k,j)<a name='3909'>
      P_w_save(i,k,j)=w_save(i,k,j)<a name='3910'>
      P_t_save(i,k,j)=t_save(i,k,j)<a name='3911'>
      P_ph_save(i,k,j)=ph_save(i,k,j)<a name='3912'>
   enddo<a name='3913'>
   enddo<a name='3914'>
   enddo<a name='3915'>
   do i=ims,ime<a name='3916'>
   do j=jms,jme<a name='3917'>
      S_mut(i,j)=mut(i,j)<a name='3918'>
      P_mut(i,j)=mut(i,j)<a name='3919'>
   enddo<a name='3920'>
   enddo<a name='3921'>
   do i=ims,ime<a name='3922'>
   do k=kms,kme<a name='3923'>
   do j=jms,jme<a name='3924'>
      S_ru_tend(i,k,j)=ru_tend(i,k,j)<a name='3925'>
      S_rv_tend(i,k,j)=rv_tend(i,k,j)<a name='3926'>
      S_rw_tend(i,k,j)=rw_tend(i,k,j)<a name='3927'>
      S_t_tend(i,k,j)=t_tend(i,k,j)<a name='3928'>
      S_ph_tend(i,k,j)=ph_tend(i,k,j)<a name='3929'>
      S_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='3930'>
      S_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='3931'>
      S_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='3932'>
      S_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='3933'>
      S_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='3934'>
<a name='3935'>
      P_ru_tend(i,k,j)=ru_tend(i,k,j)<a name='3936'>
      P_rv_tend(i,k,j)=rv_tend(i,k,j)<a name='3937'>
      P_rw_tend(i,k,j)=rw_tend(i,k,j)<a name='3938'>
      P_t_tend(i,k,j)=t_tend(i,k,j)<a name='3939'>
      P_ph_tend(i,k,j)=ph_tend(i,k,j)<a name='3940'>
      P_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='3941'>
      P_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='3942'>
      P_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='3943'>
      P_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='3944'>
      P_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='3945'>
<a name='3946'>
      K_ru_tend(i,k,j)=ru_tend(i,k,j)<a name='3947'>
      K_rv_tend(i,k,j)=rv_tend(i,k,j)<a name='3948'>
      K_rw_tend(i,k,j)=rw_tend(i,k,j)<a name='3949'>
      K_t_tend(i,k,j)=t_tend(i,k,j)<a name='3950'>
      K_ph_tend(i,k,j)=ph_tend(i,k,j)<a name='3951'>
      K_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='3952'>
      K_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='3953'>
      K_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='3954'>
      K_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='3955'>
      K_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='3956'>
   enddo<a name='3957'>
   enddo<a name='3958'>
   enddo<a name='3959'>
<a name='3960'>
<font color=#447700>!NLM<a name='3961'></font>
<a name='3962'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_ADDTEND_DRY'>rk_addtend_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_ADDTEND_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_ADDTEND_DRY_1">    ( ru_tend, rv_tend, rw_tend, ph_tend, t_tend,      &amp;<a name='3963'>
                            ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='3964'>
                            u_save, v_save, w_save, ph_save, t_save, rk_step,&amp;<a name='3965'>
                            h_diabatic, mut, msft, msfu, msfv,               &amp;<a name='3966'>
                            ids,ide, jds,jde, kds,kde,                       &amp;<a name='3967'>
                            ims,ime, jms,jme, kms,kme,                       &amp;<a name='3968'>
                            ips,ipe, jps,jpe, kps,kpe,                       &amp;<a name='3969'>
                            its,ite, jts,jte, kts,kte                       )<a name='3970'>
<a name='3971'>
   do i=its,ite<a name='3972'>
   do k=kts,kte<a name='3973'>
   do j=jts,jte<a name='3974'>
      B_ru_tend(i,k,j)=ru_tend(i,k,j)<a name='3975'>
      B_rv_tend(i,k,j)=rv_tend(i,k,j)<a name='3976'>
      B_rw_tend(i,k,j)=rw_tend(i,k,j)<a name='3977'>
      B_t_tend(i,k,j)=t_tend(i,k,j)<a name='3978'>
      B_ph_tend(i,k,j)=ph_tend(i,k,j)<a name='3979'>
      B_ru_tendf(i,k,j)=ru_tendf(i,k,j)<a name='3980'>
      B_rv_tendf(i,k,j)=rv_tendf(i,k,j)<a name='3981'>
      B_rw_tendf(i,k,j)=rw_tendf(i,k,j)<a name='3982'>
      B_t_tendf(i,k,j)=t_tendf(i,k,j)<a name='3983'>
      B_ph_tendf(i,k,j)=ph_tendf(i,k,j)<a name='3984'>
   enddo<a name='3985'>
   enddo<a name='3986'>
   enddo<a name='3987'>
<a name='3988'>
<font color=#447700>!  TCL<a name='3989'></font>
<a name='3990'>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_RK_ADDTEND_DRY'>g_rk_addtend_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_ADDTEND_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RK_ADDTEND_DRY_1">( K_ru_tend, P_ru_tend, K_rv_tend, P_rv_tend, K_rw_tend, P_rw_tend, K_ph_tend, P_ph_tend, K_t_tend, P_t_tend, &amp;<a name='3991'>
&amp;K_ru_tendf, P_ru_tendf, K_rv_tendf, P_rv_tendf, K_rw_tendf, P_rw_tendf, K_ph_tendf, P_ph_tendf, K_t_tendf, P_t_tendf, u_save, P_u_save, &amp;<a name='3992'>
&amp;v_save, P_v_save, w_save, P_w_save, ph_save, P_ph_save, t_save, P_t_save, rk_step, h_diabatic, mut, P_mut, msft, msfu, msfv, ide, &amp;<a name='3993'>
&amp;jde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='3994'>
<a name='3995'>
   SAVE_L=0.<a name='3996'>
   do i=its,ite<a name='3997'>
   do k=kts,kte<a name='3998'>
   do j=jts,jte<a name='3999'>
      SAVE_L=SAVE_L + P_ru_tend(i,k,j)*P_ru_tend(i,k,j)  &amp;<a name='4000'>
                    + P_rv_tend(i,k,j)*P_rv_tend(i,k,j)  &amp;<a name='4001'>
                    + P_rw_tend(i,k,j)*P_rw_tend(i,k,j)  &amp;<a name='4002'>
                    + P_t_tend(i,k,j)*P_t_tend(i,k,j)    &amp;<a name='4003'>
                    + P_ph_tend(i,k,j)*P_ph_tend(i,k,j)  &amp;<a name='4004'>
                    + P_ru_tendf(i,k,j)*P_ru_tendf(i,k,j)  &amp;<a name='4005'>
                    + P_rv_tendf(i,k,j)*P_rv_tendf(i,k,j)  &amp;<a name='4006'>
                    + P_rw_tendf(i,k,j)*P_rw_tendf(i,k,j)  &amp;<a name='4007'>
                    + P_t_tendf(i,k,j)*P_t_tendf(i,k,j)    &amp;<a name='4008'>
                    + P_ph_tendf(i,k,j)*P_ph_tendf(i,k,j)<a name='4009'>
   enddo<a name='4010'>
   enddo<a name='4011'>
   enddo<a name='4012'>
<a name='4013'>
#ifdef DM_PARALLEL<a name='4014'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='4015'>
                       comm, IERROR )<a name='4016'>
   SAVE_L = nsum <a name='4017'>
#endif<a name='4018'>
<a name='4019'>
   ALPHA=1.<a name='4020'>
   DO NT=1,11<a name='4021'>
      ALPHA=0.1*ALPHA<a name='4022'>
      FACTOR=1.+ALPHA<a name='4023'>
   do i=ims,ime<a name='4024'>
   do k=kms,kme<a name='4025'>
   do j=jms,jme<a name='4026'>
      P_u_save(i,k,j)=FACTOR*S_u_save(i,k,j)<a name='4027'>
      P_v_save(i,k,j)=FACTOR*S_v_save(i,k,j)<a name='4028'>
      P_w_save(i,k,j)=FACTOR*S_w_save(i,k,j)<a name='4029'>
      P_t_save(i,k,j)=FACTOR*S_t_save(i,k,j)<a name='4030'>
      P_ph_save(i,k,j)=FACTOR*S_ph_save(i,k,j)<a name='4031'>
   enddo<a name='4032'>
   enddo<a name='4033'>
   enddo<a name='4034'>
   do i=ims,ime<a name='4035'>
   do j=jms,jme<a name='4036'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='4037'>
   enddo<a name='4038'>
   enddo<a name='4039'>
   do i=ims,ime<a name='4040'>
   do k=kms,kme<a name='4041'>
   do j=jms,jme<a name='4042'>
      P_ru_tend(i,k,j)=FACTOR*S_ru_tend(i,k,j)<a name='4043'>
      P_rv_tend(i,k,j)=FACTOR*S_rv_tend(i,k,j)<a name='4044'>
      P_rw_tend(i,k,j)=FACTOR*S_rw_tend(i,k,j)<a name='4045'>
      P_t_tend(i,k,j)=FACTOR*S_t_tend(i,k,j)<a name='4046'>
      P_ph_tend(i,k,j)=FACTOR*S_ph_tend(i,k,j)<a name='4047'>
      P_ru_tendf(i,k,j)=FACTOR*S_ru_tendf(i,k,j)<a name='4048'>
      P_rv_tendf(i,k,j)=FACTOR*S_rv_tendf(i,k,j)<a name='4049'>
      P_rw_tendf(i,k,j)=FACTOR*S_rw_tendf(i,k,j)<a name='4050'>
      P_t_tendf(i,k,j)=FACTOR*S_t_tendf(i,k,j)<a name='4051'>
      P_ph_tendf(i,k,j)=FACTOR*S_ph_tendf(i,k,j)<a name='4052'>
   enddo<a name='4053'>
   enddo<a name='4054'>
   enddo<a name='4055'>
<a name='4056'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_ADDTEND_DRY'>rk_addtend_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_ADDTEND_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_ADDTEND_DRY_2">    ( P_ru_tend, P_rv_tend, P_rw_tend, P_ph_tend, P_t_tend,      &amp;<a name='4057'>
                            P_ru_tendf, P_rv_tendf, P_rw_tendf, P_ph_tendf, P_t_tendf, &amp;<a name='4058'>
                            P_u_save, P_v_save, P_w_save, P_ph_save, P_t_save, rk_step,&amp;<a name='4059'>
                            h_diabatic, P_mut, msft, msfu, msfv,               &amp;<a name='4060'>
                            ids,ide, jds,jde, kds,kde,                       &amp;<a name='4061'>
                            ims,ime, jms,jme, kms,kme,                       &amp;<a name='4062'>
                            ips,ipe, jps,jpe, kps,kpe,                       &amp;<a name='4063'>
                            its,ite, jts,jte, kts,kte                       )<a name='4064'>
      VAL_N=0.<a name='4065'>
      do i=its,ite<a name='4066'>
      do k=kts,kte<a name='4067'>
      do j=jts,jte<a name='4068'>
         VAL_N=VAL_N+(P_ru_tend(i,k,j)- B_ru_tend(i,k,j))*(P_ru_tend(i,k,j)- B_ru_tend(i,k,j))  &amp;<a name='4069'>
                    +(P_rv_tend(i,k,j)- B_rv_tend(i,k,j))*(P_rv_tend(i,k,j)- B_rv_tend(i,k,j))   &amp;<a name='4070'>
                    +(P_rw_tend(i,k,j)- B_rw_tend(i,k,j))*(P_rw_tend(i,k,j)- B_rw_tend(i,k,j))   &amp;<a name='4071'>
                    +(P_t_tend(i,k,j)- B_t_tend(i,k,j))*(P_t_tend(i,k,j)- B_t_tend(i,k,j))       &amp;<a name='4072'>
                    +(P_ph_tend(i,k,j)- B_ph_tend(i,k,j))*(P_ph_tend(i,k,j)- B_ph_tend(i,k,j))   &amp;<a name='4073'>
                    +(P_ru_tendf(i,k,j)- B_ru_tendf(i,k,j))*(P_ru_tendf(i,k,j)- B_ru_tendf(i,k,j))  &amp;<a name='4074'>
                    +(P_rv_tendf(i,k,j)- B_rv_tendf(i,k,j))*(P_rv_tendf(i,k,j)- B_rv_tendf(i,k,j))   &amp;<a name='4075'>
                    +(P_rw_tendf(i,k,j)- B_rw_tendf(i,k,j))*(P_rw_tendf(i,k,j)- B_rw_tendf(i,k,j))   &amp;<a name='4076'>
                    +(P_t_tendf(i,k,j)- B_t_tendf(i,k,j))*(P_t_tendf(i,k,j)- B_t_tendf(i,k,j))       &amp;<a name='4077'>
                    +(P_ph_tendf(i,k,j)- B_ph_tendf(i,k,j))*(P_ph_tendf(i,k,j)- B_ph_tendf(i,k,j))<a name='4078'>
      enddo<a name='4079'>
      enddo<a name='4080'>
      enddo<a name='4081'>
<a name='4082'>
#ifdef DM_PARALLEL<a name='4083'>
      call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='4084'>
                          comm, IERROR )<a name='4085'>
      VAL_N = nsum <a name='4086'>
#endif<a name='4087'>
<a name='4088'>
      VAL_L=SAVE_L*ALPHA**2<a name='4089'>
      COEF=VAL_N/VAL_L<a name='4090'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='4091'>
         'g_rk_addtend_dry: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='4092'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='4093'>
   ENDDO<a name='4094'>
<a name='4095'>
<font color=#447700>!  ADJ test<a name='4096'></font>
<a name='4097'>
   FACTOR=0.1<a name='4098'>
   do i=ims,ime<a name='4099'>
   do k=kms,kme<a name='4100'>
   do j=jms,jme<a name='4101'>
      u_save(i,k,j)=S_u_save(i,k,j)<a name='4102'>
      v_save(i,k,j)=S_v_save(i,k,j)<a name='4103'>
      w_save(i,k,j)=S_w_save(i,k,j)<a name='4104'>
      t_save(i,k,j)=S_t_save(i,k,j)<a name='4105'>
      ph_save(i,k,j)=S_ph_save(i,k,j)<a name='4106'>
<a name='4107'>
      P_u_save(i,k,j)=FACTOR*S_u_save(i,k,j)<a name='4108'>
      P_v_save(i,k,j)=FACTOR*S_v_save(i,k,j)<a name='4109'>
      P_w_save(i,k,j)=FACTOR*S_w_save(i,k,j)<a name='4110'>
      P_t_save(i,k,j)=FACTOR*S_t_save(i,k,j)<a name='4111'>
      P_ph_save(i,k,j)=FACTOR*S_ph_save(i,k,j)<a name='4112'>
<a name='4113'>
      B_u_save(i,k,j)=P_u_save(i,k,j)<a name='4114'>
      B_v_save(i,k,j)=P_v_save(i,k,j)<a name='4115'>
      B_w_save(i,k,j)=P_w_save(i,k,j)<a name='4116'>
      B_t_save(i,k,j)=P_t_save(i,k,j)<a name='4117'>
      B_ph_save(i,k,j)=P_ph_save(i,k,j)<a name='4118'>
   enddo<a name='4119'>
   enddo<a name='4120'>
   enddo<a name='4121'>
   do i=ims,ime<a name='4122'>
   do j=jms,jme<a name='4123'>
      mut(i,j)=S_mut(i,j)<a name='4124'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='4125'>
      B_mut(i,j)=P_mut(i,j)<a name='4126'>
   enddo<a name='4127'>
   enddo<a name='4128'>
<a name='4129'>
   do i=ims,ime<a name='4130'>
   do k=kms,kme<a name='4131'>
   do j=jms,jme<a name='4132'>
      ru_tend(i,k,j)=S_ru_tend(i,k,j)<a name='4133'>
      rv_tend(i,k,j)=S_rv_tend(i,k,j)<a name='4134'>
      rw_tend(i,k,j)=S_rw_tend(i,k,j)<a name='4135'>
      t_tend(i,k,j)=S_t_tend(i,k,j)<a name='4136'>
      ph_tend(i,k,j)=S_ph_tend(i,k,j)<a name='4137'>
      ru_tendf(i,k,j)=S_ru_tendf(i,k,j)<a name='4138'>
      rv_tendf(i,k,j)=S_rv_tendf(i,k,j)<a name='4139'>
      rw_tendf(i,k,j)=S_rw_tendf(i,k,j)<a name='4140'>
      t_tendf(i,k,j)=S_t_tendf(i,k,j)<a name='4141'>
      ph_tendf(i,k,j)=S_ph_tendf(i,k,j)<a name='4142'>
<a name='4143'>
      P_ru_tend(i,k,j)=FACTOR*S_ru_tend(i,k,j)<a name='4144'>
      P_rv_tend(i,k,j)=FACTOR*S_rv_tend(i,k,j)<a name='4145'>
      P_rw_tend(i,k,j)=FACTOR*S_rw_tend(i,k,j)<a name='4146'>
      P_t_tend(i,k,j)=FACTOR*S_t_tend(i,k,j)<a name='4147'>
      P_ph_tend(i,k,j)=FACTOR*S_ph_tend(i,k,j)<a name='4148'>
      P_ru_tendf(i,k,j)=FACTOR*S_ru_tendf(i,k,j)<a name='4149'>
      P_rv_tendf(i,k,j)=FACTOR*S_rv_tendf(i,k,j)<a name='4150'>
      P_rw_tendf(i,k,j)=FACTOR*S_rw_tendf(i,k,j)<a name='4151'>
      P_t_tendf(i,k,j)=FACTOR*S_t_tendf(i,k,j)<a name='4152'>
      P_ph_tendf(i,k,j)=FACTOR*S_ph_tendf(i,k,j)<a name='4153'>
<a name='4154'>
      B_ru_tend(i,k,j)=P_ru_tend(i,k,j)<a name='4155'>
      B_rv_tend(i,k,j)=P_rv_tend(i,k,j)<a name='4156'>
      B_rw_tend(i,k,j)=P_rw_tend(i,k,j)<a name='4157'>
      B_t_tend(i,k,j)=P_t_tend(i,k,j)<a name='4158'>
      B_ph_tend(i,k,j)=P_ph_tend(i,k,j)<a name='4159'>
      B_ru_tendf(i,k,j)=P_ru_tendf(i,k,j)<a name='4160'>
      B_rv_tendf(i,k,j)=P_rv_tendf(i,k,j)<a name='4161'>
      B_rw_tendf(i,k,j)=P_rw_tendf(i,k,j)<a name='4162'>
      B_t_tendf(i,k,j)=P_t_tendf(i,k,j)<a name='4163'>
      B_ph_tendf(i,k,j)=P_ph_tendf(i,k,j)<a name='4164'>
<a name='4165'>
   enddo<a name='4166'>
   enddo<a name='4167'>
   enddo<a name='4168'>
<a name='4169'>
<font color=#447700>!  TGL<a name='4170'></font>
<a name='4171'>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_RK_ADDTEND_DRY'>g_rk_addtend_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_ADDTEND_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RK_ADDTEND_DRY_2">( ru_tend, P_ru_tend, rv_tend, P_rv_tend, rw_tend, P_rw_tend, ph_tend, P_ph_tend, t_tend, P_t_tend, &amp;<a name='4172'>
&amp;ru_tendf, P_ru_tendf, rv_tendf, P_rv_tendf, rw_tendf, P_rw_tendf, ph_tendf, P_ph_tendf, t_tendf, P_t_tendf, u_save, P_u_save, &amp;<a name='4173'>
&amp;v_save, P_v_save, w_save, P_w_save, ph_save, P_ph_save, t_save, P_t_save, rk_step, h_diabatic, mut, P_mut, msft, msfu, msfv, ide, &amp;<a name='4174'>
&amp;jde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='4175'>
<a name='4176'>
   VAL_L=0.<a name='4177'>
   do i=its,ite<a name='4178'>
   do k=kts,kte<a name='4179'>
   do j=jts,jte<a name='4180'>
      VAL_L=VAL_L + P_ru_tend(i,k,j)*P_ru_tend(i,k,j)  &amp;<a name='4181'>
                    + P_rv_tend(i,k,j)*P_rv_tend(i,k,j)  &amp;<a name='4182'>
                    + P_rw_tend(i,k,j)*P_rw_tend(i,k,j)  &amp;<a name='4183'>
                    + P_t_tend(i,k,j)*P_t_tend(i,k,j)    &amp;<a name='4184'>
                    + P_ph_tend(i,k,j)*P_ph_tend(i,k,j)  &amp;<a name='4185'>
                    + P_ru_tendf(i,k,j)*P_ru_tendf(i,k,j)  &amp;<a name='4186'>
                    + P_rv_tendf(i,k,j)*P_rv_tendf(i,k,j)  &amp;<a name='4187'>
                    + P_rw_tendf(i,k,j)*P_rw_tendf(i,k,j)  &amp;<a name='4188'>
                    + P_t_tendf(i,k,j)*P_t_tendf(i,k,j)    &amp;<a name='4189'>
                    + P_ph_tendf(i,k,j)*P_ph_tendf(i,k,j)<a name='4190'>
   enddo<a name='4191'>
   enddo<a name='4192'>
   enddo<a name='4193'>
<a name='4194'>
#ifdef DM_PARALLEL<a name='4195'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='4196'>
                       comm, IERROR )<a name='4197'>
   VAL_L = nsum <a name='4198'>
#endif<a name='4199'>
<a name='4200'>
   do i=ims,ime<a name='4201'>
   do k=kms,kme<a name='4202'>
   do j=jms,jme<a name='4203'>
      P_u_save(i,k,j)=0.0<a name='4204'>
      P_v_save(i,k,j)=0.0<a name='4205'>
      P_w_save(i,k,j)=0.0<a name='4206'>
      P_t_save(i,k,j)=0.0<a name='4207'>
      P_ph_save(i,k,j)=0.0<a name='4208'>
   enddo<a name='4209'>
   enddo<a name='4210'>
   enddo<a name='4211'>
   do i=ims,ime<a name='4212'>
   do j=jms,jme<a name='4213'>
      P_mut(i,j)=0.0<a name='4214'>
   enddo<a name='4215'>
   enddo<a name='4216'>
<a name='4217'>
<font color=#447700>!  ADJ<a name='4218'></font>
<a name='4219'>
   CALL <A href='../../html_code/dyn_em/module_em_ad.F.html#A_RK_ADDTEND_DRY'>a_rk_addtend_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_ADDTEND_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_RK_ADDTEND_DRY_1">( P_ru_tend, P_rv_tend, P_rw_tend, P_ph_tend, P_t_tend, P_ru_tendf, P_rv_tendf, P_rw_tendf, P_ph_tendf, &amp;<a name='4220'>
&amp;P_t_tendf, P_u_save, P_v_save, P_w_save, P_ph_save, P_t_save, rk_step, h_diabatic, P_mut, msft, msfu, msfv, ide, jde, ims, ime, &amp;<a name='4221'>
&amp;jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='4222'>
<a name='4223'>
   VAL_A=0.<a name='4224'>
   do i=its,ite<a name='4225'>
   do k=kts,kte<a name='4226'>
   do j=jts,jte<a name='4227'>
      VAL_A=VAL_A + P_u_save(i,k,j)*B_u_save(i,k,j)      &amp;<a name='4228'>
               + P_v_save(i,k,j)*B_v_save(i,k,j)         &amp;<a name='4229'>
               + P_w_save(i,k,j)*B_w_save(i,k,j)         &amp;<a name='4230'>
               + P_t_save(i,k,j)*B_t_save(i,k,j)         &amp;<a name='4231'>
               + P_ph_save(i,k,j)*B_ph_save(i,k,j)<a name='4232'>
   enddo<a name='4233'>
   enddo<a name='4234'>
   enddo<a name='4235'>
   do i=its,ite<a name='4236'>
   do j=jts,jte<a name='4237'>
      VAL_A=VAL_A + P_mut(i,j)*B_mut(i,j)<a name='4238'>
   enddo<a name='4239'>
   enddo<a name='4240'>
   do i=its,ite<a name='4241'>
   do k=kts,kte<a name='4242'>
   do j=jts,jte<a name='4243'>
      VAL_A=VAL_A + P_ru_tend(i,k,j)*B_ru_tend(i,k,j)      &amp;<a name='4244'>
               + P_rv_tend(i,k,j)*B_rv_tend(i,k,j)         &amp;<a name='4245'>
               + P_rw_tend(i,k,j)*B_rw_tend(i,k,j)         &amp;<a name='4246'>
               + P_t_tend(i,k,j)*B_t_tend(i,k,j)           &amp;<a name='4247'>
               + P_ph_tend(i,k,j)*B_ph_tend(i,k,j)         &amp;<a name='4248'>
               + P_ru_tendf(i,k,j)*B_ru_tendf(i,k,j)       &amp;<a name='4249'>
               + P_rv_tendf(i,k,j)*B_rv_tendf(i,k,j)       &amp;<a name='4250'>
               + P_rw_tendf(i,k,j)*B_rw_tendf(i,k,j)       &amp;<a name='4251'>
               + P_t_tendf(i,k,j)*B_t_tendf(i,k,j)         &amp;<a name='4252'>
               + P_ph_tendf(i,k,j)*B_ph_tendf(i,k,j)<a name='4253'>
   enddo<a name='4254'>
   enddo<a name='4255'>
   enddo<a name='4256'>
<a name='4257'>
#ifdef DM_PARALLEL<a name='4258'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='4259'>
                       comm, IERROR )<a name='4260'>
   VAL_A = nsum <a name='4261'>
#endif<a name='4262'>
<a name='4263'>
   print*, '                '<a name='4264'>
   write(6,*) 'a_rk_addtend_dry: '<a name='4265'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='4266'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='4267'>
<a name='4268'>
<font color=#447700>!  RECOVER<a name='4269'></font>
<a name='4270'>
   do i=ims,ime<a name='4271'>
   do k=kms,kme<a name='4272'>
   do j=jms,jme<a name='4273'>
      u_save(i,k,j)=S_u_save(i,k,j)<a name='4274'>
      v_save(i,k,j)=S_v_save(i,k,j)<a name='4275'>
      w_save(i,k,j)=S_w_save(i,k,j)<a name='4276'>
      t_save(i,k,j)=S_t_save(i,k,j)<a name='4277'>
      ph_save(i,k,j)=S_ph_save(i,k,j)<a name='4278'>
   enddo<a name='4279'>
   enddo<a name='4280'>
   enddo<a name='4281'>
   do i=ims,ime<a name='4282'>
   do j=jms,jme<a name='4283'>
      mut(i,j)=S_mut(i,j)<a name='4284'>
   enddo<a name='4285'>
   enddo<a name='4286'>
   do i=ims,ime<a name='4287'>
   do k=kms,kme<a name='4288'>
   do j=jms,jme<a name='4289'>
      ru_tend(i,k,j)=S_ru_tend(i,k,j)<a name='4290'>
      rv_tend(i,k,j)=S_rv_tend(i,k,j)<a name='4291'>
      rw_tend(i,k,j)=S_rw_tend(i,k,j)<a name='4292'>
      t_tend(i,k,j)=S_t_tend(i,k,j)<a name='4293'>
      ph_tend(i,k,j)=S_ph_tend(i,k,j)<a name='4294'>
      ru_tendf(i,k,j)=S_ru_tendf(i,k,j)<a name='4295'>
      rv_tendf(i,k,j)=S_rv_tendf(i,k,j)<a name='4296'>
      rw_tendf(i,k,j)=S_rw_tendf(i,k,j)<a name='4297'>
      t_tendf(i,k,j)=S_t_tendf(i,k,j)<a name='4298'>
      ph_tendf(i,k,j)=S_ph_tendf(i,k,j)<a name='4299'>
   enddo<a name='4300'>
   enddo<a name='4301'>
   enddo<a name='4302'>
<a name='4303'>
END SUBROUTINE t_rk_addtend_dry<a name='4304'>
<a name='4305'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='4306'></font>
<a name='4307'>
<A NAME='T_SPEC_BDY_DRY'><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_DRY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4308'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_spec_bdy_dry</font> ( config_flags,                        &amp; <A href='../../call_to/T_SPEC_BDY_DRY.html' TARGET='index'>1</A>,<A href='../../call_from/T_SPEC_BDY_DRY.html' TARGET='index'>5</A><a name='4309'>
                             ru_tend, rv_tend, ph_tend, t_tend,   &amp;<a name='4310'>
                             rw_tend, mu_tend,                    &amp;<a name='4311'>
                             u_b, v_b, ph_b, t_b,                 &amp;<a name='4312'>
                             w_b, mu_b,                           &amp;<a name='4313'>
                             u_bt, v_bt, ph_bt, t_bt,             &amp;<a name='4314'>
                             w_bt, mu_bt,                         &amp;<a name='4315'>
                             spec_bdy_width, spec_zone,           &amp;<a name='4316'>
                             ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='4317'></font>
                             ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4318'></font>
                             ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4319'></font>
                             ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4320'></font>
                             its, ite, jts, jte, kts, kte)<a name='4321'>
<a name='4322'>
   IMPLICIT NONE<a name='4323'>
<a name='4324'>
   <font color=#447700>!  Input data.<a name='4325'></font>
   TYPE( grid_config_rec_type ) config_flags<a name='4326'>
<a name='4327'>
<a name='4328'>
   INTEGER ,               INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='4329'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='4330'>
                                            ips, ipe, jps, jpe, kps, kpe, &amp;<a name='4331'>
                                            its, ite, jts, jte, kts, kte<a name='4332'>
   INTEGER ,               INTENT(IN   ) :: ijds, ijde<a name='4333'>
   INTEGER ,               INTENT(IN   ) :: spec_bdy_width, spec_zone<a name='4334'>
<a name='4335'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: ru_tend, &amp;<a name='4336'>
                                                                      rv_tend, &amp;<a name='4337'>
                                                                      ph_tend, &amp;<a name='4338'>
                                                                      rw_tend, &amp;<a name='4339'>
                                                                      t_tend<a name='4340'>
   REAL , DIMENSION( ims:ime , jms:jme  )              :: mu_tend<a name='4341'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 ), INTENT(IN   ) :: u_b,  &amp;<a name='4342'>
                                                                                 v_b,  &amp;<a name='4343'>
                                                                                 ph_b, &amp;<a name='4344'>
                                                                                  w_b, &amp;<a name='4345'>
                                                                                 t_b<a name='4346'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 )                :: u_bt, &amp;<a name='4347'>
                                                                                 v_bt, &amp;<a name='4348'>
                                                                                ph_bt, &amp;<a name='4349'>
                                                                                 w_bt, &amp;<a name='4350'>
                                                                                 t_bt<a name='4351'>
<a name='4352'>
   REAL,  DIMENSION( ijds:ijde , 1:1 ,     spec_bdy_width, 4 ), INTENT(IN   ) :: mu_b<a name='4353'>
   REAL,  DIMENSION( ijds:ijde , 1:1 ,     spec_bdy_width, 4 )                :: mu_bt<a name='4354'>
<a name='4355'>
<font color=#447700>!  IN variables<a name='4356'></font>
<a name='4357'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 )                :: S_u_bt, &amp;<a name='4358'>
                                                                                 S_v_bt, &amp;<a name='4359'>
                                                                                 S_ph_bt, &amp;<a name='4360'>
                                                                                 S_w_bt, &amp;<a name='4361'>
                                                                                 S_t_bt<a name='4362'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 )                :: P_u_bt, &amp;<a name='4363'>
                                                                                 P_v_bt, &amp;<a name='4364'>
                                                                                 P_ph_bt, &amp;<a name='4365'>
                                                                                 P_w_bt, &amp;<a name='4366'>
                                                                                 P_t_bt<a name='4367'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 )                :: B_u_bt, &amp;<a name='4368'>
                                                                                 B_v_bt, &amp;<a name='4369'>
                                                                                 B_ph_bt, &amp;<a name='4370'>
                                                                                 B_w_bt, &amp;<a name='4371'>
                                                                                 B_t_bt<a name='4372'>
<a name='4373'>
   REAL,  DIMENSION( ijds:ijde , 1:1 ,     spec_bdy_width, 4 )     :: S_mu_bt,P_mu_bt, B_mu_bt <a name='4374'>
<a name='4375'>
<font color=#447700>!  OUT variables<a name='4376'></font>
<a name='4377'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: S_ru_tend, &amp;<a name='4378'>
                                                                      S_rv_tend, &amp;<a name='4379'>
                                                                      S_ph_tend, &amp;<a name='4380'>
                                                                      S_rw_tend, &amp;<a name='4381'>
                                                                      S_t_tend<a name='4382'>
<a name='4383'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: P_ru_tend, &amp;<a name='4384'>
                                                                      P_rv_tend, &amp;<a name='4385'>
                                                                      P_ph_tend, &amp;<a name='4386'>
                                                                      P_rw_tend, &amp;<a name='4387'>
                                                                      P_t_tend<a name='4388'>
<a name='4389'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )                 :: B_ru_tend, &amp;<a name='4390'>
                                                                      B_rv_tend, &amp;<a name='4391'>
                                                                      B_ph_tend, &amp;<a name='4392'>
                                                                      B_rw_tend, &amp;<a name='4393'>
                                                                      B_t_tend<a name='4394'>
<a name='4395'>
   REAL , DIMENSION( ims:ime , jms:jme  )  :: S_mu_tend,P_mu_tend,B_mu_tend<a name='4396'>
<a name='4397'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='4398'>
   INTEGER :: NT,i,j,k,h<a name='4399'>
<a name='4400'>
   S_u_bt(:,:,:,:)=u_bt(:,:,:,:)<a name='4401'>
   S_v_bt(:,:,:,:)=v_bt(:,:,:,:)<a name='4402'>
   S_ph_bt(:,:,:,:)=ph_bt(:,:,:,:)<a name='4403'>
   S_w_bt(:,:,:,:)=w_bt(:,:,:,:)<a name='4404'>
   S_t_bt(:,:,:,:)=t_bt(:,:,:,:)<a name='4405'>
<a name='4406'>
   P_u_bt(:,:,:,:)=u_bt(:,:,:,:)<a name='4407'>
   P_v_bt(:,:,:,:)=v_bt(:,:,:,:)<a name='4408'>
   P_ph_bt(:,:,:,:)=ph_bt(:,:,:,:)<a name='4409'>
   P_w_bt(:,:,:,:)=w_bt(:,:,:,:)<a name='4410'>
   P_t_bt(:,:,:,:)=t_bt(:,:,:,:)<a name='4411'>
<a name='4412'>
   S_mu_bt(:,:,:,:)=mu_bt(:,:,:,:)<a name='4413'>
   P_mu_bt(:,:,:,:)=mu_bt(:,:,:,:)<a name='4414'>
<a name='4415'>
   S_ru_tend(:,:,:)=ru_tend(:,:,:)<a name='4416'>
   S_rv_tend(:,:,:)=rv_tend(:,:,:)<a name='4417'>
   S_rw_tend(:,:,:)=rw_tend(:,:,:)<a name='4418'>
   S_t_tend(:,:,:)=t_tend(:,:,:)<a name='4419'>
   S_ph_tend(:,:,:)=ph_tend(:,:,:)<a name='4420'>
<a name='4421'>
   P_ru_tend(:,:,:)=ru_tend(:,:,:)<a name='4422'>
   P_rv_tend(:,:,:)=rv_tend(:,:,:)<a name='4423'>
   P_rw_tend(:,:,:)=rw_tend(:,:,:)<a name='4424'>
   P_t_tend(:,:,:)=t_tend(:,:,:)<a name='4425'>
   P_ph_tend(:,:,:)=ph_tend(:,:,:)<a name='4426'>
<a name='4427'>
   S_mu_tend(:,:)=mu_tend(:,:)<a name='4428'>
   P_mu_tend(:,:)=mu_tend(:,:)<a name='4429'>
<a name='4430'>
<font color=#447700>!NLM<a name='4431'></font>
<a name='4432'>
   CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_DRY'>spec_bdy_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_DRY_1"> ( config_flags,                        &amp;<a name='4433'>
                             ru_tend, rv_tend, ph_tend, t_tend,   &amp;<a name='4434'>
                             rw_tend, mu_tend,                    &amp;<a name='4435'>
                             u_b, v_b, ph_b, t_b,                 &amp;<a name='4436'>
                             w_b, mu_b,                           &amp;<a name='4437'>
                             u_bt, v_bt, ph_bt, t_bt,             &amp;<a name='4438'>
                             w_bt, mu_bt,                         &amp;<a name='4439'>
                             spec_bdy_width, spec_zone,           &amp;<a name='4440'>
                             ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='4441'></font>
                             ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4442'></font>
                             ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4443'></font>
                             ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4444'></font>
                             its, ite, jts, jte, kts, kte)<a name='4445'>
<a name='4446'>
   B_u_bt(:,:,:,:)=u_bt(:,:,:,:)<a name='4447'>
   B_v_bt(:,:,:,:)=v_bt(:,:,:,:)<a name='4448'>
   B_ph_bt(:,:,:,:)=ph_bt(:,:,:,:)<a name='4449'>
   B_w_bt(:,:,:,:)=w_bt(:,:,:,:)<a name='4450'>
   B_t_bt(:,:,:,:)=t_bt(:,:,:,:)<a name='4451'>
   B_mu_bt(:,:,:,:)=mu_bt(:,:,:,:)<a name='4452'>
<a name='4453'>
   B_ru_tend(:,:,:)=ru_tend(:,:,:)<a name='4454'>
   B_rv_tend(:,:,:)=rv_tend(:,:,:)<a name='4455'>
   B_rw_tend(:,:,:)=rw_tend(:,:,:)<a name='4456'>
   B_t_tend(:,:,:)=t_tend(:,:,:)<a name='4457'>
   B_ph_tend(:,:,:)=ph_tend(:,:,:)<a name='4458'>
<a name='4459'>
   B_mu_tend(:,:)=mu_tend(:,:)<a name='4460'>
<a name='4461'>
<font color=#447700>!  TCL<a name='4462'></font>
<a name='4463'>
   u_bt(:,:,:,:)=S_u_bt(:,:,:,:)<a name='4464'>
   v_bt(:,:,:,:)=S_v_bt(:,:,:,:)<a name='4465'>
   ph_bt(:,:,:,:)=S_ph_bt(:,:,:,:)<a name='4466'>
   w_bt(:,:,:,:)=S_w_bt(:,:,:,:)<a name='4467'>
   t_bt(:,:,:,:)=S_t_bt(:,:,:,:)<a name='4468'>
   mu_bt(:,:,:,:)=S_mu_bt(:,:,:,:)<a name='4469'>
<a name='4470'>
   rv_tend(:,:,:)=S_rv_tend(:,:,:)<a name='4471'>
   rw_tend(:,:,:)=S_rw_tend(:,:,:)<a name='4472'>
   t_tend(:,:,:)=S_t_tend(:,:,:)<a name='4473'>
   ph_tend(:,:,:)=S_ph_tend(:,:,:)<a name='4474'>
   mu_tend(:,:)=S_mu_tend(:,:)<a name='4475'>
<a name='4476'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_tl.F.html#G_SPEC_BDY_DRY'>g_spec_bdy_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SPEC_BDY_DRY_1">( config_flags, ru_tend, P_ru_tend, rv_tend, P_rv_tend, ph_tend, P_ph_tend, t_tend, P_t_tend, rw_tend, &amp;<a name='4477'>
&amp;P_rw_tend, mu_tend, P_mu_tend, u_bt, P_u_bt, v_bt, P_v_bt, ph_bt, P_ph_bt, t_bt, P_t_bt, w_bt, P_w_bt, mu_bt, P_mu_bt, &amp;<a name='4478'>
&amp;spec_bdy_width, spec_zone, ijds, ijde, ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='4479'>
<a name='4480'>
   SAVE_L = sum(P_u_bt(:,:,:,:)*P_u_bt(:,:,:,:))+  &amp;<a name='4481'>
            sum(P_v_bt(:,:,:,:)*P_v_bt(:,:,:,:))+  &amp;<a name='4482'>
            sum(P_ph_bt(:,:,:,:)*P_ph_bt(:,:,:,:))+ &amp;<a name='4483'>
            sum(P_w_bt(:,:,:,:)*P_w_bt(:,:,:,:))+ &amp;<a name='4484'>
            sum(P_t_bt(:,:,:,:)*P_t_bt(:,:,:,:))+ &amp;<a name='4485'>
            sum(P_mu_bt(:,:,:,:)*P_mu_bt(:,:,:,:))<a name='4486'>
<a name='4487'>
   SAVE_L=SAVE_L + sum(P_ru_tend(:,:,:)*P_ru_tend(:,:,:))+   &amp;<a name='4488'>
                   sum(P_rv_tend(:,:,:)*P_rv_tend(:,:,:))+   &amp;<a name='4489'>
                   sum(P_rw_tend(:,:,:)*P_rw_tend(:,:,:))+   &amp;<a name='4490'>
                   sum(P_t_tend(:,:,:)*P_t_tend(:,:,:))+     &amp;<a name='4491'>
                   sum(P_ph_tend(:,:,:)*P_ph_tend(:,:,:))+   &amp;<a name='4492'>
                   sum(P_mu_tend(:,:)*P_mu_tend(:,:))<a name='4493'>
<a name='4494'>
#ifdef DM_PARALLEL<a name='4495'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='4496'>
                       comm, IERROR )<a name='4497'>
   SAVE_L = nsum <a name='4498'>
#endif<a name='4499'>
<a name='4500'>
   ALPHA=1.<a name='4501'>
   DO NT=1,11<a name='4502'>
      ALPHA=0.1*ALPHA<a name='4503'>
      FACTOR=1.+ALPHA<a name='4504'>
      P_u_bt(:,:,:,:)=FACTOR*S_u_bt(:,:,:,:)<a name='4505'>
      P_v_bt(:,:,:,:)=FACTOR*S_v_bt(:,:,:,:)<a name='4506'>
      P_ph_bt(:,:,:,:)=FACTOR*S_ph_bt(:,:,:,:)<a name='4507'>
      P_w_bt(:,:,:,:)=FACTOR*S_w_bt(:,:,:,:)<a name='4508'>
      P_t_bt(:,:,:,:)=FACTOR*S_t_bt(:,:,:,:)<a name='4509'>
<a name='4510'>
      P_mu_bt(:,:,:,:)=FACTOR*S_mu_bt(:,:,:,:)<a name='4511'>
<a name='4512'>
      P_ru_tend(:,:,:)=FACTOR*S_ru_tend(:,:,:)<a name='4513'>
      P_rv_tend(:,:,:)=FACTOR*S_rv_tend(:,:,:)<a name='4514'>
      P_rw_tend(:,:,:)=FACTOR*S_rw_tend(:,:,:)<a name='4515'>
      P_t_tend(:,:,:)=FACTOR*S_t_tend(:,:,:)<a name='4516'>
      P_ph_tend(:,:,:)=FACTOR*S_ph_tend(:,:,:)<a name='4517'>
<a name='4518'>
      P_mu_tend(:,:)=FACTOR*S_mu_tend(:,:)<a name='4519'>
<a name='4520'>
      CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_DRY'>spec_bdy_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_DRY_2"> ( config_flags,                        &amp;<a name='4521'>
                             P_ru_tend, P_rv_tend, P_ph_tend, P_t_tend,   &amp;<a name='4522'>
                             P_rw_tend, P_mu_tend,                    &amp;<a name='4523'>
                             u_b, v_b, ph_b, t_b,                 &amp;<a name='4524'>
                             w_b, mu_b,                           &amp;<a name='4525'>
                             P_u_bt, P_v_bt, P_ph_bt, P_t_bt,             &amp;<a name='4526'>
                             P_w_bt, P_mu_bt,                         &amp;<a name='4527'>
                             spec_bdy_width, spec_zone,           &amp;<a name='4528'>
                             ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='4529'></font>
                             ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4530'></font>
                             ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4531'></font>
                             ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4532'></font>
                             its, ite, jts, jte, kts, kte)<a name='4533'>
<a name='4534'>
      VAL_N=sum((P_u_bt(:,:,:,:)-B_u_bt(:,:,:,:))*(P_u_bt(:,:,:,:)-B_u_bt(:,:,:,:))) + &amp;<a name='4535'>
            sum((P_v_bt(:,:,:,:)-B_v_bt(:,:,:,:))*(P_v_bt(:,:,:,:)-B_v_bt(:,:,:,:)))+ &amp;<a name='4536'>
            sum((P_ph_bt(:,:,:,:)-B_ph_bt(:,:,:,:))*(P_ph_bt(:,:,:,:)-B_ph_bt(:,:,:,:)))+ &amp;<a name='4537'>
            sum((P_w_bt(:,:,:,:)-B_w_bt(:,:,:,:))*(P_w_bt(:,:,:,:)-B_w_bt(:,:,:,:)))+   &amp;<a name='4538'>
            sum((P_t_bt(:,:,:,:)-B_t_bt(:,:,:,:))*(P_t_bt(:,:,:,:)-B_t_bt(:,:,:,:)))+ &amp;<a name='4539'>
            sum((P_mu_bt(:,:,:,:)-B_mu_bt(:,:,:,:))*(P_mu_bt(:,:,:,:)-B_mu_bt(:,:,:,:)))<a name='4540'>
<a name='4541'>
      VAL_N=VAL_N + sum((P_ru_tend(:,:,:)-B_ru_tend(:,:,:))*(P_ru_tend(:,:,:)-B_ru_tend(:,:,:)))+  &amp;<a name='4542'>
                    sum((P_rv_tend(:,:,:)-B_rv_tend(:,:,:))*(P_rv_tend(:,:,:)-B_rv_tend(:,:,:)))+  &amp;<a name='4543'>
                    sum((P_rw_tend(:,:,:)-B_rw_tend(:,:,:))*(P_rw_tend(:,:,:)-B_rw_tend(:,:,:)))+  &amp;<a name='4544'>
                    sum((P_t_tend(:,:,:)-B_t_tend(:,:,:))*(P_t_tend(:,:,:)-B_t_tend(:,:,:)))+      &amp;<a name='4545'>
                    sum((P_ph_tend(:,:,:)-B_ph_tend(:,:,:))*(P_ph_tend(:,:,:)-B_ph_tend(:,:,:)))+  &amp;<a name='4546'>
                    sum((P_mu_tend(:,:)-B_mu_tend(:,:))*(P_mu_tend(:,:)-B_mu_tend(:,:)))<a name='4547'>
<a name='4548'>
#ifdef DM_PARALLEL<a name='4549'>
      call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='4550'>
                          comm, IERROR )<a name='4551'>
      VAL_N = nsum <a name='4552'>
#endif<a name='4553'>
<a name='4554'>
      VAL_L=SAVE_L*ALPHA**2<a name='4555'>
      COEF=VAL_N/VAL_L<a name='4556'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='4557'>
         'g_spec_bdy_dry: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='4558'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='4559'>
   ENDDO<a name='4560'>
<a name='4561'>
<font color=#447700>!  ADJ test<a name='4562'></font>
<a name='4563'>
   FACTOR=0.1<a name='4564'>
   u_bt(:,:,:,:)=S_u_bt(:,:,:,:)<a name='4565'>
   v_bt(:,:,:,:)=S_v_bt(:,:,:,:)<a name='4566'>
   ph_bt(:,:,:,:)=S_ph_bt(:,:,:,:)<a name='4567'>
   w_bt(:,:,:,:)=S_w_bt(:,:,:,:)<a name='4568'>
   t_bt(:,:,:,:)=S_t_bt(:,:,:,:)<a name='4569'>
<a name='4570'>
   P_u_bt(:,:,:,:)=FACTOR*S_u_bt(:,:,:,:)<a name='4571'>
   P_v_bt(:,:,:,:)=FACTOR*S_v_bt(:,:,:,:)<a name='4572'>
   P_ph_bt(:,:,:,:)=FACTOR*S_ph_bt(:,:,:,:)<a name='4573'>
   P_w_bt(:,:,:,:)=FACTOR*S_w_bt(:,:,:,:)<a name='4574'>
   P_t_bt(:,:,:,:)=FACTOR*S_t_bt(:,:,:,:)<a name='4575'>
<a name='4576'>
   B_u_bt(:,:,:,:)=P_u_bt(:,:,:,:)<a name='4577'>
   B_v_bt(:,:,:,:)=P_v_bt(:,:,:,:)<a name='4578'>
   B_ph_bt(:,:,:,:)=P_ph_bt(:,:,:,:)<a name='4579'>
   B_w_bt(:,:,:,:)=P_w_bt(:,:,:,:)<a name='4580'>
   B_t_bt(:,:,:,:)=P_t_bt(:,:,:,:)<a name='4581'>
<a name='4582'>
   mu_bt(:,:,:,:)=S_mu_bt(:,:,:,:)<a name='4583'>
   P_mu_bt(:,:,:,:)=FACTOR*S_mu_bt(:,:,:,:)<a name='4584'>
   B_mu_bt(:,:,:,:)=P_mu_bt(:,:,:,:)<a name='4585'>
<a name='4586'>
   ru_tend(:,:,:)=S_ru_tend(:,:,:)<a name='4587'>
   rv_tend(:,:,:)=S_rv_tend(:,:,:)<a name='4588'>
   rw_tend(:,:,:)=S_rw_tend(:,:,:)<a name='4589'>
   t_tend(:,:,:)=S_t_tend(:,:,:)<a name='4590'>
   ph_tend(:,:,:)=S_ph_tend(:,:,:)<a name='4591'>
<a name='4592'>
   P_ru_tend(:,:,:)=FACTOR*S_ru_tend(:,:,:)<a name='4593'>
   P_rv_tend(:,:,:)=FACTOR*S_rv_tend(:,:,:)<a name='4594'>
   P_rw_tend(:,:,:)=FACTOR*S_rw_tend(:,:,:)<a name='4595'>
   P_t_tend(:,:,:)=FACTOR*S_t_tend(:,:,:)<a name='4596'>
   P_ph_tend(:,:,:)=FACTOR*S_ph_tend(:,:,:)<a name='4597'>
<a name='4598'>
   B_ru_tend(:,:,:)=P_ru_tend(:,:,:)<a name='4599'>
   B_rv_tend(:,:,:)=P_rv_tend(:,:,:)<a name='4600'>
   B_rw_tend(:,:,:)=P_rw_tend(:,:,:)<a name='4601'>
   B_t_tend(:,:,:)=P_t_tend(:,:,:)<a name='4602'>
   B_ph_tend(:,:,:)=P_ph_tend(:,:,:)<a name='4603'>
<a name='4604'>
   mu_tend(:,:)=S_mu_tend(:,:)<a name='4605'>
   P_mu_tend(:,:)=FACTOR*S_mu_tend(:,:)<a name='4606'>
   B_mu_tend(:,:)=P_mu_tend(:,:)<a name='4607'>
<a name='4608'>
<font color=#447700>!  TGL<a name='4609'></font>
<a name='4610'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_tl.F.html#G_SPEC_BDY_DRY'>g_spec_bdy_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SPEC_BDY_DRY_2">( config_flags, ru_tend, P_ru_tend, rv_tend, P_rv_tend, ph_tend, P_ph_tend, t_tend, P_t_tend, rw_tend, &amp;<a name='4611'>
&amp;P_rw_tend, mu_tend, P_mu_tend, u_bt, P_u_bt, v_bt, P_v_bt, ph_bt, P_ph_bt, t_bt, P_t_bt, w_bt, P_w_bt, mu_bt, P_mu_bt, &amp;<a name='4612'>
&amp;spec_bdy_width, spec_zone, ijds, ijde, ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='4613'>
<a name='4614'>
   VAL_L=sum(P_ru_tend(:,:,:)*P_ru_tend(:,:,:))+   &amp;<a name='4615'>
         sum(P_rv_tend(:,:,:)*P_rv_tend(:,:,:))+   &amp;<a name='4616'>
         sum(P_rw_tend(:,:,:)*P_rw_tend(:,:,:))+   &amp;<a name='4617'>
         sum(P_t_tend(:,:,:)*P_t_tend(:,:,:))+     &amp;<a name='4618'>
         sum(P_ph_tend(:,:,:)*P_ph_tend(:,:,:))+   &amp;<a name='4619'>
         sum(P_mu_tend(:,:)*P_mu_tend(:,:))<a name='4620'>
   VAL_L=VAL_L+sum(P_u_bt(:,:,:,:)*P_u_bt(:,:,:,:))+ &amp;<a name='4621'>
               sum(P_v_bt(:,:,:,:)*P_v_bt(:,:,:,:))+ &amp;<a name='4622'>
               sum(P_ph_bt(:,:,:,:)*P_ph_bt(:,:,:,:))+ &amp;<a name='4623'>
               sum(P_w_bt(:,:,:,:)*P_w_bt(:,:,:,:))+ &amp;<a name='4624'>
               sum(P_t_bt(:,:,:,:)*P_t_bt(:,:,:,:))+ &amp;<a name='4625'>
               sum(P_mu_bt(:,:,:,:)*P_mu_bt(:,:,:,:))<a name='4626'>
<a name='4627'>
#ifdef DM_PARALLEL<a name='4628'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='4629'>
                       comm, IERROR )<a name='4630'>
   VAL_L = nsum <a name='4631'>
#endif<a name='4632'>
<a name='4633'>
<font color=#447700>!  ADJ<a name='4634'></font>
<a name='4635'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_ad.F.html#A_SPEC_BDY_DRY'>a_spec_bdy_dry</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_DRY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_SPEC_BDY_DRY_1">( config_flags, P_ru_tend, P_rv_tend, P_ph_tend, P_t_tend, P_rw_tend, P_mu_tend, P_u_bt, P_v_bt, P_ph_bt, &amp;<a name='4636'>
&amp;P_t_bt, P_w_bt, P_mu_bt, spec_bdy_width, spec_zone, ijds, ijde, ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, &amp;<a name='4637'>
&amp;ite, jts, jte, kts, kte )<a name='4638'>
<a name='4639'>
   VAL_A=sum(P_u_bt(:,:,:,:)*B_u_bt(:,:,:,:))+       &amp;<a name='4640'>
         sum(P_v_bt(:,:,:,:)*B_v_bt(:,:,:,:))+       &amp;<a name='4641'>
         sum(P_ph_bt(:,:,:,:)*B_ph_bt(:,:,:,:))+       &amp;<a name='4642'>
         sum(P_w_bt(:,:,:,:)*B_w_bt(:,:,:,:))+       &amp;<a name='4643'>
         sum(P_t_bt(:,:,:,:)*B_t_bt(:,:,:,:))+       &amp;<a name='4644'>
         sum(P_mu_bt(:,:,:,:)*B_mu_bt(:,:,:,:))<a name='4645'>
   VAL_A=VAL_A+sum(P_ru_tend(:,:,:)*B_ru_tend(:,:,:))+ &amp;<a name='4646'>
               sum(P_rv_tend(:,:,:)*B_rv_tend(:,:,:))+ &amp;<a name='4647'>
               sum(P_rw_tend(:,:,:)*B_rw_tend(:,:,:))+ &amp;<a name='4648'>
               sum(P_t_tend(:,:,:)*B_t_tend(:,:,:))+   &amp;<a name='4649'>
               sum(P_ph_tend(:,:,:)*B_ph_tend(:,:,:))+  &amp;<a name='4650'>
               sum(P_mu_tend(:,:)*B_mu_tend(:,:))<a name='4651'>
<a name='4652'>
#ifdef DM_PARALLEL<a name='4653'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='4654'>
                       comm, IERROR )<a name='4655'>
   VAL_A = nsum <a name='4656'>
#endif<a name='4657'>
<a name='4658'>
   print*, '                '<a name='4659'>
   write(6,*) 'a_spec_bdy_dry: '<a name='4660'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='4661'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='4662'>
<a name='4663'>
<font color=#447700>!  RECOVER<a name='4664'></font>
<a name='4665'>
   u_bt(:,:,:,:)=S_u_bt(:,:,:,:)<a name='4666'>
   v_bt(:,:,:,:)=S_v_bt(:,:,:,:)<a name='4667'>
   ph_bt(:,:,:,:)=S_ph_bt(:,:,:,:)<a name='4668'>
   w_bt(:,:,:,:)=S_w_bt(:,:,:,:)<a name='4669'>
   t_bt(:,:,:,:)=S_t_bt(:,:,:,:)<a name='4670'>
<a name='4671'>
   mu_bt(:,:,:,:)=S_mu_bt(:,:,:,:)<a name='4672'>
<a name='4673'>
   ru_tend(:,:,:)=S_ru_tend(:,:,:)<a name='4674'>
   rv_tend(:,:,:)=S_rv_tend(:,:,:)<a name='4675'>
   rw_tend(:,:,:)=S_rw_tend(:,:,:)<a name='4676'>
   t_tend(:,:,:)=S_t_tend(:,:,:)<a name='4677'>
   ph_tend(:,:,:)=S_ph_tend(:,:,:)<a name='4678'>
<a name='4679'>
   mu_tend(:,:)=S_mu_tend(:,:)<a name='4680'>
<a name='4681'>
END SUBROUTINE t_spec_bdy_dry<a name='4682'>
<a name='4683'>
<font color=#447700>!----------------------------------------------------------------------------------------------<a name='4684'></font>
<a name='4685'>
<A NAME='T_SMALL_STEP_PREP'><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_PREP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4686'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_small_step_prep</font>( u_1, u_2, v_1, v_2, w_1, w_2, &amp; <A href='../../call_to/T_SMALL_STEP_PREP.html' TARGET='index'>1</A>,<A href='../../call_from/T_SMALL_STEP_PREP.html' TARGET='index'>5</A><a name='4687'>
                            t_1, t_2, ph_1, ph_2,         &amp;<a name='4688'>
                            mub, mu_1, mu_2,              &amp;<a name='4689'>
                            muu, muus, muv, muvs,         &amp;<a name='4690'>
                            mut, muts, mudf,              &amp;<a name='4691'>
                            u_save, v_save, w_save,       &amp;<a name='4692'>
                            t_save, ph_save, mu_save,     &amp;<a name='4693'>
                            ww, ww_save,                  &amp;<a name='4694'>
                            dnw, c2a, pb, p, alt,         &amp;<a name='4695'>
                            msfu, msfv, msft,             &amp;<a name='4696'>
                            rk_step, leapfrog,            &amp;<a name='4697'>
                            ids,ide, jds,jde, kds,kde,    &amp;<a name='4698'>
                            ims,ime, jms,jme, kms,kme,    &amp;<a name='4699'>
                            its,ite, jts,jte, kts,kte    )<a name='4700'>
<a name='4701'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='4702'></font>
<a name='4703'>
<font color=#447700>! declarations for the stuff coming in<a name='4704'></font>
<a name='4705'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='4706'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='4707'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='4708'>
<a name='4709'>
  INTEGER,      INTENT(IN   )    :: rk_step<a name='4710'>
<a name='4711'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT) :: u_1,   &amp;<a name='4712'>
                                                              v_1,   &amp;<a name='4713'>
                                                              w_1,   &amp;<a name='4714'>
                                                              t_1,   &amp;<a name='4715'>
                                                              ph_1<a name='4716'>
<a name='4717'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(  OUT) :: u_save,   &amp;<a name='4718'>
                                                              v_save,   &amp;<a name='4719'>
                                                              w_save,   &amp;<a name='4720'>
                                                              t_save,   &amp;<a name='4721'>
                                                              ph_save<a name='4722'>
<a name='4723'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT) :: u_2,   &amp;<a name='4724'>
                                                              v_2,   &amp;<a name='4725'>
                                                              w_2,   &amp;<a name='4726'>
                                                              t_2,   &amp;<a name='4727'>
                                                              ph_2<a name='4728'>
<a name='4729'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(  OUT) :: c2a, &amp;<a name='4730'>
                                                               ww_save<a name='4731'>
<a name='4732'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)                ::  pb,  &amp;<a name='4733'>
                                                                p,   &amp;<a name='4734'>
                                                                alt, &amp;<a name='4735'>
                                                                ww<a name='4736'>
<a name='4737'>
<font color=#447700>! pjj/cray<a name='4738'></font>
<font color=#447700>! REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(INOUT) :: mu_1<a name='4739'></font>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(INOUT) :: mu_1,mu_2<a name='4740'>
<a name='4741'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(INout) :: mub,  &amp;<a name='4742'>
                                                               muu,  &amp;<a name='4743'>
                                                               muv,  &amp;<a name='4744'>
                                                               mut,  &amp;<a name='4745'>
                                                               msfu, &amp;<a name='4746'>
                                                               msfv, &amp;<a name='4747'>
                                                               msft<a name='4748'>
<a name='4749'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(  OUT) :: muus, &amp;<a name='4750'>
                                                               muvs, &amp;<a name='4751'>
                                                               muts, &amp;<a name='4752'>
<font color=#447700>!pjj/cray<a name='4753'></font>
<font color=#447700>!                                                              mu_2, &amp;<a name='4754'></font>
                                                               mudf<a name='4755'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(  OUT) :: mu_save<a name='4756'>
<a name='4757'>
  REAL, DIMENSION(kms:kme, jms:jme)         , INTENT(IN   ) :: dnw<a name='4758'>
<a name='4759'>
  LOGICAL, INTENT(IN   ) :: leapfrog<a name='4760'>
<a name='4761'>
<font color=#447700>! local variables<a name='4762'></font>
<a name='4763'>
  INTEGER :: i, j, k<a name='4764'>
  INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='4765'>
  INTEGER :: i_endu, j_endv<a name='4766'>
<a name='4767'>
<font color=#447700>!  IN variables<a name='4768'></font>
<a name='4769'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)                ::  S_p,   &amp;<a name='4770'>
                                                                S_alt, &amp;<a name='4771'>
                                                                S_ww<a name='4772'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)                ::  P_p,   &amp;<a name='4773'>
                                                                P_alt, &amp;<a name='4774'>
                                                                P_ww<a name='4775'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)                ::  B_p,   &amp;<a name='4776'>
                                                                B_alt, &amp;<a name='4777'>
                                                                B_ww<a name='4778'>
<a name='4779'>
<font color=#447700>! INOUT variables<a name='4780'></font>
<a name='4781'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)               :: S_u_1,   &amp;<a name='4782'>
                                                              S_v_1,   &amp;<a name='4783'>
                                                              S_w_1,   &amp;<a name='4784'>
                                                              S_t_1,   &amp;<a name='4785'>
                                                              S_ph_1,  &amp;<a name='4786'>
                                                              S_u_2,   &amp;<a name='4787'>
                                                              S_v_2,   &amp;<a name='4788'>
                                                              S_w_2,   &amp;<a name='4789'>
                                                              S_t_2,   &amp;<a name='4790'>
                                                              S_ph_2<a name='4791'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)               :: P_u_1,   &amp;<a name='4792'>
                                                              P_v_1,   &amp;<a name='4793'>
                                                              P_w_1,   &amp;<a name='4794'>
                                                              P_t_1,   &amp;<a name='4795'>
                                                              P_ph_1,  &amp;<a name='4796'>
                                                              P_u_2,   &amp;<a name='4797'>
                                                              P_v_2,   &amp;<a name='4798'>
                                                              P_w_2,   &amp;<a name='4799'>
                                                              P_t_2,   &amp;<a name='4800'>
                                                              P_ph_2<a name='4801'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)               :: B_u_1,   &amp;<a name='4802'>
                                                              B_v_1,   &amp;<a name='4803'>
                                                              B_w_1,   &amp;<a name='4804'>
                                                              B_t_1,   &amp;<a name='4805'>
                                                              B_ph_1,  &amp;<a name='4806'>
                                                              B_u_2,   &amp;<a name='4807'>
                                                              B_v_2,   &amp;<a name='4808'>
                                                              B_w_2,   &amp;<a name='4809'>
                                                              B_t_2,   &amp;<a name='4810'>
                                                              B_ph_2<a name='4811'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)               :: K_u_1,   &amp;<a name='4812'>
                                                              K_v_1,   &amp;<a name='4813'>
                                                              K_w_1,   &amp;<a name='4814'>
                                                              K_t_1,   &amp;<a name='4815'>
                                                              K_ph_1,  &amp;<a name='4816'>
                                                              K_u_2,   &amp;<a name='4817'>
                                                              K_v_2,   &amp;<a name='4818'>
                                                              K_w_2,   &amp;<a name='4819'>
                                                              K_t_2,   &amp;<a name='4820'>
                                                              K_ph_2<a name='4821'>
<a name='4822'>
<a name='4823'>
  REAL, DIMENSION(ims:ime, jms:jme)                         :: S_mu_1, &amp;<a name='4824'>
                                                               S_mu_2, &amp;<a name='4825'>
                                                               S_muu,  &amp;<a name='4826'>
                                                               S_muv,  &amp;<a name='4827'>
                                                               S_mut<a name='4828'>
  REAL, DIMENSION(ims:ime, jms:jme)                         :: P_mu_1, &amp;<a name='4829'>
                                                               P_mu_2, &amp;<a name='4830'>
                                                               P_muu,  &amp;<a name='4831'>
                                                               P_muv,  &amp;<a name='4832'>
                                                               P_mut<a name='4833'>
  REAL, DIMENSION(ims:ime, jms:jme)                         :: B_mu_1, &amp;<a name='4834'>
                                                               B_mu_2, &amp;<a name='4835'>
                                                               B_muu,  &amp;<a name='4836'>
                                                               B_muv,  &amp;<a name='4837'>
                                                               B_mut<a name='4838'>
  REAL, DIMENSION(ims:ime, jms:jme)                         :: K_mu_1, &amp;<a name='4839'>
                                                               K_mu_2, &amp;<a name='4840'>
                                                               K_muu,  &amp;<a name='4841'>
                                                               K_muv,  &amp;<a name='4842'>
                                                               K_mut<a name='4843'>
<font color=#447700>! OUT variables<a name='4844'></font>
<a name='4845'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)               :: P_u_save,   &amp;<a name='4846'>
                                                              P_v_save,   &amp;<a name='4847'>
                                                              P_w_save,   &amp;<a name='4848'>
                                                              P_t_save,   &amp;<a name='4849'>
                                                              P_ph_save,  &amp;<a name='4850'>
                                                              P_c2a,      &amp;<a name='4851'>
                                                              P_ww_save<a name='4852'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)               :: B_u_save,   &amp;<a name='4853'>
                                                              B_v_save,   &amp;<a name='4854'>
                                                              B_w_save,   &amp;<a name='4855'>
                                                              B_t_save,   &amp;<a name='4856'>
                                                              B_ph_save,  &amp;<a name='4857'>
                                                              B_c2a,      &amp;<a name='4858'>
                                                              B_ww_save<a name='4859'>
<a name='4860'>
  REAL, DIMENSION(ims:ime, jms:jme)                         :: P_muus, &amp;<a name='4861'>
                                                               P_muvs, &amp;<a name='4862'>
                                                               P_muts, &amp;<a name='4863'>
                                                               P_mu_save ,&amp;<a name='4864'>
                                                               P_mudf<a name='4865'>
  REAL, DIMENSION(ims:ime, jms:jme)                         :: B_muus, &amp;<a name='4866'>
                                                               B_muvs, &amp;<a name='4867'>
                                                               B_muts, &amp;<a name='4868'>
                                                               B_mu_save ,&amp;<a name='4869'>
                                                               B_mudf<a name='4870'>
<a name='4871'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='4872'>
   INTEGER :: NT<a name='4873'>
<a name='4874'>
<font color=#447700>!TGL test<a name='4875'></font>
<a name='4876'>
   do i=ims,ime<a name='4877'>
   do k=kms,kme<a name='4878'>
   do j=jms,jme<a name='4879'>
      S_p(i,k,j)=p(i,k,j)<a name='4880'>
      S_alt(i,k,j)=alt(i,k,j)<a name='4881'>
      S_ww(i,k,j)=ww(i,k,j)<a name='4882'>
<a name='4883'>
      P_p(i,k,j)=p(i,k,j)<a name='4884'>
      P_alt(i,k,j)=alt(i,k,j)<a name='4885'>
      P_ww(i,k,j)=ww(i,k,j)<a name='4886'>
   enddo<a name='4887'>
   enddo<a name='4888'>
   enddo<a name='4889'>
   do i=ims,ime<a name='4890'>
   do k=kms,kme<a name='4891'>
   do j=jms,jme<a name='4892'>
      S_u_1(i,k,j)=u_1(i,k,j)<a name='4893'>
      S_v_1(i,k,j)=v_1(i,k,j)<a name='4894'>
      S_w_1(i,k,j)=w_1(i,k,j)<a name='4895'>
      S_t_1(i,k,j)=t_1(i,k,j)<a name='4896'>
      S_ph_1(i,k,j)=ph_1(i,k,j)<a name='4897'>
      S_u_2(i,k,j)=u_2(i,k,j)<a name='4898'>
      S_v_2(i,k,j)=v_2(i,k,j)<a name='4899'>
      S_w_2(i,k,j)=w_2(i,k,j)<a name='4900'>
      S_t_2(i,k,j)=t_2(i,k,j)<a name='4901'>
      S_ph_2(i,k,j)=ph_2(i,k,j)<a name='4902'>
<a name='4903'>
      P_u_1(i,k,j)=u_1(i,k,j)<a name='4904'>
      P_v_1(i,k,j)=v_1(i,k,j)<a name='4905'>
      P_w_1(i,k,j)=w_1(i,k,j)<a name='4906'>
      P_t_1(i,k,j)=t_1(i,k,j)<a name='4907'>
      P_ph_1(i,k,j)=ph_1(i,k,j)<a name='4908'>
      P_u_2(i,k,j)=u_2(i,k,j)<a name='4909'>
      P_v_2(i,k,j)=v_2(i,k,j)<a name='4910'>
      P_w_2(i,k,j)=w_2(i,k,j)<a name='4911'>
      P_t_2(i,k,j)=t_2(i,k,j)<a name='4912'>
      P_ph_2(i,k,j)=ph_2(i,k,j)<a name='4913'>
<a name='4914'>
      K_u_1(i,k,j)=u_1(i,k,j)<a name='4915'>
      K_v_1(i,k,j)=v_1(i,k,j)<a name='4916'>
      K_w_1(i,k,j)=w_1(i,k,j)<a name='4917'>
      K_t_1(i,k,j)=t_1(i,k,j)<a name='4918'>
      K_ph_1(i,k,j)=ph_1(i,k,j)<a name='4919'>
      K_u_2(i,k,j)=u_2(i,k,j)<a name='4920'>
      K_v_2(i,k,j)=v_2(i,k,j)<a name='4921'>
      K_w_2(i,k,j)=w_2(i,k,j)<a name='4922'>
      K_t_2(i,k,j)=t_2(i,k,j)<a name='4923'>
      K_ph_2(i,k,j)=ph_2(i,k,j)<a name='4924'>
   enddo<a name='4925'>
   enddo<a name='4926'>
   enddo<a name='4927'>
   do i=ims,ime<a name='4928'>
   do j=jms,jme<a name='4929'>
      S_mu_1(i,j)=mu_1(i,j)<a name='4930'>
      S_mu_2(i,j)=mu_2(i,j)<a name='4931'>
      S_mut(i,j)=mut(i,j)<a name='4932'>
      S_muu(i,j)=muu(i,j)<a name='4933'>
      S_muv(i,j)=muv(i,j)<a name='4934'>
<a name='4935'>
      P_mu_1(i,j)=mu_1(i,j)<a name='4936'>
      P_mu_2(i,j)=mu_2(i,j)<a name='4937'>
      P_mut(i,j)=mut(i,j)<a name='4938'>
      P_muu(i,j)=muu(i,j)<a name='4939'>
      P_muv(i,j)=muv(i,j)<a name='4940'>
<a name='4941'>
      K_mu_1(i,j)=mu_1(i,j)<a name='4942'>
      K_mu_2(i,j)=mu_2(i,j)<a name='4943'>
      K_mut(i,j)=mut(i,j)<a name='4944'>
      K_muu(i,j)=muu(i,j)<a name='4945'>
      K_muv(i,j)=muv(i,j)<a name='4946'>
<a name='4947'>
   enddo<a name='4948'>
   enddo<a name='4949'>
<a name='4950'>
<font color=#447700>!NLM<a name='4951'></font>
<a name='4952'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_PREP'>small_step_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMALL_STEP_PREP_1">( u_1, u_2, v_1, v_2, w_1, w_2, &amp;<a name='4953'>
                            t_1, t_2, ph_1, ph_2,         &amp;<a name='4954'>
                            mub, mu_1, mu_2,              &amp;<a name='4955'>
                            muu, muus, muv, muvs,         &amp;<a name='4956'>
                            mut, muts, mudf,              &amp;<a name='4957'>
                            u_save, v_save, w_save,       &amp;<a name='4958'>
                            t_save, ph_save, mu_save,     &amp;<a name='4959'>
                            ww, ww_save,                  &amp;<a name='4960'>
                            dnw, c2a, pb, p, alt,         &amp;<a name='4961'>
                            msfu, msfv, msft,             &amp;<a name='4962'>
                            rk_step, leapfrog,            &amp;<a name='4963'>
                            ids,ide, jds,jde, kds,kde,    &amp;<a name='4964'>
                            ims,ime, jms,jme, kms,kme,    &amp;<a name='4965'>
                            its,ite, jts,jte, kts,kte    )<a name='4966'>
<a name='4967'>
   do i=its,ite<a name='4968'>
   do k=kts,kte<a name='4969'>
   do j=jts,jte<a name='4970'>
      B_u_1(i,k,j)=u_1(i,k,j)<a name='4971'>
      B_v_1(i,k,j)=v_1(i,k,j)<a name='4972'>
      B_w_1(i,k,j)=w_1(i,k,j)<a name='4973'>
      B_t_1(i,k,j)=t_1(i,k,j)<a name='4974'>
      B_ph_1(i,k,j)=ph_1(i,k,j)<a name='4975'>
      B_u_2(i,k,j)=u_2(i,k,j)<a name='4976'>
      B_v_2(i,k,j)=v_2(i,k,j)<a name='4977'>
      B_w_2(i,k,j)=w_2(i,k,j)<a name='4978'>
      B_t_2(i,k,j)=t_2(i,k,j)<a name='4979'>
      B_ph_2(i,k,j)=ph_2(i,k,j)<a name='4980'>
   enddo<a name='4981'>
   enddo<a name='4982'>
   enddo<a name='4983'>
   do i=its,ite<a name='4984'>
   do j=jts,jte<a name='4985'>
      B_mu_1(i,j)=mu_1(i,j)<a name='4986'>
      B_mu_2(i,j)=mu_2(i,j)<a name='4987'>
      B_mut(i,j)=mut(i,j)<a name='4988'>
      B_muu(i,j)=muu(i,j)<a name='4989'>
      B_muv(i,j)=muv(i,j)<a name='4990'>
   enddo<a name='4991'>
   enddo<a name='4992'>
<a name='4993'>
   do i=its,ite<a name='4994'>
   do k=kts,kte<a name='4995'>
   do j=jts,jte<a name='4996'>
      B_u_save(i,k,j)=u_save(i,k,j)<a name='4997'>
      B_v_save(i,k,j)=v_save(i,k,j)<a name='4998'>
      B_w_save(i,k,j)=w_save(i,k,j)<a name='4999'>
      B_ph_save(i,k,j)=ph_save(i,k,j)<a name='5000'>
      B_t_save(i,k,j)=t_save(i,k,j)<a name='5001'>
      B_c2a(i,k,j)=c2a(i,k,j)<a name='5002'>
      B_ww_save(i,k,j)=ww_save(i,k,j)<a name='5003'>
   enddo<a name='5004'>
   enddo<a name='5005'>
   enddo<a name='5006'>
   do i=its,ite<a name='5007'>
   do j=jts,jte<a name='5008'>
      B_muus(i,j)=muus(i,j)<a name='5009'>
      B_muvs(i,j)=muvs(i,j)<a name='5010'>
      B_muts(i,j)=muts(i,j)<a name='5011'>
      B_mu_save(i,j)=mu_save(i,j)<a name='5012'>
      B_mudf(i,j)=mudf(i,j)<a name='5013'>
   enddo<a name='5014'>
   enddo<a name='5015'>
<a name='5016'>
<font color=#447700>!  TCL<a name='5017'></font>
<a name='5018'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_SMALL_STEP_PREP'>g_small_step_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SMALL_STEP_PREP_1">( K_u_1, P_u_1, K_u_2, P_u_2, K_v_1, P_v_1, K_v_2, P_v_2, K_w_1, P_w_1, K_w_2, P_w_2, K_t_1, P_t_1, K_t_2, P_t_2, K_ph_1,&amp;<a name='5019'>
&amp; P_ph_1, K_ph_2, P_ph_2, mub, K_mu_1, P_mu_1, K_mu_2, P_mu_2, K_muu, P_muu, muus, P_muus, K_muv, P_muv, muvs, P_muvs, K_mut, P_mut, muts, &amp;<a name='5020'>
&amp;P_muts, mudf, P_mudf, u_save, P_u_save, v_save, P_v_save, w_save, P_w_save, t_save, P_t_save, ph_save, P_ph_save, mu_save, &amp;<a name='5021'>
&amp;P_mu_save, ww, P_ww, ww_save, P_ww_save, c2a, P_c2a, pb, p, P_p, alt, P_alt, msfu, msfv, msft, rk_step, leapfrog, ide, jde, kde, &amp;<a name='5022'>
&amp;ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='5023'>
<a name='5024'>
   SAVE_L=0.<a name='5025'>
   do i=its,ite<a name='5026'>
   do k=kts,kte<a name='5027'>
   do j=jts,jte<a name='5028'>
      SAVE_L=SAVE_L + P_u_1(i,k,j)*P_u_1(i,k,j)         &amp;<a name='5029'>
                    + P_v_1(i,k,j)*P_v_1(i,k,j)         &amp;<a name='5030'>
                    + P_w_1(i,k,j)*P_w_1(i,k,j)         &amp;<a name='5031'>
                    + P_t_1(i,k,j)*P_t_1(i,k,j)         &amp;<a name='5032'>
                    + P_ph_1(i,k,j)*P_ph_1(i,k,j)       &amp;<a name='5033'>
                    + P_u_2(i,k,j)*P_u_2(i,k,j)         &amp;<a name='5034'>
                    + P_v_2(i,k,j)*P_v_2(i,k,j)         &amp;<a name='5035'>
                    + P_w_2(i,k,j)*P_w_2(i,k,j)         &amp;<a name='5036'>
                    + P_t_2(i,k,j)*P_t_2(i,k,j)         &amp;<a name='5037'>
                    + P_ph_2(i,k,j)*P_ph_2(i,k,j)<a name='5038'>
   enddo<a name='5039'>
   enddo<a name='5040'>
   enddo<a name='5041'>
   do i=its,ite<a name='5042'>
   do j=jts,jte<a name='5043'>
      SAVE_L=SAVE_L + P_mu_1(i,j)*P_mu_1(i,j)           &amp;<a name='5044'>
                    + P_mu_2(i,j)*P_mu_2(i,j)           &amp;<a name='5045'>
                    + P_mut(i,j)*P_mut(i,j)             &amp;<a name='5046'>
                    + P_muu(i,j)*P_muu(i,j)             &amp;<a name='5047'>
                    + P_muv(i,j)*P_muv(i,j)<a name='5048'>
   enddo<a name='5049'>
   enddo<a name='5050'>
   do i=its,ite<a name='5051'>
   do k=kts,kte<a name='5052'>
   do j=jts,jte<a name='5053'>
      SAVE_L=SAVE_L + P_u_save(i,k,j)*P_u_save(i,k,j)    &amp;<a name='5054'>
                    + P_v_save(i,k,j)*P_v_save(i,k,j)    &amp;<a name='5055'>
                    + P_w_save(i,k,j)*P_w_save(i,k,j)    &amp;<a name='5056'>
                    + P_ph_save(i,k,j)*P_ph_save(i,k,j)  &amp;<a name='5057'>
                    + P_t_save(i,k,j)*P_t_save(i,k,j)    &amp;<a name='5058'>
                    + P_c2a(i,k,j)*P_c2a(i,k,j)          &amp;<a name='5059'>
                    + P_ww_save(i,k,j)*P_ww_save(i,k,j)<a name='5060'>
   enddo<a name='5061'>
   enddo<a name='5062'>
   enddo<a name='5063'>
   do i=its,ite<a name='5064'>
   do j=jts,jte<a name='5065'>
      SAVE_L=SAVE_L + P_muus(i,j)*P_muus(i,j)            &amp;<a name='5066'>
                    + P_muvs(i,j)*P_muvs(i,j)            &amp;<a name='5067'>
                    + P_muts(i,j)*P_muts(i,j)            &amp;<a name='5068'>
                    + P_mu_save(i,j)*P_mu_save(i,j)      &amp;<a name='5069'>
                    + P_mudf(i,j)*P_mudf(i,j)<a name='5070'>
   enddo<a name='5071'>
   enddo<a name='5072'>
<a name='5073'>
#ifdef DM_PARALLEL<a name='5074'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='5075'>
                       comm, IERROR )<a name='5076'>
   SAVE_L = nsum <a name='5077'>
#endif<a name='5078'>
<a name='5079'>
   ALPHA=1.<a name='5080'>
   DO NT=1,11<a name='5081'>
      ALPHA=0.1*ALPHA<a name='5082'>
      FACTOR=1.+ALPHA<a name='5083'>
   do i=ims,ime<a name='5084'>
   do k=kms,kme<a name='5085'>
   do j=jms,jme<a name='5086'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='5087'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='5088'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='5089'>
   enddo<a name='5090'>
   enddo<a name='5091'>
   enddo<a name='5092'>
   do i=ims,ime<a name='5093'>
   do k=kms,kme<a name='5094'>
   do j=jms,jme<a name='5095'>
      P_u_1(i,k,j)=FACTOR*S_u_1(i,k,j)<a name='5096'>
      P_v_1(i,k,j)=FACTOR*S_v_1(i,k,j)<a name='5097'>
      P_w_1(i,k,j)=FACTOR*S_w_1(i,k,j)<a name='5098'>
      P_t_1(i,k,j)=FACTOR*S_t_1(i,k,j)<a name='5099'>
      P_ph_1(i,k,j)=FACTOR*S_ph_1(i,k,j)<a name='5100'>
      P_u_2(i,k,j)=FACTOR*S_u_2(i,k,j)<a name='5101'>
      P_v_2(i,k,j)=FACTOR*S_v_2(i,k,j)<a name='5102'>
      P_w_2(i,k,j)=FACTOR*S_w_2(i,k,j)<a name='5103'>
      P_t_2(i,k,j)=FACTOR*S_t_2(i,k,j)<a name='5104'>
      P_ph_2(i,k,j)=FACTOR*S_ph_2(i,k,j)<a name='5105'>
   enddo<a name='5106'>
   enddo<a name='5107'>
   enddo<a name='5108'>
   do i=ims,ime<a name='5109'>
   do j=jms,jme<a name='5110'>
      P_mu_1(i,j)=FACTOR*S_mu_1(i,j)<a name='5111'>
      P_mu_2(i,j)=FACTOR*S_mu_2(i,j)<a name='5112'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='5113'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='5114'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='5115'>
   enddo<a name='5116'>
   enddo<a name='5117'>
<a name='5118'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_PREP'>small_step_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMALL_STEP_PREP_2">( P_u_1, P_u_2, P_v_1, P_v_2, P_w_1, P_w_2, &amp;<a name='5119'>
                            P_t_1, P_t_2, P_ph_1, P_ph_2,         &amp;<a name='5120'>
                            mub, P_mu_1, P_mu_2,              &amp;<a name='5121'>
                            P_muu, P_muus, P_muv, P_muvs,         &amp;<a name='5122'>
                            P_mut, P_muts, P_mudf,              &amp;<a name='5123'>
                            P_u_save, P_v_save, P_w_save,       &amp;<a name='5124'>
                            P_t_save, P_ph_save, P_mu_save,     &amp;<a name='5125'>
                            P_ww, P_ww_save,                  &amp;<a name='5126'>
                            dnw, P_c2a, pb, P_p, P_alt,         &amp;<a name='5127'>
                            msfu, msfv, msft,             &amp;<a name='5128'>
                            rk_step, leapfrog,            &amp;<a name='5129'>
                            ids,ide, jds,jde, kds,kde,    &amp;<a name='5130'>
                            ims,ime, jms,jme, kms,kme,    &amp;<a name='5131'>
                            its,ite, jts,jte, kts,kte    )<a name='5132'>
<a name='5133'>
      VAL_N=0.<a name='5134'>
      do i=its,ite<a name='5135'>
      do k=kts,kte<a name='5136'>
      do j=jts,jte<a name='5137'>
         VAL_N=VAL_N + (P_u_1(i,k,j)- B_u_1(i,k,j))*(P_u_1(i,k,j)- B_u_1(i,k,j))        &amp;<a name='5138'>
                    + (P_v_1(i,k,j)- B_v_1(i,k,j))*(P_v_1(i,k,j)- B_v_1(i,k,j))         &amp;<a name='5139'>
                    + (P_w_1(i,k,j)- B_w_1(i,k,j))*(P_w_1(i,k,j)- B_w_1(i,k,j))         &amp;<a name='5140'>
                    + (P_t_1(i,k,j)- B_t_1(i,k,j))*(P_t_1(i,k,j)- B_t_1(i,k,j))         &amp;<a name='5141'>
                    + (P_ph_1(i,k,j)- B_ph_1(i,k,j))*(P_ph_1(i,k,j)- B_ph_1(i,k,j))     &amp;<a name='5142'>
                    + (P_u_2(i,k,j)- B_u_2(i,k,j))*(P_u_2(i,k,j)- B_u_2(i,k,j))         &amp;<a name='5143'>
                    + (P_v_2(i,k,j)- B_v_2(i,k,j))*(P_v_2(i,k,j)- B_v_2(i,k,j))         &amp;<a name='5144'>
                    + (P_w_2(i,k,j)- B_w_2(i,k,j))*(P_w_2(i,k,j)- B_w_2(i,k,j))         &amp;<a name='5145'>
                    + (P_t_2(i,k,j)- B_t_2(i,k,j))*(P_t_2(i,k,j)- B_t_2(i,k,j))         &amp;<a name='5146'>
                    + (P_ph_2(i,k,j)- B_ph_2(i,k,j))*(P_ph_2(i,k,j)- B_ph_2(i,k,j))<a name='5147'>
   enddo<a name='5148'>
   enddo<a name='5149'>
   enddo<a name='5150'>
   do i=its,ite<a name='5151'>
   do j=jts,jte<a name='5152'>
         VAL_N=VAL_N + (P_mu_1(i,j)- B_mu_1(i,j))*(P_mu_1(i,j)- B_mu_1(i,j))         &amp;<a name='5153'>
                    + (P_mu_2(i,j)- B_mu_2(i,j))*(P_mu_2(i,j)- B_mu_2(i,j))          &amp;<a name='5154'>
                    + (P_mut(i,j)- B_mut(i,j))*(P_mut(i,j)- B_mut(i,j))              &amp;<a name='5155'>
                    + (P_muu(i,j)- B_muu(i,j))*(P_muu(i,j)- B_muu(i,j))              &amp;<a name='5156'>
                    + (P_muv(i,j)- B_muv(i,j))*(P_muv(i,j)- B_muv(i,j))         <a name='5157'>
   enddo<a name='5158'>
   enddo<a name='5159'>
   do i=its,ite<a name='5160'>
   do k=kts,kte<a name='5161'>
   do j=jts,jte<a name='5162'>
         VAL_N=VAL_N + (P_u_save(i,k,j)- B_u_save(i,k,j))*(P_u_save(i,k,j)- B_u_save(i,k,j))        &amp;<a name='5163'>
                    + (P_v_save(i,k,j)- B_v_save(i,k,j))*(P_v_save(i,k,j)- B_v_save(i,k,j))         &amp;<a name='5164'>
                    + (P_w_save(i,k,j)- B_w_save(i,k,j))*(P_w_save(i,k,j)- B_w_save(i,k,j))         &amp;<a name='5165'>
                    + (P_ph_save(i,k,j)- B_ph_save(i,k,j))*(P_ph_save(i,k,j)- B_ph_save(i,k,j))     &amp;<a name='5166'>
                    + (P_t_save(i,k,j)- B_t_save(i,k,j))*(P_t_save(i,k,j)- B_t_save(i,k,j))         &amp;<a name='5167'>
                    + (P_c2a(i,k,j)- B_c2a(i,k,j))*(P_c2a(i,k,j)- B_c2a(i,k,j))                     &amp;<a name='5168'>
                    + (P_ww_save(i,k,j)- B_ww_save(i,k,j))*(P_ww_save(i,k,j)- B_ww_save(i,k,j))<a name='5169'>
   enddo<a name='5170'>
   enddo<a name='5171'>
   enddo<a name='5172'>
   do i=its,ite<a name='5173'>
   do j=jts,jte<a name='5174'>
         VAL_N=VAL_N + (P_muus(i,j)- B_muus(i,j))*(P_muus(i,j)- B_muus(i,j))              &amp;<a name='5175'>
                    + (P_muvs(i,j)- B_muvs(i,j))*(P_muvs(i,j)- B_muvs(i,j))               &amp;<a name='5176'>
                    + (P_muts(i,j)- B_muts(i,j))*(P_muts(i,j)- B_muts(i,j))               &amp;<a name='5177'>
                    + (P_mu_save(i,j)- B_mu_save(i,j))*(P_mu_save(i,j)- B_mu_save(i,j))   &amp;<a name='5178'>
                    + (P_mudf(i,j)- B_mudf(i,j))*(P_mudf(i,j)- B_mudf(i,j))<a name='5179'>
   enddo<a name='5180'>
   enddo<a name='5181'>
<a name='5182'>
#ifdef DM_PARALLEL<a name='5183'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='5184'>
                       comm, IERROR )<a name='5185'>
   VAL_N = nsum <a name='5186'>
#endif<a name='5187'>
<a name='5188'>
      VAL_L=SAVE_L*ALPHA**2<a name='5189'>
      COEF=VAL_N/VAL_L<a name='5190'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='5191'>
         'g_small_step_prep: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='5192'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='5193'>
   ENDDO<a name='5194'>
<a name='5195'>
<font color=#447700>!  ADJ test<a name='5196'></font>
<a name='5197'>
   FACTOR=0.1<a name='5198'>
   do i=ims,ime<a name='5199'>
   do k=kms,kme<a name='5200'>
   do j=jms,jme<a name='5201'>
      p(i,k,j)=S_p(i,k,j)<a name='5202'>
      alt(i,k,j)=S_alt(i,k,j)<a name='5203'>
      ww(i,k,j)=S_ww(i,k,j)<a name='5204'>
<a name='5205'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='5206'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='5207'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='5208'>
<a name='5209'>
      B_p(i,k,j)=P_p(i,k,j)<a name='5210'>
      B_alt(i,k,j)=P_alt(i,k,j)<a name='5211'>
      B_ww(i,k,j)=P_ww(i,k,j)<a name='5212'>
   enddo<a name='5213'>
   enddo<a name='5214'>
   enddo<a name='5215'>
   do i=ims,ime<a name='5216'>
   do k=kms,kme<a name='5217'>
   do j=jms,jme<a name='5218'>
      u_1(i,k,j)=S_u_1(i,k,j)<a name='5219'>
      v_1(i,k,j)=S_v_1(i,k,j)<a name='5220'>
      w_1(i,k,j)=S_w_1(i,k,j)<a name='5221'>
      t_1(i,k,j)=S_t_1(i,k,j)<a name='5222'>
      ph_1(i,k,j)=S_ph_1(i,k,j)<a name='5223'>
      u_2(i,k,j)=S_u_2(i,k,j)<a name='5224'>
      v_2(i,k,j)=S_v_2(i,k,j)<a name='5225'>
      w_2(i,k,j)=S_w_2(i,k,j)<a name='5226'>
      t_2(i,k,j)=S_t_2(i,k,j)<a name='5227'>
      ph_2(i,k,j)=S_ph_2(i,k,j)<a name='5228'>
<a name='5229'>
      P_u_1(i,k,j)=FACTOR*S_u_1(i,k,j)<a name='5230'>
      P_v_1(i,k,j)=FACTOR*S_v_1(i,k,j)<a name='5231'>
      P_w_1(i,k,j)=FACTOR*S_w_1(i,k,j)<a name='5232'>
      P_t_1(i,k,j)=FACTOR*S_t_1(i,k,j)<a name='5233'>
      P_ph_1(i,k,j)=FACTOR*S_ph_1(i,k,j)<a name='5234'>
      P_u_2(i,k,j)=FACTOR*S_u_2(i,k,j)<a name='5235'>
      P_v_2(i,k,j)=FACTOR*S_v_2(i,k,j)<a name='5236'>
      P_w_2(i,k,j)=FACTOR*S_w_2(i,k,j)<a name='5237'>
      P_t_2(i,k,j)=FACTOR*S_t_2(i,k,j)<a name='5238'>
      P_ph_2(i,k,j)=FACTOR*S_ph_2(i,k,j)<a name='5239'>
<a name='5240'>
      B_u_1(i,k,j)=P_u_1(i,k,j)<a name='5241'>
      B_v_1(i,k,j)=P_v_1(i,k,j)<a name='5242'>
      B_w_1(i,k,j)=P_w_1(i,k,j)<a name='5243'>
      B_t_1(i,k,j)=P_t_1(i,k,j)<a name='5244'>
      B_ph_1(i,k,j)=P_ph_1(i,k,j)<a name='5245'>
      B_u_2(i,k,j)=P_u_2(i,k,j)<a name='5246'>
      B_v_2(i,k,j)=P_v_2(i,k,j)<a name='5247'>
      B_w_2(i,k,j)=P_w_2(i,k,j)<a name='5248'>
      B_t_2(i,k,j)=P_t_2(i,k,j)<a name='5249'>
      B_ph_2(i,k,j)=P_ph_2(i,k,j)<a name='5250'>
<a name='5251'>
      K_u_1(i,k,j)=u_1(i,k,j)<a name='5252'>
      K_v_1(i,k,j)=v_1(i,k,j)<a name='5253'>
      K_w_1(i,k,j)=w_1(i,k,j)<a name='5254'>
      K_t_1(i,k,j)=t_1(i,k,j)<a name='5255'>
      K_ph_1(i,k,j)=ph_1(i,k,j)<a name='5256'>
      K_u_2(i,k,j)=u_2(i,k,j)<a name='5257'>
      K_v_2(i,k,j)=v_2(i,k,j)<a name='5258'>
      K_w_2(i,k,j)=w_2(i,k,j)<a name='5259'>
      K_t_2(i,k,j)=t_2(i,k,j)<a name='5260'>
      K_ph_2(i,k,j)=ph_2(i,k,j)<a name='5261'>
   enddo<a name='5262'>
   enddo<a name='5263'>
   enddo<a name='5264'>
   do i=ims,ime<a name='5265'>
   do j=jms,jme<a name='5266'>
      mu_1(i,j)=S_mu_1(i,j)<a name='5267'>
      mu_2(i,j)=S_mu_2(i,j)<a name='5268'>
      mut(i,j)=S_mut(i,j)<a name='5269'>
      muu(i,j)=S_muu(i,j)<a name='5270'>
      muv(i,j)=S_muv(i,j)<a name='5271'>
<a name='5272'>
      P_mu_1(i,j)=FACTOR*S_mu_1(i,j)<a name='5273'>
      P_mu_2(i,j)=FACTOR*S_mu_2(i,j)<a name='5274'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='5275'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='5276'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='5277'>
<a name='5278'>
      B_mu_1(i,j)=P_mu_1(i,j)<a name='5279'>
      B_mu_2(i,j)=P_mu_2(i,j)<a name='5280'>
      B_mut(i,j)=P_mut(i,j)<a name='5281'>
      B_muu(i,j)=P_muu(i,j)<a name='5282'>
      B_muv(i,j)=P_muv(i,j)<a name='5283'>
<a name='5284'>
      K_mu_1(i,j)=mu_1(i,j)<a name='5285'>
      K_mu_2(i,j)=mu_2(i,j)<a name='5286'>
      K_mut(i,j)=mut(i,j)<a name='5287'>
      K_muu(i,j)=muu(i,j)<a name='5288'>
      K_muv(i,j)=muv(i,j)<a name='5289'>
   enddo<a name='5290'>
   enddo<a name='5291'>
<a name='5292'>
<font color=#447700>!  TGL<a name='5293'></font>
<a name='5294'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_SMALL_STEP_PREP'>g_small_step_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SMALL_STEP_PREP_2">( u_1, P_u_1, u_2, P_u_2, v_1, P_v_1, v_2, P_v_2, w_1, P_w_1, w_2, P_w_2, t_1, P_t_1, t_2, P_t_2, ph_1,&amp;<a name='5295'>
&amp; P_ph_1, ph_2, P_ph_2, mub, mu_1, P_mu_1, mu_2, P_mu_2, muu, P_muu, muus, P_muus, muv, P_muv, muvs, P_muvs, mut, P_mut, muts, &amp;<a name='5296'>
&amp;P_muts, mudf, P_mudf, u_save, P_u_save, v_save, P_v_save, w_save, P_w_save, t_save, P_t_save, ph_save, P_ph_save, mu_save, &amp;<a name='5297'>
&amp;P_mu_save, ww, P_ww, ww_save, P_ww_save, c2a, P_c2a, pb, p, P_p, alt, P_alt, msfu, msfv, msft, rk_step, leapfrog, ide, jde, kde, &amp;<a name='5298'>
&amp;ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='5299'>
<a name='5300'>
   VAL_L=0.<a name='5301'>
   do i=its,ite<a name='5302'>
   do k=kts,kte<a name='5303'>
   do j=jts,jte<a name='5304'>
      VAL_L=VAL_L  + P_u_1(i,k,j)*P_u_1(i,k,j)         &amp;<a name='5305'>
                    + P_v_1(i,k,j)*P_v_1(i,k,j)         &amp;<a name='5306'>
                    + P_w_1(i,k,j)*P_w_1(i,k,j)         &amp;<a name='5307'>
                    + P_t_1(i,k,j)*P_t_1(i,k,j)         &amp;<a name='5308'>
                    + P_ph_1(i,k,j)*P_ph_1(i,k,j)       &amp;<a name='5309'>
                    + P_u_2(i,k,j)*P_u_2(i,k,j)         &amp;<a name='5310'>
                    + P_v_2(i,k,j)*P_v_2(i,k,j)         &amp;<a name='5311'>
                    + P_w_2(i,k,j)*P_w_2(i,k,j)         &amp;<a name='5312'>
                    + P_t_2(i,k,j)*P_t_2(i,k,j)         &amp;<a name='5313'>
                    + P_ph_2(i,k,j)*P_ph_2(i,k,j)<a name='5314'>
   enddo<a name='5315'>
   enddo<a name='5316'>
   enddo<a name='5317'>
   do i=its,ite<a name='5318'>
   do j=jts,jte<a name='5319'>
      VAL_L=VAL_L  + P_mu_1(i,j)*P_mu_1(i,j)           &amp;<a name='5320'>
                    + P_mu_2(i,j)*P_mu_2(i,j)           &amp;<a name='5321'>
                    + P_mut(i,j)*P_mut(i,j)             &amp;<a name='5322'>
                    + P_muu(i,j)*P_muu(i,j)             &amp;<a name='5323'>
                    + P_muv(i,j)*P_muv(i,j)<a name='5324'>
   enddo<a name='5325'>
   enddo<a name='5326'>
   do i=its,ite<a name='5327'>
   do k=kts,kte<a name='5328'>
   do j=jts,jte<a name='5329'>
      VAL_L=VAL_L  + P_u_save(i,k,j)*P_u_save(i,k,j)    &amp;<a name='5330'>
                    + P_v_save(i,k,j)*P_v_save(i,k,j)    &amp;<a name='5331'>
                    + P_w_save(i,k,j)*P_w_save(i,k,j)    &amp;<a name='5332'>
                    + P_ph_save(i,k,j)*P_ph_save(i,k,j)  &amp;<a name='5333'>
                    + P_t_save(i,k,j)*P_t_save(i,k,j)    &amp;<a name='5334'>
                    + P_c2a(i,k,j)*P_c2a(i,k,j)          &amp;<a name='5335'>
                    + P_ww_save(i,k,j)*P_ww_save(i,k,j)<a name='5336'>
   enddo<a name='5337'>
   enddo<a name='5338'>
   enddo<a name='5339'>
<a name='5340'>
   do i=its,ite<a name='5341'>
   do j=jts,jte<a name='5342'>
      VAL_L=VAL_L  + P_muus(i,j)*P_muus(i,j)            &amp;<a name='5343'>
                    + P_muvs(i,j)*P_muvs(i,j)            &amp;<a name='5344'>
                    + P_muts(i,j)*P_muts(i,j)            &amp;<a name='5345'>
                    + P_mu_save(i,j)*P_mu_save(i,j)      &amp;<a name='5346'>
                    + P_mudf(i,j)*P_mudf(i,j)<a name='5347'>
   enddo<a name='5348'>
   enddo<a name='5349'>
<a name='5350'>
#ifdef DM_PARALLEL<a name='5351'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='5352'>
                       comm, IERROR )<a name='5353'>
   VAL_L = nsum <a name='5354'>
#endif<a name='5355'>
<a name='5356'>
   do i=ims,ime<a name='5357'>
   do k=kms,kme<a name='5358'>
   do j=jms,jme<a name='5359'>
      P_p(i,k,j)=0.0<a name='5360'>
      P_alt(i,k,j)=0.0<a name='5361'>
      P_ww(i,k,j)=0.0<a name='5362'>
   enddo<a name='5363'>
   enddo<a name='5364'>
   enddo<a name='5365'>
<a name='5366'>
<font color=#447700>!  ADJ<a name='5367'></font>
<a name='5368'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_ad.F.html#A_SMALL_STEP_PREP'>a_small_step_prep</A><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_SMALL_STEP_PREP_1">( K_u_1, P_u_1, K_u_2, P_u_2, K_v_1, P_v_1, K_v_2, P_v_2, K_w_1, P_w_1, K_w_2, P_w_2, K_t_1, P_t_1, K_t_2, P_t_2, &amp;<a name='5369'>
&amp;P_ph_1, P_ph_2, mub, K_mu_1, P_mu_1, K_mu_2, P_mu_2, K_muu, P_muu, muus, P_muus, K_muv, P_muv, muvs, P_muvs, K_mut, P_mut, muts, P_muts, &amp;<a name='5370'>
&amp;P_mudf, P_u_save, P_v_save, P_w_save, P_t_save, P_ph_save, P_mu_save, P_ww, P_ww_save, P_c2a, pb, p, P_p, alt, P_alt, msfu, msfv, &amp;<a name='5371'>
&amp;msft, rk_step, leapfrog, ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='5372'>
<a name='5373'>
<font color=#447700>!   CALL a_small_step_prep( K_u_1, P_u_1, K_u_2, P_u_2, K_v_1, P_v_1, K_v_2, P_v_2, K_w_1, P_w_1, K_w_2, P_w_2, K_t_1, P_t_1, K_t_2, P_t_2, ph_1,&amp;<a name='5374'></font>
<font color=#447700>!&amp; P_ph_1, ph_2, P_ph_2, mub, K_mu_1, P_mu_1, K_mu_2, P_mu_2, K_muu, P_muu, muus, P_muus, K_muv, P_muv, muvs, P_muvs, K_mut, P_mut, muts, &amp;<a name='5375'></font>
<font color=#447700>!&amp;P_muts, mudf, P_mudf, u_save, P_u_save, v_save, P_v_save, w_save, P_w_save, t_save, P_t_save, ph_save, P_ph_save, mu_save, &amp;<a name='5376'></font>
<font color=#447700>!&amp;P_mu_save, ww, P_ww, ww_save, P_ww_save, c2a, P_c2a, pb, p, P_p, alt, P_alt, msfu, msfv, msft, rk_step, leapfrog, ide, jde, kde, &amp;<a name='5377'></font>
<font color=#447700>!&amp;ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='5378'></font>
<a name='5379'>
   VAL_A=0.<a name='5380'>
   do i=its,ite<a name='5381'>
   do k=kts,kte<a name='5382'>
   do j=jts,jte<a name='5383'>
      VAL_A=VAL_A +P_p(i,k,j)*B_p(i,k,j)      &amp;<a name='5384'>
                  +P_alt(i,k,j)*B_alt(i,k,j)  &amp;<a name='5385'>
                  +P_ww(i,k,j)*B_ww(i,k,j)                     <a name='5386'>
   enddo<a name='5387'>
   enddo<a name='5388'>
   enddo<a name='5389'>
   do i=its,ite<a name='5390'>
   do k=kts,kte<a name='5391'>
   do j=jts,jte<a name='5392'>
      VAL_A=VAL_A + P_u_1(i,k,j)*B_u_1(i,k,j)         &amp;<a name='5393'>
                    + P_v_1(i,k,j)*B_v_1(i,k,j)         &amp;<a name='5394'>
                    + P_w_1(i,k,j)*B_w_1(i,k,j)         &amp;<a name='5395'>
                    + P_t_1(i,k,j)*B_t_1(i,k,j)         &amp;<a name='5396'>
                    + P_ph_1(i,k,j)*B_ph_1(i,k,j)       &amp;<a name='5397'>
                    + P_u_2(i,k,j)*B_u_2(i,k,j)         &amp;<a name='5398'>
                    + P_v_2(i,k,j)*B_v_2(i,k,j)         &amp;<a name='5399'>
                    + P_w_2(i,k,j)*B_w_2(i,k,j)         &amp;<a name='5400'>
                    + P_t_2(i,k,j)*B_t_2(i,k,j)         &amp;<a name='5401'>
                    + P_ph_2(i,k,j)*B_ph_2(i,k,j)<a name='5402'>
   enddo<a name='5403'>
   enddo<a name='5404'>
   enddo<a name='5405'>
   do i=its,ite<a name='5406'>
   do j=jts,jte<a name='5407'>
      VAL_A=VAL_A + P_mu_1(i,j)*B_mu_1(i,j)           &amp;<a name='5408'>
                    + P_mu_2(i,j)*B_mu_2(i,j)           &amp;<a name='5409'>
                    + P_mut(i,j)*B_mut(i,j)             &amp;<a name='5410'>
                    + P_muu(i,j)*B_muu(i,j)             &amp;<a name='5411'>
                    + P_muv(i,j)*B_muv(i,j)<a name='5412'>
   enddo<a name='5413'>
   enddo<a name='5414'>
<a name='5415'>
#ifdef DM_PARALLEL<a name='5416'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='5417'>
                       comm, IERROR )<a name='5418'>
   VAL_A = nsum <a name='5419'>
#endif<a name='5420'>
<a name='5421'>
   print*, '                '<a name='5422'>
   write(6,*) 'a_small_step_prep: '<a name='5423'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='5424'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='5425'>
<a name='5426'>
<font color=#447700>!  RECOVER<a name='5427'></font>
<a name='5428'>
   do i=ims,ime<a name='5429'>
   do k=kms,kme<a name='5430'>
   do j=jms,jme<a name='5431'>
      p(i,k,j)=S_p(i,k,j)<a name='5432'>
      alt(i,k,j)=S_alt(i,k,j)<a name='5433'>
      ww(i,k,j)=S_ww(i,k,j)<a name='5434'>
   enddo<a name='5435'>
   enddo<a name='5436'>
   enddo<a name='5437'>
   do i=ims,ime<a name='5438'>
   do k=kms,kme<a name='5439'>
   do j=jms,jme<a name='5440'>
      u_1(i,k,j)=S_u_1(i,k,j)<a name='5441'>
      v_1(i,k,j)=S_v_1(i,k,j)<a name='5442'>
      w_1(i,k,j)=S_w_1(i,k,j)<a name='5443'>
      t_1(i,k,j)=S_t_1(i,k,j)<a name='5444'>
      ph_1(i,k,j)=S_ph_1(i,k,j)<a name='5445'>
      u_2(i,k,j)=S_u_2(i,k,j)<a name='5446'>
      v_2(i,k,j)=S_v_2(i,k,j)<a name='5447'>
      w_2(i,k,j)=S_w_2(i,k,j)<a name='5448'>
      t_2(i,k,j)=S_t_2(i,k,j)<a name='5449'>
      ph_2(i,k,j)=S_ph_2(i,k,j)<a name='5450'>
   enddo<a name='5451'>
   enddo<a name='5452'>
   enddo<a name='5453'>
   do i=ims,ime<a name='5454'>
   do j=jms,jme<a name='5455'>
      mu_1(i,j)=S_mu_1(i,j)<a name='5456'>
      mu_2(i,j)=S_mu_2(i,j)<a name='5457'>
      mut(i,j)=S_mut(i,j)<a name='5458'>
      muu(i,j)=S_muu(i,j)<a name='5459'>
      muv(i,j)=S_muv(i,j)<a name='5460'>
   enddo<a name='5461'>
   enddo<a name='5462'>
<a name='5463'>
END SUBROUTINE t_small_step_prep<a name='5464'>
<a name='5465'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='5466'></font>
<a name='5467'>
<A NAME='T_CALC_P_RHO'><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5468'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_calc_p_rho</font>( al, p, ph,                    &amp; <A href='../../call_to/T_CALC_P_RHO.html' TARGET='index'>1</A>,<A href='../../call_from/T_CALC_P_RHO.html' TARGET='index'>5</A><a name='5469'>
                       alt, t_2, t_1, c2a, pm1,      &amp;<a name='5470'>
                       mu, muts, znu, t0,            &amp;<a name='5471'>
                       rdnw, dnw, smdiv,             &amp;<a name='5472'>
                       non_hydrostatic, step,        &amp;<a name='5473'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='5474'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='5475'>
                       its,ite, jts,jte, kts,kte    )<a name='5476'>
<a name='5477'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='5478'></font>
<a name='5479'>
<font color=#447700>! declarations for the stuff coming in<a name='5480'></font>
<a name='5481'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='5482'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='5483'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='5484'>
<a name='5485'>
  INTEGER,      INTENT(IN   )    :: step<a name='5486'>
<a name='5487'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(  OUT) :: al,   &amp;<a name='5488'>
                                                               p<a name='5489'>
<font color=#447700>! pjj/cray<a name='5490'></font>
<font color=#447700>!                                                             p,    &amp;<a name='5491'></font>
<font color=#447700>!                                                             pm1<a name='5492'></font>
<a name='5493'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)               :: alt,   &amp;<a name='5494'>
                                                              t_2,   &amp;<a name='5495'>
                                                              t_1,   &amp;<a name='5496'>
                                                              c2a<a name='5497'>
<a name='5498'>
<font color=#447700>! pjj/cray<a name='5499'></font>
<font color=#447700>! REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT) :: ph<a name='5500'></font>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT) :: ph, pm1<a name='5501'>
<a name='5502'>
  REAL, DIMENSION(ims:ime, jms:jme)                         :: mu,   &amp;<a name='5503'>
                                                               muts<a name='5504'>
<a name='5505'>
  REAL, DIMENSION(kms:kme)         , INTENT(IN   ) :: dnw,  &amp;<a name='5506'>
                                                      rdnw, &amp;<a name='5507'>
                                                      znu<a name='5508'>
<a name='5509'>
  REAL,                                       INTENT(IN   ) :: t0, smdiv<a name='5510'>
<a name='5511'>
  LOGICAL, INTENT(IN   )  :: non_hydrostatic<a name='5512'>
<a name='5513'>
<font color=#447700>! local variables<a name='5514'></font>
<a name='5515'>
  INTEGER :: i, j, k<a name='5516'>
  INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='5517'>
  REAL    :: ptmp<a name='5518'>
<a name='5519'>
<a name='5520'>
<font color=#447700>!  IN variables<a name='5521'></font>
<a name='5522'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme)              :: S_alt,   &amp;<a name='5523'>
                                                              S_t_2,   &amp;<a name='5524'>
                                                              S_t_1,   &amp;<a name='5525'>
                                                              S_c2a<a name='5526'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme)              :: P_alt,   &amp;<a name='5527'>
                                                              P_t_2,   &amp;<a name='5528'>
                                                              P_t_1,   &amp;<a name='5529'>
                                                              P_c2a<a name='5530'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme)              :: B_alt,   &amp;<a name='5531'>
                                                              B_t_2,   &amp;<a name='5532'>
                                                              B_t_1,   &amp;<a name='5533'>
                                                              B_c2a<a name='5534'>
   REAL, DIMENSION(ims:ime, jms:jme)          :: S_mu, S_muts,P_mu, P_muts,B_mu, B_muts<a name='5535'>
<a name='5536'>
<font color=#447700>!  INOUT variables<a name='5537'></font>
<a name='5538'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme) :: S_ph, S_pm1,P_ph, P_pm1,K_ph, K_pm1,B_ph, B_pm1<a name='5539'>
<a name='5540'>
<font color=#447700>!  OUT variables<a name='5541'></font>
<a name='5542'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme)   :: P_al, P_p,B_al, B_p,S_al,S_p<a name='5543'>
<a name='5544'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='5545'>
   INTEGER :: NT<a name='5546'>
<a name='5547'>
<font color=#447700>!TGL test<a name='5548'></font>
<a name='5549'>
   do i=ims,ime<a name='5550'>
   do k=kms,kme<a name='5551'>
   do j=jms,jme<a name='5552'>
      S_alt(i,k,j)=alt(i,k,j)<a name='5553'>
      S_t_2(i,k,j)=t_2(i,k,j)<a name='5554'>
      S_t_1(i,k,j)=t_1(i,k,j)<a name='5555'>
      S_c2a(i,k,j)=c2a(i,k,j)<a name='5556'>
<a name='5557'>
      P_alt(i,k,j)=alt(i,k,j)<a name='5558'>
      P_t_2(i,k,j)=t_2(i,k,j)<a name='5559'>
      P_t_1(i,k,j)=t_1(i,k,j)<a name='5560'>
      P_c2a(i,k,j)=c2a(i,k,j)<a name='5561'>
   enddo<a name='5562'>
   enddo<a name='5563'>
   enddo<a name='5564'>
   do i=ims,ime<a name='5565'>
   do j=jms,jme<a name='5566'>
      S_mu(i,j)=mu(i,j)<a name='5567'>
      S_muts(i,j)=muts(i,j)<a name='5568'>
<a name='5569'>
      P_mu(i,j)=mu(i,j)<a name='5570'>
      P_muts(i,j)=muts(i,j)<a name='5571'>
   enddo<a name='5572'>
   enddo<a name='5573'>
   do i=ims,ime<a name='5574'>
   do k=kms,kme<a name='5575'>
   do j=jms,jme<a name='5576'>
      S_ph(i,k,j)=ph(i,k,j)<a name='5577'>
      S_pm1(i,k,j)=pm1(i,k,j)<a name='5578'>
<a name='5579'>
      P_ph(i,k,j)=ph(i,k,j)<a name='5580'>
      P_pm1(i,k,j)=pm1(i,k,j)<a name='5581'>
<a name='5582'>
      K_ph(i,k,j)=ph(i,k,j)<a name='5583'>
      K_pm1(i,k,j)=pm1(i,k,j)<a name='5584'>
   enddo<a name='5585'>
   enddo<a name='5586'>
   enddo<a name='5587'>
<a name='5588'>
   do i=ims,ime<a name='5589'>
   do k=kms,kme<a name='5590'>
   do j=jms,jme<a name='5591'>
      S_al(i,k,j)=al(i,k,j)<a name='5592'>
      S_p(i,k,j)=p(i,k,j)<a name='5593'>
<a name='5594'>
      P_al(i,k,j)=al(i,k,j)<a name='5595'>
      P_p(i,k,j)=p(i,k,j)<a name='5596'>
   enddo<a name='5597'>
   enddo<a name='5598'>
   enddo<a name='5599'>
<a name='5600'>
<font color=#447700>!NLM<a name='5601'></font>
<a name='5602'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_P_RHO'>calc_p_rho</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_1">( al, p, ph,                    &amp;<a name='5603'>
                       alt, t_2, t_1, c2a, pm1,      &amp;<a name='5604'>
                       mu, muts, znu, t0,            &amp;<a name='5605'>
                       rdnw, dnw, smdiv,             &amp;<a name='5606'>
                       non_hydrostatic, step,        &amp;<a name='5607'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='5608'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='5609'>
                       its,ite, jts,jte, kts,kte    )<a name='5610'>
<a name='5611'>
   do i=its,ite<a name='5612'>
   do k=kts,kte<a name='5613'>
   do j=jts,jte<a name='5614'>
      B_al(i,k,j)=al(i,k,j)<a name='5615'>
      B_p(i,k,j)=p(i,k,j)<a name='5616'>
   enddo<a name='5617'>
   enddo<a name='5618'>
   enddo<a name='5619'>
   do i=its,ite<a name='5620'>
   do k=kts,kte<a name='5621'>
   do j=jts,jte<a name='5622'>
      B_ph(i,k,j)=ph(i,k,j)<a name='5623'>
      B_pm1(i,k,j)=pm1(i,k,j)<a name='5624'>
   enddo<a name='5625'>
   enddo<a name='5626'>
   enddo<a name='5627'>
<a name='5628'>
   do i=its,ite<a name='5629'>
   do k=kts,kte<a name='5630'>
   do j=jts,jte<a name='5631'>
      B_alt(i,k,j)=alt(i,k,j)<a name='5632'>
      B_t_2(i,k,j)=t_2(i,k,j)<a name='5633'>
      B_t_1(i,k,j)=t_1(i,k,j)<a name='5634'>
      B_c2a(i,k,j)=c2a(i,k,j)<a name='5635'>
   enddo<a name='5636'>
   enddo<a name='5637'>
   enddo<a name='5638'>
   do i=its,ite<a name='5639'>
   do j=jts,jte<a name='5640'>
      B_mu(i,j)=mu(i,j)<a name='5641'>
      B_muts(i,j)=muts(i,j)<a name='5642'>
   enddo<a name='5643'>
   enddo<a name='5644'>
<a name='5645'>
<font color=#447700>!  TCL<a name='5646'></font>
<a name='5647'>
   do i=ims,ime<a name='5648'>
   do k=kms,kme<a name='5649'>
   do j=jms,jme<a name='5650'>
      alt(i,k,j)=S_alt(i,k,j)<a name='5651'>
      t_2(i,k,j)=S_t_2(i,k,j)<a name='5652'>
      t_1(i,k,j)=S_t_1(i,k,j)<a name='5653'>
      c2a(i,k,j)=S_c2a(i,k,j)<a name='5654'>
   enddo<a name='5655'>
   enddo<a name='5656'>
   enddo<a name='5657'>
   do i=ims,ime<a name='5658'>
   do j=jms,jme<a name='5659'>
      mu(i,j)=S_mu(i,j)<a name='5660'>
      muts(i,j)=S_muts(i,j)<a name='5661'>
   enddo<a name='5662'>
   enddo<a name='5663'>
   do i=ims,ime<a name='5664'>
   do k=kms,kme<a name='5665'>
   do j=jms,jme<a name='5666'>
      ph(i,k,j)=S_ph(i,k,j)<a name='5667'>
      pm1(i,k,j)=S_pm1(i,k,j)<a name='5668'>
   enddo<a name='5669'>
   enddo<a name='5670'>
   enddo<a name='5671'>
<a name='5672'>
   do i=ims,ime<a name='5673'>
   do k=kms,kme<a name='5674'>
   do j=jms,jme<a name='5675'>
      al(i,k,j)=S_al(i,k,j)<a name='5676'>
      p(i,k,j)=S_p(i,k,j)<a name='5677'>
   enddo<a name='5678'>
   enddo<a name='5679'>
   enddo<a name='5680'>
<a name='5681'>
<a name='5682'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_CALC_P_RHO'>g_calc_p_rho</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALC_P_RHO_1">( al, P_al, p, P_p, ph, P_ph, alt, P_alt, t_2, P_t_2, t_1, P_t_1, c2a, P_c2a, pm1, P_pm1, mu, P_mu, muts, &amp;<a name='5683'>
&amp;P_muts, znu, t0, rdnw, dnw, smdiv, non_hydrostatic, step, ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, &amp;<a name='5684'>
&amp;kte )<a name='5685'>
<a name='5686'>
   SAVE_L=0.<a name='5687'>
   do i=its,ite<a name='5688'>
   do k=kts,kte<a name='5689'>
   do j=jts,jte<a name='5690'>
      SAVE_L=SAVE_L + P_al(i,k,j)*P_al(i,k,j) +P_p(i,k,j)*P_p(i,k,j)<a name='5691'>
   enddo<a name='5692'>
   enddo<a name='5693'>
   enddo<a name='5694'>
   do i=its,ite<a name='5695'>
   do k=kts,kte<a name='5696'>
   do j=jts,jte<a name='5697'>
      SAVE_L=SAVE_L +P_ph(i,k,j)*P_ph(i,k,j) + P_pm1(i,k,j)*P_pm1(i,k,j)<a name='5698'>
   enddo<a name='5699'>
   enddo<a name='5700'>
   enddo<a name='5701'>
<a name='5702'>
   do i=its,ite<a name='5703'>
   do k=kts,kte<a name='5704'>
   do j=jts,jte<a name='5705'>
      SAVE_L=SAVE_L + P_alt(i,k,j)*P_alt(i,k,j)   &amp;<a name='5706'>
                  + P_t_2(i,k,j)*P_t_2(i,k,j)   &amp;<a name='5707'>
                  + P_t_1(i,k,j)*P_t_1(i,k,j)   &amp;<a name='5708'>
                  + P_c2a(i,k,j)*P_c2a(i,k,j)<a name='5709'>
   enddo<a name='5710'>
   enddo<a name='5711'>
   enddo<a name='5712'>
   do i=its,ite<a name='5713'>
   do j=jts,jte<a name='5714'>
      SAVE_L=SAVE_L + P_mu(i,j)*P_mu(i,j)   &amp;<a name='5715'>
                  + P_muts(i,j)*P_muts(i,j)<a name='5716'>
   enddo<a name='5717'>
   enddo<a name='5718'>
<a name='5719'>
#ifdef DM_PARALLEL<a name='5720'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='5721'>
                       comm, IERROR )<a name='5722'>
   SAVE_L = nsum <a name='5723'>
#endif<a name='5724'>
<a name='5725'>
   ALPHA=1.<a name='5726'>
   DO NT=1,11<a name='5727'>
      ALPHA=0.1*ALPHA<a name='5728'>
      FACTOR=1.+ALPHA<a name='5729'>
   do i=ims,ime<a name='5730'>
   do k=kms,kme<a name='5731'>
   do j=jms,jme<a name='5732'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='5733'>
      P_t_2(i,k,j)=FACTOR*S_t_2(i,k,j)<a name='5734'>
      P_t_1(i,k,j)=FACTOR*S_t_1(i,k,j)<a name='5735'>
      P_c2a(i,k,j)=FACTOR*S_c2a(i,k,j)<a name='5736'>
   enddo<a name='5737'>
   enddo<a name='5738'>
   enddo<a name='5739'>
   do i=ims,ime<a name='5740'>
   do j=jms,jme<a name='5741'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='5742'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='5743'>
   enddo<a name='5744'>
   enddo<a name='5745'>
   do i=ims,ime<a name='5746'>
   do k=kms,kme<a name='5747'>
   do j=jms,jme<a name='5748'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='5749'>
      P_pm1(i,k,j)=FACTOR*S_pm1(i,k,j)<a name='5750'>
   enddo<a name='5751'>
   enddo<a name='5752'>
   enddo<a name='5753'>
<a name='5754'>
   do i=ims,ime<a name='5755'>
   do k=kms,kme<a name='5756'>
   do j=jms,jme<a name='5757'>
      P_al(i,k,j)=FACTOR*S_al(i,k,j)<a name='5758'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='5759'>
   enddo<a name='5760'>
   enddo<a name='5761'>
   enddo<a name='5762'>
<a name='5763'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_P_RHO'>calc_p_rho</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_2">( P_al, P_p, P_ph,                    &amp;<a name='5764'>
                       P_alt, P_t_2, P_t_1, P_c2a, P_pm1,      &amp;<a name='5765'>
                       P_mu, P_muts, znu, t0,            &amp;<a name='5766'>
                       rdnw, dnw, smdiv,             &amp;<a name='5767'>
                       non_hydrostatic, step,        &amp;<a name='5768'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='5769'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='5770'>
                       its,ite, jts,jte, kts,kte    )<a name='5771'>
<a name='5772'>
   VAL_N=0.<a name='5773'>
   do i=its,ite<a name='5774'>
   do k=kts,kte<a name='5775'>
   do j=jts,jte<a name='5776'>
      VAL_N=VAL_N + (P_al(i,k,j)- B_al(i,k,j))*(P_al(i,k,j)- B_al(i,k,j))  &amp;<a name='5777'>
                  + (P_p(i,k,j) - B_p(i,k,j))*(P_p(i,k,j) - B_p(i,k,j))<a name='5778'>
   enddo<a name='5779'>
   enddo<a name='5780'>
   enddo<a name='5781'>
   do i=its,ite<a name='5782'>
   do k=kts,kte<a name='5783'>
   do j=jts,jte<a name='5784'>
         VAL_N=VAL_N + (P_ph(i,k,j)- B_ph(i,k,j))*(P_ph(i,k,j)- B_ph(i,k,j))  &amp;<a name='5785'>
                     + (P_pm1(i,k,j)-B_pm1(i,k,j))*(P_pm1(i,k,j)-B_pm1(i,k,j))<a name='5786'>
   enddo<a name='5787'>
   enddo<a name='5788'>
   enddo<a name='5789'>
<a name='5790'>
   do i=its,ite<a name='5791'>
   do k=kts,kte<a name='5792'>
   do j=jts,jte<a name='5793'>
      VAL_N=VAL_N + (P_alt(i,k,j)-B_alt(i,k,j))*(P_alt(i,k,j)-B_alt(i,k,j))   &amp;<a name='5794'>
                  + (P_t_2(i,k,j)-B_t_2(i,k,j))*(P_t_2(i,k,j)-B_t_2(i,k,j))   &amp;<a name='5795'>
                  + (P_t_1(i,k,j)-B_t_1(i,k,j))*(P_t_1(i,k,j)-B_t_1(i,k,j))   &amp;<a name='5796'>
                  + (P_c2a(i,k,j)-B_c2a(i,k,j))*(P_c2a(i,k,j)-B_c2a(i,k,j))<a name='5797'>
   enddo<a name='5798'>
   enddo<a name='5799'>
   enddo<a name='5800'>
<a name='5801'>
   do i=its,ite<a name='5802'>
   do j=jts,jte<a name='5803'>
      VAL_N=VAL_N +(P_mu(i,j)-B_mu(i,j))*(P_mu(i,j)-B_mu(i,j))     &amp;<a name='5804'>
                  +(P_muts(i,j)-B_muts(i,j))*(P_muts(i,j)-B_muts(i,j))<a name='5805'>
   enddo<a name='5806'>
   enddo<a name='5807'>
<a name='5808'>
#ifdef DM_PARALLEL<a name='5809'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='5810'>
                       comm, IERROR )<a name='5811'>
   VAL_N = nsum <a name='5812'>
#endif<a name='5813'>
<a name='5814'>
<a name='5815'>
      VAL_L=SAVE_L*ALPHA**2<a name='5816'>
      COEF=VAL_N/VAL_L<a name='5817'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='5818'>
         'g_calc_p_rho: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='5819'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='5820'>
   ENDDO<a name='5821'>
<a name='5822'>
<font color=#447700>!  ADJ test<a name='5823'></font>
<a name='5824'>
   FACTOR=0.1<a name='5825'>
   do i=ims,ime<a name='5826'>
   do k=kms,kme<a name='5827'>
   do j=jms,jme<a name='5828'>
      alt(i,k,j)=S_alt(i,k,j)<a name='5829'>
      t_2(i,k,j)=S_t_2(i,k,j)<a name='5830'>
      t_1(i,k,j)=S_t_1(i,k,j)<a name='5831'>
      c2a(i,k,j)=S_c2a(i,k,j)<a name='5832'>
<a name='5833'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='5834'>
      P_t_2(i,k,j)=FACTOR*S_t_2(i,k,j)<a name='5835'>
      P_t_1(i,k,j)=FACTOR*S_t_1(i,k,j)<a name='5836'>
      P_c2a(i,k,j)=FACTOR*S_c2a(i,k,j)<a name='5837'>
<a name='5838'>
      B_alt(i,k,j)=P_alt(i,k,j)<a name='5839'>
      B_t_2(i,k,j)=P_t_2(i,k,j)<a name='5840'>
      B_t_1(i,k,j)=P_t_1(i,k,j)<a name='5841'>
      B_c2a(i,k,j)=P_c2a(i,k,j)<a name='5842'>
   enddo<a name='5843'>
   enddo<a name='5844'>
   enddo<a name='5845'>
   do i=ims,ime<a name='5846'>
   do j=jms,jme<a name='5847'>
      mu(i,j)=S_mu(i,j)<a name='5848'>
      muts(i,j)=S_muts(i,j)<a name='5849'>
<a name='5850'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='5851'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='5852'>
<a name='5853'>
      B_mu(i,j)=P_mu(i,j)<a name='5854'>
      B_muts(i,j)=P_muts(i,j)<a name='5855'>
   enddo<a name='5856'>
   enddo<a name='5857'>
   do i=ims,ime<a name='5858'>
   do k=kms,kme<a name='5859'>
   do j=jms,jme<a name='5860'>
      ph(i,k,j)=S_ph(i,k,j)<a name='5861'>
      pm1(i,k,j)=S_pm1(i,k,j)<a name='5862'>
<a name='5863'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='5864'>
      P_pm1(i,k,j)=FACTOR*S_pm1(i,k,j)<a name='5865'>
<a name='5866'>
      B_ph(i,k,j)=P_ph(i,k,j)<a name='5867'>
      B_pm1(i,k,j)=P_pm1(i,k,j)<a name='5868'>
<a name='5869'>
      K_ph(i,k,j)=ph(i,k,j)<a name='5870'>
      K_pm1(i,k,j)=pm1(i,k,j)<a name='5871'>
   enddo<a name='5872'>
   enddo<a name='5873'>
   enddo<a name='5874'>
<a name='5875'>
   do i=ims,ime<a name='5876'>
   do k=kms,kme<a name='5877'>
   do j=jms,jme<a name='5878'>
      al(i,k,j)=S_al(i,k,j)<a name='5879'>
      p(i,k,j)=S_p(i,k,j)<a name='5880'>
<a name='5881'>
      P_al(i,k,j)=FACTOR*S_al(i,k,j)<a name='5882'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='5883'>
<a name='5884'>
      B_al(i,k,j)=P_al(i,k,j)<a name='5885'>
      B_p(i,k,j)=P_p(i,k,j)<a name='5886'>
   enddo<a name='5887'>
   enddo<a name='5888'>
   enddo<a name='5889'>
<a name='5890'>
<font color=#447700>!  TGL<a name='5891'></font>
<a name='5892'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_CALC_P_RHO'>g_calc_p_rho</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALC_P_RHO_2">( al, P_al, p, P_p, ph, P_ph, alt, P_alt, t_2, P_t_2, t_1, P_t_1, c2a, P_c2a, pm1, P_pm1, mu, P_mu, muts, &amp;<a name='5893'>
&amp;P_muts, znu, t0, rdnw, dnw, smdiv, non_hydrostatic, step, ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, &amp;<a name='5894'>
&amp;kte )<a name='5895'>
<a name='5896'>
   VAL_L=0.<a name='5897'>
   do i=its,ite<a name='5898'>
   do k=kts,kte<a name='5899'>
   do j=jts,jte<a name='5900'>
      VAL_L=VAL_L + P_al(i,k,j)*P_al(i,k,j) +P_p(i,k,j)*P_p(i,k,j)<a name='5901'>
   enddo<a name='5902'>
   enddo<a name='5903'>
   enddo<a name='5904'>
   do i=its,ite<a name='5905'>
   do k=kts,kte<a name='5906'>
   do j=jts,jte<a name='5907'>
      VAL_L=VAL_L + P_ph(i,k,j)*P_ph(i,k,j) + P_pm1(i,k,j)*P_pm1(i,k,j)<a name='5908'>
   enddo<a name='5909'>
   enddo<a name='5910'>
   enddo<a name='5911'>
<a name='5912'>
<a name='5913'>
   do i=its,ite<a name='5914'>
   do k=kts,kte<a name='5915'>
   do j=jts,jte<a name='5916'>
      VAL_L=VAL_L +P_alt(i,k,j)*B_alt(i,k,j)   &amp;<a name='5917'>
                  + P_t_2(i,k,j)*B_t_2(i,k,j)   &amp;<a name='5918'>
                  + P_t_1(i,k,j)*B_t_1(i,k,j)   &amp;<a name='5919'>
                  + P_c2a(i,k,j)*B_c2a(i,k,j)<a name='5920'>
   enddo<a name='5921'>
   enddo<a name='5922'>
   enddo<a name='5923'>
   do i=its,ite<a name='5924'>
   do j=jts,jte<a name='5925'>
      VAL_L=VAL_L  + P_mu(i,j)*B_mu(i,j)   &amp;<a name='5926'>
                  + P_muts(i,j)*B_muts(i,j)<a name='5927'>
   enddo<a name='5928'>
   enddo<a name='5929'>
<a name='5930'>
#ifdef DM_PARALLEL<a name='5931'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='5932'>
                       comm, IERROR )<a name='5933'>
   VAL_L = nsum <a name='5934'>
#endif<a name='5935'>
<a name='5936'>
<font color=#447700>!  ADJ<a name='5937'></font>
<a name='5938'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_ad.F.html#A_CALC_P_RHO'>a_calc_p_rho</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_CALC_P_RHO_1">( al, P_al, p, P_p, ph, P_ph, alt, P_alt, t_2, P_t_2, t_1, P_t_1, c2a, P_c2a, P_pm1, mu, P_mu, muts, P_muts,&amp;<a name='5939'>
&amp; znu, t0, rdnw, dnw, smdiv, non_hydrostatic, step, ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='5940'>
<a name='5941'>
   VAL_A=0.<a name='5942'>
   do i=its,ite<a name='5943'>
   do k=kts,kte<a name='5944'>
   do j=jts,jte<a name='5945'>
      VAL_A=VAL_A + P_alt(i,k,j)*B_alt(i,k,j)   &amp;<a name='5946'>
                  + P_t_2(i,k,j)*B_t_2(i,k,j)   &amp;<a name='5947'>
                  + P_t_1(i,k,j)*B_t_1(i,k,j)   &amp;<a name='5948'>
                  + P_c2a(i,k,j)*B_c2a(i,k,j)<a name='5949'>
   enddo<a name='5950'>
   enddo<a name='5951'>
   enddo<a name='5952'>
   do i=its,ite<a name='5953'>
   do j=jts,jte<a name='5954'>
      VAL_A=VAL_A + P_mu(i,j)*B_mu(i,j)   &amp;<a name='5955'>
                  + P_muts(i,j)*B_muts(i,j)<a name='5956'>
   enddo<a name='5957'>
   enddo<a name='5958'>
   do i=its,ite<a name='5959'>
   do k=kts,kte<a name='5960'>
   do j=jts,jte<a name='5961'>
      VAL_A=VAL_A + P_ph(i,k,j)*B_ph(i,k,j)   &amp;<a name='5962'>
                  + P_pm1(i,k,j)*B_pm1(i,k,j)<a name='5963'>
   enddo<a name='5964'>
   enddo<a name='5965'>
   enddo<a name='5966'>
<a name='5967'>
   do i=its,ite<a name='5968'>
   do k=kts,kte<a name='5969'>
   do j=jts,jte<a name='5970'>
      VAL_A=VAL_A + P_al(i,k,j)*P_al(i,k,j) +P_p(i,k,j)*P_p(i,k,j)<a name='5971'>
   enddo<a name='5972'>
   enddo<a name='5973'>
   enddo<a name='5974'>
<a name='5975'>
#ifdef DM_PARALLEL<a name='5976'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='5977'>
                       comm, IERROR )<a name='5978'>
   VAL_A = nsum <a name='5979'>
#endif<a name='5980'>
<a name='5981'>
   print*, '                '<a name='5982'>
   write(6,*) 'a_calc_p_rho: '<a name='5983'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='5984'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='5985'>
<a name='5986'>
<a name='5987'>
<font color=#447700>!  RECOVER<a name='5988'></font>
<a name='5989'>
   do i=ims,ime<a name='5990'>
   do k=kms,kme<a name='5991'>
   do j=jms,jme<a name='5992'>
      alt(i,k,j)=S_alt(i,k,j)<a name='5993'>
      t_2(i,k,j)=S_t_2(i,k,j)<a name='5994'>
      t_1(i,k,j)=S_t_1(i,k,j)<a name='5995'>
      c2a(i,k,j)=S_c2a(i,k,j)<a name='5996'>
   enddo<a name='5997'>
   enddo<a name='5998'>
   enddo<a name='5999'>
   do i=ims,ime<a name='6000'>
   do j=jms,jme<a name='6001'>
      mu(i,j)=S_mu(i,j)<a name='6002'>
      muts(i,j)=S_muts(i,j)<a name='6003'>
   enddo<a name='6004'>
   enddo<a name='6005'>
   do i=ims,ime<a name='6006'>
   do k=kms,kme<a name='6007'>
   do j=jms,jme<a name='6008'>
      ph(i,k,j)=S_ph(i,k,j)<a name='6009'>
      pm1(i,k,j)=S_pm1(i,k,j)<a name='6010'>
   enddo<a name='6011'>
   enddo<a name='6012'>
   enddo<a name='6013'>
<a name='6014'>
   do i=ims,ime<a name='6015'>
   do k=kms,kme<a name='6016'>
   do j=jms,jme<a name='6017'>
      al(i,k,j)=S_al(i,k,j)<a name='6018'>
      p(i,k,j)=S_p(i,k,j)<a name='6019'>
   enddo<a name='6020'>
   enddo<a name='6021'>
   enddo<a name='6022'>
<a name='6023'>
END SUBROUTINE t_calc_p_rho<a name='6024'>
<a name='6025'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='6026'></font>
<a name='6027'>
<A NAME='T_CALC_COEF_W'><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_COEF_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6028'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_calc_coef_w</font>( a,alpha,gamma,              &amp; <A href='../../call_to/T_CALC_COEF_W.html' TARGET='index'>1</A>,<A href='../../call_from/T_CALC_COEF_W.html' TARGET='index'>5</A><a name='6029'>
                        mut, cqw,                   &amp;<a name='6030'>
                        rdn, rdnw, c2a,             &amp;<a name='6031'>
                        dts, g, epssm,              &amp;<a name='6032'>
                        ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='6033'></font>
                        ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='6034'></font>
                        its,ite, jts,jte, kts,kte  )  <font color=#447700>! tile   dims<a name='6035'></font>
<a name='6036'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='6037'></font>
<a name='6038'>
<font color=#447700>!  passed in through the call<a name='6039'></font>
<a name='6040'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='6041'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='6042'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='6043'>
<a name='6044'>
<a name='6045'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)                :: c2a,  &amp;<a name='6046'>
                                                               cqw<a name='6047'>
<a name='6048'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)                :: alpha, &amp;<a name='6049'>
                                                               gamma, &amp;<a name='6050'>
                                                               a<a name='6051'>
<a name='6052'>
  REAL, DIMENSION(ims:ime, jms:jme)                         :: mut<a name='6053'>
<a name='6054'>
  REAL, DIMENSION(kms:kme),                   INTENT(IN   ) :: rdn,   &amp;<a name='6055'>
                                                               rdnw<a name='6056'>
<a name='6057'>
  REAL,                                       INTENT(IN   ) :: epssm, &amp;<a name='6058'>
                                                               dts,   &amp;<a name='6059'>
                                                               g<a name='6060'>
<a name='6061'>
<font color=#447700>!  Local stack data.<a name='6062'></font>
<a name='6063'>
  REAL, DIMENSION(ims:ime)                         :: cof<a name='6064'>
  REAL  :: b, c<a name='6065'>
<a name='6066'>
  INTEGER :: i, j, k, i_start, i_end, j_start, j_end, k_start, k_end<a name='6067'>
  INTEGER :: ij, ijp, ijm<a name='6068'>
<a name='6069'>
<font color=#447700>!  IN variables<a name='6070'></font>
<a name='6071'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)     :: S_c2a, S_cqw,P_c2a, P_cqw,B_c2a, B_cqw<a name='6072'>
  REAL, DIMENSION(ims:ime, jms:jme)              :: S_mut,P_mut,B_mut<a name='6073'>
<a name='6074'>
<font color=#447700>! INOUT variables<a name='6075'></font>
<a name='6076'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)  :: S_alpha,S_gamma,S_a,P_alpha,P_gamma,P_a,  &amp;<a name='6077'>
                                                 K_alpha,K_gamma,K_a,B_alpha,B_gamma,B_a<a name='6078'>
<a name='6079'>
   REAL :: SAVE_L, COEF, ALPHA_M, FACTOR, VAL_N, VAL_L, VAL_A<a name='6080'>
   INTEGER :: NT<a name='6081'>
<a name='6082'>
<font color=#447700>!TGL test<a name='6083'></font>
<a name='6084'>
   do i=ims,ime<a name='6085'>
   do k=kms,kme<a name='6086'>
   do j=jms,jme<a name='6087'>
      S_c2a(i,k,j)=c2a(i,k,j)<a name='6088'>
      S_cqw(i,k,j)=cqw(i,k,j)<a name='6089'>
<a name='6090'>
      P_c2a(i,k,j)=c2a(i,k,j)<a name='6091'>
      P_cqw(i,k,j)=cqw(i,k,j)<a name='6092'>
   enddo<a name='6093'>
   enddo<a name='6094'>
   enddo<a name='6095'>
   do i=ims,ime<a name='6096'>
   do j=jms,jme<a name='6097'>
      S_mut(i,j)=mut(i,j)<a name='6098'>
<a name='6099'>
      P_mut(i,j)=mut(i,j)<a name='6100'>
   enddo<a name='6101'>
   enddo<a name='6102'>
   do i=ims,ime<a name='6103'>
   do k=kms,kme<a name='6104'>
   do j=jms,jme<a name='6105'>
      S_alpha(i,k,j)=alpha(i,k,j)<a name='6106'>
      S_gamma(i,k,j)=gamma(i,k,j)<a name='6107'>
      S_a(i,k,j)=a(i,k,j)<a name='6108'>
<a name='6109'>
      P_alpha(i,k,j)=alpha(i,k,j)<a name='6110'>
      P_gamma(i,k,j)=gamma(i,k,j)<a name='6111'>
      P_a(i,k,j)=a(i,k,j)<a name='6112'>
<a name='6113'>
      K_alpha(i,k,j)=alpha(i,k,j)<a name='6114'>
      K_gamma(i,k,j)=gamma(i,k,j)<a name='6115'>
      K_a(i,k,j)=a(i,k,j)<a name='6116'>
   enddo<a name='6117'>
   enddo<a name='6118'>
   enddo<a name='6119'>
<a name='6120'>
<font color=#447700>!NLM<a name='6121'></font>
<a name='6122'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_COEF_W'>calc_coef_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_COEF_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_COEF_W_1">( a,alpha,gamma,              &amp;<a name='6123'>
                        mut, cqw,                   &amp;<a name='6124'>
                        rdn, rdnw, c2a,             &amp;<a name='6125'>
                        dts, g, epssm,              &amp;<a name='6126'>
                        ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='6127'></font>
                        ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='6128'></font>
                        its,ite, jts,jte, kts,kte  )  <font color=#447700>! tile   dims<a name='6129'></font>
<a name='6130'>
   do i=its,ite<a name='6131'>
   do k=kts,kte<a name='6132'>
   do j=jts,jte<a name='6133'>
      B_alpha(i,k,j)=alpha(i,k,j)<a name='6134'>
      B_gamma(i,k,j)=gamma(i,k,j)<a name='6135'>
      B_a(i,k,j)=a(i,k,j)<a name='6136'>
   enddo<a name='6137'>
   enddo<a name='6138'>
   enddo<a name='6139'>
<a name='6140'>
<font color=#447700>!  TCL<a name='6141'></font>
<a name='6142'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_CALC_COEF_W'>g_calc_coef_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_COEF_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALC_COEF_W_1">( K_a, P_a, K_alpha, P_alpha, K_gamma, P_gamma, mut, P_mut, cqw, P_cqw, rdn, rdnw, c2a, P_c2a, dts, g, epssm, &amp;<a name='6143'>
&amp;ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte )<a name='6144'>
<a name='6145'>
   SAVE_L=0.<a name='6146'>
   do i=its,ite<a name='6147'>
   do k=kts,kte<a name='6148'>
   do j=jts,jte<a name='6149'>
      SAVE_L=SAVE_L + P_alpha(i,k,j)*P_alpha(i,k,j)     &amp;<a name='6150'>
                    + P_gamma(i,k,j)*P_gamma(i,k,j)     &amp;<a name='6151'>
                    + P_a(i,k,j)*P_a(i,k,j)<a name='6152'>
   enddo<a name='6153'>
   enddo<a name='6154'>
   enddo<a name='6155'>
<a name='6156'>
#ifdef DM_PARALLEL<a name='6157'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='6158'>
                       comm, IERROR )<a name='6159'>
   SAVE_L = nsum<a name='6160'>
#endif<a name='6161'>
<a name='6162'>
   ALPHA_M=1.<a name='6163'>
   DO NT=1,11<a name='6164'>
      ALPHA_M=0.1*ALPHA_M<a name='6165'>
      FACTOR=1.+ALPHA_M<a name='6166'>
   do i=ims,ime<a name='6167'>
   do k=kms,kme<a name='6168'>
   do j=jms,jme<a name='6169'>
      P_c2a(i,k,j)=FACTOR*S_c2a(i,k,j)<a name='6170'>
      P_cqw(i,k,j)=FACTOR*S_cqw(i,k,j)<a name='6171'>
   enddo<a name='6172'>
   enddo<a name='6173'>
   enddo<a name='6174'>
   do i=ims,ime<a name='6175'>
   do j=jms,jme<a name='6176'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='6177'>
   enddo<a name='6178'>
   enddo<a name='6179'>
   do i=ims,ime<a name='6180'>
   do k=kms,kme<a name='6181'>
   do j=jms,jme<a name='6182'>
      P_alpha(i,k,j)=FACTOR*S_alpha(i,k,j)<a name='6183'>
      P_gamma(i,k,j)=FACTOR*S_gamma(i,k,j)<a name='6184'>
      P_a(i,k,j)=FACTOR*S_a(i,k,j)<a name='6185'>
   enddo<a name='6186'>
   enddo<a name='6187'>
   enddo<a name='6188'>
<a name='6189'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_COEF_W'>calc_coef_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_COEF_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_COEF_W_2">( P_a,P_alpha,P_gamma,              &amp;<a name='6190'>
                        P_mut, P_cqw,                   &amp;<a name='6191'>
                        rdn, rdnw, P_c2a,             &amp;<a name='6192'>
                        dts, g, epssm,              &amp;<a name='6193'>
                        ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='6194'></font>
                        ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='6195'></font>
                        its,ite, jts,jte, kts,kte  )  <font color=#447700>! tile   dims<a name='6196'></font>
<a name='6197'>
   VAL_N=0.<a name='6198'>
   do i=its,ite<a name='6199'>
   do k=kts,kte<a name='6200'>
   do j=jts,jte<a name='6201'>
      VAL_N=VAL_N + (P_alpha(i,k,j) -B_alpha(i,k,j))*(P_alpha(i,k,j) -B_alpha(i,k,j))    &amp;<a name='6202'>
                  + (P_gamma(i,k,j) -B_gamma(i,k,j))*(P_gamma(i,k,j) -B_gamma(i,k,j))    &amp;<a name='6203'>
                  + (P_a(i,k,j) -B_a(i,k,j))*(P_a(i,k,j) -B_a(i,k,j))<a name='6204'>
   enddo<a name='6205'>
   enddo<a name='6206'>
   enddo<a name='6207'>
<a name='6208'>
#ifdef DM_PARALLEL<a name='6209'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='6210'>
                       comm, IERROR )<a name='6211'>
   VAL_N = nsum <a name='6212'>
#endif<a name='6213'>
<a name='6214'>
      VAL_L=SAVE_L*ALPHA_M**2<a name='6215'>
      COEF=VAL_N/VAL_L<a name='6216'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='6217'>
         'g_calc_coef_w: ALPHA=',ALPHA_M,'  COEF=',COEF, &amp;<a name='6218'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='6219'>
   ENDDO<a name='6220'>
<a name='6221'>
<font color=#447700>!  ADJ test<a name='6222'></font>
<a name='6223'>
   FACTOR=0.1<a name='6224'>
   do i=ims,ime<a name='6225'>
   do k=kms,kme<a name='6226'>
   do j=jms,jme<a name='6227'>
      c2a(i,k,j)=S_c2a(i,k,j)<a name='6228'>
      cqw(i,k,j)=S_cqw(i,k,j)<a name='6229'>
<a name='6230'>
      P_c2a(i,k,j)=FACTOR*S_c2a(i,k,j)<a name='6231'>
      P_cqw(i,k,j)=FACTOR*S_cqw(i,k,j)<a name='6232'>
<a name='6233'>
      B_c2a(i,k,j)=P_c2a(i,k,j)<a name='6234'>
      B_cqw(i,k,j)=P_cqw(i,k,j)<a name='6235'>
   enddo<a name='6236'>
   enddo<a name='6237'>
   enddo<a name='6238'>
   do i=ims,ime<a name='6239'>
   do j=jms,jme<a name='6240'>
      mut(i,j)=S_mut(i,j)<a name='6241'>
<a name='6242'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='6243'>
<a name='6244'>
      B_mut(i,j)=P_mut(i,j)<a name='6245'>
   enddo<a name='6246'>
   enddo<a name='6247'>
   do i=ims,ime<a name='6248'>
   do k=kms,kme<a name='6249'>
   do j=jms,jme<a name='6250'>
      alpha(i,k,j)=S_alpha(i,k,j)<a name='6251'>
      gamma(i,k,j)=S_gamma(i,k,j)<a name='6252'>
      a(i,k,j)=S_a(i,k,j)<a name='6253'>
<a name='6254'>
      P_alpha(i,k,j)=FACTOR*S_alpha(i,k,j)<a name='6255'>
      P_gamma(i,k,j)=FACTOR*S_gamma(i,k,j)<a name='6256'>
      P_a(i,k,j)=FACTOR*S_a(i,k,j)<a name='6257'>
<a name='6258'>
      B_alpha(i,k,j)=P_alpha(i,k,j)<a name='6259'>
      B_gamma(i,k,j)=P_gamma(i,k,j)<a name='6260'>
      B_a(i,k,j)=P_a(i,k,j)<a name='6261'>
<a name='6262'>
      K_alpha(i,k,j)=alpha(i,k,j)<a name='6263'>
      K_gamma(i,k,j)=gamma(i,k,j)<a name='6264'>
      K_a(i,k,j)=a(i,k,j)<a name='6265'>
   enddo<a name='6266'>
   enddo<a name='6267'>
   enddo<a name='6268'>
<a name='6269'>
<font color=#447700>!  TGL<a name='6270'></font>
<a name='6271'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_CALC_COEF_W'>g_calc_coef_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_COEF_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALC_COEF_W_2">( a, P_a, alpha, P_alpha, gamma, P_gamma, mut, P_mut, cqw, P_cqw, rdn, rdnw, c2a, P_c2a, dts, g, epssm, &amp;<a name='6272'>
&amp;ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte )<a name='6273'>
<a name='6274'>
   VAL_L=0.<a name='6275'>
   do i=its,ite<a name='6276'>
   do k=kts,kte<a name='6277'>
   do j=jts,jte<a name='6278'>
      VAL_L=VAL_L + P_alpha(i,k,j)*P_alpha(i,k,j)     &amp;<a name='6279'>
                    + P_gamma(i,k,j)*P_gamma(i,k,j)     &amp;<a name='6280'>
                    + P_a(i,k,j)*P_a(i,k,j)<a name='6281'>
   enddo<a name='6282'>
   enddo<a name='6283'>
   enddo<a name='6284'>
<a name='6285'>
#ifdef DM_PARALLEL<a name='6286'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='6287'>
                       comm, IERROR )<a name='6288'>
   VAL_L = nsum <a name='6289'>
#endif<a name='6290'>
<a name='6291'>
   do i=ims,ime<a name='6292'>
   do k=kms,kme<a name='6293'>
   do j=jms,jme<a name='6294'>
      P_c2a(i,k,j)=0.0<a name='6295'>
      P_cqw(i,k,j)=0.0<a name='6296'>
   enddo<a name='6297'>
   enddo<a name='6298'>
   enddo<a name='6299'>
   do i=ims,ime<a name='6300'>
   do j=jms,jme<a name='6301'>
      P_mut(i,j)=0.0<a name='6302'>
   enddo<a name='6303'>
   enddo<a name='6304'>
<a name='6305'>
<font color=#447700>!  ADJ<a name='6306'></font>
<a name='6307'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_ad.F.html#A_CALC_COEF_W'>a_calc_coef_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_COEF_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_CALC_COEF_W_1">( K_a, P_a, K_alpha, P_alpha, K_gamma, P_gamma, mut, P_mut, cqw, P_cqw, rdn, rdnw, c2a, P_c2a, dts, g, epssm, &amp;<a name='6308'>
&amp;ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte )<a name='6309'>
<a name='6310'>
   VAL_A=0.<a name='6311'>
   do i=its,ite<a name='6312'>
   do k=kts,kte<a name='6313'>
   do j=jts,jte<a name='6314'>
      VAL_A=VAL_A + P_c2a(i,k,j)*B_c2a(i,k,j)    &amp;<a name='6315'>
                  + P_cqw(i,k,j)*B_cqw(i,k,j)<a name='6316'>
   enddo<a name='6317'>
   enddo<a name='6318'>
   enddo<a name='6319'>
   do i=its,ite<a name='6320'>
   do j=jts,jte<a name='6321'>
      VAL_A=VAL_A + P_mut(i,j)*B_mut(i,j) <a name='6322'>
   enddo<a name='6323'>
   enddo<a name='6324'>
   do i=its,ite<a name='6325'>
   do k=kts,kte<a name='6326'>
   do j=jts,jte<a name='6327'>
      VAL_A=VAL_A + P_alpha(i,k,j)*B_alpha(i,k,j)   &amp;<a name='6328'>
                  + P_gamma(i,k,j)*B_gamma(i,k,j)   &amp;<a name='6329'>
                  + P_a(i,k,j)*B_a(i,k,j)<a name='6330'>
   enddo<a name='6331'>
   enddo<a name='6332'>
   enddo<a name='6333'>
<a name='6334'>
#ifdef DM_PARALLEL<a name='6335'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='6336'>
                       comm, IERROR )<a name='6337'>
   VAL_A = nsum <a name='6338'>
#endif<a name='6339'>
<a name='6340'>
   print*, '                '<a name='6341'>
   write(6,*) 'a_calc_coef_w: '<a name='6342'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='6343'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='6344'>
<a name='6345'>
<a name='6346'>
<font color=#447700>!  RECOVER<a name='6347'></font>
<a name='6348'>
   do i=ims,ime<a name='6349'>
   do k=kms,kme<a name='6350'>
   do j=jms,jme<a name='6351'>
      c2a(i,k,j)=S_c2a(i,k,j)<a name='6352'>
      cqw(i,k,j)=S_cqw(i,k,j)<a name='6353'>
   enddo<a name='6354'>
   enddo<a name='6355'>
   enddo<a name='6356'>
   do i=ims,ime<a name='6357'>
   do j=jms,jme<a name='6358'>
      mut(i,j)=S_mut(i,j)<a name='6359'>
   enddo<a name='6360'>
   enddo<a name='6361'>
   do i=ims,ime<a name='6362'>
   do k=kms,kme<a name='6363'>
   do j=jms,jme<a name='6364'>
      alpha(i,k,j)=S_alpha(i,k,j)<a name='6365'>
      gamma(i,k,j)=S_gamma(i,k,j)<a name='6366'>
      a(i,k,j)=S_a(i,k,j)<a name='6367'>
   enddo<a name='6368'>
   enddo<a name='6369'>
   enddo<a name='6370'>
<a name='6371'>
END SUBROUTINE t_calc_coef_w<a name='6372'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='6373'></font>
<A NAME='T_ADVANCE_UV'><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_UV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6374'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_advance_uv</font> ( u, ru_tend, v, rv_tend,        &amp; <A href='../../call_to/T_ADVANCE_UV.html' TARGET='index'>1</A>,<A href='../../call_from/T_ADVANCE_UV.html' TARGET='index'>5</A><a name='6375'>
                        p, pb,                         &amp;<a name='6376'>
                        ph, php, alt, al, mu,          &amp;<a name='6377'>
                        muu, cqu, muv, cqv, mudf,      &amp;<a name='6378'>
                        rdx, rdy, dts,                 &amp;<a name='6379'>
                        cf1, cf2, cf3, fnm, fnp,       &amp;<a name='6380'>
                        emdiv,                         &amp;<a name='6381'>
                        rdnw, config_flags, spec_zone, &amp;<a name='6382'>
                        non_hydrostatic,               &amp;<a name='6383'>
                        ids, ide, jds, jde, kds, kde,  &amp;<a name='6384'>
                        ims, ime, jms, jme, kms, kme,  &amp;<a name='6385'>
                        its, ite, jts, jte, kts, kte  )<a name='6386'>
<a name='6387'>
      IMPLICIT NONE  <font color=#447700>! religion first<a name='6388'></font>
<a name='6389'>
<font color=#447700>! stuff coming in<a name='6390'></font>
<a name='6391'>
      TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='6392'>
<a name='6393'>
      LOGICAL, INTENT(IN   ) :: non_hydrostatic<a name='6394'>
<a name='6395'>
      INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='6396'>
      INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='6397'>
      INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='6398'>
      INTEGER,      INTENT(IN   )    :: spec_zone<a name='6399'>
<a name='6400'>
      REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),  &amp;<a name='6401'>
            INTENT(INOUT) ::                          &amp;<a name='6402'>
                                                  u,  &amp;<a name='6403'>
                                                  v<a name='6404'>
<a name='6405'>
      REAL, DIMENSION( ims:ime , kms:kme, jms:jme ), INTENT( IN) :: pb<a name='6406'>
      REAL, DIMENSION( ims:ime , kms:kme, jms:jme ) :: &amp;<a name='6407'>
                                             ru_tend, &amp;<a name='6408'>
                                             rv_tend, &amp;<a name='6409'>
                                             ph,      &amp;<a name='6410'>
                                             php,     &amp;<a name='6411'>
                                             p,       &amp;<a name='6412'>
                                             alt,     &amp;<a name='6413'>
                                             al,      &amp;<a name='6414'>
                                             cqu,     &amp;<a name='6415'>
                                             cqv<a name='6416'>
<a name='6417'>
<a name='6418'>
      REAL, DIMENSION( ims:ime , jms:jme )                   :: muu,  &amp;<a name='6419'>
                                                                muv,  &amp;<a name='6420'>
                                                                mu,   &amp;<a name='6421'>
                                                                mudf<a name='6422'>
<a name='6423'>
<a name='6424'>
      REAL, DIMENSION( kms:kme ),              INTENT(IN   ) :: fnm,    &amp;<a name='6425'>
                                                                fnp ,   &amp;<a name='6426'>
                                                                rdnw<a name='6427'>
<a name='6428'>
      REAL,                                    INTENT(IN   ) :: rdx,    &amp;<a name='6429'>
                                                                rdy,    &amp;<a name='6430'>
                                                                dts,    &amp;<a name='6431'>
                                            cf1,    &amp;<a name='6432'>
                                            cf2,    &amp;<a name='6433'>
                                        cf3,    &amp;<a name='6434'>
                                      emdiv<a name='6435'>
<a name='6436'>
<a name='6437'>
<font color=#447700>!  Local 3d array from the stack (note tile size)<a name='6438'></font>
<a name='6439'>
      REAL, DIMENSION (its:ite, kts:kte) :: dpn, dpxy<a name='6440'>
      REAL, DIMENSION (its:ite) :: mudf_xy<a name='6441'>
      REAL                      :: dx, dy<a name='6442'>
<a name='6443'>
      INTEGER :: i,j,k, i_start, i_end, j_start, j_end, k_start, k_end<a name='6444'>
      INTEGER :: i_endu, j_endv, k_endw<a name='6445'>
      INTEGER :: i_start_up, i_end_up, j_start_up, j_end_up<a name='6446'>
      INTEGER :: i_start_vp, i_end_vp, j_start_vp, j_end_vp<a name='6447'>
      INTEGER :: i_start_u_tend, i_end_u_tend, j_start_v_tend, j_end_v_tend<a name='6448'>
<a name='6449'>
<font color=#447700>!  IN variables<a name='6450'></font>
<a name='6451'>
      REAL, DIMENSION( ims:ime , kms:kme, jms:jme )  :: S_ru_tend, &amp;<a name='6452'>
                                                        S_rv_tend, &amp;<a name='6453'>
                                                        S_ph,      &amp;<a name='6454'>
                                                        S_php,     &amp;<a name='6455'>
                                                        S_p,       &amp;<a name='6456'>
                                                        S_alt,     &amp;<a name='6457'>
                                                        S_al,      &amp;<a name='6458'>
                                                        S_cqu,     &amp;<a name='6459'>
                                                        S_cqv<a name='6460'>
<a name='6461'>
      REAL, DIMENSION( ims:ime , kms:kme, jms:jme )  :: P_ru_tend, &amp;<a name='6462'>
                                                        P_rv_tend, &amp;<a name='6463'>
                                                        P_ph,      &amp;<a name='6464'>
                                                        P_php,     &amp;<a name='6465'>
                                                        P_p,       &amp;<a name='6466'>
                                                        P_alt,     &amp;<a name='6467'>
                                                        P_al,      &amp;<a name='6468'>
                                                        P_cqu,     &amp;<a name='6469'>
                                                        P_cqv<a name='6470'>
<a name='6471'>
      REAL, DIMENSION( ims:ime , kms:kme, jms:jme )  :: B_ru_tend, &amp;<a name='6472'>
                                                        B_rv_tend, &amp;<a name='6473'>
                                                        B_ph,      &amp;<a name='6474'>
                                                        B_php,     &amp;<a name='6475'>
                                                        B_p,       &amp;<a name='6476'>
                                                        B_alt,     &amp;<a name='6477'>
                                                        B_al,      &amp;<a name='6478'>
                                                        B_cqu,     &amp;<a name='6479'>
                                                        B_cqv<a name='6480'>
<a name='6481'>
      REAL, DIMENSION( ims:ime , jms:jme )           :: S_muu,  &amp;<a name='6482'>
                                                        S_muv,  &amp;<a name='6483'>
                                                        S_mu,   &amp;<a name='6484'>
                                                        S_mudf<a name='6485'>
      REAL, DIMENSION( ims:ime , jms:jme )           :: P_muu,  &amp;<a name='6486'>
                                                        P_muv,  &amp;<a name='6487'>
                                                        P_mu,   &amp;<a name='6488'>
                                                        P_mudf<a name='6489'>
      REAL, DIMENSION( ims:ime , jms:jme )           :: B_muu,  &amp;<a name='6490'>
                                                        B_muv,  &amp;<a name='6491'>
                                                        B_mu,   &amp;<a name='6492'>
                                                        B_mudf<a name='6493'>
<a name='6494'>
<a name='6495'>
<font color=#447700>!  INOUT variables<a name='6496'></font>
<a name='6497'>
      REAL, DIMENSION( ims:ime , kms:kme, jms:jme )  :: S_u, S_v,P_u, P_v,K_u, K_v,B_u, B_v<a name='6498'>
<a name='6499'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='6500'>
   INTEGER :: NT<a name='6501'>
<a name='6502'>
<font color=#447700>!TGL test<a name='6503'></font>
<a name='6504'>
   do i=ims,ime<a name='6505'>
   do k=kms,kme<a name='6506'>
   do j=jms,jme<a name='6507'>
      S_ru_tend(i,k,j)=ru_tend(i,k,j)<a name='6508'>
      S_rv_tend(i,k,j)=rv_tend(i,k,j)<a name='6509'>
      S_ph(i,k,j)=ph(i,k,j)<a name='6510'>
      S_php(i,k,j)=php(i,k,j)<a name='6511'>
      S_p(i,k,j)=p(i,k,j)<a name='6512'>
      S_alt(i,k,j)=alt(i,k,j)<a name='6513'>
      S_al(i,k,j)=al(i,k,j)<a name='6514'>
      S_cqu(i,k,j)=cqu(i,k,j)<a name='6515'>
      S_cqv(i,k,j)=cqv(i,k,j)<a name='6516'>
<a name='6517'>
      P_ru_tend(i,k,j)=ru_tend(i,k,j)<a name='6518'>
      P_rv_tend(i,k,j)=rv_tend(i,k,j)<a name='6519'>
      P_ph(i,k,j)=ph(i,k,j)<a name='6520'>
      P_php(i,k,j)=php(i,k,j)<a name='6521'>
      P_p(i,k,j)=p(i,k,j)<a name='6522'>
      P_alt(i,k,j)=alt(i,k,j)<a name='6523'>
      P_al(i,k,j)=al(i,k,j)<a name='6524'>
      P_cqu(i,k,j)=cqu(i,k,j)<a name='6525'>
      P_cqv(i,k,j)=cqv(i,k,j)<a name='6526'>
   enddo<a name='6527'>
   enddo<a name='6528'>
   enddo<a name='6529'>
   do i=ims,ime<a name='6530'>
   do j=jms,jme<a name='6531'>
      S_muu(i,j)=muu(i,j)<a name='6532'>
      S_muv(i,j)=muv(i,j)<a name='6533'>
      S_mu(i,j)=mu(i,j)<a name='6534'>
      S_mudf(i,j)=mudf(i,j)<a name='6535'>
<a name='6536'>
      P_muu(i,j)=muu(i,j)<a name='6537'>
      P_muv(i,j)=muv(i,j)<a name='6538'>
      P_mu(i,j)=mu(i,j)<a name='6539'>
      P_mudf(i,j)=mudf(i,j)<a name='6540'>
   enddo<a name='6541'>
   enddo<a name='6542'>
   do i=ims,ime<a name='6543'>
   do k=kms,kme<a name='6544'>
   do j=jms,jme<a name='6545'>
      S_u(i,k,j)=u(i,k,j)<a name='6546'>
      S_v(i,k,j)=v(i,k,j)<a name='6547'>
<a name='6548'>
      P_u(i,k,j)=u(i,k,j)<a name='6549'>
      P_v(i,k,j)=v(i,k,j)<a name='6550'>
<a name='6551'>
      K_u(i,k,j)=u(i,k,j)<a name='6552'>
      K_v(i,k,j)=v(i,k,j)<a name='6553'>
   enddo<a name='6554'>
   enddo<a name='6555'>
   enddo<a name='6556'>
<a name='6557'>
<font color=#447700>!NLM<a name='6558'></font>
<a name='6559'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_UV'>advance_uv</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_UV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_UV_1"> ( u, ru_tend, v, rv_tend,        &amp;<a name='6560'>
                        p, pb,                         &amp;<a name='6561'>
                        ph, php, alt, al, mu,          &amp;<a name='6562'>
                        muu, cqu, muv, cqv, mudf,      &amp;<a name='6563'>
                        rdx, rdy, dts,                 &amp;<a name='6564'>
                        cf1, cf2, cf3, fnm, fnp,       &amp;<a name='6565'>
                        emdiv,                         &amp;<a name='6566'>
                        rdnw, config_flags, spec_zone, &amp;<a name='6567'>
                        non_hydrostatic,               &amp;<a name='6568'>
                        ids, ide, jds, jde, kds, kde,  &amp;<a name='6569'>
                        ims, ime, jms, jme, kms, kme,  &amp;<a name='6570'>
                        its, ite, jts, jte, kts, kte  )<a name='6571'>
<a name='6572'>
   do i=its,ite<a name='6573'>
   do k=kts,kte<a name='6574'>
   do j=jts,jte<a name='6575'>
      B_u(i,k,j)=u(i,k,j)<a name='6576'>
      B_v(i,k,j)=v(i,k,j)<a name='6577'>
   enddo<a name='6578'>
   enddo<a name='6579'>
   enddo<a name='6580'>
<a name='6581'>
<font color=#447700>!  TCL<a name='6582'></font>
<a name='6583'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_ADVANCE_UV'>g_advance_uv</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_UV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_ADVANCE_UV_1">( K_u, P_u, ru_tend, P_ru_tend, K_v, P_v, rv_tend, P_rv_tend, p, P_p, pb, ph, P_ph, php, P_php, alt, P_alt, al, &amp;<a name='6584'>
&amp;P_al, mu, P_mu, muu, P_muu, cqu, P_cqu, muv, P_muv, cqv, P_cqv, mudf, P_mudf, rdx, rdy, dts, cf1, cf2, cf3, fnm, fnp, emdiv, rdnw,&amp;<a name='6585'>
&amp; config_flags, spec_zone, non_hydrostatic, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='6586'>
<a name='6587'>
   SAVE_L=0.<a name='6588'>
   do i=its,ite<a name='6589'>
   do k=kts,kte<a name='6590'>
   do j=jts,jte<a name='6591'>
      SAVE_L=SAVE_L + P_u(i,k,j)*P_u(i,k,j)    &amp;<a name='6592'>
                    + P_v(i,k,j)*P_v(i,k,j)<a name='6593'>
   enddo<a name='6594'>
   enddo<a name='6595'>
   enddo<a name='6596'>
<a name='6597'>
#ifdef DM_PARALLEL<a name='6598'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='6599'>
                       comm, IERROR )<a name='6600'>
   SAVE_L = nsum <a name='6601'>
#endif<a name='6602'>
<a name='6603'>
   ALPHA=1.<a name='6604'>
   DO NT=1,11<a name='6605'>
      ALPHA=0.1*ALPHA<a name='6606'>
      FACTOR=1.+ALPHA<a name='6607'>
   do i=ims,ime<a name='6608'>
   do k=kms,kme<a name='6609'>
   do j=jms,jme<a name='6610'>
      P_ru_tend(i,k,j)=FACTOR*S_ru_tend(i,k,j)<a name='6611'>
      P_rv_tend(i,k,j)=FACTOR*S_rv_tend(i,k,j)<a name='6612'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='6613'>
      P_php(i,k,j)=FACTOR*S_php(i,k,j)<a name='6614'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='6615'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='6616'>
      P_al(i,k,j)=FACTOR*S_al(i,k,j)<a name='6617'>
      P_cqu(i,k,j)=FACTOR*S_cqu(i,k,j)<a name='6618'>
      P_cqv(i,k,j)=FACTOR*S_cqv(i,k,j)<a name='6619'>
   enddo<a name='6620'>
   enddo<a name='6621'>
   enddo<a name='6622'>
   do i=ims,ime<a name='6623'>
   do j=jms,jme<a name='6624'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='6625'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='6626'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='6627'>
      P_mudf(i,j)=FACTOR*S_mudf(i,j)<a name='6628'>
   enddo<a name='6629'>
   enddo<a name='6630'>
   do i=ims,ime<a name='6631'>
   do k=kms,kme<a name='6632'>
   do j=jms,jme<a name='6633'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='6634'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='6635'>
   enddo<a name='6636'>
   enddo<a name='6637'>
   enddo<a name='6638'>
<a name='6639'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_UV'>advance_uv</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_UV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_UV_2"> ( P_u, P_ru_tend, P_v, P_rv_tend,        &amp;<a name='6640'>
                        P_p, pb,                         &amp;<a name='6641'>
                        P_ph, P_php, P_alt, P_al, P_mu,          &amp;<a name='6642'>
                        P_muu, P_cqu, P_muv, P_cqv, P_mudf,      &amp;<a name='6643'>
                        rdx, rdy, dts,                 &amp;<a name='6644'>
                        cf1, cf2, cf3, fnm, fnp,       &amp;<a name='6645'>
                        emdiv,                         &amp;<a name='6646'>
                        rdnw, config_flags, spec_zone, &amp;<a name='6647'>
                        non_hydrostatic,               &amp;<a name='6648'>
                        ids, ide, jds, jde, kds, kde,  &amp;<a name='6649'>
                        ims, ime, jms, jme, kms, kme,  &amp;<a name='6650'>
                        its, ite, jts, jte, kts, kte  )<a name='6651'>
<a name='6652'>
      VAL_N=0.<a name='6653'>
      do i=its,ite<a name='6654'>
      do k=kts,kte<a name='6655'>
      do j=jts,jte<a name='6656'>
         VAL_N=VAL_N+(P_u(i,k,j)- B_u(i,k,j))*(P_u(i,k,j)- B_u(i,k,j))       &amp;<a name='6657'>
                    +(P_v(i,k,j)- B_v(i,k,j))*(P_v(i,k,j)- B_v(i,k,j)) <a name='6658'>
      enddo<a name='6659'>
      enddo<a name='6660'>
      enddo<a name='6661'>
<a name='6662'>
#ifdef DM_PARALLEL<a name='6663'>
      call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='6664'>
                          comm, IERROR )<a name='6665'>
      VAL_N = nsum <a name='6666'>
#endif<a name='6667'>
<a name='6668'>
      VAL_L=SAVE_L*ALPHA**2<a name='6669'>
      COEF=VAL_N/VAL_L<a name='6670'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='6671'>
         'g_advance_uv: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='6672'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='6673'>
   ENDDO<a name='6674'>
<a name='6675'>
<font color=#447700>!  ADJ test<a name='6676'></font>
<a name='6677'>
   FACTOR=0.1<a name='6678'>
   do i=ims,ime<a name='6679'>
   do k=kms,kme<a name='6680'>
   do j=jms,jme<a name='6681'>
      ru_tend(i,k,j)=S_ru_tend(i,k,j)<a name='6682'>
      rv_tend(i,k,j)=S_rv_tend(i,k,j)<a name='6683'>
      ph(i,k,j)=S_ph(i,k,j)<a name='6684'>
      php(i,k,j)=S_php(i,k,j)<a name='6685'>
      p(i,k,j)=S_p(i,k,j)<a name='6686'>
      alt(i,k,j)=S_alt(i,k,j)<a name='6687'>
      al(i,k,j)=S_al(i,k,j)<a name='6688'>
      cqu(i,k,j)=S_cqu(i,k,j)<a name='6689'>
      cqv(i,k,j)=S_cqv(i,k,j)<a name='6690'>
<a name='6691'>
      P_ru_tend(i,k,j)=FACTOR*S_ru_tend(i,k,j)<a name='6692'>
      P_rv_tend(i,k,j)=FACTOR*S_rv_tend(i,k,j)<a name='6693'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='6694'>
      P_php(i,k,j)=FACTOR*S_php(i,k,j)<a name='6695'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='6696'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='6697'>
      P_al(i,k,j)=FACTOR*S_al(i,k,j)<a name='6698'>
      P_cqu(i,k,j)=FACTOR*S_cqu(i,k,j)<a name='6699'>
      P_cqv(i,k,j)=FACTOR*S_cqv(i,k,j)<a name='6700'>
<a name='6701'>
      B_ru_tend(i,k,j)=P_ru_tend(i,k,j)<a name='6702'>
      B_rv_tend(i,k,j)=P_rv_tend(i,k,j)<a name='6703'>
      B_ph(i,k,j)=P_ph(i,k,j)<a name='6704'>
      B_php(i,k,j)=P_php(i,k,j)<a name='6705'>
      B_p(i,k,j)=P_p(i,k,j)<a name='6706'>
      B_alt(i,k,j)=P_alt(i,k,j)<a name='6707'>
      B_al(i,k,j)=P_al(i,k,j)<a name='6708'>
      B_cqu(i,k,j)=P_cqu(i,k,j)<a name='6709'>
      B_cqv(i,k,j)=P_cqv(i,k,j)<a name='6710'>
   enddo<a name='6711'>
   enddo<a name='6712'>
   enddo<a name='6713'>
   do i=ims,ime<a name='6714'>
   do j=jms,jme<a name='6715'>
      muu(i,j)=S_muu(i,j)<a name='6716'>
      muv(i,j)=S_muv(i,j)<a name='6717'>
      mu(i,j)=S_mu(i,j)<a name='6718'>
      mudf(i,j)=S_mudf(i,j)<a name='6719'>
<a name='6720'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='6721'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='6722'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='6723'>
      P_mudf(i,j)=FACTOR*S_mudf(i,j)<a name='6724'>
<a name='6725'>
      B_muu(i,j)=P_muu(i,j)<a name='6726'>
      B_muv(i,j)=P_muv(i,j)<a name='6727'>
      B_mu(i,j)=P_mu(i,j)<a name='6728'>
      B_mudf(i,j)=P_mudf(i,j)<a name='6729'>
   enddo<a name='6730'>
   enddo<a name='6731'>
   do i=ims,ime<a name='6732'>
   do k=kms,kme<a name='6733'>
   do j=jms,jme<a name='6734'>
      u(i,k,j)=S_u(i,k,j)<a name='6735'>
      v(i,k,j)=S_v(i,k,j)<a name='6736'>
<a name='6737'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='6738'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='6739'>
<a name='6740'>
      B_u(i,k,j)=P_u(i,k,j)<a name='6741'>
      B_v(i,k,j)=P_v(i,k,j)<a name='6742'>
   enddo<a name='6743'>
   enddo<a name='6744'>
   enddo<a name='6745'>
<a name='6746'>
<font color=#447700>!  TGL<a name='6747'></font>
<a name='6748'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_ADVANCE_UV'>g_advance_uv</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_UV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_ADVANCE_UV_2">( u, P_u, ru_tend, P_ru_tend, v, P_v, rv_tend, P_rv_tend, p, P_p, pb, ph, P_ph, php, P_php, alt, P_alt, al, &amp;<a name='6749'>
&amp;P_al, mu, P_mu, muu, P_muu, cqu, P_cqu, muv, P_muv, cqv, P_cqv, mudf, P_mudf, rdx, rdy, dts, cf1, cf2, cf3, fnm, fnp, emdiv, rdnw,&amp;<a name='6750'>
&amp; config_flags, spec_zone, non_hydrostatic, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='6751'>
<a name='6752'>
   VAL_L=0.<a name='6753'>
   do i=its,ite<a name='6754'>
   do k=kts,kte<a name='6755'>
   do j=jts,jte<a name='6756'>
      VAL_L=VAL_L +P_u(i,k,j)*P_u(i,k,j)    &amp;<a name='6757'>
                    + P_v(i,k,j)*P_v(i,k,j)<a name='6758'>
   enddo<a name='6759'>
   enddo<a name='6760'>
   enddo<a name='6761'>
<a name='6762'>
#ifdef DM_PARALLEL<a name='6763'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='6764'>
                       comm, IERROR )<a name='6765'>
   VAL_L = nsum <a name='6766'>
#endif<a name='6767'>
<a name='6768'>
   do i=ims,ime<a name='6769'>
   do k=kms,kme<a name='6770'>
   do j=jms,jme<a name='6771'>
      P_ru_tend(i,k,j)=0.0<a name='6772'>
      P_rv_tend(i,k,j)=0.0<a name='6773'>
      P_ph(i,k,j)=0.0<a name='6774'>
      P_php(i,k,j)=0.0<a name='6775'>
      P_p(i,k,j)=0.0<a name='6776'>
      P_alt(i,k,j)=0.0<a name='6777'>
      P_al(i,k,j)=0.0<a name='6778'>
      P_cqu(i,k,j)=0.0<a name='6779'>
      P_cqv(i,k,j)=0.0<a name='6780'>
   enddo<a name='6781'>
   enddo<a name='6782'>
   enddo<a name='6783'>
   do i=ims,ime<a name='6784'>
   do j=jms,jme<a name='6785'>
      P_muu(i,j)=0.0<a name='6786'>
      P_muv(i,j)=0.0<a name='6787'>
      P_mu(i,j)=0.0<a name='6788'>
      P_mudf(i,j)=0.0<a name='6789'>
   enddo<a name='6790'>
   enddo<a name='6791'>
<a name='6792'>
<font color=#447700>!  ADJ<a name='6793'></font>
<a name='6794'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_ad.F.html#A_ADVANCE_UV'>a_advance_uv</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_UV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_ADVANCE_UV_1">( P_u, P_ru_tend, P_v, P_rv_tend, p, P_p, pb, ph, P_ph, php, P_php, alt, P_alt, al, P_al, mu, P_mu, muu, &amp;<a name='6795'>
&amp;P_muu, cqu, P_cqu, muv, P_muv, cqv, P_cqv, P_mudf, rdx, rdy, dts, cf1, cf2, cf3, fnm, fnp, emdiv, rdnw, config_flags, spec_zone, &amp;<a name='6796'>
&amp;non_hydrostatic, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='6797'>
<a name='6798'>
   VAL_A=0.<a name='6799'>
   do i=its,ite<a name='6800'>
   do k=kts,kte<a name='6801'>
   do j=jts,jte<a name='6802'>
      VAL_A=VAL_A + P_ru_tend(i,k,j)*B_ru_tend(i,k,j)  &amp;<a name='6803'>
                  + P_rv_tend(i,k,j)*B_rv_tend(i,k,j)  &amp;<a name='6804'>
                  + P_ph(i,k,j)*B_ph(i,k,j)            &amp;<a name='6805'>
                  + P_php(i,k,j)*B_php(i,k,j)          &amp;<a name='6806'>
                  + P_p(i,k,j)*B_p(i,k,j)              &amp;<a name='6807'>
                  + P_alt(i,k,j)*B_alt(i,k,j)          &amp;<a name='6808'>
                  + P_al(i,k,j)*B_al(i,k,j)            &amp;<a name='6809'>
                  + P_cqu(i,k,j)*B_cqu(i,k,j)          &amp;<a name='6810'>
                  + P_cqv(i,k,j)*B_cqv(i,k,j)          <a name='6811'>
   enddo<a name='6812'>
   enddo<a name='6813'>
   enddo<a name='6814'>
   do i=its,ite<a name='6815'>
   do j=jts,jte<a name='6816'>
      VAL_A=VAL_A + P_mu(i,j)*B_mu(i,j)      &amp;<a name='6817'>
                  + P_mudf(i,j)*B_mudf(i,j)  &amp;<a name='6818'>
                  + P_muu(i,j)*B_muu(i,j)    &amp;<a name='6819'>
                  + P_muv(i,j)*B_muv(i,j)<a name='6820'>
   enddo<a name='6821'>
   enddo<a name='6822'>
   do i=its,ite<a name='6823'>
   do k=kts,kte<a name='6824'>
   do j=jts,jte<a name='6825'>
      VAL_A=VAL_A + P_u(i,k,j)*B_u(i,k,j)    &amp;<a name='6826'>
                  + P_v(i,k,j)*B_v(i,k,j)<a name='6827'>
   enddo<a name='6828'>
   enddo<a name='6829'>
   enddo<a name='6830'>
<a name='6831'>
#ifdef DM_PARALLEL<a name='6832'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='6833'>
                       comm, IERROR )<a name='6834'>
   VAL_A = nsum <a name='6835'>
#endif<a name='6836'>
<a name='6837'>
   print*, '                '<a name='6838'>
   write(6,*) 'a_advance_uv: '<a name='6839'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='6840'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='6841'>
<a name='6842'>
<font color=#447700>!  RECOVER<a name='6843'></font>
<a name='6844'>
   do i=ims,ime<a name='6845'>
   do k=kms,kme<a name='6846'>
   do j=jms,jme<a name='6847'>
      ru_tend(i,k,j)=S_ru_tend(i,k,j)<a name='6848'>
      rv_tend(i,k,j)=S_rv_tend(i,k,j)<a name='6849'>
      ph(i,k,j)=S_ph(i,k,j)<a name='6850'>
      php(i,k,j)=S_php(i,k,j)<a name='6851'>
      p(i,k,j)=S_p(i,k,j)<a name='6852'>
      alt(i,k,j)=S_alt(i,k,j)<a name='6853'>
      al(i,k,j)=S_al(i,k,j)<a name='6854'>
      cqu(i,k,j)=S_cqu(i,k,j)<a name='6855'>
      cqv(i,k,j)=S_cqv(i,k,j)<a name='6856'>
   enddo<a name='6857'>
   enddo<a name='6858'>
   enddo<a name='6859'>
   do i=ims,ime<a name='6860'>
   do j=jms,jme<a name='6861'>
      muu(i,j)=S_muu(i,j)<a name='6862'>
      muv(i,j)=S_muv(i,j)<a name='6863'>
      mu(i,j)=S_mu(i,j)<a name='6864'>
      mudf(i,j)=S_mudf(i,j)<a name='6865'>
   enddo<a name='6866'>
   enddo<a name='6867'>
   do i=ims,ime<a name='6868'>
   do k=kms,kme<a name='6869'>
   do j=jms,jme<a name='6870'>
      u(i,k,j)=S_u(i,k,j)<a name='6871'>
      v(i,k,j)=S_v(i,k,j)<a name='6872'>
   enddo<a name='6873'>
   enddo<a name='6874'>
   enddo<a name='6875'>
<a name='6876'>
END SUBROUTINE t_advance_uv<a name='6877'>
<a name='6878'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='6879'></font>
<A NAME='T_ADVANCE_MU_T'><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_MU_T' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6880'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_advance_mu_t</font>( ww, ww_1, u, u_1, v, v_1,            &amp; <A href='../../call_to/T_ADVANCE_MU_T.html' TARGET='index'>1</A>,<A href='../../call_from/T_ADVANCE_MU_T.html' TARGET='index'>5</A><a name='6881'>
                         mu, mut, muave, muts, muu, muv,      &amp;<a name='6882'>
                         mudf, uam, vam, wwam, t, t_1,        &amp;<a name='6883'>
                         t_ave, ft, mu_tend,                  &amp;<a name='6884'>
                         rdx, rdy, dts, epssm,                &amp;<a name='6885'>
                         dnw, fnm, fnp, rdnw,                 &amp;<a name='6886'>
                         msfu, msfv, msft,                    &amp;<a name='6887'>
                         step, config_flags,                  &amp;<a name='6888'>
                         ids, ide, jds, jde, kds, kde,        &amp;<a name='6889'>
                         ims, ime, jms, jme, kms, kme,        &amp;<a name='6890'>
                         its, ite, jts, jte, kts, kte        )<a name='6891'>
<a name='6892'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='6893'></font>
<a name='6894'>
<font color=#447700>! stuff coming in<a name='6895'></font>
<a name='6896'>
  TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='6897'>
<a name='6898'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='6899'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='6900'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='6901'>
<a name='6902'>
  INTEGER,      INTENT(IN   )    :: step<a name='6903'>
<a name='6904'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ) ::  &amp;<a name='6905'>
                                              u,   &amp;<a name='6906'>
                                              v,   &amp;<a name='6907'>
                                              u_1, &amp;<a name='6908'>
                                              v_1, &amp;<a name='6909'>
                                              t_1, &amp;<a name='6910'>
                                              ft<a name='6911'>
<a name='6912'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),      &amp;<a name='6913'>
            INTENT(INOUT) ::                          &amp;<a name='6914'>
                                              ww,     &amp;<a name='6915'>
                                              ww_1,   &amp;<a name='6916'>
                                              t,      &amp;<a name='6917'>
                                              t_ave,  &amp;<a name='6918'>
                                              uam,    &amp;<a name='6919'>
                                              vam,    &amp;<a name='6920'>
                                              wwam<a name='6921'>
<a name='6922'>
  REAL, DIMENSION( ims:ime , jms:jme )                   :: muu,  &amp;<a name='6923'>
                                                            muv,  &amp;<a name='6924'>
                                                            mut,  &amp;<a name='6925'>
                                                            mu_tend<a name='6926'>
<a name='6927'>
  REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(IN   ) :: msfu, &amp;<a name='6928'>
                                                            msfv, &amp;<a name='6929'>
                                                            msft<a name='6930'>
<a name='6931'>
  REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(  OUT) :: muave, &amp;<a name='6932'>
                                                            muts,  &amp;<a name='6933'>
                                                            mudf<a name='6934'>
<a name='6935'>
  REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(INOUT) :: mu<a name='6936'>
<a name='6937'>
  REAL, DIMENSION( kms:kme ),              INTENT(IN   ) :: fnm,    &amp;<a name='6938'>
                                                            fnp,    &amp;<a name='6939'>
                                                            dnw,    &amp;<a name='6940'>
                                                            rdnw<a name='6941'>
<a name='6942'>
  REAL,                                    INTENT(IN   ) :: rdx,    &amp;<a name='6943'>
                                                            rdy,    &amp;<a name='6944'>
                                                            dts,    &amp;<a name='6945'>
                                                            epssm<a name='6946'>
<a name='6947'>
<font color=#447700>!  Local 3d array from the stack (note tile size)<a name='6948'></font>
<a name='6949'>
  REAL, DIMENSION (its:ite, kts:kte) :: wdtn, dvdxi<a name='6950'>
  REAL, DIMENSION (its:ite) :: dmdt<a name='6951'>
<a name='6952'>
  INTEGER :: i,j,k, i_start, i_end, j_start, j_end, k_start, k_end<a name='6953'>
  INTEGER :: i_endu, j_endv<a name='6954'>
  REAL    :: acc<a name='6955'>
<a name='6956'>
<font color=#447700>!  IN variables<a name='6957'></font>
<a name='6958'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ) :: &amp;<a name='6959'>
                                              S_u,   &amp;<a name='6960'>
                                              S_v,   &amp;<a name='6961'>
                                              S_u_1, &amp;<a name='6962'>
                                              S_v_1, &amp;<a name='6963'>
                                              S_t_1, &amp;<a name='6964'>
                                              S_ft , &amp;<a name='6965'>
                                              P_u,   &amp;<a name='6966'>
                                              P_v,   &amp;<a name='6967'>
                                              P_u_1, &amp;<a name='6968'>
                                              P_v_1, &amp;<a name='6969'>
                                              P_t_1, &amp;<a name='6970'>
                                              P_ft , &amp;<a name='6971'>
                                              B_u,   &amp;<a name='6972'>
                                              B_v,   &amp;<a name='6973'>
                                              B_u_1, &amp;<a name='6974'>
                                              B_v_1, &amp;<a name='6975'>
                                              B_t_1, &amp;<a name='6976'>
                                              B_ft , &amp;<a name='6977'>
<a name='6978'>
                                              K_u,   &amp;<a name='6979'>
                                              K_v,   &amp;<a name='6980'>
                                              K_u_1, &amp;<a name='6981'>
                                              K_v_1, &amp;<a name='6982'>
                                              K_t_1, &amp;<a name='6983'>
                                              K_ft<a name='6984'>
<a name='6985'>
  REAL, DIMENSION( ims:ime , jms:jme )                   :: S_muu,  &amp;<a name='6986'>
                                                            S_muv,  &amp;<a name='6987'>
                                                            S_mut,  &amp;<a name='6988'>
                                                            S_mu_tend<a name='6989'>
  REAL, DIMENSION( ims:ime , jms:jme )                   :: P_muu,  &amp;<a name='6990'>
                                                            P_muv,  &amp;<a name='6991'>
                                                            P_mut,  &amp;<a name='6992'>
                                                            P_mu_tend<a name='6993'>
  REAL, DIMENSION( ims:ime , jms:jme )                   :: B_muu,  &amp;<a name='6994'>
                                                            B_muv,  &amp;<a name='6995'>
                                                            B_mut,  &amp;<a name='6996'>
                                                            B_mu_tend<a name='6997'>
<a name='6998'>
  REAL, DIMENSION( ims:ime , jms:jme )                   :: K_muu,  &amp;<a name='6999'>
                                                            K_muv,  &amp;<a name='7000'>
                                                            K_mut,  &amp;<a name='7001'>
                                                            K_mu_tend<a name='7002'>
<font color=#447700>! INOUT variables<a name='7003'></font>
<a name='7004'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ) ::    &amp;<a name='7005'>
                                              S_ww,     &amp;<a name='7006'>
                                              S_ww_1,   &amp;<a name='7007'>
                                              S_t,      &amp;<a name='7008'>
                                              S_t_ave,  &amp;<a name='7009'>
                                              P_ww,     &amp;<a name='7010'>
                                              P_ww_1,   &amp;<a name='7011'>
                                              P_t,      &amp;<a name='7012'>
                                              P_t_ave,  &amp;<a name='7013'>
                                              B_ww,     &amp;<a name='7014'>
                                              B_ww_1,   &amp;<a name='7015'>
                                              B_t,      &amp;<a name='7016'>
                                              B_t_ave,  &amp;<a name='7017'>
                                              K_ww,     &amp;<a name='7018'>
                                              K_ww_1,   &amp;<a name='7019'>
                                              K_t,      &amp;<a name='7020'>
                                              K_t_ave<a name='7021'>
<a name='7022'>
  REAL, DIMENSION( ims:ime , jms:jme )     :: S_mu,P_mu,K_mu,B_mu<a name='7023'>
<a name='7024'>
<font color=#447700>! OUT variables<a name='7025'></font>
<a name='7026'>
  REAL, DIMENSION( ims:ime , jms:jme ) :: P_muave, P_muts, P_mudf,B_muave, B_muts, B_mudf<a name='7027'>
  REAL, DIMENSION( ims:ime , jms:jme ) :: S_muave, S_muts, S_mudf,K_muave, K_muts, K_mudf<a name='7028'>
<a name='7029'>
<a name='7030'>
   REAL :: SAVE_L, COEF, ALPHA_M, FACTOR, VAL_N, VAL_L, VAL_A<a name='7031'>
   INTEGER :: NT<a name='7032'>
<a name='7033'>
<font color=#447700>!TGL test<a name='7034'></font>
<a name='7035'>
   do i=ims,ime<a name='7036'>
   do k=kms,kme<a name='7037'>
   do j=jms,jme<a name='7038'>
      S_u(i,k,j)=u(i,k,j)<a name='7039'>
      S_v(i,k,j)=v(i,k,j)<a name='7040'>
      S_u_1(i,k,j)=u_1(i,k,j)<a name='7041'>
      S_v_1(i,k,j)=v_1(i,k,j)<a name='7042'>
      S_t_1(i,k,j)=t_1(i,k,j)<a name='7043'>
      S_ft(i,k,j)=ft(i,k,j)<a name='7044'>
<a name='7045'>
      P_u(i,k,j)=u(i,k,j)<a name='7046'>
      P_v(i,k,j)=v(i,k,j)<a name='7047'>
      P_u_1(i,k,j)=u_1(i,k,j)<a name='7048'>
      P_v_1(i,k,j)=v_1(i,k,j)<a name='7049'>
      P_t_1(i,k,j)=t_1(i,k,j)<a name='7050'>
      P_ft(i,k,j)=ft(i,k,j)<a name='7051'>
   enddo<a name='7052'>
   enddo<a name='7053'>
   enddo<a name='7054'>
   do i=ims,ime<a name='7055'>
   do j=jms,jme<a name='7056'>
      S_mu_tend(i,j)=mu_tend(i,j)<a name='7057'>
      S_mut(i,j)=mut(i,j)<a name='7058'>
      S_muu(i,j)=muu(i,j)<a name='7059'>
      S_muv(i,j)=muv(i,j)<a name='7060'>
<a name='7061'>
      P_mu_tend(i,j)=mu_tend(i,j)<a name='7062'>
      P_mut(i,j)=mut(i,j)<a name='7063'>
      P_muu(i,j)=muu(i,j)<a name='7064'>
      P_muv(i,j)=muv(i,j)<a name='7065'>
   enddo<a name='7066'>
   enddo<a name='7067'>
   do i=ims,ime<a name='7068'>
   do k=kms,kme<a name='7069'>
   do j=jms,jme<a name='7070'>
      S_ww(i,k,j)=ww(i,k,j)<a name='7071'>
      S_ww_1(i,k,j)=ww_1(i,k,j)<a name='7072'>
      S_t(i,k,j)=t(i,k,j)<a name='7073'>
      S_t_ave(i,k,j)=t_ave(i,k,j)<a name='7074'>
<a name='7075'>
      P_ww(i,k,j)=ww(i,k,j)<a name='7076'>
      P_ww_1(i,k,j)=ww_1(i,k,j)<a name='7077'>
      P_t(i,k,j)=t(i,k,j)<a name='7078'>
      P_t_ave(i,k,j)=t_ave(i,k,j)<a name='7079'>
<a name='7080'>
   enddo<a name='7081'>
   enddo<a name='7082'>
   enddo<a name='7083'>
   do i=ims,ime<a name='7084'>
   do j=jms,jme<a name='7085'>
      S_mu(i,j)=mu(i,j)<a name='7086'>
      P_mu(i,j)=mu(i,j)<a name='7087'>
   enddo<a name='7088'>
   enddo<a name='7089'>
<a name='7090'>
   do i=ims,ime<a name='7091'>
   do j=jms,jme<a name='7092'>
      S_muave(i,j)=muave(i,j)<a name='7093'>
      S_muts(i,j)=muts(i,j)<a name='7094'>
      S_mudf(i,j)=mudf(i,j)<a name='7095'>
<a name='7096'>
      P_muave(i,j)=muave(i,j)<a name='7097'>
      P_muts(i,j)=muts(i,j)<a name='7098'>
      P_mudf(i,j)=mudf(i,j)<a name='7099'>
   enddo<a name='7100'>
   enddo<a name='7101'>
<a name='7102'>
<a name='7103'>
<font color=#447700>!NLM<a name='7104'></font>
<a name='7105'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_MU_T'>advance_mu_t</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_MU_T' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_MU_T_1">( ww, ww_1, u, u_1, v, v_1,            &amp;<a name='7106'>
                         mu, mut, muave, muts, muu, muv,      &amp;<a name='7107'>
                         mudf, uam, vam, wwam, t, t_1,        &amp;<a name='7108'>
                         t_ave, ft, mu_tend,                  &amp;<a name='7109'>
                         rdx, rdy, dts, epssm,                &amp;<a name='7110'>
                         dnw, fnm, fnp, rdnw,                 &amp;<a name='7111'>
                         msfu, msfv, msft,                    &amp;<a name='7112'>
                         step, config_flags,                  &amp;<a name='7113'>
                         ids, ide, jds, jde, kds, kde,        &amp;<a name='7114'>
                         ims, ime, jms, jme, kms, kme,        &amp;<a name='7115'>
                         its, ite, jts, jte, kts, kte        )<a name='7116'>
<a name='7117'>
   do i=its,ite<a name='7118'>
   do j=jts,jte<a name='7119'>
      B_muave(i,j)=muave(i,j)<a name='7120'>
      B_muts(i,j)=muts(i,j)<a name='7121'>
      B_mudf(i,j)=mudf(i,j)<a name='7122'>
   enddo<a name='7123'>
   enddo<a name='7124'>
   do i=its,ite<a name='7125'>
   do k=kts,kte<a name='7126'>
   do j=jts,jte<a name='7127'>
      B_ww(i,k,j)=ww(i,k,j)<a name='7128'>
      B_ww_1(i,k,j)=ww_1(i,k,j)<a name='7129'>
      B_t(i,k,j)=t(i,k,j)<a name='7130'>
      B_t_ave(i,k,j)=t_ave(i,k,j)<a name='7131'>
   enddo<a name='7132'>
   enddo<a name='7133'>
   enddo<a name='7134'>
   do i=its,ite<a name='7135'>
   do j=jts,jte<a name='7136'>
      B_mu(i,j)=mu(i,j)<a name='7137'>
   enddo<a name='7138'>
   enddo<a name='7139'>
<a name='7140'>
   do i=its,ite<a name='7141'>
   do k=kts,kte<a name='7142'>
   do j=jts,jte<a name='7143'>
      B_u(i,k,j)=u(i,k,j)<a name='7144'>
      B_v(i,k,j)=v(i,k,j)<a name='7145'>
      B_u_1(i,k,j)=u_1(i,k,j)<a name='7146'>
      B_v_1(i,k,j)=v_1(i,k,j)<a name='7147'>
      B_t_1(i,k,j)=t_1(i,k,j)<a name='7148'>
      B_ft(i,k,j)=ft(i,k,j)<a name='7149'>
   enddo<a name='7150'>
   enddo<a name='7151'>
   enddo<a name='7152'>
   do i=its,ite<a name='7153'>
   do j=jts,jte<a name='7154'>
      B_mu_tend(i,j)=mu_tend(i,j)<a name='7155'>
      B_mut(i,j)=mut(i,j)<a name='7156'>
      B_muu(i,j)=muu(i,j)<a name='7157'>
      B_muv(i,j)=muv(i,j)<a name='7158'>
   enddo<a name='7159'>
   enddo<a name='7160'>
<a name='7161'>
<font color=#447700>!  TCL<a name='7162'></font>
<a name='7163'>
   do i=ims,ime<a name='7164'>
   do k=kms,kme<a name='7165'>
   do j=jms,jme<a name='7166'>
      u(i,k,j)=S_u(i,k,j)<a name='7167'>
      v(i,k,j)=S_v(i,k,j)<a name='7168'>
      u_1(i,k,j)=S_u_1(i,k,j)<a name='7169'>
      v_1(i,k,j)=S_v_1(i,k,j)<a name='7170'>
      t_1(i,k,j)=S_t_1(i,k,j)<a name='7171'>
      ft(i,k,j)=S_ft(i,k,j)<a name='7172'>
   enddo<a name='7173'>
   enddo<a name='7174'>
   enddo<a name='7175'>
   do i=ims,ime<a name='7176'>
   do j=jms,jme<a name='7177'>
      mu_tend(i,j)=S_mu_tend(i,j)<a name='7178'>
      mut(i,j)=S_mut(i,j)<a name='7179'>
      muu(i,j)=S_muu(i,j)<a name='7180'>
      muv(i,j)=S_muv(i,j)<a name='7181'>
   enddo<a name='7182'>
   enddo<a name='7183'>
   do i=ims,ime<a name='7184'>
   do k=kms,kme<a name='7185'>
   do j=jms,jme<a name='7186'>
      ww(i,k,j)=S_ww(i,k,j)<a name='7187'>
      ww_1(i,k,j)=S_ww_1(i,k,j)<a name='7188'>
      t(i,k,j)=S_t(i,k,j)<a name='7189'>
      t_ave(i,k,j)=S_t_ave(i,k,j)<a name='7190'>
   enddo<a name='7191'>
   enddo<a name='7192'>
   enddo<a name='7193'>
   do i=ims,ime<a name='7194'>
   do j=jms,jme<a name='7195'>
      mu(i,j)=S_mu(i,j)<a name='7196'>
   enddo<a name='7197'>
   enddo<a name='7198'>
<a name='7199'>
   do i=ims,ime<a name='7200'>
   do j=jms,jme<a name='7201'>
      muave(i,j)=S_muave(i,j)<a name='7202'>
      muts(i,j)=S_muts(i,j)<a name='7203'>
      mudf(i,j)=S_mudf(i,j)<a name='7204'>
   enddo<a name='7205'>
   enddo<a name='7206'>
<a name='7207'>
<a name='7208'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_ADVANCE_MU_T'>g_advance_mu_t</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_MU_T' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_ADVANCE_MU_T_1">( ww, P_ww, ww_1, P_ww_1, u, P_u, u_1, P_u_1, v, P_v, v_1, P_v_1, mu, P_mu, mut, P_mut, muave, P_muave, &amp;<a name='7209'>
&amp;muts, P_muts, muu, P_muu, muv, P_muv, mudf, P_mudf, t, P_t, t_1, P_t_1, t_ave, P_t_ave, ft, P_ft, mu_tend, P_mu_tend, rdx, rdy, &amp;<a name='7210'>
&amp;dts, epssm, dnw, fnm, fnp, rdnw, msfu, msfv, msft, config_flags, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, &amp;<a name='7211'>
&amp;jts, jte, kts, kte )<a name='7212'>
<a name='7213'>
   SAVE_L=0.<a name='7214'>
   do i=its,ite<a name='7215'>
   do j=jts,jte<a name='7216'>
      SAVE_L=SAVE_L + P_muave(i,j)*P_muave(i,j)       &amp;<a name='7217'>
                    + P_muts(i,j)*P_muts(i,j)         &amp;<a name='7218'>
                    + P_mudf(i,j)*P_mudf(i,j)<a name='7219'>
   enddo<a name='7220'>
   enddo<a name='7221'>
   do i=its,ite<a name='7222'>
   do k=kts,kte<a name='7223'>
   do j=jts,jte<a name='7224'>
      SAVE_L=SAVE_L + P_ww(i,k,j)*P_ww(i,k,j)         &amp;<a name='7225'>
                    + P_ww_1(i,k,j)*P_ww_1(i,k,j)     &amp;<a name='7226'>
                    + P_t(i,k,j)*P_t(i,k,j)           &amp;<a name='7227'>
                    + P_t_ave(i,k,j)*P_t_ave(i,k,j)<a name='7228'>
   enddo<a name='7229'>
   enddo<a name='7230'>
   enddo<a name='7231'>
   do i=its,ite<a name='7232'>
   do j=jts,jte<a name='7233'>
      SAVE_L=SAVE_L + P_mu(i,j)*P_mu(i,j)<a name='7234'>
   enddo<a name='7235'>
   enddo<a name='7236'>
<a name='7237'>
   do i=its,ite<a name='7238'>
   do k=kts,kte<a name='7239'>
   do j=jts,jte<a name='7240'>
      SAVE_L=SAVE_L +  P_u(i,k,j)*P_u(i,k,j)    &amp;<a name='7241'>
                    +  P_v(i,k,j)*P_v(i,k,j)    &amp;<a name='7242'>
                    +  P_u_1(i,k,j)*P_u_1(i,k,j)    &amp;<a name='7243'>
                    +  P_v_1(i,k,j)*P_v_1(i,k,j)    &amp;<a name='7244'>
                    +  P_t_1(i,k,j)*P_t_1(i,k,j)    &amp;<a name='7245'>
                    +  P_ft(i,k,j)*P_ft(i,k,j)<a name='7246'>
   enddo<a name='7247'>
   enddo<a name='7248'>
   enddo<a name='7249'>
   do i=its,ite<a name='7250'>
   do j=jts,jte<a name='7251'>
      SAVE_L=SAVE_L +P_mu_tend(i,j)*P_mu_tend(i,j)    &amp;<a name='7252'>
                    +P_mut(i,j)*P_mut(i,j)            &amp;<a name='7253'>
                    +P_muu(i,j)*P_muu(i,j)            &amp;<a name='7254'>
                    +P_muv(i,j)*P_muv(i,j)<a name='7255'>
   enddo<a name='7256'>
   enddo<a name='7257'>
<a name='7258'>
#ifdef DM_PARALLEL<a name='7259'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='7260'>
                       comm, IERROR )<a name='7261'>
   SAVE_L = nsum <a name='7262'>
#endif<a name='7263'>
<a name='7264'>
   ALPHA_M=1.<a name='7265'>
   DO NT=1,11<a name='7266'>
      ALPHA_M=0.1*ALPHA_M<a name='7267'>
      FACTOR=1.+ALPHA_M<a name='7268'>
   do i=ims,ime<a name='7269'>
   do k=kms,kme<a name='7270'>
   do j=jms,jme<a name='7271'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='7272'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='7273'>
      P_u_1(i,k,j)=FACTOR*S_u_1(i,k,j)<a name='7274'>
      P_v_1(i,k,j)=FACTOR*S_v_1(i,k,j)<a name='7275'>
      P_t_1(i,k,j)=FACTOR*S_t_1(i,k,j)<a name='7276'>
      P_ft(i,k,j)=FACTOR*S_ft(i,k,j)<a name='7277'>
   enddo<a name='7278'>
   enddo<a name='7279'>
   enddo<a name='7280'>
   do i=ims,ime<a name='7281'>
   do j=jms,jme<a name='7282'>
      P_mu_tend(i,j)=FACTOR*S_mu_tend(i,j)<a name='7283'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='7284'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='7285'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='7286'>
   enddo<a name='7287'>
   enddo<a name='7288'>
   do i=ims,ime<a name='7289'>
   do k=kms,kme<a name='7290'>
   do j=jms,jme<a name='7291'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='7292'>
      P_ww_1(i,k,j)=FACTOR*S_ww_1(i,k,j)<a name='7293'>
      P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='7294'>
      P_t_ave(i,k,j)=FACTOR*S_t_ave(i,k,j)<a name='7295'>
   enddo<a name='7296'>
   enddo<a name='7297'>
   enddo<a name='7298'>
   do i=ims,ime<a name='7299'>
   do j=jms,jme<a name='7300'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='7301'>
   enddo<a name='7302'>
   enddo<a name='7303'>
   do i=ims,ime<a name='7304'>
   do j=jms,jme<a name='7305'>
      P_muave(i,j)=FACTOR*S_muave(i,j)<a name='7306'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='7307'>
      P_mudf(i,j)=FACTOR*S_mudf(i,j)<a name='7308'>
   enddo<a name='7309'>
   enddo<a name='7310'>
<a name='7311'>
<a name='7312'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_MU_T'>advance_mu_t</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_MU_T' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_MU_T_2">( P_ww, P_ww_1, P_u, P_u_1, P_v, P_v_1,            &amp;<a name='7313'>
                         P_mu, P_mut, P_muave, P_muts, P_muu, P_muv,      &amp;<a name='7314'>
                         P_mudf, uam, vam, wwam, P_t, P_t_1,        &amp;<a name='7315'>
                         P_t_ave, P_ft, P_mu_tend,                  &amp;<a name='7316'>
                         rdx, rdy, dts, epssm,                &amp;<a name='7317'>
                         dnw, fnm, fnp, rdnw,                 &amp;<a name='7318'>
                         msfu, msfv, msft,                    &amp;<a name='7319'>
                         step, config_flags,                  &amp;<a name='7320'>
                         ids, ide, jds, jde, kds, kde,        &amp;<a name='7321'>
                         ims, ime, jms, jme, kms, kme,        &amp;<a name='7322'>
                         its, ite, jts, jte, kts, kte        )<a name='7323'>
<a name='7324'>
   VAL_N=0.<a name='7325'>
<a name='7326'>
   do i=its,ite<a name='7327'>
   do j=jts,jte<a name='7328'>
      VAL_N=VAL_N + (P_muave(i,j) -B_muave(i,j))*(P_muave(i,j) -B_muave(i,j))    &amp;<a name='7329'>
                  + (P_muts(i,j) -B_muts(i,j))*(P_muts(i,j) -B_muts(i,j))        &amp;<a name='7330'>
                  + (P_mudf(i,j) -B_mudf(i,j))*(P_mudf(i,j) -B_mudf(i,j))<a name='7331'>
   enddo<a name='7332'>
   enddo<a name='7333'>
   do i=its,ite<a name='7334'>
   do k=kts,kte<a name='7335'>
   do j=jts,jte<a name='7336'>
      VAL_N=VAL_N + (P_ww(i,k,j) -B_ww(i,k,j))*(P_ww(i,k,j) -B_ww(i,k,j))            &amp;<a name='7337'>
                  + (P_ww_1(i,k,j) -B_ww_1(i,k,j))*(P_ww_1(i,k,j) -B_ww_1(i,k,j))    &amp;<a name='7338'>
                  + (P_t(i,k,j) -B_t(i,k,j))*(P_t(i,k,j) -B_t(i,k,j))                &amp;<a name='7339'>
                  + (P_t_ave(i,k,j) -B_t_ave(i,k,j))*(P_t_ave(i,k,j) -B_t_ave(i,k,j))<a name='7340'>
   enddo<a name='7341'>
   enddo<a name='7342'>
   enddo<a name='7343'>
   do i=its,ite<a name='7344'>
   do j=jts,jte<a name='7345'>
      VAL_N=VAL_N + (P_mu(i,j) -B_mu(i,j))*(P_mu(i,j) -B_mu(i,j))<a name='7346'>
   enddo<a name='7347'>
   enddo<a name='7348'>
<a name='7349'>
   do i=its,ite<a name='7350'>
   do k=kts,kte<a name='7351'>
   do j=jts,jte<a name='7352'>
      VAL_N=VAL_N   +  (P_u(i,k,j)-B_u(i,k,j))*(P_u(i,k,j)-B_u(i,k,j))    &amp;<a name='7353'>
                    +  (P_v(i,k,j)-B_v(i,k,j))*(P_v(i,k,j)-B_v(i,k,j))    &amp;<a name='7354'>
                    +  (P_u_1(i,k,j)-B_u_1(i,k,j))*(P_u_1(i,k,j)-B_u_1(i,k,j))    &amp;<a name='7355'>
                    +  (P_v_1(i,k,j)-B_v_1(i,k,j))*(P_v_1(i,k,j)-B_v_1(i,k,j))    &amp;<a name='7356'>
                    +  (P_t_1(i,k,j)-B_t_1(i,k,j))*(P_t_1(i,k,j)-B_t_1(i,k,j))    &amp;<a name='7357'>
                    +  (P_ft(i,k,j)-B_ft(i,k,j))*(P_ft(i,k,j)-B_ft(i,k,j))<a name='7358'>
   enddo<a name='7359'>
   enddo<a name='7360'>
   enddo<a name='7361'>
   do i=its,ite<a name='7362'>
   do j=jts,jte<a name='7363'>
      VAL_N=VAL_N   +  (P_mu_tend(i,j)-B_mu_tend(i,j))*(P_mu_tend(i,j)-B_mu_tend(i,j))    &amp;<a name='7364'>
                    +  (P_mut(i,j)-B_mut(i,j))*(P_mut(i,j)-B_mut(i,j))            &amp;<a name='7365'>
                    +  (P_muu(i,j)-B_muu(i,j))*(P_muu(i,j)-B_muu(i,j))            &amp;<a name='7366'>
                    +  (P_muv(i,j)-B_muv(i,j))*(P_muv(i,j)-B_muv(i,j))<a name='7367'>
   enddo<a name='7368'>
   enddo<a name='7369'>
<a name='7370'>
#ifdef DM_PARALLEL<a name='7371'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='7372'>
                       comm, IERROR )<a name='7373'>
   VAL_N = nsum <a name='7374'>
#endif<a name='7375'>
<a name='7376'>
      VAL_L=SAVE_L*ALPHA_M**2<a name='7377'>
      COEF=VAL_N/VAL_L<a name='7378'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='7379'>
         'g_advance_mu_t: ALPHA_M=',ALPHA_M,'  COEF=',COEF, &amp;<a name='7380'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='7381'>
   ENDDO<a name='7382'>
<a name='7383'>
<font color=#447700>!  ADJ test<a name='7384'></font>
<a name='7385'>
   FACTOR=0.1<a name='7386'>
   do i=ims,ime<a name='7387'>
   do k=kms,kme<a name='7388'>
   do j=jms,jme<a name='7389'>
      u(i,k,j)=S_u(i,k,j)<a name='7390'>
      v(i,k,j)=S_v(i,k,j)<a name='7391'>
      u_1(i,k,j)=S_u_1(i,k,j)<a name='7392'>
      v_1(i,k,j)=S_v_1(i,k,j)<a name='7393'>
      t_1(i,k,j)=S_t_1(i,k,j)<a name='7394'>
      ft(i,k,j)=S_ft(i,k,j)<a name='7395'>
<a name='7396'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='7397'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='7398'>
      P_u_1(i,k,j)=FACTOR*S_u_1(i,k,j)<a name='7399'>
      P_v_1(i,k,j)=FACTOR*S_v_1(i,k,j)<a name='7400'>
      P_t_1(i,k,j)=FACTOR*S_t_1(i,k,j)<a name='7401'>
      P_ft(i,k,j)=FACTOR*S_ft(i,k,j)<a name='7402'>
<a name='7403'>
      B_u(i,k,j)=P_u(i,k,j)<a name='7404'>
      B_v(i,k,j)=P_v(i,k,j)<a name='7405'>
      B_u_1(i,k,j)=P_u_1(i,k,j)<a name='7406'>
      B_v_1(i,k,j)=P_v_1(i,k,j)<a name='7407'>
      B_t_1(i,k,j)=P_t_1(i,k,j)<a name='7408'>
      B_ft(i,k,j)=P_ft(i,k,j)<a name='7409'>
   enddo<a name='7410'>
   enddo<a name='7411'>
   enddo<a name='7412'>
   do i=ims,ime<a name='7413'>
   do j=jms,jme<a name='7414'>
      mu_tend(i,j)=S_mu_tend(i,j)<a name='7415'>
      mut(i,j)=S_mut(i,j)<a name='7416'>
      muu(i,j)=S_muu(i,j)<a name='7417'>
      muv(i,j)=S_muv(i,j)<a name='7418'>
<a name='7419'>
      P_mu_tend(i,j)=FACTOR*S_mu_tend(i,j)<a name='7420'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='7421'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='7422'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='7423'>
<a name='7424'>
      B_mu_tend(i,j)=P_mu_tend(i,j)<a name='7425'>
      B_mut(i,j)=P_mut(i,j)<a name='7426'>
      B_muu(i,j)=P_muu(i,j)<a name='7427'>
      B_muv(i,j)=P_muv(i,j)<a name='7428'>
   enddo<a name='7429'>
   enddo<a name='7430'>
   do i=ims,ime<a name='7431'>
   do k=kms,kme<a name='7432'>
   do j=jms,jme<a name='7433'>
      ww(i,k,j)=S_ww(i,k,j)<a name='7434'>
      ww_1(i,k,j)=S_ww_1(i,k,j)<a name='7435'>
      t(i,k,j)=S_t(i,k,j)<a name='7436'>
      t_ave(i,k,j)=S_t_ave(i,k,j)<a name='7437'>
<a name='7438'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='7439'>
      P_ww_1(i,k,j)=FACTOR*S_ww_1(i,k,j)<a name='7440'>
      P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='7441'>
      P_t_ave(i,k,j)=FACTOR*S_t_ave(i,k,j)<a name='7442'>
<a name='7443'>
      B_ww(i,k,j)=P_ww(i,k,j)<a name='7444'>
      B_ww_1(i,k,j)=P_ww_1(i,k,j)<a name='7445'>
      B_t(i,k,j)=P_t(i,k,j)<a name='7446'>
      B_t_ave(i,k,j)=P_t_ave(i,k,j)<a name='7447'>
<a name='7448'>
   enddo<a name='7449'>
   enddo<a name='7450'>
   enddo<a name='7451'>
   do i=ims,ime<a name='7452'>
   do j=jms,jme<a name='7453'>
      mu(i,j)=S_mu(i,j)<a name='7454'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='7455'>
      B_mu(i,j)=P_mu(i,j)<a name='7456'>
   enddo<a name='7457'>
   enddo<a name='7458'>
<a name='7459'>
   do i=ims,ime<a name='7460'>
   do j=jms,jme<a name='7461'>
      muave(i,j)=S_muave(i,j)<a name='7462'>
      muts(i,j)=S_muts(i,j)<a name='7463'>
      mudf(i,j)=S_mudf(i,j)<a name='7464'>
<a name='7465'>
      P_muave(i,j)=FACTOR*S_muave(i,j)<a name='7466'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='7467'>
      P_mudf(i,j)=FACTOR*S_mudf(i,j)<a name='7468'>
<a name='7469'>
      B_muave(i,j)=P_muave(i,j)<a name='7470'>
      B_muts(i,j)=P_muts(i,j)<a name='7471'>
      B_mudf(i,j)=P_mudf(i,j)<a name='7472'>
   enddo<a name='7473'>
   enddo<a name='7474'>
<a name='7475'>
<font color=#447700>!  TGL<a name='7476'></font>
<a name='7477'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_ADVANCE_MU_T'>g_advance_mu_t</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_MU_T' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_ADVANCE_MU_T_2">( ww, P_ww, ww_1, P_ww_1, u, P_u, u_1, P_u_1, v, P_v, v_1, P_v_1, mu, P_mu, mut, P_mut, muave, P_muave, &amp;<a name='7478'>
&amp;muts, P_muts, muu, P_muu, muv, P_muv, mudf, P_mudf, t, P_t, t_1, P_t_1, t_ave, P_t_ave, ft, P_ft, mu_tend, P_mu_tend, rdx, rdy, &amp;<a name='7479'>
&amp;dts, epssm, dnw, fnm, fnp, rdnw, msfu, msfv, msft, config_flags, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, &amp;<a name='7480'>
&amp;jts, jte, kts, kte )<a name='7481'>
<a name='7482'>
   VAL_L=0.<a name='7483'>
   do i=its,ite<a name='7484'>
   do j=jts,jte<a name='7485'>
      VAL_L=VAL_L +  P_muave(i,j)*P_muave(i,j)       &amp;<a name='7486'>
                    + P_muts(i,j)*P_muts(i,j)         &amp;<a name='7487'>
                    + P_mudf(i,j)*P_mudf(i,j)<a name='7488'>
   enddo<a name='7489'>
   enddo<a name='7490'>
   do i=its,ite<a name='7491'>
   do k=kts,kte<a name='7492'>
   do j=jts,jte<a name='7493'>
      VAL_L=VAL_L + P_ww(i,k,j)*P_ww(i,k,j)         &amp;<a name='7494'>
                    + P_ww_1(i,k,j)*P_ww_1(i,k,j)     &amp;<a name='7495'>
                    + P_t(i,k,j)*P_t(i,k,j)           &amp;<a name='7496'>
                    + P_t_ave(i,k,j)*P_t_ave(i,k,j)<a name='7497'>
   enddo<a name='7498'>
   enddo<a name='7499'>
   enddo<a name='7500'>
   do i=its,ite<a name='7501'>
   do j=jts,jte<a name='7502'>
      VAL_L=VAL_L + P_mu(i,j)*P_mu(i,j)<a name='7503'>
   enddo<a name='7504'>
   enddo<a name='7505'>
   do i=its,ite<a name='7506'>
   do k=kts,kte<a name='7507'>
   do j=jts,jte<a name='7508'>
      VAL_L=VAL_L   +  P_u(i,k,j)*P_u(i,k,j)    &amp;<a name='7509'>
                    +   P_v(i,k,j)*P_v(i,k,j)    &amp;<a name='7510'>
                    +   P_u_1(i,k,j)*P_u_1(i,k,j)    &amp;<a name='7511'>
                    +   P_v_1(i,k,j)*P_v_1(i,k,j)    &amp;<a name='7512'>
                    +   P_t_1(i,k,j)*P_t_1(i,k,j)    &amp;<a name='7513'>
                    +   P_ft(i,k,j)*P_ft(i,k,j)<a name='7514'>
   enddo<a name='7515'>
   enddo<a name='7516'>
   enddo<a name='7517'>
   do i=its,ite<a name='7518'>
   do j=jts,jte<a name='7519'>
       VAL_L=VAL_L  +P_mu_tend(i,j)*P_mu_tend(i,j)    &amp;<a name='7520'>
                    + P_mut(i,j)*P_mut(i,j)            &amp;<a name='7521'>
                    + P_muu(i,j)*P_muu(i,j)            &amp;<a name='7522'>
                    + P_muv(i,j)*P_muv(i,j)<a name='7523'>
   enddo<a name='7524'>
   enddo<a name='7525'>
<a name='7526'>
#ifdef DM_PARALLEL<a name='7527'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='7528'>
                       comm, IERROR )<a name='7529'>
   VAL_L = nsum <a name='7530'>
#endif<a name='7531'>
<a name='7532'>
<font color=#447700>!  ADJ<a name='7533'></font>
   do i=ims,ime<a name='7534'>
   do k=kms,kme<a name='7535'>
   do j=jms,jme<a name='7536'>
      u(i,k,j)=S_u(i,k,j)<a name='7537'>
      v(i,k,j)=S_v(i,k,j)<a name='7538'>
      u_1(i,k,j)=S_u_1(i,k,j)<a name='7539'>
      v_1(i,k,j)=S_v_1(i,k,j)<a name='7540'>
      t_1(i,k,j)=S_t_1(i,k,j)<a name='7541'>
      ft(i,k,j)=S_ft(i,k,j)<a name='7542'>
   enddo<a name='7543'>
   enddo<a name='7544'>
   enddo<a name='7545'>
   do i=ims,ime<a name='7546'>
   do j=jms,jme<a name='7547'>
      mu_tend(i,j)=S_mu_tend(i,j)<a name='7548'>
      mut(i,j)=S_mut(i,j)<a name='7549'>
      muu(i,j)=S_muu(i,j)<a name='7550'>
      muv(i,j)=S_muv(i,j)<a name='7551'>
   enddo<a name='7552'>
   enddo<a name='7553'>
   do i=ims,ime<a name='7554'>
   do k=kms,kme<a name='7555'>
   do j=jms,jme<a name='7556'>
      ww(i,k,j)=S_ww(i,k,j)<a name='7557'>
      ww_1(i,k,j)=S_ww_1(i,k,j)<a name='7558'>
      t(i,k,j)=S_t(i,k,j)<a name='7559'>
      t_ave(i,k,j)=S_t_ave(i,k,j)<a name='7560'>
   enddo<a name='7561'>
   enddo<a name='7562'>
   enddo<a name='7563'>
   do i=ims,ime<a name='7564'>
   do j=jms,jme<a name='7565'>
      mu(i,j)=S_mu(i,j)<a name='7566'>
   enddo<a name='7567'>
   enddo<a name='7568'>
<a name='7569'>
   do i=ims,ime<a name='7570'>
   do j=jms,jme<a name='7571'>
      muave(i,j)=S_muave(i,j)<a name='7572'>
      muts(i,j)=S_muts(i,j)<a name='7573'>
      mudf(i,j)=S_mudf(i,j)<a name='7574'>
   enddo<a name='7575'>
   enddo<a name='7576'>
<a name='7577'>
<a name='7578'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_ad.F.html#A_ADVANCE_MU_T'>a_advance_mu_t</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_MU_T' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_ADVANCE_MU_T_1">( ww, P_ww, ww_1, P_ww_1, u, P_u, u_1, P_u_1, v, P_v, v_1, P_v_1, P_mu, P_mut, P_muave, P_muts, muu, &amp;<a name='7579'>
&amp;P_muu, muv, P_muv, P_mudf, P_t, t_1, P_t_1, P_t_ave, P_ft, mu_tend, P_mu_tend, rdx, rdy, dts, epssm, dnw, fnm, fnp, rdnw, msfu, &amp;<a name='7580'>
&amp;msfv, msft, config_flags, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='7581'>
<a name='7582'>
   VAL_A=0.<a name='7583'>
   do i=its,ite<a name='7584'>
   do k=kts,kte<a name='7585'>
   do j=jts,jte<a name='7586'>
      VAL_A=VAL_A + P_u(i,k,j)*B_u(i,k,j)            &amp;<a name='7587'>
                  + P_v(i,k,j)*B_v(i,k,j)            &amp;<a name='7588'>
                  + P_u_1(i,k,j)*B_u_1(i,k,j)        &amp;<a name='7589'>
                  + P_v_1(i,k,j)*B_v_1(i,k,j)        &amp;<a name='7590'>
                  + P_t_1(i,k,j)*B_t_1(i,k,j)        &amp;<a name='7591'>
                  + P_ft(i,k,j)*B_ft(i,k,j)<a name='7592'>
   enddo<a name='7593'>
   enddo<a name='7594'>
   enddo<a name='7595'>
   do i=its,ite<a name='7596'>
   do j=jts,jte<a name='7597'>
      VAL_A=VAL_A + P_mu_tend(i,j)*B_mu_tend(i,j)  &amp;<a name='7598'>
                  + P_mut(i,j)*B_mut(i,j)          &amp;<a name='7599'>
                  + P_muu(i,j)*B_muu(i,j)          &amp;<a name='7600'>
                  + P_muv(i,j)*B_muv(i,j)<a name='7601'>
   enddo<a name='7602'>
   enddo<a name='7603'>
   do i=its,ite<a name='7604'>
   do k=kts,kte<a name='7605'>
   do j=jts,jte<a name='7606'>
      VAL_A=VAL_A + P_ww(i,k,j)*B_ww(i,k,j)        &amp;<a name='7607'>
                  + P_ww_1(i,k,j)*B_ww_1(i,k,j)    &amp;<a name='7608'>
                  + P_t(i,k,j)*B_t(i,k,j)          &amp;<a name='7609'>
                  + P_t_ave(i,k,j)*B_t_ave(i,k,j)<a name='7610'>
   enddo<a name='7611'>
   enddo<a name='7612'>
   enddo<a name='7613'>
   do i=its,ite<a name='7614'>
   do j=jts,jte<a name='7615'>
      VAL_A=VAL_A + P_mu(i,j)*B_mu(i,j)<a name='7616'>
   enddo<a name='7617'>
   enddo<a name='7618'>
<a name='7619'>
   do i=its,ite<a name='7620'>
   do j=jts,jte<a name='7621'>
      VAL_A=VAL_A   + P_muave(i,j)*B_muave(i,j)       &amp;<a name='7622'>
                    + P_muts(i,j)*B_muts(i,j)         &amp;<a name='7623'>
                    + P_mudf(i,j)*B_mudf(i,j)<a name='7624'>
   enddo<a name='7625'>
   enddo<a name='7626'>
<a name='7627'>
#ifdef DM_PARALLEL<a name='7628'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='7629'>
                       comm, IERROR )<a name='7630'>
   VAL_A = nsum <a name='7631'>
#endif<a name='7632'>
<a name='7633'>
   print*, '                '<a name='7634'>
   write(6,*) 'a_advance_mu_t: '<a name='7635'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='7636'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='7637'>
<a name='7638'>
<font color=#447700>!  RECOVER<a name='7639'></font>
<a name='7640'>
   do i=ims,ime<a name='7641'>
   do k=kms,kme<a name='7642'>
   do j=jms,jme<a name='7643'>
      u(i,k,j)=S_u(i,k,j)<a name='7644'>
      v(i,k,j)=S_v(i,k,j)<a name='7645'>
      u_1(i,k,j)=S_u_1(i,k,j)<a name='7646'>
      v_1(i,k,j)=S_v_1(i,k,j)<a name='7647'>
      t_1(i,k,j)=S_t_1(i,k,j)<a name='7648'>
      ft(i,k,j)=S_ft(i,k,j)<a name='7649'>
   enddo<a name='7650'>
   enddo<a name='7651'>
   enddo<a name='7652'>
   do i=ims,ime<a name='7653'>
   do j=jms,jme<a name='7654'>
      mu_tend(i,j)=S_mu_tend(i,j)<a name='7655'>
      mut(i,j)=S_mut(i,j)<a name='7656'>
      muu(i,j)=S_muu(i,j)<a name='7657'>
      muv(i,j)=S_muv(i,j)<a name='7658'>
   enddo<a name='7659'>
   enddo<a name='7660'>
   do i=ims,ime<a name='7661'>
   do k=kms,kme<a name='7662'>
   do j=jms,jme<a name='7663'>
      ww(i,k,j)=S_ww(i,k,j)<a name='7664'>
      ww_1(i,k,j)=S_ww_1(i,k,j)<a name='7665'>
      t(i,k,j)=S_t(i,k,j)<a name='7666'>
      t_ave(i,k,j)=S_t_ave(i,k,j)<a name='7667'>
   enddo<a name='7668'>
   enddo<a name='7669'>
   enddo<a name='7670'>
   do i=ims,ime<a name='7671'>
   do j=jms,jme<a name='7672'>
      mu(i,j)=S_mu(i,j)<a name='7673'>
   enddo<a name='7674'>
   enddo<a name='7675'>
<a name='7676'>
   do i=ims,ime<a name='7677'>
   do j=jms,jme<a name='7678'>
      muave(i,j)=S_muave(i,j)<a name='7679'>
      muts(i,j)=S_muts(i,j)<a name='7680'>
      mudf(i,j)=S_mudf(i,j)<a name='7681'>
   enddo<a name='7682'>
   enddo<a name='7683'>
<a name='7684'>
END SUBROUTINE t_advance_mu_t<a name='7685'>
<a name='7686'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='7687'></font>
<a name='7688'>
<A NAME='T_SUMFLUX'><A href='../../html_code/dyn_em/module_check.F.html#T_SUMFLUX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7689'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_sumflux</font> ( ru, rv, ww,                             &amp; <A href='../../call_to/T_SUMFLUX.html' TARGET='index'>1</A>,<A href='../../call_from/T_SUMFLUX.html' TARGET='index'>5</A><a name='7690'>
                     u_lin, v_lin, ww_lin,                   &amp;<a name='7691'>
                     muu, muv,                               &amp;<a name='7692'>
                     ru_m, rv_m, ww_m, epssm,                &amp;<a name='7693'>
                     msfu, msfv,                             &amp;<a name='7694'>
                     iteration , number_of_small_timesteps,  &amp;<a name='7695'>
                     ids,ide, jds,jde, kds,kde,              &amp;<a name='7696'>
                     ims,ime, jms,jme, kms,kme,              &amp;<a name='7697'>
                     its,ite, jts,jte, kts,kte              )<a name='7698'>
<a name='7699'>
<a name='7700'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='7701'></font>
<a name='7702'>
<font color=#447700>! declarations for the stuff coming in<a name='7703'></font>
<a name='7704'>
  INTEGER,      INTENT(IN   )    :: number_of_small_timesteps<a name='7705'>
  INTEGER,      INTENT(IN   )    :: iteration<a name='7706'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='7707'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='7708'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='7709'>
<a name='7710'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)                 :: ru, &amp;<a name='7711'>
                                                                rv, &amp;<a name='7712'>
                                                                ww, &amp;<a name='7713'>
                                                                u_lin,  &amp;<a name='7714'>
                                                                v_lin,  &amp;<a name='7715'>
                                                                ww_lin<a name='7716'>
<a name='7717'>
<a name='7718'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme) , INTENT(INOUT) :: ru_m, &amp;<a name='7719'>
                                                                rv_m, &amp;<a name='7720'>
                                                                ww_m<a name='7721'>
  REAL, DIMENSION(ims:ime, jms:jme) , INTENT(IN   ) ::  msfu, msfv<a name='7722'>
  REAL, DIMENSION(ims:ime, jms:jme)   :: muu, muv<a name='7723'>
<a name='7724'>
  REAL, INTENT(IN   )  ::  epssm<a name='7725'>
  INTEGER   :: i,j,k<a name='7726'>
<a name='7727'>
<font color=#447700>!  IN variables<a name='7728'></font>
<a name='7729'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)                 :: S_ru, &amp;<a name='7730'>
                                                                S_rv, &amp;<a name='7731'>
                                                                S_ww, &amp;<a name='7732'>
                                                                S_u_lin,  &amp;<a name='7733'>
                                                                S_v_lin,  &amp;<a name='7734'>
                                                                S_ww_lin<a name='7735'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)                 :: P_ru, &amp;<a name='7736'>
                                                                P_rv, &amp;<a name='7737'>
                                                                P_ww, &amp;<a name='7738'>
                                                                P_u_lin,  &amp;<a name='7739'>
                                                                P_v_lin,  &amp;<a name='7740'>
                                                                P_ww_lin<a name='7741'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)                 :: B_ru, &amp;<a name='7742'>
                                                                B_rv, &amp;<a name='7743'>
                                                                B_ww, &amp;<a name='7744'>
                                                                B_u_lin,  &amp;<a name='7745'>
                                                                B_v_lin,  &amp;<a name='7746'>
                                                                B_ww_lin<a name='7747'>
<a name='7748'>
  REAL, DIMENSION(ims:ime, jms:jme)      :: S_muu, S_muv,P_muu, P_muv,B_muu, B_muv<a name='7749'>
<a name='7750'>
<font color=#447700>!  INOUT variables<a name='7751'></font>
<a name='7752'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)  :: S_ru_m, S_rv_m, S_ww_m,P_ru_m, P_rv_m, P_ww_m<a name='7753'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)  :: K_ru_m, K_rv_m, K_ww_m,B_ru_m, B_rv_m, B_ww_m<a name='7754'>
<a name='7755'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='7756'>
   INTEGER :: NT<a name='7757'>
<a name='7758'>
<font color=#447700>!TGL test<a name='7759'></font>
<a name='7760'>
   do i=ims,ime<a name='7761'>
   do k=kms,kme<a name='7762'>
   do j=jms,jme<a name='7763'>
      S_ru(i,k,j)=ru(i,k,j)<a name='7764'>
      S_rv(i,k,j)=rv(i,k,j)<a name='7765'>
      S_ww(i,k,j)=ww(i,k,j)<a name='7766'>
      S_u_lin(i,k,j)=u_lin(i,k,j)<a name='7767'>
      S_v_lin(i,k,j)=v_lin(i,k,j)<a name='7768'>
      S_ww_lin(i,k,j)=ww_lin(i,k,j)<a name='7769'>
<a name='7770'>
      P_ru(i,k,j)=ru(i,k,j)<a name='7771'>
      P_rv(i,k,j)=rv(i,k,j)<a name='7772'>
      P_ww(i,k,j)=ww(i,k,j)<a name='7773'>
      P_u_lin(i,k,j)=u_lin(i,k,j)<a name='7774'>
      P_v_lin(i,k,j)=v_lin(i,k,j)<a name='7775'>
      P_ww_lin(i,k,j)=ww_lin(i,k,j)<a name='7776'>
   enddo<a name='7777'>
   enddo<a name='7778'>
   enddo<a name='7779'>
   do i=ims,ime<a name='7780'>
   do j=jms,jme<a name='7781'>
      S_muu(i,j)=muu(i,j)<a name='7782'>
      S_muv(i,j)=muv(i,j)<a name='7783'>
<a name='7784'>
      P_muu(i,j)=muu(i,j)<a name='7785'>
      P_muv(i,j)=muv(i,j)<a name='7786'>
   enddo<a name='7787'>
   enddo<a name='7788'>
   do i=ims,ime<a name='7789'>
   do k=kms,kme<a name='7790'>
   do j=jms,jme<a name='7791'>
      S_ru_m(i,k,j)=ru_m(i,k,j)<a name='7792'>
      S_rv_m(i,k,j)=rv_m(i,k,j)<a name='7793'>
      S_ww_m(i,k,j)=ww_m(i,k,j)<a name='7794'>
<a name='7795'>
      P_ru_m(i,k,j)=ru_m(i,k,j)<a name='7796'>
      P_rv_m(i,k,j)=rv_m(i,k,j)<a name='7797'>
      P_ww_m(i,k,j)=ww_m(i,k,j)<a name='7798'>
<a name='7799'>
      K_ru_m(i,k,j)=ru_m(i,k,j)<a name='7800'>
      K_rv_m(i,k,j)=rv_m(i,k,j)<a name='7801'>
      K_ww_m(i,k,j)=ww_m(i,k,j)<a name='7802'>
   enddo<a name='7803'>
   enddo<a name='7804'>
   enddo<a name='7805'>
<a name='7806'>
<font color=#447700>!NLM<a name='7807'></font>
<a name='7808'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SUMFLUX'>sumflux</A><A href='../../html_code/dyn_em/module_check.F.html#T_SUMFLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUMFLUX_1"> ( ru, rv, ww,                             &amp;<a name='7809'>
                     u_lin, v_lin, ww_lin,                   &amp;<a name='7810'>
                     muu, muv,                               &amp;<a name='7811'>
                     ru_m, rv_m, ww_m, epssm,                &amp;<a name='7812'>
                     msfu, msfv,                             &amp;<a name='7813'>
                     iteration , number_of_small_timesteps,  &amp;<a name='7814'>
                     ids,ide, jds,jde, kds,kde,              &amp;<a name='7815'>
                     ims,ime, jms,jme, kms,kme,              &amp;<a name='7816'>
                     its,ite, jts,jte, kts,kte              )<a name='7817'>
<a name='7818'>
   do i=its,ite<a name='7819'>
   do k=kts,kte<a name='7820'>
   do j=jts,jte<a name='7821'>
      B_ru_m(i,k,j)=ru_m(i,k,j)<a name='7822'>
      B_rv_m(i,k,j)=rv_m(i,k,j)<a name='7823'>
      B_ww_m(i,k,j)=ww_m(i,k,j)<a name='7824'>
   enddo<a name='7825'>
   enddo<a name='7826'>
   enddo<a name='7827'>
<a name='7828'>
<font color=#447700>!  TCL<a name='7829'></font>
<a name='7830'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_SUMFLUX'>g_sumflux</A><A href='../../html_code/dyn_em/module_check.F.html#T_SUMFLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SUMFLUX_1">( ru, P_ru, rv, P_rv, ww, P_ww, u_lin, P_u_lin, v_lin, P_v_lin, ww_lin, P_ww_lin, muu, P_muu, muv, P_muv, K_ru_m,&amp;<a name='7831'>
&amp; P_ru_m, K_rv_m, P_rv_m, K_ww_m, P_ww_m, msfu, msfv, iteration, number_of_small_timesteps, ide, jde, kde, ims, ime, jms, jme, kms, &amp;<a name='7832'>
&amp;kme, its, ite, jts, jte, kts, kte )<a name='7833'>
<a name='7834'>
   SAVE_L=0.<a name='7835'>
   do i=its,ite<a name='7836'>
   do k=kts,kte<a name='7837'>
   do j=jts,jte<a name='7838'>
      SAVE_L=SAVE_L +P_ru_m(i,k,j)*P_ru_m(i,k,j)      &amp;<a name='7839'>
                    +P_rv_m(i,k,j)*P_rv_m(i,k,j)      &amp;<a name='7840'>
                    +P_ww_m(i,k,j)*P_ww_m(i,k,j)<a name='7841'>
   enddo<a name='7842'>
   enddo<a name='7843'>
   enddo<a name='7844'>
<a name='7845'>
#ifdef DM_PARALLEL<a name='7846'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='7847'>
                       comm, IERROR )<a name='7848'>
   SAVE_L = nsum <a name='7849'>
#endif<a name='7850'>
<a name='7851'>
   ALPHA=1.<a name='7852'>
   DO NT=1,11<a name='7853'>
      ALPHA=0.1*ALPHA<a name='7854'>
      FACTOR=1.+ALPHA<a name='7855'>
   do i=ims,ime<a name='7856'>
   do k=kms,kme<a name='7857'>
   do j=jms,jme<a name='7858'>
      P_ru(i,k,j)=FACTOR*S_ru(i,k,j)<a name='7859'>
      P_rv(i,k,j)=FACTOR*S_rv(i,k,j)<a name='7860'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='7861'>
      P_u_lin(i,k,j)=FACTOR*S_u_lin(i,k,j)<a name='7862'>
      P_v_lin(i,k,j)=FACTOR*S_v_lin(i,k,j)<a name='7863'>
      P_ww_lin(i,k,j)=FACTOR*S_ww_lin(i,k,j)<a name='7864'>
   enddo<a name='7865'>
   enddo<a name='7866'>
   enddo<a name='7867'>
   do i=ims,ime<a name='7868'>
   do j=jms,jme<a name='7869'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='7870'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='7871'>
   enddo<a name='7872'>
   enddo<a name='7873'>
   do i=ims,ime<a name='7874'>
   do k=kms,kme<a name='7875'>
   do j=jms,jme<a name='7876'>
      P_ru_m(i,k,j)=FACTOR*S_ru_m(i,k,j)<a name='7877'>
      P_rv_m(i,k,j)=FACTOR*S_rv_m(i,k,j)<a name='7878'>
      P_ww_m(i,k,j)=FACTOR*S_ww_m(i,k,j)<a name='7879'>
   enddo<a name='7880'>
   enddo<a name='7881'>
   enddo<a name='7882'>
<a name='7883'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SUMFLUX'>sumflux</A><A href='../../html_code/dyn_em/module_check.F.html#T_SUMFLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUMFLUX_2"> ( P_ru, P_rv, P_ww,                             &amp;<a name='7884'>
                     P_u_lin, P_v_lin, P_ww_lin,                   &amp;<a name='7885'>
                     P_muu, P_muv,                               &amp;<a name='7886'>
                     P_ru_m, P_rv_m, P_ww_m, epssm,                &amp;<a name='7887'>
                     msfu, msfv,                             &amp;<a name='7888'>
                     iteration , number_of_small_timesteps,  &amp;<a name='7889'>
                     ids,ide, jds,jde, kds,kde,              &amp;<a name='7890'>
                     ims,ime, jms,jme, kms,kme,              &amp;<a name='7891'>
                     its,ite, jts,jte, kts,kte              )<a name='7892'>
<a name='7893'>
      VAL_N=0.<a name='7894'>
      do i=its,ite<a name='7895'>
      do k=kts,kte<a name='7896'>
      do j=jts,jte<a name='7897'>
         VAL_N=VAL_N + (P_ru_m(i,k,j)-B_ru_m(i,k,j))*(P_ru_m(i,k,j)-B_ru_m(i,k,j))     &amp;<a name='7898'>
                     + (P_rv_m(i,k,j)-B_rv_m(i,k,j))*(P_rv_m(i,k,j)-B_rv_m(i,k,j))     &amp;<a name='7899'>
                     + (P_ww_m(i,k,j)-B_ww_m(i,k,j))*(P_ww_m(i,k,j)-B_ww_m(i,k,j))<a name='7900'>
   enddo<a name='7901'>
   enddo<a name='7902'>
   enddo<a name='7903'>
<a name='7904'>
#ifdef DM_PARALLEL<a name='7905'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='7906'>
                       comm, IERROR )<a name='7907'>
   VAL_N = nsum <a name='7908'>
#endif<a name='7909'>
<a name='7910'>
      VAL_L=SAVE_L*ALPHA**2<a name='7911'>
      COEF=VAL_N/VAL_L<a name='7912'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='7913'>
         'g_sumflux: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='7914'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='7915'>
   ENDDO<a name='7916'>
<a name='7917'>
<font color=#447700>!  ADJ test<a name='7918'></font>
<a name='7919'>
   FACTOR=0.1<a name='7920'>
   do i=ims,ime<a name='7921'>
   do k=kms,kme<a name='7922'>
   do j=jms,jme<a name='7923'>
      ru(i,k,j)=S_ru(i,k,j)<a name='7924'>
      rv(i,k,j)=S_rv(i,k,j)<a name='7925'>
      ww(i,k,j)=S_ww(i,k,j)<a name='7926'>
      u_lin(i,k,j)=S_u_lin(i,k,j)<a name='7927'>
      v_lin(i,k,j)=S_v_lin(i,k,j)<a name='7928'>
      ww_lin(i,k,j)=S_ww_lin(i,k,j)<a name='7929'>
<a name='7930'>
      P_ru(i,k,j)=FACTOR*S_ru(i,k,j)<a name='7931'>
      P_rv(i,k,j)=FACTOR*S_rv(i,k,j)<a name='7932'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='7933'>
      P_u_lin(i,k,j)=FACTOR*S_u_lin(i,k,j)<a name='7934'>
      P_v_lin(i,k,j)=FACTOR*S_v_lin(i,k,j)<a name='7935'>
      P_ww_lin(i,k,j)=FACTOR*S_ww_lin(i,k,j)<a name='7936'>
<a name='7937'>
      B_ru(i,k,j)=P_ru(i,k,j)<a name='7938'>
      B_rv(i,k,j)=P_rv(i,k,j)<a name='7939'>
      B_ww(i,k,j)=P_ww(i,k,j)<a name='7940'>
      B_u_lin(i,k,j)=P_u_lin(i,k,j)<a name='7941'>
      B_v_lin(i,k,j)=P_v_lin(i,k,j)<a name='7942'>
      B_ww_lin(i,k,j)=P_ww_lin(i,k,j)<a name='7943'>
   enddo<a name='7944'>
   enddo<a name='7945'>
   enddo<a name='7946'>
   do i=ims,ime<a name='7947'>
   do j=jms,jme<a name='7948'>
      muu(i,j)=S_muu(i,j)<a name='7949'>
      muv(i,j)=S_muv(i,j)<a name='7950'>
<a name='7951'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='7952'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='7953'>
<a name='7954'>
      B_muu(i,j)=P_muu(i,j)<a name='7955'>
      B_muv(i,j)=P_muv(i,j)<a name='7956'>
   enddo<a name='7957'>
   enddo<a name='7958'>
   do i=ims,ime<a name='7959'>
   do k=kms,kme<a name='7960'>
   do j=jms,jme<a name='7961'>
      ru_m(i,k,j)=S_ru_m(i,k,j)<a name='7962'>
      rv_m(i,k,j)=S_rv_m(i,k,j)<a name='7963'>
      ww_m(i,k,j)=S_ww_m(i,k,j)<a name='7964'>
<a name='7965'>
      P_ru_m(i,k,j)=FACTOR*S_ru_m(i,k,j)<a name='7966'>
      P_rv_m(i,k,j)=FACTOR*S_rv_m(i,k,j)<a name='7967'>
      P_ww_m(i,k,j)=FACTOR*S_ww_m(i,k,j)<a name='7968'>
<a name='7969'>
      B_ru_m(i,k,j)=P_ru_m(i,k,j)<a name='7970'>
      B_rv_m(i,k,j)=P_rv_m(i,k,j)<a name='7971'>
      B_ww_m(i,k,j)=P_ww_m(i,k,j)<a name='7972'>
<a name='7973'>
      K_ru_m(i,k,j)=ru_m(i,k,j)<a name='7974'>
      K_rv_m(i,k,j)=rv_m(i,k,j)<a name='7975'>
      K_ww_m(i,k,j)=ww_m(i,k,j)<a name='7976'>
   enddo<a name='7977'>
   enddo<a name='7978'>
   enddo<a name='7979'>
<a name='7980'>
<font color=#447700>!  TGL<a name='7981'></font>
<a name='7982'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_SUMFLUX'>g_sumflux</A><A href='../../html_code/dyn_em/module_check.F.html#T_SUMFLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SUMFLUX_2">( ru, P_ru, rv, P_rv, ww, P_ww, u_lin, P_u_lin, v_lin, P_v_lin, ww_lin, P_ww_lin, muu, P_muu, muv, P_muv, ru_m,&amp;<a name='7983'>
&amp; P_ru_m, rv_m, P_rv_m, ww_m, P_ww_m, msfu, msfv, iteration, number_of_small_timesteps, ide, jde, kde, ims, ime, jms, jme, kms, &amp;<a name='7984'>
&amp;kme, its, ite, jts, jte, kts, kte )<a name='7985'>
<a name='7986'>
   VAL_L=0.<a name='7987'>
   do i=its,ite<a name='7988'>
   do k=kts,kte<a name='7989'>
   do j=jts,jte<a name='7990'>
      VAL_L=VAL_L   +P_ru_m(i,k,j)*P_ru_m(i,k,j)      &amp;<a name='7991'>
                    +P_rv_m(i,k,j)*P_rv_m(i,k,j)      &amp;<a name='7992'>
                    +P_ww_m(i,k,j)*P_ww_m(i,k,j)<a name='7993'>
   enddo<a name='7994'>
   enddo<a name='7995'>
   enddo<a name='7996'>
<a name='7997'>
#ifdef DM_PARALLEL<a name='7998'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='7999'>
                       comm, IERROR )<a name='8000'>
   VAL_L = nsum <a name='8001'>
#endif<a name='8002'>
<a name='8003'>
   do i=ims,ime<a name='8004'>
   do k=kms,kme<a name='8005'>
   do j=jms,jme<a name='8006'>
      P_ru(i,k,j)=0.0<a name='8007'>
      P_rv(i,k,j)=0.0<a name='8008'>
      P_ww(i,k,j)=0.0<a name='8009'>
      P_u_lin(i,k,j)=0.0<a name='8010'>
      P_v_lin(i,k,j)=0.0<a name='8011'>
      P_ww_lin(i,k,j)=0.0<a name='8012'>
   enddo<a name='8013'>
   enddo<a name='8014'>
   enddo<a name='8015'>
   do i=ims,ime<a name='8016'>
   do j=jms,jme<a name='8017'>
      P_muu(i,j)=0.0<a name='8018'>
      P_muv(i,j)=0.0<a name='8019'>
   enddo<a name='8020'>
   enddo<a name='8021'>
<a name='8022'>
<font color=#447700>!  ADJ<a name='8023'></font>
<a name='8024'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_ad.F.html#A_SUMFLUX'>a_sumflux</A><A href='../../html_code/dyn_em/module_check.F.html#T_SUMFLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_SUMFLUX_1">( P_ru, P_rv, P_ww, u_lin, P_u_lin, v_lin, P_v_lin, P_ww_lin, muu, P_muu, muv, P_muv, P_ru_m, P_rv_m, P_ww_m, &amp;<a name='8025'>
&amp;msfu, msfv, iteration, number_of_small_timesteps, ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='8026'>
<a name='8027'>
   VAL_A=0.<a name='8028'>
   do i=its,ite<a name='8029'>
   do k=kts,kte<a name='8030'>
   do j=jts,jte<a name='8031'>
      VAL_A=VAL_A+P_ru(i,k,j)*B_ru(i,k,j)         &amp;<a name='8032'>
               +P_rv(i,k,j)*B_rv(i,k,j)            &amp;<a name='8033'>
               +P_ww(i,k,j)*B_ww(i,k,j)            &amp;<a name='8034'>
               +P_u_lin(i,k,j)*B_u_lin(i,k,j)              &amp;<a name='8035'>
               +P_v_lin(i,k,j)*B_v_lin(i,k,j)              &amp;<a name='8036'>
               +P_ww_lin(i,k,j)*B_ww_lin(i,k,j)  <a name='8037'>
   enddo<a name='8038'>
   enddo<a name='8039'>
   enddo<a name='8040'>
   do i=its,ite<a name='8041'>
   do j=jts,jte<a name='8042'>
      VAL_A=VAL_A +P_muu(i,j)*B_muu(i,j)    &amp;<a name='8043'>
               +P_muv(i,j)*B_muv(i,j)<a name='8044'>
   enddo<a name='8045'>
   enddo<a name='8046'>
<a name='8047'>
   do i=its,ite<a name='8048'>
   do k=kts,kte<a name='8049'>
   do j=jts,jte<a name='8050'>
      VAL_A=VAL_A + P_ru_m(i,k,j)*B_ru_m(i,k,j)      &amp;<a name='8051'>
                    +P_rv_m(i,k,j)*B_rv_m(i,k,j)      &amp;<a name='8052'>
                    +P_ww_m(i,k,j)*B_ww_m(i,k,j)<a name='8053'>
   enddo<a name='8054'>
   enddo<a name='8055'>
   enddo<a name='8056'>
<a name='8057'>
#ifdef DM_PARALLEL<a name='8058'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='8059'>
                       comm, IERROR )<a name='8060'>
   VAL_A = nsum <a name='8061'>
#endif<a name='8062'>
<a name='8063'>
   print*, '                '<a name='8064'>
   write(6,*) 'a_sumflux: '<a name='8065'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='8066'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='8067'>
<a name='8068'>
<font color=#447700>!  RECOVER<a name='8069'></font>
<a name='8070'>
   do i=ims,ime<a name='8071'>
   do k=kms,kme<a name='8072'>
   do j=jms,jme<a name='8073'>
      ru(i,k,j)=S_ru(i,k,j)<a name='8074'>
      rv(i,k,j)=S_rv(i,k,j)<a name='8075'>
      ww(i,k,j)=S_ww(i,k,j)<a name='8076'>
      u_lin(i,k,j)=S_u_lin(i,k,j)<a name='8077'>
      v_lin(i,k,j)=S_v_lin(i,k,j)<a name='8078'>
      ww_lin(i,k,j)=S_ww_lin(i,k,j)<a name='8079'>
   enddo<a name='8080'>
   enddo<a name='8081'>
   enddo<a name='8082'>
   do i=ims,ime<a name='8083'>
   do j=jms,jme<a name='8084'>
      muu(i,j)=S_muu(i,j)<a name='8085'>
      muv(i,j)=S_muv(i,j)<a name='8086'>
   enddo<a name='8087'>
   enddo<a name='8088'>
   do i=ims,ime<a name='8089'>
   do k=kms,kme<a name='8090'>
   do j=jms,jme<a name='8091'>
      ru_m(i,k,j)=S_ru_m(i,k,j)<a name='8092'>
      rv_m(i,k,j)=S_rv_m(i,k,j)<a name='8093'>
      ww_m(i,k,j)=S_ww_m(i,k,j)<a name='8094'>
   enddo<a name='8095'>
   enddo<a name='8096'>
   enddo<a name='8097'>
<a name='8098'>
END SUBROUTINE t_sumflux<a name='8099'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='8100'></font>
<a name='8101'>
<A NAME='T_ADVANCE_W'><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8102'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_advance_w</font>( w, rw_tend, ww, u, v,       &amp; <A href='../../call_to/T_ADVANCE_W.html' TARGET='index'>1</A>,<A href='../../call_from/T_ADVANCE_W.html' TARGET='index'>5</A><a name='8103'>
                      mu1, mut, muave, muts,      &amp;<a name='8104'>
                      t_2ave, t_2, t_1,           &amp;<a name='8105'>
                      ph, ph_1, phb, ph_tend,     &amp;<a name='8106'>
                      ht, c2a, cqw, alt, alb,     &amp;<a name='8107'>
                      a, alpha, gamma,            &amp;<a name='8108'>
                      rdx, rdy, dts, t0, epssm,   &amp;<a name='8109'>
                      dnw, fnm, fnp, rdnw, rdn,   &amp;<a name='8110'>
                      cf1, cf2, cf3, msft,        &amp;<a name='8111'>
                      config_flags,               &amp;<a name='8112'>
                      ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='8113'></font>
                      ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='8114'></font>
                      its,ite, jts,jte, kts,kte  )  <font color=#447700>! tile   dims<a name='8115'></font>
<a name='8116'>
  IMPLICIT NONE <font color=#447700>! religion first<a name='8117'></font>
  <a name='8118'>
<font color=#447700>! stuff coming in<a name='8119'></font>
<a name='8120'>
<a name='8121'>
  TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='8122'>
<a name='8123'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='8124'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='8125'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='8126'>
<a name='8127'>
      REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), &amp;<a name='8128'>
            INTENT(INOUT) ::                          &amp;<a name='8129'>
                                             t_2ave,  &amp;<a name='8130'>
                                             w,       &amp;<a name='8131'>
                                             ph<a name='8132'>
<a name='8133'>
<a name='8134'>
      REAL, DIMENSION(  ims:ime , kms:kme, jms:jme ), &amp;<a name='8135'>
            INTENT(IN   ) ::                          &amp;<a name='8136'>
                                             phb,     &amp;<a name='8137'>
                                             alb<a name='8138'>
      REAL, DIMENSION(  ims:ime , kms:kme, jms:jme )  :: &amp;<a name='8139'>
                                             rw_tend, &amp;<a name='8140'>
                                             ww,     &amp;<a name='8141'>
                                             u,       &amp;<a name='8142'>
                                             v,       &amp;<a name='8143'>
                                             t_2,     &amp;<a name='8144'>
                                             t_1,     &amp;<a name='8145'>
                                             ph_1,    &amp;<a name='8146'>
                                             ph_tend, &amp;<a name='8147'>
                                             alpha,   &amp;<a name='8148'>
                                             gamma,   &amp;<a name='8149'>
                                             a,       &amp;<a name='8150'>
                                             c2a,     &amp;<a name='8151'>
                                             cqw,     &amp;<a name='8152'>
                                             alt<a name='8153'>
<a name='8154'>
      REAL, DIMENSION( ims:ime , jms:jme ), &amp;<a name='8155'>
            INTENT(IN   )  ::               &amp;<a name='8156'>
                                   ht,      &amp;<a name='8157'>
                                   msft<a name='8158'>
      REAL, DIMENSION( ims:ime , jms:jme ) :: &amp;<a name='8159'>
                                   mu1,     &amp;<a name='8160'>
                                   mut,     &amp;<a name='8161'>
                                   muave,   &amp;<a name='8162'>
                                   muts<a name='8163'>
<a name='8164'>
      REAL, DIMENSION( kms:kme ),  INTENT(IN   )  :: fnp,     &amp;<a name='8165'>
                                                     fnm,     &amp;<a name='8166'>
                                                     rdnw,    &amp;<a name='8167'>
                                                     rdn,     &amp;<a name='8168'>
                                                     dnw<a name='8169'>
<a name='8170'>
      REAL,   INTENT(IN   )  :: rdx,     &amp;<a name='8171'>
                                rdy,     &amp;<a name='8172'>
                                dts,     &amp;<a name='8173'>
                                cf1,     &amp;<a name='8174'>
                                cf2,     &amp;<a name='8175'>
                                cf3,     &amp;<a name='8176'>
                                t0,      &amp;<a name='8177'>
                                epssm<a name='8178'>
<a name='8179'>
<font color=#447700>!  Stack based 3d data, tile size.<a name='8180'></font>
<a name='8181'>
      REAL, DIMENSION( its:ite ) :: mut_inv, msft_inv<a name='8182'>
      REAL, DIMENSION( its:ite, kts:kte ) :: rhs, wdwn<a name='8183'>
      INTEGER :: i,j,k, i_start, i_end, j_start, j_end, k_start, k_end<a name='8184'>
<a name='8185'>
<font color=#447700>!  IN variables<a name='8186'></font>
<a name='8187'>
      REAL, DIMENSION(  ims:ime , kms:kme, jms:jme ) :: &amp;<a name='8188'>
                                             S_rw_tend, &amp;<a name='8189'>
                                             S_ww,     &amp;<a name='8190'>
                                             S_u,       &amp;<a name='8191'>
                                             S_v,       &amp;<a name='8192'>
                                             S_t_2,     &amp;<a name='8193'>
                                             S_t_1,     &amp;<a name='8194'>
                                             S_ph_1,    &amp;<a name='8195'>
                                             S_ph_tend, &amp;<a name='8196'>
                                             S_alpha,   &amp;<a name='8197'>
                                             S_gamma,   &amp;<a name='8198'>
                                             S_a,       &amp;<a name='8199'>
                                             S_c2a,     &amp;<a name='8200'>
                                             S_cqw,     &amp;<a name='8201'>
                                             S_alt<a name='8202'>
      REAL, DIMENSION(  ims:ime , kms:kme, jms:jme ) :: &amp;<a name='8203'>
                                             P_rw_tend, &amp;<a name='8204'>
                                             P_ww,     &amp;<a name='8205'>
                                             P_u,       &amp;<a name='8206'>
                                             P_v,       &amp;<a name='8207'>
                                             P_t_2,     &amp;<a name='8208'>
                                             P_t_1,     &amp;<a name='8209'>
                                             P_ph_1,    &amp;<a name='8210'>
                                             P_ph_tend, &amp;<a name='8211'>
                                             P_alpha,   &amp;<a name='8212'>
                                             P_gamma,   &amp;<a name='8213'>
                                             P_a,       &amp;<a name='8214'>
                                             P_c2a,     &amp;<a name='8215'>
                                             P_cqw,     &amp;<a name='8216'>
                                             P_alt<a name='8217'>
      REAL, DIMENSION(  ims:ime , kms:kme, jms:jme ) :: &amp;<a name='8218'>
                                             B_rw_tend, &amp;<a name='8219'>
                                             B_ww,     &amp;<a name='8220'>
                                             B_u,       &amp;<a name='8221'>
                                             B_v,       &amp;<a name='8222'>
                                             B_t_2,     &amp;<a name='8223'>
                                             B_t_1,     &amp;<a name='8224'>
                                             B_ph_1,    &amp;<a name='8225'>
                                             B_ph_tend, &amp;<a name='8226'>
                                             B_alpha,   &amp;<a name='8227'>
                                             B_gamma,   &amp;<a name='8228'>
                                             B_a,       &amp;<a name='8229'>
                                             B_c2a,     &amp;<a name='8230'>
                                             B_cqw,     &amp;<a name='8231'>
                                             B_alt<a name='8232'>
<a name='8233'>
      REAL, DIMENSION( ims:ime , jms:jme ) :: S_mu1, S_mut, S_muave,S_muts,P_mu1, P_mut, P_muave,P_muts,  &amp;<a name='8234'>
                                              B_mu1, B_mut, B_muave,B_muts<a name='8235'>
<a name='8236'>
<font color=#447700>!  INOUT variables<a name='8237'></font>
<a name='8238'>
      REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) :: S_t_2ave, S_w, S_ph,P_t_2ave, P_w, P_ph<a name='8239'>
      REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) :: K_t_2ave, K_w, K_ph,B_t_2ave, B_w, B_ph<a name='8240'>
<a name='8241'>
<a name='8242'>
<a name='8243'>
   REAL :: SAVE_L, COEF, ALPHA_M, FACTOR, VAL_N, VAL_L, VAL_A<a name='8244'>
   INTEGER :: NT<a name='8245'>
<a name='8246'>
<font color=#447700>!TGL test<a name='8247'></font>
<a name='8248'>
   do i=ims,ime<a name='8249'>
   do k=kms,kme<a name='8250'>
   do j=jms,jme<a name='8251'>
      S_rw_tend(i,k,j)=rw_tend(i,k,j)<a name='8252'>
      S_ww(i,k,j)=ww(i,k,j)<a name='8253'>
      S_u(i,k,j)=u(i,k,j)<a name='8254'>
      S_v(i,k,j)=v(i,k,j)<a name='8255'>
      S_t_1(i,k,j)=t_1(i,k,j)<a name='8256'>
      S_t_2(i,k,j)=t_2(i,k,j)<a name='8257'>
      S_ph_1(i,k,j)=ph_1(i,k,j)<a name='8258'>
      S_ph_tend(i,k,j)=ph_tend(i,k,j)<a name='8259'>
      S_alpha(i,k,j)=alpha(i,k,j)<a name='8260'>
      S_gamma(i,k,j)=gamma(i,k,j)<a name='8261'>
      S_a(i,k,j)=a(i,k,j)<a name='8262'>
      S_c2a(i,k,j)=c2a(i,k,j)<a name='8263'>
      S_cqw(i,k,j)=cqw(i,k,j)<a name='8264'>
      S_alt(i,k,j)=alt(i,k,j)<a name='8265'>
<a name='8266'>
      P_rw_tend(i,k,j)=rw_tend(i,k,j)<a name='8267'>
      P_ww(i,k,j)=ww(i,k,j)<a name='8268'>
      P_u(i,k,j)=u(i,k,j)<a name='8269'>
      P_v(i,k,j)=v(i,k,j)<a name='8270'>
      P_t_1(i,k,j)=t_1(i,k,j)<a name='8271'>
      P_t_2(i,k,j)=t_2(i,k,j)<a name='8272'>
      P_ph_1(i,k,j)=ph_1(i,k,j)<a name='8273'>
      P_ph_tend(i,k,j)=ph_tend(i,k,j)<a name='8274'>
      P_alpha(i,k,j)=alpha(i,k,j)<a name='8275'>
      P_gamma(i,k,j)=gamma(i,k,j)<a name='8276'>
      P_a(i,k,j)=a(i,k,j)<a name='8277'>
      P_c2a(i,k,j)=c2a(i,k,j)<a name='8278'>
      P_cqw(i,k,j)=cqw(i,k,j)<a name='8279'>
      P_alt(i,k,j)=alt(i,k,j)<a name='8280'>
   enddo<a name='8281'>
   enddo<a name='8282'>
   enddo<a name='8283'>
   do i=ims,ime<a name='8284'>
   do j=jms,jme<a name='8285'>
      S_mu1(i,j)=mu1(i,j)<a name='8286'>
      S_mut(i,j)=mut(i,j)<a name='8287'>
      S_muave(i,j)=muave(i,j)<a name='8288'>
      S_muts(i,j)=muts(i,j)<a name='8289'>
<a name='8290'>
      P_mu1(i,j)=mu1(i,j)<a name='8291'>
      P_mut(i,j)=mut(i,j)<a name='8292'>
      P_muave(i,j)=muave(i,j)<a name='8293'>
      P_muts(i,j)=muts(i,j)<a name='8294'>
   enddo<a name='8295'>
   enddo<a name='8296'>
   do i=ims,ime<a name='8297'>
   do k=kms,kme<a name='8298'>
   do j=jms,jme<a name='8299'>
      S_t_2ave(i,k,j)=t_2ave(i,k,j)<a name='8300'>
      S_w(i,k,j)=w(i,k,j)<a name='8301'>
      S_ph(i,k,j)=ph(i,k,j)<a name='8302'>
<a name='8303'>
      P_t_2ave(i,k,j)=t_2ave(i,k,j)<a name='8304'>
      P_w(i,k,j)=w(i,k,j)<a name='8305'>
      P_ph(i,k,j)=ph(i,k,j)<a name='8306'>
<a name='8307'>
      K_t_2ave(i,k,j)=t_2ave(i,k,j)<a name='8308'>
      K_w(i,k,j)=w(i,k,j)<a name='8309'>
      K_ph(i,k,j)=ph(i,k,j)<a name='8310'>
   enddo<a name='8311'>
   enddo<a name='8312'>
   enddo<a name='8313'>
<a name='8314'>
<font color=#447700>!NLM<a name='8315'></font>
<a name='8316'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_W'>advance_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_W_1">( w, rw_tend, ww, u, v,       &amp;<a name='8317'>
                      mu1, mut, muave, muts,      &amp;<a name='8318'>
                      t_2ave, t_2, t_1,           &amp;<a name='8319'>
                      ph, ph_1, phb, ph_tend,     &amp;<a name='8320'>
                      ht, c2a, cqw, alt, alb,     &amp;<a name='8321'>
                      a, alpha, gamma,            &amp;<a name='8322'>
                      rdx, rdy, dts, t0, epssm,   &amp;<a name='8323'>
                      dnw, fnm, fnp, rdnw, rdn,   &amp;<a name='8324'>
                      cf1, cf2, cf3, msft,        &amp;<a name='8325'>
                      config_flags,               &amp;<a name='8326'>
                      ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='8327'></font>
                      ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='8328'></font>
                      its,ite, jts,jte, kts,kte  )  <font color=#447700>! tile   dims<a name='8329'></font>
<a name='8330'>
<a name='8331'>
   do i=its,ite<a name='8332'>
   do k=kts,kte<a name='8333'>
   do j=jts,jte<a name='8334'>
      B_t_2ave(i,k,j)=t_2ave(i,k,j)<a name='8335'>
      B_w(i,k,j)=w(i,k,j)<a name='8336'>
      B_ph(i,k,j)=ph(i,k,j)<a name='8337'>
   enddo<a name='8338'>
   enddo<a name='8339'>
   enddo<a name='8340'>
<a name='8341'>
<font color=#447700>!  TCL<a name='8342'></font>
<a name='8343'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_ADVANCE_W'>g_advance_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_ADVANCE_W_1">( K_w, P_w, rw_tend, P_rw_tend, ww, P_ww, u, P_u, v, P_v, mu1, P_mu1, mut, P_mut, muave, P_muave, muts, P_muts,&amp;<a name='8344'>
&amp; K_t_2ave, P_t_2ave, t_2, P_t_2, t_1, P_t_1, K_ph, P_ph, ph_1, P_ph_1, phb, ph_tend, P_ph_tend, ht, c2a, P_c2a, cqw, P_cqw, alt, &amp;<a name='8345'>
&amp;P_alt, alb, a, P_a, alpha, P_alpha, gamma, P_gamma, rdx, rdy, dts, t0, epssm, fnm, fnp, rdnw, rdn, cf1, cf2, cf3, msft, &amp;<a name='8346'>
&amp;config_flags, ids, ide, jds, jde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='8347'>
<a name='8348'>
   SAVE_L=0.<a name='8349'>
   do i=its,ite<a name='8350'>
   do k=kts,kte<a name='8351'>
   do j=jts,jte<a name='8352'>
      SAVE_L=SAVE_L +P_t_2ave(i,k,j)*P_t_2ave(i,k,j)   &amp;<a name='8353'>
                    +P_w(i,k,j)*P_w(i,k,j)             &amp;<a name='8354'>
                    +P_ph(i,k,j)*P_ph(i,k,j)<a name='8355'>
   enddo<a name='8356'>
   enddo<a name='8357'>
   enddo<a name='8358'>
<a name='8359'>
#ifdef DM_PARALLEL<a name='8360'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='8361'>
                       comm, IERROR )<a name='8362'>
   SAVE_L = nsum <a name='8363'>
#endif<a name='8364'>
<a name='8365'>
   ALPHA_M=1.<a name='8366'>
   DO NT=1,11<a name='8367'>
      ALPHA_M=0.1*ALPHA_M<a name='8368'>
      FACTOR=1.+ALPHA_M<a name='8369'>
   do i=ims,ime<a name='8370'>
   do k=kms,kme<a name='8371'>
   do j=jms,jme<a name='8372'>
      P_rw_tend(i,k,j)=FACTOR*S_rw_tend(i,k,j)<a name='8373'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='8374'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='8375'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='8376'>
      P_t_1(i,k,j)=FACTOR*S_t_1(i,k,j)<a name='8377'>
      P_t_2(i,k,j)=FACTOR*S_t_2(i,k,j)<a name='8378'>
      P_ph_1(i,k,j)=FACTOR*S_ph_1(i,k,j)<a name='8379'>
      P_ph_tend(i,k,j)=FACTOR*S_ph_tend(i,k,j)<a name='8380'>
      P_alpha(i,k,j)=FACTOR*S_alpha(i,k,j)<a name='8381'>
      P_gamma(i,k,j)=FACTOR*S_gamma(i,k,j)<a name='8382'>
      P_a(i,k,j)=FACTOR*S_a(i,k,j)<a name='8383'>
      P_c2a(i,k,j)=FACTOR*S_c2a(i,k,j)<a name='8384'>
      P_cqw(i,k,j)=FACTOR*S_cqw(i,k,j)<a name='8385'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='8386'>
   enddo<a name='8387'>
   enddo<a name='8388'>
   enddo<a name='8389'>
   do i=ims,ime<a name='8390'>
   do j=jms,jme<a name='8391'>
      P_mu1(i,j)=FACTOR*S_mu1(i,j)<a name='8392'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='8393'>
      P_muave(i,j)=FACTOR*S_muave(i,j)<a name='8394'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='8395'>
   enddo<a name='8396'>
   enddo<a name='8397'>
   do i=ims,ime<a name='8398'>
   do k=kms,kme<a name='8399'>
   do j=jms,jme<a name='8400'>
      P_t_2ave(i,k,j)=FACTOR*S_t_2ave(i,k,j)<a name='8401'>
      P_w(i,k,j)=FACTOR*S_w(i,k,j)<a name='8402'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='8403'>
   enddo<a name='8404'>
   enddo<a name='8405'>
   enddo<a name='8406'>
<a name='8407'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_W'>advance_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_W_2">( P_w, P_rw_tend, P_ww, P_u, P_v,       &amp;<a name='8408'>
                      P_mu1, P_mut, P_muave, P_muts,      &amp;<a name='8409'>
                      P_t_2ave, P_t_2, P_t_1,           &amp;<a name='8410'>
                      P_ph, P_ph_1, phb, P_ph_tend,     &amp;<a name='8411'>
                      ht, P_c2a, P_cqw, P_alt, alb,     &amp;<a name='8412'>
                      P_a, P_alpha, P_gamma,            &amp;<a name='8413'>
                      rdx, rdy, dts, t0, epssm,   &amp;<a name='8414'>
                      dnw, fnm, fnp, rdnw, rdn,   &amp;<a name='8415'>
                      cf1, cf2, cf3, msft,        &amp;<a name='8416'>
                      config_flags,               &amp;<a name='8417'>
                      ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='8418'></font>
                      ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='8419'></font>
                      its,ite, jts,jte, kts,kte  )  <font color=#447700>! tile   dims<a name='8420'></font>
<a name='8421'>
      VAL_N=0.<a name='8422'>
   do i=its,ite<a name='8423'>
   do k=kts,kte<a name='8424'>
   do j=jts,jte<a name='8425'>
      VAL_N=VAL_N+(P_t_2ave(i,k,j)-B_t_2ave(i,k,j))*(P_t_2ave(i,k,j)-B_t_2ave(i,k,j))   &amp;<a name='8426'>
                 +(P_w(i,k,j)-B_w(i,k,j))*(P_w(i,k,j)-B_w(i,k,j))             &amp;<a name='8427'>
                 +(P_ph(i,k,j)-B_ph(i,k,j))*(P_ph(i,k,j)-B_ph(i,k,j))<a name='8428'>
   enddo<a name='8429'>
   enddo<a name='8430'>
   enddo<a name='8431'>
<a name='8432'>
#ifdef DM_PARALLEL<a name='8433'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='8434'>
                       comm, IERROR )<a name='8435'>
   VAL_N = nsum <a name='8436'>
#endif<a name='8437'>
<a name='8438'>
      VAL_L=SAVE_L*ALPHA_M**2<a name='8439'>
      COEF=VAL_N/VAL_L<a name='8440'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='8441'>
         'g_advance_w: ALPHA=',ALPHA_M,'  COEF=',COEF, &amp;<a name='8442'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='8443'>
   ENDDO<a name='8444'>
<a name='8445'>
<font color=#447700>!  ADJ test<a name='8446'></font>
<a name='8447'>
   FACTOR=0.1<a name='8448'>
   do i=ims,ime<a name='8449'>
   do k=kms,kme<a name='8450'>
   do j=jms,jme<a name='8451'>
      rw_tend(i,k,j)=S_rw_tend(i,k,j)<a name='8452'>
      ww(i,k,j)=S_ww(i,k,j)<a name='8453'>
      u(i,k,j)=S_u(i,k,j)<a name='8454'>
      v(i,k,j)=S_v(i,k,j)<a name='8455'>
      t_1(i,k,j)=S_t_1(i,k,j)<a name='8456'>
      t_2(i,k,j)=S_t_2(i,k,j)<a name='8457'>
      ph_1(i,k,j)=S_ph_1(i,k,j)<a name='8458'>
      ph_tend(i,k,j)=S_ph_tend(i,k,j)<a name='8459'>
      alpha(i,k,j)=S_alpha(i,k,j)<a name='8460'>
      gamma(i,k,j)=S_gamma(i,k,j)<a name='8461'>
      a(i,k,j)=S_a(i,k,j)<a name='8462'>
      c2a(i,k,j)=S_c2a(i,k,j)<a name='8463'>
      cqw(i,k,j)=S_cqw(i,k,j)<a name='8464'>
      alt(i,k,j)=S_alt(i,k,j)<a name='8465'>
<a name='8466'>
      P_rw_tend(i,k,j)=FACTOR*S_rw_tend(i,k,j)<a name='8467'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='8468'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='8469'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='8470'>
      P_t_1(i,k,j)=FACTOR*S_t_1(i,k,j)<a name='8471'>
      P_t_2(i,k,j)=FACTOR*S_t_2(i,k,j)<a name='8472'>
      P_ph_1(i,k,j)=FACTOR*S_ph_1(i,k,j)<a name='8473'>
      P_ph_tend(i,k,j)=FACTOR*S_ph_tend(i,k,j)<a name='8474'>
      P_alpha(i,k,j)=FACTOR*S_alpha(i,k,j)<a name='8475'>
      P_gamma(i,k,j)=FACTOR*S_gamma(i,k,j)<a name='8476'>
      P_a(i,k,j)=FACTOR*S_a(i,k,j)<a name='8477'>
      P_c2a(i,k,j)=FACTOR*S_c2a(i,k,j)<a name='8478'>
      P_cqw(i,k,j)=FACTOR*S_cqw(i,k,j)<a name='8479'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='8480'>
<a name='8481'>
      B_rw_tend(i,k,j)=P_rw_tend(i,k,j)<a name='8482'>
      B_ww(i,k,j)=P_ww(i,k,j)<a name='8483'>
      B_u(i,k,j)=P_u(i,k,j)<a name='8484'>
      B_v(i,k,j)=P_v(i,k,j)<a name='8485'>
      B_t_1(i,k,j)=P_t_1(i,k,j)<a name='8486'>
      B_t_2(i,k,j)=P_t_2(i,k,j)<a name='8487'>
      B_ph_1(i,k,j)=P_ph_1(i,k,j)<a name='8488'>
      B_ph_tend(i,k,j)=P_ph_tend(i,k,j)<a name='8489'>
      B_alpha(i,k,j)=P_alpha(i,k,j)<a name='8490'>
      B_gamma(i,k,j)=P_gamma(i,k,j)<a name='8491'>
      B_a(i,k,j)=P_a(i,k,j)<a name='8492'>
      B_c2a(i,k,j)=P_c2a(i,k,j)<a name='8493'>
      B_cqw(i,k,j)=P_cqw(i,k,j)<a name='8494'>
      B_alt(i,k,j)=P_alt(i,k,j)<a name='8495'>
   enddo<a name='8496'>
   enddo<a name='8497'>
   enddo<a name='8498'>
   do i=ims,ime<a name='8499'>
   do j=jms,jme<a name='8500'>
      mu1(i,j)=S_mu1(i,j)<a name='8501'>
      mut(i,j)=S_mut(i,j)<a name='8502'>
      muave(i,j)=S_muave(i,j)<a name='8503'>
      muts(i,j)=S_muts(i,j)<a name='8504'>
<a name='8505'>
      P_mu1(i,j)=FACTOR*S_mu1(i,j)<a name='8506'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='8507'>
      P_muave(i,j)=FACTOR*S_muave(i,j)<a name='8508'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='8509'>
<a name='8510'>
      B_mu1(i,j)=P_mu1(i,j)<a name='8511'>
      B_mut(i,j)=P_mut(i,j)<a name='8512'>
      B_muave(i,j)=P_muave(i,j)<a name='8513'>
      B_muts(i,j)=P_muts(i,j)<a name='8514'>
   enddo<a name='8515'>
   enddo<a name='8516'>
   do i=ims,ime<a name='8517'>
   do k=kms,kme<a name='8518'>
   do j=jms,jme<a name='8519'>
      t_2ave(i,k,j)=S_t_2ave(i,k,j)<a name='8520'>
      w(i,k,j)=S_w(i,k,j)<a name='8521'>
      ph(i,k,j)=S_ph(i,k,j)<a name='8522'>
<a name='8523'>
      P_t_2ave(i,k,j)=FACTOR*S_t_2ave(i,k,j)<a name='8524'>
      P_w(i,k,j)=FACTOR*S_w(i,k,j)<a name='8525'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='8526'>
<a name='8527'>
      B_t_2ave(i,k,j)=P_t_2ave(i,k,j)<a name='8528'>
      B_w(i,k,j)=P_w(i,k,j)<a name='8529'>
      B_ph(i,k,j)=P_ph(i,k,j)<a name='8530'>
<a name='8531'>
      K_t_2ave(i,k,j)=t_2ave(i,k,j)<a name='8532'>
      K_w(i,k,j)=w(i,k,j)<a name='8533'>
      K_ph(i,k,j)=ph(i,k,j)<a name='8534'>
   enddo<a name='8535'>
   enddo<a name='8536'>
   enddo<a name='8537'>
<a name='8538'>
<a name='8539'>
<font color=#447700>!  TGL<a name='8540'></font>
<a name='8541'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_ADVANCE_W'>g_advance_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_ADVANCE_W_2">( w, P_w, rw_tend, P_rw_tend, ww, P_ww, u, P_u, v, P_v, mu1, P_mu1, mut, P_mut, muave, P_muave, muts, P_muts,&amp;<a name='8542'>
&amp; t_2ave, P_t_2ave, t_2, P_t_2, t_1, P_t_1, ph, P_ph, ph_1, P_ph_1, phb, ph_tend, P_ph_tend, ht, c2a, P_c2a, cqw, P_cqw, alt, &amp;<a name='8543'>
&amp;P_alt, alb, a, P_a, alpha, P_alpha, gamma, P_gamma, rdx, rdy, dts, t0, epssm, fnm, fnp, rdnw, rdn, cf1, cf2, cf3, msft, &amp;<a name='8544'>
&amp;config_flags, ids, ide, jds, jde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='8545'>
<a name='8546'>
   VAL_L=0.<a name='8547'>
   do i=its,ite<a name='8548'>
   do k=kts,kte<a name='8549'>
   do j=jts,jte<a name='8550'>
      VAL_L=VAL_L + P_t_2ave(i,k,j)*P_t_2ave(i,k,j)   &amp;<a name='8551'>
                  + P_w(i,k,j)*P_w(i,k,j)             &amp;<a name='8552'>
                  + P_ph(i,k,j)*P_ph(i,k,j)<a name='8553'>
   enddo<a name='8554'>
   enddo<a name='8555'>
   enddo<a name='8556'>
<a name='8557'>
#ifdef DM_PARALLEL<a name='8558'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='8559'>
                       comm, IERROR )<a name='8560'>
   VAL_L = nsum <a name='8561'>
#endif<a name='8562'>
<a name='8563'>
   do i=ims,ime<a name='8564'>
   do k=kms,kme<a name='8565'>
   do j=jms,jme<a name='8566'>
      P_rw_tend(i,k,j)=0.0<a name='8567'>
      P_ww(i,k,j)=0.0<a name='8568'>
      P_u(i,k,j)=0.0<a name='8569'>
      P_v(i,k,j)=0.0<a name='8570'>
      P_t_1(i,k,j)=0.0<a name='8571'>
      P_t_2(i,k,j)=0.0<a name='8572'>
      P_ph_1(i,k,j)=0.0<a name='8573'>
      P_ph_tend(i,k,j)=0.0<a name='8574'>
      P_alpha(i,k,j)=0.0<a name='8575'>
      P_gamma(i,k,j)=0.0<a name='8576'>
      P_a(i,k,j)=0.0<a name='8577'>
      P_c2a(i,k,j)=0.0<a name='8578'>
      P_cqw(i,k,j)=0.0<a name='8579'>
      P_alt(i,k,j)=0.0<a name='8580'>
   enddo<a name='8581'>
   enddo<a name='8582'>
   enddo<a name='8583'>
   do i=ims,ime<a name='8584'>
   do j=jms,jme<a name='8585'>
      P_mu1(i,j)=0.0<a name='8586'>
      P_mut(i,j)=0.0<a name='8587'>
      P_muave(i,j)=0.0<a name='8588'>
      P_muts(i,j)=0.0<a name='8589'>
   enddo<a name='8590'>
   enddo<a name='8591'>
<a name='8592'>
<font color=#447700>!  ADJ<a name='8593'></font>
<a name='8594'>
   CALL  <A href='../../html_code/dyn_em/module_small_step_em_ad.F.html#A_ADVANCE_W'>a_advance_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_ADVANCE_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_ADVANCE_W_1">( K_w, P_w, rw_tend, P_rw_tend, ww, P_ww, u, P_u, v, P_v, mu1, P_mu1, mut, P_mut, muave, P_muave, muts, P_muts,&amp;<a name='8595'>
&amp; K_t_2ave, P_t_2ave, t_2, P_t_2, t_1, P_t_1, K_ph, P_ph, ph_1, P_ph_1, phb, ph_tend, P_ph_tend, ht, c2a, P_c2a, cqw, P_cqw, alt, &amp;<a name='8596'>
&amp;P_alt, alb, a, P_a, alpha, P_alpha, gamma, P_gamma, rdx, rdy, dts, t0, epssm, fnm, fnp, rdnw, rdn, cf1, cf2, cf3, msft, &amp;<a name='8597'>
&amp;config_flags, ids, ide, jds, jde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='8598'>
<a name='8599'>
   VAL_A=0.<a name='8600'>
   do i=its,ite<a name='8601'>
   do k=kts,kte<a name='8602'>
   do j=jts,jte<a name='8603'>
      VAL_A=VAL_A + P_rw_tend(i,k,j)*B_rw_tend(i,k,j)      &amp;<a name='8604'>
             + P_ww(i,k,j)*B_ww(i,k,j)                     &amp;<a name='8605'>
             + P_u(i,k,j)*B_u(i,k,j)                       &amp;<a name='8606'>
             + P_v(i,k,j)*B_v(i,k,j)                       &amp;<a name='8607'>
             + P_t_1(i,k,j)*B_t_1(i,k,j)                   &amp;<a name='8608'>
             + P_t_2(i,k,j)*B_t_2(i,k,j)                   &amp;<a name='8609'>
             + P_ph_1(i,k,j)*B_ph_1(i,k,j)                 &amp;<a name='8610'>
             + P_ph_tend(i,k,j)*B_ph_tend(i,k,j)           &amp;<a name='8611'>
             + P_alpha(i,k,j)*B_alpha(i,k,j)               &amp;<a name='8612'>
             + P_gamma(i,k,j)*B_gamma(i,k,j)               &amp;<a name='8613'>
             + P_a(i,k,j)*B_a(i,k,j)                       &amp;<a name='8614'>
             + P_c2a(i,k,j)*B_c2a(i,k,j)                   &amp;<a name='8615'>
             + P_cqw(i,k,j)*B_cqw(i,k,j)                   &amp;<a name='8616'>
             + P_alt(i,k,j)*B_alt(i,k,j)<a name='8617'>
   enddo<a name='8618'>
   enddo<a name='8619'>
   enddo<a name='8620'>
   do i=its,ite<a name='8621'>
   do j=jts,jte<a name='8622'>
      VAL_A=VAL_A + P_mu1(i,j)*B_mu1(i,j)                  &amp;<a name='8623'>
             + P_mut(i,j)*B_mut(i,j)                       &amp;<a name='8624'>
             + P_muave(i,j)*B_muave(i,j)                   &amp;<a name='8625'>
             + P_muts(i,j)*B_muts(i,j)<a name='8626'>
   enddo<a name='8627'>
   enddo<a name='8628'>
   do i=its,ite<a name='8629'>
   do k=kts,kte<a name='8630'>
   do j=jts,jte<a name='8631'>
      VAL_A=VAL_A + P_t_2ave(i,k,j)*B_t_2ave(i,k,j)        &amp;<a name='8632'>
             + P_w(i,k,j)*B_w(i,k,j)                       &amp;<a name='8633'>
             + P_ph(i,k,j)*B_ph(i,k,j)<a name='8634'>
   enddo<a name='8635'>
   enddo<a name='8636'>
   enddo<a name='8637'>
<a name='8638'>
#ifdef DM_PARALLEL<a name='8639'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='8640'>
                       comm, IERROR )<a name='8641'>
   VAL_A = nsum <a name='8642'>
#endif<a name='8643'>
<a name='8644'>
   print*, '                '<a name='8645'>
   write(6,*) 'a_advance_w: '<a name='8646'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='8647'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='8648'>
<a name='8649'>
<font color=#447700>!  RECOVER<a name='8650'></font>
<a name='8651'>
   do i=ims,ime<a name='8652'>
   do k=kms,kme<a name='8653'>
   do j=jms,jme<a name='8654'>
      rw_tend(i,k,j)=S_rw_tend(i,k,j)<a name='8655'>
      ww(i,k,j)=S_ww(i,k,j)<a name='8656'>
      u(i,k,j)=S_u(i,k,j)<a name='8657'>
      v(i,k,j)=S_v(i,k,j)<a name='8658'>
      t_1(i,k,j)=S_t_1(i,k,j)<a name='8659'>
      t_2(i,k,j)=S_t_2(i,k,j)<a name='8660'>
      ph_1(i,k,j)=S_ph_1(i,k,j)<a name='8661'>
      ph_tend(i,k,j)=S_ph_tend(i,k,j)<a name='8662'>
      alpha(i,k,j)=S_alpha(i,k,j)<a name='8663'>
      gamma(i,k,j)=S_gamma(i,k,j)<a name='8664'>
      a(i,k,j)=S_a(i,k,j)<a name='8665'>
      c2a(i,k,j)=S_c2a(i,k,j)<a name='8666'>
      cqw(i,k,j)=S_cqw(i,k,j)<a name='8667'>
      alt(i,k,j)=S_alt(i,k,j)<a name='8668'>
   enddo<a name='8669'>
   enddo<a name='8670'>
   enddo<a name='8671'>
   do i=ims,ime<a name='8672'>
   do j=jms,jme<a name='8673'>
      mu1(i,j)=S_mu1(i,j)<a name='8674'>
      mut(i,j)=S_mut(i,j)<a name='8675'>
      muave(i,j)=S_muave(i,j)<a name='8676'>
      muts(i,j)=S_muts(i,j)<a name='8677'>
   enddo<a name='8678'>
   enddo<a name='8679'>
   do i=ims,ime<a name='8680'>
   do k=kms,kme<a name='8681'>
   do j=jms,jme<a name='8682'>
      t_2ave(i,k,j)=S_t_2ave(i,k,j)<a name='8683'>
      w(i,k,j)=S_w(i,k,j)<a name='8684'>
      ph(i,k,j)=S_ph(i,k,j)<a name='8685'>
   enddo<a name='8686'>
   enddo<a name='8687'>
   enddo<a name='8688'>
<a name='8689'>
END SUBROUTINE t_advance_w<a name='8690'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='8691'></font>
<a name='8692'>
<A NAME='T_SPEC_BDYUPDATE_PH'><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE_PH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8693'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_spec_bdyupdate_ph</font>( ph_save, field,      &amp; <A href='../../call_to/T_SPEC_BDYUPDATE_PH.html' TARGET='index'>1</A>,<A href='../../call_from/T_SPEC_BDYUPDATE_PH.html' TARGET='index'>5</A><a name='8694'>
                               field_tend, mu_tend, muts, dt,     &amp;<a name='8695'>
                               variable_in, config_flags, &amp;<a name='8696'>
                               spec_zone,                  &amp;<a name='8697'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='8698'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='8699'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='8700'></font>
                               its,ite, jts,jte, kts,kte )<a name='8701'>
<a name='8702'>
      IMPLICIT NONE<a name='8703'>
<a name='8704'>
      INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='8705'>
      INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='8706'>
      INTEGER,      INTENT(IN   )    :: ips,ipe, jps,jpe, kps,kpe<a name='8707'>
      INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='8708'>
      INTEGER,      INTENT(IN   )    :: spec_zone<a name='8709'>
      CHARACTER,    INTENT(IN   )    :: variable_in<a name='8710'>
      REAL,         INTENT(IN   )    :: dt<a name='8711'>
<a name='8712'>
<a name='8713'>
      REAL,  DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(INOUT) :: field<a name='8714'>
      REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )                :: field_tend, ph_save<a name='8715'>
      REAL,  DIMENSION( ims:ime , jms:jme )                          :: mu_tend, muts<a name='8716'>
      TYPE( grid_config_rec_type ) config_flags<a name='8717'>
<a name='8718'>
      CHARACTER  :: variable<a name='8719'>
      INTEGER    :: i, j, k, ibs, ibe, jbs, jbe, itf, jtf, ktf<a name='8720'>
      INTEGER    :: b_dist<a name='8721'>
<a name='8722'>
<font color=#447700>!     Local array<a name='8723'></font>
<a name='8724'>
      REAL,  DIMENSION( its:ite , jts:jte ) :: mu_old<a name='8725'>
<a name='8726'>
<font color=#447700>!  IN variables<a name='8727'></font>
<a name='8728'>
      REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )   :: S_field_tend, S_ph_save,P_field_tend, P_ph_save,B_field_tend, B_ph_save<a name='8729'>
      REAL,  DIMENSION( ims:ime , jms:jme )             :: S_mu_tend, S_muts,P_mu_tend, P_muts,B_mu_tend, B_muts<a name='8730'>
<a name='8731'>
<font color=#447700>!  INOUT variables<a name='8732'></font>
<a name='8733'>
      REAL,  DIMENSION( ims:ime , kms:kme , jms:jme ) :: S_field,P_field,B_field,K_field<a name='8734'>
<a name='8735'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='8736'>
   INTEGER :: NT<a name='8737'>
<a name='8738'>
<font color=#447700>!TGL test<a name='8739'></font>
<a name='8740'>
   do i=ims,ime<a name='8741'>
   do k=kms,kme<a name='8742'>
   do j=jms,jme<a name='8743'>
      S_field_tend(i,k,j)=field_tend(i,k,j)<a name='8744'>
      S_ph_save(i,k,j)=ph_save(i,k,j)<a name='8745'>
<a name='8746'>
      P_field_tend(i,k,j)=field_tend(i,k,j)<a name='8747'>
      P_ph_save(i,k,j)=ph_save(i,k,j)<a name='8748'>
   enddo<a name='8749'>
   enddo<a name='8750'>
   enddo<a name='8751'>
   do i=ims,ime<a name='8752'>
   do j=jms,jme<a name='8753'>
      S_mu_tend(i,j)=mu_tend(i,j)<a name='8754'>
      S_muts(i,j)=muts(i,j)<a name='8755'>
<a name='8756'>
      P_mu_tend(i,j)=mu_tend(i,j)<a name='8757'>
      P_muts(i,j)=muts(i,j)<a name='8758'>
   enddo<a name='8759'>
   enddo<a name='8760'>
   do i=ims,ime<a name='8761'>
   do k=kms,kme<a name='8762'>
   do j=jms,jme<a name='8763'>
      S_field(i,k,j)=field(i,k,j)<a name='8764'>
      P_field(i,k,j)=field(i,k,j)<a name='8765'>
      K_field(i,k,j)=field(i,k,j)<a name='8766'>
   enddo<a name='8767'>
   enddo<a name='8768'>
   enddo<a name='8769'>
<a name='8770'>
<font color=#447700>!NLM<a name='8771'></font>
<a name='8772'>
   CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDYUPDATE_PH'>spec_bdyupdate_ph</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE_PH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_PH_1">( ph_save, field,      &amp;<a name='8773'>
                               field_tend, mu_tend, muts, dt,     &amp;<a name='8774'>
                               variable_in, config_flags, &amp;<a name='8775'>
                               spec_zone,                  &amp;<a name='8776'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='8777'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='8778'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='8779'></font>
                               its,ite, jts,jte, kts,kte )<a name='8780'>
<a name='8781'>
   do i=its,ite<a name='8782'>
   do k=kts,kte<a name='8783'>
   do j=jts,jte<a name='8784'>
      B_field(i,k,j)=field(i,k,j)<a name='8785'>
   enddo<a name='8786'>
   enddo<a name='8787'>
   enddo<a name='8788'>
<a name='8789'>
<font color=#447700>!  TCL<a name='8790'></font>
<a name='8791'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_tl.F.html#G_SPEC_BDYUPDATE_PH'>g_spec_bdyupdate_ph</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE_PH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SPEC_BDYUPDATE_PH_1">( ph_save, P_ph_save, K_field, P_field, field_tend, P_field_tend, mu_tend, P_mu_tend, muts, P_muts, dt,&amp;<a name='8792'>
&amp; variable_in, spec_zone, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='8793'>
<a name='8794'>
   SAVE_L=0.<a name='8795'>
   do i=its,ite<a name='8796'>
   do k=kts,kte<a name='8797'>
   do j=jts,jte<a name='8798'>
      SAVE_L=SAVE_L + P_field(i,k,j)*P_field(i,k,j)<a name='8799'>
   enddo<a name='8800'>
   enddo<a name='8801'>
   enddo<a name='8802'>
<a name='8803'>
#ifdef DM_PARALLEL<a name='8804'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='8805'>
                       comm, IERROR )<a name='8806'>
   SAVE_L = nsum <a name='8807'>
#endif<a name='8808'>
<a name='8809'>
   ALPHA=1.<a name='8810'>
   DO NT=1,11<a name='8811'>
      ALPHA=0.1*ALPHA<a name='8812'>
      FACTOR=1.+ALPHA<a name='8813'>
   do i=ims,ime<a name='8814'>
   do k=kms,kme<a name='8815'>
   do j=jms,jme<a name='8816'>
      P_field_tend(i,k,j)=FACTOR*S_field_tend(i,k,j)<a name='8817'>
      P_ph_save(i,k,j)=FACTOR*S_ph_save(i,k,j)<a name='8818'>
   enddo<a name='8819'>
   enddo<a name='8820'>
   enddo<a name='8821'>
   do i=ims,ime<a name='8822'>
   do j=jms,jme<a name='8823'>
      P_mu_tend(i,j)=FACTOR*S_mu_tend(i,j)<a name='8824'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='8825'>
   enddo<a name='8826'>
   enddo<a name='8827'>
   do i=ims,ime<a name='8828'>
   do k=kms,kme<a name='8829'>
   do j=jms,jme<a name='8830'>
      P_field(i,k,j)=FACTOR*S_field(i,k,j)<a name='8831'>
   enddo<a name='8832'>
   enddo<a name='8833'>
   enddo<a name='8834'>
<a name='8835'>
   CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDYUPDATE_PH'>spec_bdyupdate_ph</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE_PH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_PH_2">( P_ph_save, P_field,      &amp;<a name='8836'>
                               P_field_tend, P_mu_tend, P_muts, dt,     &amp;<a name='8837'>
                               variable_in, config_flags, &amp;<a name='8838'>
                               spec_zone,                  &amp;<a name='8839'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='8840'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='8841'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='8842'></font>
                               its,ite, jts,jte, kts,kte )<a name='8843'>
<a name='8844'>
      VAL_N=0.<a name='8845'>
      do i=its,ite<a name='8846'>
      do k=kts,kte<a name='8847'>
      do j=jts,jte<a name='8848'>
         VAL_N=VAL_N+(P_field(i,k,j) -B_field(i,k,j))*(P_field(i,k,j) -B_field(i,k,j))<a name='8849'>
   enddo<a name='8850'>
   enddo<a name='8851'>
   enddo<a name='8852'>
<a name='8853'>
#ifdef DM_PARALLEL<a name='8854'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='8855'>
                       comm, IERROR )<a name='8856'>
   VAL_N = nsum <a name='8857'>
#endif<a name='8858'>
<a name='8859'>
      VAL_L=SAVE_L*ALPHA**2<a name='8860'>
      COEF=VAL_N/VAL_L<a name='8861'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='8862'>
         'g_spec_bdyupdate_ph: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='8863'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='8864'>
   ENDDO<a name='8865'>
<a name='8866'>
<font color=#447700>!  ADJ test<a name='8867'></font>
<a name='8868'>
   FACTOR=0.1<a name='8869'>
   do i=ims,ime<a name='8870'>
   do k=kms,kme<a name='8871'>
   do j=jms,jme<a name='8872'>
      field_tend(i,k,j)=S_field_tend(i,k,j)<a name='8873'>
      ph_save(i,k,j)=S_ph_save(i,k,j)<a name='8874'>
<a name='8875'>
      P_field_tend(i,k,j)=FACTOR*S_field_tend(i,k,j)<a name='8876'>
      P_ph_save(i,k,j)=FACTOR*S_ph_save(i,k,j)<a name='8877'>
<a name='8878'>
      B_field_tend(i,k,j)=P_field_tend(i,k,j)<a name='8879'>
      B_ph_save(i,k,j)=P_ph_save(i,k,j)<a name='8880'>
   enddo<a name='8881'>
   enddo<a name='8882'>
   enddo<a name='8883'>
   do i=ims,ime<a name='8884'>
   do j=jms,jme<a name='8885'>
      mu_tend(i,j)=S_mu_tend(i,j)<a name='8886'>
      muts(i,j)=S_muts(i,j)<a name='8887'>
<a name='8888'>
      P_mu_tend(i,j)=FACTOR*S_mu_tend(i,j)<a name='8889'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='8890'>
<a name='8891'>
      B_mu_tend(i,j)=P_mu_tend(i,j)<a name='8892'>
      B_muts(i,j)=P_muts(i,j)<a name='8893'>
   enddo<a name='8894'>
   enddo<a name='8895'>
   do i=ims,ime<a name='8896'>
   do k=kms,kme<a name='8897'>
   do j=jms,jme<a name='8898'>
      field(i,k,j)=S_field(i,k,j)<a name='8899'>
      P_field(i,k,j)=FACTOR*S_field(i,k,j)<a name='8900'>
      B_field(i,k,j)=P_field(i,k,j)<a name='8901'>
      K_field(i,k,j)=field(i,k,j)<a name='8902'>
   enddo<a name='8903'>
   enddo<a name='8904'>
   enddo<a name='8905'>
<a name='8906'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_tl.F.html#G_SPEC_BDYUPDATE_PH'>g_spec_bdyupdate_ph</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE_PH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SPEC_BDYUPDATE_PH_2">( ph_save, P_ph_save, field, P_field, field_tend, P_field_tend, mu_tend, P_mu_tend, muts, P_muts, dt,&amp;<a name='8907'>
&amp; variable_in, spec_zone, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='8908'>
<a name='8909'>
   VAL_L=0.<a name='8910'>
   do i=its,ite<a name='8911'>
   do k=kts,kte<a name='8912'>
   do j=jts,jte<a name='8913'>
      VAL_L=VAL_L + P_field(i,k,j)*P_field(i,k,j)<a name='8914'>
   enddo<a name='8915'>
   enddo<a name='8916'>
   enddo<a name='8917'>
<a name='8918'>
#ifdef DM_PARALLEL<a name='8919'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='8920'>
                       comm, IERROR )<a name='8921'>
   VAL_L = nsum <a name='8922'>
#endif<a name='8923'>
<a name='8924'>
   do i=ims,ime<a name='8925'>
   do k=kms,kme<a name='8926'>
   do j=jms,jme<a name='8927'>
      P_field_tend(i,k,j)=0.0<a name='8928'>
      P_ph_save(i,k,j)=0.0<a name='8929'>
   enddo<a name='8930'>
   enddo<a name='8931'>
   enddo<a name='8932'>
   do i=ims,ime<a name='8933'>
   do j=jms,jme<a name='8934'>
      P_mu_tend(i,j)=0.0<a name='8935'>
      P_muts(i,j)=0.0<a name='8936'>
   enddo<a name='8937'>
   enddo<a name='8938'>
<a name='8939'>
<font color=#447700>!  ADJ<a name='8940'></font>
<a name='8941'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_ad.F.html#A_SPEC_BDYUPDATE_PH'>a_spec_bdyupdate_ph</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE_PH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_SPEC_BDYUPDATE_PH_1">( ph_save, P_ph_save, K_field, P_field, field_tend, P_field_tend, mu_tend, P_mu_tend, muts, P_muts, dt,&amp;<a name='8942'>
&amp; variable_in, spec_zone, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='8943'>
<a name='8944'>
   VAL_A=0.<a name='8945'>
   do i=its,ite<a name='8946'>
   do k=kts,kte<a name='8947'>
   do j=jts,jte<a name='8948'>
      VAL_A=VAL_A + P_field_tend(i,k,j)*B_field_tend(i,k,j) &amp;<a name='8949'>
                    + P_ph_save(i,k,j)*B_ph_save(i,k,j)<a name='8950'>
   enddo<a name='8951'>
   enddo<a name='8952'>
   enddo<a name='8953'>
   do i=its,ite<a name='8954'>
   do j=jts,jte<a name='8955'>
      VAL_A=VAL_A + P_mu_tend(i,j)*B_mu_tend(i,j) &amp;<a name='8956'>
                    + P_muts(i,j)*B_muts(i,j)<a name='8957'>
   enddo<a name='8958'>
   enddo<a name='8959'>
   do i=its,ite<a name='8960'>
   do k=kts,kte<a name='8961'>
   do j=jts,jte<a name='8962'>
      VAL_A=VAL_A + P_field(i,k,j)*B_field(i,k,j)<a name='8963'>
   enddo<a name='8964'>
   enddo<a name='8965'>
   enddo<a name='8966'>
<a name='8967'>
#ifdef DM_PARALLEL<a name='8968'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='8969'>
                       comm, IERROR )<a name='8970'>
   VAL_A = nsum <a name='8971'>
#endif<a name='8972'>
<a name='8973'>
   print*, '                '<a name='8974'>
   write(6,*) 'a_spec_bdyupdate_ph: '<a name='8975'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='8976'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='8977'>
<a name='8978'>
<font color=#447700>!  RECOVER<a name='8979'></font>
<a name='8980'>
   do i=ims,ime<a name='8981'>
   do k=kms,kme<a name='8982'>
   do j=jms,jme<a name='8983'>
      field_tend(i,k,j)=S_field_tend(i,k,j)<a name='8984'>
      ph_save(i,k,j)=S_ph_save(i,k,j)<a name='8985'>
   enddo<a name='8986'>
   enddo<a name='8987'>
   enddo<a name='8988'>
   do i=ims,ime<a name='8989'>
   do j=jms,jme<a name='8990'>
      mu_tend(i,j)=S_mu_tend(i,j)<a name='8991'>
      muts(i,j)=S_muts(i,j)<a name='8992'>
   enddo<a name='8993'>
   enddo<a name='8994'>
   do i=ims,ime<a name='8995'>
   do k=kms,kme<a name='8996'>
   do j=jms,jme<a name='8997'>
      field(i,k,j)=S_field(i,k,j)<a name='8998'>
   enddo<a name='8999'>
   enddo<a name='9000'>
   enddo<a name='9001'>
<a name='9002'>
END SUBROUTINE t_spec_bdyupdate_ph<a name='9003'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='9004'></font>
<A NAME='T_CALC_MU_UV_1'><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_MU_UV_1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9005'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_calc_mu_uv_1</font> ( config_flags,                 &amp; <A href='../../call_to/T_CALC_MU_UV_1.html' TARGET='index'>1</A>,<A href='../../call_from/T_CALC_MU_UV_1.html' TARGET='index'>5</A><a name='9006'>
                          mu, muu, muv,                 &amp;<a name='9007'>
                          ids, ide, jds, jde, kds, kde, &amp;<a name='9008'>
                          ims, ime, jms, jme, kms, kme, &amp;<a name='9009'>
                          its, ite, jts, jte, kts, kte )<a name='9010'>
<a name='9011'>
   IMPLICIT NONE<a name='9012'>
<a name='9013'>
   <font color=#447700>! Input data<a name='9014'></font>
<a name='9015'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='9016'>
<a name='9017'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='9018'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='9019'>
                                       its, ite, jts, jte, kts, kte<a name='9020'>
<a name='9021'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(  OUT) :: muu, muv<a name='9022'>
   REAL, DIMENSION( ims:ime , jms:jme )                 :: mu<a name='9023'>
<a name='9024'>
   <font color=#447700>!  local stuff<a name='9025'></font>
<a name='9026'>
   INTEGER :: i, j, itf, jtf, im, jm<a name='9027'>
<a name='9028'>
<font color=#447700>!  IN variables<a name='9029'></font>
<a name='9030'>
   REAL, DIMENSION( ims:ime , jms:jme )  :: S_mu,P_mu,B_mu<a name='9031'>
<a name='9032'>
<font color=#447700>!  OUT variables<a name='9033'></font>
<a name='9034'>
   REAL, DIMENSION( ims:ime , jms:jme )  :: P_muu, P_muv,B_muu, B_muv<a name='9035'>
<a name='9036'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='9037'>
   INTEGER :: NT<a name='9038'>
<a name='9039'>
<font color=#447700>!TGL test<a name='9040'></font>
<a name='9041'>
   do i=ims,ime<a name='9042'>
   do j=jms,jme<a name='9043'>
      S_mu(i,j)=mu(i,j)<a name='9044'>
      P_mu(i,j)=mu(i,j)<a name='9045'>
      B_mu(i,j)=mu(i,j)<a name='9046'>
   enddo<a name='9047'>
   enddo<a name='9048'>
<a name='9049'>
<font color=#447700>!NLM<a name='9050'></font>
<a name='9051'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_UV_1'>calc_mu_uv_1</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_MU_UV_1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_MU_UV_1_1"> ( config_flags,                 &amp;<a name='9052'>
                          mu, muu, muv,                 &amp;<a name='9053'>
                          ids, ide, jds, jde, kds, kde, &amp;<a name='9054'>
                          ims, ime, jms, jme, kms, kme, &amp;<a name='9055'>
                          its, ite, jts, jte, kts, kte )<a name='9056'>
<a name='9057'>
   do i=its,ite<a name='9058'>
   do j=jts,jte<a name='9059'>
      B_muu(i,j)=muu(i,j)<a name='9060'>
      B_muv(i,j)=muv(i,j)<a name='9061'>
   enddo<a name='9062'>
   enddo<a name='9063'>
<a name='9064'>
<font color=#447700>!  TCL<a name='9065'></font>
<a name='9066'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_CALC_MU_UV_1'>g_calc_mu_uv_1</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_MU_UV_1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALC_MU_UV_1_1">( config_flags, mu, P_mu, muu, P_muu, muv, P_muv, ids, ide, jds, jde, ims, ime, jms, jme, its, ite, jts, &amp;<a name='9067'>
&amp;jte )<a name='9068'>
<a name='9069'>
   SAVE_L=0.<a name='9070'>
   do i=its,ite<a name='9071'>
   do j=jts,jte<a name='9072'>
      SAVE_L=SAVE_L + P_muu(i,j)*P_muu(i,j) + P_muv(i,j)*P_muv(i,j)<a name='9073'>
   enddo<a name='9074'>
   enddo<a name='9075'>
<a name='9076'>
#ifdef DM_PARALLEL<a name='9077'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='9078'>
                       comm, IERROR )<a name='9079'>
   SAVE_L = nsum <a name='9080'>
#endif<a name='9081'>
<a name='9082'>
   ALPHA=1.<a name='9083'>
   DO NT=1,11<a name='9084'>
      ALPHA=0.1*ALPHA<a name='9085'>
      FACTOR=1.+ALPHA<a name='9086'>
   do i=ims,ime<a name='9087'>
   do j=jms,jme<a name='9088'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='9089'>
   enddo<a name='9090'>
   enddo<a name='9091'>
<a name='9092'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_UV_1'>calc_mu_uv_1</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_MU_UV_1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_MU_UV_1_2"> ( config_flags,                 &amp;<a name='9093'>
                          P_mu, P_muu, P_muv,                 &amp;<a name='9094'>
                          ids, ide, jds, jde, kds, kde, &amp;<a name='9095'>
                          ims, ime, jms, jme, kms, kme, &amp;<a name='9096'>
                          its, ite, jts, jte, kts, kte )<a name='9097'>
<a name='9098'>
   VAL_N=0.<a name='9099'>
   do i=its,ite<a name='9100'>
   do j=jts,jte<a name='9101'>
         VAL_N=VAL_N+ (P_muu(i,j)-B_muu(i,j))*(P_muu(i,j)-B_muu(i,j))    &amp;<a name='9102'>
                    + (P_muv(i,j)-B_muv(i,j))*(P_muv(i,j)-B_muv(i,j))<a name='9103'>
   enddo<a name='9104'>
   enddo<a name='9105'>
<a name='9106'>
#ifdef DM_PARALLEL<a name='9107'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='9108'>
                       comm, IERROR )<a name='9109'>
   VAL_N = nsum <a name='9110'>
#endif<a name='9111'>
<a name='9112'>
      VAL_L=SAVE_L*ALPHA**2<a name='9113'>
      COEF=VAL_N/VAL_L<a name='9114'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='9115'>
         'g_calc_mu_uv_1: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='9116'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='9117'>
   ENDDO<a name='9118'>
<a name='9119'>
<font color=#447700>!  ADJ test<a name='9120'></font>
<a name='9121'>
   FACTOR=0.1<a name='9122'>
   do i=ims,ime<a name='9123'>
   do j=jms,jme<a name='9124'>
      mu(i,j)=S_mu(i,j)<a name='9125'>
<a name='9126'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='9127'>
<a name='9128'>
      B_mu(i,j)=P_mu(i,j)<a name='9129'>
   enddo<a name='9130'>
   enddo<a name='9131'>
<a name='9132'>
<font color=#447700>!  TGL<a name='9133'></font>
<a name='9134'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_CALC_MU_UV_1'>g_calc_mu_uv_1</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_MU_UV_1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALC_MU_UV_1_2">( config_flags, mu, P_mu, muu, P_muu, muv, P_muv, ids, ide, jds, jde, ims, ime, jms, jme, its, ite, jts, &amp;<a name='9135'>
&amp;jte )<a name='9136'>
<a name='9137'>
   VAL_L=0.<a name='9138'>
   do i=its,ite<a name='9139'>
   do j=jts,jte<a name='9140'>
      VAL_L=VAL_L +P_muu(i,j)*P_muu(i,j) + P_muv(i,j)*P_muv(i,j)<a name='9141'>
   enddo<a name='9142'>
   enddo<a name='9143'>
<a name='9144'>
#ifdef DM_PARALLEL<a name='9145'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='9146'>
                       comm, IERROR )<a name='9147'>
   VAL_L = nsum <a name='9148'>
#endif<a name='9149'>
<a name='9150'>
   do i=ims,ime<a name='9151'>
   do j=jms,jme<a name='9152'>
      P_mu(i,j)=0.0<a name='9153'>
   enddo<a name='9154'>
   enddo<a name='9155'>
<a name='9156'>
<font color=#447700>!  ADJ<a name='9157'></font>
<a name='9158'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em_ad.F.html#A_CALC_MU_UV_1'>a_calc_mu_uv_1</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_MU_UV_1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_CALC_MU_UV_1_1">( config_flags, P_mu, P_muu, P_muv, ids, ide, jds, jde, ims, ime, jms, jme, its, ite, jts, jte )<a name='9159'>
<a name='9160'>
   VAL_A=0.<a name='9161'>
   do i=its,ite<a name='9162'>
   do j=jts,jte<a name='9163'>
      VAL_A=VAL_A +P_mu(i,j)*B_mu(i,j)<a name='9164'>
   enddo<a name='9165'>
   enddo<a name='9166'>
<a name='9167'>
#ifdef DM_PARALLEL<a name='9168'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='9169'>
                       comm, IERROR )<a name='9170'>
   VAL_A = nsum <a name='9171'>
#endif<a name='9172'>
<a name='9173'>
   print*, '                '<a name='9174'>
   write(6,*) 'a_calc_mu_uv_1: '<a name='9175'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='9176'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='9177'>
<a name='9178'>
<font color=#447700>!  RECOVER<a name='9179'></font>
<a name='9180'>
   do i=ims,ime<a name='9181'>
   do j=jms,jme<a name='9182'>
      mu(i,j)=S_mu(i,j)<a name='9183'>
   enddo<a name='9184'>
   enddo<a name='9185'>
<a name='9186'>
END SUBROUTINE t_calc_mu_uv_1<a name='9187'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='9188'></font>
<a name='9189'>
<A NAME='T_SMALL_STEP_FINISH'><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_FINISH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9190'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_small_step_finish</font>( u_2, u_1, v_2, v_1, w_2, w_1,    &amp; <A href='../../call_to/T_SMALL_STEP_FINISH.html' TARGET='index'>1</A>,<A href='../../call_from/T_SMALL_STEP_FINISH.html' TARGET='index'>5</A><a name='9191'>
                              t_2, t_1, ph_2, ph_1, ww, ww1,   &amp;<a name='9192'>
                              mu_2, mu_1,                      &amp;<a name='9193'>
                              mut, muts, muu, muus, muv, muvs, &amp;<a name='9194'>
                              u_save, v_save, w_save,          &amp;<a name='9195'>
                              t_save, ph_save, mu_save,        &amp;<a name='9196'>
                              msfu, msfv, msft,                &amp;<a name='9197'>
                              h_diabatic,                      &amp;<a name='9198'>
                              number_of_small_timesteps,dts,   &amp;<a name='9199'>
                              ids,ide, jds,jde, kds,kde,       &amp;<a name='9200'>
                              ims,ime, jms,jme, kms,kme,       &amp;<a name='9201'>
                              its,ite, jts,jte, kts,kte       )<a name='9202'>
<a name='9203'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='9204'></font>
<a name='9205'>
<font color=#447700>!  stuff passed in<a name='9206'></font>
<a name='9207'>
<a name='9208'>
<a name='9209'>
<a name='9210'>
  INTEGER,                  INTENT(IN   ) :: ids,ide, jds,jde, kds,kde<a name='9211'>
  INTEGER,                  INTENT(IN   ) :: ims,ime, jms,jme, kms,kme<a name='9212'>
  INTEGER,                  INTENT(IN   ) :: its,ite, jts,jte, kts,kte<a name='9213'>
  INTEGER,                  INTENT(IN   ) :: number_of_small_timesteps<a name='9214'>
  REAL,                     INTENT(IN   ) :: dts<a name='9215'>
<a name='9216'>
<font color=#447700>!  REAL,   DIMENSION(ims:ime, kms:kme, jms:jme)  ::P_ww1,P_ww<a name='9217'></font>
  REAL,   DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN   ) :: u_1, &amp;<a name='9218'>
                                                                 v_1, &amp;<a name='9219'>
                                                                 w_1, &amp;<a name='9220'>
                                                                 t_1, &amp;<a name='9221'>
                                                                 ww1, &amp;<a name='9222'>
                                                                 ph_1<a name='9223'>
<a name='9224'>
  REAL,   DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: u_2, &amp;<a name='9225'>
                                                                 v_2, &amp;<a name='9226'>
                                                                 w_2, &amp;<a name='9227'>
                                                                 t_2, &amp;<a name='9228'>
                                                                 ww,  &amp;<a name='9229'>
                                                                 ph_2<a name='9230'>
<a name='9231'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(IN   ) :: h_diabatic<a name='9232'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)               :: u_save,   &amp;<a name='9233'>
                                                              v_save,   &amp;<a name='9234'>
                                                              w_save,   &amp;<a name='9235'>
                                                              t_save,   &amp;<a name='9236'>
                                                              ph_save<a name='9237'>
<a name='9238'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: muus, muvs<a name='9239'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: mu_2, mu_1<a name='9240'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: mut, muts, &amp;<a name='9241'>
                                                        muu, muv, mu_save<a name='9242'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(IN   ) :: msfu, msfv, msft<a name='9243'>
<a name='9244'>
<a name='9245'>
<font color=#447700>! local stuff<a name='9246'></font>
<a name='9247'>
  INTEGER         :: i,j,k<a name='9248'>
  INTEGER :: i_start, i_end, j_start, j_end, i_endu, j_endv<a name='9249'>
<a name='9250'>
<font color=#447700>! IN variables<a name='9251'></font>
<a name='9252'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)               :: S_u_save,   &amp;<a name='9253'>
                                                              S_v_save,   &amp;<a name='9254'>
                                                              S_w_save,   &amp;<a name='9255'>
                                                              S_t_save,   &amp;<a name='9256'>
                                                              S_ph_save<a name='9257'>
<a name='9258'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)               :: P_u_save,   &amp;<a name='9259'>
                                                              P_v_save,   &amp;<a name='9260'>
                                                              P_w_save,   &amp;<a name='9261'>
                                                              P_t_save,   &amp;<a name='9262'>
                                                              P_ph_save<a name='9263'>
<a name='9264'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme)               :: B_u_save,   &amp;<a name='9265'>
                                                              B_v_save,   &amp;<a name='9266'>
                                                              B_w_save,   &amp;<a name='9267'>
                                                              B_t_save,   &amp;<a name='9268'>
                                                              B_ph_save<a name='9269'>
<a name='9270'>
<font color=#447700>!  INOUT variables<a name='9271'></font>
  REAL,   DIMENSION(ims:ime, kms:kme, jms:jme)                :: S_u_2, &amp;<a name='9272'>
                                                                 S_v_2, &amp;<a name='9273'>
                                                                 S_w_2, &amp;<a name='9274'>
                                                                 S_t_2, &amp;<a name='9275'>
                                                                 S_ph_2<a name='9276'>
  REAL,   DIMENSION(ims:ime, kms:kme, jms:jme)                :: P_u_2, &amp;<a name='9277'>
                                                                 P_v_2, &amp;<a name='9278'>
                                                                 P_w_2, &amp;<a name='9279'>
                                                                 P_t_2, &amp;<a name='9280'>
                                                                 P_ph_2<a name='9281'>
  REAL,   DIMENSION(ims:ime, kms:kme, jms:jme)                :: K_u_2, &amp;<a name='9282'>
                                                                 K_v_2, &amp;<a name='9283'>
                                                                 K_w_2, &amp;<a name='9284'>
                                                                 K_t_2, &amp;<a name='9285'>
                                                                 K_ph_2<a name='9286'>
  REAL,   DIMENSION(ims:ime, kms:kme, jms:jme)                :: B_u_2, &amp;<a name='9287'>
                                                                 B_v_2, &amp;<a name='9288'>
                                                                 B_w_2, &amp;<a name='9289'>
                                                                 B_t_2, &amp;<a name='9290'>
                                                                 B_ph_2<a name='9291'>
<a name='9292'>
  REAL,   DIMENSION(ims:ime, jms:jme) :: S_muus, S_muvs,S_mu_2,S_mut, S_muts,S_muu, S_muv, S_mu_save<a name='9293'>
  REAL,   DIMENSION(ims:ime, jms:jme) :: P_muus, P_muvs,P_mu_2,P_mut, P_muts,P_muu, P_muv, P_mu_save<a name='9294'>
  REAL,   DIMENSION(ims:ime, jms:jme) :: K_muus, K_muvs,K_mu_2,K_mut, K_muts,K_muu, K_muv, K_mu_save<a name='9295'>
  REAL,   DIMENSION(ims:ime, jms:jme) :: B_muus, B_muvs,B_mu_2,B_mut, B_muts,B_muu, B_muv, B_mu_save<a name='9296'>
<a name='9297'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='9298'>
   INTEGER :: NT<a name='9299'>
<a name='9300'>
<font color=#447700>!TGL test<a name='9301'></font>
<a name='9302'>
   do i=ims,ime<a name='9303'>
   do k=kms,kme<a name='9304'>
   do j=jms,jme<a name='9305'>
      S_u_save(i,k,j)=u_save(i,k,j)<a name='9306'>
      S_v_save(i,k,j)=v_save(i,k,j)<a name='9307'>
      S_w_save(i,k,j)=w_save(i,k,j)<a name='9308'>
      S_t_save(i,k,j)=t_save(i,k,j)<a name='9309'>
      S_ph_save(i,k,j)=ph_save(i,k,j)<a name='9310'>
<a name='9311'>
      P_u_save(i,k,j)=u_save(i,k,j)<a name='9312'>
      P_v_save(i,k,j)=v_save(i,k,j)<a name='9313'>
      P_w_save(i,k,j)=w_save(i,k,j)<a name='9314'>
      P_t_save(i,k,j)=t_save(i,k,j)<a name='9315'>
      P_ph_save(i,k,j)=ph_save(i,k,j)<a name='9316'>
   enddo<a name='9317'>
   enddo<a name='9318'>
   enddo<a name='9319'>
<a name='9320'>
   do i=ims,ime<a name='9321'>
   do k=kms,kme<a name='9322'>
   do j=jms,jme<a name='9323'>
      S_u_2(i,k,j)=u_2(i,k,j)<a name='9324'>
      S_v_2(i,k,j)=v_2(i,k,j)<a name='9325'>
      S_w_2(i,k,j)=w_2(i,k,j)<a name='9326'>
      S_t_2(i,k,j)=t_2(i,k,j)<a name='9327'>
      S_ph_2(i,k,j)=ph_2(i,k,j)<a name='9328'>
<a name='9329'>
      P_u_2(i,k,j)=u_2(i,k,j)<a name='9330'>
      P_v_2(i,k,j)=v_2(i,k,j)<a name='9331'>
      P_w_2(i,k,j)=w_2(i,k,j)<a name='9332'>
      P_t_2(i,k,j)=t_2(i,k,j)<a name='9333'>
      P_ph_2(i,k,j)=ph_2(i,k,j)<a name='9334'>
<a name='9335'>
      K_u_2(i,k,j)=u_2(i,k,j)<a name='9336'>
      K_v_2(i,k,j)=v_2(i,k,j)<a name='9337'>
      K_w_2(i,k,j)=w_2(i,k,j)<a name='9338'>
      K_t_2(i,k,j)=t_2(i,k,j)<a name='9339'>
      K_ph_2(i,k,j)=ph_2(i,k,j)<a name='9340'>
   enddo<a name='9341'>
   enddo<a name='9342'>
   enddo<a name='9343'>
   do i=ims,ime<a name='9344'>
   do j=jms,jme<a name='9345'>
      S_muus(i,j)=muus(i,j)<a name='9346'>
      S_muvs(i,j)=muvs(i,j)<a name='9347'>
      S_mu_2(i,j)=mu_2(i,j)<a name='9348'>
      S_mut(i,j)=mut(i,j)<a name='9349'>
      S_muts(i,j)=muts(i,j)<a name='9350'>
      S_muu(i,j)=muu(i,j)<a name='9351'>
      S_muv(i,j)=muv(i,j)<a name='9352'>
      S_mu_save(i,j)=mu_save(i,j)<a name='9353'>
<a name='9354'>
      P_muus(i,j)=muus(i,j)<a name='9355'>
      P_muvs(i,j)=muvs(i,j)<a name='9356'>
      P_mu_2(i,j)=mu_2(i,j)<a name='9357'>
      P_mut(i,j)=mut(i,j)<a name='9358'>
      P_muts(i,j)=muts(i,j)<a name='9359'>
      P_muu(i,j)=muu(i,j)<a name='9360'>
      P_muv(i,j)=muv(i,j)<a name='9361'>
      P_mu_save(i,j)=mu_save(i,j)<a name='9362'>
<a name='9363'>
      K_muus(i,j)=muus(i,j)<a name='9364'>
      K_muvs(i,j)=muvs(i,j)<a name='9365'>
      K_mu_2(i,j)=mu_2(i,j)<a name='9366'>
      K_mut(i,j)=mut(i,j)<a name='9367'>
      K_muts(i,j)=muts(i,j)<a name='9368'>
      K_muu(i,j)=muu(i,j)<a name='9369'>
      K_muv(i,j)=muv(i,j)<a name='9370'>
      K_mu_save(i,j)=mu_save(i,j)<a name='9371'>
   enddo<a name='9372'>
   enddo<a name='9373'>
<a name='9374'>
<font color=#447700>!NLM<a name='9375'></font>
<a name='9376'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_FINISH'>small_step_finish</A><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_FINISH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMALL_STEP_FINISH_1">( u_2, u_1, v_2, v_1, w_2, w_1,    &amp;<a name='9377'>
                              t_2, t_1, ph_2, ph_1, ww, ww1,   &amp;<a name='9378'>
                              mu_2, mu_1,                      &amp;<a name='9379'>
                              mut, muts, muu, muus, muv, muvs, &amp;<a name='9380'>
                              u_save, v_save, w_save,          &amp;<a name='9381'>
                              t_save, ph_save, mu_save,        &amp;<a name='9382'>
                              msfu, msfv, msft,                &amp;<a name='9383'>
                              h_diabatic,                      &amp;<a name='9384'>
                              number_of_small_timesteps,dts,   &amp;<a name='9385'>
                              ids,ide, jds,jde, kds,kde,       &amp;<a name='9386'>
                              ims,ime, jms,jme, kms,kme,       &amp;<a name='9387'>
                              its,ite, jts,jte, kts,kte       )<a name='9388'>
<a name='9389'>
   do i=its,ite<a name='9390'>
   do k=kts,kte<a name='9391'>
   do j=jts,jte<a name='9392'>
      B_u_2(i,k,j)=u_2(i,k,j)<a name='9393'>
      B_v_2(i,k,j)=v_2(i,k,j)<a name='9394'>
      B_w_2(i,k,j)=w_2(i,k,j)<a name='9395'>
      B_t_2(i,k,j)=t_2(i,k,j)<a name='9396'>
      B_ph_2(i,k,j)=ph_2(i,k,j)<a name='9397'>
   enddo<a name='9398'>
   enddo<a name='9399'>
   enddo<a name='9400'>
   do i=its,ite<a name='9401'>
   do j=jts,jte<a name='9402'>
      B_muus(i,j)=muus(i,j)<a name='9403'>
      B_muvs(i,j)=muvs(i,j)<a name='9404'>
      B_mu_2(i,j)=mu_2(i,j)<a name='9405'>
      B_mut(i,j)=mut(i,j)<a name='9406'>
      B_muts(i,j)=muts(i,j)<a name='9407'>
      B_muu(i,j)=muu(i,j)<a name='9408'>
      B_muv(i,j)=muv(i,j)<a name='9409'>
      B_mu_save(i,j)=mu_save(i,j)<a name='9410'>
   enddo<a name='9411'>
   enddo<a name='9412'>
<a name='9413'>
<font color=#447700>!  TCL<a name='9414'></font>
<a name='9415'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_SMALL_STEP_FINISH'>g_small_step_finish</A><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_FINISH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SMALL_STEP_FINISH_1">( K_u_2, P_u_2, K_v_2, P_v_2, K_w_2, P_w_2, K_t_2, P_t_2, K_ph_2, P_ph_2, ww, K_mu_2, P_mu_2, &amp; <a name='9416'>
&amp;K_mut, P_mut, K_muts, &amp;<a name='9417'>
&amp;P_muts, K_muu, P_muu, K_muus, P_muus, K_muv, P_muv, K_muvs, P_muvs, u_save, P_u_save, v_save, P_v_save, w_save, P_w_save, t_save, &amp;<a name='9418'>
&amp;P_t_save, ph_save, P_ph_save, K_mu_save, P_mu_save, msfu, msfv, msft, ide, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, &amp;<a name='9419'>
&amp;jts, jte )<a name='9420'>
<a name='9421'>
<a name='9422'>
   SAVE_L=0.<a name='9423'>
   do i=its,ite<a name='9424'>
   do k=kts,kte<a name='9425'>
   do j=jts,jte<a name='9426'>
      SAVE_L=SAVE_L + P_u_2(i,k,j)*P_u_2(i,k,j)         &amp;<a name='9427'>
                    + P_v_2(i,k,j)*P_v_2(i,k,j)         &amp;<a name='9428'>
                    + P_w_2(i,k,j)*P_w_2(i,k,j)         &amp;<a name='9429'>
                    + P_t_2(i,k,j)*P_t_2(i,k,j)         &amp;<a name='9430'>
                    + P_ph_2(i,k,j)*P_ph_2(i,k,j)<a name='9431'>
   enddo<a name='9432'>
   enddo<a name='9433'>
   enddo<a name='9434'>
   do i=its,ite<a name='9435'>
   do j=jts,jte<a name='9436'>
      SAVE_L=SAVE_L + P_muus(i,j)*P_muus(i,j)            &amp;<a name='9437'>
                    + P_muvs(i,j)*P_muvs(i,j)            &amp;<a name='9438'>
                    + P_mu_2(i,j)*P_mu_2(i,j)            &amp;<a name='9439'>
                    + P_mut(i,j)*P_mut(i,j)            &amp;<a name='9440'>
                    + P_muts(i,j)*P_muts(i,j)            &amp;<a name='9441'>
                    + P_muu(i,j)*P_muu(i,j)            &amp;<a name='9442'>
                    + P_muv(i,j)*P_muv(i,j)            &amp;<a name='9443'>
                    + P_mu_save(i,j)*P_mu_save(i,j)<a name='9444'>
   enddo<a name='9445'>
   enddo<a name='9446'>
<a name='9447'>
#ifdef DM_PARALLEL<a name='9448'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='9449'>
                       comm, IERROR )<a name='9450'>
   SAVE_L = nsum <a name='9451'>
#endif<a name='9452'>
<a name='9453'>
   ALPHA=1.<a name='9454'>
   DO NT=1,11<a name='9455'>
      ALPHA=0.1*ALPHA<a name='9456'>
      FACTOR=1.+ALPHA<a name='9457'>
   do i=ims,ime<a name='9458'>
   do k=kms,kme<a name='9459'>
   do j=jms,jme<a name='9460'>
      P_u_save(i,k,j)=FACTOR*S_u_save(i,k,j)<a name='9461'>
      P_v_save(i,k,j)=FACTOR*S_v_save(i,k,j)<a name='9462'>
      P_w_save(i,k,j)=FACTOR*S_w_save(i,k,j)<a name='9463'>
      P_t_save(i,k,j)=FACTOR*S_t_save(i,k,j)<a name='9464'>
      P_ph_save(i,k,j)=FACTOR*S_ph_save(i,k,j)<a name='9465'>
   enddo<a name='9466'>
   enddo<a name='9467'>
   enddo<a name='9468'>
   do i=ims,ime<a name='9469'>
   do k=kms,kme<a name='9470'>
   do j=jms,jme<a name='9471'>
      P_u_2(i,k,j)=FACTOR*S_u_2(i,k,j)<a name='9472'>
      P_v_2(i,k,j)=FACTOR*S_v_2(i,k,j)<a name='9473'>
      P_w_2(i,k,j)=FACTOR*S_w_2(i,k,j)<a name='9474'>
      P_t_2(i,k,j)=FACTOR*S_t_2(i,k,j)<a name='9475'>
      P_ph_2(i,k,j)=FACTOR*S_ph_2(i,k,j)<a name='9476'>
   enddo<a name='9477'>
   enddo<a name='9478'>
   enddo<a name='9479'>
   do i=ims,ime<a name='9480'>
   do j=jms,jme<a name='9481'>
      P_muus(i,j)=FACTOR*S_muus(i,j)<a name='9482'>
      P_muvs(i,j)=FACTOR*S_muvs(i,j)<a name='9483'>
      P_mu_2(i,j)=FACTOR*S_mu_2(i,j)<a name='9484'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='9485'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='9486'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='9487'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='9488'>
      P_mu_save(i,j)=FACTOR*S_mu_save(i,j)<a name='9489'>
   enddo<a name='9490'>
   enddo<a name='9491'>
<a name='9492'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_FINISH'>small_step_finish</A><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_FINISH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMALL_STEP_FINISH_2">( P_u_2, u_1, P_v_2, v_1, P_w_2, w_1,    &amp;<a name='9493'>
                              P_t_2, t_1, P_ph_2, ph_1, ww, ww1,   &amp;<a name='9494'>
                              P_mu_2, mu_1,                      &amp;<a name='9495'>
                              P_mut, P_muts, P_muu, P_muus, P_muv, P_muvs, &amp;<a name='9496'>
                              P_u_save, P_v_save, P_w_save,          &amp;<a name='9497'>
                              P_t_save, P_ph_save, P_mu_save,        &amp;<a name='9498'>
                              msfu, msfv, msft,                &amp;<a name='9499'>
                              h_diabatic,                      &amp;<a name='9500'>
                              number_of_small_timesteps,dts,   &amp;<a name='9501'>
                              ids,ide, jds,jde, kds,kde,       &amp;<a name='9502'>
                              ims,ime, jms,jme, kms,kme,       &amp;<a name='9503'>
                              its,ite, jts,jte, kts,kte       )<a name='9504'>
<a name='9505'>
   VAL_N=0.<a name='9506'>
   do i=its,ite<a name='9507'>
   do k=kts,kte<a name='9508'>
   do j=jts,jte<a name='9509'>
      VAL_N=VAL_N + (P_u_2(i,k,j)- B_u_2(i,k,j))*(P_u_2(i,k,j)- B_u_2(i,k,j))         &amp;<a name='9510'>
                  + (P_v_2(i,k,j)- B_v_2(i,k,j))*(P_v_2(i,k,j)- B_v_2(i,k,j))         &amp;<a name='9511'>
                  + (P_w_2(i,k,j)- B_w_2(i,k,j))*(P_w_2(i,k,j)- B_w_2(i,k,j))         &amp;<a name='9512'>
                  + (P_t_2(i,k,j)- B_t_2(i,k,j))*(P_t_2(i,k,j)- B_t_2(i,k,j))         &amp;<a name='9513'>
                  + (P_ph_2(i,k,j)- B_ph_2(i,k,j))*(P_ph_2(i,k,j)- B_ph_2(i,k,j))<a name='9514'>
   enddo<a name='9515'>
   enddo<a name='9516'>
   enddo<a name='9517'>
   do i=its,ite<a name='9518'>
   do j=jts,jte<a name='9519'>
      VAL_N=VAL_N   + (P_muus(i,j)- B_muus(i,j))*(P_muus(i,j)- B_muus(i,j))               &amp; <a name='9520'>
                    + (P_muvs(i,j)- B_muvs(i,j))*(P_muvs(i,j)- B_muvs(i,j))               &amp;<a name='9521'>
                    + (P_mu_2(i,j)- B_mu_2(i,j))*(P_mu_2(i,j)- B_mu_2(i,j))               &amp;<a name='9522'>
                    + (P_mut(i,j)- B_mut(i,j))*(P_mut(i,j)- B_mut(i,j))                   &amp;<a name='9523'>
                    + (P_muts(i,j)- B_muts(i,j))*(P_muts(i,j)- B_muts(i,j))               &amp;<a name='9524'>
                    + (P_muu(i,j)- B_muu(i,j))*(P_muu(i,j)- B_muu(i,j))                   &amp;<a name='9525'>
                    + (P_muv(i,j)- B_muv(i,j))*(P_muv(i,j)- B_muv(i,j))                   &amp;<a name='9526'>
                    + (P_mu_save(i,j)- B_mu_save(i,j))*(P_mu_save(i,j)- B_mu_save(i,j)) <a name='9527'>
   enddo<a name='9528'>
   enddo<a name='9529'>
<a name='9530'>
#ifdef DM_PARALLEL<a name='9531'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='9532'>
                       comm, IERROR )<a name='9533'>
   VAL_N = nsum <a name='9534'>
#endif<a name='9535'>
<a name='9536'>
      VAL_L=SAVE_L*ALPHA**2<a name='9537'>
      COEF=VAL_N/VAL_L<a name='9538'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='9539'>
         'g_small_step_finish: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='9540'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='9541'>
   ENDDO<a name='9542'>
<a name='9543'>
<font color=#447700>!  ADJ test<a name='9544'></font>
<a name='9545'>
   FACTOR=0.1<a name='9546'>
   do i=ims,ime<a name='9547'>
   do k=kms,kme<a name='9548'>
   do j=jms,jme<a name='9549'>
      u_save(i,k,j)=S_u_save(i,k,j)<a name='9550'>
      v_save(i,k,j)=S_v_save(i,k,j)<a name='9551'>
      w_save(i,k,j)=S_w_save(i,k,j)<a name='9552'>
      t_save(i,k,j)=S_t_save(i,k,j)<a name='9553'>
      ph_save(i,k,j)=S_ph_save(i,k,j)<a name='9554'>
<a name='9555'>
      P_u_save(i,k,j)=FACTOR*S_u_save(i,k,j)<a name='9556'>
      P_v_save(i,k,j)=FACTOR*S_v_save(i,k,j)<a name='9557'>
      P_w_save(i,k,j)=FACTOR*S_w_save(i,k,j)<a name='9558'>
      P_t_save(i,k,j)=FACTOR*S_t_save(i,k,j)<a name='9559'>
      P_ph_save(i,k,j)=FACTOR*S_ph_save(i,k,j)<a name='9560'>
<a name='9561'>
      B_u_save(i,k,j)=P_u_save(i,k,j)<a name='9562'>
      B_v_save(i,k,j)=P_v_save(i,k,j)<a name='9563'>
      B_w_save(i,k,j)=P_w_save(i,k,j)<a name='9564'>
      B_t_save(i,k,j)=P_t_save(i,k,j)<a name='9565'>
      B_ph_save(i,k,j)=P_ph_save(i,k,j)<a name='9566'>
   enddo<a name='9567'>
   enddo<a name='9568'>
   enddo<a name='9569'>
   do i=ims,ime<a name='9570'>
   do k=kms,kme<a name='9571'>
   do j=jms,jme<a name='9572'>
      u_2(i,k,j)=S_u_2(i,k,j)<a name='9573'>
      v_2(i,k,j)=S_v_2(i,k,j)<a name='9574'>
      w_2(i,k,j)=S_w_2(i,k,j)<a name='9575'>
      t_2(i,k,j)=S_t_2(i,k,j)<a name='9576'>
      ph_2(i,k,j)=S_ph_2(i,k,j)<a name='9577'>
<a name='9578'>
      P_u_2(i,k,j)=FACTOR*S_u_2(i,k,j)<a name='9579'>
      P_v_2(i,k,j)=FACTOR*S_v_2(i,k,j)<a name='9580'>
      P_w_2(i,k,j)=FACTOR*S_w_2(i,k,j)<a name='9581'>
      P_t_2(i,k,j)=FACTOR*S_t_2(i,k,j)<a name='9582'>
      P_ph_2(i,k,j)=FACTOR*S_ph_2(i,k,j)<a name='9583'>
<a name='9584'>
      B_u_2(i,k,j)=P_u_2(i,k,j)<a name='9585'>
      B_v_2(i,k,j)=P_v_2(i,k,j)<a name='9586'>
      B_w_2(i,k,j)=P_w_2(i,k,j)<a name='9587'>
      B_t_2(i,k,j)=P_t_2(i,k,j)<a name='9588'>
      B_ph_2(i,k,j)=P_ph_2(i,k,j)<a name='9589'>
<a name='9590'>
      K_u_2(i,k,j)=u_2(i,k,j)<a name='9591'>
      K_v_2(i,k,j)=v_2(i,k,j)<a name='9592'>
      K_w_2(i,k,j)=w_2(i,k,j)<a name='9593'>
      K_t_2(i,k,j)=t_2(i,k,j)<a name='9594'>
      K_ph_2(i,k,j)=ph_2(i,k,j)<a name='9595'>
   enddo<a name='9596'>
   enddo<a name='9597'>
   enddo<a name='9598'>
   do i=ims,ime<a name='9599'>
   do j=jms,jme<a name='9600'>
      muus(i,j)=S_muus(i,j)<a name='9601'>
      muvs(i,j)=S_muvs(i,j)<a name='9602'>
      mu_2(i,j)=S_mu_2(i,j)<a name='9603'>
      mut(i,j)=S_mut(i,j)<a name='9604'>
      muts(i,j)=S_muts(i,j)<a name='9605'>
      muu(i,j)=S_muu(i,j)<a name='9606'>
      muv(i,j)=S_muv(i,j)<a name='9607'>
      mu_save(i,j)=S_mu_save(i,j)<a name='9608'>
<a name='9609'>
      P_muus(i,j)=FACTOR*S_muus(i,j)<a name='9610'>
      P_muvs(i,j)=FACTOR*S_muvs(i,j)<a name='9611'>
      P_mu_2(i,j)=FACTOR*S_mu_2(i,j)<a name='9612'>
      P_mut(i,j)=FACTOR*S_mut(i,j)<a name='9613'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='9614'>
      P_muu(i,j)=FACTOR*S_muu(i,j)<a name='9615'>
      P_muv(i,j)=FACTOR*S_muv(i,j)<a name='9616'>
      P_mu_save(i,j)=FACTOR*S_mu_save(i,j)<a name='9617'>
<a name='9618'>
      B_muus(i,j)=P_muus(i,j)<a name='9619'>
      B_muvs(i,j)=P_muvs(i,j)<a name='9620'>
      B_mu_2(i,j)=P_mu_2(i,j)<a name='9621'>
      B_mut(i,j)=P_mut(i,j)<a name='9622'>
      B_muts(i,j)=P_muts(i,j)<a name='9623'>
      B_muu(i,j)=P_muu(i,j)<a name='9624'>
      B_muv(i,j)=P_muv(i,j)<a name='9625'>
      B_mu_save(i,j)=P_mu_save(i,j)<a name='9626'>
<a name='9627'>
      K_muus(i,j)=muus(i,j)<a name='9628'>
      K_muvs(i,j)=muvs(i,j)<a name='9629'>
      K_mu_2(i,j)=mu_2(i,j)<a name='9630'>
      K_mut(i,j)=mut(i,j)<a name='9631'>
      K_muts(i,j)=muts(i,j)<a name='9632'>
      K_muu(i,j)=muu(i,j)<a name='9633'>
      K_muv(i,j)=muv(i,j)<a name='9634'>
      K_mu_save(i,j)=mu_save(i,j)<a name='9635'>
   enddo<a name='9636'>
   enddo<a name='9637'>
<a name='9638'>
<font color=#447700>!  TGL<a name='9639'></font>
<a name='9640'>
   CALL <A href='../../html_code/dyn_em/module_small_step_em_tl.F.html#G_SMALL_STEP_FINISH'>g_small_step_finish</A><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_FINISH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SMALL_STEP_FINISH_2">( u_2, P_u_2, v_2, P_v_2, w_2, P_w_2, t_2, P_t_2, ph_2, P_ph_2, ww, mu_2, P_mu_2,mut, P_mut, muts, &amp;<a name='9641'>
&amp;P_muts, muu, P_muu, muus, P_muus, muv, P_muv, muvs, P_muvs, u_save, P_u_save, v_save, P_v_save, w_save, P_w_save, t_save, &amp;<a name='9642'>
&amp;P_t_save, ph_save, P_ph_save, mu_save, P_mu_save, msfu, msfv, msft, ide, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, &amp;<a name='9643'>
&amp;jts, jte )<a name='9644'>
<a name='9645'>
   VAL_L=0.<a name='9646'>
   do i=its,ite<a name='9647'>
   do k=kts,kte<a name='9648'>
   do j=jts,jte<a name='9649'>
      VAL_L=VAL_L   + P_u_2(i,k,j)*P_u_2(i,k,j)         &amp;<a name='9650'>
                    + P_v_2(i,k,j)*P_v_2(i,k,j)         &amp;<a name='9651'>
                    + P_w_2(i,k,j)*P_w_2(i,k,j)         &amp;<a name='9652'>
                    + P_t_2(i,k,j)*P_t_2(i,k,j)         &amp;<a name='9653'>
                    + P_ph_2(i,k,j)*P_ph_2(i,k,j)<a name='9654'>
   enddo<a name='9655'>
   enddo<a name='9656'>
   enddo<a name='9657'>
   do i=its,ite<a name='9658'>
   do j=jts,jte<a name='9659'>
      VAL_L=VAL_L +P_muus(i,j)*P_muus(i,j)            &amp;<a name='9660'>
                    + P_muvs(i,j)*P_muvs(i,j)            &amp;<a name='9661'>
                    + P_mu_2(i,j)*P_mu_2(i,j)            &amp;<a name='9662'>
                    + P_mut(i,j)*P_mut(i,j)            &amp;<a name='9663'>
                    + P_muts(i,j)*P_muts(i,j)            &amp;<a name='9664'>
                    + P_muu(i,j)*P_muu(i,j)            &amp;<a name='9665'>
                    + P_muv(i,j)*P_muv(i,j)            &amp;<a name='9666'>
                    + P_mu_save(i,j)*P_mu_save(i,j)<a name='9667'>
   enddo<a name='9668'>
   enddo<a name='9669'>
<a name='9670'>
#ifdef DM_PARALLEL<a name='9671'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='9672'>
                       comm, IERROR )<a name='9673'>
   VAL_L = nsum <a name='9674'>
#endif<a name='9675'>
<a name='9676'>
   do i=ims,ime<a name='9677'>
   do k=kms,kme<a name='9678'>
   do j=jms,jme<a name='9679'>
      P_u_save(i,k,j)=0.0<a name='9680'>
      P_v_save(i,k,j)=0.0<a name='9681'>
      P_w_save(i,k,j)=0.0<a name='9682'>
      P_t_save(i,k,j)=0.0<a name='9683'>
      P_ph_save(i,k,j)=0.0<a name='9684'>
   enddo<a name='9685'>
   enddo<a name='9686'>
   enddo<a name='9687'>
<a name='9688'>
<font color=#447700>!  ADJ<a name='9689'></font>
<a name='9690'>
  CALL <A href='../../html_code/dyn_em/module_small_step_em_ad.F.html#A_SMALL_STEP_FINISH'>a_small_step_finish</A><A href='../../html_code/dyn_em/module_check.F.html#T_SMALL_STEP_FINISH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_SMALL_STEP_FINISH_1">(K_u_2,P_u_2, K_v_2, P_v_2, K_w_2, P_w_2, K_t_2, P_t_2, P_ph_2, P_mu_2, K_mut, P_mut, K_muts, P_muts, K_muu, &amp;<a name='9691'>
&amp;P_muu,K_muus,P_muus, K_muv, P_muv, K_muvs, P_muvs, u_save, P_u_save, v_save, P_v_save, w_save, P_w_save, t_save, P_t_save, P_ph_save, &amp;<a name='9692'>
&amp;P_mu_save, msfu, msfv, msft, ide, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte )<a name='9693'>
<a name='9694'>
   VAL_A=0.<a name='9695'>
   do i=its,ite<a name='9696'>
   do k=kts,kte<a name='9697'>
   do j=jts,jte<a name='9698'>
     VAL_A=VAL_A +B_u_save(i,k,j)*P_u_save(i,k,j)       &amp;<a name='9699'>
                 +B_v_save(i,k,j)*P_v_save(i,k,j)       &amp;<a name='9700'>
                 +B_w_save(i,k,j)*P_w_save(i,k,j)       &amp;<a name='9701'>
                 +B_t_save(i,k,j)*P_t_save(i,k,j)       &amp;<a name='9702'>
                 +B_ph_save(i,k,j)*P_ph_save(i,k,j)<a name='9703'>
   enddo<a name='9704'>
   enddo<a name='9705'>
   enddo<a name='9706'>
   do i=its,ite<a name='9707'>
   do k=kts,kte<a name='9708'>
   do j=jts,jte<a name='9709'>
     VAL_A=VAL_A    + P_u_2(i,k,j)*B_u_2(i,k,j)         &amp;<a name='9710'>
                    + P_v_2(i,k,j)*B_v_2(i,k,j)         &amp;<a name='9711'>
                    + P_w_2(i,k,j)*B_w_2(i,k,j)         &amp;<a name='9712'>
                    + P_t_2(i,k,j)*B_t_2(i,k,j)         &amp;<a name='9713'>
                    + P_ph_2(i,k,j)*B_ph_2(i,k,j)<a name='9714'>
   enddo<a name='9715'>
   enddo<a name='9716'>
   enddo<a name='9717'>
   do i=its,ite<a name='9718'>
   do j=jts,jte<a name='9719'>
     VAL_A=VAL_A    + P_muus(i,j)*B_muus(i,j)            &amp;<a name='9720'>
                    + P_muvs(i,j)*B_muvs(i,j)            &amp;<a name='9721'>
                    + P_mu_2(i,j)*B_mu_2(i,j)            &amp;<a name='9722'>
                    + P_mut(i,j)*B_mut(i,j)            &amp;<a name='9723'>
                    + P_muts(i,j)*B_muts(i,j)            &amp;<a name='9724'>
                    + P_muu(i,j)*B_muu(i,j)            &amp;<a name='9725'>
                    + P_muv(i,j)*B_muv(i,j)            &amp;<a name='9726'>
                    + P_mu_save(i,j)*B_mu_save(i,j)<a name='9727'>
   enddo<a name='9728'>
   enddo<a name='9729'>
<a name='9730'>
#ifdef DM_PARALLEL<a name='9731'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='9732'>
                       comm, IERROR )<a name='9733'>
   VAL_A = nsum <a name='9734'>
#endif<a name='9735'>
<a name='9736'>
   print*, '                '<a name='9737'>
   write(6,*) 'a_small_step_finish: '<a name='9738'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='9739'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='9740'>
<a name='9741'>
<font color=#447700>!  RECOVER<a name='9742'></font>
<a name='9743'>
   do i=ims,ime<a name='9744'>
   do k=kms,kme<a name='9745'>
   do j=jms,jme<a name='9746'>
      u_save(i,k,j)=S_u_save(i,k,j)<a name='9747'>
      v_save(i,k,j)=S_v_save(i,k,j)<a name='9748'>
      w_save(i,k,j)=S_w_save(i,k,j)<a name='9749'>
      t_save(i,k,j)=S_t_save(i,k,j)<a name='9750'>
      ph_save(i,k,j)=S_ph_save(i,k,j)<a name='9751'>
   enddo<a name='9752'>
   enddo<a name='9753'>
   enddo<a name='9754'>
   do i=ims,ime<a name='9755'>
   do k=kms,kme<a name='9756'>
   do j=jms,jme<a name='9757'>
      u_2(i,k,j)=S_u_2(i,k,j)<a name='9758'>
      v_2(i,k,j)=S_v_2(i,k,j)<a name='9759'>
      w_2(i,k,j)=S_w_2(i,k,j)<a name='9760'>
      t_2(i,k,j)=S_t_2(i,k,j)<a name='9761'>
      ph_2(i,k,j)=S_ph_2(i,k,j)<a name='9762'>
   enddo<a name='9763'>
   enddo<a name='9764'>
   enddo<a name='9765'>
   do i=ims,ime<a name='9766'>
   do j=jms,jme<a name='9767'>
      muus(i,j)=S_muus(i,j)<a name='9768'>
      muvs(i,j)=S_muvs(i,j)<a name='9769'>
      mu_2(i,j)=S_mu_2(i,j)<a name='9770'>
      mut(i,j)=S_mut(i,j)<a name='9771'>
      muts(i,j)=S_muts(i,j)<a name='9772'>
      muu(i,j)=S_muu(i,j)<a name='9773'>
      muv(i,j)=S_muv(i,j)<a name='9774'>
      mu_save(i,j)=S_mu_save(i,j)<a name='9775'>
   enddo<a name='9776'>
   enddo<a name='9777'>
<a name='9778'>
END SUBROUTINE t_small_step_finish<a name='9779'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='9780'></font>
<A NAME='T_RK_SCALAR_TEND'><A href='../../html_code/dyn_em/module_check.F.html#T_RK_SCALAR_TEND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9781'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_rk_scalar_tend</font> ( scs, sce, config_flags,    &amp; <A href='../../call_to/T_RK_SCALAR_TEND.html' TARGET='index'>1</A>,<A href='../../call_from/T_RK_SCALAR_TEND.html' TARGET='index'>5</A><a name='9782'>
                            rk_step, dt,                  &amp;<a name='9783'>
                            ru, rv, ww, mut, alt,         &amp;<a name='9784'>
                            scalar_old, scalar,           &amp;<a name='9785'>
                            scalar_tends, advect_tend,    &amp;<a name='9786'>
                            RQVFTEN,                      &amp;<a name='9787'>
                            base, moist_step, fnm, fnp,   &amp;<a name='9788'>
                            msfu, msfv, msft,             &amp;<a name='9789'>
                            rdx, rdy, rdn, rdnw,          &amp;<a name='9790'>
                            khdif, kvdif, xkmhd,          &amp;<a name='9791'>
                            leapfrog,                     &amp;<a name='9792'>
                            ids, ide, jds, jde, kds, kde, &amp;<a name='9793'>
                            ims, ime, jms, jme, kms, kme, &amp;<a name='9794'>
                            its, ite, jts, jte, kts, kte )<a name='9795'>
<a name='9796'>
   IMPLICIT NONE<a name='9797'>
<a name='9798'>
   <font color=#447700>!  Input data.<a name='9799'></font>
<a name='9800'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='9801'>
<a name='9802'>
   INTEGER ,                INTENT(IN   ) :: rk_step, scs, sce<a name='9803'>
   INTEGER ,                INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='9804'>
                                             ims, ime, jms, jme, kms, kme, &amp;<a name='9805'>
                                             its, ite, jts, jte, kts, kte<a name='9806'>
<a name='9807'>
   LOGICAL , INTENT(IN   ) :: moist_step<a name='9808'>
<a name='9809'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce ),                &amp;<a name='9810'>
                                         INTENT(INOUT)  :: scalar,     &amp;<a name='9811'>
                                                           scalar_old<a name='9812'>
<a name='9813'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce ),                      &amp;<a name='9814'>
                                         INTENT(  OUT)  :: scalar_tends<a name='9815'>
<a name='9816'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme  ) :: advect_tend<a name='9817'>
<a name='9818'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme  ), INTENT(OUT  ) :: RQVFTEN<a name='9819'>
<a name='9820'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme  )                ::     ru,  &amp;<a name='9821'>
                                                                      rv,  &amp;<a name='9822'>
                                                                      ww,  &amp;<a name='9823'>
                                                                      xkmhd,  &amp;<a name='9824'>
                                                                      alt<a name='9825'>
<a name='9826'>
<a name='9827'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fnm,  &amp;<a name='9828'>
                                                                  fnp,  &amp;<a name='9829'>
                                                                  rdn,  &amp;<a name='9830'>
                                                                  rdnw, &amp;<a name='9831'>
                                                                  base<a name='9832'>
<a name='9833'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,       INTENT(IN   ) :: msfu,    &amp;<a name='9834'>
                                                                  msfv,    &amp;<a name='9835'>
                                                                  msft<a name='9836'>
   REAL , DIMENSION( ims:ime , jms:jme )          :: mut<a name='9837'>
<a name='9838'>
<a name='9839'>
   REAL ,                                        INTENT(IN   ) :: rdx,     &amp;<a name='9840'>
                                                                  rdy,     &amp;<a name='9841'>
                                                                  khdif,   &amp;<a name='9842'>
                                                                  kvdif<a name='9843'>
<a name='9844'>
   REAL ,                                        INTENT(IN   ) :: dt<a name='9845'>
<a name='9846'>
   LOGICAL, INTENT(IN   ) :: leapfrog<a name='9847'>
<a name='9848'>
<a name='9849'>
   <font color=#447700>! Local data<a name='9850'></font>
<a name='9851'>
   INTEGER :: im, i,j,k<a name='9852'>
<a name='9853'>
   REAL    :: khdq, kvdq, tendency<a name='9854'>
<a name='9855'>
<font color=#447700>!  IN variables<a name='9856'></font>
<a name='9857'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme  )                ::     S_ru,  &amp;<a name='9858'>
                                                                      S_rv,  &amp;<a name='9859'>
                                                                      S_ww,  &amp;<a name='9860'>
                                                                      S_advect_tend,  &amp;<a name='9861'>
                                                                      S_xkmhd,  &amp;<a name='9862'>
                                                                      S_alt<a name='9863'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme  )                ::     P_ru,  &amp;<a name='9864'>
                                                                      P_rv,  &amp;<a name='9865'>
                                                                      P_ww,  &amp;<a name='9866'>
                                                                      P_advect_tend,  &amp;<a name='9867'>
                                                                      P_xkmhd,  &amp;<a name='9868'>
                                                                      P_alt<a name='9869'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme  )                ::     B_ru,  &amp;<a name='9870'>
                                                                      B_rv,  &amp;<a name='9871'>
                                                                      B_ww,  &amp;<a name='9872'>
                                                                      B_advect_tend,  &amp;<a name='9873'>
                                                                      B_xkmhd,  &amp;<a name='9874'>
                                                                      B_alt<a name='9875'>
   REAL , DIMENSION( ims:ime , jms:jme )     :: S_mut,P_mut,B_mut<a name='9876'>
<a name='9877'>
<font color=#447700>!  INOUT variables<a name='9878'></font>
<a name='9879'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce )  :: S_scalar, S_scalar_old,P_scalar, P_scalar_old<a name='9880'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce )  :: K_scalar, K_scalar_old,B_scalar, B_scalar_old<a name='9881'>
<a name='9882'>
<font color=#447700>!  OUT variables<a name='9883'></font>
<a name='9884'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce )  :: P_scalar_tends,B_scalar_tends,S_scalar_tends<a name='9885'>
<a name='9886'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='9887'>
   INTEGER :: NT,h<a name='9888'>
<a name='9889'>
<font color=#447700>!TGL test<a name='9890'></font>
<a name='9891'>
   do i=ims,ime<a name='9892'>
   do k=kms,kme<a name='9893'>
   do j=jms,jme<a name='9894'>
      S_ru(i,k,j)=ru(i,k,j)<a name='9895'>
      S_rv(i,k,j)=rv(i,k,j)<a name='9896'>
      S_ww(i,k,j)=ww(i,k,j)<a name='9897'>
      S_advect_tend(i,k,j)=advect_tend(i,k,j)<a name='9898'>
      S_xkmhd(i,k,j)=xkmhd(i,k,j)<a name='9899'>
      S_alt(i,k,j)=alt(i,k,j)<a name='9900'>
<a name='9901'>
      P_ru(i,k,j)=ru(i,k,j)<a name='9902'>
      P_rv(i,k,j)=rv(i,k,j)<a name='9903'>
      P_ww(i,k,j)=ww(i,k,j)<a name='9904'>
      P_advect_tend(i,k,j)=advect_tend(i,k,j)<a name='9905'>
      P_xkmhd(i,k,j)=xkmhd(i,k,j)<a name='9906'>
      P_alt(i,k,j)=alt(i,k,j)<a name='9907'>
   enddo<a name='9908'>
   enddo<a name='9909'>
   enddo<a name='9910'>
   do i=ims,ime<a name='9911'>
   do k=kms,kme<a name='9912'>
   do j=jms,jme<a name='9913'>
   do h=scs,sce<a name='9914'>
      S_scalar(i,k,j,h)=scalar(i,k,j,h)<a name='9915'>
      S_scalar_old(i,k,j,h)=scalar_old(i,k,j,h)<a name='9916'>
<a name='9917'>
      P_scalar(i,k,j,h)=scalar(i,k,j,h)<a name='9918'>
      P_scalar_old(i,k,j,h)=scalar_old(i,k,j,h)<a name='9919'>
<a name='9920'>
      K_scalar(i,k,j,h)=scalar(i,k,j,h)<a name='9921'>
      K_scalar_old(i,k,j,h)=scalar_old(i,k,j,h)<a name='9922'>
   enddo<a name='9923'>
   enddo<a name='9924'>
   enddo<a name='9925'>
   enddo<a name='9926'>
   do i=ims,ime<a name='9927'>
   do k=kms,kme<a name='9928'>
   do j=jms,jme<a name='9929'>
   do h=scs,sce<a name='9930'>
      S_scalar_tends(i,k,j,h)=scalar_tends(i,k,j,h)<a name='9931'>
<a name='9932'>
      P_scalar_tends(i,k,j,h)=scalar_tends(i,k,j,h)<a name='9933'>
   enddo<a name='9934'>
   enddo<a name='9935'>
   enddo<a name='9936'>
   enddo<a name='9937'>
<a name='9938'>
<a name='9939'>
<font color=#447700>!NLM<a name='9940'></font>
<a name='9941'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_1"> ( scs, sce, config_flags,    &amp;<a name='9942'>
                            rk_step, dt,                  &amp;<a name='9943'>
                            ru, rv, ww, mut, alt,         &amp;<a name='9944'>
                            scalar_old, scalar,           &amp;<a name='9945'>
                            scalar_tends, advect_tend,    &amp;<a name='9946'>
                            RQVFTEN,                      &amp;<a name='9947'>
                            base, moist_step, fnm, fnp,   &amp;<a name='9948'>
                            msfu, msfv, msft,             &amp;<a name='9949'>
                            rdx, rdy, rdn, rdnw,          &amp;<a name='9950'>
                            khdif, kvdif, xkmhd,          &amp;<a name='9951'>
                            leapfrog,                     &amp;<a name='9952'>
                            ids, ide, jds, jde, kds, kde, &amp;<a name='9953'>
                            ims, ime, jms, jme, kms, kme, &amp;<a name='9954'>
                            its, ite, jts, jte, kts, kte )<a name='9955'>
<a name='9956'>
   do i=its,ite<a name='9957'>
   do k=kts,kte<a name='9958'>
   do j=jts,jte<a name='9959'>
   do h=scs,sce<a name='9960'>
      B_scalar_tends(i,k,j,h)=scalar_tends(i,k,j,h)<a name='9961'>
   enddo<a name='9962'>
   enddo<a name='9963'>
   enddo<a name='9964'>
   enddo<a name='9965'>
<a name='9966'>
   do i=its,ite<a name='9967'>
   do k=kts,kte<a name='9968'>
   do j=jts,jte<a name='9969'>
   do h=scs,sce<a name='9970'>
      B_scalar(i,k,j,h)=scalar(i,k,j,h)<a name='9971'>
      B_scalar_old(i,k,j,h)=scalar_old(i,k,j,h)<a name='9972'>
   enddo<a name='9973'>
   enddo<a name='9974'>
   enddo<a name='9975'>
   enddo<a name='9976'>
<a name='9977'>
   do i=its,ite<a name='9978'>
   do k=kts,kte<a name='9979'>
   do j=jts,jte<a name='9980'>
      B_ru(i,k,j)=ru(i,k,j)<a name='9981'>
      B_rv(i,k,j)=rv(i,k,j)<a name='9982'>
      B_ww(i,k,j)=ww(i,k,j)<a name='9983'>
      B_advect_tend(i,k,j)=advect_tend(i,k,j)<a name='9984'>
      B_xkmhd(i,k,j)=xkmhd(i,k,j)<a name='9985'>
      B_alt(i,k,j)=alt(i,k,j)<a name='9986'>
   enddo<a name='9987'>
   enddo<a name='9988'>
   enddo<a name='9989'>
<a name='9990'>
<font color=#447700>!  TCL<a name='9991'></font>
<a name='9992'>
   do i=ims,ime<a name='9993'>
   do k=kms,kme<a name='9994'>
   do j=jms,jme<a name='9995'>
      ru(i,k,j)=S_ru(i,k,j)<a name='9996'>
      rv(i,k,j)=S_rv(i,k,j)<a name='9997'>
      ww(i,k,j)=S_ww(i,k,j)<a name='9998'>
      advect_tend(i,k,j)=S_advect_tend(i,k,j)<a name='9999'>
      xkmhd(i,k,j)=S_xkmhd(i,k,j)<a name='10000'>
      alt(i,k,j)=S_alt(i,k,j)<a name='10001'>
   enddo<a name='10002'>
   enddo<a name='10003'>
   enddo<a name='10004'>
   do i=ims,ime<a name='10005'>
   do k=kms,kme<a name='10006'>
   do j=jms,jme<a name='10007'>
   do h=scs,sce<a name='10008'>
      scalar(i,k,j,h)=S_scalar(i,k,j,h)<a name='10009'>
      scalar_old(i,k,j,h)=S_scalar_old(i,k,j,h)<a name='10010'>
   enddo<a name='10011'>
   enddo<a name='10012'>
   enddo<a name='10013'>
   enddo<a name='10014'>
<a name='10015'>
   do i=ims,ime<a name='10016'>
   do k=kms,kme<a name='10017'>
   do j=jms,jme<a name='10018'>
   do h=scs,sce<a name='10019'>
      scalar_tends(i,k,j,h)=S_scalar_tends(i,k,j,h)<a name='10020'>
   enddo<a name='10021'>
   enddo<a name='10022'>
   enddo<a name='10023'>
   enddo<a name='10024'>
<a name='10025'>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_RK_SCALAR_TEND'>g_rk_scalar_tend</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RK_SCALAR_TEND_1">( scs, sce, config_flags, rk_step, ru, P_ru, rv, P_rv, ww, P_ww, mut, P_mut, alt, P_alt, scalar_old, &amp;<a name='10026'>
&amp;P_scalar_old, scalar, P_scalar, scalar_tends, P_scalar_tends, advect_tend, P_advect_tend, base, moist_step, fnm, fnp, msfu, msfv, &amp;<a name='10027'>
&amp;msft, rdx, rdy, rdn, rdnw, kvdif, xkmhd, P_xkmhd, leapfrog, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, &amp;<a name='10028'>
&amp;jte, kts, kte )<a name='10029'>
<a name='10030'>
   SAVE_L=0.<a name='10031'>
   do i=its,ite<a name='10032'>
   do k=kts,kte<a name='10033'>
   do j=jts,jte<a name='10034'>
   do h=scs,sce<a name='10035'>
      SAVE_L=SAVE_L + P_scalar_tends(i,k,j,h)*P_scalar_tends(i,k,j,h)<a name='10036'>
   enddo<a name='10037'>
   enddo<a name='10038'>
   enddo<a name='10039'>
   enddo<a name='10040'>
<a name='10041'>
   do i=its,ite<a name='10042'>
   do k=kts,kte<a name='10043'>
   do j=jts,jte<a name='10044'>
   do h=scs,sce<a name='10045'>
      SAVE_L=SAVE_L + P_scalar(i,k,j,h)*P_scalar(i,k,j,h)            &amp;<a name='10046'>
                    + P_scalar_old(i,k,j,h)*P_scalar_old(i,k,j,h)<a name='10047'>
   enddo<a name='10048'>
   enddo<a name='10049'>
   enddo<a name='10050'>
   enddo<a name='10051'>
<a name='10052'>
   do i=its,ite<a name='10053'>
   do k=kts,kte<a name='10054'>
   do j=jts,jte<a name='10055'>
      SAVE_L=SAVE_L+P_ru(i,k,j)*P_ru(i,k,j)         &amp;<a name='10056'>
               +P_rv(i,k,j)*P_rv(i,k,j)            &amp;<a name='10057'>
               +P_ww(i,k,j)*P_ww(i,k,j)            &amp;<a name='10058'>
               +P_advect_tend(i,k,j)*P_advect_tend(i,k,j)            &amp;<a name='10059'>
               +P_alt(i,k,j)*P_alt(i,k,j)          &amp;<a name='10060'>
               +P_xkmhd(i,k,j)*P_xkmhd(i,k,j)<a name='10061'>
   enddo<a name='10062'>
   enddo<a name='10063'>
   enddo<a name='10064'>
<a name='10065'>
#ifdef DM_PARALLEL<a name='10066'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10067'>
                       comm, IERROR )<a name='10068'>
   SAVE_L = nsum <a name='10069'>
#endif<a name='10070'>
<a name='10071'>
   ALPHA=1.<a name='10072'>
   DO NT=1,11<a name='10073'>
      ALPHA=0.1*ALPHA<a name='10074'>
      FACTOR=1.+ALPHA<a name='10075'>
   do i=ims,ime<a name='10076'>
   do k=kms,kme<a name='10077'>
   do j=jms,jme<a name='10078'>
      P_ru(i,k,j)=FACTOR*S_ru(i,k,j)<a name='10079'>
      P_rv(i,k,j)=FACTOR*S_rv(i,k,j)<a name='10080'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='10081'>
      P_advect_tend(i,k,j)=FACTOR*S_advect_tend(i,k,j)<a name='10082'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='10083'>
      P_xkmhd(i,k,j)=FACTOR*S_xkmhd(i,k,j)<a name='10084'>
   enddo<a name='10085'>
   enddo<a name='10086'>
   enddo<a name='10087'>
   do i=ims,ime<a name='10088'>
   do k=kms,kme<a name='10089'>
   do j=jms,jme<a name='10090'>
   do h=scs,sce<a name='10091'>
      P_scalar(i,k,j,h)=FACTOR*S_scalar(i,k,j,h)<a name='10092'>
      P_scalar_old(i,k,j,h)=FACTOR*S_scalar_old(i,k,j,h)<a name='10093'>
   enddo<a name='10094'>
   enddo<a name='10095'>
   enddo<a name='10096'>
   enddo<a name='10097'>
<a name='10098'>
   do i=ims,ime<a name='10099'>
   do k=kms,kme<a name='10100'>
   do j=jms,jme<a name='10101'>
   do h=scs,sce<a name='10102'>
      P_scalar_tends(i,k,j,h)=FACTOR*S_scalar_tends(i,k,j,h)<a name='10103'>
   enddo<a name='10104'>
   enddo<a name='10105'>
   enddo<a name='10106'>
   enddo<a name='10107'>
<a name='10108'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_2"> ( scs, sce, config_flags,    &amp;<a name='10109'>
                            rk_step, dt,                  &amp;<a name='10110'>
                            P_ru, P_rv, P_ww, P_mut, P_alt,         &amp;<a name='10111'>
                            P_scalar_old, P_scalar,           &amp;<a name='10112'>
                            P_scalar_tends, P_advect_tend,    &amp;<a name='10113'>
                            RQVFTEN,                      &amp;<a name='10114'>
                            base, moist_step, fnm, fnp,   &amp;<a name='10115'>
                            msfu, msfv, msft,             &amp;<a name='10116'>
                            rdx, rdy, rdn, rdnw,          &amp;<a name='10117'>
                            khdif, kvdif, P_xkmhd,          &amp;<a name='10118'>
                            leapfrog,                     &amp;<a name='10119'>
                            ids, ide, jds, jde, kds, kde, &amp;<a name='10120'>
                            ims, ime, jms, jme, kms, kme, &amp;<a name='10121'>
                            its, ite, jts, jte, kts, kte )<a name='10122'>
<a name='10123'>
   VAL_N=0.<a name='10124'>
   do i=its,ite<a name='10125'>
   do k=kts,kte<a name='10126'>
   do j=jts,jte<a name='10127'>
   do h=scs,sce<a name='10128'>
      VAL_N=VAL_N+(P_scalar_tends(i,k,j,h) -B_scalar_tends(i,k,j,h))*(P_scalar_tends(i,k,j,h) -B_scalar_tends(i,k,j,h))<a name='10129'>
   enddo<a name='10130'>
   enddo<a name='10131'>
   enddo<a name='10132'>
   enddo<a name='10133'>
<a name='10134'>
   do i=its,ite<a name='10135'>
   do k=kts,kte<a name='10136'>
   do j=jts,jte<a name='10137'>
   do h=scs,sce<a name='10138'>
      VAL_N=VAL_N+(P_scalar(i,k,j,h) -B_scalar(i,k,j,h))*(P_scalar(i,k,j,h) -B_scalar(i,k,j,h))               &amp;<a name='10139'>
                 +(P_scalar_old(i,k,j,h) -B_scalar_old(i,k,j,h))*(P_scalar_old(i,k,j,h) -B_scalar_old(i,k,j,h))<a name='10140'>
   enddo<a name='10141'>
   enddo<a name='10142'>
   enddo<a name='10143'>
   enddo<a name='10144'>
<a name='10145'>
   do i=its,ite<a name='10146'>
   do k=kts,kte<a name='10147'>
   do j=jts,jte<a name='10148'>
      VAL_N=VAL_N +(P_ru(i,k,j)-B_ru(i,k,j))*(P_ru(i,k,j)-B_ru(i,k,j))         &amp;<a name='10149'>
                  +(P_rv(i,k,j)-B_rv(i,k,j))*(P_rv(i,k,j)-B_rv(i,k,j))            &amp;<a name='10150'>
                  +(P_ww(i,k,j)-B_ww(i,k,j))*(P_ww(i,k,j)-B_ww(i,k,j))            &amp;<a name='10151'>
                  +(P_advect_tend(i,k,j)-B_advect_tend(i,k,j))*(P_advect_tend(i,k,j)-B_advect_tend(i,k,j))            &amp;<a name='10152'>
                  +(P_alt(i,k,j)-B_alt(i,k,j))*(P_alt(i,k,j)-B_alt(i,k,j))          &amp;<a name='10153'>
                  +(P_xkmhd(i,k,j)-B_xkmhd(i,k,j))*(P_xkmhd(i,k,j)-B_xkmhd(i,k,j))<a name='10154'>
   enddo<a name='10155'>
   enddo<a name='10156'>
   enddo<a name='10157'>
<a name='10158'>
#ifdef DM_PARALLEL<a name='10159'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10160'>
                       comm, IERROR )<a name='10161'>
   VAL_N = nsum <a name='10162'>
#endif<a name='10163'>
<a name='10164'>
      VAL_L=SAVE_L*ALPHA**2<a name='10165'>
<a name='10166'>
      if(VAL_L == 0.) then<a name='10167'>
         COEF = 1.<a name='10168'>
      else<a name='10169'>
         COEF=VAL_N/VAL_L<a name='10170'>
      endif<a name='10171'>
<a name='10172'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='10173'>
         'g_rk_scalar_tend: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='10174'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='10175'>
   ENDDO<a name='10176'>
<a name='10177'>
<font color=#447700>!  ADJ test<a name='10178'></font>
<a name='10179'>
   FACTOR=0.1<a name='10180'>
   do i=ims,ime<a name='10181'>
   do k=kms,kme<a name='10182'>
   do j=jms,jme<a name='10183'>
      ru(i,k,j)=S_ru(i,k,j)<a name='10184'>
      rv(i,k,j)=S_rv(i,k,j)<a name='10185'>
      ww(i,k,j)=S_ww(i,k,j)<a name='10186'>
      advect_tend(i,k,j)=S_advect_tend(i,k,j)<a name='10187'>
      xkmhd(i,k,j)=S_xkmhd(i,k,j)<a name='10188'>
      alt(i,k,j)=S_alt(i,k,j)<a name='10189'>
<a name='10190'>
      P_ru(i,k,j)=FACTOR*S_ru(i,k,j)<a name='10191'>
      P_rv(i,k,j)=FACTOR*S_rv(i,k,j)<a name='10192'>
      P_ww(i,k,j)=FACTOR*S_ww(i,k,j)<a name='10193'>
      P_advect_tend(i,k,j)=FACTOR*S_advect_tend(i,k,j)<a name='10194'>
      P_alt(i,k,j)=FACTOR*S_alt(i,k,j)<a name='10195'>
      P_xkmhd(i,k,j)=FACTOR*S_xkmhd(i,k,j)<a name='10196'>
<a name='10197'>
      B_ru(i,k,j)=P_ru(i,k,j)<a name='10198'>
      B_rv(i,k,j)=P_rv(i,k,j)<a name='10199'>
      B_advect_tend(i,k,j)=P_advect_tend(i,k,j)<a name='10200'>
      B_ww(i,k,j)=P_ww(i,k,j)<a name='10201'>
      B_alt(i,k,j)=P_alt(i,k,j)<a name='10202'>
      B_xkmhd(i,k,j)=P_xkmhd(i,k,j)<a name='10203'>
   enddo<a name='10204'>
   enddo<a name='10205'>
   enddo<a name='10206'>
   do i=ims,ime<a name='10207'>
   do k=kms,kme<a name='10208'>
   do j=jms,jme<a name='10209'>
   do h=scs,sce<a name='10210'>
      scalar(i,k,j,h)=S_scalar(i,k,j,h)<a name='10211'>
      scalar_old(i,k,j,h)=S_scalar_old(i,k,j,h)<a name='10212'>
<a name='10213'>
      P_scalar(i,k,j,h)=FACTOR*S_scalar(i,k,j,h)<a name='10214'>
      P_scalar_old(i,k,j,h)=FACTOR*S_scalar_old(i,k,j,h)<a name='10215'>
<a name='10216'>
      B_scalar(i,k,j,h)=P_scalar(i,k,j,h)<a name='10217'>
      B_scalar_old(i,k,j,h)=P_scalar_old(i,k,j,h)<a name='10218'>
<a name='10219'>
      K_scalar(i,k,j,h)=scalar(i,k,j,h)<a name='10220'>
      K_scalar_old(i,k,j,h)=scalar_old(i,k,j,h)<a name='10221'>
   enddo<a name='10222'>
   enddo<a name='10223'>
   enddo<a name='10224'>
   enddo<a name='10225'>
<a name='10226'>
   do i=ims,ime<a name='10227'>
   do k=kms,kme<a name='10228'>
   do j=jms,jme<a name='10229'>
   do h=scs,sce<a name='10230'>
      scalar_tends(i,k,j,h)=S_scalar_tends(i,k,j,h)<a name='10231'>
<a name='10232'>
      P_scalar_tends(i,k,j,h)=FACTOR*S_scalar_tends(i,k,j,h)<a name='10233'>
<a name='10234'>
      B_scalar_tends(i,k,j,h)=P_scalar_tends(i,k,j,h)<a name='10235'>
   enddo<a name='10236'>
   enddo<a name='10237'>
   enddo<a name='10238'>
   enddo<a name='10239'>
<a name='10240'>
<font color=#447700>!  TGL<a name='10241'></font>
<a name='10242'>
   do i=ims,ime<a name='10243'>
   do k=kms,kme<a name='10244'>
   do j=jms,jme<a name='10245'>
      ru(i,k,j)=S_ru(i,k,j)<a name='10246'>
      rv(i,k,j)=S_rv(i,k,j)<a name='10247'>
      ww(i,k,j)=S_ww(i,k,j)<a name='10248'>
      advect_tend(i,k,j)=S_advect_tend(i,k,j)<a name='10249'>
      xkmhd(i,k,j)=S_xkmhd(i,k,j)<a name='10250'>
      alt(i,k,j)=S_alt(i,k,j)<a name='10251'>
   enddo<a name='10252'>
   enddo<a name='10253'>
   enddo<a name='10254'>
   do i=ims,ime<a name='10255'>
   do k=kms,kme<a name='10256'>
   do j=jms,jme<a name='10257'>
   do h=scs,sce<a name='10258'>
      scalar(i,k,j,h)=S_scalar(i,k,j,h)<a name='10259'>
      scalar_old(i,k,j,h)=S_scalar_old(i,k,j,h)<a name='10260'>
   enddo<a name='10261'>
   enddo<a name='10262'>
   enddo<a name='10263'>
   enddo<a name='10264'>
   do i=ims,ime<a name='10265'>
   do k=kms,kme<a name='10266'>
   do j=jms,jme<a name='10267'>
   do h=scs,sce<a name='10268'>
      scalar_tends(i,k,j,h)=S_scalar_tends(i,k,j,h)<a name='10269'>
   enddo<a name='10270'>
   enddo<a name='10271'>
   enddo<a name='10272'>
   enddo<a name='10273'>
<a name='10274'>
<a name='10275'>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_RK_SCALAR_TEND'>g_rk_scalar_tend</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RK_SCALAR_TEND_2">( scs, sce, config_flags, rk_step, ru, P_ru, rv, P_rv, ww, P_ww, mut, P_mut, alt, P_alt, scalar_old, &amp;<a name='10276'>
&amp;P_scalar_old, scalar, P_scalar, scalar_tends, P_scalar_tends, advect_tend, P_advect_tend, base, moist_step, fnm, fnp, msfu, msfv, &amp;<a name='10277'>
&amp;msft, rdx, rdy, rdn, rdnw, kvdif, xkmhd, P_xkmhd, leapfrog, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, &amp;<a name='10278'>
&amp;jte, kts, kte )<a name='10279'>
<a name='10280'>
   VAL_L=0.<a name='10281'>
   do i=its,ite<a name='10282'>
   do k=kts,kte<a name='10283'>
   do j=jts,jte<a name='10284'>
   do h=scs,sce<a name='10285'>
      VAL_L=VAL_L + P_scalar_tends(i,k,j,h)*P_scalar_tends(i,k,j,h)<a name='10286'>
   enddo<a name='10287'>
   enddo<a name='10288'>
   enddo<a name='10289'>
   enddo<a name='10290'>
<a name='10291'>
   do i=its,ite<a name='10292'>
   do k=kts,kte<a name='10293'>
   do j=jts,jte<a name='10294'>
   do h=scs,sce<a name='10295'>
      VAL_L=VAL_L + P_scalar(i,k,j,h)*P_scalar(i,k,j,h)            &amp;<a name='10296'>
                    + P_scalar_old(i,k,j,h)*P_scalar_old(i,k,j,h)<a name='10297'>
   enddo<a name='10298'>
   enddo<a name='10299'>
   enddo<a name='10300'>
   enddo<a name='10301'>
<a name='10302'>
   do i=its,ite<a name='10303'>
   do k=kts,kte<a name='10304'>
   do j=jts,jte<a name='10305'>
      VAL_L=VAL_L+P_ru(i,k,j)*P_ru(i,k,j)         &amp;<a name='10306'>
               +P_rv(i,k,j)*P_rv(i,k,j)            &amp;<a name='10307'>
               +P_ww(i,k,j)*P_ww(i,k,j)            &amp;<a name='10308'>
               +P_advect_tend(i,k,j)*P_advect_tend(i,k,j)            &amp;<a name='10309'>
               +P_alt(i,k,j)*P_alt(i,k,j)          &amp;<a name='10310'>
               +P_xkmhd(i,k,j)*P_xkmhd(i,k,j)<a name='10311'>
   enddo<a name='10312'>
   enddo<a name='10313'>
   enddo<a name='10314'>
<a name='10315'>
#ifdef DM_PARALLEL<a name='10316'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10317'>
                       comm, IERROR )<a name='10318'>
   VAL_L = nsum <a name='10319'>
#endif<a name='10320'>
<a name='10321'>
<font color=#447700>!  ADJ<a name='10322'></font>
<a name='10323'>
   CALL <A href='../../html_code/dyn_em/module_em_ad.F.html#A_RK_SCALAR_TEND'>a_rk_scalar_tend</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_RK_SCALAR_TEND_1">( scs, sce, config_flags, rk_step, ru, P_ru, rv, P_rv, ww, P_ww, mut, P_mut, alt, P_alt, scalar_old, &amp;<a name='10324'>
&amp;P_scalar_old, scalar, P_scalar, P_scalar_tends, P_advect_tend, base, moist_step, fnm, fnp, msfu, msfv, msft, rdx, rdy, rdn, rdnw, &amp;<a name='10325'>
&amp;kvdif, xkmhd, P_xkmhd, leapfrog, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='10326'>
<a name='10327'>
<a name='10328'>
   VAL_A=0.<a name='10329'>
   do i=its,ite<a name='10330'>
   do k=kts,kte<a name='10331'>
   do j=jts,jte<a name='10332'>
      VAL_A=VAL_A +P_ru(i,k,j)*B_ru(i,k,j)         &amp;<a name='10333'>
               +P_rv(i,k,j)*B_rv(i,k,j)            &amp;<a name='10334'>
               +P_ww(i,k,j)*B_ww(i,k,j)            &amp;<a name='10335'>
               +P_advect_tend(i,k,j)*B_advect_tend(i,k,j)            &amp;<a name='10336'>
               +P_alt(i,k,j)*B_alt(i,k,j)          &amp;<a name='10337'>
               +P_xkmhd(i,k,j)*B_xkmhd(i,k,j)<a name='10338'>
   enddo<a name='10339'>
   enddo<a name='10340'>
   enddo<a name='10341'>
   do i=its,ite<a name='10342'>
   do k=kts,kte<a name='10343'>
   do j=jts,jte<a name='10344'>
   do h=scs,sce<a name='10345'>
      VAL_A=VAL_A +P_scalar(i,k,j,h)*B_scalar(i,k,j,h)   &amp;<a name='10346'>
                  +P_scalar_old(i,k,j,h)*B_scalar_old(i,k,j,h)<a name='10347'>
   enddo<a name='10348'>
   enddo<a name='10349'>
   enddo<a name='10350'>
   enddo<a name='10351'>
   do i=its,ite<a name='10352'>
   do k=kts,kte<a name='10353'>
   do j=jts,jte<a name='10354'>
   do h=scs,sce<a name='10355'>
      VAL_A=VAL_A +P_scalar_tends(i,k,j,h)*B_scalar_tends(i,k,j,h)   <a name='10356'>
   enddo<a name='10357'>
   enddo<a name='10358'>
   enddo<a name='10359'>
   enddo<a name='10360'>
<a name='10361'>
#ifdef DM_PARALLEL<a name='10362'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10363'>
                       comm, IERROR )<a name='10364'>
   VAL_A = nsum <a name='10365'>
#endif<a name='10366'>
<a name='10367'>
   print*, '                '<a name='10368'>
   write(6,*) 'a_rk_scalar_tend: '<a name='10369'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='10370'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='10371'>
<a name='10372'>
<font color=#447700>!  RECOVER<a name='10373'></font>
<a name='10374'>
<a name='10375'>
   do i=ims,ime<a name='10376'>
   do k=kms,kme<a name='10377'>
   do j=jms,jme<a name='10378'>
      ru(i,k,j)=S_ru(i,k,j)<a name='10379'>
      rv(i,k,j)=S_rv(i,k,j)<a name='10380'>
      ww(i,k,j)=S_ww(i,k,j)<a name='10381'>
      advect_tend(i,k,j)=S_advect_tend(i,k,j)<a name='10382'>
      xkmhd(i,k,j)=S_xkmhd(i,k,j)<a name='10383'>
      alt(i,k,j)=S_alt(i,k,j)<a name='10384'>
   enddo<a name='10385'>
   enddo<a name='10386'>
   enddo<a name='10387'>
   do i=ims,ime<a name='10388'>
   do k=kms,kme<a name='10389'>
   do j=jms,jme<a name='10390'>
   do h=scs,sce<a name='10391'>
      scalar(i,k,j,h)=S_scalar(i,k,j,h)<a name='10392'>
      scalar_old(i,k,j,h)=S_scalar_old(i,k,j,h)<a name='10393'>
   enddo<a name='10394'>
   enddo<a name='10395'>
   enddo<a name='10396'>
   enddo<a name='10397'>
<a name='10398'>
   do i=ims,ime<a name='10399'>
   do k=kms,kme<a name='10400'>
   do j=jms,jme<a name='10401'>
   do h=scs,sce<a name='10402'>
      scalar_tends(i,k,j,h)=S_scalar_tends(i,k,j,h)<a name='10403'>
   enddo<a name='10404'>
   enddo<a name='10405'>
   enddo<a name='10406'>
   enddo<a name='10407'>
<a name='10408'>
END SUBROUTINE t_rk_scalar_tend<a name='10409'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='10410'></font>
<A NAME='T_SPEC_BDY_SCALAR'><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_SCALAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='10411'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_spec_bdy_scalar</font> ( scalar_tend,    &amp; <A href='../../call_to/T_SPEC_BDY_SCALAR.html' TARGET='index'>1</A>,<A href='../../call_from/T_SPEC_BDY_SCALAR.html' TARGET='index'>5</A><a name='10412'>
                               scalar_b, scalar_bt,             &amp;<a name='10413'>
                          spec_bdy_width, spec_zone,                   &amp;<a name='10414'>
                          ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='10415'></font>
                          ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='10416'></font>
                          ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='10417'></font>
                          ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='10418'></font>
                          its, ite, jts, jte, kts, kte)<a name='10419'>
<a name='10420'>
   IMPLICIT NONE<a name='10421'>
<a name='10422'>
   <font color=#447700>!  Input data.<a name='10423'></font>
   TYPE( grid_config_rec_type ) config_flags<a name='10424'>
<a name='10425'>
<a name='10426'>
   INTEGER ,               INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='10427'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='10428'>
                                            ips, ipe, jps, jpe, kps, kpe, &amp;<a name='10429'>
                                            its, ite, jts, jte, kts, kte<a name='10430'>
   INTEGER ,               INTENT(IN   ) :: ijds, ijde<a name='10431'>
   INTEGER ,               INTENT(IN   ) :: spec_bdy_width, spec_zone<a name='10432'>
<a name='10433'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) , INTENT(OUT  ) :: scalar_tend<a name='10434'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 ), INTENT(IN   ) :: scalar_b<a name='10435'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 )   :: scalar_bt<a name='10436'>
<font color=#447700>!Local<a name='10437'></font>
   INTEGER :: i,j,k<a name='10438'>
<a name='10439'>
<font color=#447700>!  IN variables<a name='10440'></font>
<a name='10441'>
   REAL,  DIMENSION( ijds:ijde , kds:kde , spec_bdy_width, 4 )   :: S_scalar_bt,P_scalar_bt,B_scalar_bt<a name='10442'>
<a name='10443'>
<font color=#447700>!  OUT variables<a name='10444'></font>
<a name='10445'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )   :: S_scalar_tend,P_scalar_tend,B_scalar_tend<a name='10446'>
<a name='10447'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='10448'>
   INTEGER :: NT,h<a name='10449'>
<a name='10450'>
<font color=#447700>!TGL test<a name='10451'></font>
<a name='10452'>
   S_scalar_bt(:,:,:,:)=scalar_bt(:,:,:,:)<a name='10453'>
   P_scalar_bt(:,:,:,:)=scalar_bt(:,:,:,:)<a name='10454'>
<a name='10455'>
   S_scalar_tend(:,:,:)=scalar_tend(:,:,:)<a name='10456'>
   p_scalar_tend(:,:,:)=scalar_tend(:,:,:)<a name='10457'>
<a name='10458'>
<font color=#447700>!NLM<a name='10459'></font>
<a name='10460'>
   CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_1"> ( scalar_tend,    &amp;<a name='10461'>
                          scalar_b, scalar_bt,             &amp;<a name='10462'>
                          spec_bdy_width, spec_zone,                   &amp;<a name='10463'>
                          ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='10464'></font>
                          ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='10465'></font>
                          ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='10466'></font>
                          ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='10467'></font>
                          its, ite, jts, jte, kts, kte)<a name='10468'>
<a name='10469'>
   B_scalar_bt(:,:,:,:)=scalar_bt(:,:,:,:)<a name='10470'>
   B_scalar_tend(:,:,:)=scalar_tend(:,:,:)<a name='10471'>
<a name='10472'>
<font color=#447700>!  TCL<a name='10473'></font>
<a name='10474'>
   scalar_bt(:,:,:,:)=S_scalar_bt(:,:,:,:)<a name='10475'>
   scalar_tend(:,:,:)=S_scalar_tend(:,:,:)<a name='10476'>
<a name='10477'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_tl.F.html#G_SPEC_BDY_SCALAR'>g_spec_bdy_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SPEC_BDY_SCALAR_1">( scalar_tend, P_scalar_tend, scalar_bt, P_scalar_bt, spec_bdy_width, spec_zone, ijds, ijde, ids, ide, &amp;<a name='10478'>
&amp;jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='10479'>
<a name='10480'>
   SAVE_L=sum(P_scalar_tend(:,:,:)*P_scalar_tend(:,:,:)) + &amp;<a name='10481'>
          sum(P_scalar_bt(:,:,:,:)*P_scalar_bt(:,:,:,:))<a name='10482'>
<a name='10483'>
#ifdef DM_PARALLEL<a name='10484'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10485'>
                       comm, IERROR )<a name='10486'>
   SAVE_L = nsum <a name='10487'>
#endif<a name='10488'>
<a name='10489'>
   ALPHA=1.<a name='10490'>
   DO NT=1,11<a name='10491'>
      ALPHA=0.1*ALPHA<a name='10492'>
      FACTOR=1.+ALPHA<a name='10493'>
      P_scalar_bt(:,:,:,:)=FACTOR*S_scalar_bt(:,:,:,:)<a name='10494'>
      P_scalar_tend(:,:,:)=FACTOR*S_scalar_tend(:,:,:)<a name='10495'>
<a name='10496'>
      CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_2"> ( P_scalar_tend,    &amp;<a name='10497'>
                             scalar_b, P_scalar_bt,             &amp;<a name='10498'>
                          spec_bdy_width, spec_zone,                   &amp;<a name='10499'>
                          ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='10500'></font>
                          ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='10501'></font>
                          ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='10502'></font>
                          ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='10503'></font>
                          its, ite, jts, jte, kts, kte)<a name='10504'>
<a name='10505'>
<a name='10506'>
      VAL_N= sum((P_scalar_tend(:,:,:)-B_scalar_tend(:,:,:))*(P_scalar_tend(:,:,:)-B_scalar_tend(:,:,:))) + &amp;<a name='10507'>
             sum((P_scalar_bt(:,:,:,:)-B_scalar_bt(:,:,:,:))*(P_scalar_bt(:,:,:,:)-B_scalar_bt(:,:,:,:)))<a name='10508'>
<a name='10509'>
#ifdef DM_PARALLEL<a name='10510'>
      call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10511'>
                          comm, IERROR )<a name='10512'>
      VAL_N = nsum <a name='10513'>
#endif<a name='10514'>
<a name='10515'>
      VAL_L=SAVE_L*ALPHA**2<a name='10516'>
      COEF=VAL_N/VAL_L<a name='10517'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='10518'>
         'g_spec_bdy_scalar: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='10519'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='10520'>
   ENDDO<a name='10521'>
<a name='10522'>
<font color=#447700>!  ADJ test<a name='10523'></font>
<a name='10524'>
   FACTOR=0.1<a name='10525'>
   scalar_bt(:,:,:,:)=S_scalar_bt(:,:,:,:)<a name='10526'>
   scalar_tend(:,:,:)=S_scalar_tend(:,:,:)<a name='10527'>
   P_scalar_bt(:,:,:,:)=FACTOR*S_scalar_bt(:,:,:,:)<a name='10528'>
   P_scalar_tend(:,:,:)=FACTOR*S_scalar_tend(:,:,:)<a name='10529'>
   B_scalar_bt(:,:,:,:)=P_scalar_bt(:,:,:,:)<a name='10530'>
   B_scalar_tend(:,:,:)=P_scalar_tend(:,:,:)<a name='10531'>
<a name='10532'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_tl.F.html#G_SPEC_BDY_SCALAR'>g_spec_bdy_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SPEC_BDY_SCALAR_2">( scalar_tend, P_scalar_tend, scalar_bt, P_scalar_bt, spec_bdy_width, spec_zone, ijds, ijde, ids, ide, &amp;<a name='10533'>
&amp;jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='10534'>
<a name='10535'>
   VAL_L=sum(P_scalar_tend(:,:,:)*P_scalar_tend(:,:,:))+ &amp;<a name='10536'>
         sum(P_scalar_bt(:,:,:,:)*P_scalar_bt(:,:,:,:))<a name='10537'>
<a name='10538'>
#ifdef DM_PARALLEL<a name='10539'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10540'>
                       comm, IERROR )<a name='10541'>
   VAL_L = nsum <a name='10542'>
#endif<a name='10543'>
<a name='10544'>
<font color=#447700>!  ADJ<a name='10545'></font>
<a name='10546'>
   CALL <A href='../../html_code/dyn_em/module_bc_em_ad.F.html#A_SPEC_BDY_SCALAR'>a_spec_bdy_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDY_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_SPEC_BDY_SCALAR_1">( P_scalar_tend, P_scalar_bt, spec_bdy_width, spec_zone, ijds, ijde, ids, ide, jds, jde, kds, kde, ims,&amp;<a name='10547'>
&amp; ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='10548'>
<a name='10549'>
   VAL_A=sum(P_scalar_bt(:,:,:,:)*B_scalar_bt(:,:,:,:)) + &amp;<a name='10550'>
         sum(P_scalar_tend(:,:,:)*B_scalar_tend(:,:,:))<a name='10551'>
<a name='10552'>
#ifdef DM_PARALLEL<a name='10553'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10554'>
                       comm, IERROR )<a name='10555'>
   VAL_A = nsum <a name='10556'>
#endif<a name='10557'>
<a name='10558'>
   print*, '                '<a name='10559'>
   write(6,*) 'a_spec_bdy_scalar: '<a name='10560'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='10561'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='10562'>
<a name='10563'>
<font color=#447700>!  RECOVER<a name='10564'></font>
<a name='10565'>
   scalar_bt(:,:,:,:)=S_scalar_bt(:,:,:,:)<a name='10566'>
   scalar_tend(:,:,:)=S_scalar_tend(:,:,:)<a name='10567'>
<a name='10568'>
END SUBROUTINE t_spec_bdy_scalar<a name='10569'>
<a name='10570'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='10571'></font>
<a name='10572'>
<A NAME='T_RK_UPDATE_SCALAR'><A href='../../html_code/dyn_em/module_check.F.html#T_RK_UPDATE_SCALAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='10573'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_rk_update_scalar</font>( scs, sce,                      &amp; <A href='../../call_to/T_RK_UPDATE_SCALAR.html' TARGET='index'>1</A>,<A href='../../call_from/T_RK_UPDATE_SCALAR.html' TARGET='index'>5</A><a name='10574'>
                             scalar_1, scalar_2, sc_tend,   &amp;<a name='10575'>
                             advect_tend, msft,             &amp;<a name='10576'>
                             mu_old, mu_new, mu_base,       &amp;<a name='10577'>
                             rk_step, dt, spec_zone,        &amp;<a name='10578'>
                             epsts, leapfrog, config_flags, &amp;<a name='10579'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='10580'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='10581'>
                             its, ite, jts, jte, kts, kte  )<a name='10582'>
<a name='10583'>
   IMPLICIT NONE<a name='10584'>
<a name='10585'>
   <font color=#447700>!  Input data.<a name='10586'></font>
<a name='10587'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='10588'>
<a name='10589'>
   INTEGER ,                INTENT(IN   ) :: scs, sce, rk_step, spec_zone<a name='10590'>
   INTEGER ,                INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='10591'>
                                             ims, ime, jms, jme, kms, kme, &amp;<a name='10592'>
                                             its, ite, jts, jte, kts, kte<a name='10593'>
<a name='10594'>
   REAL,                    INTENT(IN   ) :: dt, epsts<a name='10595'>
<a name='10596'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce),                &amp;<a name='10597'>
         INTENT(INOUT)                                  :: scalar_1,  &amp;<a name='10598'>
                                                           scalar_2,  &amp;<a name='10599'>
                                                           sc_tend<a name='10600'>
<a name='10601'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme )        :: advect_tend<a name='10602'>
   REAL, DIMENSION(ims:ime, jms:jme  )                :: mu_old, mu_new<a name='10603'>
<a name='10604'>
   REAL, DIMENSION(ims:ime, jms:jme  ), INTENT(IN   ) :: mu_base, &amp;<a name='10605'>
                                                          msft<a name='10606'>
<a name='10607'>
   LOGICAL, INTENT(IN   ) :: leapfrog<a name='10608'>
<a name='10609'>
   INTEGER :: i,j,k,im<a name='10610'>
   REAL    :: sc_middle, msfsq<a name='10611'>
   REAL, DIMENSION(its:ite) :: muold, r_munew<a name='10612'>
<a name='10613'>
   REAL, DIMENSION(its:ite, kts:kte, jts:jte  ) :: tendency<a name='10614'>
<a name='10615'>
   INTEGER :: i_start,i_end,j_start,j_end,k_start,k_end<a name='10616'>
   INTEGER :: i_start_spc,i_end_spc,j_start_spc,j_end_spc,k_start_spc,k_end_spc<a name='10617'>
<a name='10618'>
<font color=#447700>!  IN variables<a name='10619'></font>
<a name='10620'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme )    :: S_advect_tend,P_advect_tend,B_advect_tend<a name='10621'>
   REAL, DIMENSION(ims:ime, jms:jme  )            :: S_mu_old, S_mu_new,P_mu_old, P_mu_new,B_mu_old, B_mu_new<a name='10622'>
<a name='10623'>
<font color=#447700>!  INOUT variables<a name='10624'></font>
<a name='10625'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce)  :: S_scalar_1, S_scalar_2, S_sc_tend,P_scalar_1, P_scalar_2, P_sc_tend<a name='10626'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce)  :: K_scalar_1, K_scalar_2, K_sc_tend,B_scalar_1, B_scalar_2, B_sc_tend<a name='10627'>
<a name='10628'>
<a name='10629'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='10630'>
   INTEGER :: NT,h<a name='10631'>
<a name='10632'>
<font color=#447700>!TGL test<a name='10633'></font>
<a name='10634'>
<a name='10635'>
   do i=ims,ime<a name='10636'>
   do k=kms,kme<a name='10637'>
   do j=jms,jme<a name='10638'>
      S_advect_tend(i,k,j)=advect_tend(i,k,j)<a name='10639'>
<a name='10640'>
      P_advect_tend(i,k,j)=advect_tend(i,k,j)<a name='10641'>
   enddo<a name='10642'>
   enddo<a name='10643'>
   enddo<a name='10644'>
   do i=ims,ime<a name='10645'>
   do j=jms,jme<a name='10646'>
      S_mu_old(i,j)=mu_old(i,j)<a name='10647'>
      S_mu_new(i,j)=mu_new(i,j)<a name='10648'>
<a name='10649'>
      P_mu_old(i,j)=mu_old(i,j)<a name='10650'>
      P_mu_new(i,j)=mu_new(i,j)<a name='10651'>
   enddo<a name='10652'>
   enddo<a name='10653'>
   do i=ims,ime<a name='10654'>
   do k=kms,kme<a name='10655'>
   do j=jms,jme<a name='10656'>
   do h=scs,sce<a name='10657'>
      S_scalar_1(i,k,j,h)=scalar_1(i,k,j,h)<a name='10658'>
      S_scalar_2(i,k,j,h)=scalar_2(i,k,j,h)<a name='10659'>
      S_sc_tend(i,k,j,h)=sc_tend(i,k,j,h)<a name='10660'>
<a name='10661'>
      P_scalar_1(i,k,j,h)=scalar_1(i,k,j,h)<a name='10662'>
      P_scalar_2(i,k,j,h)=scalar_2(i,k,j,h)<a name='10663'>
      P_sc_tend(i,k,j,h)=sc_tend(i,k,j,h)<a name='10664'>
<a name='10665'>
      K_scalar_1(i,k,j,h)=scalar_1(i,k,j,h)<a name='10666'>
      K_scalar_2(i,k,j,h)=scalar_2(i,k,j,h)<a name='10667'>
      K_sc_tend(i,k,j,h)=sc_tend(i,k,j,h)<a name='10668'>
   enddo<a name='10669'>
   enddo<a name='10670'>
   enddo<a name='10671'>
   enddo<a name='10672'>
<a name='10673'>
<font color=#447700>!NLM<a name='10674'></font>
<a name='10675'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_UPDATE_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_1">( scs, sce,                      &amp;<a name='10676'>
                             scalar_1, scalar_2, sc_tend,   &amp;<a name='10677'>
                             advect_tend, msft,             &amp;<a name='10678'>
                             mu_old, mu_new, mu_base,       &amp;<a name='10679'>
                             rk_step, dt, spec_zone,        &amp;<a name='10680'>
                             epsts, leapfrog, config_flags, &amp;<a name='10681'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='10682'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='10683'>
                             its, ite, jts, jte, kts, kte  )<a name='10684'>
<a name='10685'>
   do i=its,ite<a name='10686'>
   do k=kts,kte<a name='10687'>
   do j=jts,jte<a name='10688'>
   do h=scs,sce<a name='10689'>
      B_scalar_1(i,k,j,h)=scalar_1(i,k,j,h)<a name='10690'>
      B_scalar_2(i,k,j,h)=scalar_2(i,k,j,h)<a name='10691'>
      B_sc_tend(i,k,j,h)=sc_tend(i,k,j,h)<a name='10692'>
   enddo<a name='10693'>
   enddo<a name='10694'>
   enddo<a name='10695'>
   enddo<a name='10696'>
<a name='10697'>
<font color=#447700>!  TCL<a name='10698'></font>
<a name='10699'>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_RK_UPDATE_SCALAR'>g_rk_update_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_UPDATE_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RK_UPDATE_SCALAR_1">( scs, sce, K_scalar_1, P_scalar_1, K_scalar_2, P_scalar_2, K_sc_tend, P_sc_tend, advect_tend, &amp;<a name='10700'>
&amp;P_advect_tend, msft, mu_old, P_mu_old, mu_new, P_mu_new, mu_base, rk_step, dt, spec_zone, epsts, leapfrog, config_flags, ids, ide,&amp;<a name='10701'>
&amp; jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='10702'>
<a name='10703'>
   SAVE_L=0.<a name='10704'>
   do i=its,ite<a name='10705'>
   do k=kts,kte<a name='10706'>
   do j=jts,jte<a name='10707'>
   do h=scs,sce<a name='10708'>
      SAVE_L=SAVE_L + P_scalar_1(i,k,j,h)*P_scalar_1(i,k,j,h)   &amp;<a name='10709'>
                    + P_scalar_2(i,k,j,h)*P_scalar_2(i,k,j,h)   &amp;<a name='10710'>
                    + P_sc_tend(i,k,j,h)*P_sc_tend(i,k,j,h)<a name='10711'>
   enddo<a name='10712'>
   enddo<a name='10713'>
   enddo<a name='10714'>
   enddo<a name='10715'>
<a name='10716'>
#ifdef DM_PARALLEL<a name='10717'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10718'>
                       comm, IERROR )<a name='10719'>
   SAVE_L = nsum <a name='10720'>
#endif<a name='10721'>
<a name='10722'>
   ALPHA=1.<a name='10723'>
   DO NT=1,11<a name='10724'>
      ALPHA=0.1*ALPHA<a name='10725'>
      FACTOR=1.+ALPHA<a name='10726'>
   do i=ims,ime<a name='10727'>
   do k=kms,kme<a name='10728'>
   do j=jms,jme<a name='10729'>
      P_advect_tend(i,k,j)=FACTOR*S_advect_tend(i,k,j)<a name='10730'>
   enddo<a name='10731'>
   enddo<a name='10732'>
   enddo<a name='10733'>
   do i=ims,ime<a name='10734'>
   do j=jms,jme<a name='10735'>
      P_mu_old(i,j)=FACTOR*S_mu_old(i,j)<a name='10736'>
      P_mu_new(i,j)=FACTOR*S_mu_new(i,j)<a name='10737'>
   enddo<a name='10738'>
   enddo<a name='10739'>
   do i=ims,ime<a name='10740'>
   do k=kms,kme<a name='10741'>
   do j=jms,jme<a name='10742'>
   do h=scs,sce<a name='10743'>
      P_scalar_1(i,k,j,h)=FACTOR*S_scalar_1(i,k,j,h)<a name='10744'>
      P_scalar_2(i,k,j,h)=FACTOR*S_scalar_2(i,k,j,h)<a name='10745'>
      P_sc_tend(i,k,j,h)=FACTOR*S_sc_tend(i,k,j,h)<a name='10746'>
   enddo<a name='10747'>
   enddo<a name='10748'>
   enddo<a name='10749'>
   enddo<a name='10750'>
<a name='10751'>
   CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_UPDATE_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_2">( scs, sce,                      &amp;<a name='10752'>
                             P_scalar_1, P_scalar_2, P_sc_tend,   &amp;<a name='10753'>
                             P_advect_tend, msft,             &amp;<a name='10754'>
                             P_mu_old, P_mu_new, mu_base,       &amp;<a name='10755'>
                             rk_step, dt, spec_zone,        &amp;<a name='10756'>
                             epsts, leapfrog, config_flags, &amp;<a name='10757'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='10758'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='10759'>
                             its, ite, jts, jte, kts, kte  )<a name='10760'>
<a name='10761'>
      VAL_N=0.<a name='10762'>
   do i=its,ite<a name='10763'>
   do k=kts,kte<a name='10764'>
   do j=jts,jte<a name='10765'>
   do h=scs,sce<a name='10766'>
         VAL_N=VAL_N+(P_scalar_1(i,k,j,h)-B_scalar_1(i,k,j,h))*(P_scalar_1(i,k,j,h)-B_scalar_1(i,k,j,h))    &amp;<a name='10767'>
                    +(P_scalar_2(i,k,j,h)-B_scalar_2(i,k,j,h))*(P_scalar_2(i,k,j,h)-B_scalar_2(i,k,j,h))    &amp;<a name='10768'>
                    +(P_sc_tend(i,k,j,h) -B_sc_tend(i,k,j,h))*(P_sc_tend(i,k,j,h) -B_sc_tend(i,k,j,h))<a name='10769'>
   enddo<a name='10770'>
   enddo<a name='10771'>
   enddo<a name='10772'>
   enddo<a name='10773'>
<a name='10774'>
#ifdef DM_PARALLEL<a name='10775'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10776'>
                       comm, IERROR )<a name='10777'>
   VAL_N = nsum <a name='10778'>
#endif<a name='10779'>
<a name='10780'>
      VAL_L=SAVE_L*ALPHA**2<a name='10781'>
<a name='10782'>
      if(VAL_L == 0.) then<a name='10783'>
         COEF = 1.<a name='10784'>
      else<a name='10785'>
         COEF=VAL_N/VAL_L<a name='10786'>
      endif<a name='10787'>
<a name='10788'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='10789'>
         'g_rk_update_scalar: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='10790'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='10791'>
   ENDDO<a name='10792'>
<a name='10793'>
<font color=#447700>!  ADJ test<a name='10794'></font>
<a name='10795'>
   FACTOR=0.1<a name='10796'>
   do i=ims,ime<a name='10797'>
   do k=kms,kme<a name='10798'>
   do j=jms,jme<a name='10799'>
      advect_tend(i,k,j)=S_advect_tend(i,k,j)<a name='10800'>
<a name='10801'>
      P_advect_tend(i,k,j)=FACTOR*S_advect_tend(i,k,j)<a name='10802'>
<a name='10803'>
      B_advect_tend(i,k,j)=P_advect_tend(i,k,j)<a name='10804'>
   enddo<a name='10805'>
   enddo<a name='10806'>
   enddo<a name='10807'>
   do i=ims,ime<a name='10808'>
   do j=jms,jme<a name='10809'>
      mu_old(i,j)=S_mu_old(i,j)<a name='10810'>
      mu_new(i,j)=S_mu_new(i,j)<a name='10811'>
<a name='10812'>
      P_mu_old(i,j)=FACTOR*S_mu_old(i,j)<a name='10813'>
      P_mu_new(i,j)=FACTOR*S_mu_new(i,j)<a name='10814'>
<a name='10815'>
      B_mu_old(i,j)=P_mu_old(i,j)<a name='10816'>
      B_mu_new(i,j)=P_mu_new(i,j)<a name='10817'>
   enddo<a name='10818'>
   enddo<a name='10819'>
   do i=ims,ime<a name='10820'>
   do k=kms,kme<a name='10821'>
   do j=jms,jme<a name='10822'>
   do h=scs,sce<a name='10823'>
      scalar_1(i,k,j,h)=S_scalar_1(i,k,j,h)<a name='10824'>
      scalar_2(i,k,j,h)=S_scalar_2(i,k,j,h)<a name='10825'>
      sc_tend(i,k,j,h)=S_sc_tend(i,k,j,h)<a name='10826'>
<a name='10827'>
      P_scalar_1(i,k,j,h)=FACTOR*S_scalar_1(i,k,j,h)<a name='10828'>
      P_scalar_2(i,k,j,h)=FACTOR*S_scalar_2(i,k,j,h)<a name='10829'>
      P_sc_tend(i,k,j,h)=FACTOR*S_sc_tend(i,k,j,h)<a name='10830'>
<a name='10831'>
      B_scalar_1(i,k,j,h)=P_scalar_1(i,k,j,h)<a name='10832'>
      B_scalar_2(i,k,j,h)=P_scalar_2(i,k,j,h)<a name='10833'>
      B_sc_tend(i,k,j,h)=P_sc_tend(i,k,j,h)<a name='10834'>
<a name='10835'>
      K_scalar_1(i,k,j,h)=scalar_1(i,k,j,h)<a name='10836'>
      K_scalar_2(i,k,j,h)=scalar_2(i,k,j,h)<a name='10837'>
      K_sc_tend(i,k,j,h)=sc_tend(i,k,j,h)<a name='10838'>
   enddo<a name='10839'>
   enddo<a name='10840'>
   enddo<a name='10841'>
   enddo<a name='10842'>
<a name='10843'>
<font color=#447700>!  TGL<a name='10844'></font>
<a name='10845'>
   CALL <A href='../../html_code/dyn_em/module_em_tl.F.html#G_RK_UPDATE_SCALAR'>g_rk_update_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_UPDATE_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_RK_UPDATE_SCALAR_2">( scs, sce, scalar_1, P_scalar_1, scalar_2, P_scalar_2, sc_tend, P_sc_tend, advect_tend, &amp;<a name='10846'>
&amp;P_advect_tend, msft, mu_old, P_mu_old, mu_new, P_mu_new, mu_base, rk_step, dt, spec_zone, epsts, leapfrog, config_flags, ids, ide,&amp;<a name='10847'>
&amp; jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='10848'>
<a name='10849'>
   VAL_L=0.<a name='10850'>
   do i=its,ite<a name='10851'>
   do k=kts,kte<a name='10852'>
   do j=jts,jte<a name='10853'>
   do h=scs,sce<a name='10854'>
      VAL_L=VAL_L + P_scalar_1(i,k,j,h)*P_scalar_1(i,k,j,h)   &amp;<a name='10855'>
                    + P_scalar_2(i,k,j,h)*P_scalar_2(i,k,j,h)   &amp;<a name='10856'>
                    + P_sc_tend(i,k,j,h)*P_sc_tend(i,k,j,h)<a name='10857'>
   enddo<a name='10858'>
   enddo<a name='10859'>
   enddo<a name='10860'>
   enddo<a name='10861'>
<a name='10862'>
#ifdef DM_PARALLEL<a name='10863'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10864'>
                       comm, IERROR )<a name='10865'>
   VAL_L = nsum <a name='10866'>
#endif<a name='10867'>
<a name='10868'>
   do i=ims,ime<a name='10869'>
   do k=kms,kme<a name='10870'>
   do j=jms,jme<a name='10871'>
      P_advect_tend(i,k,j)=0.0<a name='10872'>
   enddo<a name='10873'>
   enddo<a name='10874'>
   enddo<a name='10875'>
   do i=ims,ime<a name='10876'>
   do j=jms,jme<a name='10877'>
      P_mu_old(i,j)=0.0<a name='10878'>
      P_mu_new(i,j)=0.0<a name='10879'>
   enddo<a name='10880'>
   enddo<a name='10881'>
<a name='10882'>
<font color=#447700>!  ADJ<a name='10883'></font>
<a name='10884'>
   CALL <A href='../../html_code/dyn_em/module_em_ad.F.html#A_RK_UPDATE_SCALAR'>a_rk_update_scalar</A><A href='../../html_code/dyn_em/module_check.F.html#T_RK_UPDATE_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_RK_UPDATE_SCALAR_1">( scs, sce, K_scalar_1, P_scalar_1, K_scalar_2, P_scalar_2, K_sc_tend, P_sc_tend, advect_tend, &amp;<a name='10885'>
&amp;P_advect_tend, msft, mu_old, P_mu_old, mu_new, P_mu_new, mu_base, rk_step, dt, spec_zone, epsts, leapfrog, config_flags, ids, ide,&amp;<a name='10886'>
&amp; jds, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='10887'>
<a name='10888'>
   VAL_A=0.<a name='10889'>
   do i=its,ite<a name='10890'>
   do k=kts,kte<a name='10891'>
   do j=jts,jte<a name='10892'>
      VAL_A=VAL_A +P_advect_tend(i,k,j)*B_advect_tend(i,k,j)     <a name='10893'>
   enddo<a name='10894'>
   enddo<a name='10895'>
   enddo<a name='10896'>
   do i=its,ite<a name='10897'>
   do j=jts,jte<a name='10898'>
      VAL_A=VAL_A +P_mu_old(i,j)*B_mu_old(i,j)                   &amp;<a name='10899'>
                  +P_mu_new(i,j)*B_mu_new(i,j)<a name='10900'>
   enddo<a name='10901'>
   enddo<a name='10902'>
   do i=its,ite<a name='10903'>
   do k=kts,kte<a name='10904'>
   do j=jts,jte<a name='10905'>
   do h=scs,sce<a name='10906'>
      VAL_A=VAL_A + P_scalar_1(i,k,j,h)*B_scalar_1(i,k,j,h)   &amp;<a name='10907'>
                    + P_scalar_2(i,k,j,h)*B_scalar_2(i,k,j,h)   &amp;<a name='10908'>
                    + P_sc_tend(i,k,j,h)*B_sc_tend(i,k,j,h)<a name='10909'>
   enddo<a name='10910'>
   enddo<a name='10911'>
   enddo<a name='10912'>
   enddo<a name='10913'>
<a name='10914'>
#ifdef DM_PARALLEL<a name='10915'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='10916'>
                       comm, IERROR )<a name='10917'>
   VAL_A = nsum <a name='10918'>
#endif<a name='10919'>
<a name='10920'>
   print*, '                '<a name='10921'>
   write(6,*) 'a_rk_update_scalar: '<a name='10922'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='10923'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='10924'>
<a name='10925'>
<font color=#447700>!  RECOVER<a name='10926'></font>
<a name='10927'>
   do i=ims,ime<a name='10928'>
   do k=kms,kme<a name='10929'>
   do j=jms,jme<a name='10930'>
      advect_tend(i,k,j)=S_advect_tend(i,k,j)<a name='10931'>
   enddo<a name='10932'>
   enddo<a name='10933'>
   enddo<a name='10934'>
   do i=ims,ime<a name='10935'>
   do j=jms,jme<a name='10936'>
      mu_old(i,j)=S_mu_old(i,j)<a name='10937'>
      mu_new(i,j)=S_mu_new(i,j)<a name='10938'>
   enddo<a name='10939'>
   enddo<a name='10940'>
   do i=ims,ime<a name='10941'>
   do k=kms,kme<a name='10942'>
   do j=jms,jme<a name='10943'>
   do h=scs,sce<a name='10944'>
      scalar_1(i,k,j,h)=S_scalar_1(i,k,j,h)<a name='10945'>
      scalar_2(i,k,j,h)=S_scalar_2(i,k,j,h)<a name='10946'>
      sc_tend(i,k,j,h)=S_sc_tend(i,k,j,h)<a name='10947'>
   enddo<a name='10948'>
   enddo<a name='10949'>
   enddo<a name='10950'>
   enddo<a name='10951'>
<a name='10952'>
END SUBROUTINE t_rk_update_scalar<a name='10953'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='10954'></font>
<A NAME='T_CALC_P_RHO_PHI'><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO_PHI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='10955'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_calc_p_rho_phi</font> ( moist, n_moist,                &amp; <A href='../../call_to/T_CALC_P_RHO_PHI.html' TARGET='index'>1</A>,<A href='../../call_from/T_CALC_P_RHO_PHI.html' TARGET='index'>5</A><a name='10956'>
                            al, alb, mu, muts, ph, p, pb,  &amp;<a name='10957'>
                            t, p0, t0, znu, dnw, rdnw,     &amp;<a name='10958'>
                            rdn, non_hydrostatic,          &amp;<a name='10959'>
                            ids, ide, jds, jde, kds, kde,  &amp;<a name='10960'>
                            ims, ime, jms, jme, kms, kme,  &amp;<a name='10961'>
                            its, ite, jts, jte, kts, kte  )<a name='10962'>
<a name='10963'>
<a name='10964'>
  IMPLICIT NONE<a name='10965'>
  <a name='10966'>
   <font color=#447700>! Input data<a name='10967'></font>
<a name='10968'>
  LOGICAL ,          INTENT(IN   ) :: non_hydrostatic<a name='10969'>
<a name='10970'>
  INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='10971'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='10972'>
                                      its, ite, jts, jte, kts, kte<a name='10973'>
<a name='10974'>
  INTEGER ,          INTENT(IN   ) :: n_moist<a name='10975'>
<a name='10976'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme )   :: t<a name='10977'>
<a name='10978'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme, n_moist ) :: moist<a name='10979'>
  REAL, DIMENSION( ims:ime , jms:jme )   :: mu, muts<a name='10980'>
<a name='10981'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(IN   ) :: alb,  &amp;<a name='10982'>
                                                                   pb<a name='10983'>
<a name='10984'>
<a name='10985'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(  OUT) :: al, p<a name='10986'>
<a name='10987'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(INOUT) :: ph<a name='10988'>
<a name='10989'>
<a name='10990'>
  REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: znu, dnw, rdnw, rdn<a name='10991'>
<a name='10992'>
  REAL,   INTENT(IN   ) :: t0, p0<a name='10993'>
<a name='10994'>
  <font color=#447700>! Local stuff<a name='10995'></font>
<a name='10996'>
  INTEGER :: i, j, k, itf, jtf, ktf, ispe<a name='10997'>
  REAL    :: qvf, qtot, qf1, qf2<a name='10998'>
<a name='10999'>
<font color=#447700>!  IN variables<a name='11000'></font>
<a name='11001'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme )   :: S_t,P_t,B_t<a name='11002'>
<a name='11003'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme, n_moist ) :: S_moist,P_moist,B_moist<a name='11004'>
  REAL, DIMENSION( ims:ime , jms:jme )   :: S_mu, S_muts,P_mu, P_muts,B_mu, B_muts<a name='11005'>
<font color=#447700>!  INOUT<a name='11006'></font>
<a name='11007'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme )  :: S_ph,P_ph,K_ph,B_ph<a name='11008'>
<a name='11009'>
<font color=#447700>!  OUT variables<a name='11010'></font>
<a name='11011'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) :: P_al, P_p,B_al, B_p,S_al,S_p<a name='11012'>
<a name='11013'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='11014'>
   INTEGER :: NT,h<a name='11015'>
<a name='11016'>
<font color=#447700>!TGL test<a name='11017'></font>
<a name='11018'>
   do i=ims,ime<a name='11019'>
   do k=kms,kme<a name='11020'>
   do j=jms,jme<a name='11021'>
      S_t(i,k,j)=t(i,k,j)<a name='11022'>
      P_t(i,k,j)=t(i,k,j)<a name='11023'>
   enddo<a name='11024'>
   enddo<a name='11025'>
   enddo<a name='11026'>
   do i=ims,ime<a name='11027'>
   do k=kms,kme<a name='11028'>
   do j=jms,jme<a name='11029'>
   do h=1,n_moist<a name='11030'>
      S_moist(i,k,j,h)=moist(i,k,j,h)<a name='11031'>
      P_moist(i,k,j,h)=moist(i,k,j,h)<a name='11032'>
   enddo<a name='11033'>
   enddo<a name='11034'>
   enddo<a name='11035'>
   enddo<a name='11036'>
   do i=ims,ime<a name='11037'>
   do j=jms,jme<a name='11038'>
      S_mu(i,j)=mu(i,j)<a name='11039'>
      S_muts(i,j)=muts(i,j)<a name='11040'>
<a name='11041'>
      P_mu(i,j)=mu(i,j)<a name='11042'>
      P_muts(i,j)=muts(i,j)<a name='11043'>
   enddo<a name='11044'>
   enddo<a name='11045'>
<a name='11046'>
   do i=ims,ime<a name='11047'>
   do k=kms,kme<a name='11048'>
   do j=jms,jme<a name='11049'>
      S_ph(i,k,j)=ph(i,k,j)<a name='11050'>
      P_ph(i,k,j)=ph(i,k,j)<a name='11051'>
      K_ph(i,k,j)=ph(i,k,j)<a name='11052'>
   enddo<a name='11053'>
   enddo<a name='11054'>
   enddo<a name='11055'>
<a name='11056'>
   do i=ims,ime<a name='11057'>
   do k=kms,kme<a name='11058'>
   do j=jms,jme<a name='11059'>
      S_al(i,k,j)=al(i,k,j)<a name='11060'>
      S_p(i,k,j)=p(i,k,j)<a name='11061'>
<a name='11062'>
      P_al(i,k,j)=al(i,k,j)<a name='11063'>
      P_p(i,k,j)=p(i,k,j)<a name='11064'>
   enddo<a name='11065'>
   enddo<a name='11066'>
   enddo<a name='11067'>
<a name='11068'>
<font color=#447700>!NLM<a name='11069'></font>
<a name='11070'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI'>calc_p_rho_phi</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO_PHI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_PHI_1"> ( moist, n_moist,                &amp;<a name='11071'>
                            al, alb, mu, muts, ph, p, pb,  &amp;<a name='11072'>
                            t, p0, t0, znu, dnw, rdnw,     &amp;<a name='11073'>
                            rdn, non_hydrostatic,          &amp;<a name='11074'>
                            ids, ide, jds, jde, kds, kde,  &amp;<a name='11075'>
                            ims, ime, jms, jme, kms, kme,  &amp;<a name='11076'>
                            its, ite, jts, jte, kts, kte  )<a name='11077'>
<a name='11078'>
   do i=its,ite<a name='11079'>
   do k=kts,kte<a name='11080'>
   do j=jts,jte<a name='11081'>
      B_al(i,k,j)=al(i,k,j)<a name='11082'>
      B_p(i,k,j)=p(i,k,j)<a name='11083'>
   enddo<a name='11084'>
   enddo<a name='11085'>
   enddo<a name='11086'>
   do i=its,ite<a name='11087'>
   do k=kts,kte<a name='11088'>
   do j=jts,jte<a name='11089'>
      B_ph(i,k,j)=ph(i,k,j)<a name='11090'>
   enddo<a name='11091'>
   enddo<a name='11092'>
   enddo<a name='11093'>
<a name='11094'>
   do i=its,ite<a name='11095'>
   do k=kts,kte<a name='11096'>
   do j=jts,jte<a name='11097'>
      B_t(i,k,j)=t(i,k,j)<a name='11098'>
   enddo<a name='11099'>
   enddo<a name='11100'>
   enddo<a name='11101'>
   do i=its,ite<a name='11102'>
   do k=kts,kte<a name='11103'>
   do j=jts,jte<a name='11104'>
   do h=1,n_moist<a name='11105'>
      B_moist(i,k,j,h)=moist(i,k,j,h)<a name='11106'>
   enddo<a name='11107'>
   enddo<a name='11108'>
   enddo<a name='11109'>
   enddo<a name='11110'>
   do i=its,ite<a name='11111'>
   do j=jts,jte<a name='11112'>
      B_mu(i,j)=mu(i,j)<a name='11113'>
      B_muts(i,j)=muts(i,j)<a name='11114'>
   enddo<a name='11115'>
   enddo<a name='11116'>
<a name='11117'>
<font color=#447700>!  TCL<a name='11118'></font>
<a name='11119'>
   do i=ims,ime<a name='11120'>
   do k=kms,kme<a name='11121'>
   do j=jms,jme<a name='11122'>
      t(i,k,j)=S_t(i,k,j)<a name='11123'>
   enddo<a name='11124'>
   enddo<a name='11125'>
   enddo<a name='11126'>
   do i=ims,ime<a name='11127'>
   do k=kms,kme<a name='11128'>
   do j=jms,jme<a name='11129'>
   do h=1,n_moist<a name='11130'>
      moist(i,k,j,h)=S_moist(i,k,j,h)<a name='11131'>
   enddo<a name='11132'>
   enddo<a name='11133'>
   enddo<a name='11134'>
   enddo<a name='11135'>
   do i=ims,ime<a name='11136'>
   do j=jms,jme<a name='11137'>
      mu(i,j)=S_mu(i,j)<a name='11138'>
   enddo<a name='11139'>
   enddo<a name='11140'>
<a name='11141'>
   do i=ims,ime<a name='11142'>
   do k=kms,kme<a name='11143'>
   do j=jms,jme<a name='11144'>
      ph(i,k,j)=S_ph(i,k,j)<a name='11145'>
   enddo<a name='11146'>
   enddo<a name='11147'>
   enddo<a name='11148'>
<a name='11149'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_CALC_P_RHO_PHI'>g_calc_p_rho_phi</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO_PHI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALC_P_RHO_PHI_1">( moist, P_moist, n_moist, al, P_al, alb, mu, P_mu, muts, P_muts, ph, P_ph, p, P_p, pb, t, P_t, p0, t0, &amp;<a name='11150'>
&amp;dnw, rdnw, rdn, non_hydrostatic, ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='11151'>
<a name='11152'>
   SAVE_L=0.<a name='11153'>
   do i=its,ite<a name='11154'>
   do k=kts,kte<a name='11155'>
   do j=jts,jte<a name='11156'>
      SAVE_L=SAVE_L +P_al(i,k,j)*P_al(i,k,j)  +P_p(i,k,j)*P_p(i,k,j)<a name='11157'>
   enddo<a name='11158'>
   enddo<a name='11159'>
   enddo<a name='11160'>
   do i=its,ite<a name='11161'>
   do k=kts,kte<a name='11162'>
   do j=jts,jte<a name='11163'>
      SAVE_L=SAVE_L +P_ph(i,k,j)*P_ph(i,k,j)<a name='11164'>
   enddo<a name='11165'>
   enddo<a name='11166'>
   enddo<a name='11167'>
<a name='11168'>
   do i=its,ite<a name='11169'>
   do k=kts,kte<a name='11170'>
   do j=jts,jte<a name='11171'>
      SAVE_L=SAVE_L +P_t(i,k,j) *P_t(i,k,j)<a name='11172'>
   enddo<a name='11173'>
   enddo<a name='11174'>
   enddo<a name='11175'>
   do i=its,ite<a name='11176'>
   do k=kts,kte<a name='11177'>
   do j=jts,jte<a name='11178'>
   do h=1,n_moist<a name='11179'>
      SAVE_L=SAVE_L+P_moist(i,k,j,h)*P_moist(i,k,j,h)<a name='11180'>
   enddo<a name='11181'>
   enddo<a name='11182'>
   enddo<a name='11183'>
   enddo<a name='11184'>
   do i=its,ite<a name='11185'>
   do j=jts,jte<a name='11186'>
      SAVE_L=SAVE_L+P_mu(i,j)*P_mu(i,j)  +P_muts(i,j)*P_muts(i,j)<a name='11187'>
   enddo<a name='11188'>
   enddo<a name='11189'>
<a name='11190'>
#ifdef DM_PARALLEL<a name='11191'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='11192'>
                       comm, IERROR )<a name='11193'>
   SAVE_L = nsum <a name='11194'>
#endif<a name='11195'>
<a name='11196'>
   ALPHA=1.<a name='11197'>
   DO NT=1,11<a name='11198'>
      ALPHA=0.1*ALPHA<a name='11199'>
      FACTOR=1.+ALPHA<a name='11200'>
   do i=ims,ime<a name='11201'>
   do k=kms,kme<a name='11202'>
   do j=jms,jme<a name='11203'>
      P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='11204'>
   enddo<a name='11205'>
   enddo<a name='11206'>
   enddo<a name='11207'>
   do i=ims,ime<a name='11208'>
   do k=kms,kme<a name='11209'>
   do j=jms,jme<a name='11210'>
   do h=1,n_moist<a name='11211'>
      P_moist(i,k,j,h)=FACTOR*S_moist(i,k,j,h)<a name='11212'>
   enddo<a name='11213'>
   enddo<a name='11214'>
   enddo<a name='11215'>
   enddo<a name='11216'>
   do i=ims,ime<a name='11217'>
   do j=jms,jme<a name='11218'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='11219'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='11220'>
   enddo<a name='11221'>
   enddo<a name='11222'>
<a name='11223'>
   do i=ims,ime<a name='11224'>
   do k=kms,kme<a name='11225'>
   do j=jms,jme<a name='11226'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='11227'>
   enddo<a name='11228'>
   enddo<a name='11229'>
   enddo<a name='11230'>
<a name='11231'>
   do i=ims,ime<a name='11232'>
   do k=kms,kme<a name='11233'>
   do j=jms,jme<a name='11234'>
      P_al(i,k,j)=FACTOR*S_al(i,k,j)<a name='11235'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='11236'>
   enddo<a name='11237'>
   enddo<a name='11238'>
   enddo<a name='11239'>
<a name='11240'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI'>calc_p_rho_phi</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO_PHI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_PHI_2"> ( P_moist, n_moist,                &amp;<a name='11241'>
                            P_al, alb, P_mu, P_muts, P_ph, P_p, pb,  &amp;<a name='11242'>
                            P_t, p0, t0, znu, dnw, rdnw,     &amp;<a name='11243'>
                            rdn, non_hydrostatic,          &amp;<a name='11244'>
                            ids, ide, jds, jde, kds, kde,  &amp;<a name='11245'>
                            ims, ime, jms, jme, kms, kme,  &amp;<a name='11246'>
                            its, ite, jts, jte, kts, kte  )<a name='11247'>
<a name='11248'>
<a name='11249'>
   VAL_N=0.<a name='11250'>
   do i=its,ite<a name='11251'>
   do k=kts,kte<a name='11252'>
   do j=jts,jte<a name='11253'>
         VAL_N=VAL_N+(P_ph(i,k,j)-B_ph(i,k,j))*(P_ph(i,k,j)-B_ph(i,k,j))<a name='11254'>
   enddo<a name='11255'>
   enddo<a name='11256'>
   enddo<a name='11257'>
   do i=its,ite<a name='11258'>
   do k=kts,kte<a name='11259'>
   do j=jts,jte<a name='11260'>
         VAL_N=VAL_N+(P_al(i,k,j)-B_al(i,k,j))*(P_al(i,k,j)-B_al(i,k,j))   &amp;<a name='11261'>
                    +(P_p(i,k,j) -B_p(i,k,j))*(P_p(i,k,j) -B_p(i,k,j))<a name='11262'>
   enddo<a name='11263'>
   enddo<a name='11264'>
   enddo<a name='11265'>
<a name='11266'>
   do i=its,ite<a name='11267'>
   do k=kts,kte<a name='11268'>
   do j=jts,jte<a name='11269'>
      VAL_N=VAL_N+(P_t(i,k,j) -B_t(i,k,j))*(P_t(i,k,j) -B_t(i,k,j))<a name='11270'>
   enddo<a name='11271'>
   enddo<a name='11272'>
   enddo<a name='11273'>
   do i=its,ite<a name='11274'>
   do k=kts,kte<a name='11275'>
   do j=jts,jte<a name='11276'>
   do h=1,n_moist<a name='11277'>
     VAL_N=VAL_N  +(P_moist(i,k,j,h)-B_moist(i,k,j,h))*(P_moist(i,k,j,h)-B_moist(i,k,j,h))<a name='11278'>
   enddo<a name='11279'>
   enddo<a name='11280'>
   enddo<a name='11281'>
   enddo<a name='11282'>
   do i=its,ite<a name='11283'>
   do j=jts,jte<a name='11284'>
     VAL_N=VAL_N  +(P_mu(i,j)-B_mu(i,j))*(P_mu(i,j)-B_mu(i,j))           &amp;<a name='11285'>
                  +(P_muts(i,j)-B_muts(i,j))*(P_muts(i,j)-B_muts(i,j))<a name='11286'>
   enddo<a name='11287'>
   enddo<a name='11288'>
<a name='11289'>
#ifdef DM_PARALLEL<a name='11290'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='11291'>
                       comm, IERROR )<a name='11292'>
   VAL_N = nsum <a name='11293'>
#endif<a name='11294'>
<a name='11295'>
      VAL_L=SAVE_L*ALPHA**2<a name='11296'>
      COEF=VAL_N/VAL_L<a name='11297'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='11298'>
         'g_calc_p_rho_phi: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='11299'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='11300'>
   ENDDO<a name='11301'>
<a name='11302'>
<font color=#447700>!  ADJ test<a name='11303'></font>
<a name='11304'>
   FACTOR=0.1<a name='11305'>
   do i=ims,ime<a name='11306'>
   do k=kms,kme<a name='11307'>
   do j=jms,jme<a name='11308'>
      t(i,k,j)=S_t(i,k,j)<a name='11309'>
      P_t(i,k,j)=FACTOR*S_t(i,k,j)<a name='11310'>
      B_t(i,k,j)=P_t(i,k,j)<a name='11311'>
   enddo<a name='11312'>
   enddo<a name='11313'>
   enddo<a name='11314'>
   do i=ims,ime<a name='11315'>
   do k=kms,kme<a name='11316'>
   do j=jms,jme<a name='11317'>
   do h=1,n_moist<a name='11318'>
      moist(i,k,j,h)=S_moist(i,k,j,h)<a name='11319'>
      P_moist(i,k,j,h)=FACTOR*S_moist(i,k,j,h)<a name='11320'>
      B_moist(i,k,j,h)=P_moist(i,k,j,h)<a name='11321'>
   enddo<a name='11322'>
   enddo<a name='11323'>
   enddo<a name='11324'>
   enddo<a name='11325'>
   do i=ims,ime<a name='11326'>
   do j=jms,jme<a name='11327'>
      mu(i,j)=S_mu(i,j)<a name='11328'>
      muts(i,j)=S_muts(i,j)<a name='11329'>
<a name='11330'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='11331'>
      P_muts(i,j)=FACTOR*S_muts(i,j)<a name='11332'>
<a name='11333'>
      B_mu(i,j)=P_mu(i,j)<a name='11334'>
      B_muts(i,j)=P_muts(i,j)<a name='11335'>
   enddo<a name='11336'>
   enddo<a name='11337'>
<a name='11338'>
   do i=ims,ime<a name='11339'>
   do k=kms,kme<a name='11340'>
   do j=jms,jme<a name='11341'>
      ph(i,k,j)=S_ph(i,k,j)<a name='11342'>
      P_ph(i,k,j)=FACTOR*S_ph(i,k,j)<a name='11343'>
      B_ph(i,k,j)=P_ph(i,k,j)<a name='11344'>
   enddo<a name='11345'>
   enddo<a name='11346'>
   enddo<a name='11347'>
<a name='11348'>
   do i=ims,ime<a name='11349'>
   do k=kms,kme<a name='11350'>
   do j=jms,jme<a name='11351'>
      al(i,k,j)=S_al(i,k,j)<a name='11352'>
      p(i,k,j)=S_p(i,k,j)<a name='11353'>
<a name='11354'>
      P_al(i,k,j)=FACTOR*S_al(i,k,j)<a name='11355'>
      P_p(i,k,j)=FACTOR*S_p(i,k,j)<a name='11356'>
<a name='11357'>
      B_al(i,k,j)=P_al(i,k,j)<a name='11358'>
      B_p(i,k,j)=P_p(i,k,j)<a name='11359'>
   enddo<a name='11360'>
   enddo<a name='11361'>
   enddo<a name='11362'>
<a name='11363'>
<font color=#447700>!  TGL<a name='11364'></font>
<a name='11365'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_CALC_P_RHO_PHI'>g_calc_p_rho_phi</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO_PHI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_CALC_P_RHO_PHI_2">( moist, P_moist, n_moist, al, P_al, alb, mu, P_mu, muts, P_muts, ph, P_ph, p, P_p, pb, t, P_t, p0, t0, &amp;<a name='11366'>
&amp;dnw, rdnw, rdn, non_hydrostatic, ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='11367'>
<a name='11368'>
   VAL_L=0.<a name='11369'>
   do i=its,ite<a name='11370'>
   do k=kts,kte<a name='11371'>
   do j=jts,jte<a name='11372'>
      VAL_L=VAL_L +P_al(i,k,j)*P_al(i,k,j)  +P_p(i,k,j)*P_p(i,k,j)<a name='11373'>
   enddo<a name='11374'>
   enddo<a name='11375'>
   enddo<a name='11376'>
   do i=its,ite<a name='11377'>
   do k=kts,kte<a name='11378'>
   do j=jts,jte<a name='11379'>
      VAL_L=VAL_L +P_ph(i,k,j)*P_ph(i,k,j)<a name='11380'>
   enddo<a name='11381'>
   enddo<a name='11382'>
   enddo<a name='11383'>
<a name='11384'>
   do i=its,ite<a name='11385'>
   do k=kts,kte<a name='11386'>
   do j=jts,jte<a name='11387'>
      VAL_L=VAL_L +P_t(i,k,j) *P_t(i,k,j)<a name='11388'>
   enddo<a name='11389'>
   enddo<a name='11390'>
   enddo<a name='11391'>
   do i=its,ite<a name='11392'>
   do k=kts,kte<a name='11393'>
   do j=jts,jte<a name='11394'>
   do h=1,n_moist<a name='11395'>
      VAL_L=VAL_L+P_moist(i,k,j,h)*P_moist(i,k,j,h)<a name='11396'>
   enddo<a name='11397'>
   enddo<a name='11398'>
   enddo<a name='11399'>
   enddo<a name='11400'>
   do i=its,ite<a name='11401'>
   do j=jts,jte<a name='11402'>
      VAL_L=VAL_L+P_mu(i,j)*P_mu(i,j)  +P_muts(i,j)*P_muts(i,j)<a name='11403'>
   enddo<a name='11404'>
   enddo<a name='11405'>
<a name='11406'>
#ifdef DM_PARALLEL<a name='11407'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='11408'>
                       comm, IERROR )<a name='11409'>
   VAL_L = nsum <a name='11410'>
#endif<a name='11411'>
<a name='11412'>
<font color=#447700>!  ADJ<a name='11413'></font>
<a name='11414'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em_ad.F.html#A_CALC_P_RHO_PHI'>a_calc_p_rho_phi</A><A href='../../html_code/dyn_em/module_check.F.html#T_CALC_P_RHO_PHI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_CALC_P_RHO_PHI_1">( moist, P_moist, n_moist, al, P_al, alb, mu, P_mu, muts, P_muts, ph, P_ph, p, P_p, pb, t, P_t, p0, t0, &amp;<a name='11415'>
&amp;dnw, rdnw, rdn, non_hydrostatic, ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='11416'>
<a name='11417'>
   VAL_A=0.<a name='11418'>
   do i=its,ite<a name='11419'>
   do k=kts,kte<a name='11420'>
   do j=jts,jte<a name='11421'>
      VAL_A=VAL_A +P_t(i,k,j) *B_t(i,k,j)<a name='11422'>
   enddo<a name='11423'>
   enddo<a name='11424'>
   enddo<a name='11425'>
   do i=its,ite<a name='11426'>
   do k=kts,kte<a name='11427'>
   do j=jts,jte<a name='11428'>
   do h=1,n_moist<a name='11429'>
      VAL_A=VAL_A +P_moist(i,k,j,h)*B_moist(i,k,j,h)<a name='11430'>
   enddo<a name='11431'>
   enddo<a name='11432'>
   enddo<a name='11433'>
   enddo<a name='11434'>
   do i=its,ite<a name='11435'>
   do j=jts,jte<a name='11436'>
      VAL_A=VAL_A +P_mu(i,j)*B_mu(i,j)  +P_muts(i,j)*B_muts(i,j)<a name='11437'>
   enddo<a name='11438'>
   enddo<a name='11439'>
<a name='11440'>
   do i=its,ite<a name='11441'>
   do k=kts,kte<a name='11442'>
   do j=jts,jte<a name='11443'>
      VAL_A=VAL_A +P_ph(i,k,j)*B_ph(i,k,j)<a name='11444'>
   enddo<a name='11445'>
   enddo<a name='11446'>
   enddo<a name='11447'>
<a name='11448'>
   do i=its,ite<a name='11449'>
   do k=kts,kte<a name='11450'>
   do j=jts,jte<a name='11451'>
      VAL_A=VAL_A +P_al(i,k,j)*B_al(i,k,j)  +P_p(i,k,j)*B_p(i,k,j)<a name='11452'>
   enddo<a name='11453'>
   enddo<a name='11454'>
   enddo<a name='11455'>
<a name='11456'>
#ifdef DM_PARALLEL<a name='11457'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='11458'>
                       comm, IERROR )<a name='11459'>
   VAL_A = nsum <a name='11460'>
#endif<a name='11461'>
<a name='11462'>
   print*, '                '<a name='11463'>
   write(6,*) 'a_calc_p_rho_phi: '<a name='11464'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='11465'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='11466'>
<a name='11467'>
<font color=#447700>!  RECOVER<a name='11468'></font>
<a name='11469'>
   do i=ims,ime<a name='11470'>
   do k=kms,kme<a name='11471'>
   do j=jms,jme<a name='11472'>
      t(i,k,j)=S_t(i,k,j)<a name='11473'>
   enddo<a name='11474'>
   enddo<a name='11475'>
   enddo<a name='11476'>
   do i=ims,ime<a name='11477'>
   do k=kms,kme<a name='11478'>
   do j=jms,jme<a name='11479'>
   do h=1,n_moist<a name='11480'>
      moist(i,k,j,h)=S_moist(i,k,j,h)<a name='11481'>
   enddo<a name='11482'>
   enddo<a name='11483'>
   enddo<a name='11484'>
   enddo<a name='11485'>
   do i=ims,ime<a name='11486'>
   do j=jms,jme<a name='11487'>
      mu(i,j)=S_mu(i,j)<a name='11488'>
   enddo<a name='11489'>
   enddo<a name='11490'>
<a name='11491'>
   do i=ims,ime<a name='11492'>
   do k=kms,kme<a name='11493'>
   do j=jms,jme<a name='11494'>
      ph(i,k,j)=S_ph(i,k,j)<a name='11495'>
   enddo<a name='11496'>
   enddo<a name='11497'>
   enddo<a name='11498'>
<a name='11499'>
END SUBROUTINE t_calc_p_rho_phi<a name='11500'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='11501'></font>
<A NAME='T_DIAGNOSE_W'><A href='../../html_code/dyn_em/module_check.F.html#T_DIAGNOSE_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='11502'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_diagnose_w</font>( ph_tend, ph_new, ph_old, w, mu, dt,  &amp; <A href='../../call_to/T_DIAGNOSE_W.html' TARGET='index'>1</A>,<A href='../../call_from/T_DIAGNOSE_W.html' TARGET='index'>5</A><a name='11503'>
                       u, v, ht,                            &amp;<a name='11504'>
                       cf1, cf2, cf3, rdx, rdy, msft,       &amp;<a name='11505'>
                       ids, ide, jds, jde, kds, kde,        &amp;<a name='11506'>
                       ims, ime, jms, jme, kms, kme,        &amp;<a name='11507'>
                       its, ite, jts, jte, kts, kte        )<a name='11508'>
<a name='11509'>
<a name='11510'>
   IMPLICIT NONE<a name='11511'>
<a name='11512'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='11513'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='11514'>
                                       its, ite, jts, jte, kts, kte<a name='11515'>
<a name='11516'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme )                ::   ph_tend, &amp;<a name='11517'>
                                                                     ph_new,  &amp;<a name='11518'>
                                                                     ph_old,  &amp;<a name='11519'>
                                                                     u,       &amp;<a name='11520'>
                                                                     v<a name='11521'>
<a name='11522'>
<a name='11523'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(  OUT) :: w<a name='11524'>
<a name='11525'>
   REAL, DIMENSION( ims:ime, jms:jme )    :: mu<a name='11526'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: ht, msft<a name='11527'>
<a name='11528'>
   REAL, INTENT(IN   ) :: dt, cf1, cf2, cf3, rdx, rdy<a name='11529'>
<a name='11530'>
   INTEGER :: i, j, k, itf, jtf<a name='11531'>
<a name='11532'>
<font color=#447700>!  IN variables<a name='11533'></font>
<a name='11534'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme )                ::   S_ph_tend, &amp;<a name='11535'>
                                                                     S_ph_new,  &amp;<a name='11536'>
                                                                     S_ph_old,  &amp;<a name='11537'>
                                                                     S_u,       &amp;<a name='11538'>
                                                                     S_v<a name='11539'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme )                ::   P_ph_tend, &amp;<a name='11540'>
                                                                     P_ph_new,  &amp;<a name='11541'>
                                                                     P_ph_old,  &amp;<a name='11542'>
                                                                     P_u,       &amp;<a name='11543'>
                                                                     P_v<a name='11544'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme )                ::   B_ph_tend, &amp;<a name='11545'>
                                                                     B_ph_new,  &amp;<a name='11546'>
                                                                     B_ph_old,  &amp;<a name='11547'>
                                                                     B_u,       &amp;<a name='11548'>
                                                                     B_v<a name='11549'>
<a name='11550'>
   REAL, DIMENSION( ims:ime, jms:jme )    :: S_mu,P_mu,B_mu<a name='11551'>
<a name='11552'>
<font color=#447700>!  OUT variables<a name='11553'></font>
<a name='11554'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme )        :: P_w,B_w<a name='11555'>
<a name='11556'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='11557'>
   INTEGER :: NT<a name='11558'>
<a name='11559'>
<font color=#447700>!TGL test<a name='11560'></font>
<a name='11561'>
   do i=ims,ime<a name='11562'>
   do k=kms,kme<a name='11563'>
   do j=jms,jme<a name='11564'>
      S_u(i,k,j)=u(i,k,j)<a name='11565'>
      S_v(i,k,j)=v(i,k,j)<a name='11566'>
      S_ph_new(i,k,j)=ph_new(i,k,j)<a name='11567'>
      S_ph_old(i,k,j)=ph_old(i,k,j)<a name='11568'>
      S_ph_tend(i,k,j)=ph_tend(i,k,j)<a name='11569'>
<a name='11570'>
      P_u(i,k,j)=u(i,k,j)<a name='11571'>
      P_v(i,k,j)=v(i,k,j)<a name='11572'>
      P_ph_new(i,k,j)=ph_new(i,k,j)<a name='11573'>
      P_ph_old(i,k,j)=ph_old(i,k,j)<a name='11574'>
      P_ph_tend(i,k,j)=ph_tend(i,k,j)<a name='11575'>
   enddo<a name='11576'>
   enddo<a name='11577'>
   enddo<a name='11578'>
   do i=ims,ime<a name='11579'>
   do j=jms,jme<a name='11580'>
      S_mu(i,j)=mu(i,j)<a name='11581'>
<a name='11582'>
      P_mu(i,j)=mu(i,j)<a name='11583'>
   enddo<a name='11584'>
   enddo<a name='11585'>
<a name='11586'>
<font color=#447700>!NLM<a name='11587'></font>
<a name='11588'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DIAGNOSE_W'>diagnose_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_DIAGNOSE_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIAGNOSE_W_1">( ph_tend, ph_new, ph_old, w, mu, dt,  &amp;<a name='11589'>
                       u, v, ht,                            &amp;<a name='11590'>
                       cf1, cf2, cf3, rdx, rdy, msft,       &amp;<a name='11591'>
                       ids, ide, jds, jde, kds, kde,        &amp;<a name='11592'>
                       ims, ime, jms, jme, kms, kme,        &amp;<a name='11593'>
                       its, ite, jts, jte, kts, kte        )<a name='11594'>
<a name='11595'>
   do i=its,ite<a name='11596'>
   do k=kts,kte<a name='11597'>
   do j=jts,jte<a name='11598'>
      B_w(i,k,j)=w(i,k,j)<a name='11599'>
   enddo<a name='11600'>
   enddo<a name='11601'>
   enddo<a name='11602'>
<a name='11603'>
<font color=#447700>!  TCL<a name='11604'></font>
<a name='11605'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_DIAGNOSE_W'>g_diagnose_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_DIAGNOSE_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_DIAGNOSE_W_1">( ph_tend, P_ph_tend, ph_new, P_ph_new, ph_old, P_ph_old, w, P_w, mu, P_mu, dt, u, P_u, v, P_v, ht, cf1, &amp;<a name='11606'>
&amp;cf2, cf3, rdx, rdy, msft, ide, jde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kte )<a name='11607'>
<a name='11608'>
   SAVE_L=0.<a name='11609'>
   do i=its,ite<a name='11610'>
   do k=kts,kte<a name='11611'>
   do j=jts,jte<a name='11612'>
      SAVE_L=SAVE_L +P_w(i,k,j)*P_w(i,k,j)<a name='11613'>
   enddo<a name='11614'>
   enddo<a name='11615'>
   enddo<a name='11616'>
<a name='11617'>
   ALPHA=1.<a name='11618'>
   DO NT=1,11<a name='11619'>
      ALPHA=0.1*ALPHA<a name='11620'>
      FACTOR=1.+ALPHA<a name='11621'>
   do i=ims,ime<a name='11622'>
   do k=kms,kme<a name='11623'>
   do j=jms,jme<a name='11624'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='11625'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='11626'>
      P_ph_new(i,k,j)=FACTOR*S_ph_new(i,k,j)<a name='11627'>
      P_ph_old(i,k,j)=FACTOR*S_ph_old(i,k,j)<a name='11628'>
      P_ph_tend(i,k,j)=FACTOR*S_ph_tend(i,k,j)<a name='11629'>
   enddo<a name='11630'>
   enddo<a name='11631'>
   enddo<a name='11632'>
   do i=ims,ime<a name='11633'>
   do j=jms,jme<a name='11634'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='11635'>
   enddo<a name='11636'>
   enddo<a name='11637'>
<a name='11638'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DIAGNOSE_W'>diagnose_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_DIAGNOSE_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIAGNOSE_W_2">( P_ph_tend, P_ph_new, P_ph_old, P_w, P_mu, dt,  &amp;<a name='11639'>
                       P_u, P_v, ht,                            &amp;<a name='11640'>
                       cf1, cf2, cf3, rdx, rdy, msft,       &amp;<a name='11641'>
                       ids, ide, jds, jde, kds, kde,        &amp;<a name='11642'>
                       ims, ime, jms, jme, kms, kme,        &amp;<a name='11643'>
                       its, ite, jts, jte, kts, kte        )<a name='11644'>
<a name='11645'>
      VAL_N=0.<a name='11646'>
      do i=its,ite<a name='11647'>
      do k=kts,kte<a name='11648'>
      do j=jts,jte<a name='11649'>
         VAL_N=VAL_N+(P_w(i,k,j)- B_w(i,k,j))*(P_w(i,k,j)- B_w(i,k,j)) <a name='11650'>
      enddo<a name='11651'>
      enddo<a name='11652'>
      enddo<a name='11653'>
<a name='11654'>
#ifdef DM_PARALLEL<a name='11655'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='11656'>
                       comm, IERROR )<a name='11657'>
   VAL_N = nsum<a name='11658'>
#endif<a name='11659'>
<a name='11660'>
      VAL_L=SAVE_L*ALPHA**2<a name='11661'>
      COEF=VAL_N/VAL_L<a name='11662'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='11663'>
         'g_diagnose_w: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='11664'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='11665'>
   ENDDO<a name='11666'>
<a name='11667'>
<font color=#447700>!  ADJ test<a name='11668'></font>
<a name='11669'>
   FACTOR=0.1<a name='11670'>
   do i=ims,ime<a name='11671'>
   do k=kms,kme<a name='11672'>
   do j=jms,jme<a name='11673'>
      u(i,k,j)=S_u(i,k,j)<a name='11674'>
      v(i,k,j)=S_v(i,k,j)<a name='11675'>
      ph_new(i,k,j)=S_ph_new(i,k,j)<a name='11676'>
      ph_old(i,k,j)=S_ph_old(i,k,j)<a name='11677'>
      ph_tend(i,k,j)=S_ph_tend(i,k,j)<a name='11678'>
<a name='11679'>
      P_u(i,k,j)=FACTOR*S_u(i,k,j)<a name='11680'>
      P_v(i,k,j)=FACTOR*S_v(i,k,j)<a name='11681'>
      P_ph_new(i,k,j)=FACTOR*S_ph_new(i,k,j)<a name='11682'>
      P_ph_old(i,k,j)=FACTOR*S_ph_old(i,k,j)<a name='11683'>
      P_ph_tend(i,k,j)=FACTOR*S_ph_tend(i,k,j)<a name='11684'>
<a name='11685'>
      B_u(i,k,j)=P_u(i,k,j)<a name='11686'>
      B_v(i,k,j)=P_v(i,k,j)<a name='11687'>
      B_ph_new(i,k,j)=P_ph_new(i,k,j)<a name='11688'>
      B_ph_old(i,k,j)=P_ph_old(i,k,j)<a name='11689'>
      B_ph_tend(i,k,j)=P_ph_tend(i,k,j)<a name='11690'>
   enddo<a name='11691'>
   enddo<a name='11692'>
   enddo<a name='11693'>
   do i=ims,ime<a name='11694'>
   do j=jms,jme<a name='11695'>
      mu(i,j)=S_mu(i,j)<a name='11696'>
      P_mu(i,j)=FACTOR*S_mu(i,j)<a name='11697'>
      B_mu(i,j)=P_mu(i,j)<a name='11698'>
   enddo<a name='11699'>
   enddo<a name='11700'>
<a name='11701'>
<font color=#447700>!  TGL<a name='11702'></font>
<a name='11703'>
   CALL  <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_DIAGNOSE_W'>g_diagnose_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_DIAGNOSE_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_DIAGNOSE_W_2">( ph_tend, P_ph_tend, ph_new, P_ph_new, ph_old, P_ph_old, w, P_w, mu, P_mu, dt, u, P_u, v, P_v, ht, cf1, &amp;<a name='11704'>
&amp;cf2, cf3, rdx, rdy, msft, ide, jde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kte )<a name='11705'>
<a name='11706'>
   VAL_L=0.<a name='11707'>
   do i=its,ite<a name='11708'>
   do k=kts,kte<a name='11709'>
   do j=jts,jte<a name='11710'>
      VAL_L=VAL_L + P_w(i,k,j)*P_w(i,k,j)<a name='11711'>
   enddo<a name='11712'>
   enddo<a name='11713'>
   enddo<a name='11714'>
<a name='11715'>
#ifdef DM_PARALLEL<a name='11716'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='11717'>
                       comm, IERROR )<a name='11718'>
   VAL_L = nsum<a name='11719'>
#endif<a name='11720'>
<a name='11721'>
   do i=ims,ime<a name='11722'>
   do k=kms,kme<a name='11723'>
   do j=jms,jme<a name='11724'>
      P_u(i,k,j)=0.0<a name='11725'>
      P_v(i,k,j)=0.0<a name='11726'>
      P_ph_new(i,k,j)=0.0<a name='11727'>
      P_ph_old(i,k,j)=0.0<a name='11728'>
      P_ph_tend(i,k,j)=0.0<a name='11729'>
   enddo<a name='11730'>
   enddo<a name='11731'>
   enddo<a name='11732'>
   do i=ims,ime<a name='11733'>
   do j=jms,jme<a name='11734'>
      P_mu(i,j)=0.0<a name='11735'>
   enddo<a name='11736'>
   enddo<a name='11737'>
<a name='11738'>
<font color=#447700>!  ADJ<a name='11739'></font>
<a name='11740'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em_ad.F.html#A_DIAGNOSE_W'>a_diagnose_w</A><A href='../../html_code/dyn_em/module_check.F.html#T_DIAGNOSE_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_DIAGNOSE_W_1">( ph_tend, P_ph_tend, P_ph_new, P_ph_old, P_w, mu, P_mu, dt, P_u, P_v, ht, cf1, cf2, cf3, rdx, rdy, msft, &amp;<a name='11741'>
&amp;ide, jde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kte )<a name='11742'>
<a name='11743'>
   VAL_A=0.<a name='11744'>
   do i=its,ite<a name='11745'>
   do k=kts,kte<a name='11746'>
   do j=jts,jte<a name='11747'>
      VAL_A=VAL_A +P_u(i,k,j)*B_u(i,k,j)              &amp;<a name='11748'>
               +P_v(i,k,j)*B_v(i,k,j)              &amp;<a name='11749'>
               +P_ph_new(i,k,j)*B_ph_new(i,k,j)    &amp;<a name='11750'>
               +P_ph_old(i,k,j)*B_ph_old(i,k,j)    &amp;<a name='11751'>
               +P_ph_tend(i,k,j)*B_ph_tend(i,k,j) <a name='11752'>
   enddo<a name='11753'>
   enddo<a name='11754'>
   enddo<a name='11755'>
   do i=its,ite<a name='11756'>
   do j=jts,jte<a name='11757'>
      VAL_A=VAL_A +P_mu(i,j)*B_mu(i,j)<a name='11758'>
   enddo<a name='11759'>
   enddo<a name='11760'>
<a name='11761'>
#ifdef DM_PARALLEL<a name='11762'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='11763'>
                       comm, IERROR )<a name='11764'>
   VAL_A = nsum<a name='11765'>
#endif<a name='11766'>
<a name='11767'>
   print*, '                '<a name='11768'>
   write(6,*) 'a_diagnose_w: '<a name='11769'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='11770'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='11771'>
<a name='11772'>
<font color=#447700>!  RECOVER<a name='11773'></font>
<a name='11774'>
   do i=ims,ime<a name='11775'>
   do k=kms,kme<a name='11776'>
   do j=jms,jme<a name='11777'>
      u(i,k,j)=S_u(i,k,j)<a name='11778'>
      v(i,k,j)=S_v(i,k,j)<a name='11779'>
      ph_new(i,k,j)=S_ph_new(i,k,j)<a name='11780'>
      ph_old(i,k,j)=S_ph_old(i,k,j)<a name='11781'>
      ph_tend(i,k,j)=S_ph_tend(i,k,j)<a name='11782'>
   enddo<a name='11783'>
   enddo<a name='11784'>
   enddo<a name='11785'>
   do i=ims,ime<a name='11786'>
   do j=jms,jme<a name='11787'>
      mu(i,j)=S_mu(i,j)<a name='11788'>
   enddo<a name='11789'>
   enddo<a name='11790'>
<a name='11791'>
END SUBROUTINE t_diagnose_w<a name='11792'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='11793'></font>
<A NAME='T_SPEC_BDYUPDATE'><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='11794'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>t_spec_bdyupdate</font>(  field,      &amp; <A href='../../call_to/T_SPEC_BDYUPDATE.html' TARGET='index'>1</A>,<A href='../../call_from/T_SPEC_BDYUPDATE.html' TARGET='index'>5</A><a name='11795'>
                               field_tend, dt,            &amp;<a name='11796'>
                               variable_in, config_flags, &amp;<a name='11797'>
                               spec_zone,                  &amp;<a name='11798'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='11799'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='11800'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='11801'></font>
                               its,ite, jts,jte, kts,kte )<a name='11802'>
<a name='11803'>
<a name='11804'>
      IMPLICIT NONE<a name='11805'>
<a name='11806'>
      INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='11807'>
      INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='11808'>
      INTEGER,      INTENT(IN   )    :: ips,ipe, jps,jpe, kps,kpe<a name='11809'>
      INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='11810'>
      INTEGER,      INTENT(IN   )    :: spec_zone<a name='11811'>
      CHARACTER,    INTENT(IN   )    :: variable_in<a name='11812'>
      REAL,         INTENT(IN   )    :: dt<a name='11813'>
<a name='11814'>
<a name='11815'>
      REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )   :: field<a name='11816'>
      REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )   :: field_tend<a name='11817'>
      TYPE( grid_config_rec_type ) config_flags<a name='11818'>
<a name='11819'>
      CHARACTER  :: variable<a name='11820'>
      INTEGER    :: i, j, k, ibs, ibe, jbs, jbe, itf, jtf, ktf<a name='11821'>
      INTEGER    :: b_dist<a name='11822'>
<a name='11823'>
<font color=#447700>!IN variables<a name='11824'></font>
<a name='11825'>
      REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )   :: S_field_tend,P_field_tend,B_field_tend<a name='11826'>
<a name='11827'>
<font color=#447700>!INOUT variables<a name='11828'></font>
<a name='11829'>
      REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )   :: S_field,P_field,B_field,K_field<a name='11830'>
<a name='11831'>
   REAL :: SAVE_L, COEF, ALPHA, FACTOR, VAL_N, VAL_L, VAL_A<a name='11832'>
   INTEGER :: NT<a name='11833'>
<a name='11834'>
<font color=#447700>!TGL test<a name='11835'></font>
<a name='11836'>
   do i=ims,ime<a name='11837'>
   do k=kms,kme<a name='11838'>
   do j=jms,jme<a name='11839'>
      S_field_tend(i,k,j)=field_tend(i,k,j)<a name='11840'>
<a name='11841'>
      P_field_tend(i,k,j)=field_tend(i,k,j)<a name='11842'>
   enddo<a name='11843'>
   enddo<a name='11844'>
   enddo<a name='11845'>
   do i=ims,ime<a name='11846'>
   do k=kms,kme<a name='11847'>
   do j=jms,jme<a name='11848'>
      S_field(i,k,j)=field(i,k,j)<a name='11849'>
<a name='11850'>
      P_field(i,k,j)=field(i,k,j)<a name='11851'>
<a name='11852'>
      K_field(i,k,j)=field(i,k,j)<a name='11853'>
   enddo<a name='11854'>
   enddo<a name='11855'>
   enddo<a name='11856'>
<a name='11857'>
<font color=#447700>!NLM<a name='11858'></font>
<a name='11859'>
   CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_1">(  field,      &amp;<a name='11860'>
                               field_tend, dt,            &amp;<a name='11861'>
                               variable_in, config_flags, &amp;<a name='11862'>
                               spec_zone,                  &amp;<a name='11863'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='11864'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='11865'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='11866'></font>
                               its,ite, jts,jte, kts,kte )<a name='11867'>
<a name='11868'>
   do i=its,ite<a name='11869'>
   do k=kts,kte<a name='11870'>
   do j=jts,jte<a name='11871'>
      B_field(i,k,j)=field(i,k,j)<a name='11872'>
   enddo<a name='11873'>
   enddo<a name='11874'>
   enddo<a name='11875'>
<a name='11876'>
<font color=#447700>!  TCL<a name='11877'></font>
<a name='11878'>
   CALL <A href='../../html_code/dyn_em/module_bc_tl.F.html#G_SPEC_BDYUPDATE'>g_spec_bdyupdate</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SPEC_BDYUPDATE_1">( K_field, P_field, field_tend, P_field_tend, dt, variable_in, spec_zone, ids, ide, jds, jde, kde, ims, &amp;<a name='11879'>
&amp;ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='11880'>
<a name='11881'>
   SAVE_L=0.<a name='11882'>
   do i=its,ite<a name='11883'>
   do k=kts,kte<a name='11884'>
   do j=jts,jte<a name='11885'>
      SAVE_L=SAVE_L + P_field(i,k,j)*P_field(i,k,j)<a name='11886'>
   enddo<a name='11887'>
   enddo<a name='11888'>
   enddo<a name='11889'>
<a name='11890'>
#ifdef DM_PARALLEL<a name='11891'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='11892'>
                       comm, IERROR )<a name='11893'>
   SAVE_L = nsum<a name='11894'>
#endif<a name='11895'>
<a name='11896'>
   ALPHA=1.<a name='11897'>
   DO NT=1,11<a name='11898'>
      ALPHA=0.1*ALPHA<a name='11899'>
      FACTOR=1.+ALPHA<a name='11900'>
   do i=ims,ime<a name='11901'>
   do k=kms,kme<a name='11902'>
   do j=jms,jme<a name='11903'>
      P_field_tend(i,k,j)=FACTOR*S_field_tend(i,k,j)<a name='11904'>
      P_field(i,k,j)=FACTOR*S_field(i,k,j)<a name='11905'>
   enddo<a name='11906'>
   enddo<a name='11907'>
   enddo<a name='11908'>
<a name='11909'>
   CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_2">(  P_field,      &amp;<a name='11910'>
                               P_field_tend, dt,            &amp;<a name='11911'>
                               variable_in, config_flags, &amp;<a name='11912'>
                               spec_zone,                  &amp;<a name='11913'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='11914'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='11915'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='11916'></font>
                               its,ite, jts,jte, kts,kte )<a name='11917'>
<a name='11918'>
   VAL_N=0.<a name='11919'>
   do i=its,ite<a name='11920'>
   do k=kts,kte<a name='11921'>
   do j=jts,jte<a name='11922'>
      VAL_N=VAL_N+(P_field(i,k,j) -B_field(i,k,j))*(P_field(i,k,j) -B_field(i,k,j))<a name='11923'>
   enddo<a name='11924'>
   enddo<a name='11925'>
   enddo<a name='11926'>
<a name='11927'>
#ifdef DM_PARALLEL<a name='11928'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='11929'>
                       comm, IERROR )<a name='11930'>
   VAL_N = nsum<a name='11931'>
#endif<a name='11932'>
<a name='11933'>
      VAL_L=SAVE_L*ALPHA**2<a name='11934'>
      COEF=VAL_N/VAL_L<a name='11935'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='11936'>
         'g_spec_bdyupdate: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='11937'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='11938'>
   ENDDO<a name='11939'>
<a name='11940'>
<font color=#447700>!  ADJ test<a name='11941'></font>
<a name='11942'>
   FACTOR=0.1<a name='11943'>
   do i=ims,ime<a name='11944'>
   do k=kms,kme<a name='11945'>
   do j=jms,jme<a name='11946'>
      field_tend(i,k,j)=S_field_tend(i,k,j)<a name='11947'>
      P_field_tend(i,k,j)=FACTOR*S_field_tend(i,k,j)<a name='11948'>
      B_field_tend(i,k,j)=P_field_tend(i,k,j)<a name='11949'>
   enddo<a name='11950'>
   enddo<a name='11951'>
   enddo<a name='11952'>
   do i=ims,ime<a name='11953'>
   do k=kms,kme<a name='11954'>
   do j=jms,jme<a name='11955'>
      field(i,k,j)=S_field(i,k,j)<a name='11956'>
      P_field(i,k,j)=FACTOR*S_field(i,k,j)<a name='11957'>
      B_field(i,k,j)=P_field(i,k,j)<a name='11958'>
      K_field(i,k,j)=field(i,k,j)<a name='11959'>
   enddo<a name='11960'>
   enddo<a name='11961'>
   enddo<a name='11962'>
<a name='11963'>
   CALL <A href='../../html_code/dyn_em/module_bc_tl.F.html#G_SPEC_BDYUPDATE'>g_spec_bdyupdate</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SPEC_BDYUPDATE_2">( field, P_field, field_tend, P_field_tend, dt, variable_in, spec_zone, ids, ide, jds, jde, kde, ims, &amp;<a name='11964'>
&amp;ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='11965'>
<a name='11966'>
   VAL_L=0.<a name='11967'>
   do i=its,ite<a name='11968'>
   do k=kts,kte<a name='11969'>
   do j=jts,jte<a name='11970'>
      VAL_L=VAL_L + P_field(i,k,j)*P_field(i,k,j)<a name='11971'>
   enddo<a name='11972'>
   enddo<a name='11973'>
   enddo<a name='11974'>
<a name='11975'>
#ifdef DM_PARALLEL<a name='11976'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='11977'>
                       comm, IERROR )<a name='11978'>
   VAL_L = nsum<a name='11979'>
#endif<a name='11980'>
<a name='11981'>
   do i=ims,ime<a name='11982'>
   do k=kms,kme<a name='11983'>
   do j=jms,jme<a name='11984'>
      P_field_tend(i,k,j)=0.0<a name='11985'>
   enddo<a name='11986'>
   enddo<a name='11987'>
   enddo<a name='11988'>
<a name='11989'>
<font color=#447700>!  ADJ<a name='11990'></font>
<a name='11991'>
   CALL <A href='../../html_code/dyn_em/module_bc_ad.F.html#A_SPEC_BDYUPDATE'>a_spec_bdyupdate</A><A href='../../html_code/dyn_em/module_check.F.html#T_SPEC_BDYUPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_SPEC_BDYUPDATE_1">( P_field, P_field_tend, dt, variable_in, spec_zone, ids, ide, jds, jde, kde, ims, ime, jms, jme, kms, &amp;<a name='11992'>
&amp;kme, its, ite, jts, jte, kts, kte )<a name='11993'>
<a name='11994'>
   VAL_A=0.<a name='11995'>
   do i=its,ite<a name='11996'>
   do k=kts,kte<a name='11997'>
   do j=jts,jte<a name='11998'>
      VAL_A=VAL_A + P_field_tend(i,k,j)*B_field_tend(i,k,j) <a name='11999'>
   enddo<a name='12000'>
   enddo<a name='12001'>
   enddo<a name='12002'>
   do i=its,ite<a name='12003'>
   do k=kts,kte<a name='12004'>
   do j=jts,jte<a name='12005'>
      VAL_A=VAL_A + P_field(i,k,j)*B_field(i,k,j)<a name='12006'>
   enddo<a name='12007'>
   enddo<a name='12008'>
   enddo<a name='12009'>
<a name='12010'>
#ifdef DM_PARALLEL<a name='12011'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='12012'>
                       comm, IERROR )<a name='12013'>
   VAL_A = nsum<a name='12014'>
#endif<a name='12015'>
<a name='12016'>
   print*, '                '<a name='12017'>
   write(6,*) 'a_spec_bdyupdate: '<a name='12018'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='12019'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='12020'>
<a name='12021'>
<font color=#447700>!  RECOVER<a name='12022'></font>
<a name='12023'>
   do i=ims,ime<a name='12024'>
   do k=kms,kme<a name='12025'>
   do j=jms,jme<a name='12026'>
      field_tend(i,k,j)=S_field_tend(i,k,j)<a name='12027'>
   enddo<a name='12028'>
   enddo<a name='12029'>
   enddo<a name='12030'>
   do i=ims,ime<a name='12031'>
   do k=kms,kme<a name='12032'>
   do j=jms,jme<a name='12033'>
      field(i,k,j)=S_field(i,k,j)<a name='12034'>
   enddo<a name='12035'>
   enddo<a name='12036'>
   enddo<a name='12037'>
<a name='12038'>
END SUBROUTINE t_spec_bdyupdate<a name='12039'>
<font color=#447700>!-----------------------------------------------------------------------------------------------<a name='12040'></font>
<a name='12041'>
<A NAME='T_SURFACE_DRAG'><A href='../../html_code/dyn_em/module_check.F.html#T_SURFACE_DRAG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='12042'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>t_surface_drag</font> ( ru_tendf, rv_tendf, u, v, xland,             &amp;,<A href='../../call_from/T_SURFACE_DRAG.html' TARGET='index'>6</A><a name='12043'>
                         muu, muv, z, z_at_w,                   &amp;<a name='12044'>
                         ids, ide, jds, jde, kds, kde,                &amp;<a name='12045'>
                         ims, ime, jms, jme, kms, kme,                &amp;<a name='12046'>
                         its, ite, jts, jte, kts, kte   )<a name='12047'>
   <a name='12048'>
   USE <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/dyn_em/module_check.F.html#T_SURFACE_DRAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_4"><a name='12049'>
   implicit none<a name='12050'>
<a name='12051'>
   INTEGER ,               INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='12052'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='12053'>
                                            its, ite, jts, jte, kts, kte<a name='12054'>
<a name='12055'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )  :: ru_tendf, rv_tendf<a name='12056'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  )  :: u, v, z,  z_at_w<a name='12057'>
   REAL , DIMENSION( ims:ime , jms:jme  ) :: muu,muv,xland<a name='12058'>
<font color=#447700>! Local<a name='12059'></font>
   REAL :: V0_u, V0_v, tao_xz, tao_yz, cd, zu, zv, zwt<a name='12060'>
   INTEGER :: i, j, i_start, i_end, i_endu, j_start, j_end, j_endv, k<a name='12061'>
<a name='12062'>
   REAL :: SAVE_L, ALPHA, FACTOR, VAL_N, VAL_L, COEF,VAL_A<a name='12063'>
<a name='12064'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) :: K_ru_tendf,K_rv_tendf<a name='12065'>
<a name='12066'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) :: g_ru_tendf,g_rv_tendf, g_u,g_v, g_z,g_z_at_w<a name='12067'>
   REAL , DIMENSION( ims:ime , jms:jme  )          :: g_muu, g_muv<a name='12068'>
<a name='12069'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) :: P_ru_tendf,P_rv_tendf, P_u,P_v, P_z,P_z_at_w<a name='12070'>
   REAL , DIMENSION( ims:ime , jms:jme  )          :: P_muu, P_muv<a name='12071'>
<a name='12072'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) :: S_ru_tendf,S_rv_tendf, S_u,S_v, S_z,S_z_at_w<a name='12073'>
   REAL , DIMENSION( ims:ime , jms:jme  )          :: S_muu, S_muv<a name='12074'>
<a name='12075'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) :: B_ru_tendf,B_rv_tendf, B_u,B_v, B_z,B_z_at_w<a name='12076'>
   REAL , DIMENSION( ims:ime , jms:jme  )          :: B_muu, B_muv<a name='12077'>
    INTEGER:: NT<a name='12078'>
<a name='12079'>
<font color=#447700>! End declarations.<a name='12080'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='12081'></font>
<a name='12082'>
   K_ru_tendf=ru_tendf<a name='12083'>
   K_rv_tendf=rv_tendf<a name='12084'>
<a name='12085'>
   g_ru_tendf=ru_tendf<a name='12086'>
   g_rv_tendf=rv_tendf<a name='12087'>
   g_u=u<a name='12088'>
   g_v=v<a name='12089'>
   g_muu=muu<a name='12090'>
   g_muv=muv<a name='12091'>
   g_z=z<a name='12092'>
   g_z_at_w=z_at_w<a name='12093'>
<a name='12094'>
   S_ru_tendf=ru_tendf<a name='12095'>
   S_rv_tendf=rv_tendf<a name='12096'>
   S_u=u<a name='12097'>
   S_v=v<a name='12098'>
   S_muu=muu<a name='12099'>
   S_muv=muv<a name='12100'>
   S_z=z<a name='12101'>
   S_z_at_w=z_at_w<a name='12102'>
<a name='12103'>
<font color=#447700>!call FWD<a name='12104'></font>
  call   <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SURFACE_DRAG'>surface_drag</A><A href='../../html_code/dyn_em/module_check.F.html#T_SURFACE_DRAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURFACE_DRAG_1">( ru_tendf, rv_tendf, u, v, xland,             &amp;<a name='12105'>
                         muu, muv, z, z_at_w,                   &amp;<a name='12106'>
                         ids, ide, jds, jde, kds, kde,                &amp;<a name='12107'>
                         ims, ime, jms, jme, kms, kme,                &amp;<a name='12108'>
                         its, ite, jts, jte, kts, kte)<a name='12109'>
<a name='12110'>
        B_ru_tendf=ru_tendf<a name='12111'>
        B_rv_tendf=rv_tendf<a name='12112'>
<a name='12113'>
<font color=#447700>!call TL<a name='12114'></font>
  call   <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_SURFACE_DRAG'>g_surface_drag</A><A href='../../html_code/dyn_em/module_check.F.html#T_SURFACE_DRAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SURFACE_DRAG_1">( K_ru_tendf, g_ru_tendf, K_rv_tendf, g_rv_tendf, u, g_u, v, g_v, xland, muu, g_muu, muv, &amp;<a name='12115'>
  &amp;g_muv, z, g_z, z_at_w, g_z_at_w, ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts , jte, kts, kte )<a name='12116'>
<a name='12117'>
      SAVE_L=0.<a name='12118'>
      SAVE_L=sum(g_ru_tendf**2)+sum(g_rv_tendf**2)<a name='12119'>
<a name='12120'>
#ifdef DM_PARALLEL<a name='12121'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='12122'>
                       comm, IERROR )<a name='12123'>
   SAVE_L = nsum<a name='12124'>
#endif<a name='12125'>
<a name='12126'>
<a name='12127'>
 ALPHA=1.<a name='12128'>
  DO NT=1,11<a name='12129'>
    ALPHA=0.1*ALPHA<a name='12130'>
    FACTOR=1.+ALPHA<a name='12131'>
<a name='12132'>
    P_ru_tendf(:,:,:) = FACTOR * S_ru_tendf(:,:,:)<a name='12133'>
    P_rv_tendf(:,:,:) = FACTOR * S_rv_tendf(:,:,:)<a name='12134'>
    P_u(:,:,:) = FACTOR * S_u(:,:,:)<a name='12135'>
    P_v(:,:,:) = FACTOR * S_v(:,:,:)<a name='12136'>
    P_muu(:,:) = FACTOR *S_muu(:,:)<a name='12137'>
    P_muv(:,:) = FACTOR *S_muv (:,:)<a name='12138'>
    P_z(:,:,:)   = FACTOR *S_z(:,:,:)<a name='12139'>
    P_z_at_w(:,:,:) = FACTOR * S_z_at_w(:,:,:)<a name='12140'>
<a name='12141'>
    call  <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SURFACE_DRAG'>surface_drag</A><A href='../../html_code/dyn_em/module_check.F.html#T_SURFACE_DRAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURFACE_DRAG_2">( P_ru_tendf, P_rv_tendf, P_u, P_v, xland,             &amp;<a name='12142'>
                         P_muu, P_muv, P_z, P_z_at_w,                   &amp;<a name='12143'>
                         ids, ide, jds, jde, kds, kde,                &amp;<a name='12144'>
                         ims, ime, jms, jme, kms, kme,                &amp;<a name='12145'>
                         its, ite, jts, jte, kts, kte   )<a name='12146'>
    VAL_N=0.<a name='12147'>
    VAL_N= sum ((P_ru_tendf-B_ru_tendf)**2)&amp;<a name='12148'>
          +sum ((P_rv_tendf-B_rv_tendf)**2)<a name='12149'>
<a name='12150'>
#ifdef DM_PARALLEL<a name='12151'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='12152'>
                       comm, IERROR )<a name='12153'>
   VAL_N = nsum<a name='12154'>
#endif<a name='12155'>
<a name='12156'>
    VAL_L=SAVE_L*ALPHA**2<a name='12157'>
    COEF=VAL_N/VAL_L<a name='12158'>
    <a name='12159'>
    WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='12160'>
         'g_mod_sfcdiffs: ALPHA=',ALPHA,'  COEF=',COEF, &amp;<a name='12161'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='12162'>
<a name='12163'>
    ENDDO<a name='12164'>
<a name='12165'>
<font color=#447700>! ADJ Test<a name='12166'></font>
<a name='12167'>
   FACTOR=0.01<a name='12168'>
   ru_tendf=S_ru_tendf<a name='12169'>
   rv_tendf=S_rv_tendf<a name='12170'>
   u=S_u<a name='12171'>
   v=S_v<a name='12172'>
   muu=S_muu<a name='12173'>
   muv=S_muv<a name='12174'>
   z=S_z<a name='12175'>
   z_at_w=S_z_at_w<a name='12176'>
<a name='12177'>
   P_ru_tendf=FACTOR*S_ru_tendf<a name='12178'>
   P_rv_tendf=FACTOR*S_rv_tendf<a name='12179'>
   P_u=FACTOR*S_u<a name='12180'>
   P_v=FACTOR*S_v<a name='12181'>
   P_muu=FACTOR*S_muu<a name='12182'>
   P_muv=FACTOR*S_muv<a name='12183'>
   P_z=FACTOR*S_z<a name='12184'>
   P_z_at_w=FACTOR*S_z_at_w<a name='12185'>
<a name='12186'>
   B_ru_tendf=P_ru_tendf<a name='12187'>
   B_rv_tendf=P_rv_tendf<a name='12188'>
   B_u=P_u<a name='12189'>
   B_v=P_v<a name='12190'>
   B_muu=P_muu<a name='12191'>
   B_muv=P_muv<a name='12192'>
   B_z=P_z<a name='12193'>
   B_z_at_w=P_z_at_w<a name='12194'>
   <a name='12195'>
  call   <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_SURFACE_DRAG'>g_surface_drag</A><A href='../../html_code/dyn_em/module_check.F.html#T_SURFACE_DRAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_SURFACE_DRAG_2">( ru_tendf, P_ru_tendf, rv_tendf, P_rv_tendf, u, P_u, v, P_v, xland, muu, P_muu, muv, &amp;<a name='12196'>
  &amp;P_muv,z,P_z, z_at_w, P_z_at_w, ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts , jte, kts, kte )<a name='12197'>
<a name='12198'>
   VAL_L=0.0<a name='12199'>
   VAL_L=sum(P_ru_tendf**2) + sum(P_rv_tendf**2)<a name='12200'>
   <a name='12201'>
#ifdef DM_PARALLEL<a name='12202'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='12203'>
                       comm, IERROR )<a name='12204'>
   VAL_L= nsum<a name='12205'>
#endif<a name='12206'>
<a name='12207'>
   P_u=0.0<a name='12208'>
   P_v=0.0<a name='12209'>
   P_muu=0.0<a name='12210'>
   P_muv=0.0<a name='12211'>
   P_z=0.0<a name='12212'>
   P_z_at_w=0.0<a name='12213'>
   ru_tendf=S_ru_tendf<a name='12214'>
   rv_tendf=S_rv_tendf<a name='12215'>
<a name='12216'>
   call <A href='../../html_code/dyn_em/module_big_step_utilities_em_ad.F.html#A_SURFACE_DRAG'>a_surface_drag</A><A href='../../html_code/dyn_em/module_check.F.html#T_SURFACE_DRAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_SURFACE_DRAG_1">(ru_tendf, P_ru_tendf, rv_tendf, P_rv_tendf, u, P_u, v, P_v, xland, muu, P_muu, muv, P_muv, z, &amp;<a name='12217'>
&amp;P_z, z_at_w, P_z_at_w, ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='12218'>
<a name='12219'>
    VAL_A=0.0<a name='12220'>
    VAL_A= sum(P_ru_tendf*B_ru_tendf) +sum(P_rv_tendf*B_rv_tendf) &amp;<a name='12221'>
          +sum(P_u*B_u) +sum(P_v*B_v) +sum(P_muu*B_muu) +sum(P_muv*B_muv) &amp;<a name='12222'>
          +sum(P_z*B_z) +sum(P_z_at_w*B_z_at_w)<a name='12223'>
<a name='12224'>
#ifdef DM_PARALLEL<a name='12225'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='12226'>
                       comm, IERROR )<a name='12227'>
   VAL_A = nsum<a name='12228'>
#endif<a name='12229'>
<a name='12230'>
   print*, '                '<a name='12231'>
   write(6,*) 'a_surface_drag: '<a name='12232'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='12233'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='12234'>
<a name='12235'>
<font color=#447700>! RECOVER<a name='12236'></font>
<a name='12237'>
   ru_tendf=S_ru_tendf<a name='12238'>
   rv_tendf=S_rv_tendf<a name='12239'>
   u=S_u<a name='12240'>
   v=S_v<a name='12241'>
   muu=S_muu<a name='12242'>
   muv=S_muv<a name='12243'>
   z=S_z<a name='12244'>
   z_at_w=S_z_at_w<a name='12245'>
END SUBROUTINE t_surface_drag<a name='12246'>
<a name='12247'>
<font color=#447700>!=======================================================================================================<a name='12248'></font>
<a name='12249'>
<A NAME='T_LSCOND'><A href='../../html_code/dyn_em/module_check.F.html#T_LSCOND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='12250'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>t_lscond</font>( th_in,p,qv_in,rho,pii,r_v,xlv,cp,EP2,SVP1,SVP2,SVP3,SVPT0,dz8w,RAINNC_in,RAINNCV_in, &amp; <A href='../../call_to/T_LSCOND.html' TARGET='index'>1</A>,<A href='../../call_from/T_LSCOND.html' TARGET='index'>6</A><a name='12251'>
  ids,ide,jds,jde,kds,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte,caller )<a name='12252'>
<a name='12253'>
   USE <A href='../../html_code/phys/module_mp_nconvp.F.html#MODULE_MP_NCONVP'>module_mp_nconvp</A><A href='../../html_code/dyn_em/module_check.F.html#T_LSCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_NCONVP_1">    <a name='12254'>
   IMPLICIT NONE<a name='12255'>
  <a name='12256'>
  <font color=#447700>! Declare dummy arguments<a name='12257'></font>
    INTEGER, INTENT(IN) :: ids<a name='12258'>
    INTEGER, INTENT(IN) :: ide<a name='12259'>
    INTEGER, INTENT(IN) :: jds<a name='12260'>
    INTEGER, INTENT(IN) :: jde<a name='12261'>
    INTEGER, INTENT(IN) :: kds<a name='12262'>
    INTEGER, INTENT(IN) :: kde<a name='12263'>
    INTEGER, INTENT(IN) :: ims<a name='12264'>
    INTEGER, INTENT(IN) :: ime<a name='12265'>
    INTEGER, INTENT(IN) :: jms<a name='12266'>
    INTEGER, INTENT(IN) :: jme<a name='12267'>
    INTEGER, INTENT(IN) :: kms<a name='12268'>
    INTEGER, INTENT(IN) :: kme<a name='12269'>
    INTEGER, INTENT(IN) :: its<a name='12270'>
    INTEGER, INTENT(IN) :: ite<a name='12271'>
    INTEGER, INTENT(IN) :: jts<a name='12272'>
    INTEGER, INTENT(IN) :: jte<a name='12273'>
    INTEGER, INTENT(IN) :: kts<a name='12274'>
    INTEGER, INTENT(IN) :: kte<a name='12275'>
    REAL, INTENT(IN) :: th_in(ims:ime,kms:kme,jms:jme)<a name='12276'>
    REAL, INTENT(IN) :: p(ims:ime,kms:kme,jms:jme)<a name='12277'>
    REAL, INTENT(IN) :: qv_in(ims:ime,kms:kme,jms:jme)<a name='12278'>
    REAL, INTENT(IN) :: rho(ims:ime,kms:kme,jms:jme)<a name='12279'>
    REAL, INTENT(IN) :: pii(ims:ime,kms:kme,jms:jme)<a name='12280'>
    REAL, INTENT(IN) :: r_v<a name='12281'>
    REAL, INTENT(IN) :: xlv<a name='12282'>
    REAL, INTENT(IN) :: cp<a name='12283'>
    REAL, INTENT(IN) :: EP2<a name='12284'>
    REAL, INTENT(IN) :: SVP1<a name='12285'>
    REAL, INTENT(IN) :: SVP2<a name='12286'>
    REAL, INTENT(IN) :: SVP3<a name='12287'>
    REAL, INTENT(IN) :: SVPT0<a name='12288'>
    REAL, INTENT(IN) :: dz8w(ims:ime,kms:kme,jms:jme)<a name='12289'>
    REAL, INTENT(IN) :: RAINNC_in(ims:ime,jms:jme)<a name='12290'>
    REAL, INTENT(IN) :: RAINNCV_in(ims:ime,jms:jme)<a name='12291'>
<a name='12292'>
    CHARACTER*(*), INTENT(IN) :: caller<a name='12293'>
<a name='12294'>
  <font color=#447700>! Declare local variables<a name='12295'></font>
    REAL :: th(ims:ime,kms:kme,jms:jme)<a name='12296'>
    REAL :: qv(ims:ime,kms:kme,jms:jme)<a name='12297'>
    REAL :: RAINNC(ims:ime,jms:jme)<a name='12298'>
    REAL :: RAINNCV(ims:ime,jms:jme)<a name='12299'>
<a name='12300'>
  <font color=#447700>! IN variables<a name='12301'></font>
    REAL :: S_p(ims:ime,kms:kme,jms:jme)<a name='12302'>
    REAL :: P_p(ims:ime,kms:kme,jms:jme)<a name='12303'>
    REAL :: B_p(ims:ime,kms:kme,jms:jme)<a name='12304'>
    REAL :: S_rho(ims:ime,kms:kme,jms:jme)<a name='12305'>
    REAL :: P_rho(ims:ime,kms:kme,jms:jme)<a name='12306'>
    REAL :: B_rho(ims:ime,kms:kme,jms:jme)<a name='12307'>
    REAL :: S_pii(ims:ime,kms:kme,jms:jme)<a name='12308'>
    REAL :: P_pii(ims:ime,kms:kme,jms:jme)<a name='12309'>
    REAL :: B_pii(ims:ime,kms:kme,jms:jme)<a name='12310'>
    REAL :: S_dz8w(ims:ime,kms:kme,jms:jme)<a name='12311'>
    REAL :: P_dz8w(ims:ime,kms:kme,jms:jme)<a name='12312'>
    REAL :: B_dz8w(ims:ime,kms:kme,jms:jme)<a name='12313'>
<a name='12314'>
  <font color=#447700>! INOUT variables<a name='12315'></font>
    REAL :: S_th(ims:ime,kms:kme,jms:jme)<a name='12316'>
    REAL :: P_th(ims:ime,kms:kme,jms:jme)<a name='12317'>
    REAL :: B_th(ims:ime,kms:kme,jms:jme)<a name='12318'>
    REAL :: S_qv(ims:ime,kms:kme,jms:jme)<a name='12319'>
    REAL :: P_qv(ims:ime,kms:kme,jms:jme)<a name='12320'>
    REAL :: B_qv(ims:ime,kms:kme,jms:jme)<a name='12321'>
    REAL :: S_RAINNC(ims:ime,jms:jme)<a name='12322'>
    REAL :: P_RAINNC(ims:ime,jms:jme)<a name='12323'>
    REAL :: B_RAINNC(ims:ime,jms:jme)<a name='12324'>
    REAL :: S_RAINNCV(ims:ime,jms:jme)<a name='12325'>
    REAL :: P_RAINNCV(ims:ime,jms:jme)<a name='12326'>
    REAL :: B_RAINNCV(ims:ime,jms:jme)<a name='12327'>
<a name='12328'>
  <font color=#447700>! OUT variables<a name='12329'></font>
<a name='12330'>
  <font color=#447700>! Other local declarations<a name='12331'></font>
<a name='12332'>
    REAL :: SAVE_L, COEF_TST, ALPHA_TST, FACTOR_TST, VAL_N, VAL_L, VAL_A<a name='12333'>
    INTEGER :: NT<a name='12334'>
    INTEGER :: i, j, k, n, s<a name='12335'>
    INTEGER :: i1, i2, i3, i4, i5, i6, i7<a name='12336'>
<a name='12337'>
  <font color=#447700>! Begin executable code<a name='12338'></font>
<a name='12339'>
  <font color=#447700>! Copy intent(out) and intent(inout) args<a name='12340'></font>
<a name='12341'>
    th = th_in<a name='12342'>
    qv = qv_in<a name='12343'>
    RAINNC = RAINNC_in<a name='12344'>
    RAINNCV = RAINNCV_in<a name='12345'>
<a name='12346'>
<font color=#447700>! TGL test<a name='12347'></font>
<a name='12348'>
    S_p = p<a name='12349'>
    P_p = p<a name='12350'>
    S_rho = rho<a name='12351'>
    P_rho = rho<a name='12352'>
    S_pii = pii<a name='12353'>
    P_pii = pii<a name='12354'>
    S_dz8w = dz8w<a name='12355'>
    P_dz8w = dz8w<a name='12356'>
    S_th = th<a name='12357'>
    P_th = th<a name='12358'>
    S_qv = qv<a name='12359'>
    P_qv = qv<a name='12360'>
    S_RAINNC = RAINNC<a name='12361'>
    P_RAINNC = RAINNC<a name='12362'>
    S_RAINNCV = RAINNCV<a name='12363'>
    P_RAINNCV = RAINNCV<a name='12364'>
<a name='12365'>
<font color=#447700>! NLM<a name='12366'></font>
<a name='12367'>
  CALL <A href='../../html_code/phys/module_mp_nconvp.F.html#LSCOND'>lscond</A><A href='../../html_code/dyn_em/module_check.F.html#T_LSCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LSCOND_1"> ( th,p,qv,rho,pii,r_v,xlv,cp,EP2,SVP1,SVP2,SVP3,SVPT0,dz8w,RAINNC,RAINNCV,ids,ide,jds,jde,kds, &amp;<a name='12368'>
  kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='12369'>
<a name='12370'>
<font color=#447700>!   B_p(its:ite,kts:kte,jts:jte) = p(its:ite,kts:kte,jts:jte)<a name='12371'></font>
<font color=#447700>!   B_rho(its:ite,kts:kte,jts:jte) = rho(its:ite,kts:kte,jts:jte)<a name='12372'></font>
<font color=#447700>!   B_pii(its:ite,kts:kte,jts:jte) = pii(its:ite,kts:kte,jts:jte)<a name='12373'></font>
<font color=#447700>!   B_dz8w(its:ite,kts:kte,jts:jte) = dz8w(its:ite,kts:kte,jts:jte)<a name='12374'></font>
    B_th(its:ite,kts:kte,jts:jte) = th(its:ite,kts:kte,jts:jte)<a name='12375'>
    B_qv(its:ite,kts:kte,jts:jte) = qv(its:ite,kts:kte,jts:jte)<a name='12376'>
    B_RAINNC(its:ite,jts:jte) = RAINNC(its:ite,jts:jte)<a name='12377'>
    B_RAINNCV(its:ite,jts:jte) = RAINNCV(its:ite,jts:jte)<a name='12378'>
<a name='12379'>
<font color=#447700>! TL<a name='12380'></font>
<a name='12381'>
    th = S_th<a name='12382'>
    qv = S_qv<a name='12383'>
    RAINNC = S_RAINNC<a name='12384'>
    RAINNCV = S_RAINNCV<a name='12385'>
  CALL <A href='../../html_code/phys/module_mp_nconvp.F.html#G_LSCOND'>g_lscond</A><A href='../../html_code/dyn_em/module_check.F.html#T_LSCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_LSCOND_1"> ( th,P_th,p,P_p,qv,P_qv,rho,P_rho,pii,P_pii,r_v,xlv,cp,ep2,svp1,svp2,svp3,svpt0,dz8w,P_dz8w, &amp;<a name='12386'>
  rainnc,P_rainnc,rainncv,P_rainncv,ids,ide,jds,jde,kds,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte  &amp;<a name='12387'>
  )<a name='12388'>
<a name='12389'>
    SAVE_L=0.<a name='12390'>
    DO j = jts,jte<a name='12391'>
    DO k = kts,kte<a name='12392'>
    DO i = its,ite<a name='12393'>
      SAVE_L = SAVE_L + (P_th(i,k,j) * P_th(i,k,j))<a name='12394'>
    ENDDO<a name='12395'>
    ENDDO<a name='12396'>
    ENDDO<a name='12397'>
<font color=#447700>!   DO j = jts,jte<a name='12398'></font>
<font color=#447700>!   DO k = kts,kte<a name='12399'></font>
<font color=#447700>!   DO i = its,ite<a name='12400'></font>
<font color=#447700>!     SAVE_L = SAVE_L + (P_p(i,k,j) * P_p(i,k,j))<a name='12401'></font>
<font color=#447700>!   ENDDO<a name='12402'></font>
<font color=#447700>!   ENDDO<a name='12403'></font>
<font color=#447700>!   ENDDO<a name='12404'></font>
    DO j = jts,jte<a name='12405'>
    DO k = kts,kte<a name='12406'>
    DO i = its,ite<a name='12407'>
      SAVE_L = SAVE_L + (P_qv(i,k,j) * P_qv(i,k,j))<a name='12408'>
    ENDDO<a name='12409'>
    ENDDO<a name='12410'>
    ENDDO<a name='12411'>
<font color=#447700>!   DO j = jts,jte<a name='12412'></font>
<font color=#447700>!   DO k = kts,kte<a name='12413'></font>
<font color=#447700>!   DO i = its,ite<a name='12414'></font>
<font color=#447700>!     SAVE_L = SAVE_L + (P_rho(i,k,j) * P_rho(i,k,j))<a name='12415'></font>
<font color=#447700>!   ENDDO<a name='12416'></font>
<font color=#447700>!   ENDDO<a name='12417'></font>
<font color=#447700>!   ENDDO<a name='12418'></font>
<font color=#447700>!   DO j = jts,jte<a name='12419'></font>
<font color=#447700>!   DO k = kts,kte<a name='12420'></font>
<font color=#447700>!   DO i = its,ite<a name='12421'></font>
<font color=#447700>!     SAVE_L = SAVE_L + (P_pii(i,k,j) * P_pii(i,k,j))<a name='12422'></font>
<font color=#447700>!   ENDDO<a name='12423'></font>
<font color=#447700>!   ENDDO<a name='12424'></font>
<font color=#447700>!   ENDDO<a name='12425'></font>
<font color=#447700>!   DO j = jts,jte<a name='12426'></font>
<font color=#447700>!   DO k = kts,kte<a name='12427'></font>
<font color=#447700>!   DO i = its,ite<a name='12428'></font>
<font color=#447700>!     SAVE_L = SAVE_L + (P_dz8w(i,k,j) * P_dz8w(i,k,j))<a name='12429'></font>
<font color=#447700>!   ENDDO<a name='12430'></font>
<font color=#447700>!   ENDDO<a name='12431'></font>
<font color=#447700>!   ENDDO<a name='12432'></font>
    DO j = jts,jte<a name='12433'>
    DO i = its,ite<a name='12434'>
      SAVE_L = SAVE_L + (P_rainnc(i,j) * P_rainnc(i,j))<a name='12435'>
    ENDDO<a name='12436'>
    ENDDO<a name='12437'>
    DO j = jts,jte<a name='12438'>
    DO i = its,ite<a name='12439'>
      SAVE_L = SAVE_L + (P_rainncv(i,j) * P_rainncv(i,j))<a name='12440'>
    ENDDO<a name='12441'>
    ENDDO<a name='12442'>
<a name='12443'>
#ifdef DM_PARALLEL<a name='12444'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='12445'>
                       comm, IERROR )<a name='12446'>
   SAVE_L = nsum<a name='12447'>
#endif<a name='12448'>
<a name='12449'>
    ALPHA_TST=1.<a name='12450'>
    DO NT=1,11<a name='12451'>
      ALPHA_TST=0.1*ALPHA_TST<a name='12452'>
      FACTOR_TST=1.+ALPHA_TST<a name='12453'>
    DO j = jts,jte<a name='12454'>
    DO k = kts,kte<a name='12455'>
    DO i = its,ite<a name='12456'>
      P_th(i,k,j) = FACTOR_TST * S_th(i,k,j)<a name='12457'>
    ENDDO<a name='12458'>
    ENDDO<a name='12459'>
    ENDDO<a name='12460'>
    DO j = jts,jte<a name='12461'>
    DO k = kts,kte<a name='12462'>
    DO i = its,ite<a name='12463'>
      P_p(i,k,j) = FACTOR_TST * S_p(i,k,j)<a name='12464'>
    ENDDO<a name='12465'>
    ENDDO<a name='12466'>
    ENDDO<a name='12467'>
    DO j = jts,jte<a name='12468'>
    DO k = kts,kte<a name='12469'>
    DO i = its,ite<a name='12470'>
      P_qv(i,k,j) = FACTOR_TST * S_qv(i,k,j)<a name='12471'>
    ENDDO<a name='12472'>
    ENDDO<a name='12473'>
    ENDDO<a name='12474'>
    DO j = jts,jte<a name='12475'>
    DO k = kts,kte<a name='12476'>
    DO i = its,ite<a name='12477'>
      P_rho(i,k,j) = FACTOR_TST * S_rho(i,k,j)<a name='12478'>
    ENDDO<a name='12479'>
    ENDDO<a name='12480'>
    ENDDO<a name='12481'>
    DO j = jts,jte<a name='12482'>
    DO k = kts,kte<a name='12483'>
    DO i = its,ite<a name='12484'>
      P_pii(i,k,j) = FACTOR_TST * S_pii(i,k,j)<a name='12485'>
    ENDDO<a name='12486'>
    ENDDO<a name='12487'>
    ENDDO<a name='12488'>
    DO j = jts,jte<a name='12489'>
    DO k = kts,kte<a name='12490'>
    DO i = its,ite<a name='12491'>
      P_dz8w(i,k,j) = FACTOR_TST * S_dz8w(i,k,j)<a name='12492'>
    ENDDO<a name='12493'>
    ENDDO<a name='12494'>
    ENDDO<a name='12495'>
    DO j = jts,jte<a name='12496'>
    DO i = its,ite<a name='12497'>
      P_rainnc(i,j) = FACTOR_TST * S_rainnc(i,j)<a name='12498'>
    ENDDO<a name='12499'>
    ENDDO<a name='12500'>
    DO j = jts,jte<a name='12501'>
    DO i = its,ite<a name='12502'>
      P_rainncv(i,j) = FACTOR_TST * S_rainncv(i,j)<a name='12503'>
    ENDDO<a name='12504'>
    ENDDO<a name='12505'>
<a name='12506'>
  CALL <A href='../../html_code/phys/module_mp_nconvp.F.html#LSCOND'>lscond</A><A href='../../html_code/dyn_em/module_check.F.html#T_LSCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LSCOND_2"> ( P_th,P_p,P_qv,P_rho,P_pii,r_v,xlv,cp,EP2,SVP1,SVP2,SVP3,SVPT0,P_dz8w,P_RAINNC,P_RAINNCV,ids,ide, &amp;<a name='12507'>
  jds,jde,kds,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte )<a name='12508'>
<a name='12509'>
    VAL_N=0.<a name='12510'>
    DO j = jts,jte<a name='12511'>
    DO k = kts,kte<a name='12512'>
    DO i = its,ite<a name='12513'>
      VAL_N = VAL_N + ((P_th(i,k,j) - B_th(i,k,j)) * (P_th(i,k,j) - B_th(i,k,j)))<a name='12514'>
    ENDDO<a name='12515'>
    ENDDO<a name='12516'>
    ENDDO<a name='12517'>
<font color=#447700>!   DO j = jts,jte<a name='12518'></font>
<font color=#447700>!   DO k = kts,kte<a name='12519'></font>
<font color=#447700>!   DO i = its,ite<a name='12520'></font>
<font color=#447700>!     VAL_N = VAL_N + ((P_p(i,k,j) - B_p(i,k,j)) * (P_p(i,k,j) - B_p(i,k,j)))<a name='12521'></font>
<font color=#447700>!   ENDDO<a name='12522'></font>
<font color=#447700>!   ENDDO<a name='12523'></font>
<font color=#447700>!   ENDDO<a name='12524'></font>
    DO j = jts,jte<a name='12525'>
    DO k = kts,kte<a name='12526'>
    DO i = its,ite<a name='12527'>
      VAL_N = VAL_N + ((P_qv(i,k,j) - B_qv(i,k,j)) * (P_qv(i,k,j) - B_qv(i,k,j)))<a name='12528'>
    ENDDO<a name='12529'>
    ENDDO<a name='12530'>
    ENDDO<a name='12531'>
<font color=#447700>!   DO j = jts,jte<a name='12532'></font>
<font color=#447700>!   DO k = kts,kte<a name='12533'></font>
<font color=#447700>!   DO i = its,ite<a name='12534'></font>
<font color=#447700>!     VAL_N = VAL_N + ((P_rho(i,k,j) - B_rho(i,k,j)) * (P_rho(i,k,j) - B_rho(i,k,j)))<a name='12535'></font>
<font color=#447700>!   ENDDO<a name='12536'></font>
<font color=#447700>!   ENDDO<a name='12537'></font>
<font color=#447700>!   ENDDO<a name='12538'></font>
<font color=#447700>!   DO j = jts,jte<a name='12539'></font>
<font color=#447700>!   DO k = kts,kte<a name='12540'></font>
<font color=#447700>!   DO i = its,ite<a name='12541'></font>
<font color=#447700>!     VAL_N = VAL_N + ((P_pii(i,k,j) - B_pii(i,k,j)) * (P_pii(i,k,j) - B_pii(i,k,j)))<a name='12542'></font>
<font color=#447700>!   ENDDO<a name='12543'></font>
<font color=#447700>!   ENDDO<a name='12544'></font>
<font color=#447700>!   ENDDO<a name='12545'></font>
<font color=#447700>!   DO j = jts,jte<a name='12546'></font>
<font color=#447700>!   DO k = kts,kte<a name='12547'></font>
<font color=#447700>!   DO i = its,ite<a name='12548'></font>
<font color=#447700>!     VAL_N = VAL_N + ((P_dz8w(i,k,j) - B_dz8w(i,k,j)) * (P_dz8w(i,k,j) - B_dz8w(i,k,j)))<a name='12549'></font>
<font color=#447700>!   ENDDO<a name='12550'></font>
<font color=#447700>!   ENDDO<a name='12551'></font>
<font color=#447700>!   ENDDO<a name='12552'></font>
    DO j = jts,jte<a name='12553'>
    DO i = its,ite<a name='12554'>
      VAL_N = VAL_N + ((P_rainnc(i,j) - B_rainnc(i,j)) * (P_rainnc(i,j) - B_rainnc(i,j)))<a name='12555'>
    ENDDO<a name='12556'>
    ENDDO<a name='12557'>
    DO j = jts,jte<a name='12558'>
    DO i = its,ite<a name='12559'>
      VAL_N = VAL_N + ((P_rainncv(i,j) - B_rainncv(i,j)) * (P_rainncv(i,j) - B_rainncv(i,j)))<a name='12560'>
    ENDDO<a name='12561'>
    ENDDO<a name='12562'>
<a name='12563'>
#ifdef DM_PARALLEL<a name='12564'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='12565'>
                       comm, IERROR )<a name='12566'>
   VAL_N = nsum<a name='12567'>
#endif<a name='12568'>
<a name='12569'>
      VAL_L=SAVE_L*ALPHA_TST**2<a name='12570'>
      IF (VAL_N .EQ. VAL_L) THEN<a name='12571'>
        COEF_TST=1.0   <font color=#447700>! handle case where VAL_N==VAL_L==0.0<a name='12572'></font>
      ELSE<a name='12573'>
        COEF_TST=VAL_N/VAL_L<a name='12574'>
      ENDIF<a name='12575'>
      WRITE(6, fmt='(3A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='12576'>
         'lscond_tl from ',TRIM(caller),': ALPHA=',ALPHA_TST,'  COEF=',COEF_TST, &amp;<a name='12577'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='12578'>
    ENDDO<a name='12579'>
<a name='12580'>
<font color=#447700>! ADJ test<a name='12581'></font>
<a name='12582'>
  FACTOR_TST = 0.1<a name='12583'>
    DO j = jts,jte<a name='12584'>
    DO k = kts,kte<a name='12585'>
    DO i = its,ite<a name='12586'>
      th(i,k,j)=S_th(i,k,j)<a name='12587'>
      P_th(i,k,j)=FACTOR_TST*S_th(i,k,j)<a name='12588'>
      B_th(i,k,j)=P_th(i,k,j)<a name='12589'>
    ENDDO<a name='12590'>
    ENDDO<a name='12591'>
    ENDDO<a name='12592'>
    DO j = jts,jte<a name='12593'>
    DO k = kts,kte<a name='12594'>
    DO i = its,ite<a name='12595'>
      P_p(i,k,j)=FACTOR_TST*S_p(i,k,j)<a name='12596'>
      B_p(i,k,j)=P_p(i,k,j)<a name='12597'>
    ENDDO<a name='12598'>
    ENDDO<a name='12599'>
    ENDDO<a name='12600'>
    DO j = jts,jte<a name='12601'>
    DO k = kts,kte<a name='12602'>
    DO i = its,ite<a name='12603'>
      qv(i,k,j)=S_qv(i,k,j)<a name='12604'>
      P_qv(i,k,j)=FACTOR_TST*S_qv(i,k,j)<a name='12605'>
      B_qv(i,k,j)=P_qv(i,k,j)<a name='12606'>
    ENDDO<a name='12607'>
    ENDDO<a name='12608'>
    ENDDO<a name='12609'>
    DO j = jts,jte<a name='12610'>
    DO k = kts,kte<a name='12611'>
    DO i = its,ite<a name='12612'>
      P_rho(i,k,j)=FACTOR_TST*S_rho(i,k,j)<a name='12613'>
      B_rho(i,k,j)=P_rho(i,k,j)<a name='12614'>
    ENDDO<a name='12615'>
    ENDDO<a name='12616'>
    ENDDO<a name='12617'>
    DO j = jts,jte<a name='12618'>
    DO k = kts,kte<a name='12619'>
    DO i = its,ite<a name='12620'>
      P_pii(i,k,j)=FACTOR_TST*S_pii(i,k,j)<a name='12621'>
      B_pii(i,k,j)=P_pii(i,k,j)<a name='12622'>
    ENDDO<a name='12623'>
    ENDDO<a name='12624'>
    ENDDO<a name='12625'>
    DO j = jts,jte<a name='12626'>
    DO k = kts,kte<a name='12627'>
    DO i = its,ite<a name='12628'>
      P_dz8w(i,k,j)=FACTOR_TST*S_dz8w(i,k,j)<a name='12629'>
      B_dz8w(i,k,j)=P_dz8w(i,k,j)<a name='12630'>
    ENDDO<a name='12631'>
    ENDDO<a name='12632'>
    ENDDO<a name='12633'>
    DO j = jts,jte<a name='12634'>
    DO i = its,ite<a name='12635'>
      rainnc(i,j)=S_rainnc(i,j)<a name='12636'>
      P_rainnc(i,j)=FACTOR_TST*S_rainnc(i,j)<a name='12637'>
      B_rainnc(i,j)=P_rainnc(i,j)<a name='12638'>
    ENDDO<a name='12639'>
    ENDDO<a name='12640'>
    DO j = jts,jte<a name='12641'>
    DO i = its,ite<a name='12642'>
      rainncv(i,j)=S_rainncv(i,j)<a name='12643'>
      P_rainncv(i,j)=FACTOR_TST*S_rainncv(i,j)<a name='12644'>
      B_rainncv(i,j)=P_rainncv(i,j)<a name='12645'>
    ENDDO<a name='12646'>
    ENDDO<a name='12647'>
<font color=#447700>! TL<a name='12648'></font>
<a name='12649'>
  CALL <A href='../../html_code/phys/module_mp_nconvp.F.html#G_LSCOND'>g_lscond</A><A href='../../html_code/dyn_em/module_check.F.html#T_LSCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_LSCOND_2"> ( th,P_th,p,P_p,qv,P_qv,rho,P_rho,pii,P_pii,r_v,xlv,cp,ep2,svp1,svp2,svp3,svpt0,dz8w,P_dz8w, &amp;<a name='12650'>
  rainnc,P_rainnc,rainncv,P_rainncv,ids,ide,jds,jde,kds,kde,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte  &amp;<a name='12651'>
  )<a name='12652'>
<a name='12653'>
    VAL_L=0.<a name='12654'>
    DO j = jts,jte<a name='12655'>
    DO k = kts,kte<a name='12656'>
    DO i = its,ite<a name='12657'>
      VAL_L = VAL_L + (P_th(i,k,j) * P_th(i,k,j))<a name='12658'>
    ENDDO<a name='12659'>
    ENDDO<a name='12660'>
    ENDDO<a name='12661'>
    DO j = jts,jte<a name='12662'>
    DO k = kts,kte<a name='12663'>
    DO i = its,ite<a name='12664'>
      VAL_L = VAL_L + (P_p(i,k,j) * P_p(i,k,j))<a name='12665'>
    ENDDO<a name='12666'>
    ENDDO<a name='12667'>
    ENDDO<a name='12668'>
    DO j = jts,jte<a name='12669'>
    DO k = kts,kte<a name='12670'>
    DO i = its,ite<a name='12671'>
      VAL_L = VAL_L + (P_qv(i,k,j) * P_qv(i,k,j))<a name='12672'>
    ENDDO<a name='12673'>
    ENDDO<a name='12674'>
    ENDDO<a name='12675'>
    DO j = jts,jte<a name='12676'>
    DO k = kts,kte<a name='12677'>
    DO i = its,ite<a name='12678'>
      VAL_L = VAL_L + (P_rho(i,k,j) * P_rho(i,k,j))<a name='12679'>
    ENDDO<a name='12680'>
    ENDDO<a name='12681'>
    ENDDO<a name='12682'>
    DO j = jts,jte<a name='12683'>
    DO k = kts,kte<a name='12684'>
    DO i = its,ite<a name='12685'>
      VAL_L = VAL_L + (P_pii(i,k,j) * P_pii(i,k,j))<a name='12686'>
    ENDDO<a name='12687'>
    ENDDO<a name='12688'>
    ENDDO<a name='12689'>
    DO j = jts,jte<a name='12690'>
    DO k = kts,kte<a name='12691'>
    DO i = its,ite<a name='12692'>
      VAL_L = VAL_L + (P_dz8w(i,k,j) * P_dz8w(i,k,j))<a name='12693'>
    ENDDO<a name='12694'>
    ENDDO<a name='12695'>
    ENDDO<a name='12696'>
    DO j = jts,jte<a name='12697'>
    DO i = its,ite<a name='12698'>
      VAL_L = VAL_L + (P_rainnc(i,j) * P_rainnc(i,j))<a name='12699'>
    ENDDO<a name='12700'>
    ENDDO<a name='12701'>
    DO j = jts,jte<a name='12702'>
    DO i = its,ite<a name='12703'>
      VAL_L = VAL_L + (P_rainncv(i,j) * P_rainncv(i,j))<a name='12704'>
    ENDDO<a name='12705'>
    ENDDO<a name='12706'>
<a name='12707'>
#ifdef DM_PARALLEL<a name='12708'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='12709'>
                       comm, IERROR )<a name='12710'>
   VAL_L = nsum<a name='12711'>
#endif<a name='12712'>
<a name='12713'>
    DO j = jts,jte<a name='12714'>
    DO k = kts,kte<a name='12715'>
    DO i = its,ite<a name='12716'>
      th(i,k,j)=S_th(i,k,j)<a name='12717'>
      qv(i,k,j)=S_qv(i,k,j)<a name='12718'>
    ENDDO<a name='12719'>
    ENDDO<a name='12720'>
    ENDDO<a name='12721'>
    DO j = jts,jte<a name='12722'>
    DO i = its,ite<a name='12723'>
      rainnc(i,j)=S_rainnc(i,j)<a name='12724'>
      rainncv(i,j)=S_rainncv(i,j)<a name='12725'>
    ENDDO<a name='12726'>
    ENDDO<a name='12727'>
<a name='12728'>
<a name='12729'>
<font color=#447700>! ADJ<a name='12730'></font>
<a name='12731'>
  CALL <A href='../../html_code/phys/module_mp_nconvp.F.html#A_LSCOND'>a_lscond</A><A href='../../html_code/dyn_em/module_check.F.html#T_LSCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_LSCOND_1"> ( th,P_th,p,P_p,qv,P_qv,rho,P_rho,pii,P_pii,r_v,xlv,cp,ep2,svp1,svp2,svp3,svpt0,dz8w,P_dz8w, &amp;<a name='12732'>
  rainnc,P_rainnc,rainncv,P_rainncv,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kte )<a name='12733'>
<a name='12734'>
    VAL_A=0.<a name='12735'>
    DO j = jts,jte<a name='12736'>
    DO k = kts,kte<a name='12737'>
    DO i = its,ite<a name='12738'>
      VAL_A = VAL_A + (P_th(i,k,j) * B_th(i,k,j))<a name='12739'>
    ENDDO<a name='12740'>
    ENDDO<a name='12741'>
    ENDDO<a name='12742'>
    DO j = jts,jte<a name='12743'>
    DO k = kts,kte<a name='12744'>
    DO i = its,ite<a name='12745'>
      VAL_A = VAL_A + (P_p(i,k,j) * B_p(i,k,j))<a name='12746'>
    ENDDO<a name='12747'>
    ENDDO<a name='12748'>
    ENDDO<a name='12749'>
    DO j = jts,jte<a name='12750'>
    DO k = kts,kte<a name='12751'>
    DO i = its,ite<a name='12752'>
      VAL_A = VAL_A + (P_qv(i,k,j) * B_qv(i,k,j))<a name='12753'>
    ENDDO<a name='12754'>
    ENDDO<a name='12755'>
    ENDDO<a name='12756'>
    DO j = jts,jte<a name='12757'>
    DO k = kts,kte<a name='12758'>
    DO i = its,ite<a name='12759'>
      VAL_A = VAL_A + (P_rho(i,k,j) * B_rho(i,k,j))<a name='12760'>
    ENDDO<a name='12761'>
    ENDDO<a name='12762'>
    ENDDO<a name='12763'>
    DO j = jts,jte<a name='12764'>
    DO k = kts,kte<a name='12765'>
    DO i = its,ite<a name='12766'>
      VAL_A = VAL_A + (P_pii(i,k,j) * B_pii(i,k,j))<a name='12767'>
    ENDDO<a name='12768'>
    ENDDO<a name='12769'>
    ENDDO<a name='12770'>
    DO j = jts,jte<a name='12771'>
    DO k = kts,kte<a name='12772'>
    DO i = its,ite<a name='12773'>
      VAL_A = VAL_A + (P_dz8w(i,k,j) * B_dz8w(i,k,j))<a name='12774'>
    ENDDO<a name='12775'>
    ENDDO<a name='12776'>
    ENDDO<a name='12777'>
    DO j = jts,jte<a name='12778'>
    DO i = its,ite<a name='12779'>
      VAL_A = VAL_A + (P_rainnc(i,j) * B_rainnc(i,j))<a name='12780'>
    ENDDO<a name='12781'>
    ENDDO<a name='12782'>
    DO j = jts,jte<a name='12783'>
    DO i = its,ite<a name='12784'>
      VAL_A = VAL_A + (P_rainncv(i,j) * B_rainncv(i,j))<a name='12785'>
    ENDDO<a name='12786'>
    ENDDO<a name='12787'>
<a name='12788'>
#ifdef DM_PARALLEL<a name='12789'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='12790'>
                       comm, IERROR )<a name='12791'>
   VAL_A = nsum<a name='12792'>
#endif<a name='12793'>
<a name='12794'>
   WRITE(6,FMT='(3A,E22.13)') 'lscond_ad from ',TRIM(caller),' VAL_TL: ', VAL_L<a name='12795'>
   WRITE(6,FMT='(3A,E22.13)') 'lscond_ad from ',TRIM(caller),' VAL_AD: ', VAL_A<a name='12796'>
<a name='12797'>
  END SUBROUTINE t_lscond<a name='12798'>
<a name='12799'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='12800'></font>
<A NAME='T_MOIST_PHYSICS_PREP_EM'><A href='../../html_code/dyn_em/module_check.F.html#T_MOIST_PHYSICS_PREP_EM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='12801'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>t_moist_physics_prep_em</font>( t_new, t_old, t0, rho, al, alb, &amp; <A href='../../call_to/T_MOIST_PHYSICS_PREP_EM.html' TARGET='index'>1</A>,<A href='../../call_from/T_MOIST_PHYSICS_PREP_EM.html' TARGET='index'>5</A><a name='12802'>
                                     p, p8w, p0, pb, ph, phb, pii, pf,    &amp;<a name='12803'>
                                     z, z_at_w, dz8w,                &amp;<a name='12804'>
                                     dt,h_diabatic,                  &amp;<a name='12805'>
                                     config_flags,fzm, fzp,          &amp;<a name='12806'>
                                     ids,ide, jds,jde, kds,kde,      &amp;<a name='12807'>
                                     ims,ime, jms,jme, kms,kme,      &amp;<a name='12808'>
                                     its,ite, jts,jte, kts,kte      )<a name='12809'>
<a name='12810'>
   IMPLICIT NONE<a name='12811'>
<a name='12812'>
<font color=#447700>! Here we construct full fields<a name='12813'></font>
<a name='12814'>
   TYPE(grid_config_rec_type),    INTENT(IN   )    :: config_flags<a name='12815'>
<a name='12816'>
   INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='12817'>
   INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='12818'>
   INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='12819'>
<a name='12820'>
   REAL, INTENT(IN   )  ::  dt<a name='12821'>
<a name='12822'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ) :: al,  &amp;<a name='12823'>
                                                    alb, &amp;<a name='12824'>
                                                    p,   &amp;<a name='12825'>
                                                    pb,  &amp;<a name='12826'>
                                                    ph,  &amp;<a name='12827'>
                                                    phb<a name='12828'>
<a name='12829'>
<a name='12830'>
   REAL , DIMENSION( kms:kme )                  ::   fzm, &amp;<a name='12831'>
                                                              fzp<a name='12832'>
<a name='12833'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme )::rho,  &amp;<a name='12834'>
                                                  pii,  &amp;<a name='12835'>
                                                  pf,   &amp;<a name='12836'>
                                                    z,  &amp;<a name='12837'>
                                               z_at_w,  &amp;<a name='12838'>
                                                 dz8w,  &amp;<a name='12839'>
                                                  p8w<a name='12840'>
<font color=#447700>! pjj/cray<a name='12841'></font>
<font color=#447700>!                                                 p8w,  &amp;<a name='12842'></font>
<font color=#447700>!                                          h_diabatic<a name='12843'></font>
<a name='12844'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),       &amp;<a name='12845'>
         INTENT(INOUT) ::                         h_diabatic<a name='12846'>
<a name='12847'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),        &amp;<a name='12848'>
         INTENT(INOUT) ::                         t_new, &amp;<a name='12849'>
                                                  t_old<a name='12850'>
<a name='12851'>
   REAL, INTENT(IN   ) :: t0, p0<a name='12852'>
   REAL                :: z0,z1,z2,w1,w2<a name='12853'>
<a name='12854'>
   INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='12855'>
   INTEGER :: i, j, k<a name='12856'>
<a name='12857'>
<font color=#447700>!  IN variables<a name='12858'></font>
   REAL,  DIMENSION(ims:ime,kms:kme,jms:jme) ::   S_al, S_p, S_ph<a name='12859'>
   REAL,  DIMENSION(ims:ime,kms:kme,jms:jme) ::   P_al, P_p, P_ph<a name='12860'>
   REAL,  DIMENSION(ims:ime,kms:kme,jms:jme) ::   B_al, B_p, B_ph<a name='12861'>
<a name='12862'>
<a name='12863'>
<font color=#447700>!  OUT variables<a name='12864'></font>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ) :: P_rho, P_pii, P_pf, P_z, P_z_at_w, P_dz8w, P_p8w<a name='12865'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ) :: B_rho, B_pii, B_pf, B_z, B_z_at_w, B_dz8w, B_p8w<a name='12866'>
<a name='12867'>
<font color=#447700>! INOUT variables<a name='12868'></font>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme )  ::  S_h_diabatic, S_t_new, S_t_old<a name='12869'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme )  ::  P_h_diabatic, P_t_new, P_t_old<a name='12870'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme )  ::  B_h_diabatic, B_t_new, B_t_old<a name='12871'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme )  ::  K_h_diabatic, K_t_new, K_t_old<a name='12872'>
<a name='12873'>
<a name='12874'>
   REAL :: SAVE_L, COEF, ALPHA_TST, FACTOR, VAL_N, VAL_L, VAL_A<a name='12875'>
   INTEGER :: NT,h<a name='12876'>
<a name='12877'>
    i_start = its<a name='12878'>
    i_end   = min( ite,ide-1 )<a name='12879'>
    j_start = jts<a name='12880'>
    j_end   = min( jte,jde-1 )<a name='12881'>
<a name='12882'>
    k_start = kts<a name='12883'>
    k_end = min( kte, kde-1 )<a name='12884'>
<a name='12885'>
 S_al  =al<a name='12886'>
 S_p   =p<a name='12887'>
 S_ph  =ph<a name='12888'>
<a name='12889'>
 P_al  =al<a name='12890'>
 P_p   =p<a name='12891'>
 P_ph  =ph<a name='12892'>
<a name='12893'>
 S_h_diabatic =h_diabatic<a name='12894'>
 S_t_new =t_new<a name='12895'>
 S_t_old =t_old<a name='12896'>
<a name='12897'>
 P_h_diabatic =h_diabatic<a name='12898'>
 P_t_new =t_new<a name='12899'>
 P_t_old =t_old<a name='12900'>
<a name='12901'>
 K_h_diabatic =h_diabatic<a name='12902'>
 K_t_new =t_new<a name='12903'>
 K_t_old =t_old<a name='12904'>
<a name='12905'>
<font color=#447700>!  NLM<a name='12906'></font>
<a name='12907'>
    CALL  <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_PREP_EM'>moist_physics_prep_em</A><A href='../../html_code/dyn_em/module_check.F.html#T_MOIST_PHYSICS_PREP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOIST_PHYSICS_PREP_EM_1">( t_new, t_old, t0, rho, al, alb, &amp;<a name='12908'>
                                      p, p8w, p0, pb, ph, phb, pii, pf,    &amp;<a name='12909'>
                                      z, z_at_w, dz8w,                &amp;<a name='12910'>
                                      dt,h_diabatic,                  &amp;<a name='12911'>
                                      config_flags,fzm, fzp,          &amp;<a name='12912'>
                                      ids,ide, jds,jde, kds,kde,      &amp;<a name='12913'>
                                      ims,ime, jms,jme, kms,kme,      &amp;<a name='12914'>
                                      its,ite, jts,jte, kts,kte      )<a name='12915'>
<a name='12916'>
 B_rho =rho<a name='12917'>
 B_pii =pii<a name='12918'>
 B_pf  =pf<a name='12919'>
 B_z   =z<a name='12920'>
 B_z_at_w =z_at_w<a name='12921'>
 B_dz8w   =dz8w<a name='12922'>
<a name='12923'>
 B_h_diabatic =h_diabatic<a name='12924'>
 B_t_new =t_new<a name='12925'>
 B_t_old =t_old<a name='12926'>
<a name='12927'>
  CALL  <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_MOIST_PHYSICS_PREP_EM'>g_moist_physics_prep_em</A><A href='../../html_code/dyn_em/module_check.F.html#T_MOIST_PHYSICS_PREP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_MOIST_PHYSICS_PREP_EM_1">( K_t_new, P_t_new, K_t_old, P_t_old, t0, rho, P_rho, al, P_al, alb, p, P_p, p8w, P_p8w, p0, &amp;<a name='12928'>
&amp;pb, ph, P_ph, phb, pii, P_pii, pf, P_pf, z, P_z, z_at_w, P_z_at_w, dz8w, P_dz8w, dt, K_h_diabatic, P_h_diabatic, &amp;<a name='12929'>
&amp;config_flags, fzm, fzp, ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='12930'>
<a name='12931'>
     SAVE_L=0.<a name='12932'>
     DO j = j_start, j_end<a name='12933'>
     DO k = k_start, kte<a name='12934'>
     DO i = i_start, i_end<a name='12935'>
       SAVE_L=SAVE_L+P_rho(i,k,j)**2+P_pii(i,k,j)**2+P_pf(i,k,j)**2+P_z(i,k,j)**2+  &amp;<a name='12936'>
              P_z_at_w(i,k,j)**2+P_dz8w(i,k,j)**2+P_t_new(i,k,j)**2+P_t_old(i,k,j)**2<a name='12937'>
     ENDDO<a name='12938'>
     ENDDO<a name='12939'>
     ENDDO<a name='12940'>
<a name='12941'>
#ifdef DM_PARALLEL<a name='12942'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='12943'>
                       comm, IERROR )<a name='12944'>
   SAVE_L = nsum<a name='12945'>
#endif<a name='12946'>
<a name='12947'>
   ALPHA_TST=1.<a name='12948'>
   DO NT=1,11<a name='12949'>
      ALPHA_TST=0.1*ALPHA_TST<a name='12950'>
      FACTOR=1.+ALPHA_TST<a name='12951'>
      P_al  =FACTOR*S_al<a name='12952'>
      P_p   =FACTOR*S_p<a name='12953'>
      P_ph  =FACTOR*S_ph<a name='12954'>
<a name='12955'>
      P_h_diabatic =FACTOR*S_h_diabatic<a name='12956'>
      P_t_new =FACTOR*S_t_new<a name='12957'>
      P_t_old =FACTOR*S_t_old<a name='12958'>
<a name='12959'>
   CALL  <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_PREP_EM'>moist_physics_prep_em</A><A href='../../html_code/dyn_em/module_check.F.html#T_MOIST_PHYSICS_PREP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOIST_PHYSICS_PREP_EM_2">( P_t_new, P_t_old, t0, P_rho, P_al, alb, &amp;<a name='12960'>
                                     P_p, P_p8w, p0, pb, P_ph, phb, P_pii, P_pf,    &amp;<a name='12961'>
                                     P_z, P_z_at_w, P_dz8w,                &amp;<a name='12962'>
                                     dt,P_h_diabatic,                  &amp;<a name='12963'>
                                     config_flags,fzm, fzp,          &amp;<a name='12964'>
                                     ids,ide, jds,jde, kds,kde,      &amp;<a name='12965'>
                                     ims,ime, jms,jme, kms,kme,      &amp;<a name='12966'>
                                     its,ite, jts,jte, kts,kte      )<a name='12967'>
<a name='12968'>
     VAL_N=0.<a name='12969'>
     DO j = j_start, j_end<a name='12970'>
     DO k = k_start, kte<a name='12971'>
     DO i = i_start, i_end<a name='12972'>
       VAL_N=VAL_N+(P_rho(i,k,j)-B_rho(i,k,j))**2+(P_pii(i,k,j)-B_pii(i,k,j))**2+(P_pf(i,k,j)-B_pf(i,k,j))**2+  &amp;<a name='12973'>
             (P_z(i,k,j)-B_z(i,k,j))**2+(P_z_at_w(i,k,j)-B_z_at_w(i,k,j))**2+(P_dz8w(i,k,j)-B_dz8w(i,k,j))**2+  &amp;<a name='12974'>
             (P_h_diabatic(i,k,j)-B_h_diabatic(i,k,j))**2+(P_t_new(i,k,j) -B_t_new(i,k,j))**2+  &amp;<a name='12975'>
             (P_t_old(i,k,j)-B_t_old(i,k,j))**2<a name='12976'>
     ENDDO<a name='12977'>
     ENDDO<a name='12978'>
     ENDDO<a name='12979'>
<a name='12980'>
#ifdef DM_PARALLEL<a name='12981'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='12982'>
                       comm, IERROR )<a name='12983'>
   VAL_N = nsum<a name='12984'>
#endif<a name='12985'>
<a name='12986'>
      VAL_L=SAVE_L*ALPHA_TST**2<a name='12987'>
      COEF=VAL_N/VAL_L<a name='12988'>
<a name='12989'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='12990'>
         'g_prep_em: ALPHA=',ALPHA_TST,'  COEF=',COEF, &amp;<a name='12991'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='12992'>
   ENDDO<a name='12993'>
<a name='12994'>
<a name='12995'>
<font color=#447700>!  ADJ test<a name='12996'></font>
<a name='12997'>
   FACTOR=0.1<a name='12998'>
 al  =S_al<a name='12999'>
 p   =S_p<a name='13000'>
 ph  =S_ph<a name='13001'>
 h_diabatic =S_h_diabatic<a name='13002'>
 t_new =S_t_new<a name='13003'>
 t_old =S_t_old<a name='13004'>
<a name='13005'>
 P_al  =FACTOR*S_al<a name='13006'>
 P_p   =FACTOR*S_p<a name='13007'>
 P_ph  =FACTOR*S_ph<a name='13008'>
 P_h_diabatic =FACTOR*S_h_diabatic<a name='13009'>
 P_t_new =FACTOR*S_t_new<a name='13010'>
 P_t_old =FACTOR*S_t_old<a name='13011'>
<a name='13012'>
 B_al  =P_al<a name='13013'>
 B_p   =P_p<a name='13014'>
 B_ph  =P_ph<a name='13015'>
 B_h_diabatic =P_h_diabatic<a name='13016'>
 B_t_new =P_t_new<a name='13017'>
 B_t_old =P_t_old<a name='13018'>
<a name='13019'>
 K_h_diabatic =h_diabatic<a name='13020'>
 K_t_new =t_new<a name='13021'>
 K_t_old =t_old<a name='13022'>
<a name='13023'>
call <A href='../../html_code/dyn_em/module_big_step_utilities_em_tl.F.html#G_MOIST_PHYSICS_PREP_EM'>g_moist_physics_prep_em</A><A href='../../html_code/dyn_em/module_check.F.html#T_MOIST_PHYSICS_PREP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G_MOIST_PHYSICS_PREP_EM_2">( t_new, P_t_new, t_old, P_t_old, t0, rho, P_rho, al, P_al, alb, p, P_p, p8w, P_p8w, p0, &amp;<a name='13024'>
&amp;pb, ph, P_ph, phb, pii, P_pii, pf, P_pf, z, P_z, z_at_w, P_z_at_w, dz8w, P_dz8w, dt, h_diabatic, P_h_diabatic, &amp;<a name='13025'>
&amp;config_flags, fzm, fzp, ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='13026'>
<a name='13027'>
     VAL_L=0.<a name='13028'>
     DO j = j_start, j_end<a name='13029'>
     DO k = k_start, kte<a name='13030'>
     DO i = i_start, i_end<a name='13031'>
       VAL_L=VAL_L+P_rho(i,k,j)**2+P_pii(i,k,j)**2+P_pf(i,k,j)**2+P_z(i,k,j)**2+  &amp;<a name='13032'>
              P_z_at_w(i,k,j)**2+P_dz8w(i,k,j)**2+P_h_diabatic(i,k,j)**2+  &amp;<a name='13033'>
              P_t_new(i,k,j)**2+P_t_old(i,k,j)**2<a name='13034'>
     ENDDO<a name='13035'>
     ENDDO<a name='13036'>
     ENDDO<a name='13037'>
<a name='13038'>
<a name='13039'>
 P_al  =0.0<a name='13040'>
 P_p   =0.0<a name='13041'>
 P_ph  =0.0<a name='13042'>
<a name='13043'>
call <A href='../../html_code/dyn_em/module_big_step_utilities_em_ad.F.html#A_MOIST_PHYSICS_PREP_EM'>a_moist_physics_prep_em</A><A href='../../html_code/dyn_em/module_check.F.html#T_MOIST_PHYSICS_PREP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="A_MOIST_PHYSICS_PREP_EM_1">( K_t_new, P_t_new, K_t_old, P_t_old, t0, rho, P_rho, al, P_al, alb, p, P_p, p8w, P_p8w, p0, &amp;<a name='13044'>
&amp;pb, ph, P_ph, phb, pii, P_pii, pf, P_pf, z, P_z, z_at_w, P_z_at_w, dz8w, P_dz8w, K_h_diabatic, P_h_diabatic, fzm, fzp, &amp;<a name='13045'>
&amp;ide, jde, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte )<a name='13046'>
<a name='13047'>
     VAL_A=0.<a name='13048'>
     DO j = j_start, j_end<a name='13049'>
     DO k = k_start, kte<a name='13050'>
     DO i = i_start, i_end<a name='13051'>
       VAL_A=VAL_A+P_al(i,k,j)*B_al(i,k,j)+P_p(i,k,j)*B_p(i,k,j)+P_ph(i,k,j)*B_ph(i,k,j)+  &amp;<a name='13052'>
              P_h_diabatic(i,k,j)*B_h_diabatic(i,k,j)+P_t_new(i,k,j)*B_t_new(i,k,j)+  &amp;<a name='13053'>
              P_t_old(i,k,j)*B_t_old(i,k,j)<a name='13054'>
     ENDDO<a name='13055'>
     ENDDO<a name='13056'>
     ENDDO<a name='13057'>
<a name='13058'>
#ifdef DM_PARALLEL<a name='13059'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='13060'>
                       comm, IERROR )<a name='13061'>
   VAL_A = nsum<a name='13062'>
#endif<a name='13063'>
<a name='13064'>
   print*, '                '<a name='13065'>
   write(6,*) 'a_prep_em: '<a name='13066'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='13067'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='13068'>
<a name='13069'>
END SUBROUTINE t_moist_physics_prep_em<a name='13070'>
<a name='13071'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='13072'></font>
<A NAME='T_DUCU'><A href='../../html_code/dyn_em/module_check.F.html#T_DUCU' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='13073'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>t_DUCU</font>(                                          &amp; <A href='../../call_to/T_DUCU.html' TARGET='index'>1</A>,<A href='../../call_from/T_DUCU.html' TARGET='index'>6</A><a name='13074'>
              ids,ide, jds,jde, kds,kde                      &amp;<a name='13075'>
             ,ims,ime, jms,jme, kms,kme                      &amp;<a name='13076'>
             ,its,ite, jts,jte, kts,kte                      &amp;<a name='13077'>
             ,DT,KTAU,DX                                     &amp;<a name='13078'>
             ,rho,RAINCV,NCA                                 &amp;<a name='13079'>
             ,U,V,TH,T,W,dz8w,Z,Pcps,pi                      &amp;<a name='13080'>
             ,W0AVG,XLV                                      &amp;<a name='13081'>
             ,CP,RD,RV,G                                      &amp;<a name='13082'>
             ,EP2,SVP1,SVP2,SVP3,SVPT0                       &amp;<a name='13083'>
             ,STEPCU,CU_ACT_FLAG,warm_rain,CUTOP,CUBOT       &amp;<a name='13084'>
             ,QV                                             &amp;<a name='13085'>
            <font color=#447700>! optionals<a name='13086'></font>
             ,RTHCUTEN,RQVCUTEN                              &amp;<a name='13087'>
                                                             )<a name='13088'>
<a name='13089'>
<a name='13090'>
   USE <A href='../../html_code/phys/module_cu_du.F.html#MODULE_CU_DU'>module_cu_du</A><A href='../../html_code/dyn_em/module_check.F.html#T_DUCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CU_DU_1"> , only : DUCU, DUCU_D, DUCU_B<a name='13091'>
<font color=#447700>!-------------------------------------------------------------<a name='13092'></font>
   IMPLICIT NONE<a name='13093'>
<font color=#447700>!-------------------------------------------------------------<a name='13094'></font>
   INTEGER       ::                            &amp;<a name='13095'>
                                  ids,ide, jds,jde, kds,kde, &amp;<a name='13096'>
                                  ims,ime, jms,jme, kms,kme, &amp;<a name='13097'>
                                  its,ite, jts,jte, kts,kte<a name='13098'>
<a name='13099'>
   INTEGER   :: STEPCU<a name='13100'>
   LOGICAL    :: warm_rain<a name='13101'>
<a name='13102'>
   REAL          :: XLV<a name='13103'>
   REAL          :: CP,RD,RV,G,EP2<a name='13104'>
   REAL          :: SVP1,SVP2,SVP3,SVPT0<a name='13105'>
<a name='13106'>
   INTEGER       :: KTAU<a name='13107'>
<a name='13108'>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         :: &amp;<a name='13109'>
                                                          U, &amp;<a name='13110'>
                                                          V, &amp;<a name='13111'>
                                                          W, &amp;<a name='13112'>
                                                         TH, &amp;<a name='13113'>
                                                          T, &amp;<a name='13114'>
                                                         QV, &amp;<a name='13115'>
                                                       dz8w, &amp;<a name='13116'>
                                                          z, &amp;<a name='13117'>
                                                       Pcps, &amp;<a name='13118'>
                                                        rho, &amp;<a name='13119'>
                                                         pi<a name='13120'>
<font color=#447700>!<a name='13121'></font>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )        :: W0AVG<a name='13122'>
  REAL   :: DT, DX<a name='13123'>
<font color=#447700>!<a name='13124'></font>
   REAL, DIMENSION( ims:ime , jms:jme )                  :: RAINCV<a name='13125'>
<a name='13126'>
   REAL,    DIMENSION( ims:ime , jms:jme )               :: NCA<a name='13127'>
<a name='13128'>
   REAL, DIMENSION( ims:ime , jms:jme )                ::  CUBOT, &amp;<a name='13129'>
                                                      CUTOP<a name='13130'>
<a name='13131'>
   LOGICAL, DIMENSION( ims:ime , jms:jme )            :: CU_ACT_FLAG<a name='13132'>
<a name='13133'>
<font color=#447700>!<a name='13134'></font>
<font color=#447700>! Optional arguments<a name='13135'></font>
<font color=#447700>!<a name='13136'></font>
<a name='13137'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme )     :: RTHCUTEN, &amp;<a name='13138'>
                                                   RQVCUTEN<a name='13139'>
<a name='13140'>
<font color=#447700>!  xzhang: new definition<a name='13141'></font>
<font color=#447700>!  IN variables<a name='13142'></font>
  REAL,  DIMENSION( ims:ime , kms:kme , jms:jme ) ::  S_TH, S_T, S_QV, S_dz8w, S_z, S_Pcps, S_rho <a name='13143'>
  REAL,  DIMENSION( ims:ime , kms:kme , jms:jme ) ::  P_TH, P_T, P_QV, P_dz8w, P_z, P_Pcps, P_rho <a name='13144'>
  REAL,  DIMENSION( ims:ime , kms:kme , jms:jme ) ::  B_TH, B_T, B_QV, B_dz8w, B_z, B_Pcps, B_rho <a name='13145'>
<a name='13146'>
<font color=#447700>! INOUT variables<a name='13147'></font>
   REAL, DIMENSION( ims:ime , jms:jme )           ::  S_RAINCV,P_RAINCV,B_RAINCV,K_RAINCV<a name='13148'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) ::  S_RTHCUTEN, S_RQVCUTEN<a name='13149'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) ::  P_RTHCUTEN, P_RQVCUTEN<a name='13150'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) ::  B_RTHCUTEN, B_RQVCUTEN<a name='13151'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) ::  K_RTHCUTEN, K_RQVCUTEN<a name='13152'>
<a name='13153'>
   REAL :: SAVE_L, COEF, ALPHA_TST, FACTOR, VAL_N, VAL_L, VAL_A<a name='13154'>
   INTEGER :: NT,h<a name='13155'>
<a name='13156'>
S_TH =TH<a name='13157'>
S_T =T<a name='13158'>
S_QV=QV<a name='13159'>
S_dz8w =dz8w<a name='13160'>
S_z =z<a name='13161'>
S_Pcps =Pcps<a name='13162'>
S_rho =rho<a name='13163'>
<a name='13164'>
P_TH =TH<a name='13165'>
P_T =T<a name='13166'>
P_QV=QV<a name='13167'>
P_dz8w =dz8w<a name='13168'>
P_z =z<a name='13169'>
P_Pcps =Pcps<a name='13170'>
P_rho =rho<a name='13171'>
<a name='13172'>
<font color=#447700>!S_RAINCV =RAINCV<a name='13173'></font>
<font color=#447700>!S_RTHCUTEN =RTHCUTEN<a name='13174'></font>
<font color=#447700>!S_RQVCUTEN =RQVCUTEN<a name='13175'></font>
<a name='13176'>
<font color=#447700>!P_RAINCV =RAINCV<a name='13177'></font>
<font color=#447700>!P_RTHCUTEN =RTHCUTEN<a name='13178'></font>
<font color=#447700>!P_RQVCUTEN =RQVCUTEN<a name='13179'></font>
<a name='13180'>
<font color=#447700>!K_RAINCV =RAINCV<a name='13181'></font>
<font color=#447700>!K_RTHCUTEN =RTHCUTEN<a name='13182'></font>
<font color=#447700>!K_RQVCUTEN =RQVCUTEN<a name='13183'></font>
<a name='13184'>
<font color=#447700>!  NLM<a name='13185'></font>
<a name='13186'>
    CALL  <A href='../../html_code/phys/module_cu_du.F.html#DUCU'>DUCU</A><A href='../../html_code/dyn_em/module_check.F.html#T_DUCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DUCU_1">(                                          &amp;<a name='13187'>
              ids,ide, jds,jde, kds,kde                      &amp;<a name='13188'>
             ,ims,ime, jms,jme, kms,kme                      &amp;<a name='13189'>
             ,its,ite, jts,jte, kts,kte                      &amp;<a name='13190'>
             ,DT,KTAU,DX                                     &amp;<a name='13191'>
             ,rho,RAINCV,NCA                                 &amp;<a name='13192'>
             ,U,V,TH,T,W,dz8w,Z,Pcps,pi                      &amp;<a name='13193'>
             ,W0AVG,XLV                                      &amp;<a name='13194'>
             ,CP,RD,RV,G                                      &amp;<a name='13195'>
             ,EP2,SVP1,SVP2,SVP3,SVPT0                       &amp;<a name='13196'>
             ,STEPCU,CU_ACT_FLAG,warm_rain,CUTOP,CUBOT       &amp;<a name='13197'>
             ,QV                                             &amp;<a name='13198'>
            <font color=#447700>! optionals<a name='13199'></font>
             ,RTHCUTEN,RQVCUTEN                              &amp;<a name='13200'>
                                                             )<a name='13201'>
<a name='13202'>
B_RAINCV =RAINCV<a name='13203'>
B_RTHCUTEN =RTHCUTEN<a name='13204'>
B_RQVCUTEN =RQVCUTEN<a name='13205'>
<a name='13206'>
<font color=#447700>!   CALL DUCU_D(ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms&amp;<a name='13207'></font>
<font color=#447700>! &amp;  , kme, its, ite, jts, jte, kts, kte, dt, ktau, dx, rho, rhod, raincv&amp;<a name='13208'></font>
<font color=#447700>! &amp;  , raincvd, nca, u, v, th, thd, t, td, w, dz8w, dz8wd, z, zd, pcps, &amp;<a name='13209'></font>
<font color=#447700>! &amp;  pcpsd, pi, w0avg, xlv, cp, rd, rv, g, ep2, svp1, svp2, svp3, svpt0, &amp;<a name='13210'></font>
<font color=#447700>! &amp;  stepcu, cu_act_flag, warm_rain, cutop, cubot, qv, qvd, rthcuten, &amp;<a name='13211'></font>
<font color=#447700>! &amp;  rthcutend, rqvcuten, rqvcutend)<a name='13212'></font>
<a name='13213'>
  CALL <A href='../../html_code/phys/module_cu_du.F.html#DUCU_D'>DUCU_D</A><A href='../../html_code/dyn_em/module_check.F.html#T_DUCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DUCU_D_1">(ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms&amp;<a name='13214'>
&amp;  , kme, its, ite, jts, jte, kts, kte, dt, ktau, dx, rho, P_rho, K_raincv&amp;<a name='13215'>
&amp;  , P_raincv, nca, u, v, th, P_th, t, P_t, w, dz8w, P_dz8w, z, P_z, pcps, &amp;<a name='13216'>
&amp;  P_pcps, pi, w0avg, xlv, cp, rd, rv, g, ep2, svp1, svp2, svp3, svpt0, &amp;<a name='13217'>
&amp;  stepcu, cu_act_flag, warm_rain, cutop, cubot, qv, P_qv, K_rthcuten, &amp;<a name='13218'>
&amp;  P_rthcuten, K_rqvcuten, P_rqvcuten)<a name='13219'>
<a name='13220'>
     SAVE_L=0.<a name='13221'>
     SAVE_L= sum(P_RAINCV**2) + sum(P_RTHCUTEN **2)+ sum(P_RQVCUTEN **2)<a name='13222'>
<a name='13223'>
#ifdef DM_PARALLEL<a name='13224'>
   call MPI_ALLREDUCE( SAVE_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='13225'>
                       comm, IERROR )<a name='13226'>
   SAVE_L = nsum<a name='13227'>
#endif<a name='13228'>
<a name='13229'>
<a name='13230'>
   ALPHA_TST=1.<a name='13231'>
   DO NT=1,11<a name='13232'>
      ALPHA_TST=0.1*ALPHA_TST<a name='13233'>
      FACTOR=1.+ALPHA_TST<a name='13234'>
<a name='13235'>
	P_TH =FACTOR*S_TH<a name='13236'>
	P_T =FACTOR*S_T<a name='13237'>
	P_QV=FACTOR*S_QV<a name='13238'>
	P_dz8w =FACTOR*S_dz8w<a name='13239'>
	P_z =FACTOR*S_z<a name='13240'>
	P_Pcps =FACTOR*S_pcps<a name='13241'>
	P_rho =FACTOR*S_rho<a name='13242'>
<a name='13243'>
<font color=#447700>!	P_RAINCV =FACTOR*S_RAINCV<a name='13244'></font>
<font color=#447700>!	P_RTHCUTEN =FACTOR*S_RTHCUTEN<a name='13245'></font>
<font color=#447700>!	P_RQVCUTEN =FACTOR*S_RQVCUTEN<a name='13246'></font>
<a name='13247'>
    CALL  <A href='../../html_code/phys/module_cu_du.F.html#DUCU'>DUCU</A><A href='../../html_code/dyn_em/module_check.F.html#T_DUCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DUCU_2">(                                          &amp;<a name='13248'>
              ids,ide, jds,jde, kds,kde                      &amp;<a name='13249'>
             ,ims,ime, jms,jme, kms,kme                      &amp;<a name='13250'>
             ,its,ite, jts,jte, kts,kte                      &amp;<a name='13251'>
             ,DT,KTAU,DX                                     &amp;<a name='13252'>
             ,P_rho,P_RAINCV,NCA                                 &amp;<a name='13253'>
             ,U,V,P_TH,P_T,W,P_dz8w,P_Z,P_Pcps,pi                      &amp;<a name='13254'>
             ,W0AVG,XLV                                      &amp;<a name='13255'>
             ,CP,RD,RV,G                                      &amp;<a name='13256'>
             ,EP2,SVP1,SVP2,SVP3,SVPT0                       &amp;<a name='13257'>
             ,STEPCU,CU_ACT_FLAG,warm_rain,CUTOP,CUBOT       &amp;<a name='13258'>
             ,P_QV                                             &amp;<a name='13259'>
            <font color=#447700>! optionals<a name='13260'></font>
             ,P_RTHCUTEN,P_RQVCUTEN                              &amp;<a name='13261'>
                                                             )<a name='13262'>
<a name='13263'>
<a name='13264'>
     VAL_N=0.<a name='13265'>
     VAL_N= sum((P_RAINCV -B_RAINCV)**2) + sum((P_RTHCUTEN -B_RTHCUTEN)**2) + sum((P_RQVCUTEN -B_RQVCUTEN)**2) <a name='13266'>
<a name='13267'>
#ifdef DM_PARALLEL<a name='13268'>
   call MPI_ALLREDUCE( VAL_N, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='13269'>
                       comm, IERROR )<a name='13270'>
   VAL_N = nsum<a name='13271'>
#endif<a name='13272'>
<a name='13273'>
      VAL_L=SAVE_L*ALPHA_TST**2<a name='13274'>
      COEF=VAL_N/VAL_L<a name='13275'>
<a name='13276'>
      WRITE(6, fmt='(A,E9.4,A,E22.13,A,E13.6,A,E13.6)') &amp;<a name='13277'>
         'g_cudu: ALPHA=',ALPHA_TST,'  COEF=',COEF, &amp;<a name='13278'>
         '  VAL_N=',VAL_N,'  VAL_L=',VAL_L<a name='13279'>
   ENDDO<a name='13280'>
<a name='13281'>
<font color=#447700>! ADJ test<a name='13282'></font>
<a name='13283'>
  FACTOR = 0.1<a name='13284'>
<a name='13285'>
TH =S_TH<a name='13286'>
T =S_T<a name='13287'>
QV=S_QV<a name='13288'>
dz8w =S_dz8w<a name='13289'>
z =S_z<a name='13290'>
Pcps =S_Pcps<a name='13291'>
rho =S_rho<a name='13292'>
<a name='13293'>
<font color=#447700>!RAINCV =S_RAINCV<a name='13294'></font>
<font color=#447700>!RTHCUTEN =S_RTHCUTEN<a name='13295'></font>
<font color=#447700>!RQVCUTEN =S_RQVCUTEN<a name='13296'></font>
<a name='13297'>
P_TH =FACTOR*S_TH<a name='13298'>
P_T =FACTOR*S_T<a name='13299'>
P_QV=FACTOR*S_QV<a name='13300'>
P_dz8w =FACTOR*S_dz8w<a name='13301'>
P_z =FACTOR*S_z<a name='13302'>
P_Pcps =FACTOR*S_Pcps<a name='13303'>
P_rho =FACTOR*S_rho<a name='13304'>
<a name='13305'>
<font color=#447700>!P_RAINCV =FACTOR*S_RAINCV<a name='13306'></font>
<font color=#447700>!P_RTHCUTEN =FACTOR*S_RTHCUTEN<a name='13307'></font>
<font color=#447700>!P_RQVCUTEN =FACTOR*S_RQVCUTEN<a name='13308'></font>
<a name='13309'>
B_TH =P_TH<a name='13310'>
B_T =P_T<a name='13311'>
B_QV=P_QV<a name='13312'>
B_dz8w =P_dz8w<a name='13313'>
B_z =P_z<a name='13314'>
B_Pcps =P_Pcps<a name='13315'>
B_rho =P_rho<a name='13316'>
<a name='13317'>
<font color=#447700>!B_RAINCV =P_RAINCV<a name='13318'></font>
<font color=#447700>!B_RTHCUTEN =P_RTHCUTEN<a name='13319'></font>
<font color=#447700>!B_RQVCUTEN =P_RQVCUTEN<a name='13320'></font>
<a name='13321'>
<font color=#447700>!K_RAINCV =RAINCV<a name='13322'></font>
<font color=#447700>!K_RTHCUTEN =RTHCUTEN<a name='13323'></font>
<font color=#447700>!K_RQVCUTEN =RQVCUTEN<a name='13324'></font>
<a name='13325'>
  CALL <A href='../../html_code/phys/module_cu_du.F.html#DUCU_D'>DUCU_D</A><A href='../../html_code/dyn_em/module_check.F.html#T_DUCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DUCU_D_2">(ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms&amp;<a name='13326'>
&amp;  , kme, its, ite, jts, jte, kts, kte, dt, ktau, dx, rho, P_rho, raincv&amp;<a name='13327'>
&amp;  , P_raincv, nca, u, v, th, P_th, t, P_t, w, dz8w, P_dz8w, z, P_z, pcps, &amp;<a name='13328'>
&amp;  P_pcps, pi, w0avg, xlv, cp, rd, rv, g, ep2, svp1, svp2, svp3, svpt0, &amp;<a name='13329'>
&amp;  stepcu, cu_act_flag, warm_rain, cutop, cubot, qv, P_qv, rthcuten, &amp;<a name='13330'>
&amp;  P_rthcuten, rqvcuten, P_rqvcuten)<a name='13331'>
<a name='13332'>
     VAL_L=0.<a name='13333'>
     VAL_L= sum(P_RAINCV**2) + sum(P_RTHCUTEN **2)+ sum(P_RQVCUTEN **2)<a name='13334'>
<a name='13335'>
#ifdef DM_PARALLEL<a name='13336'>
   call MPI_ALLREDUCE( VAL_L, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='13337'>
                       comm, IERROR )<a name='13338'>
   VAL_L = nsum<a name='13339'>
#endif<a name='13340'>
<a name='13341'>
P_TH =0.0<a name='13342'>
P_T =0.0<a name='13343'>
P_QV=0.0<a name='13344'>
P_dz8w =0.0<a name='13345'>
P_z =0.0<a name='13346'>
P_Pcps =0.0<a name='13347'>
P_rho =0.0<a name='13348'>
<a name='13349'>
<font color=#447700>!  call  DUCU_B(ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms&amp;<a name='13350'></font>
<font color=#447700>!&amp;  , kme, its, ite, jts, jte, kts, kte, dt, ktau, dx, rho, P_rho, K_raincv&amp;<a name='13351'></font>
<font color=#447700>!&amp;  , P_raincv, nca, u, v, th, P_th, t, P_t, w, dz8w, P_dz8w, z, P_z, pcps, &amp;<a name='13352'></font>
<font color=#447700>!&amp;  P_pcps, pi, w0avg, xlv, cp, rd, rv, g, ep2, svp1, svp2, svp3, svpt0, &amp;<a name='13353'></font>
<font color=#447700>!&amp;  stepcu, cu_act_flag, warm_rain, cutop, cubot, qv, P_qv, K_rthcuten, &amp;<a name='13354'></font>
<font color=#447700>!&amp;  P_rthcuten, K_rqvcuten, P_rqvcuten)<a name='13355'></font>
<a name='13356'>
  call  <A href='../../html_code/phys/module_cu_du.F.html#DUCU_B'>DUCU_B</A><A href='../../html_code/dyn_em/module_check.F.html#T_DUCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DUCU_B_1">(ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms&amp;<a name='13357'>
&amp;  , kme, its, ite, jts, jte, kts, kte, dt, ktau, dx, rho, P_rho, raincv&amp;<a name='13358'>
&amp;  , P_raincv, nca, u, v, th, P_th, t, P_t, w, dz8w, P_dz8w, z, P_z, pcps, &amp;<a name='13359'>
&amp;  P_pcps, pi, w0avg, xlv, cp, rd, rv, g, ep2, svp1, svp2, svp3, svpt0, &amp;<a name='13360'>
&amp;  stepcu, cu_act_flag, warm_rain, cutop, cubot, qv, P_qv, rthcuten, &amp;<a name='13361'>
&amp;  P_rthcuten, rqvcuten, P_rqvcuten)<a name='13362'>
<a name='13363'>
     VAL_A=0.<a name='13364'>
     VAL_A= sum(P_TH*B_TH)+ sum(P_T*B_T)+ sum(P_QV*B_QV)+ sum(P_dz8w*B_dz8w)  &amp;<a name='13365'>
            + sum(P_z*B_z)+ sum(P_Pcps*B_Pcps)+ sum(P_rho*B_rho) <a name='13366'>
<font color=#447700>!            + sum(P_RAINCV*B_RAINCV) +sum(P_RTHCUTEN*B_RTHCUTEN) +sum(P_RQVCUTEN*B_RQVCUTEN)<a name='13367'></font>
<a name='13368'>
#ifdef DM_PARALLEL<a name='13369'>
   call MPI_ALLREDUCE( VAL_A, nsum, 1, MPI_DOUBLE_PRECISION, MPI_SUM, &amp;<a name='13370'>
                       comm, IERROR )<a name='13371'>
   VAL_A = nsum<a name='13372'>
#endif<a name='13373'>
<a name='13374'>
   print*, '                '<a name='13375'>
   write(6,*) 'a_CUDU: '<a name='13376'>
   write(6,fmt='(A,E22.13)') '      VAL_TL: ', VAL_L<a name='13377'>
   write(6,fmt='(A,E22.13)') '      VAL_AD: ', VAL_A<a name='13378'>
<a name='13379'>
    END SUBROUTINE t_DUCU<a name='13380'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='13381'></font>
<font color=#447700>!============================================================================================================<a name='13382'></font>
<a name='13383'>
END MODULE module_check<a name='13384'>
</pre></body></html>