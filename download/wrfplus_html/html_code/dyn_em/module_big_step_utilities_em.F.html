<HTML> <BODY BGCOLOR=#cceeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:DYNAMICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_BIG_STEP_UTILITIES_EM'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>module_big_step_utilities_em</font> <A href='../../call_to/MODULE_BIG_STEP_UTILITIES_EM.html' TARGET='index'>17</A><a name='5'>
<a name='6'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#module_big_step_utilities_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_3"><a name='7'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#module_big_step_utilities_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_4"><a name='8'>
   USE module_state_description<a name='9'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#module_big_step_utilities_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_8"><a name='10'>
<a name='11'>
CONTAINS<a name='12'>
<a name='13'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='14'></font>
<a name='15'>
<A NAME='CALC_MU_UV'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_UV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='16'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_mu_uv</font> ( config_flags,                 &amp; <A href='../../call_to/CALC_MU_UV.html' TARGET='index'>2</A><a name='17'>
                        mu, mub, muu, muv,            &amp;<a name='18'>
                        ids, ide, jds, jde, kds, kde, &amp;<a name='19'>
                        ims, ime, jms, jme, kms, kme, &amp;<a name='20'>
                        its, ite, jts, jte, kts, kte )<a name='21'>
<a name='22'>
   IMPLICIT NONE<a name='23'>
   <a name='24'>
   <font color=#447700>! Input data<a name='25'></font>
<a name='26'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='27'>
<a name='28'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='29'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='30'>
                                       its, ite, jts, jte, kts, kte <a name='31'>
<a name='32'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(  OUT) :: muu, muv<a name='33'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mu, mub<a name='34'>
<a name='35'>
   <font color=#447700>!  local stuff<a name='36'></font>
<a name='37'>
   INTEGER :: i, j, itf, jtf, im, jm<a name='38'>
<a name='39'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='40'></font>
<font color=#447700>!<a name='41'></font>
<font color=#447700>!  calc_mu_uv calculates the full column dry-air mass at the staggered<a name='42'></font>
<font color=#447700>!  horizontal velocity points (u,v) and places the results in muu and muv.<a name='43'></font>
<font color=#447700>!  This routine uses the reference state (mub) and perturbation state (mu)<a name='44'></font>
<font color=#447700>!<a name='45'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='46'></font>
<a name='47'>
<a name='48'>
      itf=ite<a name='49'>
      jtf=MIN(jte,jde-1)<a name='50'>
<a name='51'>
      IF      ( ( its .NE. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='52'>
         DO j=jts,jtf<a name='53'>
         DO i=its,itf<a name='54'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j)+mub(i,j)+mub(i-1,j))<a name='55'>
         ENDDO<a name='56'>
         ENDDO<a name='57'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='58'>
         DO j=jts,jtf<a name='59'>
         DO i=its+1,itf<a name='60'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j)+mub(i,j)+mub(i-1,j))<a name='61'>
         ENDDO<a name='62'>
         ENDDO<a name='63'>
         i=its<a name='64'>
         im = its<a name='65'>
         if(config_flags%periodic_x) im = its-1<a name='66'>
         DO j=jts,jtf<a name='67'>
<font color=#447700>!            muu(i,j) =      mu(i,j)          +mub(i,j)<a name='68'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='69'></font>
            muu(i,j) = 0.5*(mu(i,j)+mu(im,j)+mub(i,j)+mub(im,j))<a name='70'>
         ENDDO<a name='71'>
      ELSE IF ( ( its .NE. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='72'>
         DO j=jts,jtf<a name='73'>
         DO i=its,itf-1<a name='74'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j)+mub(i,j)+mub(i-1,j))<a name='75'>
         ENDDO<a name='76'>
         ENDDO<a name='77'>
         i=ite<a name='78'>
         im = ite-1<a name='79'>
         if(config_flags%periodic_x) im = ite<a name='80'>
         DO j=jts,jtf<a name='81'>
<font color=#447700>!            muu(i,j) =      mu(i-1,j)        +mub(i-1,j)<a name='82'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='83'></font>
            muu(i,j) = 0.5*(mu(i-1,j)+mu(im,j)+mub(i-1,j)+mub(im,j))<a name='84'>
         ENDDO<a name='85'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='86'>
         DO j=jts,jtf<a name='87'>
         DO i=its+1,itf-1<a name='88'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j)+mub(i,j)+mub(i-1,j))<a name='89'>
         ENDDO<a name='90'>
         ENDDO<a name='91'>
         i=its<a name='92'>
         im = its<a name='93'>
         if(config_flags%periodic_x) im = its-1<a name='94'>
         DO j=jts,jtf<a name='95'>
<font color=#447700>!            muu(i,j) =      mu(i,j)          +mub(i,j)<a name='96'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='97'></font>
            muu(i,j) = 0.5*(mu(i,j)+mu(im,j)+mub(i,j)+mub(im,j))<a name='98'>
         ENDDO<a name='99'>
         i=ite<a name='100'>
         im = ite-1<a name='101'>
         if(config_flags%periodic_x) im = ite<a name='102'>
         DO j=jts,jtf<a name='103'>
<font color=#447700>!            muu(i,j) =      mu(i-1,j)        +mub(i-1,j)<a name='104'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='105'></font>
            muu(i,j) = 0.5*(mu(i-1,j)+mu(im,j)+mub(i-1,j)+mub(im,j))<a name='106'>
         ENDDO<a name='107'>
      END IF<a name='108'>
<a name='109'>
      itf=MIN(ite,ide-1)<a name='110'>
      jtf=jte<a name='111'>
<a name='112'>
      IF      ( ( jts .NE. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='113'>
         DO j=jts,jtf<a name='114'>
         DO i=its,itf<a name='115'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1)+mub(i,j)+mub(i,j-1))<a name='116'>
         ENDDO<a name='117'>
         ENDDO<a name='118'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='119'>
         DO j=jts+1,jtf<a name='120'>
         DO i=its,itf<a name='121'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1)+mub(i,j)+mub(i,j-1))<a name='122'>
         ENDDO<a name='123'>
         ENDDO<a name='124'>
         j=jts<a name='125'>
         jm = jts<a name='126'>
         if(config_flags%periodic_y) jm = jts-1<a name='127'>
         DO i=its,itf<a name='128'>
<font color=#447700>!             muv(i,j) =      mu(i,j)          +mub(i,j)<a name='129'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='130'></font>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,jm)+mub(i,j)+mub(i,jm))<a name='131'>
         ENDDO<a name='132'>
      ELSE IF ( ( jts .NE. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='133'>
         DO j=jts,jtf-1<a name='134'>
         DO i=its,itf<a name='135'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1)+mub(i,j)+mub(i,j-1))<a name='136'>
         ENDDO<a name='137'>
         ENDDO<a name='138'>
         j=jte<a name='139'>
         jm = jte-1<a name='140'>
         if(config_flags%periodic_y) jm = jte<a name='141'>
         DO i=its,itf<a name='142'>
             muv(i,j) =      mu(i,j-1)        +mub(i,j-1)<a name='143'>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='144'></font>
             muv(i,j) = 0.5*(mu(i,j-1)+mu(i,jm)+mub(i,j-1)+mub(i,jm))<a name='145'>
         ENDDO<a name='146'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='147'>
         DO j=jts+1,jtf-1<a name='148'>
         DO i=its,itf<a name='149'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1)+mub(i,j)+mub(i,j-1))<a name='150'>
         ENDDO<a name='151'>
         ENDDO<a name='152'>
         j=jts<a name='153'>
         jm = jts<a name='154'>
         if(config_flags%periodic_y) jm = jts-1<a name='155'>
         DO i=its,itf<a name='156'>
<font color=#447700>!             muv(i,j) =      mu(i,j)          +mub(i,j)<a name='157'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='158'></font>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,jm)+mub(i,j)+mub(i,jm))<a name='159'>
         ENDDO<a name='160'>
         j=jte<a name='161'>
         jm = jte-1<a name='162'>
         if(config_flags%periodic_y) jm = jte<a name='163'>
         DO i=its,itf<a name='164'>
<font color=#447700>!             muv(i,j) =      mu(i,j-1)        +mub(i,j-1)<a name='165'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='166'></font>
             muv(i,j) = 0.5*(mu(i,j-1)+mu(i,jm)+mub(i,j-1)+mub(i,jm))<a name='167'>
         ENDDO<a name='168'>
      END IF<a name='169'>
<a name='170'>
END SUBROUTINE calc_mu_uv<a name='171'>
<a name='172'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='173'></font>
<a name='174'>
<A NAME='CALC_MU_UV_1'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_UV_1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='175'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_mu_uv_1</font> ( config_flags,                 &amp; <A href='../../call_to/CALC_MU_UV_1.html' TARGET='index'>10</A><a name='176'>
                          mu, muu, muv,                 &amp;<a name='177'>
                          ids, ide, jds, jde, kds, kde, &amp;<a name='178'>
                          ims, ime, jms, jme, kms, kme, &amp;<a name='179'>
                          its, ite, jts, jte, kts, kte )<a name='180'>
<a name='181'>
   IMPLICIT NONE<a name='182'>
   <a name='183'>
   <font color=#447700>! Input data<a name='184'></font>
<a name='185'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='186'>
<a name='187'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='188'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='189'>
                                       its, ite, jts, jte, kts, kte <a name='190'>
<a name='191'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(  OUT) :: muu, muv<a name='192'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mu<a name='193'>
<a name='194'>
   <font color=#447700>!  local stuff<a name='195'></font>
<a name='196'>
   INTEGER :: i, j, itf, jtf, im, jm<a name='197'>
<a name='198'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='199'></font>
<font color=#447700>!<a name='200'></font>
<font color=#447700>!  calc_mu_uv calculates the full column dry-air mass at the staggered<a name='201'></font>
<font color=#447700>!  horizontal velocity points (u,v) and places the results in muu and muv.<a name='202'></font>
<font color=#447700>!  This routine uses the full state (mu)<a name='203'></font>
<font color=#447700>!<a name='204'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='205'></font>
   <a name='206'>
      itf=ite<a name='207'>
      jtf=MIN(jte,jde-1)<a name='208'>
<a name='209'>
      IF      ( ( its .NE. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='210'>
         DO j=jts,jtf<a name='211'>
         DO i=its,itf<a name='212'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j))<a name='213'>
         ENDDO<a name='214'>
         ENDDO<a name='215'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='216'>
         DO j=jts,jtf<a name='217'>
         DO i=its+1,itf<a name='218'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j))<a name='219'>
         ENDDO<a name='220'>
         ENDDO<a name='221'>
         i=its<a name='222'>
         im = its<a name='223'>
         if(config_flags%periodic_x) im = its-1<a name='224'>
         DO j=jts,jtf<a name='225'>
            muu(i,j) = 0.5*(mu(i,j)+mu(im,j))<a name='226'>
         ENDDO<a name='227'>
      ELSE IF ( ( its .NE. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='228'>
         DO j=jts,jtf<a name='229'>
         DO i=its,itf-1<a name='230'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j))<a name='231'>
         ENDDO<a name='232'>
         ENDDO<a name='233'>
         i=ite<a name='234'>
         im = ite-1<a name='235'>
         if(config_flags%periodic_x) im = ite<a name='236'>
         DO j=jts,jtf<a name='237'>
            muu(i,j) = 0.5*(mu(i-1,j)+mu(im,j))<a name='238'>
         ENDDO<a name='239'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='240'>
         DO j=jts,jtf<a name='241'>
         DO i=its+1,itf-1<a name='242'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j))<a name='243'>
         ENDDO<a name='244'>
         ENDDO<a name='245'>
         i=its<a name='246'>
         im = its<a name='247'>
         if(config_flags%periodic_x) im = its-1<a name='248'>
         DO j=jts,jtf<a name='249'>
            muu(i,j) = 0.5*(mu(i,j)+mu(im,j))<a name='250'>
         ENDDO<a name='251'>
         i=ite<a name='252'>
         im = ite-1<a name='253'>
         if(config_flags%periodic_x) im = ite<a name='254'>
         DO j=jts,jtf<a name='255'>
            muu(i,j) = 0.5*(mu(i-1,j)+mu(im,j))<a name='256'>
         ENDDO<a name='257'>
      END IF<a name='258'>
<a name='259'>
      itf=MIN(ite,ide-1)<a name='260'>
      jtf=jte<a name='261'>
<a name='262'>
      IF      ( ( jts .NE. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='263'>
         DO j=jts,jtf<a name='264'>
         DO i=its,itf<a name='265'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1))<a name='266'>
         ENDDO<a name='267'>
         ENDDO<a name='268'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='269'>
         DO j=jts+1,jtf<a name='270'>
         DO i=its,itf<a name='271'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1))<a name='272'>
         ENDDO<a name='273'>
         ENDDO<a name='274'>
         j=jts<a name='275'>
         jm = jts<a name='276'>
         if(config_flags%periodic_y) jm = jts-1<a name='277'>
         DO i=its,itf<a name='278'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,jm))<a name='279'>
         ENDDO<a name='280'>
      ELSE IF ( ( jts .NE. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='281'>
         DO j=jts,jtf-1<a name='282'>
         DO i=its,itf<a name='283'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1))<a name='284'>
         ENDDO<a name='285'>
         ENDDO<a name='286'>
         j=jte<a name='287'>
         jm = jte-1<a name='288'>
         if(config_flags%periodic_y) jm = jte<a name='289'>
         DO i=its,itf<a name='290'>
             muv(i,j) = 0.5*(mu(i,j-1)+mu(i,jm))<a name='291'>
         ENDDO<a name='292'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='293'>
         DO j=jts+1,jtf-1<a name='294'>
         DO i=its,itf<a name='295'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1))<a name='296'>
         ENDDO<a name='297'>
         ENDDO<a name='298'>
         j=jts<a name='299'>
         jm = jts<a name='300'>
         if(config_flags%periodic_y) jm = jts-1<a name='301'>
         DO i=its,itf<a name='302'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,jm))<a name='303'>
         ENDDO<a name='304'>
         j=jte<a name='305'>
         jm = jte-1<a name='306'>
         if(config_flags%periodic_y) jm = jte<a name='307'>
         DO i=its,itf<a name='308'>
             muv(i,j) = 0.5*(mu(i,j-1)+mu(i,jm))<a name='309'>
         ENDDO<a name='310'>
      END IF<a name='311'>
<a name='312'>
END SUBROUTINE calc_mu_uv_1<a name='313'>
<a name='314'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='315'></font>
<a name='316'>
<A NAME='COUPLE_MOMENTUM'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE_MOMENTUM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='317'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>couple_momentum</font> ( muu, ru, u, msfu,              &amp; <A href='../../call_to/COUPLE_MOMENTUM.html' TARGET='index'>1</A><a name='318'>
                             muv, rv, v, msfv,              &amp;<a name='319'>
                             mut, rw, w, msft,              &amp;<a name='320'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='321'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='322'>
                             its, ite, jts, jte, kts, kte  )<a name='323'>
<a name='324'>
   IMPLICIT NONE<a name='325'>
<a name='326'>
   <font color=#447700>! Input data<a name='327'></font>
<a name='328'>
   INTEGER ,             INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='329'>
                                          ims, ime, jms, jme, kms, kme, &amp;<a name='330'>
                                          its, ite, jts, jte, kts, kte<a name='331'>
<a name='332'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(  OUT) :: ru, rv, rw<a name='333'>
<a name='334'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: muu, muv, mut<a name='335'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: msfu, msfv, msft<a name='336'>
   <a name='337'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: u, v, w<a name='338'>
   <a name='339'>
   <font color=#447700>! Local data<a name='340'></font>
   <a name='341'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='342'>
   <a name='343'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='344'></font>
<font color=#447700>!<a name='345'></font>
<font color=#447700>! couple_momentum couples the velocities to the full column mass and<a name='346'></font>
<font color=#447700>! the map factors.<a name='347'></font>
<font color=#447700>!<a name='348'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='349'></font>
<a name='350'>
   ktf=MIN(kte,kde-1)<a name='351'>
   <a name='352'>
      itf=ite<a name='353'>
      jtf=MIN(jte,jde-1)<a name='354'>
<a name='355'>
      DO j=jts,jtf<a name='356'>
      DO k=kts,ktf<a name='357'>
      DO i=its,itf<a name='358'>
         ru(i,k,j)=u(i,k,j)*muu(i,j)/msfu(i,j)<a name='359'>
      ENDDO<a name='360'>
      ENDDO<a name='361'>
      ENDDO<a name='362'>
<a name='363'>
      itf=MIN(ite,ide-1)<a name='364'>
      jtf=jte<a name='365'>
<a name='366'>
      DO j=jts,jtf<a name='367'>
      DO k=kts,ktf<a name='368'>
      DO i=its,itf<a name='369'>
           rv(i,k,j)=v(i,k,j)*muv(i,j)/msfv(i,j)<a name='370'>
      ENDDO<a name='371'>
      ENDDO<a name='372'>
      ENDDO<a name='373'>
<a name='374'>
      itf=MIN(ite,ide-1)<a name='375'>
      jtf=MIN(jte,jde-1)<a name='376'>
<a name='377'>
      DO j=jts,jtf<a name='378'>
      DO k=kts,kte<a name='379'>
      DO i=its,itf<a name='380'>
         rw(i,k,j)=w(i,k,j)*mut(i,j)/msft(i,j)<a name='381'>
      ENDDO<a name='382'>
      ENDDO<a name='383'>
      ENDDO<a name='384'>
<a name='385'>
END SUBROUTINE couple_momentum<a name='386'>
<a name='387'>
<font color=#447700>!-------------------------------------------------------------------<a name='388'></font>
<a name='389'>
<A NAME='CALC_MU_STAGGERED'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_STAGGERED' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='390'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_mu_staggered</font> ( mu, mub, muu, muv,            &amp; <A href='../../call_to/CALC_MU_STAGGERED.html' TARGET='index'>2</A><a name='391'>
                                  ids, ide, jds, jde, kds, kde, &amp;<a name='392'>
                                  ims, ime, jms, jme, kms, kme, &amp;<a name='393'>
                                  its, ite, jts, jte, kts, kte )<a name='394'>
<a name='395'>
   IMPLICIT NONE<a name='396'>
   <a name='397'>
   <font color=#447700>! Input data<a name='398'></font>
<a name='399'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='400'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='401'>
                                       its, ite, jts, jte, kts, kte <a name='402'>
<a name='403'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(  OUT) :: muu, muv<a name='404'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mu, mub<a name='405'>
<a name='406'>
   <font color=#447700>!  local stuff<a name='407'></font>
<a name='408'>
   INTEGER :: i, j, itf, jtf<a name='409'>
<a name='410'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='411'></font>
<font color=#447700>!<a name='412'></font>
<font color=#447700>! calc_mu_staggered calculates the full dry air mass at the staggered<a name='413'></font>
<font color=#447700>! velocity points (u,v).<a name='414'></font>
<font color=#447700>!<a name='415'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='416'></font>
   <a name='417'>
      itf=ite<a name='418'>
      jtf=MIN(jte,jde-1)<a name='419'>
<a name='420'>
      IF      ( ( its .NE. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='421'>
         DO j=jts,jtf<a name='422'>
         DO i=its,itf<a name='423'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j)+mub(i,j)+mub(i-1,j))<a name='424'>
         ENDDO<a name='425'>
         ENDDO<a name='426'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='427'>
         DO j=jts,jtf<a name='428'>
         DO i=its+1,itf<a name='429'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j)+mub(i,j)+mub(i-1,j))<a name='430'>
         ENDDO<a name='431'>
         ENDDO<a name='432'>
         i=its<a name='433'>
         DO j=jts,jtf<a name='434'>
            muu(i,j) =      mu(i,j)          +mub(i,j)<a name='435'>
         ENDDO<a name='436'>
      ELSE IF ( ( its .NE. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='437'>
         DO j=jts,jtf<a name='438'>
         DO i=its,itf-1<a name='439'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j)+mub(i,j)+mub(i-1,j))<a name='440'>
         ENDDO<a name='441'>
         ENDDO<a name='442'>
         i=ite<a name='443'>
         DO j=jts,jtf<a name='444'>
            muu(i,j) =      mu(i-1,j)        +mub(i-1,j)<a name='445'>
         ENDDO<a name='446'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='447'>
         DO j=jts,jtf<a name='448'>
         DO i=its+1,itf-1<a name='449'>
            muu(i,j) = 0.5*(mu(i,j)+mu(i-1,j)+mub(i,j)+mub(i-1,j))<a name='450'>
         ENDDO<a name='451'>
         ENDDO<a name='452'>
         i=its<a name='453'>
         DO j=jts,jtf<a name='454'>
            muu(i,j) =      mu(i,j)          +mub(i,j)<a name='455'>
         ENDDO<a name='456'>
         i=ite<a name='457'>
         DO j=jts,jtf<a name='458'>
            muu(i,j) =      mu(i-1,j)        +mub(i-1,j)<a name='459'>
         ENDDO<a name='460'>
      END IF<a name='461'>
<a name='462'>
      itf=MIN(ite,ide-1)<a name='463'>
      jtf=jte<a name='464'>
<a name='465'>
      IF      ( ( jts .NE. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='466'>
         DO j=jts,jtf<a name='467'>
         DO i=its,itf<a name='468'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1)+mub(i,j)+mub(i,j-1))<a name='469'>
         ENDDO<a name='470'>
         ENDDO<a name='471'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='472'>
         DO j=jts+1,jtf<a name='473'>
         DO i=its,itf<a name='474'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1)+mub(i,j)+mub(i,j-1))<a name='475'>
         ENDDO<a name='476'>
         ENDDO<a name='477'>
         j=jts<a name='478'>
         DO i=its,itf<a name='479'>
             muv(i,j) =      mu(i,j)          +mub(i,j)<a name='480'>
         ENDDO<a name='481'>
      ELSE IF ( ( jts .NE. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='482'>
         DO j=jts,jtf-1<a name='483'>
         DO i=its,itf<a name='484'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1)+mub(i,j)+mub(i,j-1))<a name='485'>
         ENDDO<a name='486'>
         ENDDO<a name='487'>
         j=jte<a name='488'>
         DO i=its,itf<a name='489'>
             muv(i,j) =      mu(i,j-1)        +mub(i,j-1)<a name='490'>
         ENDDO<a name='491'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='492'>
         DO j=jts+1,jtf-1<a name='493'>
         DO i=its,itf<a name='494'>
             muv(i,j) = 0.5*(mu(i,j)+mu(i,j-1)+mub(i,j)+mub(i,j-1))<a name='495'>
         ENDDO<a name='496'>
         ENDDO<a name='497'>
         j=jts<a name='498'>
         DO i=its,itf<a name='499'>
             muv(i,j) =      mu(i,j)          +mub(i,j)<a name='500'>
         ENDDO<a name='501'>
         j=jte<a name='502'>
         DO i=its,itf<a name='503'>
             muv(i,j) =      mu(i,j-1)        +mub(i,j-1)<a name='504'>
         ENDDO<a name='505'>
      END IF<a name='506'>
<a name='507'>
END SUBROUTINE calc_mu_staggered<a name='508'>
<a name='509'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='510'></font>
<a name='511'>
<A NAME='COUPLE'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='512'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>couple</font> ( mu, mub, rfield, field, name, &amp; <A href='../../call_to/COUPLE.html' TARGET='index'>25</A>,<A href='../../call_from/COUPLE.html' TARGET='index'>2</A><a name='513'>
                    msf,                          &amp;<a name='514'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='515'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='516'>
                    its, ite, jts, jte, kts, kte )<a name='517'>
<a name='518'>
   IMPLICIT NONE<a name='519'>
<a name='520'>
   <font color=#447700>! Input data<a name='521'></font>
<a name='522'>
   INTEGER ,             INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='523'>
                                          ims, ime, jms, jme, kms, kme, &amp;<a name='524'>
                                          its, ite, jts, jte, kts, kte<a name='525'>
<a name='526'>
   CHARACTER(LEN=1) ,     INTENT(IN   ) :: name<a name='527'>
<a name='528'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(  OUT) :: rfield<a name='529'>
<a name='530'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mu, mub, msf<a name='531'>
   <a name='532'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field<a name='533'>
   <a name='534'>
   <font color=#447700>! Local data<a name='535'></font>
   <a name='536'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='537'>
   REAL , DIMENSION(ims:ime,jms:jme) :: muu , muv<a name='538'>
<a name='539'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='540'></font>
<font color=#447700>!<a name='541'></font>
<font color=#447700>! subroutine couple couples the input variable with the dry-air <a name='542'></font>
<font color=#447700>! column mass (mu).  <a name='543'></font>
<font color=#447700>!<a name='544'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='545'></font>
<a name='546'>
   <a name='547'>
   ktf=MIN(kte,kde-1)<a name='548'>
   <a name='549'>
   IF (name .EQ. 'u')THEN<a name='550'>
<a name='551'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_STAGGERED'>calc_mu_staggered</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_MU_STAGGERED_1"> ( mu, mub, muu, muv,            &amp;<a name='552'>
                                  ids, ide, jds, jde, kds, kde, &amp;<a name='553'>
                                  ims, ime, jms, jme, kms, kme, &amp;<a name='554'>
                                  its, ite, jts, jte, kts, kte )<a name='555'>
<a name='556'>
      itf=ite<a name='557'>
      jtf=MIN(jte,jde-1)<a name='558'>
<a name='559'>
      DO j=jts,jtf<a name='560'>
      DO k=kts,ktf<a name='561'>
      DO i=its,itf<a name='562'>
         rfield(i,k,j)=field(i,k,j)*muu(i,j)/msf(i,j)<a name='563'>
      ENDDO<a name='564'>
      ENDDO<a name='565'>
      ENDDO<a name='566'>
<a name='567'>
   ELSE IF (name .EQ. 'v')THEN<a name='568'>
<a name='569'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_STAGGERED'>calc_mu_staggered</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_MU_STAGGERED_2"> ( mu, mub, muu, muv,            &amp;<a name='570'>
                               ids, ide, jds, jde, kds, kde, &amp;<a name='571'>
                               ims, ime, jms, jme, kms, kme, &amp;<a name='572'>
                               its, ite, jts, jte, kts, kte )<a name='573'>
<a name='574'>
      itf=ite<a name='575'>
      itf=MIN(ite,ide-1)<a name='576'>
      jtf=jte<a name='577'>
<a name='578'>
      DO j=jts,jtf<a name='579'>
      DO k=kts,ktf<a name='580'>
      DO i=its,itf<a name='581'>
           rfield(i,k,j)=field(i,k,j)*muv(i,j)/msf(i,j)<a name='582'>
      ENDDO<a name='583'>
      ENDDO<a name='584'>
      ENDDO<a name='585'>
<a name='586'>
   ELSE IF (name .EQ. 'w')THEN<a name='587'>
      itf=MIN(ite,ide-1)<a name='588'>
      jtf=MIN(jte,jde-1)<a name='589'>
      DO j=jts,jtf<a name='590'>
      DO k=kts,kte<a name='591'>
      DO i=its,itf<a name='592'>
         rfield(i,k,j)=field(i,k,j)*(mu(i,j)+mub(i,j))/msf(i,j)<a name='593'>
      ENDDO<a name='594'>
      ENDDO<a name='595'>
      ENDDO<a name='596'>
<a name='597'>
   ELSE IF (name .EQ. 'h')THEN<a name='598'>
      itf=MIN(ite,ide-1)<a name='599'>
      jtf=MIN(jte,jde-1)<a name='600'>
      DO j=jts,jtf<a name='601'>
      DO k=kts,kte<a name='602'>
      DO i=its,itf<a name='603'>
         rfield(i,k,j)=field(i,k,j)*(mu(i,j)+mub(i,j))<a name='604'>
      ENDDO<a name='605'>
      ENDDO<a name='606'>
      ENDDO<a name='607'>
<a name='608'>
   ELSE <a name='609'>
      itf=MIN(ite,ide-1)<a name='610'>
      jtf=MIN(jte,jde-1)<a name='611'>
      DO j=jts,jtf<a name='612'>
      DO k=kts,ktf<a name='613'>
      DO i=its,itf<a name='614'>
         rfield(i,k,j)=field(i,k,j)*(mu(i,j)+mub(i,j))<a name='615'>
      ENDDO<a name='616'>
      ENDDO<a name='617'>
      ENDDO<a name='618'>
   <a name='619'>
   ENDIF<a name='620'>
<a name='621'>
END SUBROUTINE couple<a name='622'>
<a name='623'>
<font color=#447700>!-----------------------------------------------------------------------<a name='624'></font>
<a name='625'>
<A NAME='CALC_WW'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_WW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='626'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_ww</font> ( mu, ru, rv, ww,               &amp;<a name='627'>
                     rdx, rdy, msft, dnw,          &amp;<a name='628'>
                     ids, ide, jds, jde, kds, kde, &amp;<a name='629'>
                     ims, ime, jms, jme, kms, kme, &amp;<a name='630'>
                     its, ite, jts, jte, kts, kte )<a name='631'>
<a name='632'>
   IMPLICIT NONE<a name='633'>
<a name='634'>
   <font color=#447700>! Input data<a name='635'></font>
<a name='636'>
<a name='637'>
   INTEGER ,                                   INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='638'>
                                                                ims, ime, jms, jme, kms, kme, &amp;<a name='639'>
                                                                its, ite, jts, jte, kts, kte<a name='640'>
<a name='641'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: ru, rv<a name='642'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mu, msft<a name='643'>
   REAL , DIMENSION( kms:kme ) , INTENT(IN   ) :: dnw<a name='644'>
   <a name='645'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT  ) :: ww<a name='646'>
   REAL , INTENT(IN   )  :: rdx, rdy<a name='647'>
   <a name='648'>
   <font color=#447700>! Local data<a name='649'></font>
   <a name='650'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='651'>
   REAL , DIMENSION( its:ite ) :: dmdt<a name='652'>
<a name='653'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='654'></font>
<font color=#447700>!<a name='655'></font>
<font color=#447700>!  calc_ww calculates omega using the mass-coupled velocities mu*u, mu*v.<a name='656'></font>
<font color=#447700>!  The algorithm integrates the continuity equation through the column<a name='657'></font>
<font color=#447700>!  followed by a diagnosis of omega.<a name='658'></font>
<font color=#447700>!<a name='659'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='660'></font>
<a name='661'>
<a name='662'>
    jtf=MIN(jte,jde-1)<a name='663'>
    ktf=MIN(kte,kde-1)  <a name='664'>
    itf=MIN(ite,ide-1)<a name='665'>
<a name='666'>
      DO j=jts,jtf<a name='667'>
<a name='668'>
        DO i=its,ite<a name='669'>
          dmdt(i) = 0.<a name='670'>
          ww(i,1,j) = 0.<a name='671'>
          ww(i,kte,j) = 0.<a name='672'>
        ENDDO<a name='673'>
<a name='674'>
<font color=#447700>!!        DO k=kts,ktf+1<a name='675'></font>
<a name='676'>
        DO k=kts,ktf<a name='677'>
        DO i=its,itf<a name='678'>
<a name='679'>
          dmdt(i) = dmdt(i) + dnw(k)* ( rdx*(ru(i+1,k,j)-ru(i,k,j))  &amp;<a name='680'>
                                       +rdy*(rv(i,k,j+1)-rv(i,k,j))   )<a name='681'>
<a name='682'>
        ENDDO<a name='683'>
        ENDDO<a name='684'>
<a name='685'>
<font color=#447700>!               DO K=2,NZ-1<a name='686'></font>
<font color=#447700>!                  ww(K,I)=ww(K-1,I)-DNW(K-1)*<a name='687'></font>
<font color=#447700>!     &amp;                  (DMDT+RDX*( xmu(i  )*u(K,I  ) <a name='688'></font>
<font color=#447700>!     &amp;                             -xmu(im1)*u(k,im1)) )<a name='689'></font>
<font color=#447700>!               END DO<a name='690'></font>
<a name='691'>
        DO k=2,ktf<a name='692'>
        DO i=its,itf<a name='693'>
<a name='694'>
           ww(i,k,j)=ww(i,k-1,j)                                       &amp;<a name='695'>
                        - dnw(k-1)* ( dmdt(i)                          &amp;<a name='696'>
                                     +rdx*(ru(i+1,k-1,j)-ru(i,k-1,j))  &amp;<a name='697'>
                                     +rdy*(rv(i,k-1,j+1)-rv(i,k-1,j)) )<a name='698'>
        ENDDO<a name='699'>
        ENDDO<a name='700'>
     ENDDO<a name='701'>
<a name='702'>
END SUBROUTINE calc_ww<a name='703'>
<a name='704'>
<a name='705'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='706'></font>
<a name='707'>
<A NAME='CALC_WW_CP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_WW_CP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='708'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_ww_cp</font> ( u, v, mup, mub, ww,              &amp; <A href='../../call_to/CALC_WW_CP.html' TARGET='index'>1</A><a name='709'>
                        rdx, rdy, msft, msfu, msfv, dnw, &amp;<a name='710'>
                        ids, ide, jds, jde, kds, kde,    &amp;<a name='711'>
                        ims, ime, jms, jme, kms, kme,    &amp;<a name='712'>
                        its, ite, jts, jte, kts, kte    )<a name='713'>
<a name='714'>
   IMPLICIT NONE<a name='715'>
<a name='716'>
   <font color=#447700>! Input data<a name='717'></font>
<a name='718'>
<a name='719'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='720'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='721'>
                                 its, ite, jts, jte, kts, kte<a name='722'>
<a name='723'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: u, v<a name='724'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mup, mub, &amp;<a name='725'>
                                                            msft, msfu, msfv<a name='726'>
   REAL , DIMENSION( kms:kme ) , INTENT(IN   ) :: dnw<a name='727'>
   <a name='728'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT  ) :: ww<a name='729'>
   REAL , INTENT(IN   )  :: rdx, rdy<a name='730'>
   <a name='731'>
   <font color=#447700>! Local data<a name='732'></font>
   <a name='733'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='734'>
   REAL , DIMENSION( its:ite ) :: dmdt<a name='735'>
   REAL , DIMENSION( its:ite, kts:kte ) :: divv<a name='736'>
   REAL , DIMENSION( its:ite+1, jts:jte+1 ) :: muu, muv<a name='737'>
<a name='738'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='739'></font>
<font color=#447700>!<a name='740'></font>
<font color=#447700>!  calc_ww calculates omega using the velocities (u,v) and the dry-air <a name='741'></font>
<font color=#447700>!  column mass (mup+mub).<a name='742'></font>
<font color=#447700>!  The algorithm integrates the continuity equation through the column<a name='743'></font>
<font color=#447700>!  followed by a diagnosis of omega.<a name='744'></font>
<font color=#447700>!<a name='745'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='746'></font>
<a name='747'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='748'></font>
<font color=#447700>!<a name='749'></font>
<font color=#447700>!  calc_ww_cp calculates omega using the velocities (u,v) and the <a name='750'></font>
<font color=#447700>!  column mass mu.<a name='751'></font>
<font color=#447700>!<a name='752'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='753'></font>
<a name='754'>
    jtf=MIN(jte,jde-1)<a name='755'>
    ktf=MIN(kte,kde-1)  <a name='756'>
    itf=MIN(ite,ide-1)<a name='757'>
<a name='758'>
<font color=#447700>!  mu coupled with the appropriate map factor<a name='759'></font>
<a name='760'>
      DO j=jts,jtf<a name='761'>
      DO i=its,min(ite+1,ide)<a name='762'>
        muu(i,j) = 0.5*(mup(i,j)+mub(i,j)+mup(i-1,j)+mub(i-1,j))/msfu(i,j)<a name='763'>
      ENDDO<a name='764'>
      ENDDO<a name='765'>
<a name='766'>
      DO j=jts,min(jte+1,jde)<a name='767'>
      DO i=its,itf<a name='768'>
        muv(i,j) = 0.5*(mup(i,j)+mub(i,j)+mup(i,j-1)+mub(i,j-1))/msfv(i,j)<a name='769'>
      ENDDO<a name='770'>
      ENDDO<a name='771'>
<a name='772'>
      DO j=jts,jtf<a name='773'>
<a name='774'>
        DO i=its,ite<a name='775'>
          dmdt(i) = 0.<a name='776'>
          ww(i,1,j) = 0.<a name='777'>
          ww(i,kte,j) = 0.<a name='778'>
        ENDDO<a name='779'>
<a name='780'>
        DO k=kts,ktf<a name='781'>
        DO i=its,itf<a name='782'>
<a name='783'>
          divv(i,k) = msft(i,j)*dnw(k)*( rdx*(muu(i+1,j)*u(i+1,k,j)-muu(i,j)*u(i,k,j))  &amp;<a name='784'>
                                        +rdy*(muv(i,j+1)*v(i,k,j+1)-muv(i,j)*v(i,k,j))   )<a name='785'>
<a name='786'>
<font color=#447700>!          dmdt(i) = dmdt(i) + dnw(k)* ( rdx*(ru(i+1,k,j)-ru(i,k,j))  &amp;<a name='787'></font>
<font color=#447700>!                                       +rdy*(rv(i,k,j+1)-rv(i,k,j))   )<a name='788'></font>
<a name='789'>
          dmdt(i) = dmdt(i) + divv(i,k)<a name='790'>
<a name='791'>
<a name='792'>
        ENDDO<a name='793'>
        ENDDO<a name='794'>
<a name='795'>
        DO k=2,ktf<a name='796'>
        DO i=its,itf<a name='797'>
<a name='798'>
<font color=#447700>!           ww(i,k,j)=ww(i,k-1,j)                                       &amp;<a name='799'></font>
<font color=#447700>!                        - dnw(k-1)* ( dmdt(i)                          &amp;<a name='800'></font>
<font color=#447700>!                                     +rdx*(ru(i+1,k-1,j)-ru(i,k-1,j))  &amp;<a name='801'></font>
<font color=#447700>!                                     +rdy*(rv(i,k-1,j+1)-rv(i,k-1,j)) )<a name='802'></font>
<a name='803'>
           ww(i,k,j)=ww(i,k-1,j) - dnw(k-1)*dmdt(i) - divv(i,k-1)<a name='804'>
<a name='805'>
        ENDDO<a name='806'>
        ENDDO<a name='807'>
     ENDDO<a name='808'>
<a name='809'>
<a name='810'>
END SUBROUTINE calc_ww_cp<a name='811'>
<a name='812'>
<a name='813'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='814'></font>
 <a name='815'>
<A NAME='CALC_CQ'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_CQ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='816'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_cq</font> ( moist, cqu, cqv, cqw, n_moist, &amp; <A href='../../call_to/CALC_CQ.html' TARGET='index'>1</A><a name='817'>
                     ids, ide, jds, jde, kds, kde,  &amp;<a name='818'>
                     ims, ime, jms, jme, kms, kme,  &amp;<a name='819'>
                     its, ite, jts, jte, kts, kte  )<a name='820'>
<a name='821'>
   IMPLICIT NONE<a name='822'>
   <a name='823'>
   <font color=#447700>! Input data<a name='824'></font>
<a name='825'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='826'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='827'>
                                       its, ite, jts, jte, kts, kte <a name='828'>
<a name='829'>
   INTEGER ,          INTENT(IN   ) :: n_moist<a name='830'>
   <a name='831'>
<a name='832'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme , n_moist ), INTENT(IN   ) :: moist<a name='833'>
                                              <a name='834'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(  OUT) :: cqu, cqv, cqw<a name='835'>
<a name='836'>
   <font color=#447700>! Local stuff<a name='837'></font>
<a name='838'>
   REAL :: qtot<a name='839'>
   <a name='840'>
   INTEGER :: i, j, k, itf, jtf, ktf, ispe<a name='841'>
<a name='842'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='843'></font>
<font color=#447700>!<a name='844'></font>
<font color=#447700>!  calc_cq calculates moist coefficients for the momentum equations.<a name='845'></font>
<font color=#447700>!<a name='846'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='847'></font>
<a name='848'>
      itf=ite<a name='849'>
      jtf=MIN(jte,jde-1)<a name='850'>
      ktf=MIN(kte,kde-1)<a name='851'>
<a name='852'>
      IF(  n_moist &gt;= PARAM_FIRST_SCALAR ) THEN<a name='853'>
<a name='854'>
        DO j=jts,jtf<a name='855'>
        DO k=kts,ktf<a name='856'>
        DO i=its,itf<a name='857'>
          qtot = 0.<a name='858'>
          DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='859'>
            qtot = qtot + moist(i,k,j,ispe) + moist(i-1,k,j,ispe)<a name='860'>
          ENDDO<a name='861'>
<font color=#447700>!           qtot = 0.5*( moist(i  ,k,j,1)+moist(i  ,k,j,2)+moist(i  ,k,j,3)+  &amp;<a name='862'></font>
<font color=#447700>!     &amp;                  moist(i-1,k,j,1)+moist(i-1,k,j,2)+moist(i-1,k,j,3) )<a name='863'></font>
<font color=#447700>!           cqu(i,k,j) = 1./(1.+qtot)<a name='864'></font>
           cqu(i,k,j) = 1./(1.+0.5*qtot)<a name='865'>
        ENDDO<a name='866'>
        ENDDO<a name='867'>
        ENDDO<a name='868'>
<a name='869'>
        itf=MIN(ite,ide-1)<a name='870'>
        jtf=jte<a name='871'>
<a name='872'>
        DO j=jts,jtf<a name='873'>
        DO k=kts,ktf<a name='874'>
        DO i=its,itf<a name='875'>
          qtot = 0.<a name='876'>
          DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='877'>
            qtot = qtot + moist(i,k,j,ispe) + moist(i,k,j-1,ispe)<a name='878'>
          ENDDO<a name='879'>
<font color=#447700>!           qtot = 0.5*( moist(i,k,j  ,1)+moist(i,k,j  ,2)+moist(i,k,j  ,3)+  &amp;<a name='880'></font>
<font color=#447700>!     &amp;                  moist(i,k,j-1,1)+moist(i,k,j-1,2)+moist(i,k,j-1,3) )<a name='881'></font>
<font color=#447700>!           cqv(i,k,j) = 1./(1.+qtot)<a name='882'></font>
           cqv(i,k,j) = 1./(1.+0.5*qtot)<a name='883'>
        ENDDO<a name='884'>
        ENDDO<a name='885'>
        ENDDO<a name='886'>
<a name='887'>
        itf=MIN(ite,ide-1)<a name='888'>
        jtf=MIN(jte,jde-1)<a name='889'>
        DO j=jts,jtf<a name='890'>
        DO k=kts+1,ktf<a name='891'>
        DO i=its,itf<a name='892'>
          qtot = 0.<a name='893'>
          DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='894'>
            qtot = qtot + moist(i,k,j,ispe) + moist(i,k-1,j,ispe)<a name='895'>
          ENDDO<a name='896'>
<font color=#447700>!           qtot = 0.5*( moist(i,k  ,j,1)+moist(i,k  ,j,2)+moist(i,k-1,j,3)+  &amp;<a name='897'></font>
<font color=#447700>!     &amp;                  moist(i,k-1,j,1)+moist(i,k-1,j,2)+moist(i,k  ,j,3) )<a name='898'></font>
<font color=#447700>!           cqw(i,k,j) = qtot<a name='899'></font>
           cqw(i,k,j) = 0.5*qtot<a name='900'>
        ENDDO<a name='901'>
        ENDDO<a name='902'>
        ENDDO<a name='903'>
<a name='904'>
      ELSE<a name='905'>
<a name='906'>
        DO j=jts,jtf<a name='907'>
        DO k=kts,ktf<a name='908'>
        DO i=its,itf<a name='909'>
           cqu(i,k,j) = 1.<a name='910'>
        ENDDO<a name='911'>
        ENDDO<a name='912'>
        ENDDO<a name='913'>
<a name='914'>
        itf=MIN(ite,ide-1)<a name='915'>
        jtf=jte<a name='916'>
<a name='917'>
        DO j=jts,jtf<a name='918'>
        DO k=kts,ktf<a name='919'>
        DO i=its,itf<a name='920'>
           cqv(i,k,j) = 1.<a name='921'>
        ENDDO<a name='922'>
        ENDDO<a name='923'>
        ENDDO<a name='924'>
<a name='925'>
        itf=MIN(ite,ide-1)<a name='926'>
        jtf=MIN(jte,jde-1)<a name='927'>
        DO j=jts,jtf<a name='928'>
        DO k=kts+1,ktf<a name='929'>
        DO i=its,itf<a name='930'>
           cqw(i,k,j) = 0.<a name='931'>
        ENDDO<a name='932'>
        ENDDO<a name='933'>
        ENDDO<a name='934'>
<a name='935'>
      END IF<a name='936'>
<a name='937'>
END SUBROUTINE calc_cq<a name='938'>
<a name='939'>
<font color=#447700>!----------------------------------------------------------------------<a name='940'></font>
<a name='941'>
<A NAME='CALC_ALT'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_ALT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='942'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_alt</font> ( alt, al, alb,                  &amp; <A href='../../call_to/CALC_ALT.html' TARGET='index'>1</A><a name='943'>
                      ids, ide, jds, jde, kds, kde,  &amp;<a name='944'>
                      ims, ime, jms, jme, kms, kme,  &amp;<a name='945'>
                      its, ite, jts, jte, kts, kte  )<a name='946'>
<a name='947'>
   IMPLICIT NONE<a name='948'>
   <a name='949'>
   <font color=#447700>! Input data<a name='950'></font>
<a name='951'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='952'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='953'>
                                       its, ite, jts, jte, kts, kte <a name='954'>
<a name='955'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(IN   ) :: alb, al<a name='956'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(  OUT) :: alt<a name='957'>
<a name='958'>
   <font color=#447700>! Local stuff<a name='959'></font>
<a name='960'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='961'>
<a name='962'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='963'></font>
<font color=#447700>!<a name='964'></font>
<font color=#447700>! calc_alt computes the full inverse density<a name='965'></font>
<font color=#447700>!<a name='966'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='967'></font>
<a name='968'>
      itf=MIN(ite,ide-1)<a name='969'>
      jtf=MIN(jte,jde-1)<a name='970'>
      ktf=MIN(kte,kde-1)<a name='971'>
<a name='972'>
      DO j=jts,jtf<a name='973'>
      DO k=kts,ktf<a name='974'>
      DO i=its,itf<a name='975'>
        alt(i,k,j) = al(i,k,j)+alb(i,k,j)<a name='976'>
      ENDDO<a name='977'>
      ENDDO<a name='978'>
      ENDDO<a name='979'>
<a name='980'>
<a name='981'>
END SUBROUTINE calc_alt<a name='982'>
<a name='983'>
<font color=#447700>!----------------------------------------------------------------------<a name='984'></font>
<a name='985'>
<A NAME='CALC_P_RHO_PHI'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='986'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_p_rho_phi</font> ( moist, n_moist,                &amp; <A href='../../call_to/CALC_P_RHO_PHI.html' TARGET='index'>10</A><a name='987'>
                            al, alb, mu, muts, ph, p, pb,  &amp;<a name='988'>
                            t, p0, t0, znu, dnw, rdnw,     &amp;<a name='989'>
                            rdn, non_hydrostatic,          &amp;<a name='990'>
                            ids, ide, jds, jde, kds, kde,  &amp;<a name='991'>
                            ims, ime, jms, jme, kms, kme,  &amp;<a name='992'>
                            its, ite, jts, jte, kts, kte  )<a name='993'>
<a name='994'>
  IMPLICIT NONE<a name='995'>
   <a name='996'>
   <font color=#447700>! Input data<a name='997'></font>
<a name='998'>
  LOGICAL ,          INTENT(IN   ) :: non_hydrostatic<a name='999'>
<a name='1000'>
  INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1001'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='1002'>
                                      its, ite, jts, jte, kts, kte <a name='1003'>
<a name='1004'>
  INTEGER ,          INTENT(IN   ) :: n_moist<a name='1005'>
<a name='1006'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(IN   ) :: alb,  &amp;<a name='1007'>
                                                                   pb,   &amp;<a name='1008'>
                                                                   t<a name='1009'>
<a name='1010'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme, n_moist ), INTENT(IN   ) :: moist<a name='1011'>
<a name='1012'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(  OUT) :: al, p<a name='1013'>
<a name='1014'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(INOUT) :: ph<a name='1015'>
<a name='1016'>
  REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN   ) :: mu, muts<a name='1017'>
<a name='1018'>
  REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: znu, dnw, rdnw, rdn<a name='1019'>
<a name='1020'>
  REAL,   INTENT(IN   ) :: t0, p0<a name='1021'>
<a name='1022'>
  <font color=#447700>! Local stuff<a name='1023'></font>
<a name='1024'>
  INTEGER :: i, j, k, itf, jtf, ktf, ispe<a name='1025'>
  REAL    :: qvf, qtot, qf1, qf2<a name='1026'>
<a name='1027'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1028'></font>
<font color=#447700>!<a name='1029'></font>
<font color=#447700>! For the nonhydrostatic option, calc_p_rho_phi calculates the<a name='1030'></font>
<font color=#447700>! diagnostic quantities pressure and (inverse) density from the<a name='1031'></font>
<font color=#447700>! prognostic variables using the equation of state.<a name='1032'></font>
<font color=#447700>!<a name='1033'></font>
<font color=#447700>! For the hydrostatic option, calc_p_rho_phi calculates the<a name='1034'></font>
<font color=#447700>! diagnostic quantities (inverse) density and geopotential from the<a name='1035'></font>
<font color=#447700>! prognostic variables using the equation of state and the hydrostatic <a name='1036'></font>
<font color=#447700>! equation.<a name='1037'></font>
<font color=#447700>!<a name='1038'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1039'></font>
<a name='1040'>
  itf=MIN(ite,ide-1)<a name='1041'>
  jtf=MIN(jte,jde-1)<a name='1042'>
  ktf=MIN(kte,kde-1)<a name='1043'>
<a name='1044'>
  IF (non_hydrostatic) THEN<a name='1045'>
<a name='1046'>
      IF (n_moist &gt;= PARAM_FIRST_SCALAR ) THEN  <a name='1047'>
<a name='1048'>
        DO j=jts,jtf<a name='1049'>
        DO k=kts,ktf<a name='1050'>
        DO i=its,itf<a name='1051'>
          qvf = 1.+rvovrd*moist(i,k,j,P_QV)<a name='1052'>
          al(i,k,j)=-1./muts(i,j)*(alb(i,k,j)*mu(i,j)  &amp;<a name='1053'>
                     +rdnw(k)*(ph(i,k+1,j)-ph(i,k,j)))<a name='1054'>
          p(i,k,j)= ( (r_d*(t0+t(i,k,j))*qvf)/                 &amp;<a name='1055'>
                        (p0*(al(i,k,j)+alb(i,k,j))) )**cpovcv  &amp;<a name='1056'>
                        *p0 -pb(i,k,j)<a name='1057'>
<a name='1058'>
        ENDDO<a name='1059'>
        ENDDO<a name='1060'>
        ENDDO<a name='1061'>
<a name='1062'>
      ELSE<a name='1063'>
<a name='1064'>
        DO j=jts,jtf<a name='1065'>
        DO k=kts,ktf<a name='1066'>
        DO i=its,itf<a name='1067'>
          al(i,k,j)=-1./muts(i,j)*(alb(i,k,j)*mu(i,j)  &amp;<a name='1068'>
                     +rdnw(k)*(ph(i,k+1,j)-ph(i,k,j)))<a name='1069'>
          p(i,k,j)=p0*( (r_d*(t0+t(i,k,j)))/                     &amp;<a name='1070'>
                        (p0*(al(i,k,j)+alb(i,k,j))) )**cpovcv  &amp;<a name='1071'>
                           -pb(i,k,j)<a name='1072'>
        ENDDO<a name='1073'>
        ENDDO<a name='1074'>
        ENDDO<a name='1075'>
<a name='1076'>
      END IF<a name='1077'>
<a name='1078'>
   ELSE<a name='1079'>
<a name='1080'>
<font color=#447700>!  hydrostatic pressure, al, and ph1 calc; WCS, 5 sept 2001<a name='1081'></font>
<a name='1082'>
<a name='1083'>
      IF (n_moist &gt;= PARAM_FIRST_SCALAR ) THEN  <a name='1084'>
<a name='1085'>
        DO j=jts,jtf<a name='1086'>
<a name='1087'>
          k=ktf          <font color=#447700>! top layer<a name='1088'></font>
          DO i=its,itf<a name='1089'>
<a name='1090'>
            qtot = 0.<a name='1091'>
            DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='1092'>
              qtot = qtot + moist(i,k,j,ispe)<a name='1093'>
            ENDDO<a name='1094'>
            qf2 = 1./(1.+qtot)<a name='1095'>
            qf1 = qtot*qf2<a name='1096'>
<a name='1097'>
            p(i,k,j) = - 0.5*(mu(i,j)+qf1*muts(i,j))/rdnw(k)/qf2<a name='1098'>
            qvf = 1.+rvovrd*moist(i,k,j,P_QV)<a name='1099'>
            al(i,k,j) = (r_d/p1000mb)*(t(i,k,j)+t0)*qvf* &amp;<a name='1100'>
                (((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm) - alb(i,k,j)<a name='1101'>
<a name='1102'>
          ENDDO<a name='1103'>
<a name='1104'>
          DO k=ktf-1,kts,-1  <font color=#447700>! remaining layers, integrate down<a name='1105'></font>
            DO i=its,itf<a name='1106'>
<a name='1107'>
            qtot = 0.<a name='1108'>
            DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='1109'>
              qtot = qtot + 0.5*(  moist(i,k  ,j,ispe) + moist(i,k+1,j,ispe) )<a name='1110'>
            ENDDO<a name='1111'>
            qf2 = 1./(1.+qtot)<a name='1112'>
            qf1 = qtot*qf2<a name='1113'>
<a name='1114'>
            p(i,k,j) = p(i,k+1,j) - (mu(i,j) + qf1*muts(i,j))/qf2/rdn(k+1)<a name='1115'>
            qvf = 1.+rvovrd*moist(i,k,j,P_QV)<a name='1116'>
            al(i,k,j) = (r_d/p1000mb)*(t(i,k,j)+t0)*qvf* &amp;<a name='1117'>
                        (((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm) - alb(i,k,j)<a name='1118'>
            ENDDO<a name='1119'>
          ENDDO<a name='1120'>
<a name='1121'>
          DO k=2,ktf+1  <font color=#447700>! integrate hydrostatic equation for geopotential<a name='1122'></font>
            DO i=its,itf<a name='1123'>
<a name='1124'>
<font color=#447700>!              ph(i,k,j) = ph(i,k-1,j) - (1./rdnw(k-1))*(       &amp;<a name='1125'></font>
<font color=#447700>!                           (muts(i,j)+mu(i,j))*al(i,k-1,j)+    &amp;<a name='1126'></font>
<font color=#447700>!                            mu(i,j)*alb(i,k-1,j)  )<a name='1127'></font>
              ph(i,k,j) = ph(i,k-1,j) - (dnw(k-1))*(           &amp;<a name='1128'>
                           (muts(i,j))*al(i,k-1,j)+            &amp;<a name='1129'>
                            mu(i,j)*alb(i,k-1,j)  )<a name='1130'>
                                                   <a name='1131'>
<a name='1132'>
            ENDDO<a name='1133'>
          ENDDO<a name='1134'>
<a name='1135'>
        ENDDO<a name='1136'>
<a name='1137'>
      ELSE<a name='1138'>
<a name='1139'>
        DO j=jts,jtf<a name='1140'>
<a name='1141'>
          k=ktf          <font color=#447700>! top layer<a name='1142'></font>
          DO i=its,itf<a name='1143'>
<a name='1144'>
            qtot = 0.<a name='1145'>
            qf2 = 1./(1.+qtot)<a name='1146'>
            qf1 = qtot*qf2<a name='1147'>
<a name='1148'>
            p(i,k,j) = - 0.5*(mu(i,j)+qf1*muts(i,j))/rdnw(k)/qf2<a name='1149'>
            qvf = 1.<a name='1150'>
            al(i,k,j) = (r_d/p1000mb)*(t(i,k,j)+t0)*qvf* &amp;<a name='1151'>
                (((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm) - alb(i,k,j)<a name='1152'>
<a name='1153'>
          ENDDO<a name='1154'>
<a name='1155'>
          DO k=ktf-1,kts,-1  <font color=#447700>! remaining layers, integrate down<a name='1156'></font>
            DO i=its,itf<a name='1157'>
<a name='1158'>
            qtot = 0.<a name='1159'>
            qf2 = 1./(1.+qtot)<a name='1160'>
            qf1 = qtot*qf2<a name='1161'>
<a name='1162'>
            p(i,k,j) = p(i,k+1,j) - (mu(i,j) + qf1*muts(i,j))/qf2/rdn(k+1)<a name='1163'>
            qvf = 1.<a name='1164'>
            al(i,k,j) = (r_d/p1000mb)*(t(i,k,j)+t0)*qvf* &amp;<a name='1165'>
                        (((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm) - alb(i,k,j)<a name='1166'>
            ENDDO<a name='1167'>
          ENDDO<a name='1168'>
<a name='1169'>
          DO k=2,ktf+1  <font color=#447700>! integrate hydrostatic equation for geopotential<a name='1170'></font>
            DO i=its,itf<a name='1171'>
<a name='1172'>
<font color=#447700>!              ph(i,k,j) = ph(i,k-1,j) - (1./rdnw(k-1))*(       &amp;<a name='1173'></font>
<font color=#447700>!                           (muts(i,j)+mu(i,j))*al(i,k-1,j)+    &amp;<a name='1174'></font>
<font color=#447700>!                            mu(i,j)*alb(i,k-1,j)  )<a name='1175'></font>
              ph(i,k,j) = ph(i,k-1,j) - (dnw(k-1))*(           &amp;<a name='1176'>
                           (muts(i,j))*al(i,k-1,j)+            &amp;<a name='1177'>
                            mu(i,j)*alb(i,k-1,j)  )<a name='1178'>
                                                   <a name='1179'>
<a name='1180'>
            ENDDO<a name='1181'>
          ENDDO<a name='1182'>
<a name='1183'>
        ENDDO<a name='1184'>
<a name='1185'>
     END IF<a name='1186'>
<a name='1187'>
   END IF<a name='1188'>
<a name='1189'>
END SUBROUTINE calc_p_rho_phi<a name='1190'>
<a name='1191'>
<font color=#447700>!----------------------------------------------------------------------<a name='1192'></font>
<a name='1193'>
<A NAME='CALC_PHP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_PHP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1194'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_php</font> ( php, ph, phb,                  &amp; <A href='../../call_to/CALC_PHP.html' TARGET='index'>1</A><a name='1195'>
                      ids, ide, jds, jde, kds, kde,  &amp;<a name='1196'>
                      ims, ime, jms, jme, kms, kme,  &amp;<a name='1197'>
                      its, ite, jts, jte, kts, kte  )<a name='1198'>
<a name='1199'>
   IMPLICIT NONE<a name='1200'>
   <a name='1201'>
   <font color=#447700>! Input data<a name='1202'></font>
<a name='1203'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1204'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='1205'>
                                       its, ite, jts, jte, kts, kte <a name='1206'>
<a name='1207'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) :: phb, ph<a name='1208'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(  OUT) :: php<a name='1209'>
<a name='1210'>
   <font color=#447700>! Local stuff<a name='1211'></font>
<a name='1212'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='1213'>
<a name='1214'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1215'></font>
<font color=#447700>!<a name='1216'></font>
<font color=#447700>!  calc_php calculates the full geopotential from the reference state<a name='1217'></font>
<font color=#447700>!  geopotential and the perturbation geopotential (phb_ph).<a name='1218'></font>
<font color=#447700>!<a name='1219'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1220'></font>
<a name='1221'>
      itf=MIN(ite,ide-1)<a name='1222'>
      jtf=MIN(jte,jde-1)<a name='1223'>
      ktf=MIN(kte,kde-1)<a name='1224'>
<a name='1225'>
      DO j=jts,jtf<a name='1226'>
      DO k=kts,ktf<a name='1227'>
      DO i=its,itf<a name='1228'>
        php(i,k,j) = 0.5*(phb(i,k,j)+phb(i,k+1,j)+ph(i,k,j)+ph(i,k+1,j))<a name='1229'>
      ENDDO<a name='1230'>
      ENDDO<a name='1231'>
      ENDDO<a name='1232'>
<a name='1233'>
END SUBROUTINE calc_php<a name='1234'>
<a name='1235'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1236'></font>
<a name='1237'>
<A NAME='DIAGNOSE_W'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DIAGNOSE_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1238'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>diagnose_w</font>( ph_tend, ph_new, ph_old, w, mu, dt,  &amp; <A href='../../call_to/DIAGNOSE_W.html' TARGET='index'>9</A><a name='1239'>
                       u, v, ht,                            &amp;<a name='1240'>
                       cf1, cf2, cf3, rdx, rdy, msft,       &amp;<a name='1241'>
                       ids, ide, jds, jde, kds, kde,        &amp;<a name='1242'>
                       ims, ime, jms, jme, kms, kme,        &amp;<a name='1243'>
                       its, ite, jts, jte, kts, kte        )<a name='1244'>
<a name='1245'>
   IMPLICIT NONE<a name='1246'>
<a name='1247'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1248'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='1249'>
                                       its, ite, jts, jte, kts, kte <a name='1250'>
<a name='1251'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) ::   ph_tend, &amp;<a name='1252'>
                                                                     ph_new,  &amp;<a name='1253'>
                                                                     ph_old,  &amp;<a name='1254'>
                                                                     u,       &amp;<a name='1255'>
                                                                     v<a name='1256'>
<a name='1257'>
<a name='1258'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(  OUT) :: w<a name='1259'>
<a name='1260'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: mu, ht, msft<a name='1261'>
<a name='1262'>
   REAL, INTENT(IN   ) :: dt, cf1, cf2, cf3, rdx, rdy<a name='1263'>
<a name='1264'>
   INTEGER :: i, j, k, itf, jtf<a name='1265'>
<a name='1266'>
   itf=MIN(ite,ide-1)<a name='1267'>
   jtf=MIN(jte,jde-1)<a name='1268'>
<a name='1269'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1270'></font>
<font color=#447700>!<a name='1271'></font>
<font color=#447700>! diagnose_w diagnoses the vertical velocity from the geopoential equation.<a name='1272'></font>
<font color=#447700>! Used with the hydrostatic option.<a name='1273'></font>
<font color=#447700>!<a name='1274'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1275'></font>
<a name='1276'>
   DO j = jts, jtf<a name='1277'>
<a name='1278'>
<font color=#447700>!  lower b.c. on w<a name='1279'></font>
<a name='1280'>
     DO i = its, itf<a name='1281'>
         w(i,1,j)=  msft(i,j)*(                              &amp;<a name='1282'>
                  .5*rdy*(                                   &amp;<a name='1283'>
                           (ht(i,j+1)-ht(i,j  ))             &amp;<a name='1284'>
          *(cf1*v(i,1,j+1)+cf2*v(i,2,j+1)+cf3*v(i,3,j+1))    &amp;<a name='1285'>
                          +(ht(i,j  )-ht(i,j-1))             &amp;<a name='1286'>
          *(cf1*v(i,1,j  )+cf2*v(i,2,j  )+cf3*v(i,3,j  ))  ) &amp;<a name='1287'>
                 +.5*rdx*(                                   &amp;<a name='1288'>
                           (ht(i+1,j)-ht(i,j  ))             &amp;<a name='1289'>
          *(cf1*u(i+1,1,j)+cf2*u(i+1,2,j)+cf3*u(i+1,3,j))    &amp;<a name='1290'>
                          +(ht(i,j  )-ht(i,j-1))             &amp;<a name='1291'>
          *(cf1*u(i  ,1,j)+cf2*u(i  ,2,j)+cf3*u(i  ,3,j))  ) &amp;<a name='1292'>
                                                            )<a name='1293'>
     ENDDO<a name='1294'>
<a name='1295'>
<font color=#447700>!  use geopotential equation to diagnose w<a name='1296'></font>
<a name='1297'>
     DO k = 2, kte<a name='1298'>
     DO i = its, itf<a name='1299'>
       w(i,k,j) =  msft(i,j)*(  (ph_new(i,k,j)-ph_old(i,k,j))/dt       &amp;<a name='1300'>
                               - ph_tend(i,k,j)/mu(i,j)        )/g <a name='1301'>
<a name='1302'>
     ENDDO<a name='1303'>
     ENDDO<a name='1304'>
<a name='1305'>
   ENDDO<a name='1306'>
<a name='1307'>
END SUBROUTINE diagnose_w<a name='1308'>
<a name='1309'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1310'></font>
<a name='1311'>
<A NAME='RHS_PH'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#RHS_PH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1312'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>rhs_ph</font>( ph_tend, u, v, ww,               &amp; <A href='../../call_to/RHS_PH.html' TARGET='index'>2</A><a name='1313'>
                   ph, ph_old, phb, w,              &amp;<a name='1314'>
                   mut, muu, muv,                   &amp;<a name='1315'>
                   fnm, fnp,                        &amp;<a name='1316'>
                   rdnw, cfn, cfn1, rdx, rdy, msft, &amp;<a name='1317'>
                   non_hydrostatic,                 &amp;<a name='1318'>
                   config_flags,                    &amp;<a name='1319'>
                   ids, ide, jds, jde, kds, kde,    &amp;<a name='1320'>
                   ims, ime, jms, jme, kms, kme,    &amp;<a name='1321'>
                   its, ite, jts, jte, kts, kte    )<a name='1322'>
   IMPLICIT NONE<a name='1323'>
<a name='1324'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='1325'>
<a name='1326'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1327'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='1328'>
                                       its, ite, jts, jte, kts, kte <a name='1329'>
<a name='1330'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) ::        &amp;<a name='1331'>
                                                                     u,   &amp;<a name='1332'>
                                                                     v,   &amp;<a name='1333'>
                                                                     ww,  &amp;<a name='1334'>
                                                                     ph,  &amp;<a name='1335'>
                                                                     ph_old, &amp;<a name='1336'>
                                                                     phb, &amp; <a name='1337'>
                                                                    w<a name='1338'>
<a name='1339'>
<font color=#447700>! pjj/cray<a name='1340'></font>
<font color=#447700>!  REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(  OUT) :: ph_tend<a name='1341'></font>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(INOUT) :: ph_tend<a name='1342'>
<a name='1343'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: muu, muv, mut, msft<a name='1344'>
<a name='1345'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: rdnw, fnm, fnp<a name='1346'>
<a name='1347'>
   REAL,  INTENT(IN   ) :: cfn, cfn1, rdx, rdy<a name='1348'>
<a name='1349'>
   LOGICAL,  INTENT(IN   )  ::  non_hydrostatic<a name='1350'>
<a name='1351'>
   <font color=#447700>! Local stuff<a name='1352'></font>
<a name='1353'>
   INTEGER :: i, j, k, itf, jtf, ktf, kz, i_start, j_start<a name='1354'>
   REAL    :: ur, ul, ub, vr, vl, vb<a name='1355'>
   REAL, DIMENSION(its:ite,kts:kte) :: wdwn<a name='1356'>
<a name='1357'>
   INTEGER :: advective_order<a name='1358'>
<a name='1359'>
   LOGICAL :: specified<a name='1360'>
<a name='1361'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1362'></font>
<font color=#447700>!<a name='1363'></font>
<font color=#447700>! rhs_ph calculates the large-timestep tendency terms for the geopotential<a name='1364'></font>
<font color=#447700>! equation.  These terms include the advection and "gw".  The geopotential<a name='1365'></font>
<font color=#447700>! equation is cast in advective form, so we don't use the flux form advection<a name='1366'></font>
<font color=#447700>! algorithms here.<a name='1367'></font>
<font color=#447700>!<a name='1368'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1369'></font>
<a name='1370'>
   specified = .false.<a name='1371'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='1372'>
<a name='1373'>
   advective_order = config_flags%h_sca_adv_order <a name='1374'>
<font color=#447700>!   advective_order = 2  !  original configuration (pre Oct 2001)<a name='1375'></font>
<a name='1376'>
   itf=MIN(ite,ide-1)<a name='1377'>
   jtf=MIN(jte,jde-1)<a name='1378'>
   ktf=MIN(kte,kde-1)<a name='1379'>
<a name='1380'>
<font color=#447700>! advective form for the geopotential equation<a name='1381'></font>
<a name='1382'>
   DO j = jts, jtf<a name='1383'>
<a name='1384'>
     DO k = 2, kte<a name='1385'>
     DO i = its, itf<a name='1386'>
          wdwn(i,k) = .5*(ww(i,k,j)+ww(i,k-1,j))*rdnw(k-1)               &amp;<a name='1387'>
                        *(ph(i,k,j)-ph(i,k-1,j)+phb(i,k,j)-phb(i,k-1,j))<a name='1388'>
     ENDDO<a name='1389'>
     ENDDO<a name='1390'>
<a name='1391'>
     DO k = 2, kte-1<a name='1392'>
     DO i = its, itf<a name='1393'>
           ph_tend(i,k,j) = ph_tend(i,k,j)                           &amp;<a name='1394'>
                             - (fnm(k)*wdwn(i,k+1)+fnp(k)*wdwn(i,k))<a name='1395'>
     ENDDO<a name='1396'>
     ENDDO<a name='1397'>
<a name='1398'>
   ENDDO<a name='1399'>
<a name='1400'>
   IF (non_hydrostatic) THEN  <font color=#447700>! add in "gw" term.<a name='1401'></font>
   DO j = jts, jtf            <font color=#447700>! in hydrostatic mode, "gw" will be diagnosed<a name='1402'></font>
                              <font color=#447700>! after the timestep to give us "w"<a name='1403'></font>
     DO i = its, itf<a name='1404'>
        ph_tend(i,kde,j) = 0.<a name='1405'>
     ENDDO<a name='1406'>
<a name='1407'>
     DO k = 2, kte<a name='1408'>
     DO i = its, itf<a name='1409'>
        ph_tend(i,k,j) = ph_tend(i,k,j) + mut(i,j)*g*w(i,k,j)/msft(i,j)<a name='1410'>
     ENDDO<a name='1411'>
     ENDDO<a name='1412'>
<a name='1413'>
   ENDDO<a name='1414'>
<a name='1415'>
   END IF<a name='1416'>
<a name='1417'>
   IF (advective_order &lt;= 2) THEN<a name='1418'>
<a name='1419'>
<font color=#447700>!  y (v) advection<a name='1420'></font>
<a name='1421'>
   i_start = its<a name='1422'>
   j_start = jts<a name='1423'>
   itf=MIN(ite,ide-1)<a name='1424'>
   jtf=MIN(jte,jde-1)<a name='1425'>
<a name='1426'>
   IF ( (config_flags%open_ys) .and. jts == jds ) j_start = jts+1<a name='1427'>
   IF ( (config_flags%open_ye) .and. jte == jde ) jtf = jtf-1<a name='1428'>
<a name='1429'>
   DO j = j_start, jtf<a name='1430'>
<a name='1431'>
     DO k = 2, kte-1<a name='1432'>
     DO i = i_start, itf<a name='1433'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .25*rdy*                       &amp;<a name='1434'>
                 ( muv(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))*               &amp;<a name='1435'>
                  (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))  &amp;<a name='1436'>
                  +muv(i,j  )*(v(i,k,j  )+v(i,k-1,j  ))*               &amp;<a name='1437'>
                  (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1)) )<a name='1438'>
     ENDDO<a name='1439'>
     ENDDO<a name='1440'>
<a name='1441'>
     k = kte<a name='1442'>
     DO i = i_start, itf<a name='1443'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .5*rdy*                         &amp;<a name='1444'>
                  ( muv(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))*    &amp;<a name='1445'>
                   (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))  &amp;<a name='1446'>
                   +muv(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  ))*    &amp;<a name='1447'>
                   (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1)) )<a name='1448'>
     ENDDO<a name='1449'>
<a name='1450'>
   ENDDO<a name='1451'>
<a name='1452'>
<font color=#447700>!  x (u) advection<a name='1453'></font>
<a name='1454'>
   i_start = its<a name='1455'>
   j_start = jts<a name='1456'>
   itf=MIN(ite,ide-1)<a name='1457'>
   jtf=MIN(jte,jde-1)<a name='1458'>
<a name='1459'>
   IF ( (config_flags%open_xs) .and. its == ids ) i_start = its+1<a name='1460'>
   IF ( (config_flags%open_xe) .and. ite == ide ) itf = itf-1<a name='1461'>
<a name='1462'>
   DO j = j_start, jtf<a name='1463'>
<a name='1464'>
     DO k = 2, kte-1<a name='1465'>
     DO i = i_start, itf<a name='1466'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .25*rdx*                        &amp;<a name='1467'>
                 ( muu(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))*                &amp;<a name='1468'>
                  (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))   &amp;<a name='1469'>
                  +muu(i  ,j)*(u(i  ,k,j)+u(i  ,k-1,j))*                &amp;<a name='1470'>
                  (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j)) )<a name='1471'>
     ENDDO<a name='1472'>
     ENDDO<a name='1473'>
 <a name='1474'>
     k = kte<a name='1475'>
     DO i = i_start, itf<a name='1476'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .5*rdx*                         &amp;<a name='1477'>
                  ( muu(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))*    &amp;<a name='1478'>
                   (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))  &amp;<a name='1479'>
                   +muu(i  ,j)*(cfn*u(i  ,k-1,j)+cfn1*u(i  ,k-2,j))*    &amp;<a name='1480'>
                   (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j)) )<a name='1481'>
     ENDDO<a name='1482'>
<a name='1483'>
   ENDDO<a name='1484'>
<a name='1485'>
   ELSE IF (advective_order &lt;= 4) THEN<a name='1486'>
<a name='1487'>
<font color=#447700>!  y (v) advection<a name='1488'></font>
<a name='1489'>
   i_start = its<a name='1490'>
   j_start = jts<a name='1491'>
   itf=MIN(ite,ide-1)<a name='1492'>
   jtf=MIN(jte,jde-1)<a name='1493'>
<a name='1494'>
   IF ( (config_flags%open_ys) .and. jts == jds ) j_start = jts+1<a name='1495'>
   IF ( (config_flags%open_ye) .and. jte == jde ) jtf = jtf-1<a name='1496'>
<a name='1497'>
   DO j = j_start, jtf<a name='1498'>
<a name='1499'>
     DO k = 2, kte-1<a name='1500'>
     DO i = i_start, itf<a name='1501'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .25*rdy*           (          &amp;<a name='1502'>
                 ( muv(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))               &amp;<a name='1503'>
                  +muv(i,j  )*(v(i,k,j  )+v(i,k-1,j  )) )* (1./12.)*( &amp;<a name='1504'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                      &amp;<a name='1505'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                      &amp;<a name='1506'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                    &amp;<a name='1507'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1508'>
<a name='1509'>
<a name='1510'>
     ENDDO<a name='1511'>
     ENDDO<a name='1512'>
<a name='1513'>
     k = kte<a name='1514'>
     DO i = i_start, itf<a name='1515'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .5*rdy*           (                      &amp;<a name='1516'>
                 ( muv(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))               &amp;<a name='1517'>
                  +muv(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  )) )* (1./12.)*( &amp;<a name='1518'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                                 &amp;<a name='1519'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                                 &amp;<a name='1520'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                               &amp;<a name='1521'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1522'>
<a name='1523'>
     ENDDO<a name='1524'>
<a name='1525'>
   ENDDO<a name='1526'>
<a name='1527'>
<a name='1528'>
<font color=#447700>!  x (u) advection<a name='1529'></font>
<a name='1530'>
   i_start = its<a name='1531'>
   j_start = jts<a name='1532'>
   itf=MIN(ite,ide-1)<a name='1533'>
   jtf=MIN(jte,jde-1)<a name='1534'>
<a name='1535'>
   IF ( (config_flags%open_xs) .and. its == ids ) i_start = its+1<a name='1536'>
   IF ( (config_flags%open_xe) .and. ite == ide ) itf = itf-1<a name='1537'>
<a name='1538'>
   DO j = j_start, jtf<a name='1539'>
<a name='1540'>
     DO k = 2, kte-1<a name='1541'>
     DO i = i_start, itf<a name='1542'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .25*rdx*(                     &amp;<a name='1543'>
                 ( muu(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))               &amp;<a name='1544'>
                  +muu(i,j  )*(u(i,k,j  )+u(i,k-1,j  )) )* (1./12.)*( &amp;<a name='1545'>
                    8.*(ph(i+1,k,j)-ph(i-1,k,j))                      &amp;<a name='1546'>
                      -(ph(i+2,k,j)-ph(i-2,k,j))                      &amp;<a name='1547'>
                   +8.*(phb(i+1,k,j)-phb(i-1,k,j))                    &amp;<a name='1548'>
                      -(phb(i+2,k,j)-phb(i-2,k,j))  )   )                <a name='1549'>
     ENDDO<a name='1550'>
     ENDDO<a name='1551'>
 <a name='1552'>
     k = kte<a name='1553'>
     DO i = i_start, itf<a name='1554'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .5*rdx*(                                 &amp;<a name='1555'>
                 ( muu(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))               &amp;<a name='1556'>
                  +muu(i,j  )*(cfn*u(i  ,k-1,j)+cfn1*u(i,k-2,j)) )* (1./12.)*(   &amp;<a name='1557'>
                    8.*(ph(i+1,k,j)-ph(i-1,k,j))                                 &amp;<a name='1558'>
                      -(ph(i+2,k,j)-ph(i-2,k,j))                                 &amp;<a name='1559'>
                   +8.*(phb(i+1,k,j)-phb(i-1,k,j))                               &amp;<a name='1560'>
                      -(phb(i+2,k,j)-phb(i-2,k,j))  )     )<a name='1561'>
     ENDDO<a name='1562'>
<a name='1563'>
   ENDDO<a name='1564'>
<a name='1565'>
   ELSE IF (advective_order &lt;= 6) THEN<a name='1566'>
<a name='1567'>
<font color=#447700>!  y (v) advection<a name='1568'></font>
<a name='1569'>
   i_start = its<a name='1570'>
   j_start = jts<a name='1571'>
   itf=MIN(ite,ide-1)<a name='1572'>
   jtf=MIN(jte,jde-1)<a name='1573'>
<a name='1574'>
<font color=#447700>!   IF ( (config_flags%open_ys) .and. jts == jds ) j_start = jts+1<a name='1575'></font>
<font color=#447700>!   IF ( (config_flags%open_ye) .and. jte == jde ) jtf = jtf-1<a name='1576'></font>
<a name='1577'>
   IF (config_flags%open_ys .or. specified ) j_start = max(jts,jds+2)<a name='1578'>
   IF (config_flags%open_ye .or. specified ) jtf     = min(jtf,jde-3)<a name='1579'>
<a name='1580'>
   DO j = j_start, jtf<a name='1581'>
<a name='1582'>
     DO k = 2, kte-1<a name='1583'>
     DO i = i_start, itf<a name='1584'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .25*rdy* (                    &amp;<a name='1585'>
                 ( muv(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))               &amp;<a name='1586'>
                  +muv(i,j  )*(v(i,k,j  )+v(i,k-1,j  )) )* (1./60.)*( &amp;<a name='1587'>
                   45.*(ph(i,k,j+1)-ph(i,k,j-1))                      &amp;<a name='1588'>
                   -9.*(ph(i,k,j+2)-ph(i,k,j-2))                      &amp;<a name='1589'>
                      +(ph(i,k,j+3)-ph(i,k,j-3))                      &amp;<a name='1590'>
                  +45.*(phb(i,k,j+1)-phb(i,k,j-1))                    &amp;<a name='1591'>
                   -9.*(phb(i,k,j+2)-phb(i,k,j-2))                    &amp;<a name='1592'>
                      +(phb(i,k,j+3)-phb(i,k,j-3))  )   )                <a name='1593'>
<a name='1594'>
<a name='1595'>
     ENDDO<a name='1596'>
     ENDDO<a name='1597'>
<a name='1598'>
     k = kte<a name='1599'>
     DO i = i_start, itf<a name='1600'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .5*rdy* (                                &amp;<a name='1601'>
                 ( muv(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))               &amp;<a name='1602'>
                  +muv(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  )) )* (1./60.)*( &amp;<a name='1603'>
                   45.*(ph(i,k,j+1)-ph(i,k,j-1))                                 &amp;<a name='1604'>
                   -9.*(ph(i,k,j+2)-ph(i,k,j-2))                                 &amp;<a name='1605'>
                      +(ph(i,k,j+3)-ph(i,k,j-3))                                 &amp;<a name='1606'>
                  +45.*(phb(i,k,j+1)-phb(i,k,j-1))                               &amp;<a name='1607'>
                   -9.*(phb(i,k,j+2)-phb(i,k,j-2))                               &amp;<a name='1608'>
                      +(phb(i,k,j+3)-phb(i,k,j-3))  )   )                <a name='1609'>
<a name='1610'>
     ENDDO<a name='1611'>
<a name='1612'>
   ENDDO<a name='1613'>
<a name='1614'>
<a name='1615'>
<font color=#447700>!  pick up near boundary rows using 4th order stencil <a name='1616'></font>
<font color=#447700>!  (open bc copy only goes out to jds-1 and jde, hence 4rth is ok but 6th is too big)<a name='1617'></font>
<a name='1618'>
   IF ( (config_flags%open_ys) .and. jts &lt;= jds+1 )  THEN<a name='1619'>
<a name='1620'>
     j = jds+1<a name='1621'>
     DO k = 2, kte-1<a name='1622'>
     DO i = i_start, itf<a name='1623'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .25*rdy* (                    &amp;<a name='1624'>
                 ( muv(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))               &amp;<a name='1625'>
                  +muv(i,j  )*(v(i,k,j  )+v(i,k-1,j  )) )* (1./12.)*( &amp;<a name='1626'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                      &amp;<a name='1627'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                      &amp;<a name='1628'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                    &amp;<a name='1629'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1630'>
<a name='1631'>
<a name='1632'>
     ENDDO<a name='1633'>
     ENDDO<a name='1634'>
<a name='1635'>
     k = kte<a name='1636'>
     DO i = i_start, itf<a name='1637'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .5*rdy* (                                &amp;<a name='1638'>
                 ( muv(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))               &amp;<a name='1639'>
                  +muv(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  )) )* (1./12.)*( &amp;<a name='1640'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                                 &amp;<a name='1641'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                                 &amp;<a name='1642'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                               &amp;<a name='1643'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1644'>
<a name='1645'>
     ENDDO<a name='1646'>
<a name='1647'>
   END IF<a name='1648'>
<a name='1649'>
   IF ( (config_flags%open_ye) .and. jte &gt;= jde-2 )  THEN<a name='1650'>
<a name='1651'>
     j = jde-2<a name='1652'>
     DO k = 2, kte-1<a name='1653'>
     DO i = i_start, itf<a name='1654'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .25*rdy* (                    &amp;<a name='1655'>
                 ( muv(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))               &amp;<a name='1656'>
                  +muv(i,j  )*(v(i,k,j  )+v(i,k-1,j  )) )* (1./12.)*( &amp;<a name='1657'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                      &amp;<a name='1658'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                      &amp;<a name='1659'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                    &amp;<a name='1660'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1661'>
<a name='1662'>
<a name='1663'>
     ENDDO<a name='1664'>
     ENDDO<a name='1665'>
<a name='1666'>
     k = kte<a name='1667'>
     DO i = i_start, itf<a name='1668'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .5*rdy* (                                &amp;<a name='1669'>
                 ( muv(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))               &amp;<a name='1670'>
                  +muv(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  )) )* (1./12.)*( &amp;<a name='1671'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                                 &amp;<a name='1672'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                                 &amp;<a name='1673'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                               &amp;<a name='1674'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1675'>
<a name='1676'>
     ENDDO<a name='1677'>
<a name='1678'>
   END IF<a name='1679'>
<a name='1680'>
<font color=#447700>!  x (u) advection<a name='1681'></font>
<a name='1682'>
   i_start = its<a name='1683'>
   j_start = jts<a name='1684'>
   itf=MIN(ite,ide-1)<a name='1685'>
   jtf=MIN(jte,jde-1)<a name='1686'>
<a name='1687'>
   IF (config_flags%open_xs .or. specified ) i_start = max(its,ids+2)<a name='1688'>
   IF (config_flags%open_xe .or. specified ) itf     = min(itf,ide-3)<a name='1689'>
<a name='1690'>
   DO j = j_start, jtf<a name='1691'>
<a name='1692'>
     DO k = 2, kte-1<a name='1693'>
     DO i = i_start, itf<a name='1694'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .25*rdx*(                     &amp;<a name='1695'>
                 ( muu(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))               &amp;<a name='1696'>
                  +muu(i,j  )*(u(i,k,j  )+u(i,k-1,j  )) )* (1./60.)*( &amp;<a name='1697'>
                   45.*(ph(i+1,k,j)-ph(i-1,k,j))                      &amp;<a name='1698'>
                   -9.*(ph(i+2,k,j)-ph(i-2,k,j))                      &amp;<a name='1699'>
                      +(ph(i+3,k,j)-ph(i-3,k,j))                      &amp;<a name='1700'>
                  +45.*(phb(i+1,k,j)-phb(i-1,k,j))                    &amp;<a name='1701'>
                   -9.*(phb(i+2,k,j)-phb(i-2,k,j))                    &amp;<a name='1702'>
                      +(phb(i+3,k,j)-phb(i-3,k,j))  )   )                <a name='1703'>
     ENDDO<a name='1704'>
     ENDDO<a name='1705'>
 <a name='1706'>
     k = kte<a name='1707'>
     DO i = i_start, itf<a name='1708'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .5*rdx*(                                 &amp;<a name='1709'>
                 ( muu(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))               &amp;<a name='1710'>
                  +muu(i,j  )*(cfn*u(i  ,k-1,j)+cfn1*u(i,k-2,j)) )* (1./60.)*(   &amp;<a name='1711'>
                   45.*(ph(i+1,k,j)-ph(i-1,k,j))                                 &amp;<a name='1712'>
                   -9.*(ph(i+2,k,j)-ph(i-2,k,j))                                 &amp;<a name='1713'>
                      +(ph(i+3,k,j)-ph(i-3,k,j))                                 &amp;<a name='1714'>
                  +45.*(phb(i+1,k,j)-phb(i-1,k,j))                               &amp;<a name='1715'>
                   -9.*(phb(i+2,k,j)-phb(i-2,k,j))                               &amp;<a name='1716'>
                      +(phb(i+3,k,j)-phb(i-3,k,j))  )     )<a name='1717'>
     ENDDO<a name='1718'>
<a name='1719'>
   ENDDO<a name='1720'>
<a name='1721'>
   IF ( (config_flags%open_xs) .and. its &lt;= ids+1 ) THEN<a name='1722'>
     i = ids + 1<a name='1723'>
     DO j = j_start, jtf<a name='1724'>
       DO k = 2, kte-1<a name='1725'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .25*rdx*(                     &amp;<a name='1726'>
                 ( muu(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))               &amp;<a name='1727'>
                  +muu(i,j  )*(u(i,k,j  )+u(i,k-1,j  )) )* (1./12.)*( &amp;<a name='1728'>
                    8.*(ph(i+1,k,j)-ph(i-1,k,j))                      &amp;<a name='1729'>
                      -(ph(i+2,k,j)-ph(i-2,k,j))                      &amp;<a name='1730'>
                   +8.*(phb(i+1,k,j)-phb(i-1,k,j))                    &amp;<a name='1731'>
                      -(phb(i+2,k,j)-phb(i-2,k,j))  )   )                <a name='1732'>
       ENDDO<a name='1733'>
       k = kte<a name='1734'>
       ph_tend(i,k,j)=ph_tend(i,k,j) - .5*rdx*(                                 &amp;<a name='1735'>
                ( muu(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))               &amp;<a name='1736'>
                 +muu(i,j  )*(cfn*u(i  ,k-1,j)+cfn1*u(i,k-2,j)) )* (1./12.)*(   &amp;<a name='1737'>
                   8.*(ph(i+1,k,j)-ph(i-1,k,j))                                 &amp;<a name='1738'>
                     -(ph(i+2,k,j)-ph(i-2,k,j))                                 &amp;<a name='1739'>
                  +8.*(phb(i+1,k,j)-phb(i-1,k,j))                               &amp;<a name='1740'>
                     -(phb(i+2,k,j)-phb(i-2,k,j))  )     )<a name='1741'>
<a name='1742'>
     ENDDO<a name='1743'>
   END IF<a name='1744'>
<a name='1745'>
   IF ( (config_flags%open_xe) .and. ite &gt;= ide-2 ) THEN<a name='1746'>
     i = ide-2<a name='1747'>
     DO j = j_start, jtf<a name='1748'>
       DO k = 2, kte-1<a name='1749'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - .25*rdx*(                     &amp;<a name='1750'>
                 ( muu(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))               &amp;<a name='1751'>
                  +muu(i,j  )*(u(i,k,j  )+u(i,k-1,j  )) )* (1./12.)*( &amp;<a name='1752'>
                    8.*(ph(i+1,k,j)-ph(i-1,k,j))                      &amp;<a name='1753'>
                      -(ph(i+2,k,j)-ph(i-2,k,j))                      &amp;<a name='1754'>
                   +8.*(phb(i+1,k,j)-phb(i-1,k,j))                    &amp;<a name='1755'>
                      -(phb(i+2,k,j)-phb(i-2,k,j))  )   )                <a name='1756'>
       ENDDO<a name='1757'>
       k = kte<a name='1758'>
       ph_tend(i,k,j)=ph_tend(i,k,j) - .5*rdx*(                                 &amp;<a name='1759'>
                ( muu(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))               &amp;<a name='1760'>
                 +muu(i,j  )*(cfn*u(i  ,k-1,j)+cfn1*u(i,k-2,j)) )* (1./12.)*(   &amp;<a name='1761'>
                   8.*(ph(i+1,k,j)-ph(i-1,k,j))                                 &amp;<a name='1762'>
                     -(ph(i+2,k,j)-ph(i-2,k,j))                                 &amp;<a name='1763'>
                  +8.*(phb(i+1,k,j)-phb(i-1,k,j))                               &amp;<a name='1764'>
                     -(phb(i+2,k,j)-phb(i-2,k,j))  )     )<a name='1765'>
<a name='1766'>
     ENDDO<a name='1767'>
   END IF<a name='1768'>
<a name='1769'>
   END IF<a name='1770'>
<a name='1771'>
<font color=#447700>!  lateral open boundary conditions,<a name='1772'></font>
<font color=#447700>!  start with north and south (y) boundaries<a name='1773'></font>
<a name='1774'>
   i_start = its<a name='1775'>
   itf=MIN(ite,ide-1)<a name='1776'>
<a name='1777'>
   <font color=#447700>!  south<a name='1778'></font>
<a name='1779'>
   IF ( (config_flags%open_ys) .and. jts == jds ) THEN<a name='1780'>
<a name='1781'>
     j=jts<a name='1782'>
<a name='1783'>
     DO k=2,kde<a name='1784'>
       kz = min(k,kde-1)<a name='1785'>
       DO i = its,itf<a name='1786'>
         vb =.5*( fnm(kz)*(v(i,kz  ,j+1)+v(i,kz  ,j  ))    &amp;<a name='1787'>
                 +fnp(kz)*(v(i,kz-1,j+1)+v(i,kz-1,j  )) )<a name='1788'>
         vl=amin1(vb,0.)<a name='1789'>
         ph_tend(i,k,j)=ph_tend(i,k,j)-rdy*mut(i,j)*(      &amp;<a name='1790'>
                              +vl*(ph_old(i,k,j+1)-ph_old(i,k,j)))<a name='1791'>
       ENDDO<a name='1792'>
     ENDDO<a name='1793'>
<a name='1794'>
   END IF<a name='1795'>
<a name='1796'>
   <font color=#447700>! north<a name='1797'></font>
<a name='1798'>
   IF ( (config_flags%open_ye) .and. jte == jde ) THEN<a name='1799'>
<a name='1800'>
     j=jte-1<a name='1801'>
<a name='1802'>
     DO k=2,kde<a name='1803'>
       kz = min(k,kde-1)<a name='1804'>
       DO i = its,itf<a name='1805'>
        vb=.5*( fnm(kz)*(v(i,kz  ,j+1)+v(i,kz  ,j))   &amp;<a name='1806'>
               +fnp(kz)*(v(i,kz-1,j+1)+v(i,kz-1,j)) )<a name='1807'>
        vr=amax1(vb,0.)<a name='1808'>
        ph_tend(i,k,j)=ph_tend(i,k,j)-rdy*mut(i,j)*(      &amp;<a name='1809'>
                   +vr*(ph_old(i,k,j)-ph_old(i,k,j-1)))<a name='1810'>
       ENDDO<a name='1811'>
     ENDDO<a name='1812'>
<a name='1813'>
   END IF<a name='1814'>
<a name='1815'>
   <font color=#447700>!  now the east and west (y) boundaries<a name='1816'></font>
<a name='1817'>
   j_start = its<a name='1818'>
   jtf=MIN(jte,jde-1)<a name='1819'>
<a name='1820'>
   <font color=#447700>!  west<a name='1821'></font>
<a name='1822'>
   IF ( (config_flags%open_xs) .and. its == ids ) THEN<a name='1823'>
<a name='1824'>
     i=its<a name='1825'>
<a name='1826'>
     DO j = jts,jtf<a name='1827'>
       DO k=2,kde-1<a name='1828'>
         kz = k<a name='1829'>
         ub =.5*( fnm(kz)*(u(i+1,kz  ,j)+u(i  ,kz  ,j))     &amp;<a name='1830'>
                 +fnp(kz)*(u(i+1,kz-1,j)+u(i  ,kz-1,j)) )<a name='1831'>
         ul=amin1(ub,0.)<a name='1832'>
         ph_tend(i,k,j)=ph_tend(i,k,j)-rdx*mut(i,j)*(       &amp;<a name='1833'>
                              +ul*(ph_old(i+1,k,j)-ph_old(i,k,j)))<a name='1834'>
       ENDDO<a name='1835'>
<a name='1836'>
         k = kde<a name='1837'>
         kz = k<a name='1838'>
         ub =.5*( fnm(kz)*(u(i+1,kz  ,j)+u(i  ,kz  ,j))     &amp;<a name='1839'>
                 +fnp(kz)*(u(i+1,kz-1,j)+u(i  ,kz-1,j)) )<a name='1840'>
         ul=amin1(ub,0.)<a name='1841'>
         ph_tend(i,k,j)=ph_tend(i,k,j)-rdx*mut(i,j)*(       &amp;<a name='1842'>
                              +ul*(ph_old(i+1,k,j)-ph_old(i,k,j)))<a name='1843'>
     ENDDO<a name='1844'>
<a name='1845'>
   END IF<a name='1846'>
<a name='1847'>
   <font color=#447700>! east<a name='1848'></font>
<a name='1849'>
   IF ( (config_flags%open_xe) .and. ite == ide ) THEN<a name='1850'>
<a name='1851'>
     i = ite-1<a name='1852'>
<a name='1853'>
     DO j = jts,jtf<a name='1854'>
       DO k=2,kde-1<a name='1855'>
        kz = k<a name='1856'>
        ub=.5*( fnm(kz)*(u(i+1,kz  ,j)+u(i,kz  ,j))  &amp;<a name='1857'>
               +fnp(kz)*(u(i+1,kz-1,j)+u(i,kz-1,j)) )<a name='1858'>
        ur=amax1(ub,0.)<a name='1859'>
        ph_tend(i,k,j)=ph_tend(i,k,j)-rdx*mut(i,j)*( &amp;<a name='1860'>
                   +ur*(ph_old(i,k,j)-ph_old(i-1,k,j)))<a name='1861'>
       ENDDO<a name='1862'>
<a name='1863'>
        k = kde    <a name='1864'>
        kz = k-1<a name='1865'>
        ub=.5*( fnm(kz)*(u(i+1,kz  ,j)+u(i,kz  ,j))   &amp;<a name='1866'>
               +fnp(kz)*(u(i+1,kz-1,j)+u(i,kz-1,j)) )<a name='1867'>
        ur=amax1(ub,0.)<a name='1868'>
        ph_tend(i,k,j)=ph_tend(i,k,j)-rdx*mut(i,j)*(  &amp;<a name='1869'>
                   +ur*(ph_old(i,k,j)-ph_old(i-1,k,j)))<a name='1870'>
<a name='1871'>
     ENDDO<a name='1872'>
<a name='1873'>
   END IF<a name='1874'>
<a name='1875'>
  END SUBROUTINE rhs_ph<a name='1876'>
<a name='1877'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1878'></font>
<a name='1879'>
<A NAME='HORIZONTAL_PRESSURE_GRADIENT'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_PRESSURE_GRADIENT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1880'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_pressure_gradient</font>( ru_tend,rv_tend,                &amp; <A href='../../call_to/HORIZONTAL_PRESSURE_GRADIENT.html' TARGET='index'>1</A><a name='1881'>
                                         ph,alt,p,pb,al,php,cqu,cqv,     &amp;<a name='1882'>
                                         muu,muv,mu,fnm,fnp,rdnw,        &amp;<a name='1883'>
                                         cf1,cf2,cf3,rdx,rdy,msft,       &amp;<a name='1884'>
                                         config_flags, non_hydrostatic,  &amp;<a name='1885'>
                                         ids, ide, jds, jde, kds, kde,   &amp;<a name='1886'>
                                         ims, ime, jms, jme, kms, kme,   &amp;<a name='1887'>
                                         its, ite, jts, jte, kts, kte   )<a name='1888'>
<a name='1889'>
   IMPLICIT NONE<a name='1890'>
   <a name='1891'>
   <font color=#447700>! Input data<a name='1892'></font>
<a name='1893'>
<a name='1894'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='1895'>
<a name='1896'>
   LOGICAL, INTENT (IN   ) :: non_hydrostatic<a name='1897'>
<a name='1898'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1899'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='1900'>
                                       its, ite, jts, jte, kts, kte <a name='1901'>
<a name='1902'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) ::        &amp;<a name='1903'>
                                                                     ph,  &amp;<a name='1904'>
                                                                     alt, &amp;<a name='1905'>
                                                                     al,  &amp;<a name='1906'>
                                                                     p,   &amp;<a name='1907'>
                                                                     pb,  &amp;<a name='1908'>
                                                                     php, &amp;<a name='1909'>
                                                                     cqu, &amp;<a name='1910'>
                                                                     cqv<a name='1911'>
<a name='1912'>
<a name='1913'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(INOUT) ::           &amp;<a name='1914'>
                                                                    ru_tend, &amp;<a name='1915'>
                                                                    rv_tend<a name='1916'>
<a name='1917'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: muu, muv, mu, msft<a name='1918'>
<a name='1919'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: rdnw, fnm, fnp<a name='1920'>
<a name='1921'>
   REAL,  INTENT(IN   ) :: rdx, rdy, cf1, cf2, cf3<a name='1922'>
<a name='1923'>
   INTEGER :: i,j,k, itf, jtf, ktf, i_start, j_start<a name='1924'>
   REAL, DIMENSION( ims:ime, kms:kme ) :: dpn<a name='1925'>
   REAL :: dpx, dpy<a name='1926'>
<a name='1927'>
   LOGICAL :: specified<a name='1928'>
<a name='1929'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1930'></font>
<font color=#447700>!<a name='1931'></font>
<font color=#447700>!  horizontal_pressure_gradient calculates the <a name='1932'></font>
<font color=#447700>!  horizontal pressure gradient terms for the large-timestep tendency <a name='1933'></font>
<font color=#447700>!  in the horizontal momentum equations (u,v).<a name='1934'></font>
<font color=#447700>!<a name='1935'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1936'></font>
<a name='1937'>
   specified = .false.<a name='1938'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='1939'>
<a name='1940'>
<font color=#447700>! start with the north-south (y) pressure gradient<a name='1941'></font>
<a name='1942'>
   itf=MIN(ite,ide-1)<a name='1943'>
   jtf=jte<a name='1944'>
   ktf=MIN(kte,kde-1)<a name='1945'>
   i_start = its<a name='1946'>
   j_start = jts<a name='1947'>
   IF ( (config_flags%open_ys .or. specified .or. &amp;<a name='1948'>
           config_flags%nested ) .and. jts == jds ) j_start = jts+1<a name='1949'>
   IF ( (config_flags%open_ye .or. specified .or. &amp;<a name='1950'>
           config_flags%nested ) .and. jte == jde ) jtf = jtf-1<a name='1951'>
<a name='1952'>
   DO j = j_start, jtf<a name='1953'>
<a name='1954'>
     IF ( non_hydrostatic )  THEN<a name='1955'>
<a name='1956'>
        k=1<a name='1957'>
<a name='1958'>
        DO i = i_start, itf<a name='1959'>
          dpn(i,k) = .5*( cf1*(p(i,k  ,j-1)+p(i,k  ,j))   &amp;<a name='1960'>
                         +cf2*(p(i,k+1,j-1)+p(i,k+1,j))   &amp;<a name='1961'>
                         +cf3*(p(i,k+2,j-1)+p(i,k+2,j))  )<a name='1962'>
          dpn(i,kde) = 0.<a name='1963'>
        ENDDO<a name='1964'>
               <a name='1965'>
        DO k=2,ktf<a name='1966'>
          DO i = i_start, itf<a name='1967'>
            dpn(i,k) = .5*( fnm(k)*(p(i,k  ,j-1)+p(i,k  ,j))  &amp;<a name='1968'>
                           +fnp(k)*(p(i,k-1,j-1)+p(i,k-1,j)) )<a name='1969'>
          END DO<a name='1970'>
        END DO<a name='1971'>
<a name='1972'>
        DO K=1,ktf<a name='1973'>
          DO i = i_start, itf<a name='1974'>
            dpy = .5*rdy*muv(i,j)*(                                            &amp;<a name='1975'>
                     (ph (i,k+1,j)-ph (i,k+1,j-1) + ph(i,k,j)-ph(i,k,j-1))  &amp;<a name='1976'>
                    +(alt(i,k  ,j)+alt(i,k  ,j-1))*(p (i,k,j)-p (i,k,j-1))  &amp;<a name='1977'>
                    +(al (i,k  ,j)+al (i,k  ,j-1))*(pb(i,k,j)-pb(i,k,j-1)) )<a name='1978'>
            dpy = dpy + rdy*(php(i,k,j)-php(i,k,j-1))*              &amp;<a name='1979'>
                (rdnw(k)*(dpn(i,k+1)-dpn(i,k))-.5*(mu(i,j-1)+mu(i,j)))<a name='1980'>
            rv_tend(i,k,j) = rv_tend(i,k,j)-cqv(i,k,j)*dpy<a name='1981'>
          END DO<a name='1982'>
        END DO<a name='1983'>
<a name='1984'>
     ELSE<a name='1985'>
<a name='1986'>
        DO K=1,ktf<a name='1987'>
          DO i = i_start, itf<a name='1988'>
            dpy = .5*rdy*muv(i,j)*(                                            &amp;<a name='1989'>
                     (ph (i,k+1,j)-ph (i,k+1,j-1) + ph(i,k,j)-ph(i,k,j-1))  &amp;<a name='1990'>
                    +(alt(i,k  ,j)+alt(i,k  ,j-1))*(p (i,k,j)-p (i,k,j-1))  &amp;<a name='1991'>
                    +(al (i,k  ,j)+al (i,k  ,j-1))*(pb(i,k,j)-pb(i,k,j-1)) )<a name='1992'>
            rv_tend(i,k,j) = rv_tend(i,k,j)-cqv(i,k,j)*dpy<a name='1993'>
          END DO<a name='1994'>
        END DO<a name='1995'>
<a name='1996'>
     END IF<a name='1997'>
<a name='1998'>
   ENDDO<a name='1999'>
<a name='2000'>
<font color=#447700>!  now the east-west (x) pressure gradient<a name='2001'></font>
<a name='2002'>
   itf=ite<a name='2003'>
   jtf=MIN(jte,jde-1)<a name='2004'>
   ktf=MIN(kte,kde-1)<a name='2005'>
   i_start = its<a name='2006'>
   j_start = jts<a name='2007'>
   IF ( (config_flags%open_xs .or. specified .or. &amp;<a name='2008'>
           config_flags%nested ) .and. its == ids ) i_start = its+1<a name='2009'>
   IF ( (config_flags%open_xe .or. specified .or. &amp;<a name='2010'>
           config_flags%nested ) .and. ite == ide ) itf = itf-1<a name='2011'>
<a name='2012'>
   DO j = j_start, jtf<a name='2013'>
<a name='2014'>
     IF ( non_hydrostatic )  THEN<a name='2015'>
<a name='2016'>
        k=1<a name='2017'>
<a name='2018'>
        DO i = i_start, itf<a name='2019'>
          dpn(i,k) = .5*( cf1*(p(i-1,k  ,j)+p(i,k  ,j))   &amp;<a name='2020'>
                         +cf2*(p(i-1,k+1,j)+p(i,k+1,j))   &amp;<a name='2021'>
                         +cf3*(p(i-1,k+2,j)+p(i,k+2,j))  )<a name='2022'>
          dpn(i,kde) = 0.<a name='2023'>
        ENDDO<a name='2024'>
               <a name='2025'>
        DO k=2,ktf<a name='2026'>
          DO i = i_start, itf<a name='2027'>
            dpn(i,k) = .5*( fnm(k)*(p(i-1,k  ,j)+p(i,k  ,j))  &amp;<a name='2028'>
                           +fnp(k)*(p(i-1,k-1,j)+p(i,k-1,j)) )<a name='2029'>
          END DO<a name='2030'>
        END DO<a name='2031'>
<a name='2032'>
        DO K=1,ktf<a name='2033'>
          DO i = i_start, itf<a name='2034'>
            dpx = .5*rdx*muu(i,j)*(                                            &amp;<a name='2035'>
                        (ph (i,k+1,j)-ph (i-1,k+1,j) + ph(i,k,j)-ph(i-1,k,j))  &amp;<a name='2036'>
                       +(alt(i,k  ,j)+alt(i-1,k  ,j))*(p (i,k,j)-p (i-1,k,j))  &amp;<a name='2037'>
                       +(al (i,k  ,j)+al (i-1,k  ,j))*(pb(i,k,j)-pb(i-1,k,j)) )<a name='2038'>
            dpx = dpx + rdx*(php(i,k,j)-php(i-1,k,j))*              &amp;<a name='2039'>
                (rdnw(k)*(dpn(i,k+1)-dpn(i,k))-.5*(mu(i-1,j)+mu(i,j)))<a name='2040'>
            ru_tend(i,k,j) = ru_tend(i,k,j)-cqu(i,k,j)*dpx<a name='2041'>
          END DO<a name='2042'>
        END DO<a name='2043'>
<a name='2044'>
     ELSE<a name='2045'>
<a name='2046'>
        DO K=1,ktf<a name='2047'>
          DO i = i_start, itf<a name='2048'>
            dpx = .5*rdx*muu(i,j)*(                                            &amp;<a name='2049'>
                        (ph (i,k+1,j)-ph (i-1,k+1,j) + ph(i,k,j)-ph(i-1,k,j))  &amp;<a name='2050'>
                       +(alt(i,k  ,j)+alt(i-1,k  ,j))*(p (i,k,j)-p (i-1,k,j))  &amp;<a name='2051'>
                       +(al (i,k  ,j)+al (i-1,k  ,j))*(pb(i,k,j)-pb(i-1,k,j)) )<a name='2052'>
            ru_tend(i,k,j) = ru_tend(i,k,j)-cqu(i,k,j)*dpx<a name='2053'>
          END DO<a name='2054'>
        END DO<a name='2055'>
<a name='2056'>
     END IF<a name='2057'>
<a name='2058'>
   ENDDO<a name='2059'>
<a name='2060'>
END SUBROUTINE horizontal_pressure_gradient<a name='2061'>
<a name='2062'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2063'></font>
<a name='2064'>
<A NAME='PG_BUOY_W'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PG_BUOY_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2065'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>pg_buoy_w</font>( rw_tend, p, cqw, mu, mub,       &amp; <A href='../../call_to/PG_BUOY_W.html' TARGET='index'>1</A><a name='2066'>
                      rdnw, rdn, g, msft,             &amp;<a name='2067'>
                      ids, ide, jds, jde, kds, kde,   &amp;<a name='2068'>
                      ims, ime, jms, jme, kms, kme,   &amp;<a name='2069'>
                      its, ite, jts, jte, kts, kte   )<a name='2070'>
<a name='2071'>
   IMPLICIT NONE<a name='2072'>
   <a name='2073'>
   <font color=#447700>! Input data<a name='2074'></font>
<a name='2075'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2076'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='2077'>
                                       its, ite, jts, jte, kts, kte <a name='2078'>
<a name='2079'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) ::   p<a name='2080'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(INOUT) ::   cqw<a name='2081'>
<a name='2082'>
<a name='2083'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(INOUT) ::  rw_tend<a name='2084'>
<a name='2085'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: mub, mu, msft<a name='2086'>
<a name='2087'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: rdnw, rdn<a name='2088'>
<a name='2089'>
   REAL,  INTENT(IN   ) :: g<a name='2090'>
<a name='2091'>
   INTEGER :: itf, jtf, i, j, k<a name='2092'>
   REAL    :: cq1, cq2<a name='2093'>
<a name='2094'>
<a name='2095'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2096'></font>
<font color=#447700>!<a name='2097'></font>
<font color=#447700>!  pg_buoy_w calculates the <a name='2098'></font>
<font color=#447700>!  vertical pressure gradient and buoyancy terms for the large-timestep <a name='2099'></font>
<font color=#447700>!  tendency in the vertical momentum equation.<a name='2100'></font>
<font color=#447700>!<a name='2101'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2102'></font>
<a name='2103'>
<font color=#447700>!  BUOYANCY AND PRESSURE GRADIENT TERM IN W EQUATION AT TIME T<a name='2104'></font>
<a name='2105'>
   itf=MIN(ite,ide-1)<a name='2106'>
   jtf=MIN(jte,jde-1)<a name='2107'>
<a name='2108'>
   DO j = jts,jtf<a name='2109'>
<a name='2110'>
     k=kde<a name='2111'>
     DO i=its,itf<a name='2112'>
       cq1 = 1./(1.+cqw(i,k-1,j))<a name='2113'>
       cq2 = cqw(i,k-1,j)*cq1<a name='2114'>
       rw_tend(i,k,j) = rw_tend(i,k,j)+(1./msft(i,j))*g*(      &amp;<a name='2115'>
                        cq1*2.*rdnw(k-1)*(  -p(i,k-1,j))  &amp;<a name='2116'>
                        -mu(i,j)-cq2*mub(i,j)            )<a name='2117'>
     END DO<a name='2118'>
<a name='2119'>
     DO k = 2, kde-1<a name='2120'>
     DO i = its,itf<a name='2121'>
      cq1 = 1./(1.+cqw(i,k,j))<a name='2122'>
      cq2 = cqw(i,k,j)*cq1<a name='2123'>
      cqw(i,k,j) = cq1<a name='2124'>
      rw_tend(i,k,j) = rw_tend(i,k,j)+(1./msft(i,j))*g*(      &amp;<a name='2125'>
                       cq1*rdn(k)*(p(i,k,j)-p(i,k-1,j))  &amp;<a name='2126'>
                       -mu(i,j)-cq2*mub(i,j)            )<a name='2127'>
     END DO<a name='2128'>
     ENDDO           <a name='2129'>
<a name='2130'>
<a name='2131'>
   ENDDO<a name='2132'>
<a name='2133'>
END SUBROUTINE pg_buoy_w<a name='2134'>
<a name='2135'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2136'></font>
<a name='2137'>
<A NAME='W_DAMP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#W_DAMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2138'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>w_damp</font>( rw_tend, ww, w, mut, rdnw, dt,     &amp; <A href='../../call_to/W_DAMP.html' TARGET='index'>1</A><a name='2139'>
                      ids, ide, jds, jde, kds, kde,   &amp;<a name='2140'>
                      ims, ime, jms, jme, kms, kme,   &amp;<a name='2141'>
                      its, ite, jts, jte, kts, kte   )<a name='2142'>
<a name='2143'>
   IMPLICIT NONE<a name='2144'>
<a name='2145'>
   <font color=#447700>! Input data<a name='2146'></font>
<a name='2147'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2148'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='2149'>
                                       its, ite, jts, jte, kts, kte<a name='2150'>
<a name='2151'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) ::   ww, w<a name='2152'>
<a name='2153'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(INOUT) ::  rw_tend<a name='2154'>
<a name='2155'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: mut<a name='2156'>
<a name='2157'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: rdnw<a name='2158'>
<a name='2159'>
   REAL, INTENT(IN)    :: dt<a name='2160'>
   REAL                :: cfl, cf_n, cf_d<a name='2161'>
<a name='2162'>
   INTEGER :: itf, jtf, i, j, k<a name='2163'>
<a name='2164'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2165'></font>
<font color=#447700>!<a name='2166'></font>
<font color=#447700>!  w_damp computes a damping term for the vertical velocity when the<a name='2167'></font>
<font color=#447700>!  vertical Courant number is too large.  This was found to be preferable to <a name='2168'></font>
<font color=#447700>!  decreasing the timestep or increasing the diffusion in real-data applications<a name='2169'></font>
<font color=#447700>!  that produced potentially-unstable large vertical velocities because of<a name='2170'></font>
<font color=#447700>!  unphysically large heating rates coming from the cumulus parameterization <a name='2171'></font>
<font color=#447700>!  schemes run at moderately high resolutions (dx ~ O(10) km).<a name='2172'></font>
<font color=#447700>!<a name='2173'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2174'></font>
<a name='2175'>
   itf=MIN(ite,ide-1)<a name='2176'>
   jtf=MIN(jte,jde-1)<a name='2177'>
<a name='2178'>
   DO j = jts,jtf<a name='2179'>
<a name='2180'>
     DO k = 2, kde-1<a name='2181'>
     DO i = its,itf<a name='2182'>
#if 0<a name='2183'>
        cfl = abs(ww(i,k,j)/mut(i,j)*rdnw(k)*dt)<a name='2184'>
        if(cfl .gt. w_beta)then<a name='2185'>
#else<a name='2186'>
<font color=#447700>! restructure to get rid of divide<a name='2187'></font>
        cf_n = abs(ww(i,k,j))<a name='2188'>
        cf_d = abs(mut(i,j)*rdnw(k)*dt)<a name='2189'>
        if(cf_n .gt. cf_d*w_beta )then<a name='2190'>
#endif<a name='2191'>
<a name='2192'>
           print *,i,j,k,'cfl,w,d(eta)=',cfl,w(i,k,j),-1./rdnw(k)<a name='2193'>
           rw_tend(i,k,j) = rw_tend(i,k,j)-sign(1.,w(i,k,j))*w_alpha*(cfl-w_beta)*mut(i,j)<a name='2194'>
        endif<a name='2195'>
     END DO<a name='2196'>
     ENDDO<a name='2197'>
<a name='2198'>
   ENDDO<a name='2199'>
<a name='2200'>
END SUBROUTINE w_damp<a name='2201'>
<a name='2202'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2203'></font>
<a name='2204'>
<A NAME='HORIZONTAL_DIFFUSION'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_DIFFUSION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2205'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion</font> ( name, field, tendency, mu,           &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION.html' TARGET='index'>8</A><a name='2206'>
                                  config_flags,                        &amp;<a name='2207'>
                                  msfu, msfv, msft, khdif, xkmhd, rdx, rdy,   &amp;<a name='2208'>
                                  ids, ide, jds, jde, kds, kde,        &amp;<a name='2209'>
                                  ims, ime, jms, jme, kms, kme,        &amp;<a name='2210'>
                                  its, ite, jts, jte, kts, kte        )<a name='2211'>
<a name='2212'>
   IMPLICIT NONE<a name='2213'>
   <a name='2214'>
   <font color=#447700>! Input data<a name='2215'></font>
<a name='2216'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2217'>
<a name='2218'>
   INTEGER ,        INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2219'>
                                     ims, ime, jms, jme, kms, kme, &amp;<a name='2220'>
                                     its, ite, jts, jte, kts, kte<a name='2221'>
<a name='2222'>
   CHARACTER(LEN=1) ,                          INTENT(IN   ) :: name<a name='2223'>
<a name='2224'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field, xkmhd<a name='2225'>
<a name='2226'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='2227'>
<a name='2228'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mu<a name='2229'>
<a name='2230'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfu,      &amp;<a name='2231'>
                                                                msfv,      &amp;<a name='2232'>
                                                                msft<a name='2233'>
<a name='2234'>
   REAL ,                                      INTENT(IN   ) :: rdx,       &amp;<a name='2235'>
                                                                rdy,       &amp;<a name='2236'>
                                                                khdif<a name='2237'>
<a name='2238'>
   <font color=#447700>! Local data<a name='2239'></font>
   <a name='2240'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='2241'>
<a name='2242'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2243'>
<a name='2244'>
   REAL :: mrdx, mkrdxm, mkrdxp, &amp;<a name='2245'>
           mrdy, mkrdym, mkrdyp, &amp;<a name='2246'>
           rcoup<a name='2247'>
   REAL :: pr = 3.<a name='2248'>
<a name='2249'>
   LOGICAL :: specified<a name='2250'>
<a name='2251'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2252'></font>
<font color=#447700>!<a name='2253'></font>
<font color=#447700>!  horizontal_diffusion computes the horizontal diffusion tendency<a name='2254'></font>
<font color=#447700>!  on model horizontal coordinate surfaces.<a name='2255'></font>
<font color=#447700>!<a name='2256'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2257'></font>
<a name='2258'>
   specified = .false.<a name='2259'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='2260'>
<a name='2261'>
   ktf=MIN(kte,kde-1)<a name='2262'>
   <a name='2263'>
   IF (name .EQ. 'u') THEN<a name='2264'>
<a name='2265'>
      i_start = its<a name='2266'>
      i_end   = ite<a name='2267'>
      j_start = jts<a name='2268'>
      j_end   = MIN(jte,jde-1)<a name='2269'>
<a name='2270'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2271'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='2272'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2273'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='2274'>
<a name='2275'>
      DO j = j_start, j_end<a name='2276'>
      DO k=kts,ktf<a name='2277'>
      DO i = i_start, i_end<a name='2278'>
<a name='2279'>
         mkrdxm=msft(i-1,j)*xkmhd(i-1,k,j)*rdx<a name='2280'>
         mkrdxp=msft(i,j)*xkmhd(i,k,j)*rdx<a name='2281'>
         mrdx=msfu(i,j)*rdx<a name='2282'>
         mkrdym=0.5*(msfu(i,j)+msfu(i,j-1))*    &amp;<a name='2283'>
                0.25*(xkmhd(i,k,j)+xkmhd(i,k,j-1)+xkmhd(i-1,k,j-1)+xkmhd(i-1,k,j))*rdy<a name='2284'>
         mkrdyp=0.5*(msfu(i,j)+msfu(i,j+1))*    &amp;<a name='2285'>
                0.25*(xkmhd(i,k,j)+xkmhd(i,k,j+1)+xkmhd(i-1,k,j+1)+xkmhd(i-1,k,j))*rdy<a name='2286'>
         mrdy=msfu(i,j)*rdy<a name='2287'>
<a name='2288'>
            rcoup=0.5*(mu(i,j)+mu(i-1,j))<a name='2289'>
            tendency(i,k,j)=tendency(i,k,j)+rcoup*( &amp;<a name='2290'>
                            mrdx*(mkrdxp*(field(i+1,k,j)-field(i  ,k,j))  &amp;<a name='2291'>
                                 -mkrdxm*(field(i  ,k,j)-field(i-1,k,j))) &amp;<a name='2292'>
                           +mrdy*(mkrdyp*(field(i,k,j+1)-field(i,k,j  ))  &amp;<a name='2293'>
                                 -mkrdym*(field(i,k,j  )-field(i,k,j-1))))<a name='2294'>
      ENDDO<a name='2295'>
      ENDDO<a name='2296'>
      ENDDO<a name='2297'>
   <a name='2298'>
   ELSE IF (name .EQ. 'v')THEN<a name='2299'>
<a name='2300'>
      i_start = its<a name='2301'>
      i_end   = MIN(ite,ide-1)<a name='2302'>
      j_start = jts<a name='2303'>
      j_end   = jte<a name='2304'>
<a name='2305'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2306'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='2307'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2308'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-1,jte)<a name='2309'>
<a name='2310'>
      DO j = j_start, j_end<a name='2311'>
      DO k=kts,ktf<a name='2312'>
      DO i = i_start, i_end<a name='2313'>
<a name='2314'>
         mkrdxm=0.5*(msfv(i,j)+msfv(i-1,j))*    &amp;<a name='2315'>
                0.25*(xkmhd(i,k,j)+xkmhd(i,k,j-1)+xkmhd(i-1,k,j-1)+xkmhd(i-1,k,j))*rdx<a name='2316'>
         mkrdxp=0.5*(msfv(i,j)+msfv(i+1,j))*    &amp;<a name='2317'>
                0.25*(xkmhd(i,k,j)+xkmhd(i,k,j-1)+xkmhd(i+1,k,j-1)+xkmhd(i+1,k,j))*rdx<a name='2318'>
         mrdx=msfv(i,j)*rdx<a name='2319'>
         mkrdym=msft(i,j-1)*xkmhd(i,k,j-1)*rdy<a name='2320'>
         mkrdyp=msft(i,j)*xkmhd(i,k,j)*rdy<a name='2321'>
         mrdy=msfv(i,j)*rdy<a name='2322'>
<a name='2323'>
            rcoup=0.5*(mu(i,j)+mu(i,j-1))<a name='2324'>
            tendency(i,k,j)=tendency(i,k,j)+rcoup*( &amp;<a name='2325'>
                            mrdx*(mkrdxp*(field(i+1,k,j)-field(i  ,k,j))  &amp;<a name='2326'>
                                 -mkrdxm*(field(i  ,k,j)-field(i-1,k,j))) &amp;<a name='2327'>
                           +mrdy*(mkrdyp*(field(i,k,j+1)-field(i,k,j  ))  &amp;<a name='2328'>
                                 -mkrdym*(field(i,k,j  )-field(i,k,j-1))))<a name='2329'>
      ENDDO<a name='2330'>
      ENDDO<a name='2331'>
      ENDDO<a name='2332'>
   <a name='2333'>
   ELSE IF (name .EQ. 'w')THEN<a name='2334'>
<a name='2335'>
      i_start = its<a name='2336'>
      i_end   = MIN(ite,ide-1)<a name='2337'>
      j_start = jts<a name='2338'>
      j_end   = MIN(jte,jde-1)<a name='2339'>
<a name='2340'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2341'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='2342'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2343'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='2344'>
<a name='2345'>
      DO j = j_start, j_end<a name='2346'>
      DO k=kts+1,ktf<a name='2347'>
      DO i = i_start, i_end<a name='2348'>
<a name='2349'>
         mkrdxm=msfu(i,j)*0.25*(xkmhd(i,k,j)+xkmhd(i-1,k,j)+xkmhd(i,k-1,j)+xkmhd(i-1,k-1,j))*rdx<a name='2350'>
         mkrdxp=msfu(i+1,j)*0.25*(xkmhd(i+1,k,j)+xkmhd(i,k,j)+xkmhd(i+1,k-1,j)+xkmhd(i,k-1,j))*rdx<a name='2351'>
         mrdx=msft(i,j)*rdx<a name='2352'>
         mkrdym=msfv(i,j)*0.25*(xkmhd(i,k,j)+xkmhd(i,k,j-1)+xkmhd(i,k-1,j)+xkmhd(i,k-1,j-1))*rdy<a name='2353'>
         mkrdyp=msfv(i,j+1)*0.25*(xkmhd(i,k,j+1)+xkmhd(i,k,j)+xkmhd(i,k-1,j+1)+xkmhd(i,k-1,j))*rdy<a name='2354'>
         mrdy=msft(i,j)*rdy<a name='2355'>
<a name='2356'>
            rcoup=0.5*(mu(i,j)+mu(i,j))<a name='2357'>
            tendency(i,k,j)=tendency(i,k,j)+rcoup*( &amp;<a name='2358'>
                            mrdx*(mkrdxp*(field(i+1,k,j)-field(i  ,k,j)) &amp;<a name='2359'>
                                 -mkrdxm*(field(i  ,k,j)-field(i-1,k,j))) &amp;<a name='2360'>
                           +mrdy*(mkrdyp*(field(i,k,j+1)-field(i,k,j  )) &amp;<a name='2361'>
                                 -mkrdym*(field(i,k,j  )-field(i,k,j-1))))<a name='2362'>
      ENDDO<a name='2363'>
      ENDDO<a name='2364'>
      ENDDO<a name='2365'>
   <a name='2366'>
   ELSE<a name='2367'>
<a name='2368'>
<a name='2369'>
      i_start = its<a name='2370'>
      i_end   = MIN(ite,ide-1)<a name='2371'>
      j_start = jts<a name='2372'>
      j_end   = MIN(jte,jde-1)<a name='2373'>
<a name='2374'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2375'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='2376'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2377'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='2378'>
<a name='2379'>
      DO j = j_start, j_end<a name='2380'>
      DO k=kts,ktf<a name='2381'>
      DO i = i_start, i_end<a name='2382'>
<a name='2383'>
         mkrdxm=msfu(i,j)*0.5*(xkmhd(i,k,j)+xkmhd(i-1,k,j))*rdx*pr<a name='2384'>
         mkrdxp=msfu(i+1,j)*0.5*(xkmhd(i+1,k,j)+xkmhd(i,k,j))*rdx*pr<a name='2385'>
         mrdx=msft(i,j)*rdx<a name='2386'>
         mkrdym=msfv(i,j)*0.5*(xkmhd(i,k,j)+xkmhd(i,k,j-1))*rdy*pr<a name='2387'>
         mkrdyp=msfv(i,j+1)*0.5*(xkmhd(i,k,j+1)+xkmhd(i,k,j))*rdy*pr<a name='2388'>
         mrdy=msft(i,j)*rdy<a name='2389'>
<a name='2390'>
            rcoup=mu(i,j)<a name='2391'>
            tendency(i,k,j)=tendency(i,k,j)+rcoup*( &amp;<a name='2392'>
                            mrdx*(mkrdxp*(field(i+1,k,j)-field(i  ,k,j))  &amp;<a name='2393'>
                                 -mkrdxm*(field(i  ,k,j)-field(i-1,k,j))) &amp;<a name='2394'>
                           +mrdy*(mkrdyp*(field(i,k,j+1)-field(i,k,j  ))  &amp;<a name='2395'>
                                 -mkrdym*(field(i,k,j  )-field(i,k,j-1))))<a name='2396'>
      ENDDO<a name='2397'>
      ENDDO<a name='2398'>
      ENDDO<a name='2399'>
           <a name='2400'>
   ENDIF<a name='2401'>
<a name='2402'>
END SUBROUTINE horizontal_diffusion<a name='2403'>
<a name='2404'>
<font color=#447700>!-----------------------------------------------------------------------------------------<a name='2405'></font>
<a name='2406'>
<A NAME='HORIZONTAL_DIFFUSION_3DMP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_DIFFUSION_3DMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2407'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_3dmp</font> ( name, field, tendency, mu,           &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_3DMP.html' TARGET='index'>2</A><a name='2408'>
                                       config_flags, base_3d,               &amp;<a name='2409'>
                                       msfu, msfv, msft, khdif, xkmhd, rdx, rdy,   &amp;<a name='2410'>
                                       ids, ide, jds, jde, kds, kde,        &amp;<a name='2411'>
                                       ims, ime, jms, jme, kms, kme,        &amp;<a name='2412'>
                                       its, ite, jts, jte, kts, kte        )<a name='2413'>
<a name='2414'>
   IMPLICIT NONE<a name='2415'>
   <a name='2416'>
   <font color=#447700>! Input data<a name='2417'></font>
   <a name='2418'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2419'>
<a name='2420'>
   INTEGER ,        INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2421'>
                                     ims, ime, jms, jme, kms, kme, &amp;<a name='2422'>
                                     its, ite, jts, jte, kts, kte<a name='2423'>
<a name='2424'>
   CHARACTER(LEN=1) ,                          INTENT(IN   ) :: name<a name='2425'>
<a name='2426'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field, &amp;<a name='2427'>
                                                                      xkmhd, &amp;<a name='2428'>
                                                                      base_3d<a name='2429'>
<a name='2430'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='2431'>
<a name='2432'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mu<a name='2433'>
<a name='2434'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfu,      &amp;<a name='2435'>
                                                                    msfv,      &amp;<a name='2436'>
                                                                    msft<a name='2437'>
<a name='2438'>
   REAL ,                                      INTENT(IN   ) :: rdx,       &amp;<a name='2439'>
                                                                rdy,       &amp;<a name='2440'>
                                                                khdif<a name='2441'>
<a name='2442'>
   <font color=#447700>! Local data<a name='2443'></font>
   <a name='2444'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='2445'>
<a name='2446'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2447'>
<a name='2448'>
   REAL :: mrdx, mkrdxm, mkrdxp, &amp;<a name='2449'>
           mrdy, mkrdym, mkrdyp, &amp;<a name='2450'>
           rcoup<a name='2451'>
   REAL :: pr = 3.<a name='2452'>
<a name='2453'>
   LOGICAL :: specified<a name='2454'>
<a name='2455'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2456'></font>
<font color=#447700>!<a name='2457'></font>
<font color=#447700>!  horizontal_diffusion_3dmp computes the horizontal diffusion tendency<a name='2458'></font>
<font color=#447700>!  on model horizontal coordinate surfaces.  This routine computes diffusion<a name='2459'></font>
<font color=#447700>!  a perturbation scalar (field-base_3d).<a name='2460'></font>
<font color=#447700>!<a name='2461'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2462'></font>
<a name='2463'>
   specified = .false.<a name='2464'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='2465'>
<a name='2466'>
   ktf=MIN(kte,kde-1)<a name='2467'>
   <a name='2468'>
      i_start = its<a name='2469'>
      i_end   = MIN(ite,ide-1)<a name='2470'>
      j_start = jts<a name='2471'>
      j_end   = MIN(jte,jde-1)<a name='2472'>
<a name='2473'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2474'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='2475'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2476'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='2477'>
<a name='2478'>
      DO j = j_start, j_end<a name='2479'>
      DO k=kts,ktf<a name='2480'>
      DO i = i_start, i_end<a name='2481'>
<a name='2482'>
         mkrdxm=msfu(i,j)*0.5*(xkmhd(i,k,j)+xkmhd(i-1,k,j))*rdx*pr<a name='2483'>
         mkrdxp=msfu(i+1,j)*0.5*(xkmhd(i+1,k,j)+xkmhd(i,k,j))*rdx*pr<a name='2484'>
         mrdx=msft(i,j)*rdx<a name='2485'>
         mkrdym=msfv(i,j)*0.5*(xkmhd(i,k,j)+xkmhd(i,k,j-1))*rdy*pr<a name='2486'>
         mkrdyp=msfv(i,j+1)*0.5*(xkmhd(i,k,j+1)+xkmhd(i,k,j))*rdy*pr<a name='2487'>
         mrdy=msft(i,j)*rdy<a name='2488'>
<a name='2489'>
            rcoup=mu(i,j)<a name='2490'>
            tendency(i,k,j)=tendency(i,k,j)+rcoup*(                        &amp;<a name='2491'>
                    mrdx*( mkrdxp*(   field(i+1,k,j)  -field(i  ,k,j)      &amp;<a name='2492'>
                                   -base_3d(i+1,k,j)+base_3d(i  ,k,j) )    &amp;<a name='2493'>
                          -mkrdxm*(   field(i  ,k,j)  -field(i-1,k,j)      &amp;<a name='2494'>
                                   -base_3d(i  ,k,j)+base_3d(i-1,k,j) )  ) &amp;<a name='2495'>
                   +mrdy*( mkrdyp*(   field(i,k,j+1)  -field(i,k,j  )      &amp;<a name='2496'>
                                   -base_3d(i,k,j+1)+base_3d(i,k,j  ) )    &amp;<a name='2497'>
                          -mkrdym*(   field(i,k,j  )  -field(i,k,j-1)      &amp;<a name='2498'>
                                   -base_3d(i,k,j  )+base_3d(i,k,j-1) )  ) &amp;<a name='2499'>
                                                                         ) <a name='2500'>
      ENDDO<a name='2501'>
      ENDDO<a name='2502'>
      ENDDO<a name='2503'>
<a name='2504'>
END SUBROUTINE horizontal_diffusion_3dmp<a name='2505'>
<a name='2506'>
<font color=#447700>!-----------------------------------------------------------------------------------------<a name='2507'></font>
<a name='2508'>
<A NAME='VERTICAL_DIFFUSION'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2509'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion</font> ( name, field, tendency,        &amp; <A href='../../call_to/VERTICAL_DIFFUSION.html' TARGET='index'>4</A><a name='2510'>
                                config_flags,                 &amp;<a name='2511'>
                                alt, mut, rdn, rdnw, kvdif,   &amp;<a name='2512'>
                                ids, ide, jds, jde, kds, kde, &amp;<a name='2513'>
                                ims, ime, jms, jme, kms, kme, &amp;<a name='2514'>
                                its, ite, jts, jte, kts, kte )<a name='2515'>
<a name='2516'>
<a name='2517'>
   IMPLICIT NONE<a name='2518'>
   <a name='2519'>
   <font color=#447700>! Input data<a name='2520'></font>
   <a name='2521'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2522'>
<a name='2523'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2524'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='2525'>
                                 its, ite, jts, jte, kts, kte<a name='2526'>
<a name='2527'>
   CHARACTER(LEN=1) ,                          INTENT(IN   ) :: name<a name='2528'>
<a name='2529'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                      &amp;<a name='2530'>
                                               INTENT(IN   ) :: field,    &amp;<a name='2531'>
                                                                alt<a name='2532'>
<a name='2533'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='2534'>
<a name='2535'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: mut<a name='2536'>
<a name='2537'>
   REAL , DIMENSION( kms:kme ) ,                   INTENT(IN   ) :: rdn, rdnw<a name='2538'>
<a name='2539'>
   REAL ,                                      INTENT(IN   ) :: kvdif<a name='2540'>
   <a name='2541'>
   <font color=#447700>! Local data<a name='2542'></font>
   <a name='2543'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='2544'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2545'>
<a name='2546'>
   REAL , DIMENSION(its:ite, jts:jte) :: vfluxm, vfluxp, zz<a name='2547'>
   REAL , DIMENSION(its:ite, 0:kte+1) :: vflux<a name='2548'>
<a name='2549'>
   REAL :: rdz, rcoup<a name='2550'>
<a name='2551'>
   LOGICAL :: specified<a name='2552'>
<a name='2553'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2554'></font>
<font color=#447700>!<a name='2555'></font>
<font color=#447700>!  vertical_diffusion<a name='2556'></font>
<font color=#447700>!  computes vertical diffusion tendency.<a name='2557'></font>
<font color=#447700>!<a name='2558'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2559'></font>
<a name='2560'>
   specified = .false.<a name='2561'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='2562'>
<a name='2563'>
   ktf=MIN(kte,kde-1)<a name='2564'>
   <a name='2565'>
   IF (name .EQ. 'w')THEN<a name='2566'>
<a name='2567'>
   <a name='2568'>
   i_start = its<a name='2569'>
   i_end   = MIN(ite,ide-1)<a name='2570'>
   j_start = jts<a name='2571'>
   j_end   = MIN(jte,jde-1)<a name='2572'>
<a name='2573'>
j_loop_w : DO j = j_start, j_end<a name='2574'>
<a name='2575'>
     DO k=kts,ktf-1<a name='2576'>
       DO i = i_start, i_end<a name='2577'>
          vflux(i,k)= (kvdif/alt(i,k,j))*rdnw(k)*(field(i,k+1,j)-field(i,k,j))<a name='2578'>
       ENDDO<a name='2579'>
     ENDDO<a name='2580'>
<a name='2581'>
     DO i = i_start, i_end<a name='2582'>
       vflux(i,ktf)=0.<a name='2583'>
     ENDDO<a name='2584'>
<a name='2585'>
     DO k=kts+1,ktf<a name='2586'>
       DO i = i_start, i_end<a name='2587'>
            tendency(i,k,j)=tendency(i,k,j)                                         &amp;<a name='2588'>
                              +rdn(k)*g*g/mut(i,j)/(0.5*(alt(i,k,j)+alt(i,k-1,j)))  &amp;<a name='2589'>
                                         *(vflux(i,k)-vflux(i,k-1))<a name='2590'>
       ENDDO<a name='2591'>
     ENDDO<a name='2592'>
<a name='2593'>
    ENDDO j_loop_w<a name='2594'>
<a name='2595'>
   ELSE IF(name .EQ. 'm')THEN<a name='2596'>
<a name='2597'>
     i_start = its<a name='2598'>
     i_end   = MIN(ite,ide-1)<a name='2599'>
     j_start = jts<a name='2600'>
     j_end   = MIN(jte,jde-1)<a name='2601'>
<a name='2602'>
j_loop_s : DO j = j_start, j_end<a name='2603'>
<a name='2604'>
     DO k=kts,ktf-1<a name='2605'>
       DO i = i_start, i_end<a name='2606'>
         vflux(i,k)=kvdif*rdn(k+1)/(0.5*(alt(i,k,j)+alt(i,k+1,j)))   &amp;<a name='2607'>
                  *(field(i,k+1,j)-field(i,k,j))<a name='2608'>
       ENDDO<a name='2609'>
     ENDDO<a name='2610'>
<a name='2611'>
     DO i = i_start, i_end<a name='2612'>
       vflux(i,0)=vflux(i,1)<a name='2613'>
     ENDDO<a name='2614'>
<a name='2615'>
     DO i = i_start, i_end<a name='2616'>
       vflux(i,ktf)=0.<a name='2617'>
     ENDDO<a name='2618'>
<a name='2619'>
     DO k=kts,ktf<a name='2620'>
       DO i = i_start, i_end<a name='2621'>
         tendency(i,k,j)=tendency(i,k,j)+g*g/mut(i,j)/alt(i,k,j)  &amp;<a name='2622'>
                *rdnw(k)*(vflux(i,k)-vflux(i,k-1))<a name='2623'>
       ENDDO<a name='2624'>
     ENDDO<a name='2625'>
<a name='2626'>
 ENDDO j_loop_s<a name='2627'>
<a name='2628'>
   ENDIF<a name='2629'>
<a name='2630'>
END SUBROUTINE vertical_diffusion<a name='2631'>
<a name='2632'>
<a name='2633'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2634'></font>
<a name='2635'>
<A NAME='VERTICAL_DIFFUSION_MP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_MP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2636'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_mp</font> ( field, tendency, config_flags, &amp; <A href='../../call_to/VERTICAL_DIFFUSION_MP.html' TARGET='index'>2</A><a name='2637'>
                                   base,                          &amp;<a name='2638'>
                                   alt, mut, rdn, rdnw, kvdif,    &amp;<a name='2639'>
                                   ids, ide, jds, jde, kds, kde,  &amp;<a name='2640'>
                                   ims, ime, jms, jme, kms, kme,  &amp;<a name='2641'>
                                   its, ite, jts, jte, kts, kte  )<a name='2642'>
<a name='2643'>
<a name='2644'>
   IMPLICIT NONE<a name='2645'>
   <a name='2646'>
   <font color=#447700>! Input data<a name='2647'></font>
   <a name='2648'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2649'>
<a name='2650'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2651'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='2652'>
                                 its, ite, jts, jte, kts, kte<a name='2653'>
<a name='2654'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                      &amp;<a name='2655'>
                                               INTENT(IN   ) :: field,    &amp;<a name='2656'>
                                                                alt<a name='2657'>
<a name='2658'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='2659'>
<a name='2660'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: mut<a name='2661'>
<a name='2662'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: rdn,  &amp;<a name='2663'>
                                                                  rdnw, &amp;<a name='2664'>
                                                                  base<a name='2665'>
<a name='2666'>
   REAL ,                                      INTENT(IN   ) :: kvdif<a name='2667'>
   <a name='2668'>
   <font color=#447700>! Local data<a name='2669'></font>
   <a name='2670'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='2671'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2672'>
<a name='2673'>
   REAL , DIMENSION(its:ite, 0:kte+1) :: vflux<a name='2674'>
<a name='2675'>
   REAL :: rdz, rcoup<a name='2676'>
<a name='2677'>
   LOGICAL :: specified<a name='2678'>
<a name='2679'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2680'></font>
<font color=#447700>!<a name='2681'></font>
<font color=#447700>!  vertical_diffusion_mp<a name='2682'></font>
<font color=#447700>!  computes vertical diffusion tendency of a perturbation variable<a name='2683'></font>
<font color=#447700>!  (field-base).  Note that base as a 1D (k) field.<a name='2684'></font>
<font color=#447700>!<a name='2685'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2686'></font>
<a name='2687'>
   specified = .false.<a name='2688'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='2689'>
<a name='2690'>
   ktf=MIN(kte,kde-1)<a name='2691'>
   <a name='2692'>
     i_start = its<a name='2693'>
     i_end   = MIN(ite,ide-1)<a name='2694'>
     j_start = jts<a name='2695'>
     j_end   = MIN(jte,jde-1)<a name='2696'>
<a name='2697'>
j_loop_s : DO j = j_start, j_end<a name='2698'>
<a name='2699'>
     DO k=kts,ktf-1<a name='2700'>
       DO i = i_start, i_end<a name='2701'>
         vflux(i,k)=kvdif*rdn(k+1)/(0.5*(alt(i,k,j)+alt(i,k+1,j)))   &amp;<a name='2702'>
                    *(field(i,k+1,j)-field(i,k,j)-base(k+1)+base(k))<a name='2703'>
       ENDDO<a name='2704'>
     ENDDO<a name='2705'>
<a name='2706'>
     DO i = i_start, i_end<a name='2707'>
       vflux(i,0)=vflux(i,1)<a name='2708'>
     ENDDO<a name='2709'>
<a name='2710'>
     DO i = i_start, i_end<a name='2711'>
       vflux(i,ktf)=0.<a name='2712'>
     ENDDO<a name='2713'>
<a name='2714'>
     DO k=kts,ktf<a name='2715'>
       DO i = i_start, i_end<a name='2716'>
         tendency(i,k,j)=tendency(i,k,j)+g*g/mut(i,j)/alt(i,k,j)  &amp;<a name='2717'>
                *rdnw(k)*(vflux(i,k)-vflux(i,k-1))<a name='2718'>
       ENDDO<a name='2719'>
     ENDDO<a name='2720'>
<a name='2721'>
 ENDDO j_loop_s<a name='2722'>
<a name='2723'>
END SUBROUTINE vertical_diffusion_mp<a name='2724'>
<a name='2725'>
<a name='2726'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2727'></font>
<a name='2728'>
<A NAME='VERTICAL_DIFFUSION_3DMP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_3DMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2729'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_3dmp</font> ( field, tendency, config_flags, &amp; <A href='../../call_to/VERTICAL_DIFFUSION_3DMP.html' TARGET='index'>2</A><a name='2730'>
                                     base_3d,                       &amp;<a name='2731'>
                                     alt, mut, rdn, rdnw, kvdif,    &amp;<a name='2732'>
                                     ids, ide, jds, jde, kds, kde,  &amp;<a name='2733'>
                                     ims, ime, jms, jme, kms, kme,  &amp;<a name='2734'>
                                     its, ite, jts, jte, kts, kte  )<a name='2735'>
<a name='2736'>
<a name='2737'>
   IMPLICIT NONE<a name='2738'>
   <a name='2739'>
   <font color=#447700>! Input data<a name='2740'></font>
   <a name='2741'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2742'>
<a name='2743'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2744'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='2745'>
                                 its, ite, jts, jte, kts, kte<a name='2746'>
<a name='2747'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                      &amp;<a name='2748'>
                                               INTENT(IN   ) :: field,    &amp;<a name='2749'>
                                                                alt,      &amp;<a name='2750'>
                                                                base_3d<a name='2751'>
<a name='2752'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='2753'>
<a name='2754'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: mut<a name='2755'>
<a name='2756'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: rdn,  &amp;<a name='2757'>
                                                                  rdnw<a name='2758'>
<a name='2759'>
   REAL ,                                      INTENT(IN   ) :: kvdif<a name='2760'>
   <a name='2761'>
   <font color=#447700>! Local data<a name='2762'></font>
   <a name='2763'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='2764'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2765'>
<a name='2766'>
   REAL , DIMENSION(its:ite, 0:kte+1) :: vflux<a name='2767'>
<a name='2768'>
   REAL :: rdz, rcoup<a name='2769'>
<a name='2770'>
   LOGICAL :: specified<a name='2771'>
<a name='2772'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2773'></font>
<font color=#447700>!<a name='2774'></font>
<font color=#447700>!  vertical_diffusion_3dmp<a name='2775'></font>
<font color=#447700>!  computes vertical diffusion tendency of a perturbation variable<a name='2776'></font>
<font color=#447700>!  (field-base_3d).  <a name='2777'></font>
<font color=#447700>!<a name='2778'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2779'></font>
<a name='2780'>
   specified = .false.<a name='2781'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='2782'>
<a name='2783'>
   ktf=MIN(kte,kde-1)<a name='2784'>
   <a name='2785'>
     i_start = its<a name='2786'>
     i_end   = MIN(ite,ide-1)<a name='2787'>
     j_start = jts<a name='2788'>
     j_end   = MIN(jte,jde-1)<a name='2789'>
<a name='2790'>
j_loop_s : DO j = j_start, j_end<a name='2791'>
<a name='2792'>
     DO k=kts,ktf-1<a name='2793'>
       DO i = i_start, i_end<a name='2794'>
         vflux(i,k)=kvdif*rdn(k+1)/(0.5*(alt(i,k,j)+alt(i,k+1,j)))   &amp;<a name='2795'>
                    *(   field(i,k+1,j)  -field(i,k,j)               &amp;<a name='2796'>
                      -base_3d(i,k+1,j)+base_3d(i,k,j) )<a name='2797'>
       ENDDO<a name='2798'>
     ENDDO<a name='2799'>
<a name='2800'>
     DO i = i_start, i_end<a name='2801'>
       vflux(i,0)=vflux(i,1)<a name='2802'>
     ENDDO<a name='2803'>
<a name='2804'>
     DO i = i_start, i_end<a name='2805'>
       vflux(i,ktf)=0.<a name='2806'>
     ENDDO<a name='2807'>
<a name='2808'>
     DO k=kts,ktf<a name='2809'>
       DO i = i_start, i_end<a name='2810'>
         tendency(i,k,j)=tendency(i,k,j)+g*g/mut(i,j)/alt(i,k,j)  &amp;<a name='2811'>
                *rdnw(k)*(vflux(i,k)-vflux(i,k-1))<a name='2812'>
       ENDDO<a name='2813'>
     ENDDO<a name='2814'>
<a name='2815'>
 ENDDO j_loop_s<a name='2816'>
<a name='2817'>
END SUBROUTINE vertical_diffusion_3dmp<a name='2818'>
<a name='2819'>
<a name='2820'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2821'></font>
<a name='2822'>
<a name='2823'>
<A NAME='VERTICAL_DIFFUSION_U'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_U' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2824'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_u</font> ( field, tendency,              &amp; <A href='../../call_to/VERTICAL_DIFFUSION_U.html' TARGET='index'>2</A><a name='2825'>
                                  config_flags, u_base,         &amp;<a name='2826'>
                                  alt, muu, rdn, rdnw, kvdif,   &amp;<a name='2827'>
                                  ids, ide, jds, jde, kds, kde, &amp;<a name='2828'>
                                  ims, ime, jms, jme, kms, kme, &amp;<a name='2829'>
                                  its, ite, jts, jte, kts, kte )<a name='2830'>
<a name='2831'>
<a name='2832'>
   IMPLICIT NONE<a name='2833'>
   <a name='2834'>
   <font color=#447700>! Input data<a name='2835'></font>
   <a name='2836'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2837'>
<a name='2838'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2839'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='2840'>
                                 its, ite, jts, jte, kts, kte<a name='2841'>
<a name='2842'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                      &amp;<a name='2843'>
                                               INTENT(IN   ) :: field,    &amp;<a name='2844'>
                                                                alt<a name='2845'>
<a name='2846'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='2847'>
<a name='2848'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: muu<a name='2849'>
<a name='2850'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: rdn, rdnw, u_base<a name='2851'>
<a name='2852'>
   REAL ,                                      INTENT(IN   ) :: kvdif<a name='2853'>
   <a name='2854'>
   <font color=#447700>! Local data<a name='2855'></font>
   <a name='2856'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='2857'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2858'>
<a name='2859'>
   REAL , DIMENSION(its:ite, 0:kte+1) :: vflux<a name='2860'>
<a name='2861'>
   REAL :: rdz, rcoup, zz<a name='2862'>
<a name='2863'>
   LOGICAL :: specified<a name='2864'>
<a name='2865'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2866'></font>
<font color=#447700>!<a name='2867'></font>
<font color=#447700>!  vertical_diffusion_u computes vertical diffusion tendency for <a name='2868'></font>
<font color=#447700>!  the u momentum equation.  This routine assumes a constant eddy<a name='2869'></font>
<font color=#447700>!  viscosity kvdif.<a name='2870'></font>
<font color=#447700>!<a name='2871'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2872'></font>
<a name='2873'>
   specified = .false.<a name='2874'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='2875'>
<a name='2876'>
   ktf=MIN(kte,kde-1)<a name='2877'>
<a name='2878'>
      i_start = its<a name='2879'>
      i_end   = ite<a name='2880'>
      j_start = jts<a name='2881'>
      j_end   = MIN(jte,jde-1)<a name='2882'>
<a name='2883'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2884'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='2885'>
<a name='2886'>
<a name='2887'>
j_loop_u : DO j = j_start, j_end<a name='2888'>
<a name='2889'>
     DO k=kts,ktf-1<a name='2890'>
       DO i = i_start, i_end<a name='2891'>
         vflux(i,k)=kvdif*rdn(k+1)/(0.25*( alt(i  ,k  ,j)      &amp;<a name='2892'>
                                        +alt(i-1,k  ,j)      &amp;<a name='2893'>
                                        +alt(i  ,k+1,j)      &amp;<a name='2894'>
                                        +alt(i-1,k+1,j) ) )  &amp;<a name='2895'>
                             *(field(i,k+1,j)-field(i,k,j)   &amp;<a name='2896'>
                               -u_base(k+1)   +u_base(k)  )<a name='2897'>
       ENDDO<a name='2898'>
     ENDDO<a name='2899'>
<a name='2900'>
     DO i = i_start, i_end<a name='2901'>
       vflux(i,0)=vflux(i,1)<a name='2902'>
     ENDDO<a name='2903'>
<a name='2904'>
     DO i = i_start, i_end<a name='2905'>
       vflux(i,ktf)=0.<a name='2906'>
     ENDDO<a name='2907'>
<a name='2908'>
     DO k=kts,ktf-1<a name='2909'>
       DO i = i_start, i_end<a name='2910'>
         tendency(i,k,j)=tendency(i,k,j)+                             &amp;<a name='2911'>
                g*g*rdnw(k)/muu(i,j)/(0.5*(alt(i-1,k,j)+alt(i,k,j)))* &amp;<a name='2912'>
                              (vflux(i,k)-vflux(i,k-1))<a name='2913'>
       ENDDO<a name='2914'>
     ENDDO<a name='2915'>
<a name='2916'>
 ENDDO j_loop_u<a name='2917'>
   <a name='2918'>
END SUBROUTINE vertical_diffusion_u<a name='2919'>
<a name='2920'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2921'></font>
<a name='2922'>
<a name='2923'>
<A NAME='VERTICAL_DIFFUSION_V'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2924'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_v</font> ( field, tendency,              &amp; <A href='../../call_to/VERTICAL_DIFFUSION_V.html' TARGET='index'>2</A><a name='2925'>
                                  config_flags, v_base,         &amp;<a name='2926'>
                                  alt, muv, rdn, rdnw, kvdif,   &amp;<a name='2927'>
                                  ids, ide, jds, jde, kds, kde, &amp;<a name='2928'>
                                  ims, ime, jms, jme, kms, kme, &amp;<a name='2929'>
                                  its, ite, jts, jte, kts, kte )<a name='2930'>
<a name='2931'>
<a name='2932'>
   IMPLICIT NONE<a name='2933'>
   <a name='2934'>
   <font color=#447700>! Input data<a name='2935'></font>
   <a name='2936'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2937'>
<a name='2938'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2939'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='2940'>
                                 its, ite, jts, jte, kts, kte<a name='2941'>
<a name='2942'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                      &amp;<a name='2943'>
                                               INTENT(IN   ) :: field,    &amp;<a name='2944'>
                                                                alt<a name='2945'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: rdn, rdnw, v_base<a name='2946'>
<a name='2947'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='2948'>
<a name='2949'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: muv<a name='2950'>
<a name='2951'>
   REAL ,                                      INTENT(IN   ) :: kvdif<a name='2952'>
   <a name='2953'>
   <font color=#447700>! Local data<a name='2954'></font>
   <a name='2955'>
   INTEGER :: i, j, k, itf, jtf, ktf, jm1<a name='2956'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2957'>
<a name='2958'>
   REAL , DIMENSION(its:ite, 0:kte+1) :: vflux<a name='2959'>
<a name='2960'>
   REAL :: rdz, rcoup, zz<a name='2961'>
<a name='2962'>
   LOGICAL :: specified<a name='2963'>
<a name='2964'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2965'></font>
<font color=#447700>!<a name='2966'></font>
<font color=#447700>!  vertical_diffusion_v computes vertical diffusion tendency for <a name='2967'></font>
<font color=#447700>!  the v momentum equation.  This routine assumes a constant eddy<a name='2968'></font>
<font color=#447700>!  viscosity kvdif.<a name='2969'></font>
<font color=#447700>!<a name='2970'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2971'></font>
<a name='2972'>
   specified = .false.<a name='2973'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='2974'>
<a name='2975'>
   ktf=MIN(kte,kde-1)<a name='2976'>
   <a name='2977'>
      i_start = its<a name='2978'>
      i_end   = MIN(ite,ide-1)<a name='2979'>
      j_start = jts<a name='2980'>
      j_end   = MIN(jte,jde-1)<a name='2981'>
<a name='2982'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2983'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-1,jte)<a name='2984'>
<a name='2985'>
j_loop_v : DO j = j_start, j_end<a name='2986'>
<font color=#447700>!     jm1 = max(j-1,1)<a name='2987'></font>
     jm1 = j-1<a name='2988'>
<a name='2989'>
     DO k=kts,ktf-1<a name='2990'>
       DO i = i_start, i_end<a name='2991'>
         vflux(i,k)=kvdif*rdn(k+1)/(0.25*( alt(i,k  ,j  )      &amp;<a name='2992'>
                                        +alt(i,k  ,jm1)      &amp;<a name='2993'>
                                        +alt(i,k+1,j  )      &amp;<a name='2994'>
                                        +alt(i,k+1,jm1) ) )  &amp;<a name='2995'>
                             *(field(i,k+1,j)-field(i,k,j)   &amp;<a name='2996'>
                               -v_base(k+1)   +v_base(k)  )<a name='2997'>
       ENDDO<a name='2998'>
     ENDDO<a name='2999'>
<a name='3000'>
     DO i = i_start, i_end<a name='3001'>
       vflux(i,0)=vflux(i,1)<a name='3002'>
     ENDDO<a name='3003'>
<a name='3004'>
     DO i = i_start, i_end<a name='3005'>
       vflux(i,ktf)=0.<a name='3006'>
     ENDDO<a name='3007'>
<a name='3008'>
     DO k=kts,ktf-1<a name='3009'>
       DO i = i_start, i_end <a name='3010'>
         tendency(i,k,j)=tendency(i,k,j)+                              &amp;<a name='3011'>
                g*g*rdnw(k)/muv(i,j)/(0.5*(alt(i,k,jm1)+alt(i,k,j)))*  &amp;<a name='3012'>
                              (vflux(i,k)-vflux(i,k-1))<a name='3013'>
       ENDDO<a name='3014'>
     ENDDO<a name='3015'>
<a name='3016'>
 ENDDO j_loop_v<a name='3017'>
   <a name='3018'>
END SUBROUTINE vertical_diffusion_v<a name='3019'>
<a name='3020'>
<font color=#447700>!***************  end new mass coordinate routines<a name='3021'></font>
<a name='3022'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='3023'></font>
<a name='3024'>
<A NAME='CALCULATE_FULL'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALCULATE_FULL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3025'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calculate_full</font> ( rfield, rfieldb, rfieldp,     &amp; <A href='../../call_to/CALCULATE_FULL.html' TARGET='index'>2</A><a name='3026'>
                            ids, ide, jds, jde, kds, kde, &amp;<a name='3027'>
                            ims, ime, jms, jme, kms, kme, &amp;<a name='3028'>
                            its, ite, jts, jte, kts, kte )<a name='3029'>
<a name='3030'>
   IMPLICIT NONE<a name='3031'>
   <a name='3032'>
   <font color=#447700>! Input data<a name='3033'></font>
   <a name='3034'>
   INTEGER ,      INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3035'>
                                   ims, ime, jms, jme, kms, kme, &amp;<a name='3036'>
                                   its, ite, jts, jte, kts, kte <a name='3037'>
   <a name='3038'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: rfieldb, &amp;<a name='3039'>
                                                                      rfieldp<a name='3040'>
<a name='3041'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT  ) :: rfield<a name='3042'>
   <a name='3043'>
   <font color=#447700>! Local indices.<a name='3044'></font>
   <a name='3045'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3046'>
   <a name='3047'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3048'></font>
<font color=#447700>!<a name='3049'></font>
<font color=#447700>!  calculate_full<a name='3050'></font>
<font color=#447700>!  calculates full 3D field from pertubation and base field.<a name='3051'></font>
<font color=#447700>!<a name='3052'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3053'></font>
<a name='3054'>
   itf=MIN(ite,ide-1)<a name='3055'>
   jtf=MIN(jte,jde-1)<a name='3056'>
   ktf=MIN(kte,kde-1)<a name='3057'>
<a name='3058'>
   DO j=jts,jtf<a name='3059'>
   DO k=kts,ktf<a name='3060'>
   DO i=its,itf<a name='3061'>
      rfield(i,k,j)=rfieldb(i,k,j)+rfieldp(i,k,j)<a name='3062'>
   ENDDO<a name='3063'>
   ENDDO<a name='3064'>
   ENDDO<a name='3065'>
<a name='3066'>
END SUBROUTINE calculate_full<a name='3067'>
<a name='3068'>
<font color=#447700>!------------------------------------------------------------------------------<a name='3069'></font>
<a name='3070'>
<A NAME='CORIOLIS'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CORIOLIS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3071'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>coriolis</font> ( ru, rv, rw, ru_tend, rv_tend, rw_tend, &amp; <A href='../../call_to/CORIOLIS.html' TARGET='index'>1</A><a name='3072'>
                      config_flags,                          &amp;<a name='3073'>
                      f, e, sina, cosa, fzm, fzp,            &amp;<a name='3074'>
                      ids, ide, jds, jde, kds, kde,          &amp;<a name='3075'>
                      ims, ime, jms, jme, kms, kme,          &amp;<a name='3076'>
                      its, ite, jts, jte, kts, kte          )<a name='3077'>
<a name='3078'>
   IMPLICIT NONE<a name='3079'>
   <a name='3080'>
   <font color=#447700>! Input data<a name='3081'></font>
   <a name='3082'>
   TYPE(grid_config_rec_type) ,           INTENT(IN   ) :: config_flags   <a name='3083'>
<a name='3084'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3085'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='3086'>
                                              its, ite, jts, jte, kts, kte<a name='3087'>
<a name='3088'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: ru_tend, &amp;<a name='3089'>
                                                                rv_tend, &amp;<a name='3090'>
                                                                rw_tend<a name='3091'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: ru, &amp;<a name='3092'>
                                                                rv, &amp;<a name='3093'>
                                                                rw<a name='3094'>
<a name='3095'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: f,    &amp;<a name='3096'>
                                                                    e,    &amp;<a name='3097'>
                                                                    sina, &amp;<a name='3098'>
                                                                    cosa<a name='3099'>
<a name='3100'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm, &amp;<a name='3101'>
                                                                  fzp<a name='3102'>
   <a name='3103'>
   <font color=#447700>! Local indices.<a name='3104'></font>
   <a name='3105'>
   INTEGER :: i, j , k, ktf<a name='3106'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3107'>
   <a name='3108'>
   LOGICAL :: specified<a name='3109'>
<a name='3110'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3111'></font>
<font color=#447700>!<a name='3112'></font>
<font color=#447700>!  coriolis calculates the large timestep tendency terms in the <a name='3113'></font>
<font color=#447700>!  u, v, and w momentum equations arise from the coriolis force.<a name='3114'></font>
<font color=#447700>!<a name='3115'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3116'></font>
<a name='3117'>
   specified = .false.<a name='3118'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3119'>
<a name='3120'>
   ktf=MIN(kte,kde-1)<a name='3121'>
<a name='3122'>
<font color=#447700>! coriolis for u-momentum equation<a name='3123'></font>
<a name='3124'>
   i_start = its<a name='3125'>
   i_end   = ite<a name='3126'>
   IF ( config_flags%open_xs .or. specified .or. &amp;<a name='3127'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='3128'>
   IF ( config_flags%open_xe .or. specified .or. &amp;<a name='3129'>
        config_flags%nested) i_end   = MIN(ide-1,ite)<a name='3130'>
<a name='3131'>
   DO j = jts, MIN(jte,jde-1)<a name='3132'>
<a name='3133'>
   DO k=kts,ktf<a name='3134'>
   DO i = i_start, i_end<a name='3135'>
   <a name='3136'>
     ru_tend(i,k,j)=ru_tend(i,k,j) + 0.5*(f(i,j)+f(i-1,j)) &amp;<a name='3137'>
       *0.25*(rv(i-1,k,j+1)+rv(i,k,j+1)+rv(i-1,k,j)+rv(i,k,j)) &amp;<a name='3138'>
           - 0.5*(e(i,j)+e(i-1,j))*0.5*(cosa(i,j)+cosa(i-1,j)) &amp;<a name='3139'>
       *0.25*(rw(i-1,k+1,j)+rw(i-1,k,j)+rw(i,k+1,j)+rw(i,k,j))<a name='3140'>
<a name='3141'>
   ENDDO<a name='3142'>
   ENDDO<a name='3143'>
<a name='3144'>
   IF ( (config_flags%open_xs) .and. (its == ids) ) THEN<a name='3145'>
<a name='3146'>
     DO k=kts,ktf<a name='3147'>
   <a name='3148'>
       ru_tend(its,k,j)=ru_tend(its,k,j) + 0.5*(f(its,j)+f(its,j))   &amp;<a name='3149'>
         *0.25*(rv(its,k,j+1)+rv(its,k,j+1)+rv(its,k,j)+rv(its,k,j)) &amp;<a name='3150'>
             - 0.5*(e(its,j)+e(its,j))*0.5*(cosa(its,j)+cosa(its,j)) &amp;<a name='3151'>
         *0.25*(rw(its,k+1,j)+rw(its,k,j)+rw(its,k+1,j)+rw(its,k,j))<a name='3152'>
<a name='3153'>
     ENDDO<a name='3154'>
<a name='3155'>
   ENDIF<a name='3156'>
<a name='3157'>
   IF ( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='3158'>
<a name='3159'>
     DO k=kts,ktf<a name='3160'>
   <a name='3161'>
       ru_tend(ite,k,j)=ru_tend(ite,k,j) + 0.5*(f(ite-1,j)+f(ite-1,j)) &amp;<a name='3162'>
         *0.25*(rv(ite-1,k,j+1)+rv(ite-1,k,j+1)+rv(ite-1,k,j)+rv(ite-1,k,j)) &amp;<a name='3163'>
             - 0.5*(e(ite-1,j)+e(ite-1,j))*0.5*(cosa(ite-1,j)+cosa(ite-1,j)) &amp;<a name='3164'>
         *0.25*(rw(ite-1,k+1,j)+rw(ite-1,k,j)+rw(ite-1,k+1,j)+rw(ite-1,k,j))<a name='3165'>
<a name='3166'>
     ENDDO<a name='3167'>
<a name='3168'>
   ENDIF<a name='3169'>
<a name='3170'>
   ENDDO<a name='3171'>
<a name='3172'>
<font color=#447700>!  coriolis term for v-momentum equation<a name='3173'></font>
<a name='3174'>
   j_start = jts<a name='3175'>
   j_end   = jte<a name='3176'>
<a name='3177'>
   IF ( config_flags%open_ys .or. specified .or. &amp;<a name='3178'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='3179'>
   IF ( config_flags%open_ye .or. specified .or. &amp;<a name='3180'>
        config_flags%nested) j_end   = MIN(jde-1,jte)<a name='3181'>
<a name='3182'>
   IF ( (config_flags%open_ys) .and. (jts == jds) ) THEN<a name='3183'>
<a name='3184'>
     DO k=kts,ktf<a name='3185'>
     DO i=its,MIN(ide-1,ite)<a name='3186'>
   <a name='3187'>
        rv_tend(i,k,jts)=rv_tend(i,k,jts) - 0.5*(f(i,jts)+f(i,jts))    &amp;<a name='3188'>
         *0.25*(ru(i,k,jts)+ru(i+1,k,jts)+ru(i,k,jts)+ru(i+1,k,jts))   &amp;<a name='3189'>
             + 0.5*(e(i,jts)+e(i,jts))*0.5*(sina(i,jts)+sina(i,jts))   &amp;<a name='3190'>
             *0.25*(rw(i,k+1,jts)+rw(i,k,jts)+rw(i,k+1,jts)+rw(i,k,jts)) <a name='3191'>
<a name='3192'>
     ENDDO<a name='3193'>
     ENDDO<a name='3194'>
<a name='3195'>
   ENDIF<a name='3196'>
<a name='3197'>
   DO j=j_start, j_end<a name='3198'>
   DO k=kts,ktf<a name='3199'>
   DO i=its,MIN(ide-1,ite)<a name='3200'>
   <a name='3201'>
      rv_tend(i,k,j)=rv_tend(i,k,j) - 0.5*(f(i,j)+f(i,j-1))    &amp;<a name='3202'>
       *0.25*(ru(i,k,j)+ru(i+1,k,j)+ru(i,k,j-1)+ru(i+1,k,j-1)) &amp;<a name='3203'>
           + 0.5*(e(i,j)+e(i,j-1))*0.5*(sina(i,j)+sina(i,j-1)) &amp;<a name='3204'>
           *0.25*(rw(i,k+1,j-1)+rw(i,k,j-1)+rw(i,k+1,j)+rw(i,k,j)) <a name='3205'>
<a name='3206'>
   ENDDO<a name='3207'>
   ENDDO<a name='3208'>
   ENDDO<a name='3209'>
<a name='3210'>
<a name='3211'>
   IF ( (config_flags%open_ye) .and. (jte == jde) ) THEN<a name='3212'>
<a name='3213'>
     DO k=kts,ktf<a name='3214'>
     DO i=its,MIN(ide-1,ite)<a name='3215'>
   <a name='3216'>
        rv_tend(i,k,jte)=rv_tend(i,k,jte) - 0.5*(f(i,jte-1)+f(i,jte-1))        &amp;<a name='3217'>
         *0.25*(ru(i,k,jte-1)+ru(i+1,k,jte-1)+ru(i,k,jte-1)+ru(i+1,k,jte-1))   &amp;<a name='3218'>
             + 0.5*(e(i,jte-1)+e(i,jte-1))*0.5*(sina(i,jte-1)+sina(i,jte-1))   &amp;<a name='3219'>
             *0.25*(rw(i,k+1,jte-1)+rw(i,k,jte-1)+rw(i,k+1,jte-1)+rw(i,k,jte-1)) <a name='3220'>
<a name='3221'>
     ENDDO<a name='3222'>
     ENDDO<a name='3223'>
<a name='3224'>
   ENDIF<a name='3225'>
<a name='3226'>
<font color=#447700>! coriolis term for w-mometum <a name='3227'></font>
<a name='3228'>
   DO j=jts,MIN(jte, jde-1)<a name='3229'>
   DO k=kts+1,ktf<a name='3230'>
   DO i=its,MIN(ite, ide-1)<a name='3231'>
<a name='3232'>
       rw_tend(i,k,j)=rw_tend(i,k,j) + e(i,j)*           &amp;<a name='3233'>
          (cosa(i,j)*0.5*(fzm(k)*(ru(i,k,j)+ru(i+1,k,j)) &amp;<a name='3234'>
          +fzp(k)*(ru(i,k-1,j)+ru(i+1,k-1,j)))           &amp;<a name='3235'>
          -sina(i,j)*0.5*(fzm(k)*(rv(i,k,j)+rv(i,k,j+1)) &amp; <a name='3236'>
          +fzp(k)*(rv(i,k-1,j)+rv(i,k-1,j+1))))<a name='3237'>
<a name='3238'>
   ENDDO<a name='3239'>
   ENDDO<a name='3240'>
   ENDDO<a name='3241'>
<a name='3242'>
END SUBROUTINE coriolis<a name='3243'>
<a name='3244'>
<font color=#447700>!------------------------------------------------------------------------------<a name='3245'></font>
<a name='3246'>
<A NAME='PERTURBATION_CORIOLIS'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PERTURBATION_CORIOLIS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3247'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>perturbation_coriolis</font> ( ru_in, rv_in, rw, ru_tend, rv_tend, rw_tend, &amp; <A href='../../call_to/PERTURBATION_CORIOLIS.html' TARGET='index'>1</A><a name='3248'>
                                   config_flags,                                &amp;<a name='3249'>
                                   u_base, v_base, z_base,                      &amp;<a name='3250'>
                                   muu, muv, phb, ph,                           &amp;<a name='3251'>
                                   f, e, sina, cosa, fzm, fzp,                  &amp;<a name='3252'>
                                   ids, ide, jds, jde, kds, kde,                &amp;<a name='3253'>
                                   ims, ime, jms, jme, kms, kme,                &amp;<a name='3254'>
                                   its, ite, jts, jte, kts, kte                )<a name='3255'>
<a name='3256'>
   IMPLICIT NONE<a name='3257'>
   <a name='3258'>
   <font color=#447700>! Input data<a name='3259'></font>
   <a name='3260'>
   TYPE(grid_config_rec_type) ,           INTENT(IN   ) :: config_flags   <a name='3261'>
<a name='3262'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3263'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='3264'>
                                              its, ite, jts, jte, kts, kte<a name='3265'>
<a name='3266'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: ru_tend, &amp;<a name='3267'>
                                                                rv_tend, &amp;<a name='3268'>
                                                                rw_tend<a name='3269'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: ru_in, &amp;<a name='3270'>
                                                                      rv_in, &amp;<a name='3271'>
                                                                      rw,    &amp;<a name='3272'>
                                                                      ph,    &amp;<a name='3273'>
                                                                      phb<a name='3274'>
<a name='3275'>
<a name='3276'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: f,    &amp;<a name='3277'>
                                                                    e,    &amp;<a name='3278'>
                                                                    sina, &amp;<a name='3279'>
                                                                    cosa<a name='3280'>
<a name='3281'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: muu, &amp;<a name='3282'>
                                                                    muv<a name='3283'>
                                                                    <a name='3284'>
<a name='3285'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm, &amp;<a name='3286'>
                                                                  fzp<a name='3287'>
<a name='3288'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: u_base,  &amp;<a name='3289'>
                                                                  v_base,  &amp;<a name='3290'>
                                                                  z_base<a name='3291'>
   <a name='3292'>
   <font color=#447700>! Local storage<a name='3293'></font>
<a name='3294'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) :: ru, &amp;<a name='3295'>
                                                      rv<a name='3296'>
<a name='3297'>
   REAL  :: z_at_u, z_at_v, wkp1, wk, wkm1<a name='3298'>
<a name='3299'>
   <font color=#447700>! Local indices.<a name='3300'></font>
   <a name='3301'>
   INTEGER :: i, j , k, ktf<a name='3302'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3303'>
   <a name='3304'>
   LOGICAL :: specified<a name='3305'>
<a name='3306'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3307'></font>
<font color=#447700>!<a name='3308'></font>
<font color=#447700>!  perturbation_coriolis calculates the large timestep tendency terms in the <a name='3309'></font>
<font color=#447700>!  u, v, and w momentum equations arise from the coriolis force.  This version<a name='3310'></font>
<font color=#447700>!  subtracts off the horizontal velocities from the initial sounding when<a name='3311'></font>
<font color=#447700>!  computing the forcing terms, hence "perturbation" coriolis.<a name='3312'></font>
<font color=#447700>!<a name='3313'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3314'></font>
<a name='3315'>
   specified = .false.<a name='3316'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3317'>
<a name='3318'>
   ktf=MIN(kte,kde-1)<a name='3319'>
<a name='3320'>
<font color=#447700>! coriolis for u-momentum equation<a name='3321'></font>
<a name='3322'>
   i_start = its<a name='3323'>
   i_end   = ite<a name='3324'>
   IF ( config_flags%open_xs .or. specified .or. &amp;<a name='3325'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='3326'>
   IF ( config_flags%open_xe .or. specified .or. &amp;<a name='3327'>
        config_flags%nested) i_end   = MIN(ide-1,ite)<a name='3328'>
<a name='3329'>
<font color=#447700>!  compute perturbation mu*v for use in u momentum equation<a name='3330'></font>
<a name='3331'>
   DO j = jts, MIN(jte,jde-1)+1<a name='3332'>
   DO k=kts+1,ktf-1<a name='3333'>
   DO i = i_start-1, i_end<a name='3334'>
     z_at_v = 0.25*( phb(i,k,j  )+phb(i,k+1,j  )  &amp;<a name='3335'>
                    +phb(i,k,j-1)+phb(i,k+1,j-1)  &amp;<a name='3336'>
                    +ph(i,k,j  )+ph(i,k+1,j  )    &amp;<a name='3337'>
                    +ph(i,k,j-1)+ph(i,k+1,j-1))/g<a name='3338'>
     wkp1 = min(1.,max(0.,z_at_v-z_base(k))/(z_base(k+1)-z_base(k)))<a name='3339'>
     wkm1 = min(1.,max(0.,z_base(k)-z_at_v)/(z_base(k)-z_base(k-1)))<a name='3340'>
     wk   = 1.-wkp1-wkm1<a name='3341'>
     rv(i,k,j) = rv_in(i,k,j) - muv(i,j)*(            &amp;<a name='3342'>
                                  wkm1*v_base(k-1)    &amp;<a name='3343'>
                                 +wk  *v_base(k  )    &amp;<a name='3344'>
                                 +wkp1*v_base(k+1)   )<a name='3345'>
   ENDDO<a name='3346'>
   ENDDO<a name='3347'>
   ENDDO<a name='3348'>
<a name='3349'>
<a name='3350'>
<font color=#447700>!  pick up top and bottom v <a name='3351'></font>
<a name='3352'>
   DO j = jts, MIN(jte,jde-1)+1<a name='3353'>
   DO i = i_start-1, i_end<a name='3354'>
<a name='3355'>
     k = kts<a name='3356'>
     z_at_v = 0.25*( phb(i,k,j  )+phb(i,k+1,j  )  &amp;<a name='3357'>
                    +phb(i,k,j-1)+phb(i,k+1,j-1)  &amp;<a name='3358'>
                    +ph(i,k,j  )+ph(i,k+1,j  )    &amp;<a name='3359'>
                    +ph(i,k,j-1)+ph(i,k+1,j-1))/g<a name='3360'>
     wkp1 = min(1.,max(0.,z_at_v-z_base(k))/(z_base(k+1)-z_base(k)))<a name='3361'>
     wk   = 1.-wkp1<a name='3362'>
     rv(i,k,j) = rv_in(i,k,j) - muv(i,j)*(            &amp;<a name='3363'>
                                 +wk  *v_base(k  )    &amp;<a name='3364'>
                                 +wkp1*v_base(k+1)   )<a name='3365'>
<a name='3366'>
     k = ktf<a name='3367'>
     z_at_v = 0.25*( phb(i,k,j  )+phb(i,k+1,j  )  &amp;<a name='3368'>
                    +phb(i,k,j-1)+phb(i,k+1,j-1)  &amp;<a name='3369'>
                    +ph(i,k,j  )+ph(i,k+1,j  )    &amp;<a name='3370'>
                    +ph(i,k,j-1)+ph(i,k+1,j-1))/g<a name='3371'>
     wkm1 = min(1.,max(0.,z_base(k)-z_at_v)/(z_base(k)-z_base(k-1)))<a name='3372'>
     wk   = 1.-wkm1<a name='3373'>
     rv(i,k,j) = rv_in(i,k,j) - muv(i,j)*(            &amp;<a name='3374'>
                                  wkm1*v_base(k-1)    &amp;<a name='3375'>
                                 +wk  *v_base(k  )   )<a name='3376'>
<a name='3377'>
   ENDDO<a name='3378'>
   ENDDO<a name='3379'>
<a name='3380'>
<font color=#447700>!  compute coriolis forcing for u<a name='3381'></font>
<a name='3382'>
   DO j = jts, MIN(jte,jde-1)<a name='3383'>
<a name='3384'>
   DO k=kts,ktf<a name='3385'>
     DO i = i_start, i_end<a name='3386'>
       ru_tend(i,k,j)=ru_tend(i,k,j) + 0.5*(f(i,j)+f(i-1,j)) &amp;<a name='3387'>
         *0.25*(rv(i-1,k,j+1)+rv(i,k,j+1)+rv(i-1,k,j)+rv(i,k,j)) &amp;<a name='3388'>
             - 0.5*(e(i,j)+e(i-1,j))*0.5*(cosa(i,j)+cosa(i-1,j)) &amp;<a name='3389'>
         *0.25*(rw(i-1,k+1,j)+rw(i-1,k,j)+rw(i,k+1,j)+rw(i,k,j))<a name='3390'>
     ENDDO<a name='3391'>
   ENDDO<a name='3392'>
<a name='3393'>
   IF ( (config_flags%open_xs) .and. (its == ids) ) THEN<a name='3394'>
<a name='3395'>
     DO k=kts,ktf<a name='3396'>
   <a name='3397'>
       ru_tend(its,k,j)=ru_tend(its,k,j) + 0.5*(f(its,j)+f(its,j))   &amp;<a name='3398'>
         *0.25*(rv(its,k,j+1)+rv(its,k,j+1)+rv(its,k,j)+rv(its,k,j)) &amp;<a name='3399'>
             - 0.5*(e(its,j)+e(its,j))*0.5*(cosa(its,j)+cosa(its,j)) &amp;<a name='3400'>
         *0.25*(rw(its,k+1,j)+rw(its,k,j)+rw(its,k+1,j)+rw(its,k,j))<a name='3401'>
<a name='3402'>
     ENDDO<a name='3403'>
<a name='3404'>
   ENDIF<a name='3405'>
<a name='3406'>
   IF ( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='3407'>
<a name='3408'>
     DO k=kts,ktf<a name='3409'>
   <a name='3410'>
       ru_tend(ite,k,j)=ru_tend(ite,k,j) + 0.5*(f(ite-1,j)+f(ite-1,j)) &amp;<a name='3411'>
         *0.25*(rv(ite-1,k,j+1)+rv(ite-1,k,j+1)+rv(ite-1,k,j)+rv(ite-1,k,j)) &amp;<a name='3412'>
             - 0.5*(e(ite-1,j)+e(ite-1,j))*0.5*(cosa(ite-1,j)+cosa(ite-1,j)) &amp;<a name='3413'>
         *0.25*(rw(ite-1,k+1,j)+rw(ite-1,k,j)+rw(ite-1,k+1,j)+rw(ite-1,k,j))<a name='3414'>
<a name='3415'>
     ENDDO<a name='3416'>
<a name='3417'>
   ENDIF<a name='3418'>
<a name='3419'>
   ENDDO<a name='3420'>
<a name='3421'>
<font color=#447700>!  coriolis term for v-momentum equation<a name='3422'></font>
<a name='3423'>
   j_start = jts<a name='3424'>
   j_end   = jte<a name='3425'>
<a name='3426'>
   IF ( config_flags%open_ys .or. specified .or. &amp;<a name='3427'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='3428'>
   IF ( config_flags%open_ye .or. specified .or. &amp;<a name='3429'>
        config_flags%nested) j_end   = MIN(jde-1,jte)<a name='3430'>
<a name='3431'>
<font color=#447700>!  compute perturbation mu*u for use in v momentum equation<a name='3432'></font>
<a name='3433'>
   DO j = j_start-1,j_end<a name='3434'>
   DO k=kts+1,ktf-1<a name='3435'>
   DO i = its, MIN(ite,ide-1)+1<a name='3436'>
     z_at_u = 0.25*( phb(i  ,k,j)+phb(i  ,k+1,j)  &amp;<a name='3437'>
                    +phb(i-1,k,j)+phb(i-1,k+1,j)  &amp;<a name='3438'>
                    +ph(i  ,k,j)+ph(i  ,k+1,j)    &amp;<a name='3439'>
                    +ph(i-1,k,j)+ph(i-1,k+1,j))/g<a name='3440'>
     wkp1 = min(1.,max(0.,z_at_u-z_base(k))/(z_base(k+1)-z_base(k)))<a name='3441'>
     wkm1 = min(1.,max(0.,z_base(k)-z_at_u)/(z_base(k)-z_base(k-1)))<a name='3442'>
     wk   = 1.-wkp1-wkm1<a name='3443'>
     ru(i,k,j) = ru_in(i,k,j) - muu(i,j)*(            &amp;<a name='3444'>
                                  wkm1*u_base(k-1)    &amp;<a name='3445'>
                                 +wk  *u_base(k  )    &amp;<a name='3446'>
                                 +wkp1*u_base(k+1)   )<a name='3447'>
   ENDDO<a name='3448'>
   ENDDO<a name='3449'>
   ENDDO<a name='3450'>
<a name='3451'>
<font color=#447700>!  pick up top and bottom u<a name='3452'></font>
<a name='3453'>
   DO j = j_start-1,j_end<a name='3454'>
   DO i = its, MIN(ite,ide-1)+1<a name='3455'>
<a name='3456'>
     k = kts<a name='3457'>
     z_at_u = 0.25*( phb(i  ,k,j)+phb(i  ,k+1,j)  &amp;<a name='3458'>
                    +phb(i-1,k,j)+phb(i-1,k+1,j)  &amp;<a name='3459'>
                    +ph(i  ,k,j)+ph(i  ,k+1,j)    &amp;<a name='3460'>
                    +ph(i-1,k,j)+ph(i-1,k+1,j))/g<a name='3461'>
     wkp1 = min(1.,max(0.,z_at_u-z_base(k))/(z_base(k+1)-z_base(k)))<a name='3462'>
     wk   = 1.-wkp1<a name='3463'>
     ru(i,k,j) = ru_in(i,k,j) - muu(i,j)*(            &amp;<a name='3464'>
                                 +wk  *u_base(k  )    &amp;<a name='3465'>
                                 +wkp1*u_base(k+1)   )<a name='3466'>
<a name='3467'>
<a name='3468'>
     k = ktf<a name='3469'>
     z_at_u = 0.25*( phb(i  ,k,j)+phb(i  ,k+1,j)  &amp;<a name='3470'>
                    +phb(i-1,k,j)+phb(i-1,k+1,j)  &amp;<a name='3471'>
                    +ph(i  ,k,j)+ph(i  ,k+1,j)    &amp;<a name='3472'>
                    +ph(i-1,k,j)+ph(i-1,k+1,j))/g<a name='3473'>
     wkm1 = min(1.,max(0.,z_base(k)-z_at_u)/(z_base(k)-z_base(k-1)))<a name='3474'>
     wk   = 1.-wkm1<a name='3475'>
     ru(i,k,j) = ru_in(i,k,j) - muu(i,j)*(            &amp;<a name='3476'>
                                  wkm1*u_base(k-1)    &amp;<a name='3477'>
                                 +wk  *u_base(k  )   )<a name='3478'>
<a name='3479'>
   ENDDO<a name='3480'>
   ENDDO<a name='3481'>
<a name='3482'>
<font color=#447700>!  compute coriolis forcing for v momentum equation<a name='3483'></font>
<a name='3484'>
   IF ( (config_flags%open_ys) .and. (jts == jds) ) THEN<a name='3485'>
<a name='3486'>
     DO k=kts,ktf<a name='3487'>
     DO i=its,MIN(ide-1,ite)<a name='3488'>
   <a name='3489'>
        rv_tend(i,k,jts)=rv_tend(i,k,jts) - 0.5*(f(i,jts)+f(i,jts))    &amp;<a name='3490'>
         *0.25*(ru(i,k,jts)+ru(i+1,k,jts)+ru(i,k,jts)+ru(i+1,k,jts))   &amp;<a name='3491'>
             + 0.5*(e(i,jts)+e(i,jts))*0.5*(sina(i,jts)+sina(i,jts))   &amp;<a name='3492'>
             *0.25*(rw(i,k+1,jts)+rw(i,k,jts)+rw(i,k+1,jts)+rw(i,k,jts)) <a name='3493'>
<a name='3494'>
     ENDDO<a name='3495'>
     ENDDO<a name='3496'>
<a name='3497'>
   ENDIF<a name='3498'>
<a name='3499'>
   DO j=j_start, j_end<a name='3500'>
   DO k=kts,ktf<a name='3501'>
   DO i=its,MIN(ide-1,ite)<a name='3502'>
   <a name='3503'>
      rv_tend(i,k,j)=rv_tend(i,k,j) - 0.5*(f(i,j)+f(i,j-1))    &amp;<a name='3504'>
       *0.25*(ru(i,k,j)+ru(i+1,k,j)+ru(i,k,j-1)+ru(i+1,k,j-1)) &amp;<a name='3505'>
           + 0.5*(e(i,j)+e(i,j-1))*0.5*(sina(i,j)+sina(i,j-1)) &amp;<a name='3506'>
           *0.25*(rw(i,k+1,j-1)+rw(i,k,j-1)+rw(i,k+1,j)+rw(i,k,j)) <a name='3507'>
<a name='3508'>
   ENDDO<a name='3509'>
   ENDDO<a name='3510'>
   ENDDO<a name='3511'>
<a name='3512'>
<a name='3513'>
   IF ( (config_flags%open_ye) .and. (jte == jde) ) THEN<a name='3514'>
<a name='3515'>
     DO k=kts,ktf<a name='3516'>
     DO i=its,MIN(ide-1,ite)<a name='3517'>
   <a name='3518'>
        rv_tend(i,k,jte)=rv_tend(i,k,jte) - 0.5*(f(i,jte-1)+f(i,jte-1))        &amp;<a name='3519'>
         *0.25*(ru(i,k,jte-1)+ru(i+1,k,jte-1)+ru(i,k,jte-1)+ru(i+1,k,jte-1))   &amp;<a name='3520'>
             + 0.5*(e(i,jte-1)+e(i,jte-1))*0.5*(sina(i,jte-1)+sina(i,jte-1))   &amp;<a name='3521'>
             *0.25*(rw(i,k+1,jte-1)+rw(i,k,jte-1)+rw(i,k+1,jte-1)+rw(i,k,jte-1)) <a name='3522'>
<a name='3523'>
     ENDDO<a name='3524'>
     ENDDO<a name='3525'>
<a name='3526'>
   ENDIF<a name='3527'>
<a name='3528'>
<font color=#447700>! coriolis term for w-mometum <a name='3529'></font>
<a name='3530'>
   DO j=jts,MIN(jte, jde-1)<a name='3531'>
   DO k=kts+1,ktf<a name='3532'>
   DO i=its,MIN(ite, ide-1)<a name='3533'>
<a name='3534'>
       rw_tend(i,k,j)=rw_tend(i,k,j) + e(i,j)*           &amp;<a name='3535'>
          (cosa(i,j)*0.5*(fzm(k)*(ru(i,k,j)+ru(i+1,k,j)) &amp;<a name='3536'>
          +fzp(k)*(ru(i,k-1,j)+ru(i+1,k-1,j)))           &amp;<a name='3537'>
          -sina(i,j)*0.5*(fzm(k)*(rv(i,k,j)+rv(i,k,j+1)) &amp; <a name='3538'>
          +fzp(k)*(rv(i,k-1,j)+rv(i,k-1,j+1))))<a name='3539'>
<a name='3540'>
   ENDDO<a name='3541'>
   ENDDO<a name='3542'>
   ENDDO<a name='3543'>
<a name='3544'>
END SUBROUTINE perturbation_coriolis<a name='3545'>
<a name='3546'>
<font color=#447700>!------------------------------------------------------------------------------<a name='3547'></font>
<a name='3548'>
<A NAME='CURVATURE'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CURVATURE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3549'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>curvature</font> ( ru, rv, rw, u, v, w, ru_tend, rv_tend, rw_tend, &amp; <A href='../../call_to/CURVATURE.html' TARGET='index'>1</A><a name='3550'>
                        config_flags,                                       &amp;<a name='3551'>
                        msfu, msfv, fzm, fzp, rdx, rdy,                 &amp;<a name='3552'>
                        ids, ide, jds, jde, kds, kde,                   &amp;<a name='3553'>
                        ims, ime, jms, jme, kms, kme,                   &amp;<a name='3554'>
                        its, ite, jts, jte, kts, kte                   )<a name='3555'>
<a name='3556'>
<a name='3557'>
   IMPLICIT NONE<a name='3558'>
   <a name='3559'>
   <font color=#447700>! Input data<a name='3560'></font>
<a name='3561'>
   TYPE(grid_config_rec_type) ,           INTENT(IN   ) :: config_flags   <a name='3562'>
<a name='3563'>
   INTEGER ,                  INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3564'>
                                               ims, ime, jms, jme, kms, kme, &amp;<a name='3565'>
                                               its, ite, jts, jte, kts, kte<a name='3566'>
   <a name='3567'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                     &amp;<a name='3568'>
                                               INTENT(INOUT) :: ru_tend, &amp;<a name='3569'>
                                                                rv_tend, &amp;<a name='3570'>
                                                                rw_tend<a name='3571'>
<a name='3572'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                     &amp;<a name='3573'>
                                               INTENT(IN   ) :: ru,      &amp;<a name='3574'>
                                                                rv,      &amp;<a name='3575'>
                                                                rw,      &amp;<a name='3576'>
                                                                u,       &amp;<a name='3577'>
                                                                v,       &amp;<a name='3578'>
                                                                w<a name='3579'>
<a name='3580'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfu,    &amp;<a name='3581'>
                                                                msfv<a name='3582'>
<a name='3583'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,     &amp;<a name='3584'>
                                                                fzp<a name='3585'>
<a name='3586'>
   REAL ,                                      INTENT(IN   ) :: rdx,     &amp;<a name='3587'>
                                                                rdy<a name='3588'>
   <a name='3589'>
   <font color=#447700>! Local data<a name='3590'></font>
   <a name='3591'>
<font color=#447700>!   INTEGER :: i, j, k, itf, jtf, ktf, kp1, im, ip, jm, jp<a name='3592'></font>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3593'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3594'>
<font color=#447700>!   INTEGER :: irmin, irmax, jrmin, jrmax<a name='3595'></font>
<a name='3596'>
   REAL , DIMENSION( its-1:ite , kts:kte, jts-1:jte ) :: vxgm<a name='3597'>
<a name='3598'>
   LOGICAL :: specified<a name='3599'>
<a name='3600'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3601'></font>
<font color=#447700>!<a name='3602'></font>
<font color=#447700>!  curvature calculates the large timestep tendency terms in the <a name='3603'></font>
<font color=#447700>!  u, v, and w momentum equations arise from the curvature terms.  <a name='3604'></font>
<font color=#447700>!<a name='3605'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3606'></font>
<a name='3607'>
   specified = .false.<a name='3608'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3609'>
<a name='3610'>
      itf=MIN(ite,ide-1)<a name='3611'>
      jtf=MIN(jte,jde-1)<a name='3612'>
      ktf=MIN(kte,kde-1)<a name='3613'>
<a name='3614'>
<font color=#447700>!   irmin = ims<a name='3615'></font>
<font color=#447700>!   irmax = ime<a name='3616'></font>
<font color=#447700>!   jrmin = jms<a name='3617'></font>
<font color=#447700>!   jrmax = jme<a name='3618'></font>
<font color=#447700>!   IF ( config_flags%open_xs ) irmin = ids<a name='3619'></font>
<font color=#447700>!   IF ( config_flags%open_xe ) irmax = ide-1<a name='3620'></font>
<font color=#447700>!   IF ( config_flags%open_ys ) jrmin = jds<a name='3621'></font>
<font color=#447700>!   IF ( config_flags%open_ye ) jrmax = jde-1<a name='3622'></font>
   <a name='3623'>
<font color=#447700>! Define v cross grad m at scalar points - vxgm(i,j)<a name='3624'></font>
<a name='3625'>
   i_start = its-1<a name='3626'>
   i_end   = ite<a name='3627'>
   j_start = jts-1<a name='3628'>
   j_end   = jte<a name='3629'>
<a name='3630'>
   IF ( ( config_flags%open_xs .or. specified .or. &amp;<a name='3631'>
        config_flags%nested) .and. (its == ids) ) i_start = its<a name='3632'>
   IF ( ( config_flags%open_xe .or. specified .or. &amp;<a name='3633'>
        config_flags%nested) .and. (ite == ide) ) i_end   = ite-1<a name='3634'>
   IF ( ( config_flags%open_ys .or. specified .or. &amp;<a name='3635'>
        config_flags%nested) .and. (jts == jds) ) j_start = jts<a name='3636'>
   IF ( ( config_flags%open_ye .or. specified .or. &amp;<a name='3637'>
        config_flags%nested) .and. (jte == jde) ) j_end   = jte-1<a name='3638'>
<a name='3639'>
   DO j=j_start, j_end<a name='3640'>
   DO k=kts,ktf<a name='3641'>
   DO i=i_start, i_end<a name='3642'>
      vxgm(i,k,j)=0.5*(u(i,k,j)+u(i+1,k,j))*(msfv(i,j+1)-msfv(i,j))*rdy - &amp;<a name='3643'>
                  0.5*(v(i,k,j)+v(i,k,j+1))*(msfu(i+1,j)-msfu(i,j))*rdx<a name='3644'>
   ENDDO<a name='3645'>
   ENDDO<a name='3646'>
   ENDDO<a name='3647'>
<a name='3648'>
<font color=#447700>!  Pick up the boundary rows for open (radiation) lateral b.c.<a name='3649'></font>
<font color=#447700>!  Rather crude at present, we are assuming there is no<a name='3650'></font>
<font color=#447700>!    variation in this term at the boundary.<a name='3651'></font>
<a name='3652'>
   IF ( ( config_flags%open_xs .or. specified .or. &amp;<a name='3653'>
        config_flags%nested) .and. (its == ids) ) THEN<a name='3654'>
<a name='3655'>
     DO j = jts-1, jte<a name='3656'>
     DO k = kts, ktf<a name='3657'>
       vxgm(its-1,k,j) =  vxgm(its,k,j)<a name='3658'>
     ENDDO<a name='3659'>
     ENDDO<a name='3660'>
<a name='3661'>
   ENDIF<a name='3662'>
<a name='3663'>
   IF ( ( config_flags%open_xe .or. specified .or. &amp;<a name='3664'>
        config_flags%nested) .and. (ite == ide) ) THEN<a name='3665'>
<a name='3666'>
     DO j = jts-1, jte<a name='3667'>
     DO k = kts, ktf<a name='3668'>
       vxgm(ite,k,j) =  vxgm(ite-1,k,j)<a name='3669'>
     ENDDO<a name='3670'>
     ENDDO<a name='3671'>
<a name='3672'>
   ENDIF<a name='3673'>
<a name='3674'>
   IF ( ( config_flags%open_ys .or. specified .or. &amp;<a name='3675'>
        config_flags%nested) .and. (jts == jds) ) THEN<a name='3676'>
<a name='3677'>
     DO k = kts, ktf<a name='3678'>
     DO i = its-1, ite<a name='3679'>
       vxgm(i,k,jts-1) =  vxgm(i,k,jts)<a name='3680'>
     ENDDO<a name='3681'>
     ENDDO<a name='3682'>
<a name='3683'>
   ENDIF<a name='3684'>
<a name='3685'>
   IF ( ( config_flags%open_ye .or. specified .or. &amp;<a name='3686'>
        config_flags%nested) .and. (jte == jde) ) THEN<a name='3687'>
<a name='3688'>
     DO k = kts, ktf<a name='3689'>
     DO i = its-1, ite<a name='3690'>
       vxgm(i,k,jte) =  vxgm(i,k,jte-1)<a name='3691'>
     ENDDO<a name='3692'>
     ENDDO<a name='3693'>
<a name='3694'>
   ENDIF<a name='3695'>
<a name='3696'>
<font color=#447700>!  curvature term for u momentum eqn.<a name='3697'></font>
<a name='3698'>
   i_start = its<a name='3699'>
   IF ( config_flags%open_xs .or. specified .or. &amp;<a name='3700'>
        config_flags%nested) i_start = MAX ( ids+1 , its )<a name='3701'>
   IF ( config_flags%open_xe .or. specified .or. &amp;<a name='3702'>
        config_flags%nested) i_end   = MIN ( ide-1 , ite )<a name='3703'>
<a name='3704'>
   DO j=jts,MIN(jde-1,jte)<a name='3705'>
   DO k=kts,ktf<a name='3706'>
   DO i=i_start,i_end<a name='3707'>
<a name='3708'>
      ru_tend(i,k,j)=ru_tend(i,k,j) + 0.5*(vxgm(i,k,j)+vxgm(i-1,k,j)) &amp;<a name='3709'>
              *0.25*(rv(i-1,k,j+1)+rv(i,k,j+1)+rv(i-1,k,j)+rv(i,k,j)) &amp;<a name='3710'>
               - u(i,k,j)*reradius &amp;<a name='3711'>
              *0.25*(rw(i-1,k+1,j)+rw(i-1,k,j)+rw(i,k+1,j)+rw(i,k,j))<a name='3712'>
<a name='3713'>
   ENDDO<a name='3714'>
   ENDDO<a name='3715'>
   ENDDO<a name='3716'>
<a name='3717'>
<font color=#447700>!  curvature term for v momentum eqn.<a name='3718'></font>
<a name='3719'>
   j_start = jts<a name='3720'>
   IF ( config_flags%open_ys .or. specified .or. &amp;<a name='3721'>
        config_flags%nested) j_start = MAX ( jds+1 , jts )<a name='3722'>
   IF ( config_flags%open_ye .or. specified .or. &amp;<a name='3723'>
        config_flags%nested) j_end   = MIN ( jde-1 , jte ) <a name='3724'>
<a name='3725'>
   DO j=j_start,j_end<a name='3726'>
   DO k=kts,ktf<a name='3727'>
   DO i=its,MIN(ite,ide-1)<a name='3728'>
<a name='3729'>
      rv_tend(i,k,j)=rv_tend(i,k,j) - 0.5*(vxgm(i,k,j)+vxgm(i,k,j-1)) &amp;<a name='3730'>
              *0.25*(ru(i,k,j)+ru(i+1,k,j)+ru(i,k,j-1)+ru(i+1,k,j-1)) &amp;<a name='3731'>
                    + v(i,k,j)*reradius                               &amp;<a name='3732'>
              *0.25*(rw(i,k+1,j-1)+rw(i,k,j-1)+rw(i,k+1,j)+rw(i,k,j))<a name='3733'>
<a name='3734'>
   ENDDO<a name='3735'>
   ENDDO<a name='3736'>
   ENDDO<a name='3737'>
<a name='3738'>
<font color=#447700>!  curvature term for vertical momentum eqn.<a name='3739'></font>
<a name='3740'>
   DO j=jts,MIN(jte,jde-1)<a name='3741'>
   DO k=MAX(2,kts),ktf<a name='3742'>
   DO i=its,MIN(ite,ide-1)<a name='3743'>
<a name='3744'>
      rw_tend(i,k,j)=rw_tend(i,k,j) + reradius*                              &amp;<a name='3745'>
    (0.5*(fzm(k)*(ru(i,k,j)+ru(i+1,k,j))+fzp(k)*(ru(i,k-1,j)+ru(i+1,k-1,j))) &amp;<a name='3746'>
    *0.5*(fzm(k)*( u(i,k,j) +u(i+1,k,j))+fzp(k)*( u(i,k-1,j) +u(i+1,k-1,j)))     &amp;<a name='3747'>
    +0.5*(fzm(k)*(rv(i,k,j)+rv(i,k,j+1))+fzp(k)*(rv(i,k-1,j)+rv(i,k-1,j+1))) &amp;<a name='3748'>
    *0.5*(fzm(k)*( v(i,k,j) +v(i,k,j+1))+fzp(k)*( v(i,k-1,j) +v(i,k-1,j+1))))<a name='3749'>
<a name='3750'>
   ENDDO<a name='3751'>
   ENDDO<a name='3752'>
   ENDDO<a name='3753'>
<a name='3754'>
END SUBROUTINE curvature<a name='3755'>
<a name='3756'>
<font color=#447700>!------------------------------------------------------------------------------<a name='3757'></font>
<a name='3758'>
<A NAME='DECOUPLE'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DECOUPLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3759'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>decouple</font> ( rr, rfield, field, name, config_flags, &amp;<a name='3760'>
                      fzm, fzp,                          &amp;<a name='3761'>
                      ids, ide, jds, jde, kds, kde,      &amp;<a name='3762'>
                      ims, ime, jms, jme, kms, kme,      &amp;<a name='3763'>
                      its, ite, jts, jte, kts, kte      )<a name='3764'>
<a name='3765'>
   IMPLICIT NONE<a name='3766'>
<a name='3767'>
   <font color=#447700>! Input data<a name='3768'></font>
<a name='3769'>
   TYPE(grid_config_rec_type) ,           INTENT(IN   ) :: config_flags   <a name='3770'>
<a name='3771'>
   INTEGER ,                                   INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3772'>
                                                                ims, ime, jms, jme, kms, kme, &amp;<a name='3773'>
                                                                its, ite, jts, jte, kts, kte<a name='3774'>
<a name='3775'>
   CHARACTER(LEN=1) ,                          INTENT(IN   ) :: name<a name='3776'>
<a name='3777'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: rfield<a name='3778'>
<a name='3779'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: rr<a name='3780'>
   <a name='3781'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT  ) :: field<a name='3782'>
   <a name='3783'>
   REAL , DIMENSION( kms:kme ) , INTENT(IN   ) :: fzm, fzp<a name='3784'>
   <a name='3785'>
   <font color=#447700>! Local data<a name='3786'></font>
   <a name='3787'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3788'>
   <a name='3789'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3790'></font>
<font color=#447700>!<a name='3791'></font>
<font color=#447700>!  decouple decouples a variable from the column dry-air mass.<a name='3792'></font>
<font color=#447700>!<a name='3793'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3794'></font>
<a name='3795'>
   ktf=MIN(kte,kde-1)<a name='3796'>
   <a name='3797'>
   IF (name .EQ. 'u')THEN<a name='3798'>
      itf=ite<a name='3799'>
      jtf=MIN(jte,jde-1)<a name='3800'>
<a name='3801'>
      DO j=jts,jtf<a name='3802'>
      DO k=kts,ktf<a name='3803'>
      DO i=its,itf<a name='3804'>
         field(i,k,j)=rfield(i,k,j)/(0.5*(rr(i,k,j)+rr(i-1,k,j)))<a name='3805'>
      ENDDO<a name='3806'>
      ENDDO<a name='3807'>
      ENDDO<a name='3808'>
<a name='3809'>
   ELSE IF (name .EQ. 'v')THEN<a name='3810'>
      itf=MIN(ite,ide-1)<a name='3811'>
      jtf=jte<a name='3812'>
<a name='3813'>
      DO j=jts,jtf<a name='3814'>
      DO k=kts,ktf<a name='3815'>
        DO i=its,itf<a name='3816'>
             field(i,k,j)=rfield(i,k,j)/(0.5*(rr(i,k,j)+rr(i,k,j-1)))<a name='3817'>
        ENDDO<a name='3818'>
      ENDDO<a name='3819'>
      ENDDO<a name='3820'>
<a name='3821'>
   ELSE IF (name .EQ. 'w')THEN<a name='3822'>
      itf=MIN(ite,ide-1)<a name='3823'>
      jtf=MIN(jte,jde-1)<a name='3824'>
      DO j=jts,jtf<a name='3825'>
      DO k=kts+1,ktf<a name='3826'>
      DO i=its,itf<a name='3827'>
         field(i,k,j)=rfield(i,k,j)/(fzm(k)*rr(i,k,j)+fzp(k)*rr(i,k-1,j))<a name='3828'>
      ENDDO<a name='3829'>
      ENDDO<a name='3830'>
      ENDDO<a name='3831'>
<a name='3832'>
      DO j=jts,jtf<a name='3833'>
      DO i=its,itf<a name='3834'>
        field(i,kte,j) = 0.<a name='3835'>
      ENDDO<a name='3836'>
      ENDDO<a name='3837'>
<a name='3838'>
   ELSE <a name='3839'>
      itf=MIN(ite,ide-1)<a name='3840'>
      jtf=MIN(jte,jde-1)<a name='3841'>
   <font color=#447700>! For theta we will decouple tb and tp and add them to give t afterwards<a name='3842'></font>
      DO j=jts,jtf<a name='3843'>
      DO k=kts,ktf<a name='3844'>
      DO i=its,itf<a name='3845'>
         field(i,k,j)=rfield(i,k,j)/rr(i,k,j)<a name='3846'>
      ENDDO<a name='3847'>
      ENDDO<a name='3848'>
      ENDDO<a name='3849'>
   <a name='3850'>
   ENDIF<a name='3851'>
<a name='3852'>
END SUBROUTINE decouple<a name='3853'>
<a name='3854'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='3855'></font>
<a name='3856'>
<A NAME='MIX_QV'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MIX_QV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3857'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>mix_qv</font> ( qv_tend, qv_mix, rho,         &amp;<a name='3858'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='3859'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='3860'>
                    its, ite, jts, jte, kts, kte )<a name='3861'>
<a name='3862'>
   IMPLICIT NONE<a name='3863'>
<a name='3864'>
   <font color=#447700>! Input data<a name='3865'></font>
<a name='3866'>
   INTEGER ,               INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3867'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='3868'>
                                            its, ite, jts, jte, kts, kte<a name='3869'>
<a name='3870'>
   REAL , DIMENSION( ims:ime, kms:kme , jms:jme ) , INTENT(IN   ) :: qv_mix,  &amp;<a name='3871'>
                                                                     rho<a name='3872'>
<a name='3873'>
   REAL , DIMENSION( ims:ime, kms:kme , jms:jme ) , INTENT(INOUT) :: qv_tend<a name='3874'>
<a name='3875'>
   <font color=#447700>! Local data<a name='3876'></font>
   <a name='3877'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3878'>
<a name='3879'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3880'></font>
<font color=#447700>!<a name='3881'></font>
<font color=#447700>!  mix_qv adds the qv_mixing tendency to the qv tendency.<a name='3882'></font>
<font color=#447700>!<a name='3883'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3884'></font>
<a name='3885'>
   ktf=MIN(kte,kde-1)<a name='3886'>
   itf=MIN(ite,ide-1)<a name='3887'>
   jtf=MIN(jte,jde-1)<a name='3888'>
<a name='3889'>
     DO j=jts,jtf<a name='3890'>
     DO k=kts,ktf<a name='3891'>
     DO i=its,itf<a name='3892'>
<a name='3893'>
       qv_tend(i,k,j) = qv_tend(i,k,j)  + qv_mix(i,k,j)<a name='3894'>
<a name='3895'>
     ENDDO<a name='3896'>
     ENDDO<a name='3897'>
     ENDDO<a name='3898'>
<a name='3899'>
END SUBROUTINE mix_qv<a name='3900'>
<a name='3901'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='3902'></font>
<a name='3903'>
<a name='3904'>
<A NAME='ZERO_TEND'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3905'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>zero_tend</font> ( tendency,                     &amp; <A href='../../call_to/ZERO_TEND.html' TARGET='index'>21</A><a name='3906'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='3907'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='3908'>
                       its, ite, jts, jte, kts, kte )<a name='3909'>
<a name='3910'>
<a name='3911'>
   IMPLICIT NONE<a name='3912'>
   <a name='3913'>
   <font color=#447700>! Input data<a name='3914'></font>
   <a name='3915'>
   INTEGER ,                                   INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3916'>
                                                                ims, ime, jms, jme, kms, kme, &amp;<a name='3917'>
                                                                its, ite, jts, jte, kts, kte<a name='3918'>
<a name='3919'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='3920'>
<a name='3921'>
   <font color=#447700>! Local data<a name='3922'></font>
   <a name='3923'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3924'>
<a name='3925'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3926'></font>
<font color=#447700>!<a name='3927'></font>
<font color=#447700>!  zero_tend sets the input tendency array to zero.<a name='3928'></font>
<font color=#447700>!<a name='3929'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3930'></font>
<a name='3931'>
      DO j = jts, jte<a name='3932'>
      DO k = kts, kte<a name='3933'>
      DO i = its, ite<a name='3934'>
        tendency(i,k,j) = 0.<a name='3935'>
      ENDDO<a name='3936'>
      ENDDO<a name='3937'>
      ENDDO<a name='3938'>
<a name='3939'>
      END SUBROUTINE zero_tend<a name='3940'>
<a name='3941'>
<font color=#447700>!======================================================================<a name='3942'></font>
<font color=#447700>!   physics prep routines<a name='3943'></font>
<font color=#447700>!======================================================================<a name='3944'></font>
<a name='3945'>
<A NAME='PHY_PREP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PHY_PREP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3946'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>phy_prep</font> ( config_flags,                                &amp;  <font color=#447700>! input <A href='../../call_to/PHY_PREP.html' TARGET='index'>14</A><a name='3947'></font>
                         mu, u, v, p, pb, alt, ph,                    &amp;  <font color=#447700>! input<a name='3948'></font>
                         phb, t, tsk, moist, n_moist,                 &amp;  <font color=#447700>! input<a name='3949'></font>
                         mu_3d, rho, th_phy, p_phy , pi_phy ,         &amp;  <font color=#447700>! output<a name='3950'></font>
                         u_phy, v_phy, p8w, t_phy, t8w,               &amp;  <font color=#447700>! output<a name='3951'></font>
                         z, z_at_w, dz8w,                             &amp;  <font color=#447700>! output<a name='3952'></font>
                         fzm, fzp,                                    &amp;  <font color=#447700>! params<a name='3953'></font>
                         RTHRATEN,                                    &amp;<a name='3954'>
                         RTHBLTEN, RUBLTEN, RVBLTEN,                  &amp;<a name='3955'>
                         RQVBLTEN, RQCBLTEN, RQIBLTEN,                &amp;<a name='3956'>
                         RTHCUTEN, RQVCUTEN, RQCCUTEN,                &amp;<a name='3957'>
                         RQRCUTEN, RQICUTEN, RQSCUTEN,                &amp;<a name='3958'>
                         RTHFTEN,  RQVFTEN,                           &amp;<a name='3959'>
                         ids, ide, jds, jde, kds, kde,                &amp;<a name='3960'>
                         ims, ime, jms, jme, kms, kme,                &amp;<a name='3961'>
                         its, ite, jts, jte, kts, kte                )<a name='3962'>
<font color=#447700>!----------------------------------------------------------------------<a name='3963'></font>
   IMPLICIT NONE<a name='3964'>
<font color=#447700>!----------------------------------------------------------------------<a name='3965'></font>
<a name='3966'>
   TYPE(grid_config_rec_type) ,     INTENT(IN   ) :: config_flags<a name='3967'>
<a name='3968'>
   INTEGER ,        INTENT(IN   ) ::   ids, ide, jds, jde, kds, kde, &amp;<a name='3969'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='3970'>
                                       its, ite, jts, jte, kts, kte<a name='3971'>
   INTEGER ,          INTENT(IN   ) :: n_moist<a name='3972'>
<a name='3973'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme , n_moist ), INTENT(IN) :: moist<a name='3974'>
<a name='3975'>
<a name='3976'>
   REAL , DIMENSION( ims:ime, jms:jme ), INTENT(IN   )   ::     TSK, mu<a name='3977'>
<a name='3978'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                 &amp;<a name='3979'>
          INTENT(  OUT)                                  ::   u_phy, &amp;<a name='3980'>
                                                              v_phy, &amp;<a name='3981'>
                                                             pi_phy, &amp;<a name='3982'>
                                                              p_phy, &amp;<a name='3983'>
                                                                p8w, &amp;<a name='3984'>
                                                              t_phy, &amp;<a name='3985'>
                                                             th_phy, &amp;<a name='3986'>
                                                                t8w, &amp;<a name='3987'>
                                                              mu_3d, &amp;<a name='3988'>
                                                                rho, &amp;<a name='3989'>
                                                                  z, &amp;<a name='3990'>
                                                               dz8w, &amp;<a name='3991'>
                                                              z_at_w <a name='3992'>
<a name='3993'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                 &amp;<a name='3994'>
          INTENT(IN   )                                  ::      pb, &amp;<a name='3995'>
                                                                  p, &amp;<a name='3996'>
                                                                  u, &amp;<a name='3997'>
                                                                  v, &amp;<a name='3998'>
                                                                alt, &amp;<a name='3999'>
                                                                 ph, &amp;<a name='4000'>
                                                                phb, &amp;<a name='4001'>
                                                                  t<a name='4002'>
<a name='4003'>
<a name='4004'>
   REAL , DIMENSION( kms:kme ) ,           INTENT(IN   ) ::     fzm,   &amp;<a name='4005'>
                                                                fzp<a name='4006'>
<a name='4007'>
   REAL,  DIMENSION( ims:ime , kms:kme, jms:jme ),                   &amp;<a name='4008'>
          INTENT(INOUT)   ::                               RTHRATEN  <a name='4009'>
<a name='4010'>
   REAL,  DIMENSION( ims:ime , kms:kme, jms:jme ),                   &amp;<a name='4011'>
          INTENT(INOUT)   ::                               RTHCUTEN, &amp;<a name='4012'>
                                                           RQVCUTEN, &amp;<a name='4013'>
                                                           RQCCUTEN, &amp;<a name='4014'>
                                                           RQRCUTEN, &amp;<a name='4015'>
                                                           RQICUTEN, &amp;<a name='4016'>
                                                           RQSCUTEN<a name='4017'>
<a name='4018'>
   REAL,  DIMENSION( ims:ime, kms:kme, jms:jme )                   , &amp;<a name='4019'>
          INTENT(INOUT)   ::                                RUBLTEN, &amp;<a name='4020'>
                                                            RVBLTEN, &amp;<a name='4021'>
                                                           RTHBLTEN, &amp;<a name='4022'>
                                                           RQVBLTEN, &amp;<a name='4023'>
                                                           RQCBLTEN, &amp;<a name='4024'>
                                                           RQIBLTEN<a name='4025'>
<a name='4026'>
   REAL,  DIMENSION( ims:ime, kms:kme, jms:jme )                   , &amp;<a name='4027'>
          INTENT(INOUT)   ::                                RTHFTEN, &amp;<a name='4028'>
                                                            RQVFTEN<a name='4029'>
<a name='4030'>
   INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='4031'>
   INTEGER :: i, j, k<a name='4032'>
   REAL    :: w1, w2, z0, z1, z2<a name='4033'>
<a name='4034'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4035'></font>
<a name='4036'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4037'></font>
<font color=#447700>!<a name='4038'></font>
<font color=#447700>!  phys_prep calculates a number of diagnostic quantities needed by<a name='4039'></font>
<font color=#447700>!  the physics routines.  It also decouples the physics tendencies from<a name='4040'></font>
<font color=#447700>!  the column dry-air mass (the physics routines expect to see/update the<a name='4041'></font>
<font color=#447700>!  uncoupled tendencies).<a name='4042'></font>
<font color=#447700>!<a name='4043'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4044'></font>
<a name='4045'>
<font color=#447700>!  set up loop bounds for this grid's boundary conditions<a name='4046'></font>
<a name='4047'>
    i_start = its<a name='4048'>
    i_end   = min( ite,ide-1 )<a name='4049'>
    j_start = jts<a name='4050'>
    j_end   = min( jte,jde-1 )<a name='4051'>
<a name='4052'>
    k_start = kts<a name='4053'>
    k_end = min( kte, kde-1 )<a name='4054'>
<a name='4055'>
<font color=#447700>!  compute thermodynamics and velocities at pressure points<a name='4056'></font>
<a name='4057'>
    do j = j_start,j_end<a name='4058'>
    do k = k_start, k_end<a name='4059'>
    do i = i_start, i_end<a name='4060'>
<a name='4061'>
      th_phy(i,k,j) = t(i,k,j) + t0<a name='4062'>
      p_phy(i,k,j) = p(i,k,j) + pb(i,k,j)<a name='4063'>
      pi_phy(i,k,j) = (p_phy(i,k,j)/p1000mb)**rcp<a name='4064'>
      t_phy(i,k,j) = th_phy(i,k,j)*pi_phy(i,k,j)<a name='4065'>
      rho(i,k,j) = 1./alt(i,k,j)*(1.+moist(i,k,j,P_QV))<a name='4066'>
      mu_3d(i,k,j) = mu(i,j)<a name='4067'>
      u_phy(i,k,j) = 0.5*(u(i,k,j)+u(i+1,k,j))<a name='4068'>
      v_phy(i,k,j) = 0.5*(v(i,k,j)+v(i,k,j+1))<a name='4069'>
<a name='4070'>
    enddo<a name='4071'>
    enddo<a name='4072'>
    enddo<a name='4073'>
<a name='4074'>
<font color=#447700>!  compute z at w points<a name='4075'></font>
<a name='4076'>
    do j = j_start,j_end<a name='4077'>
    do k = k_start, kte<a name='4078'>
    do i = i_start, i_end<a name='4079'>
      z_at_w(i,k,j) = (phb(i,k,j)+ph(i,k,j))/g<a name='4080'>
    enddo<a name='4081'>
    enddo<a name='4082'>
    enddo<a name='4083'>
<a name='4084'>
    do j = j_start,j_end<a name='4085'>
    do k = k_start, kte-1<a name='4086'>
    do i = i_start, i_end<a name='4087'>
      dz8w(i,k,j) = z_at_w(i,k+1,j)-z_at_w(i,k,j)<a name='4088'>
    enddo<a name='4089'>
    enddo<a name='4090'>
    enddo<a name='4091'>
<a name='4092'>
    do j = j_start,j_end<a name='4093'>
    do i = i_start, i_end<a name='4094'>
      dz8w(i,kte,j) = 0.<a name='4095'>
    enddo<a name='4096'>
    enddo<a name='4097'>
<a name='4098'>
<font color=#447700>!  compute z at p points (average of z at w points)<a name='4099'></font>
<a name='4100'>
    do j = j_start,j_end<a name='4101'>
    do k = k_start, k_end<a name='4102'>
    do i = i_start, i_end<a name='4103'>
      z(i,k,j) = 0.5*(z_at_w(i,k,j) +z_at_w(i,k+1,j) )<a name='4104'>
    enddo<a name='4105'>
    enddo<a name='4106'>
    enddo<a name='4107'>
<a name='4108'>
<font color=#447700>!  interp t and p at w points<a name='4109'></font>
<a name='4110'>
    do j = j_start,j_end<a name='4111'>
    do k = 2, k_end<a name='4112'>
    do i = i_start, i_end<a name='4113'>
      p8w(i,k,j) = fzm(k)*p_phy(i,k,j)+fzp(k)*p_phy(i,k-1,j)<a name='4114'>
      t8w(i,k,j) = fzm(k)*t_phy(i,k,j)+fzp(k)*t_phy(i,k-1,j)<a name='4115'>
    enddo<a name='4116'>
    enddo<a name='4117'>
    enddo<a name='4118'>
<a name='4119'>
<font color=#447700>!  extrapolate p and t to surface and top.<a name='4120'></font>
<font color=#447700>!  we'll use an extrapolation in z for now<a name='4121'></font>
<a name='4122'>
    do j = j_start,j_end<a name='4123'>
    do i = i_start, i_end<a name='4124'>
<a name='4125'>
<font color=#447700>! bottom<a name='4126'></font>
<a name='4127'>
      z0 = z_at_w(i,1,j)<a name='4128'>
      z1 = z(i,1,j)<a name='4129'>
      z2 = z(i,2,j)<a name='4130'>
      w1 = (z0 - z2)/(z1 - z2)<a name='4131'>
      w2 = 1. - w1<a name='4132'>
      p8w(i,1,j) = w1*p_phy(i,1,j)+w2*p_phy(i,2,j)<a name='4133'>
      t8w(i,1,j) = w1*t_phy(i,1,j)+w2*t_phy(i,2,j)<a name='4134'>
<a name='4135'>
<font color=#447700>! top<a name='4136'></font>
<a name='4137'>
      z0 = z_at_w(i,kte,j)<a name='4138'>
      z1 = z(i,k_end,j)<a name='4139'>
      z2 = z(i,k_end-1,j)<a name='4140'>
      w1 = (z0 - z2)/(z1 - z2)<a name='4141'>
      w2 = 1. - w1<a name='4142'>
<a name='4143'>
<font color=#447700>!      p8w(i,kde,j) = w1*p_phy(i,kde-1,j)+w2*p_phy(i,kde-2,j)<a name='4144'></font>
<font color=#447700>!!!  bug fix      extrapolate ln(p) so p is positive definite<a name='4145'></font>
      p8w(i,kde,j) = exp(w1*log(p_phy(i,kde-1,j))+w2*log(p_phy(i,kde-2,j)))<a name='4146'>
      t8w(i,kde,j) = w1*t_phy(i,kde-1,j)+w2*t_phy(i,kde-2,j)<a name='4147'>
<a name='4148'>
    enddo<a name='4149'>
    enddo<a name='4150'>
<a name='4151'>
<font color=#447700>! decouple all physics tendencies<a name='4152'></font>
<a name='4153'>
   IF (config_flags%ra_lw_physics .gt. 0 .or. config_flags%ra_sw_physics .gt. 0) THEN<a name='4154'>
<a name='4155'>
      DO J=j_start,j_end<a name='4156'>
      DO K=k_start,k_end<a name='4157'>
      DO I=i_start,i_end<a name='4158'>
         RTHRATEN(I,K,J)=RTHRATEN(I,K,J)/mu(I,J)<a name='4159'>
      ENDDO<a name='4160'>
      ENDDO<a name='4161'>
      ENDDO<a name='4162'>
<a name='4163'>
   ENDIF<a name='4164'>
<a name='4165'>
   IF (config_flags%cu_physics .gt. 0) THEN<a name='4166'>
<a name='4167'>
      DO J=j_start,j_end<a name='4168'>
      DO I=i_start,i_end<a name='4169'>
      DO K=k_start,k_end<a name='4170'>
         RTHCUTEN(I,K,J)=RTHCUTEN(I,K,J)/mu(I,J)<a name='4171'>
      ENDDO<a name='4172'>
      ENDDO<a name='4173'>
      ENDDO<a name='4174'>
<a name='4175'>
      IF (P_QV .ge. PARAM_FIRST_SCALAR)THEN<a name='4176'>
         DO J=j_start,j_end<a name='4177'>
         DO I=i_start,i_end<a name='4178'>
         DO K=k_start,k_end<a name='4179'>
            RQVCUTEN(I,K,J)=RQVCUTEN(I,K,J)/mu(I,J)<a name='4180'>
         ENDDO<a name='4181'>
         ENDDO<a name='4182'>
         ENDDO<a name='4183'>
      ENDIF<a name='4184'>
<a name='4185'>
      IF (P_QC .ge. PARAM_FIRST_SCALAR)THEN<a name='4186'>
         DO J=j_start,j_end<a name='4187'>
         DO I=i_start,i_end<a name='4188'>
         DO K=k_start,k_end<a name='4189'>
            RQCCUTEN(I,K,J)=RQCCUTEN(I,K,J)/mu(I,J)<a name='4190'>
         ENDDO<a name='4191'>
         ENDDO<a name='4192'>
         ENDDO<a name='4193'>
      ENDIF<a name='4194'>
<a name='4195'>
      IF (P_QR .ge. PARAM_FIRST_SCALAR)THEN<a name='4196'>
         DO J=j_start,j_end<a name='4197'>
         DO I=i_start,i_end<a name='4198'>
         DO K=k_start,k_end<a name='4199'>
            RQRCUTEN(I,K,J)=RQRCUTEN(I,K,J)/mu(I,J)<a name='4200'>
         ENDDO<a name='4201'>
         ENDDO<a name='4202'>
         ENDDO<a name='4203'>
      ENDIF<a name='4204'>
<a name='4205'>
      IF (P_QI .ge. PARAM_FIRST_SCALAR)THEN<a name='4206'>
         DO J=j_start,j_end<a name='4207'>
         DO I=i_start,i_end<a name='4208'>
         DO K=k_start,k_end<a name='4209'>
            RQICUTEN(I,K,J)=RQICUTEN(I,K,J)/mu(I,J)<a name='4210'>
         ENDDO<a name='4211'>
         ENDDO<a name='4212'>
         ENDDO<a name='4213'>
      ENDIF<a name='4214'>
<a name='4215'>
      IF(P_QS .ge. PARAM_FIRST_SCALAR)THEN<a name='4216'>
         DO J=j_start,j_end<a name='4217'>
         DO I=i_start,i_end<a name='4218'>
         DO K=k_start,k_end<a name='4219'>
            RQSCUTEN(I,K,J)=RQSCUTEN(I,K,J)/mu(I,J)<a name='4220'>
         ENDDO<a name='4221'>
         ENDDO<a name='4222'>
         ENDDO<a name='4223'>
      ENDIF<a name='4224'>
<a name='4225'>
   ENDIF<a name='4226'>
<a name='4227'>
   IF (config_flags%bl_pbl_physics .gt. 0) THEN<a name='4228'>
<a name='4229'>
      DO J=j_start,j_end<a name='4230'>
      DO K=k_start,k_end<a name='4231'>
      DO I=i_start,i_end<a name='4232'>
         RUBLTEN(I,K,J) =RUBLTEN(I,K,J)/mu(I,J)<a name='4233'>
         RVBLTEN(I,K,J) =RVBLTEN(I,K,J)/mu(I,J)<a name='4234'>
         RTHBLTEN(I,K,J)=RTHBLTEN(I,K,J)/mu(I,J)<a name='4235'>
      ENDDO<a name='4236'>
      ENDDO<a name='4237'>
      ENDDO<a name='4238'>
<a name='4239'>
      IF (P_QV .ge. PARAM_FIRST_SCALAR) THEN<a name='4240'>
         DO J=j_start,j_end<a name='4241'>
         DO K=k_start,k_end<a name='4242'>
         DO I=i_start,i_end<a name='4243'>
            RQVBLTEN(I,K,J)=RQVBLTEN(I,K,J)/mu(I,J)<a name='4244'>
         ENDDO<a name='4245'>
         ENDDO<a name='4246'>
         ENDDO<a name='4247'>
      ENDIF<a name='4248'>
<a name='4249'>
      IF (P_QC .ge. PARAM_FIRST_SCALAR) THEN<a name='4250'>
         DO J=j_start,j_end<a name='4251'>
         DO K=k_start,k_end<a name='4252'>
         DO I=i_start,i_end<a name='4253'>
           RQCBLTEN(I,K,J)=RQCBLTEN(I,K,J)/mu(I,J)<a name='4254'>
         ENDDO<a name='4255'>
         ENDDO<a name='4256'>
         ENDDO<a name='4257'>
      ENDIF<a name='4258'>
<a name='4259'>
      IF (P_QI .ge. PARAM_FIRST_SCALAR) THEN<a name='4260'>
         DO J=j_start,j_end<a name='4261'>
         DO K=k_start,k_end<a name='4262'>
         DO I=i_start,i_end<a name='4263'>
            RQIBLTEN(I,K,J)=RQIBLTEN(I,K,J)/mu(I,J)<a name='4264'>
         ENDDO<a name='4265'>
         ENDDO<a name='4266'>
         ENDDO<a name='4267'>
      ENDIF<a name='4268'>
<a name='4269'>
    ENDIF<a name='4270'>
<a name='4271'>
<font color=#447700>!  decouple advective forcing required by Grell-Devenyi scheme<a name='4272'></font>
<a name='4273'>
   if ( config_flags%cu_physics == GDSCHEME ) then<a name='4274'>
<a name='4275'>
      DO J=j_start,j_end<a name='4276'>
      DO I=i_start,i_end<a name='4277'>
         DO K=k_start,k_end<a name='4278'>
            RTHFTEN(I,K,J)=RTHFTEN(I,K,J)/mu(I,J)<a name='4279'>
         ENDDO<a name='4280'>
      ENDDO<a name='4281'>
      ENDDO<a name='4282'>
<a name='4283'>
      IF (P_QV .ge. PARAM_FIRST_SCALAR)THEN<a name='4284'>
         DO J=j_start,j_end<a name='4285'>
         DO I=i_start,i_end<a name='4286'>
            DO K=k_start,k_end<a name='4287'>
               RQVFTEN(I,K,J)=RQVFTEN(I,K,J)/mu(I,J)<a name='4288'>
            ENDDO<a name='4289'>
         ENDDO<a name='4290'>
         ENDDO<a name='4291'>
      ENDIF<a name='4292'>
<a name='4293'>
   END IF<a name='4294'>
<a name='4295'>
END SUBROUTINE phy_prep<a name='4296'>
<a name='4297'>
<font color=#447700>!------------------------------------------------------------<a name='4298'></font>
<a name='4299'>
<A NAME='MOIST_PHYSICS_PREP_EM'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_PREP_EM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4300'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>moist_physics_prep_em</font>( t_new, t_old, t0, rho, al, alb, &amp; <A href='../../call_to/MOIST_PHYSICS_PREP_EM.html' TARGET='index'>5</A><a name='4301'>
                                     p, p8w, p0, pb, ph, phb, pii, pf,    &amp;<a name='4302'>
                                     z, z_at_w, dz8w,                &amp;<a name='4303'>
                                     dt,h_diabatic,                  &amp;<a name='4304'>
                                     config_flags,fzm, fzp,          &amp;<a name='4305'>
                                     ids,ide, jds,jde, kds,kde,      &amp;<a name='4306'>
                                     ims,ime, jms,jme, kms,kme,      &amp;<a name='4307'>
                                     its,ite, jts,jte, kts,kte      )<a name='4308'>
<a name='4309'>
   IMPLICIT NONE<a name='4310'>
<a name='4311'>
<font color=#447700>! Here we construct full fields<a name='4312'></font>
<font color=#447700>! needed by the microphysics<a name='4313'></font>
<a name='4314'>
   TYPE(grid_config_rec_type),    INTENT(IN   )    :: config_flags<a name='4315'>
<a name='4316'>
   INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='4317'>
   INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='4318'>
   INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='4319'>
<a name='4320'>
   REAL, INTENT(IN   )  ::  dt<a name='4321'>
<a name='4322'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),        &amp;<a name='4323'>
         INTENT(IN   ) ::                           al,  &amp;<a name='4324'>
                                                    alb, &amp;<a name='4325'>
                                                    p,   &amp;<a name='4326'>
                                                    pb,  &amp;<a name='4327'>
                                                    ph,  &amp;<a name='4328'>
                                                    phb<a name='4329'>
<a name='4330'>
<a name='4331'>
   REAL , DIMENSION( kms:kme ) ,           INTENT(IN   ) ::   fzm, &amp;<a name='4332'>
                                                              fzp<a name='4333'>
<a name='4334'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),       &amp;<a name='4335'>
         INTENT(  OUT) ::                         rho,  &amp;<a name='4336'>
                                                  pii,  &amp;<a name='4337'>
                                                  pf,   &amp;<a name='4338'>
                                                    z,  &amp;<a name='4339'>
                                               z_at_w,  &amp;<a name='4340'>
                                                 dz8w,  &amp;<a name='4341'>
                                                  p8w<a name='4342'>
<font color=#447700>! pjj/cray<a name='4343'></font>
<font color=#447700>!                                                 p8w,  &amp;<a name='4344'></font>
<font color=#447700>!                                          h_diabatic<a name='4345'></font>
<a name='4346'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),       &amp;<a name='4347'>
         INTENT(INOUT) ::                         h_diabatic<a name='4348'>
<a name='4349'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),        &amp;<a name='4350'>
         INTENT(INOUT) ::                         t_new, &amp;<a name='4351'>
                                                  t_old<a name='4352'>
<a name='4353'>
   REAL, INTENT(IN   ) :: t0, p0<a name='4354'>
   REAL                :: z0,z1,z2,w1,w2<a name='4355'>
<a name='4356'>
   INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='4357'>
   INTEGER :: i, j, k<a name='4358'>
<a name='4359'>
<font color=#447700>!--------------------------------------------------------------------<a name='4360'></font>
<a name='4361'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4362'></font>
<font color=#447700>!<a name='4363'></font>
<font color=#447700>!  moist_phys_prep_em calculates a number of diagnostic quantities needed by<a name='4364'></font>
<font color=#447700>!  the microphysics routines.<a name='4365'></font>
<font color=#447700>!<a name='4366'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4367'></font>
<a name='4368'>
<font color=#447700>!  set up loop bounds for this grid's boundary conditions<a name='4369'></font>
<a name='4370'>
    i_start = its    <a name='4371'>
    i_end   = min( ite,ide-1 )<a name='4372'>
    j_start = jts    <a name='4373'>
    j_end   = min( jte,jde-1 )<a name='4374'>
<a name='4375'>
    k_start = kts<a name='4376'>
    k_end = min( kte, kde-1 )<a name='4377'>
<a name='4378'>
     DO j = j_start, j_end<a name='4379'>
     DO k = k_start, kte<a name='4380'>
     DO i = i_start, i_end<a name='4381'>
       z_at_w(i,k,j) = (ph(i,k,j)+phb(i,k,j))/g<a name='4382'>
     ENDDO<a name='4383'>
     ENDDO<a name='4384'>
     ENDDO<a name='4385'>
<a name='4386'>
    do j = j_start,j_end<a name='4387'>
    do k = k_start, kte-1<a name='4388'>
    do i = i_start, i_end<a name='4389'>
      dz8w(i,k,j) = z_at_w(i,k+1,j)-z_at_w(i,k,j)<a name='4390'>
    enddo<a name='4391'>
    enddo<a name='4392'>
    enddo<a name='4393'>
<a name='4394'>
    do j = j_start,j_end<a name='4395'>
    do i = i_start, i_end<a name='4396'>
      dz8w(i,kte,j) = 0.<a name='4397'>
    enddo<a name='4398'>
    enddo<a name='4399'>
<a name='4400'>
<a name='4401'>
           <font color=#447700>!  compute full pii, rho, and z at the new time-level<a name='4402'></font>
           <font color=#447700>!  (needed for physics).<a name='4403'></font>
           <font color=#447700>!  convert perturbation theta to full theta<a name='4404'></font>
<a name='4405'>
     DO j = j_start, j_end<a name='4406'>
     DO k = k_start, k_end<a name='4407'>
     DO i = i_start, i_end<a name='4408'>
<a name='4409'>
       t_new(i,k,j) = t_new(i,k,j) + t0<a name='4410'>
       t_old(i,k,j) = t_old(i,k,j) + t0<a name='4411'>
       rho(i,k,j)  = 1./(al(i,k,j)+alb(i,k,j))<a name='4412'>
       pii(i,k,j) = ((p(i,k,j)+pb(i,k,j))/p0)**rcp<a name='4413'>
       z(i,k,j) = 0.5*(z_at_w(i,k,j) +z_at_w(i,k+1,j) )<a name='4414'>
       pf(i,k,j) = p(i,k,j)+pb(i,k,j)<a name='4415'>
<a name='4416'>
     ENDDO<a name='4417'>
     ENDDO<a name='4418'>
     ENDDO<a name='4419'>
<a name='4420'>
   END SUBROUTINE moist_physics_prep_em<a name='4421'>
<a name='4422'>
<font color=#447700>!------------------------------------------------------------------------------<a name='4423'></font>
<a name='4424'>
<A NAME='MOIST_PHYSICS_FINISH_EM'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_FINISH_EM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4425'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>moist_physics_finish_em</font>( t_new, t_old, t0, mut,     &amp; <A href='../../call_to/MOIST_PHYSICS_FINISH_EM.html' TARGET='index'>2</A><a name='4426'>
                                       h_diabatic, dt,            &amp;<a name='4427'>
                                       config_flags,              &amp;<a name='4428'>
                                       ids,ide, jds,jde, kds,kde, &amp;<a name='4429'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='4430'>
                                       its,ite, jts,jte, kts,kte )<a name='4431'>
<a name='4432'>
   IMPLICIT NONE<a name='4433'>
<a name='4434'>
<font color=#447700>! Here we construct full fields<a name='4435'></font>
<font color=#447700>! needed by the microphysics<a name='4436'></font>
<a name='4437'>
   TYPE(grid_config_rec_type),    INTENT(IN   )    :: config_flags<a name='4438'>
<a name='4439'>
   INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='4440'>
   INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='4441'>
   INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='4442'>
<a name='4443'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),        &amp;<a name='4444'>
         INTENT(INOUT) ::                         t_new, &amp;<a name='4445'>
                                                  t_old, &amp;<a name='4446'>
                                                  h_diabatic<a name='4447'>
<a name='4448'>
   REAL, DIMENSION( ims:ime , jms:jme ),  INTENT(INOUT) ::  mut<a name='4449'>
<a name='4450'>
<a name='4451'>
   REAL, INTENT(IN   ) :: t0, dt<a name='4452'>
<a name='4453'>
   INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='4454'>
   INTEGER :: i, j, k<a name='4455'>
<a name='4456'>
<font color=#447700>!--------------------------------------------------------------------<a name='4457'></font>
<a name='4458'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4459'></font>
<font color=#447700>!<a name='4460'></font>
<font color=#447700>!  moist_phys_finish_em resets theta to its perturbation value and<a name='4461'></font>
<font color=#447700>!  computes and stores the microphysics diabatic heating term.<a name='4462'></font>
<font color=#447700>!<a name='4463'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4464'></font>
<a name='4465'>
<font color=#447700>!  set up loop bounds for this grid's boundary conditions<a name='4466'></font>
<a name='4467'>
<a name='4468'>
    i_start = its    <a name='4469'>
    i_end   = min( ite,ide-1 )<a name='4470'>
    j_start = jts    <a name='4471'>
    j_end   = min( jte,jde-1 )<a name='4472'>
<a name='4473'>
    k_start = kts<a name='4474'>
    k_end = min( kte, kde-1 )<a name='4475'>
<a name='4476'>
<font color=#447700>!  return theta to perturbation theta, calc new p, rho<a name='4477'></font>
<a name='4478'>
     DO j = j_start, j_end<a name='4479'>
     DO k = k_start, k_end<a name='4480'>
     DO i = i_start, i_end<a name='4481'>
<a name='4482'>
       t_new(i,k,j) = t_new(i,k,j) - t0<a name='4483'>
       t_old(i,k,j) = t_old(i,k,j) - t0<a name='4484'>
<a name='4485'>
     ENDDO<a name='4486'>
     ENDDO<a name='4487'>
     ENDDO<a name='4488'>
<a name='4489'>
   END SUBROUTINE moist_physics_finish_em<a name='4490'>
<a name='4491'>
<font color=#447700>!----------------------------------------------------------------<a name='4492'></font>
<a name='4493'>
<a name='4494'>
<A NAME='INIT_MODULE_BIG_STEP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#INIT_MODULE_BIG_STEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4495'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_module_big_step</font> <A href='../../call_to/INIT_MODULE_BIG_STEP.html' TARGET='index'>1</A><a name='4496'>
   END SUBROUTINE init_module_big_step<a name='4497'>
<a name='4498'>
<A NAME='SET_TEND'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SET_TEND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4499'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>set_tend</font> ( field, field_adv_tend, msf,       &amp; <A href='../../call_to/SET_TEND.html' TARGET='index'>2</A><a name='4500'>
                      ids, ide, jds, jde, kds, kde,     &amp;<a name='4501'>
                      ims, ime, jms, jme, kms, kme,     &amp;<a name='4502'>
                      its, ite, jts, jte, kts, kte       )<a name='4503'>
<a name='4504'>
   IMPLICIT NONE<a name='4505'>
<a name='4506'>
   <font color=#447700>! Input data<a name='4507'></font>
<a name='4508'>
   INTEGER ,  INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='4509'>
                               ims, ime, jms, jme, kms, kme, &amp;<a name='4510'>
                               its, ite, jts, jte, kts, kte<a name='4511'>
<a name='4512'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) :: field<a name='4513'>
<a name='4514'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN)  :: field_adv_tend<a name='4515'>
<a name='4516'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN)  :: msf<a name='4517'>
<a name='4518'>
   <font color=#447700>! Local data<a name='4519'></font>
<a name='4520'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='4521'>
<a name='4522'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4523'></font>
<font color=#447700>!<a name='4524'></font>
<font color=#447700>!  set_tend copies the advective tendency array into the tendency array.<a name='4525'></font>
<font color=#447700>!<a name='4526'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4527'></font>
<a name='4528'>
      jtf = MIN(jte,jde-1)<a name='4529'>
      ktf = MIN(kte,kde-1)<a name='4530'>
      itf = MIN(ite,ide-1)<a name='4531'>
      DO j = jts, jtf<a name='4532'>
      DO k = kts, ktf<a name='4533'>
      DO i = its, itf<a name='4534'>
         field(i,k,j) = field_adv_tend(i,k,j)*msf(i,j)<a name='4535'>
      ENDDO<a name='4536'>
      ENDDO<a name='4537'>
      ENDDO<a name='4538'>
<a name='4539'>
END SUBROUTINE set_tend<a name='4540'>
<font color=#447700>!------------------------------------------------------------------------------------<a name='4541'></font>
<font color=#447700>!Xiaoyan Zhang ------ add vertical diffusion here 10/11/2006    --------------------<a name='4542'></font>
<font color=#447700>!==============================================================================<a name='4543'></font>
<font color=#447700>!x   SUBROUTINE surface_drag (config_flags, rk_step,                   &amp;<a name='4544'></font>
<A NAME='SURFACE_DRAG'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SURFACE_DRAG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4545'>
     <font color=#993300>SUBROUTINE </font><font color=#cc0000>surface_drag</font> (ru_tendf, rv_tendf, u, v, xland,             &amp; <A href='../../call_to/SURFACE_DRAG.html' TARGET='index'>4</A><a name='4546'>
                         muu, muv, z, z_at_w,                   &amp;<a name='4547'>
                         ids, ide, jds, jde, kds, kde,                &amp;<a name='4548'>
                         ims, ime, jms, jme, kms, kme,                &amp;<a name='4549'>
                         its, ite, jts, jte, kts, kte   )<a name='4550'>
<a name='4551'>
    IMPLICIT NONE<a name='4552'>
<a name='4553'>
<font color=#447700>!   TYPE(grid_config_rec_type),    INTENT(IN   )    :: config_flags<a name='4554'></font>
   INTEGER ,               INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='4555'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='4556'>
                                            its, ite, jts, jte, kts, kte<a name='4557'>
<a name='4558'>
<font color=#447700>!   INTEGER ,       INTENT(IN   ) :: rk_step<a name='4559'></font>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) ,               &amp;<a name='4560'>
                                        INTENT(INOUT) :: ru_tendf, &amp;<a name='4561'>
                                                         rv_tendf<a name='4562'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) ,               &amp;<a name='4563'>
                                        INTENT(IN   ) :: u, &amp;<a name='4564'>
                                                         v, &amp;<a name='4565'>
                                                         z, z_at_w<a name='4566'>
   REAL , DIMENSION( ims:ime , jms:jme  ), INTENT(IN) :: muu,muv,xland<a name='4567'>
<a name='4568'>
<font color=#447700>! Local<a name='4569'></font>
   REAL :: V0_u, V0_v, tao_xz, tao_yz, cd, zu, zv, zwt<a name='4570'>
   INTEGER :: i, j, i_start, i_end, i_endu, j_start, j_end, j_endv, k<a name='4571'>
<a name='4572'>
<font color=#447700>! End declarations.<a name='4573'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4574'></font>
<a name='4575'>
   i_start = its<a name='4576'>
   i_end   = MIN(ite,ide-1)<a name='4577'>
   i_endu  = ite<a name='4578'>
   j_start = jts<a name='4579'>
   j_end   = MIN(jte,jde-1)<a name='4580'>
   j_endv  = jte<a name='4581'>
<a name='4582'>
    DO j = j_start, j_end<a name='4583'>
    DO i = i_start, i_endu<a name='4584'>
       V0_u=    sqrt((u(i,kts,j)**2) +         &amp;<a name='4585'>
                        (((v(i  ,kts,j  )+          &amp;<a name='4586'>
                           v(i  ,kts,j+1)+          &amp;<a name='4587'>
                           v(i-1,kts,j  )+          &amp;<a name='4588'>
                           v(i-1,kts,j+1))/4)**2))+epsilon<a name='4589'>
       if(xland(i,j) .eq. xland(i-1,j))then<a name='4590'>
         if(xland(i,j) .lt. 1.5)then<a name='4591'>
<font color=#447700>! land<a name='4592'></font>
           Cd=0.01<a name='4593'>
         else<a name='4594'>
<font color=#447700>! water<a name='4595'></font>
           Cd=0.001<a name='4596'>
           Cd=max(Cd, 1.e-4 * V0_u)<a name='4597'>
           Cd=min(Cd, 0.003)<a name='4598'>
<a name='4599'>
         endif<a name='4600'>
       else<a name='4601'>
<font color=#447700>! coast<a name='4602'></font>
         Cd=0.003<a name='4603'>
       endif<a name='4604'>
       tao_xz=Cd*V0_u*u(i,kts,j)<a name='4605'>
      DO k = kts, kte<a name='4606'>
        zu = 0.5*(z(i,k,j)+z(i-1,k,j)-z_at_w(i,kts,j)-z_at_w(i-1,kts,j))<a name='4607'>
        IF(zu .LT. 1000.)THEN<a name='4608'>
          zwt = 2. * (1000.-zu) / 1000.<a name='4609'>
          ru_tendf(i,k,j)=ru_tendf(i,k,j)            &amp;<a name='4610'>
                          -zwt*0.5*muu(i,j)*tao_xz/1000.<a name='4611'>
        ENDIF<a name='4612'>
<a name='4613'>
      ENDDO<a name='4614'>
    ENDDO<a name='4615'>
    ENDDO<a name='4616'>
<a name='4617'>
<font color=#447700>!<a name='4618'></font>
    DO j = j_start, j_endv<a name='4619'>
    DO i = i_start, i_end<a name='4620'>
       V0_v=    sqrt((v(i,kts,j)**2) +         &amp;<a name='4621'>
                        (((u(i  ,kts,j  )+          &amp;<a name='4622'>
                           u(i  ,kts,j-1)+          &amp;<a name='4623'>
                           u(i+1,kts,j  )+          &amp;<a name='4624'>
                           u(i+1,kts,j-1))/4)**2))+epsilon<a name='4625'>
       if(xland(i,j) .eq. xland(i,j-1))then<a name='4626'>
         if(xland(i,j) .lt. 1.5)then<a name='4627'>
<font color=#447700>! land<a name='4628'></font>
           Cd=0.01<a name='4629'>
         else<a name='4630'>
<font color=#447700>! water<a name='4631'></font>
           Cd=0.001<a name='4632'>
           Cd=max(Cd, 1.e-4 * V0_v)<a name='4633'>
           Cd=min(Cd, 0.003)<a name='4634'>
<a name='4635'>
         endif<a name='4636'>
       else<a name='4637'>
<font color=#447700>! coast<a name='4638'></font>
         Cd=0.003<a name='4639'>
       endif<a name='4640'>
      tao_yz=Cd*V0_v*v(i,kts,j)<a name='4641'>
      DO k = kts, kte<a name='4642'>
        zv = 0.5*(z(i,k,j)+z(i,k,j-1)-z_at_w(i,kts,j)-z_at_w(i,kts,j-1))<a name='4643'>
        IF(zv .LT. 1000.)THEN<a name='4644'>
          zwt = 2. * (1000.-zv) / 1000.<a name='4645'>
          rv_tendf(i,k,j)=rv_tendf(i,k,j)            &amp;<a name='4646'>
                          -zwt*0.5*muv(i,j)*tao_yz/1000.<a name='4647'>
<a name='4648'>
        ENDIF<a name='4649'>
<a name='4650'>
      ENDDO<a name='4651'>
    ENDDO<a name='4652'>
    ENDDO<a name='4653'>
<a name='4654'>
<a name='4655'>
   END SUBROUTINE surface_drag<a name='4656'>
<a name='4657'>
<a name='4658'>
<font color=#447700>!==============================================================================<a name='4659'></font>
<a name='4660'>
<a name='4661'>
END MODULE module_big_step_utilities_em<a name='4662'>
</pre></body></html>