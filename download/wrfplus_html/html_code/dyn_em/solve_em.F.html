<HTML> <BODY BGCOLOR=#cceeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MEDIATION_LAYER:SOLVER<a name='2'></font>
<a name='3'>
<A NAME='SOLVE_EM'><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>solve_em</font> ( grid , config_flags , &amp; <A href='../../call_to/SOLVE_EM.html' TARGET='index'>3</A>,<A href='../../call_from/SOLVE_EM.html' TARGET='index'>150</A><a name='5'>
<font color=#447700>! Actual arguments generated from Registry<a name='6'></font>
#include "<A href='../../html_code/include/em_dummy_args.inc.html'>em_dummy_args.inc</A>"<A NAME="em_dummy_args.inc_1"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='7'>
<font color=#447700>!<a name='8'></font>
                    )<a name='9'>
<a name='10'>
<font color=#447700>! Driver layer modules<a name='11'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_14"><a name='12'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_27"><a name='13'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_2"><a name='14'>
   USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_2"><a name='15'>
   USE <A href='../../html_code/frame/module_tiles.F.html#MODULE_TILES'>module_tiles</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TILES_2"><a name='16'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_11"><a name='17'>
<font color=#447700>! Mediation layer modules<a name='18'></font>
<font color=#447700>! Model layer modules<a name='19'></font>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_23"><a name='20'>
   USE <A href='../../html_code/dyn_em/module_small_step_em.F.html#MODULE_SMALL_STEP_EM'>module_small_step_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SMALL_STEP_EM_3"><a name='21'>
   USE <A href='../../html_code/dyn_em/module_em.F.html#MODULE_EM'>module_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_EM_3"><a name='22'>
   USE <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_11"><a name='23'>
   USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_20"><a name='24'>
   USE <A href='../../html_code/dyn_em/module_bc_em.F.html#MODULE_BC_EM'>module_bc_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_EM_3"><a name='25'>
   USE <A href='../../html_code/dyn_em/module_solvedebug_em.F.html#MODULE_SOLVEDEBUG_EM'>module_solvedebug_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SOLVEDEBUG_EM_1"><a name='26'>
   USE <A href='../../html_code/phys/module_physics_addtendc.F.html#MODULE_PHYSICS_ADDTENDC'>module_physics_addtendc</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PHYSICS_ADDTENDC_1"><a name='27'>
   USE <A href='../../html_code/dyn_em/module_diffusion_em.F.html#MODULE_DIFFUSION_EM'>module_diffusion_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DIFFUSION_EM_3"><a name='28'>
<font color=#447700>! Registry generated module<a name='29'></font>
   USE module_state_description<a name='30'>
   USE <A href='../../html_code/phys/module_radiation_driver.F.html#MODULE_RADIATION_DRIVER'>module_radiation_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RADIATION_DRIVER_1"><a name='31'>
   USE <A href='../../html_code/phys/module_surface_driver.F.html#MODULE_SURFACE_DRIVER'>module_surface_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SURFACE_DRIVER_1"><a name='32'>
   USE <A href='../../html_code/phys/module_cumulus_driver.F.html#MODULE_CUMULUS_DRIVER'>module_cumulus_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CUMULUS_DRIVER_1"><a name='33'>
   USE <A href='../../html_code/phys/module_cu_du.F.html#MODULE_CU_DU'>module_cu_du</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CU_DU_2"> , only : DUCU<a name='34'>
   USE <A href='../../html_code/phys/module_microphysics_driver.F.html#MODULE_MICROPHYSICS_DRIVER'>module_microphysics_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MICROPHYSICS_DRIVER_1"><a name='35'>
   USE <A href='../../html_code/phys/module_pbl_driver.F.html#MODULE_PBL_DRIVER'>module_pbl_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PBL_DRIVER_1"><a name='36'>
   USE <A href='../../html_code/phys/module_mp_nconvp.F.html#MODULE_MP_NCONVP'>module_mp_nconvp</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_NCONVP_2">    <font color=#447700>!Xiaoyan Zhang 11/20/2006 for Large Scale Condensation<a name='37'></font>
#ifdef WRF_CHEM<a name='38'>
   USE module_input_chem_data<a name='39'>
   USE module_chem_utilities<a name='40'>
#endif<a name='41'>
<a name='42'>
   USE <A href='../../html_code/frame/module_trace.F.html#MODULE_TRACE'>module_trace</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TRACE_12">, only : trace_entry, trace_exit<a name='43'>
<a name='44'>
   IMPLICIT NONE<a name='45'>
<a name='46'>
   <font color=#447700>!  Input data.<a name='47'></font>
<a name='48'>
   TYPE(domain) , TARGET          :: grid<a name='49'>
<a name='50'>
   <font color=#447700>!  Definitions of dummy arguments to this routine (generated from Registry).<a name='51'></font>
#include &lt;<A href='../../html_code/include/em_dummy_decl.inc.html'>em_dummy_decl.inc</A>&gt;<A NAME="em_dummy_decl.inc_2"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='52'>
<a name='53'>
   <font color=#447700>!  Structure that contains run-time configuration (namelist) data for domain<a name='54'></font>
   TYPE (grid_config_rec_type) , INTENT(IN)          :: config_flags<a name='55'>
<a name='56'>
   <font color=#447700>! Local data<a name='57'></font>
<a name='58'>
   INTEGER                         :: k_start , k_end, its, ite, jts, jte<a name='59'>
   INTEGER                         :: ids , ide , jds , jde , kds , kde , &amp;<a name='60'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='61'>
                                      ips , ipe , jps , jpe , kps , kpe<a name='62'>
   INTEGER                         :: ij , iteration<a name='63'>
   INTEGER                         :: im , num_3d_m , ic , num_3d_c<a name='64'>
   INTEGER                         :: loop<a name='65'>
   INTEGER                         :: ijds, ijde<a name='66'>
   INTEGER                         :: itmpstep<a name='67'>
   INTEGER                         :: sz<a name='68'>
<a name='69'>
<font color=#447700>! storage for tendencies and decoupled state (generated from Registry)<a name='70'></font>
#include &lt;<A href='../../html_code/include/em_i1_decl.inc.html'>em_i1_decl.inc</A>&gt;<A NAME="em_i1_decl.inc_3"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='71'>
<a name='72'>
   INTEGER :: rc <a name='73'>
   INTEGER :: number_of_small_timesteps, rk_step<a name='74'>
   INTEGER :: klevel,ijm,ijp,i,j,k,size1,size2    <font color=#447700>! for prints/plots only<a name='75'></font>
   INTEGER :: idum1, idum2, dynamics_option<a name='76'>
<a name='77'>
   INTEGER :: rk_order, iwmax, jwmax, kwmax<a name='78'>
   REAL :: dt_rk, dts_rk, dtm, wmax<a name='79'>
   LOGICAL :: leapfrog<a name='80'>
   INTEGER :: l,kte,kk<a name='81'>
   INTEGER :: kts   <font color=#447700>!xzhang 6/25/2007<a name='82'></font>
<a name='83'>
<font color=#447700>! These are used if -DDEREF_KLUDGE is compiled<a name='84'></font>
<font color=#447700>!  see http://www2.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='85'></font>
   INTEGER     :: sm31  , em31  , sm32  , em32  , sm33  , em33<a name='86'>
   INTEGER     :: sm31x , em31x , sm32x , em32x , sm33x , em33x<a name='87'>
   INTEGER     :: sm31y , em31y , sm32y , em32y , sm33y , em33y<a name='88'>
<a name='89'>
<font color=#447700>! Define benchmarking timers if -DBENCH is compiled<a name='90'></font>
#include &lt;<A href='../../html_code/include/bench_solve_em_def.h.html'>bench_solve_em_def.h</A>&gt;<A NAME="bench_solve_em_def.h_4"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='91'>
<a name='92'>
<font color=#447700>!----------------------<a name='93'></font>
<font color=#447700>! Executable statements<a name='94'></font>
<font color=#447700>!----------------------<a name='95'></font>
<a name='96'>
<font color=#447700>! Trick problematic compilers into not performing copy-in/copy-out by adding<a name='97'></font>
<font color=#447700>! indices to array arguments in the CALL statements in this routine.<a name='98'></font>
<font color=#447700>! It has the effect of passing only the first element of the array, rather <a name='99'></font>
<font color=#447700>! than the entire array.  See:  <a name='100'></font>
<font color=#447700>! http://www2.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='101'></font>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_5"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='102'>
<a name='103'>
<font color=#447700>! Limit the number of arguments if compiled with -DLIMIT_ARGS by copying <a name='104'></font>
<font color=#447700>! scalar (non-array) arguments out of the grid data structure into locally<a name='105'></font>
<font color=#447700>! defined copies (defined in em_dummy_decl.inc, above, as they are if they<a name='106'></font>
<font color=#447700>! are arguments). An equivalent include of em_scalar_derefs.inc appears<a name='107'></font>
<font color=#447700>! at the end of the routine to copy back any chnaged non-array values.<a name='108'></font>
<font color=#447700>! The definition of COPY_IN or COPY_OUT before the include defines the<a name='109'></font>
<font color=#447700>! direction of the copy.  Em_scalar_derefs.inc is generated from Registry<a name='110'></font>
#define COPY_IN<a name='111'>
#include &lt;<A href='../../html_code/include/em_scalar_derefs.inc.html'>em_scalar_derefs.inc</A>&gt;<A NAME="em_scalar_derefs.inc_6"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='112'>
<a name='113'>
<font color=#447700>! Needed by some comm layers, e.g. RSL. If needed, nmm_data_calls.inc is<a name='114'></font>
<font color=#447700>! generated from the registry.  The definition of REGISTER_I1 allows<a name='115'></font>
<font color=#447700>! I1 data to be communicated in this routine if necessary.<a name='116'></font>
#ifdef DM_PARALLEL<a name='117'>
#    define REGISTER_I1<a name='118'>
#      include &lt;<A href='../../html_code/include/em_data_calls.inc.html'>em_data_calls.inc</A>&gt;<A NAME="em_data_calls.inc_7"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='119'>
#endif<a name='120'>
<a name='121'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='122'></font>
<font color=#447700>!&lt;pre&gt;<a name='123'></font>
<font color=#447700>! solve_em is the main driver for advancing a grid a single timestep.<a name='124'></font>
<font color=#447700>! It is a mediation-layer routine -&gt; DM and SM calls are made where <a name='125'></font>
<font color=#447700>! needed for parallel processing.  <a name='126'></font>
<font color=#447700>!<a name='127'></font>
<font color=#447700>! solve_em can integrate the equations using 3 time-integration methods<a name='128'></font>
<font color=#447700>!      <a name='129'></font>
<font color=#447700>!    - 3rd order Runge-Kutta time integration (recommended)<a name='130'></font>
<font color=#447700>!      <a name='131'></font>
<font color=#447700>!    - 2nd order Runge-Kutta time integration<a name='132'></font>
<font color=#447700>!      <a name='133'></font>
<font color=#447700>!    - Leapfrog time integration<a name='134'></font>
<font color=#447700>!      (note: the leapfrog scheme is not correctly implemented<a name='135'></font>
<font color=#447700>!      for most of the physics)<a name='136'></font>
<font color=#447700>!<a name='137'></font>
<font color=#447700>! The main sections of solve_em are<a name='138'></font>
<font color=#447700>!     <a name='139'></font>
<font color=#447700>! (1) Runge-Kutta (RK) loop<a name='140'></font>
<font color=#447700>!     <a name='141'></font>
<font color=#447700>! (2) Non-timesplit physics (i.e., tendencies computed for updating<a name='142'></font>
<font color=#447700>!     model state variables during the first RK sub-step (loop)<a name='143'></font>
<font color=#447700>!     <a name='144'></font>
<font color=#447700>! (3) Small (acoustic, sound) timestep loop - within the RK sub-steps<a name='145'></font>
<font color=#447700>!     <a name='146'></font>
<font color=#447700>! (4) Scalar advance for moist and chem scalar variables (and TKE)<a name='147'></font>
<font color=#447700>!     within the RK sub-steps.<a name='148'></font>
<font color=#447700>!     <a name='149'></font>
<font color=#447700>! (5) time-split physics (after the RK step), currently this includes<a name='150'></font>
<font color=#447700>!     only microphyics<a name='151'></font>
<font color=#447700>!<a name='152'></font>
<font color=#447700>! A more detailed description of these sections follows.<a name='153'></font>
<font color=#447700>!&lt;/pre&gt;<a name='154'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='155'></font>
<a name='156'>
<font color=#447700>! Initialize timers if compiled with -DBENCH<a name='157'></font>
#include &lt;<A href='../../html_code/include/bench_solve_em_init.h.html'>bench_solve_em_init.h</A>&gt;<A NAME="bench_solve_em_init.h_8"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='158'>
<a name='159'>
   if(grid%trace_use) call <A href='../../html_code/frame/module_trace.F.html#TRACE_ENTRY'>trace_entry</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRACE_ENTRY_103">("solve_em")<a name='160'>
<a name='161'>
<font color=#447700>!  set leapfrog or runge-kutta solver (2nd or 3rd order)<a name='162'></font>
<a name='163'>
   dynamics_option = config_flags%rk_ord<a name='164'>
<a name='165'>
<font color=#447700>!  Obtain dimension information stored in the grid data structure.<a name='166'></font>
  CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_4"> (  grid ,                   &amp;<a name='167'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='168'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='169'>
                            ips, ipe, jps, jpe, kps, kpe    )<a name='170'>
<a name='171'>
  k_start         = kps<a name='172'>
  k_end           = kpe<a name='173'>
<a name='174'>
  ijds = min(ids, jds)<a name='175'>
  ijde = max(ide, jde)<a name='176'>
<a name='177'>
  num_3d_m        = num_moist<a name='178'>
  num_3d_c        = num_chem<a name='179'>
<a name='180'>
<font color=#447700>!  Compute these starting and stopping locations for each tile and number of tiles.<a name='181'></font>
<font color=#447700>!  See: http://www2.mmm.ucar.edu/wrf/WG2/topics/settiles<a name='182'></font>
  CALL <A href='../../html_code/frame/module_tiles.F.html#SET_TILES'>set_tiles</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TILES_1"> ( grid , ids , ide , jds , jde , ips , ipe , jps , jpe )<a name='183'>
<a name='184'>
  itimestep = itimestep + 1<a name='185'>
<a name='186'>
<font color=#447700>!**********************************************************************<a name='187'></font>
<font color=#447700>!<a name='188'></font>
<font color=#447700>!  LET US BEGIN.......<a name='189'></font>
<font color=#447700>!<a name='190'></font>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='191'></font>
<font color=#447700>!&lt;pre&gt;<a name='192'></font>
<font color=#447700>! (1) RK integration loop is named the "Runge_Kutta_loop:"<a name='193'></font>
<font color=#447700>!<a name='194'></font>
<font color=#447700>!   Predictor-corrector type time integration.<a name='195'></font>
<font color=#447700>!   Advection terms are evaluated at time t for the predictor step,<a name='196'></font>
<font color=#447700>!   and advection is re-evaluated with the latest predicted value for<a name='197'></font>
<font color=#447700>!   each succeeding time corrector step<a name='198'></font>
<font color=#447700>!<a name='199'></font>
<font color=#447700>!   2nd order Runge Kutta (rk_order = 2):<a name='200'></font>
<font color=#447700>!   Step 1 is taken to the midpoint predictor, step 2 is the full step.<a name='201'></font>
<font color=#447700>!<a name='202'></font>
<font color=#447700>!   3rd order Runge Kutta (rk_order = 3):<a name='203'></font>
<font color=#447700>!   Step 1 is taken to from t to dt/3, step 2 is from t to dt/2,<a name='204'></font>
<font color=#447700>!   and step 3 is from t to dt.<a name='205'></font>
<font color=#447700>!<a name='206'></font>
<font color=#447700>!   non-timesplit physics are evaluated during first RK step and<a name='207'></font>
<font color=#447700>!   these physics tendencies are stored for use in each RK pass.<a name='208'></font>
<font color=#447700>!&lt;/pre&gt;<a name='209'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='210'></font>
<font color=#447700>!**********************************************************************<a name='211'></font>
<a name='212'>
#ifdef WRF_CHEM<a name='213'>
<font color=#447700>!<a name='214'></font>
<font color=#447700>!    prepare chem aerosols for advection before communication<a name='215'></font>
<font color=#447700>!    so far only for RADM2/SORGAM choice<a name='216'></font>
<font color=#447700>!<a name='217'></font>
<a name='218'>
   kte=min(k_end,kde-1)<a name='219'>
<font color=#447700>!<a name='220'></font>
<font color=#447700>! change units for advection to mixing ratio<a name='221'></font>
<font color=#447700>!<a name='222'></font>
      if(imicrogram == 1)then<a name='223'>
<a name='224'>
   if ( p_so4aj &gt;= PARAM_FIRST_SCALAR ) then<a name='225'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='226'></font>
   <font color=#447700>!$OMP PRIVATE ( ij ,its,ite,jts,jte,kte)<a name='227'></font>
   aerosol_decouple_loop : DO ij = 1 , grid%num_tiles<a name='228'>
       its = max(grid%i_start(ij),ids)<a name='229'>
       ite = min(grid%i_end(ij),ide-1)<a name='230'>
       jts = max(grid%j_start(ij),jds)<a name='231'>
       jte = min(grid%j_end(ij),jde-1)<a name='232'>
      do l=p_so4aj,num_chem<a name='233'>
      do j=jts,jte<a name='234'>
      do k=k_start,kte+1 <a name='235'>
      kk=min(k,kde-1)<a name='236'>
      do i=its,ite<a name='237'>
        chem_1(i,k,j,l)=chem_1(i,kk,j,l)*alt(i,kk,j)<a name='238'>
        chem_2(i,k,j,l)=chem_2(i,kk,j,l)*alt(i,kk,j)<a name='239'>
      enddo<a name='240'>
      enddo<a name='241'>
      enddo<a name='242'>
      enddo<a name='243'>
    enddo aerosol_decouple_loop<a name='244'>
    endif<a name='245'>
    imicrogram=0<a name='246'>
    endif<a name='247'>
# ifdef DM_PARALLEL<a name='248'>
   if ( num_chem &gt;= PARAM_FIRST_SCALAR ) then<a name='249'>
<font color=#447700>!-----------------------------------------------------------------------<a name='250'></font>
<font color=#447700>! see above<a name='251'></font>
<font color=#447700>!--------------------------------------------------------------<a name='252'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_CHEM' )<a name='253'>
     IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='254'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_9"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='255'>
     ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='256'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_5.inc.html'>HALO_EM_CHEM_E_5.inc</A>"<A NAME="HALO_EM_CHEM_E_5.inc_10"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='257'>
     ELSE<a name='258'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='259'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_36">(TRIM(wrf_err_message))<a name='260'>
     ENDIF<a name='261'>
   endif<a name='262'>
# endif<a name='263'>
<font color=#447700>!--------------------------------------------------------------<a name='264'></font>
#endif<a name='265'>
<a name='266'>
 rk_order = config_flags%rk_ord<a name='267'>
 leapfrog = .false.<a name='268'>
<a name='269'>
 IF (time_step_sound == 0) THEN<a name='270'>
<font color=#447700>! auto-set option<a name='271'></font>
<font color=#447700>! This function will give 4 for 6*dx and 6 for 10*dx and returns even numbers only<a name='272'></font>
   time_step_sound = max ( 2 * ( INT (300.*dt/dx-0.01) + 1 ), 4 )<a name='273'>
   WRITE(wrf_err_message,*)'dx, dt, time_step_sound=',dx,dt,time_step_sound<a name='274'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_8"> ( 50 , wrf_err_message )<a name='275'>
 ENDIF<a name='276'>
<a name='277'>
 dts = dt/float(time_step_sound)<a name='278'>
<a name='279'>
 IF(rk_ord == 1) leapfrog = .true.<a name='280'>
<a name='281'>
 Runge_Kutta_loop:  DO rk_step = 1, rk_order<a name='282'>
<a name='283'>
   <font color=#447700>!  Set the step size and number of small timesteps for<a name='284'></font>
   <font color=#447700>!  each part of the timestep<a name='285'></font>
<a name='286'>
   dtm = dt<a name='287'>
   IF ( rk_order == 1 ) THEN   <font color=#447700>! Leapfrog<a name='288'></font>
<a name='289'>
       IF (step_number /= 1) THEN<a name='290'>
         number_of_small_timesteps = 2*time_step_sound<a name='291'>
         dt_rk = dt<a name='292'>
         dtm = 2*dt<a name='293'>
       ELSE<a name='294'>
         number_of_small_timesteps = time_step_sound<a name='295'>
         dt_rk = dt/2.<a name='296'>
         dtm = dt<a name='297'>
       END IF<a name='298'>
<a name='299'>
       dts_rk = dts<a name='300'>
<a name='301'>
   ELSE IF ( rk_order == 2 ) THEN   <font color=#447700>! 2nd order Runge-Kutta timestep<a name='302'></font>
<a name='303'>
       IF ( rk_step == 1) THEN<a name='304'>
             dt_rk  = 0.5*dt<a name='305'>
             dts_rk = dts<a name='306'>
             number_of_small_timesteps = time_step_sound/2<a name='307'>
       ELSE<a name='308'>
             dt_rk = dt<a name='309'>
             dts_rk = dts<a name='310'>
             number_of_small_timesteps = time_step_sound<a name='311'>
       ENDIF<a name='312'>
<a name='313'>
   ELSE IF ( rk_order == 3 ) THEN <font color=#447700>! third order Runge-Kutta<a name='314'></font>
<a name='315'>
       IF ( rk_step == 1) THEN<a name='316'>
            dt_rk = dt/3.<a name='317'>
            dts_rk = dt_rk<a name='318'>
            number_of_small_timesteps = 1<a name='319'>
       ELSE IF (rk_step == 2) THEN<a name='320'>
            dt_rk  = 0.5*dt<a name='321'>
            dts_rk = dts<a name='322'>
            number_of_small_timesteps = time_step_sound/2<a name='323'>
       ELSE<a name='324'>
            dt_rk = dt<a name='325'>
            dts_rk = dts<a name='326'>
            number_of_small_timesteps = time_step_sound<a name='327'>
       ENDIF<a name='328'>
<a name='329'>
   ELSE<a name='330'>
<a name='331'>
      write(wrf_err_message,*)' unknown solver, error exit for dynamics_option = ',dynamics_option<a name='332'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_37">( wrf_err_message )<a name='333'>
<a name='334'>
   END IF<a name='335'>
<a name='336'>
<font color=#447700>!<a name='337'></font>
<font color=#447700>!  Time level t is in the *_2 variable in the first part <a name='338'></font>
<font color=#447700>!  of the step, and in the *_1 variable after the predictor.<a name='339'></font>
<font color=#447700>!  the latest predicted values are stored in the *_2 variables.<a name='340'></font>
<font color=#447700>!<a name='341'></font>
   CALL wrf_debug ( 200 , ' call rk_step_prep ' )<a name='342'>
<a name='343'>
BENCH_START(step_prep_tim)<a name='344'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='345'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='346'></font>
<a name='347'>
   DO ij = 1 , grid%num_tiles<a name='348'>
<a name='349'>
      CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP'>rk_step_prep</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_STEP_PREP_3">  ( config_flags, rk_step,            &amp;<a name='350'>
                           u_2, v_2, w_2, t_2, ph_2, mu_2,   &amp;<a name='351'>
                           moist_2,                          &amp;<a name='352'>
                           ru, rv, rw, ww, php, alt, muu, muv,   &amp;<a name='353'>
                           mub, mut, phb, pb, p, al, alb,    &amp;<a name='354'>
                           cqu, cqv, cqw,                    &amp;<a name='355'>
                           msfu, msfv, msft,                 &amp;<a name='356'>
                           fnm, fnp, dnw, rdx, rdy,          &amp;<a name='357'>
                           num_3d_m,                         &amp;<a name='358'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='359'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='360'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='361'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='362'>
                           k_start, k_end                   )<a name='363'>
<a name='364'>
   END DO<a name='365'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='366'></font>
BENCH_END(step_prep_tim)<a name='367'>
<a name='368'>
#ifdef DM_PARALLEL<a name='369'>
<font color=#447700>!-----------------------------------------------------------------------<a name='370'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='371'></font>
<font color=#447700>!  Note:  the small size of this halo exchange reflects the <a name='372'></font>
<font color=#447700>!         fact that we are carrying the uncoupled variables <a name='373'></font>
<font color=#447700>!         as state variables in the mass coordinate model, as<a name='374'></font>
<font color=#447700>!         opposed to the coupled variables as in the height<a name='375'></font>
<font color=#447700>!         coordinate model.<a name='376'></font>
<font color=#447700>!<a name='377'></font>
<font color=#447700>!                           * * * * *<a name='378'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='379'></font>
<font color=#447700>!       * + *      * + *    * * + * * <a name='380'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='381'></font>
<font color=#447700>!                           * * * * *<a name='382'></font>
<font color=#447700>!<a name='383'></font>
<font color=#447700>!  3D variables - note staggering!  ru(X), rv(Y), ww(Z), php(Z)<a name='384'></font>
<font color=#447700>!<a name='385'></font>
<font color=#447700>!j ru     x<a name='386'></font>
<font color=#447700>!j rv     x<a name='387'></font>
<font color=#447700>!j ww     x<a name='388'></font>
<font color=#447700>!j php    x<a name='389'></font>
<font color=#447700>!j alt    x<a name='390'></font>
<font color=#447700>!j ph_2   x<a name='391'></font>
<font color=#447700>!j phb    x<a name='392'></font>
<font color=#447700>!<a name='393'></font>
<font color=#447700>!  the following are 2D (xy) variables<a name='394'></font>
<font color=#447700>!<a name='395'></font>
<font color=#447700>!j muu    x<a name='396'></font>
<font color=#447700>!j muv    x<a name='397'></font>
<font color=#447700>!j mut    x<a name='398'></font>
<font color=#447700>!--------------------------------------------------------------<a name='399'></font>
#    include "<A href='../../html_code/include/HALO_EM_A.inc.html'>HALO_EM_A.inc</A>"<A NAME="HALO_EM_A.inc_11"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='400'>
#endif<a name='401'>
<a name='402'>
<font color=#447700>! set boundary conditions on variables <a name='403'></font>
<font color=#447700>! from big_step_prep for use in big_step_proc<a name='404'></font>
<a name='405'>
#ifdef DM_PARALLEL<a name='406'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_A.inc.html'>PERIOD_BDY_EM_A.inc</A>"<A NAME="PERIOD_BDY_EM_A.inc_12"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='407'>
#endif<a name='408'>
<a name='409'>
<font color=#447700>!   CALL set_tiles ( grid , ids , ide , jds , jde , ips-1 , ipe+1 , jps-1 , jpe+1 )<a name='410'></font>
<a name='411'>
BENCH_START(set_phys_bc_tim)<a name='412'>
   if(dyn_opt == DYN_EM) then<a name='413'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='414'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='415'></font>
<a name='416'>
   DO ij = 1 , grid%num_tiles<a name='417'>
<a name='418'>
       CALL wrf_debug ( 200 , ' call rk_phys_bc_dry_1' )<a name='419'>
<a name='420'>
        CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RK_PHYS_BC_DRY_1'>rk_phys_bc_dry_1</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_PHYS_BC_DRY_1_1">( config_flags, ru, rv, rw, ww,      &amp; <a name='421'>
                               muu, muv, mut, php, alt, p,        &amp;<a name='422'>
                               ids, ide, jds, jde, kds, kde,      &amp;<a name='423'>
                               ims, ime, jms, jme, kms, kme,      &amp;<a name='424'>
                               ips, ipe, jps, jpe, kps, kpe,      &amp;<a name='425'>
                               grid%i_start(ij), grid%i_end(ij),  &amp;<a name='426'>
                               grid%j_start(ij), grid%j_end(ij),  &amp;<a name='427'>
                               k_start, k_end                )<a name='428'>
<a name='429'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_70">( ph_2, 'w', config_flags,            &amp;<a name='430'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='431'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='432'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='433'>
                               grid%i_start(ij), grid%i_end(ij),        &amp;<a name='434'>
                               grid%j_start(ij), grid%j_end(ij),        &amp;<a name='435'>
                               k_start, k_end                )<a name='436'>
<a name='437'>
   END DO<a name='438'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='439'></font>
   endif<a name='440'>
BENCH_END(set_phys_bc_tim)<a name='441'>
<a name='442'>
    rk_step_is_one : IF (rk_step == 1) THEN <font color=#447700>! only need to initialize diffusion tendencies<a name='443'></font>
<a name='444'>
 <font color=#447700>! initialize all tendencies to zero in order to update physics<a name='445'></font>
 <font color=#447700>! tendencies first (separate from dry dynamics).<a name='446'></font>
 <a name='447'>
BENCH_START(init_zero_tend_tim)<a name='448'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='449'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='450'></font>
<a name='451'>
     DO ij = 1 , grid%num_tiles<a name='452'>
<a name='453'>
        CALL wrf_debug ( 200 , ' call init_zero_tendency' )<a name='454'>
        CALL <A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY'>init_zero_tendency</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_ZERO_TENDENCY_3"> ( ru_tendf, rv_tendf, rw_tendf,     &amp;<a name='455'>
                                  ph_tendf, t_tendf, tke_tend,      &amp;<a name='456'>
                                  moist_tend,chem_tend,             &amp;<a name='457'>
                                  num_3d_m,num_3d_c,rk_step,        &amp;<a name='458'>
                                  ids, ide, jds, jde, kds, kde,     &amp;<a name='459'>
                                  ims, ime, jms, jme, kms, kme,     &amp;<a name='460'>
                                  grid%i_start(ij), grid%i_end(ij), &amp;<a name='461'>
                                  grid%j_start(ij), grid%j_end(ij), &amp;<a name='462'>
                                  k_start, k_end                   )<a name='463'>
<a name='464'>
     END DO<a name='465'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='466'></font>
BENCH_END(init_zero_tend_tim)<a name='467'>
<a name='468'>
#ifdef DM_PARALLEL<a name='469'>
#     include "<A href='../../html_code/include/HALO_EM_PHYS_A.inc.html'>HALO_EM_PHYS_A.inc</A>"<A NAME="HALO_EM_PHYS_A.inc_13"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='470'>
#endif<a name='471'>
<a name='472'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='473'></font>
<font color=#447700>!&lt;pre&gt;<a name='474'></font>
<font color=#447700>!(2) The non-timesplit physics begins with a call to "phy_prep"<a name='475'></font>
<font color=#447700>!    (which computes some diagnostic variables such as temperature,<a name='476'></font>
<font color=#447700>!    pressure, u and v at p points, etc).  This is followed by<a name='477'></font>
<font color=#447700>!    calls to the physics drivers:<a name='478'></font>
<font color=#447700>!<a name='479'></font>
<font color=#447700>!              radiation,<a name='480'></font>
<font color=#447700>!              surface,<a name='481'></font>
<font color=#447700>!              pbl,<a name='482'></font>
<font color=#447700>!              cumulus,<a name='483'></font>
<font color=#447700>!              3D TKE and mixing.<a name='484'></font>
<font color=#447700>!&lt;pre&gt;<a name='485'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='486'></font>
<a name='487'>
<a name='488'>
BENCH_START(phy_prep_tim)<a name='489'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='490'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='491'></font>
      DO ij = 1 , grid%num_tiles<a name='492'>
<a name='493'>
          CALL wrf_debug ( 200 , ' call phy_prep' )<a name='494'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PHY_PREP'>phy_prep</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHY_PREP_3"> ( config_flags,                           &amp;<a name='495'>
                         mut, u_2, v_2, p, pb, alt,              &amp;<a name='496'>
                         ph_2, phb, t_2, tsk, moist_2, num_3d_m, &amp;<a name='497'>
                         mu_3d, rho,                             &amp;<a name='498'>
                         th_phy, p_phy, pi_phy, u_phy, v_phy,    &amp;<a name='499'>
                         p8w, t_phy, t8w, z, z_at_w,             &amp;<a name='500'>
                         dz8w, fnm, fnp,                         &amp;    <a name='501'>
                         RTHRATEN,                               &amp;<a name='502'>
                         RTHBLTEN, RUBLTEN, RVBLTEN,             &amp;<a name='503'>
                         RQVBLTEN, RQCBLTEN, RQIBLTEN,           &amp;<a name='504'>
                         RTHCUTEN, RQVCUTEN, RQCCUTEN,           &amp;<a name='505'>
                         RQRCUTEN, RQICUTEN, RQSCUTEN,           &amp;<a name='506'>
                         RTHFTEN,  RQVFTEN,                      &amp;<a name='507'>
                         ids, ide, jds, jde, kds, kde,           &amp;<a name='508'>
                         ims, ime, jms, jme, kms, kme,           &amp;<a name='509'>
                         grid%i_start(ij), grid%i_end(ij),       &amp;<a name='510'>
                         grid%j_start(ij), grid%j_end(ij),       &amp;<a name='511'>
                         k_start, k_end                         )<a name='512'>
      ENDDO<a name='513'>
      <font color=#447700>!$OMP END PARALLEL DO<a name='514'></font>
<a name='515'>
BENCH_END(phy_prep_tim)<a name='516'>
<a name='517'>
<font color=#447700>!  physics to implement<a name='518'></font>
<a name='519'>
<font color=#447700>!      CALL set_tiles ( grid , ids , ide-1 , jds , jde-1 ips , ipe , jps , jpe )<a name='520'></font>
<a name='521'>
<font color=#447700>! Open MP loops are in physics drivers<a name='522'></font>
<font color=#447700>! radiation<a name='523'></font>
<a name='524'>
         CALL wrf_debug ( 200 , ' call radiation_driver' )<a name='525'>
BENCH_START(rad_driver_tim)<a name='526'>
         if(dyn_opt == DYN_EM) then<a name='527'>
         CALL <A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER'>radiation_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADIATION_DRIVER_1">(itimestep,dt,AER_DRY,AER_WATER,       &amp;<a name='528'>
                    RTHRATENLW,RTHRATENSW,RTHRATEN,GLW,GSW,          &amp;<a name='529'>
                    SWDOWN,                                          &amp;<a name='530'>
                    XLAT,XLONG,ALBEDO,CLDFRA,EMISS,                  &amp;<a name='531'>
                    rho,moist_2,num_3d_m,                            &amp;<a name='532'>
                    p8w,p_phy,pb,pi_phy,dz8w,t_phy,t8w,              &amp;<a name='533'>
                    GMT,JULDAY,config_flags,RADT,STEPRA,ICLOUD,      &amp;<a name='534'>
                    taucldi,taucldc,warm_rain,                       &amp;<a name='535'>
                    XLAND,TSK,HTOP,HBOT,CUPPT,VEGFRA,SNOW,           &amp;<a name='536'>
                    julyr,                                           &amp;<a name='537'>
                    1   ,                                            &amp;<a name='538'>
                    TOTSWDN,TOTLWDN,RSWTOA,RLWTOA,CZMEAN,            &amp;<a name='539'>
                    CFRACL,CFRACM,CFRACH,                            &amp;<a name='540'>
                    ACFRST,NCFRST,ACFRCV,NCFRCV,                     &amp;<a name='541'>
                    ids,ide, jds,jde, kds,kde,                       &amp;<a name='542'>
                    ims,ime, jms,jme, kms,kme,                       &amp;<a name='543'>
                    grid%i_start, min(grid%i_end, ide-1),            &amp;<a name='544'>
                    grid%j_start, min(grid%j_end, jde-1),            &amp;<a name='545'>
                    k_start    , min(k_end,kde-1) , grid%num_tiles   )<a name='546'>
         endif<a name='547'>
BENCH_END(rad_driver_tim)<a name='548'>
<a name='549'>
<a name='550'>
<a name='551'>
<font color=#447700>!********* Surface driver<a name='552'></font>
<font color=#447700>! surface<a name='553'></font>
<a name='554'>
BENCH_START(surf_driver_tim)<a name='555'>
      if(dyn_opt == DYN_EM) then<a name='556'>
      CALL wrf_debug ( 200 , ' call surface_driver' )<a name='557'>
      CALL <A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER'>surface_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURFACE_DRIVER_1">(                                          &amp;<a name='558'>
     &amp;           ACSNOM,ACSNOW,AKHS,AKMS,ALBEDO,BR,CANWAT,CAPG        &amp;<a name='559'>
     &amp;          ,CHKLOWQ,CONFIG_FLAGS,DT,DX,DZ8W,DZS,EMISS,GLW        &amp;<a name='560'>
     &amp;          ,GRDFLX,GSW,GZ1OZ0,HFX,HOL,HT,IFSNOW,ISFFLX           &amp;<a name='561'>
     &amp;          ,ISLTYP,ITIMESTEP,IVGTYP,LOWLYR,MAVAIL,MOIST_2,MOL,RMOL&amp;<a name='562'>
     &amp;          ,NUM_SOIL_LAYERS,NUM_3D_M,P8W,PBLH,PI_PHY,PSHLTR,PSIH &amp;<a name='563'>
     &amp;          ,PSIM,P_PHY,Q10,Q2,QFX,QSFC,QSHLTR,QZ0,RAINBL         &amp;<a name='564'>
     &amp;          ,RAINCV,RAINNCV,REGIME,RHO,SFCEVP,SFCEXC,SFCRUNOFF    &amp;<a name='565'>
     &amp;          ,SMOIS,SMSTAV,SMSTOT,SNOALB,SNOW,SNOWC,SNOWH,STEPBL   &amp;<a name='566'>
     &amp;          ,T2,TH10,TH2,THC,THZ0,TH_PHY,TMN,TSHLTR,TSK,TSLB      &amp;<a name='567'>
     &amp;          ,T_PHY,U10,UDRUNOFF,UST,UZ0,U_FRAME,U_PHY,V10,VEGFRA  &amp;<a name='568'>
     &amp;          ,VZ0,V_FRAME,V_PHY,WARM_RAIN,WSPD,XICE,XLAND,Z,ZNT,ZS &amp;<a name='569'>
     &amp;          ,CT,TKE_MYJ                                           &amp;<a name='570'>
     &amp;          ,ALBBCK,LH,SH2O,SHDMAX,SHDMIN,Z0                      &amp;<a name='571'>
     &amp;          ,flqc,flhc,qsg,qvg,qcg,soilt1,tsnav                   &amp; <font color=#447700>! for RUC LSM<a name='572'></font>
     &amp;          ,SMFR3D,KEEPFR3DFLAG                                  &amp;<a name='573'>
     &amp;          ,PSFC                                                 &amp;<a name='574'>
     &amp;          ,ids,ide, jds,jde, kds,kde                            &amp;<a name='575'>
     &amp;          ,ims,ime, jms,jme, kms,kme                            &amp;<a name='576'>
     &amp;          ,grid%i_start, min(grid%i_end, ide-1)                 &amp;<a name='577'>
     &amp;          ,grid%j_start, min(grid%j_end, jde-1)                 &amp;<a name='578'>
     &amp;          ,k_start    , min(k_end,kde-1) , grid%num_tiles       )<a name='579'>
      endif<a name='580'>
BENCH_END(surf_driver_tim)<a name='581'>
<a name='582'>
<font color=#447700>!*********<a name='583'></font>
<font color=#447700>! pbl<a name='584'></font>
<a name='585'>
BENCH_START(pbl_driver_tim)<a name='586'>
      if(dyn_opt == DYN_EM) then<a name='587'>
      CALL wrf_debug ( 200 , ' call pbl_driver' )<a name='588'>
      CALL <A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER'>pbl_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PBL_DRIVER_1">(itimestep,dt,u_frame,v_frame                    &amp;<a name='589'>
     &amp;           ,RUBLTEN,RVBLTEN,RTHBLTEN                            &amp;<a name='590'>
     &amp;           ,RQVBLTEN,RQCBLTEN,RQIBLTEN                          &amp;<a name='591'>
     &amp;           ,TSK,XLAND,ZNT,HT                                    &amp;<a name='592'>
     &amp;           ,UST,HOL,MOL,PBLH                                    &amp;<a name='593'>
     &amp;           ,HFX,QFX,REGIME,GRDFLX                               &amp;<a name='594'>
     &amp;           ,u_phy,v_phy,th_phy,rho,moist_2                      &amp;<a name='595'>
     &amp;           ,p_phy,pi_phy,p8w,t_phy,dz8w,z                       &amp;<a name='596'>
     &amp;           ,TKE_MYJ,EXCH_H,AKHS,AKMS                            &amp;<a name='597'>
     &amp;           ,THZ0,QZ0,UZ0,VZ0,QSFC,LOWLYR                        &amp;<a name='598'>
     &amp;           ,PSIM, PSIH, GZ1OZ0, WSPD, BR, CHKLOWQ               &amp;<a name='599'>
     &amp;           ,config_flags,DX,num_3d_m                            &amp;<a name='600'>
     &amp;           ,STEPBL,warm_rain                                    &amp;<a name='601'>
     &amp;           ,KPBL,CT,LH,SNOW,XICE                                &amp;<a name='602'>
     &amp;           ,ids,ide, jds,jde, kds,kde                           &amp;<a name='603'>
     &amp;           ,ims,ime, jms,jme, kms,kme                           &amp;<a name='604'>
     &amp;           ,grid%i_start, min(grid%i_end,ide-1)                 &amp;<a name='605'>
     &amp;           ,grid%j_start, min(grid%j_end,jde-1)                 &amp;<a name='606'>
     &amp;           ,k_start    , min(k_end,kde-1) , grid%num_tiles  )<a name='607'>
      endif<a name='608'>
BENCH_END(pbl_driver_tim)<a name='609'>
<a name='610'>
<font color=#447700>! cumulus para.<a name='611'></font>
<a name='612'>
BENCH_START(cu_driver_tim)<a name='613'>
         if(dyn_opt == DYN_EM) then<a name='614'>
         CALL wrf_debug ( 200 , ' call cumulus_driver' )<a name='615'>
         CALL <A href='../../html_code/phys/module_cumulus_driver.F.html#CUMULUS_DRIVER'>cumulus_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUMULUS_DRIVER_1">(                                          &amp;<a name='616'>
                 <font color=#447700>! Order dependent args: domain, mem, tile dims<a name='617'></font>
                     ids,ide, jds,jde, kds,kde                         &amp;<a name='618'>
                   , ims,ime, jms,jme, kms,kme                         &amp;<a name='619'>
                   , grid%i_start, min(grid%i_end, ide-1)              &amp;<a name='620'>
                   , grid%j_start, min(grid%j_end, jde-1)              &amp;<a name='621'>
                   , k_start  , min(k_end,kde-1) , grid%num_tiles      &amp;<a name='622'>
                 <font color=#447700>! Prognostic variables<a name='623'></font>
                   , U=u_phy   ,V=v_phy   ,TH=th_phy  ,T=t_phy         &amp;<a name='624'>
                   , W=w_2     ,P=p_phy   ,PI=pi_phy  ,RHO=rho         &amp;<a name='625'>
                 <font color=#447700>! Other arguments<a name='626'></font>
                   , ITIMESTEP=itimestep ,DT=dt      ,DX=dx            &amp;<a name='627'>
                   , RAINC=rainc   ,RAINCV=raincv   ,NCA=nca           &amp;<a name='628'>
                   , HTOP=htop     ,HBOT=hbot       ,KPBL=kpbl         &amp;<a name='629'>
                   , DZ8W=dz8w     ,P8W=p8w                            &amp;<a name='630'>
                   , W0AVG=w0avg   ,STEPCU=stepcu                      &amp;<a name='631'>
                   , CLDEFI=cldefi ,LOWLYR=lowlyr ,XLAND=xland         &amp;<a name='632'>
                   , APR_GR=apr_gr ,APR_W=apr_w   ,APR_MC=apr_mc       &amp;<a name='633'>
                   , APR_ST=apr_st ,APR_AS=apr_as ,APR_CAPMA=apr_capma &amp;<a name='634'>
                   , APR_CAPME=apr_capme          ,APR_CAPMI=apr_capmi &amp;<a name='635'>
                   , MASS_FLUX=mass_flux          ,XF_ENS=xf_ens       &amp;<a name='636'>
                   , PR_ENS=pr_ens ,HT=ht                              &amp;<a name='637'>
                   , ENSDIM=ensdim ,MAXIENS=maxiens ,MAXENS=maxens     &amp;<a name='638'>
                   , MAXENS2=maxens2                ,MAXENS3=maxens3   &amp;<a name='639'>
                   , CU_ACT_FLAG=cu_act_flag   ,WARM_RAIN=warm_rain    &amp;<a name='640'>
                 <font color=#447700>! Selection flag<a name='641'></font>
                   , CU_PHYSICS=config_flags%cu_physics                &amp;<a name='642'>
                 <font color=#447700>! Moisture tendency arguments<a name='643'></font>
                   , RQVCUTEN=rqvcuten , RQCCUTEN=rqccuten             &amp;<a name='644'>
                   , RQRCUTEN=rqrcuten , RQVBLTEN=rqvblten             &amp;<a name='645'>
                   , RQVFTEN=rqvften                                   &amp;<a name='646'>
                 <font color=#447700>! Other tendency arguments<a name='647'></font>
                   , RTHRATEN=rthraten , RTHBLTEN=rthblten             &amp;<a name='648'>
                   , RTHCUTEN=rthcuten , RTHFTEN=rthften               &amp;<a name='649'>
                 <font color=#447700>! Moisture tracer arguments<a name='650'></font>
                   , QV_CURR=moist_2(ims,kms,jms,P_QV), F_QV=F_QV      &amp;<a name='651'>
                   , QC_CURR=moist_2(ims,kms,jms,P_QC), F_QC=F_QC      &amp;<a name='652'>
                   , QR_CURR=moist_2(ims,kms,jms,P_QR), F_QR=F_QR      &amp;<a name='653'>
                   , QI_CURR=moist_2(ims,kms,jms,P_QI), F_QI=F_QI      &amp;<a name='654'>
                   , QS_CURR=moist_2(ims,kms,jms,P_QS), F_QS=F_QS      &amp;<a name='655'>
                   , QG_CURR=moist_2(ims,kms,jms,P_QG), F_QG=F_QG      &amp;<a name='656'>
                                                                       )<a name='657'>
         endif<a name='658'>
<a name='659'>
         IF (cu_physics .eq. 5) then            <font color=#447700>!IF for CUDU<a name='660'></font>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_9">(100,'in du_cps')<a name='661'>
            DO ij = 1, grid%num_tiles<a name='662'>
<a name='663'>
               Print *, 'xxxx  CALL DU_CU scheme from solve_em xxxx, ij= ',ij<a name='664'>
               CALL <A href='../../html_code/phys/module_cu_du.F.html#DUCU'>DUCU</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DUCU_3">(                                            &amp;<a name='665'>
               IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde &amp;<a name='666'>
               ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme &amp;<a name='667'>
               ,ITS=grid%i_start(ij),ITE=min(grid%i_end(ij), ide-1)      &amp;<a name='668'>
               ,JTS=grid%j_start(ij),JTE= min(grid%j_end(ij), jde-1)    &amp;<a name='669'>
               ,KTS=k_start,KTE=min(k_end, kde-1) &amp;<a name='670'>
               ,DT=dt ,KTAU=itimestep ,DX=dx                    &amp;<a name='671'>
               ,RHO=rho,RAINCV=raincv, NCA=nca                  &amp;<a name='672'>
               ,U=u_phy ,V=v_phy ,TH=th_phy ,T=t_phy ,W=w_2    &amp;<a name='673'>
               ,DZ8W=dz8w               &amp;<a name='674'>
               ,Z=z, PCPS=p_phy, PI=pi_phy ,W0AVG=grid%W0AVG                 &amp;<a name='675'>
               ,XLV=XLV                                         &amp;<a name='676'>
               ,CP=CP ,RD=R_d ,RV=R_v ,G=G ,EP2=EP_2             &amp;<a name='677'>
               ,SVP1=SVP1 ,SVP2=SVP2 ,SVP3=SVP3 ,SVPT0=SVPT0    &amp;<a name='678'>
               ,STEPCU=stepcu                                   &amp;<a name='679'>
               ,CU_ACT_FLAG=cu_act_flag ,warm_rain=warm_rain    &amp;<a name='680'>
               ,CUTOP=HTOP,CUBOT=HBOT                           &amp;<a name='681'>
               ,QV=moist_2(ims,kms,jms,P_QV) 		                                     &amp;<a name='682'>
              <font color=#447700>! optionals<a name='683'></font>
               ,RTHCUTEN=rthcuten                               &amp;<a name='684'>
               ,RQVCUTEN=rqvcuten                               &amp;<a name='685'>
                                                                )<a name='686'>
<a name='687'>
               do j = grid%j_start(ij), min(grid%j_end(ij), jde-1)<a name='688'>
               do i = grid%i_start(ij), min(grid%i_end(ij), ide-1)<a name='689'>
                  do k = k_start, min(k_end, kde-1)<a name='690'>
                     t_tendf(I,K,J) = t_tendf(I,K,J) + rthcuten(I,K,J) * mut(I,J)<a name='691'>
                     moist_tend(I,K,J,P_QV) = moist_tend(I,K,J,P_QV) + rqvcuten(I,K,J) * mut(I,J)<a name='692'>
                  end do<a name='693'>
                  rainc(I,J) = rainc(I,J) + raincv(I,J)<a name='694'>
               end do<a name='695'>
               end do<a name='696'>
<a name='697'>
            END DO<a name='698'>
         ENDIF <a name='699'>
<a name='700'>
BENCH_END(cu_driver_tim)<a name='701'>
<a name='702'>
<font color=#447700>! calculate_phy_tend<a name='703'></font>
<a name='704'>
BENCH_START(cal_phy_tend)<a name='705'>
      if(dyn_opt == DYN_EM) then<a name='706'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='707'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='708'></font>
<a name='709'>
      DO ij = 1 , grid%num_tiles<a name='710'>
<a name='711'>
          CALL wrf_debug ( 200 , ' call calculate_phy_tend' )<a name='712'>
          CALL <A href='../../html_code/dyn_em/module_em.F.html#CALCULATE_PHY_TEND'>calculate_phy_tend</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_PHY_TEND_1"> (config_flags,mut,pi_phy,            &amp;<a name='713'>
                     RTHRATEN,                                         &amp;<a name='714'>
                     RUBLTEN,RVBLTEN,RTHBLTEN,                         &amp;<a name='715'>
                     RQVBLTEN,RQCBLTEN,RQIBLTEN,                       &amp;<a name='716'>
                     RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN,              &amp;<a name='717'>
                     RQICUTEN,RQSCUTEN,                                &amp;<a name='718'>
                     ids,ide, jds,jde, kds,kde,                        &amp;<a name='719'>
                     ims,ime, jms,jme, kms,kme,                        &amp;<a name='720'>
                     grid%i_start(ij), min(grid%i_end(ij),ide-1),      &amp;<a name='721'>
                     grid%j_start(ij), min(grid%j_end(ij),jde-1),      &amp;<a name='722'>
                     k_start    , min(k_end,kde-1)                     )<a name='723'>
<a name='724'>
      ENDDO<a name='725'>
      <font color=#447700>!$OMP END PARALLEL DO<a name='726'></font>
      endif<a name='727'>
BENCH_END(cal_phy_tend)<a name='728'>
<a name='729'>
<font color=#447700>! tke diffusion<a name='730'></font>
<a name='731'>
     IF(diff_opt .eq. 2 .OR. diff_opt .eq. 1) THEN<a name='732'>
<a name='733'>
BENCH_START(comp_diff_metrics_tim)<a name='734'>
       if(dyn_opt == DYN_EM) then<a name='735'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='736'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='737'></font>
<a name='738'>
       DO ij = 1 , grid%num_tiles<a name='739'>
<a name='740'>
          CALL wrf_debug ( 200 , ' call compute_diff_metrics ' )<a name='741'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#COMPUTE_DIFF_METRICS'>compute_diff_metrics</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_DIFF_METRICS_1"> ( config_flags, ph_2, phb, z, rdz, rdzw, &amp;<a name='742'>
                                      zx, zy, rdx, rdy,                      &amp;<a name='743'>
                                      ids, ide, jds, jde, kds, kde,          &amp;<a name='744'>
                                      ims, ime, jms, jme, kms, kme,          &amp;<a name='745'>
                                      grid%i_start(ij), grid%i_end(ij),      &amp;<a name='746'>
                                      grid%j_start(ij), grid%j_end(ij),      &amp;<a name='747'>
                                      k_start    , k_end                    )<a name='748'>
       ENDDO<a name='749'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='750'></font>
       endif<a name='751'>
BENCH_END(comp_diff_metrics_tim)<a name='752'>
<a name='753'>
#ifdef DM_PARALLEL<a name='754'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_A1.inc.html'>PERIOD_BDY_EM_A1.inc</A>"<A NAME="PERIOD_BDY_EM_A1.inc_14"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='755'>
#endif<a name='756'>
<a name='757'>
BENCH_START(tke_diff_bc_tim)<a name='758'>
       if(dyn_opt == DYN_EM) then<a name='759'>
       DO ij = 1 , grid%num_tiles<a name='760'>
<a name='761'>
          CALL wrf_debug ( 200 , ' call bc for diffusion_metrics ' )<a name='762'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_71">( rdzw , 'w', config_flags,           &amp;<a name='763'>
                                  ids, ide, jds, jde, kds, kde,       &amp;<a name='764'>
                                  ims, ime, jms, jme, kms, kme,       &amp;<a name='765'>
                                  ips, ipe, jps, jpe, kps, kpe,       &amp;<a name='766'>
                                  grid%i_start(ij), grid%i_end(ij),   &amp;<a name='767'>
                                  grid%j_start(ij), grid%j_end(ij),   &amp;<a name='768'>
                                  k_start    , k_end                 )<a name='769'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_72">( rdz , 'w', config_flags,           &amp;<a name='770'>
                                  ids, ide, jds, jde, kds, kde,       &amp;<a name='771'>
                                  ims, ime, jms, jme, kms, kme,       &amp;<a name='772'>
                                  ips, ipe, jps, jpe, kps, kpe,       &amp;<a name='773'>
                                  grid%i_start(ij), grid%i_end(ij),   &amp;<a name='774'>
                                  grid%j_start(ij), grid%j_end(ij),   &amp;<a name='775'>
                                  k_start    , k_end                 )<a name='776'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_73">( z , 'w', config_flags,           &amp;<a name='777'>
                                  ids, ide, jds, jde, kds, kde,       &amp;<a name='778'>
                                  ims, ime, jms, jme, kms, kme,       &amp;<a name='779'>
                                  ips, ipe, jps, jpe, kps, kpe,       &amp;<a name='780'>
                                  grid%i_start(ij), grid%i_end(ij),   &amp;<a name='781'>
                                  grid%j_start(ij), grid%j_end(ij),   &amp;<a name='782'>
                                  k_start    , k_end                 )<a name='783'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_74">( zx , 'w', config_flags,           &amp;<a name='784'>
                                  ids, ide, jds, jde, kds, kde,       &amp;<a name='785'>
                                  ims, ime, jms, jme, kms, kme,       &amp;<a name='786'>
                                  ips, ipe, jps, jpe, kps, kpe,       &amp;<a name='787'>
                                  grid%i_start(ij), grid%i_end(ij),   &amp;<a name='788'>
                                  grid%j_start(ij), grid%j_end(ij),   &amp;<a name='789'>
                                  k_start    , k_end                 )<a name='790'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_75">( zy , 'w', config_flags,           &amp;<a name='791'>
                                  ids, ide, jds, jde, kds, kde,       &amp;<a name='792'>
                                  ims, ime, jms, jme, kms, kme,       &amp;<a name='793'>
                                  ips, ipe, jps, jpe, kps, kpe,       &amp;<a name='794'>
                                  grid%i_start(ij), grid%i_end(ij),   &amp;<a name='795'>
                                  grid%j_start(ij), grid%j_end(ij),   &amp;<a name='796'>
                                  k_start    , k_end                 )<a name='797'>
<a name='798'>
       ENDDO<a name='799'>
       endif<a name='800'>
BENCH_END(tke_diff_bc_tim)<a name='801'>
<a name='802'>
#ifdef DM_PARALLEL<a name='803'>
#     include "<A href='../../html_code/include/HALO_EM_TKE_C.inc.html'>HALO_EM_TKE_C.inc</A>"<A NAME="HALO_EM_TKE_C.inc_15"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='804'>
#endif<a name='805'>
<a name='806'>
BENCH_START(deform_div_tim)<a name='807'>
       if(dyn_opt == DYN_EM) then<a name='808'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='809'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='810'></font>
<a name='811'>
       DO ij = 1 , grid%num_tiles<a name='812'>
<a name='813'>
          CALL wrf_debug ( 200 , ' call cal_deform_and_div' )<a name='814'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_DEFORM_AND_DIV'>cal_deform_and_div</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_DEFORM_AND_DIV_1"> ( config_flags,u_2,v_2,w_2,div,        &amp;<a name='815'>
                                    defor11,defor22,defor33,defor12,     &amp;<a name='816'>
                                    defor13,defor23,                     &amp;<a name='817'>
                                    u_base, v_base,msfu,msfv,msft,       &amp;<a name='818'>
                                    rdx, rdy, dn, dnw, rdz, rdzw,        &amp;<a name='819'>
                                    fnm,fnp,cf1,cf2,cf3,zx,zy,           &amp;<a name='820'>
                                    ids, ide, jds, jde, kds, kde,        &amp;<a name='821'>
                                    ims, ime, jms, jme, kms, kme,        &amp;<a name='822'>
                                    grid%i_start(ij), grid%i_end(ij),    &amp;<a name='823'>
                                    grid%j_start(ij), grid%j_end(ij),    &amp;<a name='824'>
                                    k_start    , k_end                  )<a name='825'>
       ENDDO<a name='826'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='827'></font>
       endif<a name='828'>
BENCH_END(deform_div_tim)<a name='829'>
<a name='830'>
<a name='831'>
#ifdef DM_PARALLEL<a name='832'>
#     include "<A href='../../html_code/include/HALO_EM_TKE_D.inc.html'>HALO_EM_TKE_D.inc</A>"<A NAME="HALO_EM_TKE_D.inc_16"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='833'>
#endif<a name='834'>
<a name='835'>
<a name='836'>
<font color=#447700>! calculate tke, kmh, and kmv<a name='837'></font>
<a name='838'>
BENCH_START(calc_tke_tim)<a name='839'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='840'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='841'></font>
<a name='842'>
       DO ij = 1 , grid%num_tiles<a name='843'>
<a name='844'>
          CALL wrf_debug ( 200 , ' call calculate_km_kh' )<a name='845'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH'>calculate_km_kh</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_KM_KH_3">( config_flags,dt,dampcoef,zdamp,damp_opt,     &amp;<a name='846'>
                                xkmh,xkmhd,xkmv,xkhh,xkhv,BN2,               &amp;<a name='847'>
                                khdif,kvdif,div,                             &amp;<a name='848'>
                                defor11,defor22,defor33,defor12,             &amp;<a name='849'>
                                defor13,defor23,                             &amp;<a name='850'>
                                tke_2(ims,kms,jms),p8w,t8w,th_phy,           &amp;<a name='851'>
                                t_phy,p_phy,moist_2,dn,dnw,                  &amp;<a name='852'>
                                dx,dy,rdz,rdzw,mix_cr_len,num_3d_m,          &amp;<a name='853'>
                                cf1, cf2, cf3, warm_rain,                    &amp;<a name='854'>
                                kh_tke_upper_bound, kv_tke_upper_bound,      &amp;<a name='855'>
                                ids,ide, jds,jde, kds,kde,                   &amp;<a name='856'>
                                ims,ime, jms,jme, kms,kme,                   &amp;<a name='857'>
                                grid%i_start(ij), grid%i_end(ij),            &amp;<a name='858'>
                                grid%j_start(ij), grid%j_end(ij),            &amp;<a name='859'>
                                k_start    , k_end                          )<a name='860'>
       ENDDO<a name='861'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='862'></font>
BENCH_END(calc_tke_tim)<a name='863'>
<a name='864'>
#ifdef DM_PARALLEL<a name='865'>
#     include "<A href='../../html_code/include/HALO_EM_TKE_E.inc.html'>HALO_EM_TKE_E.inc</A>"<A NAME="HALO_EM_TKE_E.inc_17"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='866'>
#endif<a name='867'>
<a name='868'>
     ENDIF<a name='869'>
<a name='870'>
#ifdef DM_PARALLEL<a name='871'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_PHY_BC.inc.html'>PERIOD_BDY_EM_PHY_BC.inc</A>"<A NAME="PERIOD_BDY_EM_PHY_BC.inc_18"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='872'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_CHEM.inc.html'>PERIOD_BDY_EM_CHEM.inc</A>"<A NAME="PERIOD_BDY_EM_CHEM.inc_19"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='873'>
#endif<a name='874'>
<a name='875'>
BENCH_START(phy_bc_tim)<a name='876'>
     if(dyn_opt == DYN_EM) then<a name='877'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='878'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='879'></font>
<a name='880'>
     DO ij = 1 , grid%num_tiles<a name='881'>
<a name='882'>
          CALL wrf_debug ( 200 , ' call phy_bc' )<a name='883'>
       CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC'>phy_bc</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHY_BC_1"> (config_flags,div,defor11,defor22,defor33,            &amp;<a name='884'>
                            defor12,defor13,defor23,                     &amp;<a name='885'>
                            xkmh,xkmhd,xkmv,xkhh,xkhv,                   &amp;<a name='886'>
                            tke_2(ims,kms,jms),                          &amp;<a name='887'>
                            RUBLTEN, RVBLTEN,                            &amp;<a name='888'>
                            ids, ide, jds, jde, kds, kde,                &amp;<a name='889'>
                            ims, ime, jms, jme, kms, kme,                &amp;<a name='890'>
                            ips, ipe, jps, jpe, kps, kpe,                &amp;<a name='891'>
                            grid%i_start(ij), grid%i_end(ij),                      &amp;<a name='892'>
                            grid%j_start(ij), grid%j_end(ij),                      &amp;<a name='893'>
                            k_start    , k_end                           )<a name='894'>
     ENDDO<a name='895'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='896'></font>
     endif<a name='897'>
BENCH_END(phy_bc_tim)<a name='898'>
<a name='899'>
#ifdef DM_PARALLEL<a name='900'>
<font color=#447700>!-----------------------------------------------------------------------<a name='901'></font>
<font color=#447700>!<a name='902'></font>
<font color=#447700>! MPP for some physics tendency, km, kh, deformation, and divergence<a name='903'></font>
<font color=#447700>!<a name='904'></font>
<font color=#447700>!               *                     *<a name='905'></font>
<font color=#447700>!             * + *      * + *        +<a name='906'></font>
<font color=#447700>!               *                     *<a name='907'></font>
<font color=#447700>!<a name='908'></font>
<font color=#447700>! (for PBL)<a name='909'></font>
<font color=#447700>! RUBLTEN                  x<a name='910'></font>
<font color=#447700>! RVBLTEN                             x<a name='911'></font>
<font color=#447700>!<a name='912'></font>
<font color=#447700>! (for diff_opt &gt;= 1)<a name='913'></font>
<font color=#447700>! defor11                  x<a name='914'></font>
<font color=#447700>! defor22                             x<a name='915'></font>
<font color=#447700>! defor12       x<a name='916'></font>
<font color=#447700>! defor13                  x<a name='917'></font>
<font color=#447700>! defor23                             x<a name='918'></font>
<font color=#447700>! div           x<a name='919'></font>
<font color=#447700>! xkmv          x<a name='920'></font>
<font color=#447700>! xkmh          x<a name='921'></font>
<font color=#447700>! xkmhd         x<a name='922'></font>
<font color=#447700>! xkhv          x<a name='923'></font>
<font color=#447700>! xkhh          x<a name='924'></font>
<font color=#447700>! tke           x<a name='925'></font>
<font color=#447700>!<a name='926'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='927'></font>
      IF ( bl_pbl_physics .ge. 1 ) THEN<a name='928'>
#      include "<A href='../../html_code/include/HALO_EM_PHYS_PBL.inc.html'>HALO_EM_PHYS_PBL.inc</A>"<A NAME="HALO_EM_PHYS_PBL.inc_20"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='929'>
      ENDIF<a name='930'>
      IF ( diff_opt .ge. 1 ) THEN<a name='931'>
#      include "<A href='../../html_code/include/HALO_EM_PHYS_DIFFUSION.inc.html'>HALO_EM_PHYS_DIFFUSION.inc</A>"<A NAME="HALO_EM_PHYS_DIFFUSION.inc_21"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='932'>
      ENDIF<a name='933'>
<a name='934'>
      IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='935'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_3.inc.html'>HALO_EM_TKE_3.inc</A>"<A NAME="HALO_EM_TKE_3.inc_22"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='936'>
      ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='937'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_5.inc.html'>HALO_EM_TKE_5.inc</A>"<A NAME="HALO_EM_TKE_5.inc_23"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='938'>
      ELSE<a name='939'>
        WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='940'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_38">(TRIM(wrf_err_message))<a name='941'>
      ENDIF<a name='942'>
#endif<a name='943'>
<a name='944'>
BENCH_START(update_phy_ten_tim)<a name='945'>
      if(dyn_opt == DYN_EM) then<a name='946'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='947'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='948'></font>
<a name='949'>
      DO ij = 1 , grid%num_tiles<a name='950'>
<a name='951'>
          CALL wrf_debug ( 200 , ' call update_phy_ten' )<a name='952'>
        CALL <A href='../../html_code/phys/module_physics_addtendc.F.html#UPDATE_PHY_TEN'>update_phy_ten</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPDATE_PHY_TEN_1">(t_tendf, ru_tendf, rv_tendf,moist_tend,        &amp;<a name='953'>
                          RTHRATEN,RTHBLTEN,RTHCUTEN,RUBLTEN,RVBLTEN,  &amp;<a name='954'>
                          RQVBLTEN,RQCBLTEN,RQIBLTEN,                  &amp;<a name='955'>
                          RQVCUTEN,RQCCUTEN,RQRCUTEN,RQICUTEN,RQSCUTEN,&amp;<a name='956'>
                          num_3d_m,config_flags,rk_step,              &amp;<a name='957'>
                          ids, ide, jds, jde, kds, kde,                &amp;<a name='958'>
                          ims, ime, jms, jme, kms, kme,                &amp;<a name='959'>
                          grid%i_start(ij), grid%i_end(ij),                      &amp;<a name='960'>
                          grid%j_start(ij), grid%j_end(ij),                      &amp;<a name='961'>
                          k_start, k_end                               )<a name='962'>
<a name='963'>
      END DO<a name='964'>
      <font color=#447700>!$OMP END PARALLEL DO<a name='965'></font>
      endif<a name='966'>
BENCH_END(update_phy_ten_tim)<a name='967'>
<a name='968'>
     IF( diff_opt .eq. 2 .and. km_opt .eq. 2 ) THEN<a name='969'>
<a name='970'>
BENCH_START(tke_rhs_tim)<a name='971'>
       if(dyn_opt == DYN_EM) then<a name='972'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='973'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='974'></font>
<a name='975'>
       DO ij = 1 , grid%num_tiles<a name='976'>
<a name='977'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_RHS'>tke_rhs</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TKE_RHS_1">  ( tke_tend,BN2,                               &amp;<a name='978'>
                          config_flags,defor11,defor22,defor33,       &amp;<a name='979'>
                          defor12,defor13,defor23,u_2,v_2,w_2,div,    &amp;<a name='980'>
                          tke_2(ims,kms,jms),mut,                     &amp;<a name='981'>
                          th_phy,p_phy,p8w,t8w,z,fnm,fnp,             &amp;<a name='982'>
                          cf1,cf2,cf3,msft,xkmh,xkmv,xkhv,rdx,rdy,    &amp;<a name='983'>
                          dx,dy,dt,zx,zy,rdz,rdzw,dn,dnw,mix_cr_len,  &amp;<a name='984'>
                          ids, ide, jds, jde, kds, kde,               &amp;<a name='985'>
                          ims, ime, jms, jme, kms, kme,               &amp;<a name='986'>
                          grid%i_start(ij), grid%i_end(ij),           &amp;<a name='987'>
                          grid%j_start(ij), grid%j_end(ij),           &amp;<a name='988'>
                          k_start    , k_end                         )<a name='989'>
<a name='990'>
       ENDDO<a name='991'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='992'></font>
       endif<a name='993'>
BENCH_END(tke_rhs_tim)<a name='994'>
<a name='995'>
     ENDIF<a name='996'>
<a name='997'>
<font color=#447700>! calculate vertical diffusion first and then horizontal<a name='998'></font>
<font color=#447700>! (keep this order)<a name='999'></font>
<a name='1000'>
     IF(diff_opt .eq. 2) THEN<a name='1001'>
<a name='1002'>
       IF (bl_pbl_physics .eq. 0) THEN<a name='1003'>
<a name='1004'>
BENCH_START(vert_diff_tim)<a name='1005'>
         if(dyn_opt == DYN_EM) then<a name='1006'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1007'></font>
         <font color=#447700>!$OMP PRIVATE ( ij )<a name='1008'></font>
         DO ij = 1 , grid%num_tiles<a name='1009'>
<a name='1010'>
           CALL wrf_debug ( 200 , ' call vertical_diffusion_2 ' )<a name='1011'>
           CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2'>vertical_diffusion_2</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_2_1">( ru_tendf, rv_tendf, rw_tendf,              &amp;<a name='1012'>
                                      t_tendf, tke_tend,                         &amp;<a name='1013'>
                                      moist_tend, num_3d_m,                      &amp;<a name='1014'>
                                      chem_tend, num_3d_c,                       &amp;<a name='1015'>
                                      u_2, v_2,                                  &amp;<a name='1016'>
                                      t_2,u_base,v_base,t_base,qv_base,          &amp;<a name='1017'>
                                      mut,tke_2,config_flags,                    &amp;<a name='1018'>
                                      defor13,defor23,defor33,                   &amp;<a name='1019'>
                                      div, moist_2, chem_2, xkmv, xkhv, km_opt,  &amp;<a name='1020'>
                                      fnm, fnp, dn, dnw, rdz, rdzw,              &amp;<a name='1021'>
                                      ids, ide, jds, jde, kds, kde,              &amp;<a name='1022'>
                                      ims, ime, jms, jme, kms, kme,              &amp;<a name='1023'>
                                      grid%i_start(ij), grid%i_end(ij),          &amp;<a name='1024'>
                                      grid%j_start(ij), grid%j_end(ij),          &amp;<a name='1025'>
                                      k_start    , k_end                        )<a name='1026'>
<a name='1027'>
         ENDDO<a name='1028'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='1029'></font>
         endif<a name='1030'>
BENCH_END(vert_diff_tim)<a name='1031'>
<a name='1032'>
       ENDIF<a name='1033'>
<font color=#447700>!<a name='1034'></font>
BENCH_START(hor_diff_tim)<a name='1035'>
       if(dyn_opt == DYN_EM) then<a name='1036'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1037'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1038'></font>
       DO ij = 1 , grid%num_tiles<a name='1039'>
<a name='1040'>
          CALL wrf_debug ( 200 , ' call horizontal_diffusion_2' )<a name='1041'>
         CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2'>horizontal_diffusion_2</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_2_1">( t_tendf, ru_tendf, rv_tendf, rw_tendf, &amp;<a name='1042'>
                                      tke_tend,                              &amp;<a name='1043'>
                                      moist_tend, num_3d_m,                  &amp;<a name='1044'>
                                      chem_tend, num_3d_c,                   &amp;<a name='1045'>
                                      t_2, th_phy,                           &amp;<a name='1046'>
                                      mut, tke_2, config_flags,              &amp;<a name='1047'>
                                      defor11, defor22, defor12,             &amp;<a name='1048'>
                                      defor13, defor23, div,                 &amp;<a name='1049'>
                                      moist_2, chem_2,                       &amp;<a name='1050'>
                                      msfu, msfv, msft, xkmhd, xkhh, km_opt, &amp;<a name='1051'>
                                      rdx, rdy, rdz, rdzw,                   &amp;<a name='1052'>
                                      fnm, fnp, cf1, cf2, cf3,               &amp;<a name='1053'>
                                      zx, zy, dn, dnw,                       &amp;<a name='1054'>
                                      ids, ide, jds, jde, kds, kde,          &amp;<a name='1055'>
                                      ims, ime, jms, jme, kms, kme,          &amp;<a name='1056'>
                                      grid%i_start(ij), grid%i_end(ij),      &amp;<a name='1057'>
                                      grid%j_start(ij), grid%j_end(ij),      &amp;<a name='1058'>
                                      k_start    , k_end                    )<a name='1059'>
       ENDDO<a name='1060'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1061'></font>
       endif<a name='1062'>
BENCH_END(hor_diff_tim)<a name='1063'>
<a name='1064'>
     ENDIF<a name='1065'>
<a name='1066'>
     END IF rk_step_is_one<a name='1067'>
<a name='1068'>
BENCH_START(rk_tend_tim)<a name='1069'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1070'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='1071'></font>
   DO ij = 1 , grid%num_tiles<a name='1072'>
<a name='1073'>
      CALL wrf_debug ( 200 , ' call rk_tendency' )<a name='1074'>
      CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY'>rk_tendency</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_TENDENCY_3"> ( config_flags, rk_step,                           &amp;<a name='1075'>
                         ru_tend, rv_tend, rw_tend, ph_tend, t_tend,      &amp;<a name='1076'>
                         ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='1077'>
                         mu_tend, u_save, v_save, w_save, ph_save,        &amp;<a name='1078'>
                         t_save, mu_save, RTHFTEN,                        &amp;<a name='1079'>
                         ru, rv, rw, ww,                                  &amp;<a name='1080'>
                         u_2, v_2, w_2, t_2, ph_2,                        &amp;<a name='1081'>
                         u_1, v_1, w_1, t_1, ph_1,                        &amp;<a name='1082'>
                         h_diabatic, phb, t_init,                         &amp;<a name='1083'>
                         mu_2, mut, muu, muv, mub,                        &amp;<a name='1084'>
                         al, alt, p, pb, php, cqu, cqv, cqw,              &amp;<a name='1085'>
                         u_base, v_base, t_base, qv_base, z_base,         &amp;<a name='1086'>
                         msfu, msfv, msft, f, e, sina, cosa,              &amp;<a name='1087'>
                         fnm, fnp, rdn, rdnw,                             &amp;<a name='1088'>
                         dt, rdx, rdy, khdif, kvdif, xkmhd,               &amp;<a name='1089'>
                         cf1, cf2, cf3, cfn, cfn1, num_3d_m,              &amp;<a name='1090'>
                         non_hydrostatic, leapfrog,                       &amp;<a name='1091'>
                         ids, ide, jds, jde, kds, kde,                    &amp;<a name='1092'>
                         ims, ime, jms, jme, kms, kme,                    &amp;<a name='1093'>
                         grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1094'>
                         grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1095'>
                         k_start, k_end                                  )<a name='1096'>
<font color=#447700>!--------------------------------------------------------------------------<a name='1097'></font>
<font color=#447700>!Xiaoyan Zhang---  add vertical diffusion here 12/06/2006  !<a name='1098'></font>
<a name='1099'>
  IF (rk_step == 1 ) then<a name='1100'>
<a name='1101'>
<a name='1102'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SURFACE_DRAG'>surface_drag</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURFACE_DRAG_3"> (ru_tendf, rv_tendf, u_2, v_2, xland,             &amp;<a name='1103'>
                         muu, muv,z,z_at_w,&amp;<a name='1104'>
                         ids, ide, jds, jde, kds, kde,                    &amp;<a name='1105'>
                         ims, ime, jms, jme, kms, kme,                    &amp;<a name='1106'>
                         grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1107'>
                         grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1108'>
                         k_start, k_end                                  )<a name='1109'>
<a name='1110'>
  ENDIF<a name='1111'>
<a name='1112'>
<font color=#447700>!Xiaoyan Zhang--------------    End      ----------------------------------------<a name='1113'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='1114'></font>
<a name='1115'>
   END DO<a name='1116'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1117'></font>
BENCH_END(rk_tend_tim)<a name='1118'>
<a name='1119'>
BENCH_START(relax_bdy_dry_tim)<a name='1120'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1121'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='1122'></font>
   DO ij = 1 , grid%num_tiles<a name='1123'>
<a name='1124'>
     IF( (config_flags%specified .or. config_flags%nested) .and. rk_step == 1 ) THEN <a name='1125'>
<a name='1126'>
       CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_DRY'>relax_bdy_dry</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_DRY_3"> ( config_flags,                                &amp;<a name='1127'>
                            u_save, v_save, ph_save, t_save,             &amp;<a name='1128'>
                            w_save, mu_tend,                             &amp; <a name='1129'>
                            ru, rv, ph_2, t_2,                           &amp;<a name='1130'>
                            w_2, mu_2, mut,                              &amp;<a name='1131'>
                            u_b, v_b, ph_b, t_b, w_b,                    &amp;<a name='1132'>
                            mu_b,                                        &amp;<a name='1133'>
                            u_bt, v_bt, ph_bt, t_bt,                     &amp;<a name='1134'>
                            w_bt, mu_bt,                                 &amp;<a name='1135'>
                            spec_bdy_width, spec_zone, relax_zone,       &amp;<a name='1136'>
                            dtbc, fcx, gcx,             &amp;<a name='1137'>
                            ijds, ijde,                 &amp;<a name='1138'>
                            ids,ide, jds,jde, kds,kde,  &amp;<a name='1139'>
                            ims,ime, jms,jme, kms,kme,  &amp;<a name='1140'>
                            ips,ipe, jps,jpe, kps,kpe,  &amp;<a name='1141'>
                            grid%i_start(ij), grid%i_end(ij),            &amp;<a name='1142'>
                            grid%j_start(ij), grid%j_end(ij),            &amp;<a name='1143'>
                            k_start, k_end                              )<a name='1144'>
<a name='1145'>
<a name='1146'>
     ENDIF<a name='1147'>
<a name='1148'>
     CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_ADDTEND_DRY'>rk_addtend_dry</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_ADDTEND_DRY_3">( ru_tend,  rv_tend,  rw_tend,  ph_tend,  t_tend,  &amp;<a name='1149'>
                          ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='1150'>
                          u_save, v_save, w_save, ph_save, t_save, rk_step,&amp;<a name='1151'>
                          h_diabatic, mut, msft, msfu, msfv,               &amp;<a name='1152'>
                          ids,ide, jds,jde, kds,kde,                       &amp;<a name='1153'>
                          ims,ime, jms,jme, kms,kme,                       &amp;<a name='1154'>
                          ips,ipe, jps,jpe, kps,kpe,                       &amp;<a name='1155'>
                          grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1156'>
                          grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1157'>
                          k_start, k_end                                  )<a name='1158'>
<a name='1159'>
     IF( config_flags%specified .or. config_flags%nested ) THEN <a name='1160'>
       CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_DRY'>spec_bdy_dry</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_DRY_3"> ( config_flags,                                    &amp;<a name='1161'>
                           ru_tend, rv_tend, ph_tend, t_tend,               &amp;<a name='1162'>
                           rw_tend, mu_tend,                                &amp;<a name='1163'>
                           u_b, v_b, ph_b, t_b,                             &amp;<a name='1164'>
                           w_b, mu_b,                                       &amp;<a name='1165'>
                           u_bt, v_bt, ph_bt, t_bt,                         &amp;<a name='1166'>
                           w_bt, mu_bt,                                     &amp;<a name='1167'>
                           spec_bdy_width, spec_zone,                       &amp;<a name='1168'>
                           ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1169'></font>
                           ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1170'></font>
                           ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1171'></font>
                           ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1172'></font>
                           grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1173'>
                           grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1174'>
                           k_start, k_end                                  )<a name='1175'>
     <a name='1176'>
     ENDIF<a name='1177'>
<a name='1178'>
   END DO<a name='1179'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1180'></font>
BENCH_END(relax_bdy_dry_tim)<a name='1181'>
<a name='1182'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1183'></font>
<font color=#447700>!&lt;pre&gt;<a name='1184'></font>
<font color=#447700>! (3) Small (acoustic,sound) steps.<a name='1185'></font>
<font color=#447700>!<a name='1186'></font>
<font color=#447700>!    Several acoustic steps are taken each RK pass.  A small step <a name='1187'></font>
<font color=#447700>!    sequence begins with calculating perturbation variables <a name='1188'></font>
<font color=#447700>!    and coupling them to the column dry-air-mass mu <a name='1189'></font>
<font color=#447700>!    (call to small_step_prep).  This is followed by computing<a name='1190'></font>
<font color=#447700>!    coefficients for the vertically implicit part of the<a name='1191'></font>
<font color=#447700>!    small timestep (call to calc_coef_w).  <a name='1192'></font>
<font color=#447700>!<a name='1193'></font>
<font color=#447700>!    The small steps are taken<a name='1194'></font>
<font color=#447700>!    in the named loop "small_steps:".  In the small_steps loop, first <a name='1195'></font>
<font color=#447700>!    the horizontal momentum (u and v) are advanced (call to advance_uv),<a name='1196'></font>
<font color=#447700>!    next mu and theta are advanced (call to advance_mu_t) followed by<a name='1197'></font>
<font color=#447700>!    advancing w and the geopotential (call to advance_w).  Diagnostic<a name='1198'></font>
<font color=#447700>!    values for pressure and inverse density are updated at the end of<a name='1199'></font>
<font color=#447700>!    each small_step.<a name='1200'></font>
<font color=#447700>!<a name='1201'></font>
<font color=#447700>!    The small-step section ends with the change of the perturbation variables<a name='1202'></font>
<font color=#447700>!    back to full variables (call to small_step_finish).<a name='1203'></font>
<font color=#447700>!&lt;/pre&gt;<a name='1204'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1205'></font>
<a name='1206'>
BENCH_START(small_step_prep_tim)<a name='1207'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1208'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='1209'></font>
<a name='1210'>
   DO ij = 1 , grid%num_tiles<a name='1211'>
<a name='1212'>
    <font color=#447700>! Calculate coefficients for the vertically implicit acoustic/gravity wave<a name='1213'></font>
    <font color=#447700>! integration.  We only need calculate these for the first pass through -<a name='1214'></font>
    <font color=#447700>! the predictor step.  They are reused as is for the corrector step.<a name='1215'></font>
    <font color=#447700>! For third-order RK, we need to recompute these after the first <a name='1216'></font>
    <font color=#447700>! predictor because we may have changed the small timestep -&gt; dts.<a name='1217'></font>
<a name='1218'>
      CALL wrf_debug ( 200 , ' call calc_coef_w' )<a name='1219'>
<a name='1220'>
      CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_PREP'>small_step_prep</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMALL_STEP_PREP_3">( u_1,u_2,v_1,v_2,w_1,w_2,          &amp;<a name='1221'>
                            t_1,t_2,ph_1,ph_2,                &amp;<a name='1222'>
                            mub, mu_1, mu_2,                  &amp;<a name='1223'>
                            muu, muus, muv, muvs,             &amp;<a name='1224'>
                            mut, muts, mudf,                  &amp; <a name='1225'>
                            u_save, v_save, w_save,           &amp; <a name='1226'>
                            t_save, ph_save, mu_save,         &amp;<a name='1227'>
                            ww, ww1,                          &amp;<a name='1228'>
                            dnw, c2a, pb, p, alt,             &amp;<a name='1229'>
                            msfu, msfv, msft,                 &amp;<a name='1230'>
                            rk_step, leapfrog,                &amp;<a name='1231'>
                            ids, ide, jds, jde, kds, kde,     &amp;<a name='1232'>
                            ims, ime, jms, jme, kms, kme,     &amp;<a name='1233'>
                            grid%i_start(ij), grid%i_end(ij), &amp;<a name='1234'>
                            grid%j_start(ij), grid%j_end(ij), &amp;<a name='1235'>
                            k_start    , k_end               )<a name='1236'>
      CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_P_RHO'>calc_p_rho</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_3">( al, p, ph_2,                      &amp;<a name='1237'>
                       alt, t_2, t_save, c2a, pm1,       &amp;<a name='1238'>
                       mu_2, muts, znu, t0,              &amp;<a name='1239'>
                       rdnw, dnw, smdiv,                 &amp;<a name='1240'>
                       non_hydrostatic, 0,               &amp;<a name='1241'>
                       ids, ide, jds, jde, kds, kde,     &amp;<a name='1242'>
                       ims, ime, jms, jme, kms, kme,     &amp;<a name='1243'>
                       grid%i_start(ij), grid%i_end(ij), &amp;<a name='1244'>
                       grid%j_start(ij), grid%j_end(ij), &amp;<a name='1245'>
                       k_start    , k_end               )<a name='1246'>
<a name='1247'>
      IF (non_hydrostatic)                                &amp;<a name='1248'>
      CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_COEF_W'>calc_coef_w</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_COEF_W_3">( a,alpha,gamma,                    &amp;<a name='1249'>
                        mut, cqw,                         &amp;<a name='1250'>
                        rdn, rdnw, c2a,                   &amp;<a name='1251'>
                        dts_rk, g, epssm,                 &amp;<a name='1252'>
                        ids, ide, jds, jde, kds, kde,     &amp;<a name='1253'>
                        ims, ime, jms, jme, kms, kme,     &amp;<a name='1254'>
                        grid%i_start(ij), grid%i_end(ij), &amp;<a name='1255'>
                        grid%j_start(ij), grid%j_end(ij), &amp;<a name='1256'>
                        k_start    , k_end               )<a name='1257'>
<a name='1258'>
<a name='1259'>
   ENDDO<a name='1260'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1261'></font>
BENCH_END(small_step_prep_tim)<a name='1262'>
<a name='1263'>
<a name='1264'>
#ifdef DM_PARALLEL<a name='1265'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1266'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='1267'></font>
<font color=#447700>!  Note:  the small size of this halo exchange reflects the <a name='1268'></font>
<font color=#447700>!         fact that we are carrying the uncoupled variables <a name='1269'></font>
<font color=#447700>!         as state variables in the mass coordinate model, as<a name='1270'></font>
<font color=#447700>!         opposed to the coupled variables as in the height<a name='1271'></font>
<font color=#447700>!         coordinate model.<a name='1272'></font>
<font color=#447700>!<a name='1273'></font>
<font color=#447700>!                              * * * * *<a name='1274'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='1275'></font>
<font color=#447700>!          * + *      * + *    * * + * * <a name='1276'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='1277'></font>
<font color=#447700>!                              * * * * *<a name='1278'></font>
<font color=#447700>!<a name='1279'></font>
<font color=#447700>!  3D variables - note staggering!  ph_2(Z), u_save(X), v_save(Y)<a name='1280'></font>
<font color=#447700>!<a name='1281'></font>
<font color=#447700>!j ph_2      x<a name='1282'></font>
<font color=#447700>!j al        x<a name='1283'></font>
<font color=#447700>!j p         x<a name='1284'></font>
<font color=#447700>!j t_1       x<a name='1285'></font>
<font color=#447700>!j t_save    x<a name='1286'></font>
<font color=#447700>!j u_save    x<a name='1287'></font>
<font color=#447700>!j v_save    x<a name='1288'></font>
<font color=#447700>!<a name='1289'></font>
<font color=#447700>!  the following are 2D (xy) variables<a name='1290'></font>
<font color=#447700>!<a name='1291'></font>
<font color=#447700>!j mu_1      x<a name='1292'></font>
<font color=#447700>!j mu_2      x<a name='1293'></font>
<font color=#447700>!j mudf      x<a name='1294'></font>
<font color=#447700>!--------------------------------------------------------------<a name='1295'></font>
#      include "<A href='../../html_code/include/HALO_EM_B.inc.html'>HALO_EM_B.inc</A>"<A NAME="HALO_EM_B.inc_24"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1296'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_B.inc.html'>PERIOD_BDY_EM_B.inc</A>"<A NAME="PERIOD_BDY_EM_B.inc_25"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1297'>
#endif<a name='1298'>
<a name='1299'>
BENCH_START(set_phys_bc2_tim)<a name='1300'>
   if(dyn_opt == DYN_EM) then<a name='1301'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1302'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='1303'></font>
<a name='1304'>
   DO ij = 1 , grid%num_tiles<a name='1305'>
<a name='1306'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_76">( ru_tend, 'u', config_flags,          &amp;<a name='1307'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1308'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1309'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1310'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1311'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1312'>
                           k_start    , k_end                     )<a name='1313'>
<a name='1314'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_77">( rv_tend, 'v', config_flags,            &amp;<a name='1315'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1316'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1317'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1318'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1319'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1320'>
                           k_start    , k_end                     )<a name='1321'>
<a name='1322'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_78">( ph_2, 'w', config_flags,          &amp;<a name='1323'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1324'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1325'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1326'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1327'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1328'>
                           k_start    , k_end                     )<a name='1329'>
<a name='1330'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_79">( al, 'p', config_flags,            &amp;<a name='1331'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1332'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1333'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1334'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1335'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1336'>
                           k_start    , k_end                     )<a name='1337'>
<a name='1338'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_80">( p, 'p', config_flags,             &amp;<a name='1339'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1340'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1341'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1342'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1343'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1344'>
                           k_start    , k_end                     )<a name='1345'>
<a name='1346'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_81">( t_1, 'p', config_flags,             &amp;<a name='1347'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1348'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1349'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1350'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1351'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1352'>
                           k_start    , k_end                     )<a name='1353'>
<a name='1354'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_82">( t_save, 't', config_flags,             &amp;<a name='1355'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='1356'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1357'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1358'>
                           grid%i_start(ij), grid%i_end(ij),                 &amp;<a name='1359'>
                           grid%j_start(ij), grid%j_end(ij),                 &amp;<a name='1360'>
                           k_start    , k_end                     )<a name='1361'>
<a name='1362'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_10">( mu_1, 't', config_flags,          &amp;<a name='1363'>
                                 ids, ide, jds, jde,               &amp;<a name='1364'>
                                 ims, ime, jms, jme,               &amp;<a name='1365'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1366'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1367'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1368'>
<a name='1369'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_11">( mu_2, 't', config_flags,          &amp;<a name='1370'>
                                 ids, ide, jds, jde,               &amp;<a name='1371'>
                                 ims, ime, jms, jme,               &amp;<a name='1372'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1373'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1374'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1375'>
<a name='1376'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_12">( mudf, 't', config_flags,          &amp;<a name='1377'>
                                 ids, ide, jds, jde,               &amp;<a name='1378'>
                                 ims, ime, jms, jme,               &amp;<a name='1379'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1380'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1381'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1382'>
<a name='1383'>
    END DO<a name='1384'>
    <font color=#447700>!$OMP END PARALLEL DO<a name='1385'></font>
    endif<a name='1386'>
BENCH_END(set_phys_bc2_tim)<a name='1387'>
<a name='1388'>
   small_steps : DO iteration = 1 , number_of_small_timesteps<a name='1389'>
<a name='1390'>
   <font color=#447700>! Boundary condition time (or communication time).  <a name='1391'></font>
<a name='1392'>
#ifdef DM_PARALLEL<a name='1393'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_B.inc.html'>PERIOD_BDY_EM_B.inc</A>"<A NAME="PERIOD_BDY_EM_B.inc_26"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1394'>
#endif<a name='1395'>
<a name='1396'>
<a name='1397'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1398'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='1399'></font>
<a name='1400'>
      DO ij = 1 , grid%num_tiles<a name='1401'>
<a name='1402'>
BENCH_START(advance_uv_tim)<a name='1403'>
         CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_UV'>advance_uv</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_UV_3"> ( u_2, ru_tend, v_2, rv_tend,       &amp;<a name='1404'>
                           p, pb,                            &amp;<a name='1405'>
                           ph_2, php, alt, al, mu_2,         &amp;<a name='1406'>
                           muu, cqu, muv, cqv, mudf,         &amp;<a name='1407'>
                           rdx, rdy, dts_rk,                 &amp;<a name='1408'>
                           cf1, cf2, cf3, fnm, fnp,          &amp;<a name='1409'>
                           emdiv,                            &amp;<a name='1410'>
                           rdnw, config_flags,spec_zone,     &amp;<a name='1411'>
                           non_hydrostatic,                  &amp;<a name='1412'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='1413'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='1414'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='1415'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='1416'>
                           k_start    , k_end               )<a name='1417'>
BENCH_END(advance_uv_tim)<a name='1418'>
<a name='1419'>
BENCH_START(spec_bdy_uv_tim)<a name='1420'>
         IF( config_flags%specified .or. config_flags%nested ) THEN<a name='1421'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_3">(u_2, ru_tend, dts_rk,      &amp;<a name='1422'>
                               'u'         , config_flags, &amp;<a name='1423'>
                               spec_zone,                  &amp;<a name='1424'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1425'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1426'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1427'></font>
                               grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1428'>
                               grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1429'>
                               k_start    , k_end             )<a name='1430'>
<a name='1431'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_4">(v_2, rv_tend, dts_rk,      &amp;<a name='1432'>
                               'v'         , config_flags, &amp;<a name='1433'>
                               spec_zone,                  &amp;<a name='1434'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1435'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1436'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1437'></font>
                               grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1438'>
                               grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1439'>
                               k_start    , k_end             )<a name='1440'>
<a name='1441'>
         ENDIF<a name='1442'>
BENCH_END(spec_bdy_uv_tim)<a name='1443'>
<a name='1444'>
      END DO<a name='1445'>
      <font color=#447700>!$OMP END PARALLEL DO<a name='1446'></font>
<a name='1447'>
#ifdef DM_PARALLEL<a name='1448'>
<font color=#447700>!<a name='1449'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='1450'></font>
<font color=#447700>!<a name='1451'></font>
<font color=#447700>!         *                     *<a name='1452'></font>
<font color=#447700>!       * + *      * + *        +<a name='1453'></font>
<font color=#447700>!         *                     *<a name='1454'></font>
<font color=#447700>!<a name='1455'></font>
<font color=#447700>!  u_2               x<a name='1456'></font>
<font color=#447700>!  v_2                          x<a name='1457'></font>
<font color=#447700>!<a name='1458'></font>
#     include "<A href='../../html_code/include/HALO_EM_C.inc.html'>HALO_EM_C.inc</A>"<A NAME="HALO_EM_C.inc_27"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1459'>
#endif<a name='1460'>
<a name='1461'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1462'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='1463'></font>
<a name='1464'>
      DO ij = 1 , grid%num_tiles<a name='1465'>
<a name='1466'>
        <font color=#447700>!  advance the mass in the column, theta, and calculate ww<a name='1467'></font>
<a name='1468'>
BENCH_START(advance_mu_t_tim)<a name='1469'>
        CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_MU_T'>advance_mu_t</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_MU_T_3">( ww, ww1, u_2, u_save, v_2, v_save, &amp;<a name='1470'>
                           mu_2, mut, muave, muts, muu, muv,  &amp;<a name='1471'>
                           mudf, ru_m, rv_m, ww_m,            &amp;<a name='1472'>
                           t_2, t_save, t_2save, t_tend,      &amp;<a name='1473'>
                           mu_tend,                           &amp;<a name='1474'>
                           rdx, rdy, dts_rk, epssm,           &amp;<a name='1475'>
                           dnw, fnm, fnp, rdnw,               &amp;<a name='1476'>
                           msfu, msfv, msft,                  &amp;<a name='1477'>
                           iteration, config_flags,           &amp;<a name='1478'>
                           ids, ide, jds, jde, kds, kde,      &amp;<a name='1479'>
                           ims, ime, jms, jme, kms, kme,      &amp;<a name='1480'>
                           grid%i_start(ij), grid%i_end(ij),  &amp;<a name='1481'>
                           grid%j_start(ij), grid%j_end(ij),  &amp;<a name='1482'>
                           k_start    , k_end                )<a name='1483'>
BENCH_END(advance_mu_t_tim)<a name='1484'>
<a name='1485'>
BENCH_START(spec_bdy_t_tim)<a name='1486'>
         IF( config_flags%specified .or. config_flags%nested ) THEN<a name='1487'>
<a name='1488'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_5">(t_2, t_tend, dts_rk,      &amp;<a name='1489'>
                               't'         , config_flags, &amp;<a name='1490'>
                               spec_zone,                  &amp;<a name='1491'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1492'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1493'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1494'></font>
                               grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1495'>
                               grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1496'>
                               k_start    , k_end             )<a name='1497'>
<a name='1498'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_6">(mu_2, mu_tend, dts_rk,      &amp;<a name='1499'>
                               'm'         , config_flags, &amp;<a name='1500'>
                               spec_zone,                  &amp;<a name='1501'>
                               ids,ide, jds,jde, 1  ,1  ,  &amp; <font color=#447700>! domain dims<a name='1502'></font>
                               ims,ime, jms,jme, 1  ,1  ,  &amp; <font color=#447700>! memory dims<a name='1503'></font>
                               ips,ipe, jps,jpe, 1  ,1  ,  &amp; <font color=#447700>! patch  dims<a name='1504'></font>
                               grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1505'>
                               grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1506'>
                               1    , 1             )<a name='1507'>
<a name='1508'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_7">(muts, mu_tend, dts_rk,      &amp;<a name='1509'>
                               'm'         , config_flags, &amp;<a name='1510'>
                               spec_zone,                  &amp;<a name='1511'>
                               ids,ide, jds,jde, 1  ,1  ,  &amp; <font color=#447700>! domain dims<a name='1512'></font>
                               ims,ime, jms,jme, 1  ,1  ,  &amp; <font color=#447700>! memory dims<a name='1513'></font>
                               ips,ipe, jps,jpe, 1  ,1  ,  &amp; <font color=#447700>! patch  dims<a name='1514'></font>
                               grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1515'>
                               grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1516'>
                               1    , 1             )<a name='1517'>
         ENDIF<a name='1518'>
BENCH_END(spec_bdy_t_tim)<a name='1519'>
<a name='1520'>
         <font color=#447700>! sumflux accumulates the time-averged mass flux<a name='1521'></font>
         <font color=#447700>! (time averaged over the acoustic steps) for use<a name='1522'></font>
         <font color=#447700>! in the scalar advection (flux divergence).  Using<a name='1523'></font>
         <font color=#447700>! time averaged values gives us exact scalar conservation.<a name='1524'></font>
<a name='1525'>
BENCH_START(sumflux_tim)<a name='1526'>
         CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SUMFLUX'>sumflux</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUMFLUX_3"> ( u_2, v_2, ww,                         &amp;<a name='1527'>
                        u_save, v_save, ww1,                  &amp;<a name='1528'>
                        muu, muv,                             &amp;<a name='1529'>
                        ru_m, rv_m, ww_m, epssm,              &amp;<a name='1530'>
                        msfu, msfv,                           &amp;<a name='1531'>
                        iteration, number_of_small_timesteps, &amp;<a name='1532'>
                        ids, ide, jds, jde, kds, kde,         &amp;<a name='1533'>
                        ims, ime, jms, jme, kms, kme,         &amp;<a name='1534'>
                        grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1535'>
                        grid%j_start(ij), grid%j_end(ij),     &amp;<a name='1536'>
                        k_start    , k_end                   )<a name='1537'>
BENCH_END(sumflux_tim)<a name='1538'>
<a name='1539'>
         <font color=#447700>! small (acoustic) step for the vertical momentum,<a name='1540'></font>
         <font color=#447700>! density and coupled potential temperature.<a name='1541'></font>
<a name='1542'>
<a name='1543'>
BENCH_START(advance_w_tim)<a name='1544'>
        IF ( non_hydrostatic ) THEN<a name='1545'>
          CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_W'>advance_w</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_W_3">( w_2, rw_tend, ww, u_2, v_2,       &amp;<a name='1546'>
                          mu_2, mut, muave, muts,           &amp;<a name='1547'>
                          t_2save, t_2, t_save,             &amp;<a name='1548'>
                          ph_2, ph_save, phb, ph_tend,      &amp;<a name='1549'>
                          ht, c2a, cqw, alt, alb,           &amp;<a name='1550'>
                          a, alpha, gamma,                  &amp;<a name='1551'>
                          rdx, rdy, dts_rk, t0, epssm,      &amp;<a name='1552'>
                          dnw, fnm, fnp, rdnw, rdn,         &amp;<a name='1553'>
                          cf1, cf2, cf3, msft,              &amp;<a name='1554'>
                          config_flags,                     &amp;<a name='1555'>
                          ids,ide, jds,jde, kds,kde,        &amp; <font color=#447700>! domain dims<a name='1556'></font>
                          ims,ime, jms,jme, kms,kme,        &amp; <font color=#447700>! memory dims<a name='1557'></font>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='1558'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='1559'>
                          k_start    , k_end               )<a name='1560'>
        ENDIF<a name='1561'>
BENCH_END(advance_w_tim)<a name='1562'>
<a name='1563'>
        IF( config_flags%specified .or. config_flags%nested ) THEN<a name='1564'>
<a name='1565'>
BENCH_START(spec_bdynhyd_tim)<a name='1566'>
           IF (non_hydrostatic)  THEN<a name='1567'>
             CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDYUPDATE_PH'>spec_bdyupdate_ph</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_PH_3">( ph_save, ph_2, ph_tend, mu_tend, muts, dts_rk, &amp;<a name='1568'>
                                     'h'         , config_flags, &amp;<a name='1569'>
                                     spec_zone,                  &amp;<a name='1570'>
                                     ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1571'></font>
                                     ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1572'></font>
                                     ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1573'></font>
                                     grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1574'>
                                     grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1575'>
                                     k_start    , k_end             )<a name='1576'>
             IF( config_flags%specified ) THEN<a name='1577'>
               CALL <A href='../../html_code/share/module_bc.F.html#ZERO_GRAD_BDY'>zero_grad_bdy</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_GRAD_BDY_1"> ( w_2,                        &amp;<a name='1578'>
                                    'w'         , config_flags, &amp;<a name='1579'>
                                    spec_zone,                  &amp;<a name='1580'>
                                    ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1581'></font>
                                    ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1582'></font>
                                    ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1583'></font>
                                    grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1584'>
                                    grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1585'>
                                    k_start    , k_end             )<a name='1586'>
             ELSE<a name='1587'>
               CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_8">   ( w_2, rw_tend, dts_rk,       &amp;<a name='1588'>
                                       'h'         , config_flags, &amp;<a name='1589'>
                                       spec_zone,                  &amp;<a name='1590'>
                                       ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1591'></font>
                                       ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1592'></font>
                                       ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1593'></font>
                                       grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1594'>
                                       grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1595'>
                                       k_start    , k_end             )<a name='1596'>
             ENDIF<a name='1597'>
          ENDIF<a name='1598'>
BENCH_END(spec_bdynhyd_tim)<a name='1599'>
        ENDIF<a name='1600'>
<a name='1601'>
BENCH_START(cald_p_rho_tim)<a name='1602'>
        CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_P_RHO'>calc_p_rho</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_4">( al, p, ph_2,                      &amp;<a name='1603'>
                         alt, t_2, t_save, c2a, pm1,       &amp;<a name='1604'>
                         mu_2, muts, znu, t0,              &amp;<a name='1605'>
                         rdnw, dnw, smdiv,                 &amp;<a name='1606'>
                         non_hydrostatic, iteration,       &amp;<a name='1607'>
                         ids, ide, jds, jde, kds, kde,     &amp;<a name='1608'>
                         ims, ime, jms, jme, kms, kme,     &amp;<a name='1609'>
                         grid%i_start(ij), grid%i_end(ij), &amp;<a name='1610'>
                         grid%j_start(ij), grid%j_end(ij), &amp;<a name='1611'>
                         k_start    , k_end               )<a name='1612'>
BENCH_END(cald_p_rho_tim)<a name='1613'>
<a name='1614'>
   ENDDO<a name='1615'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1616'></font>
<a name='1617'>
#ifdef DM_PARALLEL<a name='1618'>
<font color=#447700>!<a name='1619'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='1620'></font>
<font color=#447700>!<a name='1621'></font>
<font color=#447700>!         *                     *<a name='1622'></font>
<font color=#447700>!       * + *      * + *        +<a name='1623'></font>
<font color=#447700>!         *                     *<a name='1624'></font>
<font color=#447700>!<a name='1625'></font>
<font color=#447700>!  ph_2   x<a name='1626'></font>
<font color=#447700>!  al     x<a name='1627'></font>
<font color=#447700>!  p      x<a name='1628'></font>
<font color=#447700>!<a name='1629'></font>
<font color=#447700>!  2D variables (x,y)<a name='1630'></font>
<font color=#447700>!<a name='1631'></font>
<font color=#447700>!  mu_2   x<a name='1632'></font>
<font color=#447700>!  muts   x<a name='1633'></font>
<font color=#447700>!  mudf   x<a name='1634'></font>
<a name='1635'>
#      include "<A href='../../html_code/include/HALO_EM_C2.inc.html'>HALO_EM_C2.inc</A>"<A NAME="HALO_EM_C2.inc_28"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1636'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_B3.inc.html'>PERIOD_BDY_EM_B3.inc</A>"<A NAME="PERIOD_BDY_EM_B3.inc_29"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1637'>
#endif<a name='1638'>
<a name='1639'>
BENCH_START(phys_bc_tim)<a name='1640'>
      if(dyn_opt == DYN_EM) then<a name='1641'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1642'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='1643'></font>
<a name='1644'>
      DO ij = 1 , grid%num_tiles<a name='1645'>
<a name='1646'>
        <font color=#447700>! boundary condition set for next small timestep<a name='1647'></font>
<a name='1648'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_83">( ph_2, 'w', config_flags,          &amp;<a name='1649'>
                                 ids, ide, jds, jde, kds, kde,     &amp;<a name='1650'>
                                 ims, ime, jms, jme, kms, kme,     &amp;<a name='1651'>
                                 ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='1652'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1653'>
                                 grid%j_start(ij), grid%j_end(ij), &amp;<a name='1654'>
                                 k_start    , k_end               )<a name='1655'>
<a name='1656'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_84">( al, 'p', config_flags,            &amp;<a name='1657'>
                                 ids, ide, jds, jde, kds, kde,     &amp;<a name='1658'>
                                 ims, ime, jms, jme, kms, kme,     &amp;<a name='1659'>
                                 ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='1660'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1661'>
                                 grid%j_start(ij), grid%j_end(ij), &amp;<a name='1662'>
                                 k_start    , k_end               )<a name='1663'>
<a name='1664'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_85">( p, 'p', config_flags,             &amp;<a name='1665'>
                                 ids, ide, jds, jde, kds, kde,     &amp;<a name='1666'>
                                 ims, ime, jms, jme, kms, kme,     &amp;<a name='1667'>
                                 ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='1668'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1669'>
                                 grid%j_start(ij), grid%j_end(ij), &amp;<a name='1670'>
                                 k_start    , k_end               )<a name='1671'>
<a name='1672'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_13">( muts, 't', config_flags,          &amp;<a name='1673'>
                                 ids, ide, jds, jde,               &amp;<a name='1674'>
                                 ims, ime, jms, jme,               &amp;<a name='1675'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1676'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1677'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1678'>
<a name='1679'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_14">( mu_2, 't', config_flags,          &amp;<a name='1680'>
                                 ids, ide, jds, jde,               &amp;<a name='1681'>
                                 ims, ime, jms, jme,               &amp;<a name='1682'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1683'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1684'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1685'>
<a name='1686'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_15">( mudf, 't', config_flags,          &amp;<a name='1687'>
                                 ids, ide, jds, jde,               &amp;<a name='1688'>
                                 ims, ime, jms, jme,               &amp;<a name='1689'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1690'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1691'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1692'>
<a name='1693'>
      END DO<a name='1694'>
      <font color=#447700>!$OMP END PARALLEL DO<a name='1695'></font>
      endif<a name='1696'>
BENCH_END(phys_bc_tim)<a name='1697'>
<a name='1698'>
   END DO small_steps<a name='1699'>
<a name='1700'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1701'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='1702'></font>
<a name='1703'>
   DO ij = 1 , grid%num_tiles<a name='1704'>
<a name='1705'>
      CALL wrf_debug ( 200 , ' call rk_small_finish' )<a name='1706'>
<a name='1707'>
      <font color=#447700>! change time-perturbation variables back to <a name='1708'></font>
      <font color=#447700>! full perturbation variables.<a name='1709'></font>
      <font color=#447700>! first get updated mu at u and v points<a name='1710'></font>
<a name='1711'>
BENCH_START(calc_mu_uv_tim)<a name='1712'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_UV_1'>calc_mu_uv_1</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_MU_UV_1_3"> ( config_flags,                     &amp;<a name='1713'>
                          muts, muus, muvs,                 &amp;<a name='1714'>
                          ids, ide, jds, jde, kds, kde,     &amp;<a name='1715'>
                          ims, ime, jms, jme, kms, kme,     &amp;<a name='1716'>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='1717'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='1718'>
                          k_start    , k_end               )<a name='1719'>
BENCH_END(calc_mu_uv_tim)<a name='1720'>
BENCH_START(small_step_finish_tim)<a name='1721'>
      CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_FINISH'>small_step_finish</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMALL_STEP_FINISH_3">( u_2, u_1, v_2, v_1, w_2, w_1,     &amp;<a name='1722'>
                              t_2, t_1, ph_2, ph_1, ww, ww1,    &amp;<a name='1723'>
                              mu_2, mu_1,                       &amp;<a name='1724'>
                              mut, muts, muu, muus, muv, muvs,  &amp; <a name='1725'>
                              u_save, v_save, w_save,           &amp;<a name='1726'>
                              t_save, ph_save, mu_save,         &amp;<a name='1727'>
                              msfu, msfv, msft,                 &amp;<a name='1728'>
                              h_diabatic,                       &amp;<a name='1729'>
                              number_of_small_timesteps,dts_rk, &amp;<a name='1730'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='1731'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='1732'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='1733'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='1734'>
                              k_start    , k_end               )<a name='1735'>
BENCH_END(small_step_finish_tim)<a name='1736'>
<a name='1737'>
   END DO<a name='1738'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1739'></font>
<a name='1740'>
#ifdef DM_PARALLEL<a name='1741'>
<font color=#447700>!<a name='1742'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='1743'></font>
<font color=#447700>!<a name='1744'></font>
<font color=#447700>!<a name='1745'></font>
<font color=#447700>! ru_m      x<a name='1746'></font>
<font color=#447700>! rv_m      x<a name='1747'></font>
<font color=#447700>!<a name='1748'></font>
<font color=#447700>!--------------------------------------------------------------<a name='1749'></font>
<a name='1750'>
#  include "<A href='../../html_code/include/HALO_EM_D.inc.html'>HALO_EM_D.inc</A>"<A NAME="HALO_EM_D.inc_30"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1751'>
#endif<a name='1752'>
<a name='1753'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1754'></font>
<font color=#447700>!&lt;pre&gt;<a name='1755'></font>
<font color=#447700>! (4) Still within the RK loop, the scalar variables are advanced.<a name='1756'></font>
<font color=#447700>!<a name='1757'></font>
<font color=#447700>!    For the moist and chem variables, each one is advanced<a name='1758'></font>
<font color=#447700>!    individually, using named loops "moist_variable_loop:"<a name='1759'></font>
<font color=#447700>!    and "chem_variable_loop:".  Each RK substep begins by<a name='1760'></font>
<font color=#447700>!    calculating the advective tendency, and, for the first RK step, <a name='1761'></font>
<font color=#447700>!    3D mixing (calling rk_scalar_tend) followed by an update<a name='1762'></font>
<font color=#447700>!    of the scalar (calling rk_scalar_update).<a name='1763'></font>
<font color=#447700>!&lt;/pre&gt;<a name='1764'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1765'></font>
<a name='1766'>
<a name='1767'>
  moist_scalar_advance: IF (num_3d_m &gt;= PARAM_FIRST_SCALAR )  THEN<a name='1768'>
<a name='1769'>
   moist_variable_loop: do im = PARAM_FIRST_SCALAR, num_3d_m<a name='1770'>
<a name='1771'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1772'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='1773'></font>
<a name='1774'>
   moist_tile_loop_1: DO ij = 1 , grid%num_tiles<a name='1775'>
<a name='1776'>
       CALL wrf_debug ( 200 , ' call rk_scalar_tend' )<a name='1777'>
<a name='1778'>
BENCH_START(rk_scalar_tend_tim)<a name='1779'>
       CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_3"> (  im, im, config_flags,             &amp;<a name='1780'>
                              rk_step, dt_rk,                   &amp;<a name='1781'>
                              ru_m, rv_m, ww_m,                 &amp;<a name='1782'>
                              mut, alt,                         &amp;<a name='1783'>
                              moist_1(ims,kms,jms,im),          &amp;<a name='1784'>
                              moist_2(ims,kms,jms,im),          &amp;<a name='1785'>
                              moist_tend(ims,kms,jms,im),       &amp;<a name='1786'>
                              advect_tend,RQVFTEN,              &amp;<a name='1787'>
                              qv_base, .true., fnm, fnp,        &amp;<a name='1788'>
                              msfu, msfv, msft,                 &amp;<a name='1789'>
                              rdx, rdy, rdn, rdnw, khdif,       &amp;<a name='1790'>
                              kvdif, xkmhd,                     &amp;<a name='1791'>
                              leapfrog,                         &amp;<a name='1792'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='1793'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='1794'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='1795'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='1796'>
                              k_start    , k_end               )<a name='1797'>
BENCH_END(rk_scalar_tend_tim)<a name='1798'>
<a name='1799'>
BENCH_START(rlx_bdy_scalar_tim)<a name='1800'>
     IF( (config_flags%specified .or. config_flags%nested) .and. rk_step == 1 ) THEN <a name='1801'>
<a name='1802'>
       IF(im .eq. P_QV)THEN<a name='1803'>
<a name='1804'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_1"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='1805'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='1806'>
                                 rqv_b, rqv_bt,                         &amp;<a name='1807'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='1808'>
                                 dtbc, fcx, gcx,             &amp;<a name='1809'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1810'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1811'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1812'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1813'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='1814'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='1815'>
                                 k_start, k_end                        )<a name='1816'>
<a name='1817'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_3">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='1818'>
                                 rqv_b, rqv_bt,                             &amp;<a name='1819'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='1820'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1821'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1822'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1823'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1824'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='1825'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='1826'>
                                 k_start, k_end                               )<a name='1827'>
       ENDIF<a name='1828'>
<a name='1829'>
     ENDIF<a name='1830'>
<a name='1831'>
<font color=#447700>!  ugly code for nested b.c for moist scalars other than qv<a name='1832'></font>
<a name='1833'>
     IF( config_flags%nested .and. (rk_step == 1) ) THEN <a name='1834'>
<a name='1835'>
       IF (im .eq. P_QC) THEN<a name='1836'>
<a name='1837'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_2"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='1838'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='1839'>
                                 rqc_b, rqc_bt,                         &amp;<a name='1840'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='1841'>
                                 dtbc, fcx, gcx,             &amp;<a name='1842'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1843'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1844'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1845'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1846'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='1847'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='1848'>
                                 k_start, k_end                        )<a name='1849'>
<a name='1850'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_4">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='1851'>
                                 rqc_b, rqc_bt,                             &amp;<a name='1852'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='1853'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1854'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1855'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1856'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1857'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='1858'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='1859'>
                                 k_start, k_end                               )<a name='1860'>
<a name='1861'>
       ELSE IF (im .eq. P_QR) THEN<a name='1862'>
<a name='1863'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_3"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='1864'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='1865'>
                                 rqr_b, rqr_bt,                         &amp;<a name='1866'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='1867'>
                                 dtbc, fcx, gcx,             &amp;<a name='1868'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1869'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1870'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1871'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1872'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='1873'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='1874'>
                                 k_start, k_end                        )<a name='1875'>
<a name='1876'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_5">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='1877'>
                                 rqr_b, rqr_bt,                             &amp;<a name='1878'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='1879'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1880'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1881'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1882'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1883'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='1884'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='1885'>
                                 k_start, k_end                               )<a name='1886'>
<a name='1887'>
       ELSE IF (im .eq. P_QI) THEN<a name='1888'>
<a name='1889'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_4"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='1890'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='1891'>
                                 rqi_b, rqi_bt,                         &amp;<a name='1892'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='1893'>
                                 dtbc, fcx, gcx,             &amp;<a name='1894'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1895'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1896'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1897'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1898'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='1899'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='1900'>
                                 k_start, k_end                        )<a name='1901'>
<a name='1902'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_6">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='1903'>
                                 rqi_b, rqi_bt,                             &amp;<a name='1904'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='1905'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1906'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1907'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1908'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1909'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='1910'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='1911'>
                                 k_start, k_end                               )<a name='1912'>
<a name='1913'>
       ELSE IF (im .eq. P_QS) THEN<a name='1914'>
<a name='1915'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_5"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='1916'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='1917'>
                                 rqs_b, rqs_bt,                         &amp;<a name='1918'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='1919'>
                                 dtbc, fcx, gcx,             &amp;<a name='1920'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1921'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1922'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1923'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1924'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='1925'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='1926'>
                                 k_start, k_end                        )<a name='1927'>
<a name='1928'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_7">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='1929'>
                                 rqs_b, rqs_bt,                             &amp;<a name='1930'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='1931'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1932'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1933'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1934'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1935'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='1936'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='1937'>
                                 k_start, k_end                               )<a name='1938'>
       ELSE IF (im .eq. P_QG) THEN<a name='1939'>
<a name='1940'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_6"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='1941'>
                                 moist_2(ims,kms,jms,im),  mut,         &amp;<a name='1942'>
                                 rqg_b, rqg_bt,                         &amp;<a name='1943'>
                                 spec_bdy_width, spec_zone, relax_zone, &amp;<a name='1944'>
                                 dtbc, fcx, gcx,             &amp;<a name='1945'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1946'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1947'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1948'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1949'></font>
                                 grid%i_start(ij), grid%i_end(ij),      &amp;<a name='1950'>
                                 grid%j_start(ij), grid%j_end(ij),      &amp;<a name='1951'>
                                 k_start, k_end                        )<a name='1952'>
<a name='1953'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_8">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='1954'>
                                 rqg_b, rqg_bt,                             &amp;<a name='1955'>
                                 spec_bdy_width, spec_zone,                 &amp;<a name='1956'>
                                 ijds, ijde,                 &amp; <font color=#447700>! min/max(id,jd)<a name='1957'></font>
                                 ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1958'></font>
                                 ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1959'></font>
                                 ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1960'></font>
                                 grid%i_start(ij), grid%i_end(ij),          &amp;<a name='1961'>
                                 grid%j_start(ij), grid%j_end(ij),          &amp;<a name='1962'>
                                 k_start, k_end                               )<a name='1963'>
       ENDIF<a name='1964'>
<a name='1965'>
     ENDIF <font color=#447700>! b.c test for moist nested boundary condition<a name='1966'></font>
<a name='1967'>
BENCH_END(rlx_bdy_scalar_tim)<a name='1968'>
<a name='1969'>
   ENDDO moist_tile_loop_1<a name='1970'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1971'></font>
<a name='1972'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1973'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='1974'></font>
<a name='1975'>
   moist_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='1976'>
<a name='1977'>
       CALL wrf_debug ( 200 , ' call rk_update_scalar' )<a name='1978'>
<a name='1979'>
BENCH_START(update_scal_tim)<a name='1980'>
       CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_3">( im, im,                           &amp;<a name='1981'>
                              moist_1(ims,kms,jms,im),          &amp;<a name='1982'>
                              moist_2(ims,kms,jms,im),          &amp;<a name='1983'>
                              moist_tend(ims,kms,jms,im),       &amp;<a name='1984'>
                              advect_tend, msft,                &amp;<a name='1985'>
                              mu_1, mu_2, mub,                  &amp;<a name='1986'>
                              rk_step, dt_rk, spec_zone,        &amp;<a name='1987'>
                              epsts, leapfrog,config_flags,     &amp;<a name='1988'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='1989'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='1990'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='1991'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='1992'>
                              k_start    , k_end               )<a name='1993'>
BENCH_END(update_scal_tim)<a name='1994'>
<a name='1995'>
BENCH_START(flow_depbdy_tim)<a name='1996'>
       if(dyn_opt == DYN_EM) then<a name='1997'>
       IF( config_flags%specified ) THEN<a name='1998'>
         IF(im .ne. P_QV)THEN<a name='1999'>
           CALL <A href='../../html_code/share/module_bc.F.html#FLOW_DEP_BDY'>flow_dep_bdy</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLOW_DEP_BDY_1">  (  moist_2(ims,kms,jms,im),                     &amp;<a name='2000'>
                               ru_m, rv_m, config_flags, &amp;<a name='2001'>
                               spec_zone,                  &amp;<a name='2002'>
                               ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2003'></font>
                               ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2004'></font>
                               ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2005'></font>
                               grid%i_start(ij), grid%i_end(ij),                      &amp;<a name='2006'>
                               grid%j_start(ij), grid%j_end(ij),                      &amp;<a name='2007'>
                               k_start, k_end                               )<a name='2008'>
         ENDIF<a name='2009'>
       ENDIF<a name='2010'>
       endif<a name='2011'>
BENCH_END(flow_depbdy_tim)<a name='2012'>
<a name='2013'>
   ENDDO moist_tile_loop_2<a name='2014'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2015'></font>
<a name='2016'>
   ENDDO moist_variable_loop<a name='2017'>
<a name='2018'>
 ENDIF moist_scalar_advance<a name='2019'>
<a name='2020'>
BENCH_START(tke_adv_tim)<a name='2021'>
 if(dyn_opt == DYN_EM) then<a name='2022'>
 TKE_advance: IF (km_opt .eq. 2) then<a name='2023'>
<a name='2024'>
#ifdef DM_PARALLEL<a name='2025'>
      IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2026'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_ADVECT_3.inc.html'>HALO_EM_TKE_ADVECT_3.inc</A>"<A NAME="HALO_EM_TKE_ADVECT_3.inc_31"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2027'>
      ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2028'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_ADVECT_5.inc.html'>HALO_EM_TKE_ADVECT_5.inc</A>"<A NAME="HALO_EM_TKE_ADVECT_5.inc_32"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2029'>
      ELSE<a name='2030'>
        WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2031'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_39">(TRIM(wrf_err_message))<a name='2032'>
      ENDIF<a name='2033'>
#endif<a name='2034'>
<a name='2035'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2036'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2037'></font>
<a name='2038'>
   tke_tile_loop_1: DO ij = 1 , grid%num_tiles<a name='2039'>
<a name='2040'>
     CALL wrf_debug ( 200 , ' call rk_scalar_tend for tke' )<a name='2041'>
     CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_4"> ( 1, 1, config_flags,               &amp;<a name='2042'>
                           rk_step, dt_rk,                   &amp;<a name='2043'>
                           ru_m, rv_m, ww_m,                 &amp;<a name='2044'>
                           mut, alt,                         &amp;<a name='2045'>
                           tke_1(ims,kms,jms),               &amp;<a name='2046'>
                           tke_2(ims,kms,jms),               &amp;<a name='2047'>
                           tke_tend(ims,kms,jms),            &amp;<a name='2048'>
                           advect_tend,RQVFTEN,              &amp;<a name='2049'>
                           qv_base, .false., fnm, fnp,       &amp;<a name='2050'>
                           msfu, msfv, msft,                 &amp;<a name='2051'>
                           rdx, rdy, rdn, rdnw, khdif,       &amp;<a name='2052'>
                           kvdif, xkmhd,                     &amp;<a name='2053'>
                           leapfrog,                         &amp;<a name='2054'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='2055'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='2056'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='2057'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='2058'>
                           k_start    , k_end               )<a name='2059'>
<a name='2060'>
   ENDDO tke_tile_loop_1<a name='2061'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2062'></font>
<a name='2063'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2064'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2065'></font>
<a name='2066'>
   tke_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='2067'>
<a name='2068'>
     CALL wrf_debug ( 200 , ' call rk_update_scalar' )<a name='2069'>
     CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_4">( 1, 1,                             &amp;<a name='2070'>
                            tke_1(ims,kms,jms),               &amp;<a name='2071'>
                            tke_2(ims,kms,jms),               &amp;<a name='2072'>
                            tke_tend(ims,kms,jms),            &amp;<a name='2073'>
                            advect_tend,msft,                 &amp;<a name='2074'>
                            mu_1, mu_2, mub,                  &amp;<a name='2075'>
                            rk_step, dt_rk, spec_zone,        &amp;<a name='2076'>
                            epsts, leapfrog,config_flags,     &amp;<a name='2077'>
                            ids, ide, jds, jde, kds, kde,     &amp;<a name='2078'>
                            ims, ime, jms, jme, kms, kme,     &amp;<a name='2079'>
                            grid%i_start(ij), grid%i_end(ij), &amp;<a name='2080'>
                            grid%j_start(ij), grid%j_end(ij), &amp;<a name='2081'>
                            k_start    , k_end               ) <a name='2082'>
<a name='2083'>
<font color=#447700>! bound the tke (greater than 0, less than tke_upper_bound)<a name='2084'></font>
<a name='2085'>
     CALL <A href='../../html_code/dyn_em/module_em.F.html#BOUND_TKE'>bound_tke</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BOUND_TKE_1">( tke_2(ims,kms,jms), tke_upper_bound, &amp;<a name='2086'>
                     ids, ide, jds, jde, kds, kde,        &amp;<a name='2087'>
                     ims, ime, jms, jme, kms, kme,        &amp;<a name='2088'>
                     grid%i_start(ij), grid%i_end(ij),    &amp;<a name='2089'>
                     grid%j_start(ij), grid%j_end(ij),    &amp;<a name='2090'>
                     k_start    , k_end                  )<a name='2091'>
<a name='2092'>
     IF( config_flags%specified .or. config_flags%nested ) THEN<a name='2093'>
         CALL <A href='../../html_code/share/module_bc.F.html#FLOW_DEP_BDY'>flow_dep_bdy</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLOW_DEP_BDY_2"> (  tke_2(ims,kms,jms),                     &amp;<a name='2094'>
                              ru_m, rv_m, config_flags,               &amp;<a name='2095'>
                              spec_zone,                              &amp;<a name='2096'>
                              ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2097'></font>
                              ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2098'></font>
                              ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2099'></font>
                              grid%i_start(ij), grid%i_end(ij),       &amp;<a name='2100'>
                              grid%j_start(ij), grid%j_end(ij),       &amp;<a name='2101'>
                              k_start, k_end                               )<a name='2102'>
     ENDIF<a name='2103'>
   ENDDO tke_tile_loop_2<a name='2104'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2105'></font>
<a name='2106'>
   END IF TKE_advance<a name='2107'>
   endif<a name='2108'>
BENCH_END(tke_adv_tim)<a name='2109'>
<a name='2110'>
<font color=#447700>!  next the chemical species<a name='2111'></font>
<a name='2112'>
  chem_scalar_advance: IF (num_3d_c &gt;= PARAM_FIRST_SCALAR)  THEN<a name='2113'>
<a name='2114'>
   chem_variable_loop: do ic = PARAM_FIRST_SCALAR, num_3d_c<a name='2115'>
<a name='2116'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2117'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2118'></font>
<a name='2119'>
   chem_tile_loop_1: DO ij = 1 , grid%num_tiles<a name='2120'>
<a name='2121'>
       CALL wrf_debug ( 200 , ' call rk_scalar_tend' )<a name='2122'>
       CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_5"> ( ic, ic, config_flags,                  &amp;<a name='2123'>
                             rk_step, dt_rk,                   &amp;<a name='2124'>
                             ru_m, rv_m, ww_m,                 &amp;<a name='2125'>
                             mut, alt,                         &amp;<a name='2126'>
                             chem_1(ims,kms,jms,ic),           &amp;<a name='2127'>
                             chem_2(ims,kms,jms,ic),           &amp;<a name='2128'>
                             chem_tend(ims,kms,jms,ic),        &amp;<a name='2129'>
                             advect_tend,RQVFTEN,              &amp;<a name='2130'>
                             qv_base, .false., fnm, fnp,       &amp;<a name='2131'>
                             msfu, msfv, msft,                 &amp;<a name='2132'>
                             rdx, rdy, rdn, rdnw,              &amp;<a name='2133'>
                             khdif, kvdif, xkmhd,              &amp;<a name='2134'>
                             leapfrog,                         &amp;<a name='2135'>
                             ids, ide, jds, jde, kds, kde,     &amp;<a name='2136'>
                             ims, ime, jms, jme, kms, kme,     &amp;<a name='2137'>
                             grid%i_start(ij), grid%i_end(ij), &amp;<a name='2138'>
                             grid%j_start(ij), grid%j_end(ij), &amp;<a name='2139'>
                             k_start    , k_end               )<a name='2140'>
<a name='2141'>
   ENDDO chem_tile_loop_1<a name='2142'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2143'></font>
<a name='2144'>
<a name='2145'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2146'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2147'></font>
<a name='2148'>
   chem_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='2149'>
<a name='2150'>
       CALL wrf_debug ( 200 , ' call rk_update_scalar' )<a name='2151'>
       CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_5">( ic, ic,                           &amp;<a name='2152'>
                              chem_1(ims,kms,jms,ic),           &amp;<a name='2153'>
                              chem_2(ims,kms,jms,ic),           &amp;<a name='2154'>
                              chem_tend(ims,kms,jms,ic),        &amp;<a name='2155'>
                              advect_tend, msft,                &amp;<a name='2156'>
                              mu_1, mu_2, mub,                  &amp;<a name='2157'>
                              rk_step, dt_rk, spec_zone,        &amp;<a name='2158'>
                              epsts, leapfrog,config_flags,     &amp;<a name='2159'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='2160'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='2161'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='2162'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='2163'>
                              k_start    , k_end               )<a name='2164'>
<a name='2165'>
<a name='2166'>
       IF( config_flags%specified ) THEN<a name='2167'>
<font color=#447700>! come back to this and figure out why two different routines are needed. JM 20041203<a name='2168'></font>
#ifndef WRF_CHEM<a name='2169'>
           CALL <A href='../../html_code/share/module_bc.F.html#FLOW_DEP_BDY'>flow_dep_bdy</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLOW_DEP_BDY_3">  ( chem_2(ims,kms,jms,ic),     &amp;<a name='2170'>
                                ru_m, rv_m, config_flags,   &amp;<a name='2171'>
                                spec_zone,                  &amp;<a name='2172'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2173'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2174'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2175'></font>
                                grid%i_start(ij), grid%i_end(ij),  &amp;<a name='2176'>
                                grid%j_start(ij), grid%j_end(ij),  &amp;<a name='2177'>
                                k_start, k_end                    )<a name='2178'>
#else<a name='2179'>
           CALL flow_dep_bdy_chem( chem_2(ims,kms,jms,ic),z,&amp;<a name='2180'>
                                ru_m, rv_m, config_flags,alt,   &amp;<a name='2181'>
                                t_1,pb,p,t0,p1000mb,rcp,ph_2,phb,g, &amp;<a name='2182'>
                                spec_zone,ic,               &amp;<a name='2183'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2184'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2185'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2186'></font>
                                grid%i_start(ij), grid%i_end(ij),  &amp;<a name='2187'>
                                grid%j_start(ij), grid%j_end(ij),  &amp;<a name='2188'>
                                k_start, k_end                    )<a name='2189'>
#endif<a name='2190'>
       ENDIF<a name='2191'>
<a name='2192'>
<a name='2193'>
   ENDDO chem_tile_loop_2<a name='2194'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2195'></font>
<a name='2196'>
   ENDDO chem_variable_loop<a name='2197'>
<a name='2198'>
 ENDIF chem_scalar_advance<a name='2199'>
<a name='2200'>
 <font color=#447700>!  update the pressure and density at the new time level<a name='2201'></font>
<a name='2202'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2203'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2204'></font>
   DO ij = 1 , grid%num_tiles<a name='2205'>
<a name='2206'>
BENCH_START(calc_p_rho_tim)<a name='2207'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI'>calc_p_rho_phi</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_PHI_3">( moist_2, num_3d_m,                &amp;<a name='2208'>
                          al, alb, mu_2, muts,              &amp;<a name='2209'>
                          ph_2, p, pb, t_2,                 &amp;<a name='2210'>
                          p0, t0, znu, dnw, rdnw,           &amp;<a name='2211'>
                          rdn, non_hydrostatic,             &amp;<a name='2212'>
                          ids, ide, jds, jde, kds, kde,     &amp;<a name='2213'>
                          ims, ime, jms, jme, kms, kme,     &amp;<a name='2214'>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='2215'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='2216'>
                          k_start    , k_end               )<a name='2217'>
BENCH_END(calc_p_rho_tim)<a name='2218'>
<a name='2219'>
BENCH_START(diag_w_tim)<a name='2220'>
     IF (.not. non_hydrostatic) THEN<a name='2221'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DIAGNOSE_W'>diagnose_w</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIAGNOSE_W_3">( ph_tend, ph_2, ph_1, w_2, muts, dt_rk,  &amp;<a name='2222'>
                      u_2, v_2, ht,                           &amp;<a name='2223'>
                      cf1, cf2, cf3, rdx, rdy, msft,          &amp;<a name='2224'>
                      ids, ide, jds, jde, kds, kde,           &amp;<a name='2225'>
                      ims, ime, jms, jme, kms, kme,           &amp;<a name='2226'>
                      grid%i_start(ij), grid%i_end(ij),       &amp;<a name='2227'>
                      grid%j_start(ij), grid%j_end(ij),       &amp;<a name='2228'>
                      k_start    , k_end                     )<a name='2229'>
     ENDIF<a name='2230'>
BENCH_END(diag_w_tim)<a name='2231'>
<a name='2232'>
   ENDDO<a name='2233'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2234'></font>
<a name='2235'>
<font color=#447700>!  Reset the boundary conditions if there is another corrector step.<a name='2236'></font>
<font color=#447700>!  (rk_step &lt; rk_order), else we'll handle it at the end of everything<a name='2237'></font>
<font color=#447700>!  (after the split physics, before exiting the timestep).<a name='2238'></font>
<a name='2239'>
   rk_step_1_check: IF ( rk_step &lt; rk_order ) THEN<a name='2240'>
<a name='2241'>
<font color=#447700>!-----------------------------------------------------------<a name='2242'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='2243'></font>
<font color=#447700>!<a name='2244'></font>
<font color=#447700>!  here's where we need a wide comm stencil - these are the <a name='2245'></font>
<font color=#447700>!  uncoupled variables so are used for high order calc in<a name='2246'></font>
<font color=#447700>!  advection and mixong routines.<a name='2247'></font>
<font color=#447700>!<a name='2248'></font>
<font color=#447700>!                              * * * * *<a name='2249'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='2250'></font>
<font color=#447700>!          * + *      * + *    * * + * * <a name='2251'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='2252'></font>
<font color=#447700>!                              * * * * *<a name='2253'></font>
<font color=#447700>!<a name='2254'></font>
<font color=#447700>!<a name='2255'></font>
<font color=#447700>! u_2                              x<a name='2256'></font>
<font color=#447700>! v_2                              x<a name='2257'></font>
<font color=#447700>! w_2                              x<a name='2258'></font>
<font color=#447700>! t_2                              x<a name='2259'></font>
<font color=#447700>! ph_2                             x<a name='2260'></font>
<font color=#447700>! al         x<a name='2261'></font>
<font color=#447700>!<a name='2262'></font>
<font color=#447700>!  2D variable<a name='2263'></font>
<font color=#447700>! mu_2       x<a name='2264'></font>
<font color=#447700>!<a name='2265'></font>
<font color=#447700>!  4D variable<a name='2266'></font>
<font color=#447700>! moist_2               x<a name='2267'></font>
<font color=#447700>! chem_2                x<a name='2268'></font>
<a name='2269'>
#ifdef DM_PARALLEL<a name='2270'>
   IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2271'>
#    include "<A href='../../html_code/include/HALO_EM_D2_3.inc.html'>HALO_EM_D2_3.inc</A>"<A NAME="HALO_EM_D2_3.inc_33"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2272'>
   ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2273'>
#    include "<A href='../../html_code/include/HALO_EM_D2_5.inc.html'>HALO_EM_D2_5.inc</A>"<A NAME="HALO_EM_D2_5.inc_34"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2274'>
   ELSE <a name='2275'>
     WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2276'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_40">(TRIM(wrf_err_message))<a name='2277'>
   ENDIF<a name='2278'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_D.inc.html'>PERIOD_BDY_EM_D.inc</A>"<A NAME="PERIOD_BDY_EM_D.inc_35"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2279'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_MOIST2.inc.html'>PERIOD_BDY_EM_MOIST2.inc</A>"<A NAME="PERIOD_BDY_EM_MOIST2.inc_36"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2280'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_CHEM2.inc.html'>PERIOD_BDY_EM_CHEM2.inc</A>"<A NAME="PERIOD_BDY_EM_CHEM2.inc_37"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2281'>
#endif<a name='2282'>
<a name='2283'>
BENCH_START(bc_end_tim)<a name='2284'>
   if(dyn_opt == DYN_EM) then<a name='2285'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2286'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2287'></font>
<a name='2288'>
    tile_bc_loop_1: DO ij = 1 , grid%num_tiles<a name='2289'>
<a name='2290'>
      CALL wrf_debug ( 200 , ' call rk_phys_bc_dry_2' )<a name='2291'>
<a name='2292'>
      CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RK_PHYS_BC_DRY_2'>rk_phys_bc_dry_2</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_PHYS_BC_DRY_2_1">( config_flags,                         &amp;<a name='2293'>
                             u_2, v_2, w_2,                    &amp;<a name='2294'>
                             t_2, ph_2, mu_2,                  &amp;<a name='2295'>
                             ids, ide, jds, jde, kds, kde,     &amp;<a name='2296'>
                             ims, ime, jms, jme, kms, kme,     &amp;<a name='2297'>
                             ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='2298'>
                             grid%i_start(ij), grid%i_end(ij), &amp;<a name='2299'>
                             grid%j_start(ij), grid%j_end(ij), &amp;<a name='2300'>
                             k_start    , k_end               )<a name='2301'>
<a name='2302'>
      IF (num_3d_m &gt;= PARAM_FIRST_SCALAR) THEN<a name='2303'>
<a name='2304'>
        moisture_loop_bdy_1 : DO im = PARAM_FIRST_SCALAR , num_3d_m<a name='2305'>
  <a name='2306'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_86">( moist_2(ims,kms,jms,im), 'p', config_flags,   &amp;<a name='2307'>
                                   ids, ide, jds, jde, kds, kde,             &amp;<a name='2308'>
                                   ims, ime, jms, jme, kms, kme,             &amp;<a name='2309'>
                                   ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='2310'>
                                   grid%i_start(ij), grid%i_end(ij),                   &amp;<a name='2311'>
                                   grid%j_start(ij), grid%j_end(ij),                   &amp;<a name='2312'>
                                   k_start    , k_end                       )<a name='2313'>
         END DO moisture_loop_bdy_1<a name='2314'>
<a name='2315'>
      ENDIF<a name='2316'>
<a name='2317'>
      IF (num_3d_c &gt;= PARAM_FIRST_SCALAR) THEN<a name='2318'>
<a name='2319'>
        chem_species_bdy_loop_1 : DO ic = PARAM_FIRST_SCALAR , num_3d_c<a name='2320'>
<a name='2321'>
          CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_87">( chem_2(ims,kms,jms,ic), 'p', config_flags,   &amp;<a name='2322'>
                                  ids, ide, jds, jde, kds, kde,            &amp;<a name='2323'>
                                  ims, ime, jms, jme, kms, kme,            &amp;<a name='2324'>
                                  ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='2325'>
                                  grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='2326'>
                                  grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='2327'>
                                  k_start    , k_end-1                    )<a name='2328'>
<a name='2329'>
        END DO chem_species_bdy_loop_1<a name='2330'>
<a name='2331'>
      END IF<a name='2332'>
<a name='2333'>
      IF (km_opt .eq. 2) THEN<a name='2334'>
<a name='2335'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_88">( tke_2(ims,kms,jms) , 'p', config_flags,  &amp;<a name='2336'>
                                ids, ide, jds, jde, kds, kde,            &amp;<a name='2337'>
                                ims, ime, jms, jme, kms, kme,            &amp;<a name='2338'>
                                ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='2339'>
                                grid%i_start(ij), grid%i_end(ij),        &amp;<a name='2340'>
                                grid%j_start(ij), grid%j_end(ij),        &amp;<a name='2341'>
                                k_start    , k_end                      )<a name='2342'>
      END IF<a name='2343'>
<a name='2344'>
    END DO tile_bc_loop_1<a name='2345'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2346'></font>
   endif<a name='2347'>
BENCH_END(bc_end_tim)<a name='2348'>
<a name='2349'>
<a name='2350'>
#ifdef DM_PARALLEL<a name='2351'>
<a name='2352'>
      IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2353'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_3.inc.html'>HALO_EM_TKE_3.inc</A>"<A NAME="HALO_EM_TKE_3.inc_38"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2354'>
      ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2355'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_5.inc.html'>HALO_EM_TKE_5.inc</A>"<A NAME="HALO_EM_TKE_5.inc_39"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2356'>
      ELSE<a name='2357'>
        WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2358'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_41">(TRIM(wrf_err_message))<a name='2359'>
      ENDIF<a name='2360'>
<a name='2361'>
#if 0<a name='2362'>
   IF (km_opt .eq. 2) THEN<a name='2363'>
#      include  "<A href='../../html_code/include/HALO_EM_TKE_F.inc.html'>HALO_EM_TKE_F.inc</A>"<A NAME="HALO_EM_TKE_F.inc_40"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2364'>
   ENDIF<a name='2365'>
#endif<a name='2366'>
<a name='2367'>
   if ( num_moist .ge. PARAM_FIRST_SCALAR ) then<a name='2368'>
<a name='2369'>
<font color=#447700>!                           * * * * *<a name='2370'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='2371'></font>
<font color=#447700>!       * + *      * + *    * * + * *<a name='2372'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='2373'></font>
<font color=#447700>!                           * * * * *<a name='2374'></font>
<a name='2375'>
<font color=#447700>! moist_2                       x<a name='2376'></font>
<a name='2377'>
     IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2378'>
#      include "<A href='../../html_code/include/HALO_EM_MOIST_E_3.inc.html'>HALO_EM_MOIST_E_3.inc</A>"<A NAME="HALO_EM_MOIST_E_3.inc_41"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2379'>
     ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2380'>
#      include "<A href='../../html_code/include/HALO_EM_MOIST_E_5.inc.html'>HALO_EM_MOIST_E_5.inc</A>"<A NAME="HALO_EM_MOIST_E_5.inc_42"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2381'>
     ELSE<a name='2382'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2383'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_42">(TRIM(wrf_err_message))<a name='2384'>
     ENDIF<a name='2385'>
   endif<a name='2386'>
   if ( num_chem &gt;= PARAM_FIRST_SCALAR ) then<a name='2387'>
<a name='2388'>
<font color=#447700>!                           * * * * *<a name='2389'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='2390'></font>
<font color=#447700>!       * + *      * + *    * * + * *<a name='2391'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='2392'></font>
<font color=#447700>!                           * * * * *<a name='2393'></font>
<a name='2394'>
<font color=#447700>! chem_2                        x<a name='2395'></font>
<a name='2396'>
     IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2397'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_43"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2398'>
     ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2399'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_5.inc.html'>HALO_EM_CHEM_E_5.inc</A>"<A NAME="HALO_EM_CHEM_E_5.inc_44"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2400'>
     ELSE<a name='2401'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2402'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_43">(TRIM(wrf_err_message))<a name='2403'>
     ENDIF<a name='2404'>
   endif<a name='2405'>
#endif<a name='2406'>
<a name='2407'>
   ENDIF rk_step_1_check<a name='2408'>
<a name='2409'>
<a name='2410'>
<font color=#447700>!**********************************************************<a name='2411'></font>
<font color=#447700>!<a name='2412'></font>
<font color=#447700>!  end of RK predictor-corrector loop<a name='2413'></font>
<font color=#447700>!<a name='2414'></font>
<font color=#447700>!**********************************************************<a name='2415'></font>
<a name='2416'>
 END DO Runge_Kutta_loop<a name='2417'>
<a name='2418'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2419'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2420'></font>
<a name='2421'>
   DO ij = 1 , grid%num_tiles<a name='2422'>
<a name='2423'>
BENCH_START(advance_ppt_tim)<a name='2424'>
      CALL wrf_debug ( 200 , ' call advance_ppt' )<a name='2425'>
      CALL <A href='../../html_code/phys/module_physics_addtendc.F.html#ADVANCE_PPT'>advance_ppt</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_PPT_1">(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN, &amp;<a name='2426'>
                     RQICUTEN,RQSCUTEN,RAINC,RAINCV,NCA,    &amp;<a name='2427'>
                     CUPPT, config_flags,                   &amp;<a name='2428'>
                     ids,ide, jds,jde, kds,kde,             &amp;<a name='2429'>
                     ims,ime, jms,jme, kms,kme,             &amp;<a name='2430'>
                     grid%i_start(ij), grid%i_end(ij),      &amp;<a name='2431'>
                     grid%j_start(ij), grid%j_end(ij),      &amp;<a name='2432'>
                     k_start    , k_end                    )<a name='2433'>
BENCH_END(advance_ppt_tim)<a name='2434'>
<a name='2435'>
   ENDDO<a name='2436'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2437'></font>
<a name='2438'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2439'></font>
<font color=#447700>!&lt;pre&gt;<a name='2440'></font>
<font color=#447700>! (5) time-split physics.<a name='2441'></font>
<font color=#447700>!<a name='2442'></font>
<font color=#447700>!     Microphysics are the only time  split physics in the WRF model <a name='2443'></font>
<font color=#447700>!     at this time.  Split-physics begins with the calculation of<a name='2444'></font>
<font color=#447700>!     needed diagnostic quantities (pressure, temperature, etc.)<a name='2445'></font>
<font color=#447700>!     followed by a call to the microphysics driver, <a name='2446'></font>
<font color=#447700>!     and finishes with a clean-up, storing off of a diabatic tendency<a name='2447'></font>
<font color=#447700>!     from the moist physics, and a re-calulation of the  diagnostic<a name='2448'></font>
<font color=#447700>!     quantities pressure and density.<a name='2449'></font>
<font color=#447700>!&lt;/pre&gt;<a name='2450'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2451'></font>
<a name='2452'>
  IF (config_flags%mp_physics == 0)  then<a name='2453'>
<a name='2454'>
   IF( config_flags%specified .or. config_flags%nested ) THEN<a name='2455'>
     sz = spec_zone<a name='2456'>
   ELSE<a name='2457'>
     sz = 0<a name='2458'>
   ENDIF<a name='2459'>
<a name='2460'>
<a name='2461'>
   scalar_tile_loop_1a: DO ij = 1 , grid%num_tiles<a name='2462'>
<a name='2463'>
       its = max(grid%i_start(ij),ids+sz)<a name='2464'>
       ite = min(grid%i_end(ij),ide-1-sz)<a name='2465'>
       jts = max(grid%j_start(ij),jds+sz)<a name='2466'>
       jte = min(grid%j_end(ij),jde-1-sz)<a name='2467'>
<a name='2468'>
       CALL wrf_debug ( 200 , ' call moist_physics_prep' )<a name='2469'>
BENCH_START(moist_physics_prep_tim)<a name='2470'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_PREP_EM'>moist_physics_prep_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOIST_PHYSICS_PREP_EM_3">( t_2, t_1, t0, rho,                &amp;<a name='2471'>
                                   al, alb, p, p8w, p0, pb,          &amp;<a name='2472'>
                                   ph_2, phb, pi_phy, p_phy,         &amp;<a name='2473'>
                                   z, z_at_w, dz8w,                  &amp;<a name='2474'>
                                   dtm, h_diabatic,                  &amp;<a name='2475'>
                                   config_flags,fnm, fnp,            &amp;<a name='2476'>
                                   ids, ide, jds, jde, kds, kde,     &amp;<a name='2477'>
                                   ims, ime, jms, jme, kms, kme,     &amp;<a name='2478'>
                                   its, ite, jts, jte,               &amp;<a name='2479'>
                                   k_start    , k_end               )<a name='2480'>
        <a name='2481'>
        CALL <A href='../../html_code/phys/module_mp_nconvp.F.html#LSCOND'>lscond</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LSCOND_3">(t_2, p_phy                                         &amp;<a name='2482'>
                    ,moist_2(ims,kms,jms,P_QV)                         &amp;<a name='2483'>
                    ,rho, pi_phy,r_v, xlv, cp                          &amp;<a name='2484'>
                    ,ep_2, svp1, svp2                                  &amp;<a name='2485'>
                    ,svp3, svpt0                                       &amp;<a name='2486'>
                    ,dz8w                                              &amp;<a name='2487'>
                    ,rainnc, rainncv                                   &amp;<a name='2488'>
                    ,ids, ide, jds, jde, kds, kde                      &amp;<a name='2489'>
                    ,ims, ime, jms, jme, kms, kme                      &amp;<a name='2490'>
                    ,its, ite, jts, jte                                &amp;<a name='2491'>
                    ,k_start, min(k_end,kde-1)                         )<a name='2492'>
<a name='2493'>
<a name='2494'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2495'></font>
<a name='2496'>
BENCH_END(moist_physics_prep_tim)<a name='2497'>
   END DO scalar_tile_loop_1a<a name='2498'>
<a name='2499'>
       CALL wrf_debug ( 200 , ' call microphysics_driver' )<a name='2500'>
<a name='2501'>
<a name='2502'>
       CALL wrf_debug ( 200 , ' call moist_physics_finish' )<a name='2503'>
BENCH_START(moist_phys_end_tim)<a name='2504'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2505'></font>
   <font color=#447700>!$OMP PRIVATE ( ij, its, ite, jts, jte )<a name='2506'></font>
<a name='2507'>
   scalar_tile_loop_1b: DO ij = 1 , grid%num_tiles<a name='2508'>
<a name='2509'>
       its = max(grid%i_start(ij),ids+sz)<a name='2510'>
       ite = min(grid%i_end(ij),ide-1-sz)<a name='2511'>
       jts = max(grid%j_start(ij),jds+sz)<a name='2512'>
       jte = min(grid%j_end(ij),jde-1-sz)<a name='2513'>
<a name='2514'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_FINISH_EM'>moist_physics_finish_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOIST_PHYSICS_FINISH_EM_1">( t_2, t_1, t0, muts,               &amp;<a name='2515'>
                                     h_diabatic, dtm, config_flags,    &amp;<a name='2516'>
                                     ids, ide, jds, jde, kds, kde,     &amp;<a name='2517'>
                                     ims, ime, jms, jme, kms, kme,     &amp;<a name='2518'>
                                     its, ite, jts, jte,               &amp;<a name='2519'>
                                     k_start    , k_end               )<a name='2520'>
<a name='2521'>
<a name='2522'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI'>calc_p_rho_phi</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_PHI_4">( moist_2, num_3d_m,                &amp;<a name='2523'>
                            al, alb, mu_2, muts,              &amp;<a name='2524'>
                            ph_2, p, pb, t_2,                 &amp;<a name='2525'>
                            p0, t0, znu, dnw, rdnw,           &amp;<a name='2526'>
                            rdn, non_hydrostatic,             &amp;<a name='2527'>
                            ids, ide, jds, jde, kds, kde,     &amp;<a name='2528'>
                            ims, ime, jms, jme, kms, kme,     &amp;<a name='2529'>
                            its, ite, jts, jte,               &amp;<a name='2530'>
                            k_start    , k_end               )<a name='2531'>
<a name='2532'>
       IF (.not. non_hydrostatic)                               &amp;<a name='2533'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DIAGNOSE_W'>diagnose_w</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIAGNOSE_W_4">( ph_tend, ph_2, ph_1, w_2, muts, dt_rk,  &amp;<a name='2534'>
                        u_2, v_2, ht,                           &amp;<a name='2535'>
                        cf1, cf2, cf3, rdx, rdy, msft,          &amp;<a name='2536'>
                        ids, ide, jds, jde, kds, kde,           &amp;<a name='2537'>
                        ims, ime, jms, jme, kms, kme,           &amp;<a name='2538'>
                        its, ite, jts, jte,                     &amp;<a name='2539'>
                        k_start    , k_end                     )<a name='2540'>
<a name='2541'>
   END DO scalar_tile_loop_1b<a name='2542'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2543'></font>
BENCH_END(moist_phys_end_tim)<a name='2544'>
<a name='2545'>
  ENDIF<a name='2546'>
<a name='2547'>
   scalar_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='2548'>
<a name='2549'>
          CALL wrf_debug ( 200 , ' call scalar_tile_loop_2' )<a name='2550'>
<a name='2551'>
     IF ( num_3d_c &gt;= PARAM_FIRST_SCALAR ) then<a name='2552'>
<a name='2553'>
<font color=#447700>!<a name='2554'></font>
<font color=#447700>!  tiled chemistry not here, it is called from solve_interface, and found in chem_driver<a name='2555'></font>
<font color=#447700>!<a name='2556'></font>
<a name='2557'>
     END IF<a name='2558'>
<a name='2559'>
   END DO scalar_tile_loop_2<a name='2560'>
<a name='2561'>
<a name='2562'>
   if(dyn_opt == DYN_EM) then<a name='2563'>
   IF (leapfrog ) THEN<a name='2564'>
<a name='2565'>
    <font color=#447700>! do time filter and switch for the dry variables<a name='2566'></font>
<a name='2567'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2568'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2569'></font>
<a name='2570'>
    DO ij = 1 , grid%num_tiles<a name='2571'>
<a name='2572'>
BENCH_START(time_filt_tim)<a name='2573'>
      call <A href='../../html_code/dyn_em/module_em.F.html#TIME_FILTER'>time_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TIME_FILTER_1">( u_1, u_2, u_save,                 &amp;<a name='2574'>
                        v_1, v_2, v_save,                 &amp;<a name='2575'>
                        w_1, w_2, w_save,                 &amp;<a name='2576'>
                        t_1, t_2, t_save,                 &amp;<a name='2577'>
                        ph_1, ph_2, ph_save,              &amp;<a name='2578'>
                        mu_1, mu_2, mu_save,              &amp;<a name='2579'>
                        epsts,                            &amp;<a name='2580'>
                        ids, ide, jds, jde, kds, kde,     &amp;<a name='2581'>
                        ims, ime, jms, jme, kms, kme,     &amp;<a name='2582'>
                        grid%i_start(ij), grid%i_end(ij), &amp;<a name='2583'>
                        grid%j_start(ij), grid%j_end(ij), &amp;<a name='2584'>
                        k_start    , k_end               )<a name='2585'>
BENCH_END(time_filt_tim)<a name='2586'>
<a name='2587'>
    ENDDO<a name='2588'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2589'></font>
<a name='2590'>
    END IF<a name='2591'>
    endif<a name='2592'>
<a name='2593'>
   <font color=#447700>!  We're finished except for boundary condition (and patch) update<a name='2594'></font>
<a name='2595'>
   <font color=#447700>! Boundary condition time (or communication time).  At this time, we have<a name='2596'></font>
   <font color=#447700>! implemented periodic and symmetric physical boundary conditions.<a name='2597'></font>
<a name='2598'>
   <font color=#447700>! b.c. routine for data within patch.<a name='2599'></font>
<a name='2600'>
   <font color=#447700>! we need to do both time levels of <a name='2601'></font>
   <font color=#447700>! data because the time filter only works in the physical solution space.<a name='2602'></font>
<a name='2603'>
   <font color=#447700>! First, do patch communications for boundary conditions (periodicity)<a name='2604'></font>
<a name='2605'>
<font color=#447700>!-----------------------------------------------------------<a name='2606'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='2607'></font>
<font color=#447700>!<a name='2608'></font>
<font color=#447700>!  here's where we need a wide comm stencil - these are the <a name='2609'></font>
<font color=#447700>!  uncoupled variables so are used for high order calc in<a name='2610'></font>
<font color=#447700>!  advection and mixong routines.<a name='2611'></font>
<font color=#447700>!<a name='2612'></font>
<font color=#447700>!                              * * * * *<a name='2613'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='2614'></font>
<font color=#447700>!          * + *      * + *    * * + * * <a name='2615'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='2616'></font>
<font color=#447700>!                              * * * * *<a name='2617'></font>
<font color=#447700>!<a name='2618'></font>
<font color=#447700>!   u_1                            x<a name='2619'></font>
<font color=#447700>!   u_2                            x<a name='2620'></font>
<font color=#447700>!   v_1                            x<a name='2621'></font>
<font color=#447700>!   v_2                            x<a name='2622'></font>
<font color=#447700>!   w_1                            x<a name='2623'></font>
<font color=#447700>!   w_2                            x<a name='2624'></font>
<font color=#447700>!   t_1                            x<a name='2625'></font>
<font color=#447700>!   t_2                            x<a name='2626'></font>
<font color=#447700>!  ph_1                            x<a name='2627'></font>
<font color=#447700>!  ph_2                            x<a name='2628'></font>
<font color=#447700>!  tke_1                           x<a name='2629'></font>
<font color=#447700>!  tke_2                           x<a name='2630'></font>
<font color=#447700>!<a name='2631'></font>
<font color=#447700>!    2D variables<a name='2632'></font>
<font color=#447700>!  mu_1     x<a name='2633'></font>
<font color=#447700>!  mu_2     x<a name='2634'></font>
<font color=#447700>!<a name='2635'></font>
<font color=#447700>!    4D variables<a name='2636'></font>
<font color=#447700>!  moist_1                         x<a name='2637'></font>
<font color=#447700>!  moist_2                         x<a name='2638'></font>
<font color=#447700>!   chem_1                         x<a name='2639'></font>
<font color=#447700>!   chem_2                         x<a name='2640'></font>
<font color=#447700>!----------------------------------------------------------<a name='2641'></font>
<a name='2642'>
<a name='2643'>
#ifdef DM_PARALLEL<a name='2644'>
   IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2645'>
#    include "<A href='../../html_code/include/HALO_EM_D3_3.inc.html'>HALO_EM_D3_3.inc</A>"<A NAME="HALO_EM_D3_3.inc_45"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2646'>
   ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2647'>
#    include "<A href='../../html_code/include/HALO_EM_D3_5.inc.html'>HALO_EM_D3_5.inc</A>"<A NAME="HALO_EM_D3_5.inc_46"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2648'>
   ELSE <a name='2649'>
     WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2650'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_44">(TRIM(wrf_err_message))<a name='2651'>
   ENDIF<a name='2652'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_D3.inc.html'>PERIOD_BDY_EM_D3.inc</A>"<A NAME="PERIOD_BDY_EM_D3.inc_47"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2653'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_MOIST.inc.html'>PERIOD_BDY_EM_MOIST.inc</A>"<A NAME="PERIOD_BDY_EM_MOIST.inc_48"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2654'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_CHEM.inc.html'>PERIOD_BDY_EM_CHEM.inc</A>"<A NAME="PERIOD_BDY_EM_CHEM.inc_49"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2655'>
#endif<a name='2656'>
<a name='2657'>
<font color=#447700>!  now set physical b.c on a patch<a name='2658'></font>
<a name='2659'>
BENCH_START(bc_2d_tim)<a name='2660'>
   if(dyn_opt == DYN_EM) then<a name='2661'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2662'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='2663'></font>
<a name='2664'>
   tile_bc_loop_2: DO ij = 1 , grid%num_tiles<a name='2665'>
<a name='2666'>
     CALL wrf_debug ( 200 , ' call set_phys_bc_dry_2' )<a name='2667'>
<a name='2668'>
     CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SET_PHYS_BC_DRY_2'>set_phys_bc_dry_2</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYS_BC_DRY_2_1">( config_flags,                           &amp;<a name='2669'>
                             u_1, u_2, v_1, v_2, w_1, w_2,           &amp;<a name='2670'>
                             t_1, t_2, ph_1, ph_2, mu_1, mu_2,       &amp;<a name='2671'>
                             ids, ide, jds, jde, kds, kde,           &amp;<a name='2672'>
                             ims, ime, jms, jme, kms, kme,           &amp;<a name='2673'>
                             ips, ipe, jps, jpe, kps, kpe,           &amp;<a name='2674'>
                             grid%i_start(ij), grid%i_end(ij),       &amp;<a name='2675'>
                             grid%j_start(ij), grid%j_end(ij),       &amp;<a name='2676'>
                             k_start    , k_end                     )<a name='2677'>
<a name='2678'>
     CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_89">( tke_1(ims,kms,jms), 'p', config_flags,   &amp;<a name='2679'>
                             ids, ide, jds, jde, kds, kde,            &amp;<a name='2680'>
                             ims, ime, jms, jme, kms, kme,            &amp;<a name='2681'>
                             ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='2682'>
                             grid%i_start(ij), grid%i_end(ij),        &amp;<a name='2683'>
                             grid%j_start(ij), grid%j_end(ij),        &amp;<a name='2684'>
                             k_start    , k_end-1                    )<a name='2685'>
     CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_90">( tke_2(ims,kms,jms) , 'p', config_flags,  &amp;<a name='2686'>
                             ids, ide, jds, jde, kds, kde,            &amp;<a name='2687'>
                             ims, ime, jms, jme, kms, kme,            &amp;<a name='2688'>
                             ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='2689'>
                             grid%i_start(ij), grid%i_end(ij),        &amp;<a name='2690'>
                             grid%j_start(ij), grid%j_end(ij),        &amp;<a name='2691'>
                             k_start    , k_end                      )<a name='2692'>
<a name='2693'>
     moisture_loop_bdy_2 : DO im = PARAM_FIRST_SCALAR , num_3d_m<a name='2694'>
<a name='2695'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_91">( moist_1(ims,kms,jms,im), 'p',           &amp;<a name='2696'>
                               config_flags,                           &amp;<a name='2697'>
                               ids, ide, jds, jde, kds, kde,           &amp;<a name='2698'>
                               ims, ime, jms, jme, kms, kme,           &amp;<a name='2699'>
                               ips, ipe, jps, jpe, kps, kpe,           &amp;<a name='2700'>
                               grid%i_start(ij), grid%i_end(ij),       &amp;<a name='2701'>
                               grid%j_start(ij), grid%j_end(ij),       &amp;<a name='2702'>
                               k_start    , k_end                     )<a name='2703'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_92">( moist_2(ims,kms,jms,im), 'p',           &amp;<a name='2704'>
                               config_flags,                           &amp;<a name='2705'>
                               ids, ide, jds, jde, kds, kde,           &amp;<a name='2706'>
                               ims, ime, jms, jme, kms, kme,           &amp;<a name='2707'>
                               ips, ipe, jps, jpe, kps, kpe,           &amp;<a name='2708'>
                               grid%i_start(ij), grid%i_end(ij),       &amp;<a name='2709'>
                               grid%j_start(ij), grid%j_end(ij),       &amp;<a name='2710'>
                               k_start    , k_end                     )<a name='2711'>
<a name='2712'>
     END DO moisture_loop_bdy_2<a name='2713'>
<a name='2714'>
     chem_species_bdy_loop_2 : DO ic = PARAM_FIRST_SCALAR , num_3d_c<a name='2715'>
<a name='2716'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_93">( chem_1(ims,kms,jms,ic), 'p', config_flags,   &amp;<a name='2717'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='2718'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='2719'>
                               ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='2720'>
                               grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='2721'>
                               grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='2722'>
                               k_start    , k_end                    )<a name='2723'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_94">( chem_2(ims,kms,jms,ic) , 'p', config_flags,  &amp;<a name='2724'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='2725'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='2726'>
                               ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='2727'>
                               grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='2728'>
                               grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='2729'>
                               k_start    , k_end                      )<a name='2730'>
<a name='2731'>
     END DO chem_species_bdy_loop_2<a name='2732'>
<a name='2733'>
   END DO tile_bc_loop_2<a name='2734'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2735'></font>
   endif<a name='2736'>
BENCH_END(bc_2d_tim)<a name='2737'>
<a name='2738'>
   IF( config_flags%specified .or. config_flags%nested ) THEN <a name='2739'>
     dtbc = dtbc + dt<a name='2740'>
   ENDIF<a name='2741'>
<a name='2742'>
#ifdef DM_PARALLEL<a name='2743'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2744'></font>
<font color=#447700>! see above<a name='2745'></font>
<font color=#447700>!--------------------------------------------------------------<a name='2746'></font>
   CALL wrf_debug ( 200 , ' call HALO_RK_E' )<a name='2747'>
   IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2748'>
#    include "<A href='../../html_code/include/HALO_EM_E_3.inc.html'>HALO_EM_E_3.inc</A>"<A NAME="HALO_EM_E_3.inc_50"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2749'>
   ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2750'>
#    include "<A href='../../html_code/include/HALO_EM_E_5.inc.html'>HALO_EM_E_5.inc</A>"<A NAME="HALO_EM_E_5.inc_51"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2751'>
   ELSE<a name='2752'>
     WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2753'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_45">(TRIM(wrf_err_message))<a name='2754'>
   ENDIF<a name='2755'>
#endif<a name='2756'>
<a name='2757'>
#ifdef DM_PARALLEL<a name='2758'>
   if ( num_moist &gt;= PARAM_FIRST_SCALAR  ) then<a name='2759'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2760'></font>
<font color=#447700>! see above<a name='2761'></font>
<font color=#447700>!--------------------------------------------------------------<a name='2762'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_MOIST' )<a name='2763'>
     IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2764'>
#      include "<A href='../../html_code/include/HALO_EM_MOIST_E_3.inc.html'>HALO_EM_MOIST_E_3.inc</A>"<A NAME="HALO_EM_MOIST_E_3.inc_52"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2765'>
     ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2766'>
#      include "<A href='../../html_code/include/HALO_EM_MOIST_E_5.inc.html'>HALO_EM_MOIST_E_5.inc</A>"<A NAME="HALO_EM_MOIST_E_5.inc_53"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2767'>
     ELSE<a name='2768'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2769'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_46">(TRIM(wrf_err_message))<a name='2770'>
     ENDIF<a name='2771'>
   endif<a name='2772'>
   if ( num_chem &gt;= PARAM_FIRST_SCALAR ) then<a name='2773'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2774'></font>
<font color=#447700>! see above<a name='2775'></font>
<font color=#447700>!--------------------------------------------------------------<a name='2776'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_CHEM' )<a name='2777'>
     IF      ( h_mom_adv_order &lt;= 4 ) THEN<a name='2778'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_54"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2779'>
     ELSE IF ( h_mom_adv_order &lt;= 6 ) THEN<a name='2780'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_5.inc.html'>HALO_EM_CHEM_E_5.inc</A>"<A NAME="HALO_EM_CHEM_E_5.inc_55"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2781'>
     ELSE<a name='2782'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',h_mom_adv_order<a name='2783'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_47">(TRIM(wrf_err_message))<a name='2784'>
     ENDIF<a name='2785'>
   endif<a name='2786'>
#endif<a name='2787'>
<a name='2788'>
<font color=#447700>! add diagnoses. hans_xyh huang.<a name='2789'></font>
<a name='2790'>
   DO ij = 1 , grid%num_tiles<a name='2791'>
<a name='2792'>
     call <A href='../../html_code/dyn_em/addroutines.F.html#CALC_DPSDT'>calc_dpsdt</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_DPSDT_1"> ( itimestep, dt, psfc, psfcm, 'ps', &amp;<a name='2793'>
                       avg_abs_dpsdt, dpsdt,             &amp;<a name='2794'>
                       ids, ide, jds, jde,               &amp;<a name='2795'>
                       ims, ime, jms, jme,               &amp;<a name='2796'>
                       grid%i_start(ij), grid%i_end(ij), &amp;<a name='2797'>
                       grid%j_start(ij), grid%j_end(ij)  )<a name='2798'>
     call <A href='../../html_code/dyn_em/addroutines.F.html#CALC_DPSDT'>calc_dpsdt</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_DPSDT_2"> ( itimestep, dt, mu_2, mu_1, 'mu',  &amp;<a name='2799'>
                       avg_abs_dmudt, dmudt,             &amp;<a name='2800'>
                       ids, ide, jds, jde,               &amp;<a name='2801'>
                       ims, ime, jms, jme,               &amp;<a name='2802'>
                       grid%i_start(ij), grid%i_end(ij), &amp;<a name='2803'>
                       grid%j_start(ij), grid%j_end(ij)  )<a name='2804'>
<a name='2805'>
     call <A href='../../html_code/dyn_em/addroutines.F.html#CALC_Q_CONV_3D'>calc_q_conv_3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_Q_CONV_3D_1"> ( moist_1, moist_2, dt,             &amp;<a name='2806'>
                           q_conve_3d,                       &amp;<a name='2807'>
                           num_3d_m,                         &amp;<a name='2808'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='2809'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='2810'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='2811'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='2812'>
                           k_start, k_end                    )<a name='2813'>
     call <A href='../../html_code/dyn_em/addroutines.F.html#CALC_Q_CONV_2D'>calc_q_conv_2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_Q_CONV_2D_1"> ( moist_2, u_2, v_2,                &amp;<a name='2814'>
                           dt, DX, q_conve_2d,               &amp;<a name='2815'>
                           num_3d_m,                         &amp;<a name='2816'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='2817'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='2818'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='2819'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='2820'>
                           k_start, k_end                    )<a name='2821'>
<a name='2822'>
   ENDDO<a name='2823'>
<a name='2824'>
   CALL wrf_debug ( 200 , ' call end of solve_em' )<a name='2825'>
<a name='2826'>
<font color=#447700>! Finish timers if compiled with -DBENCH.<a name='2827'></font>
#include &lt;<A href='../../html_code/include/bench_solve_em_end.h.html'>bench_solve_em_end.h</A>&gt;<A NAME="bench_solve_em_end.h_56"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2828'>
<a name='2829'>
<font color=#447700>! See comment before earlier #include of this file.<a name='2830'></font>
#define COPY_OUT<a name='2831'>
#include &lt;<A href='../../html_code/include/em_scalar_derefs.inc.html'>em_scalar_derefs.inc</A>&gt;<A NAME="em_scalar_derefs.inc_57"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2832'>
<a name='2833'>
   if(grid%trace_use) call <A href='../../html_code/frame/module_trace.F.html#TRACE_EXIT'>trace_exit</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRACE_EXIT_103">("solve_em")<a name='2834'>
<a name='2835'>
   RETURN<a name='2836'>
<a name='2837'>
END SUBROUTINE solve_em<a name='2838'>
</pre></body></html>