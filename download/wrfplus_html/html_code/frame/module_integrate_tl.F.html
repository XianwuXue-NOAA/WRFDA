<HTML> <BODY BGCOLOR=#eeddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:DRIVER_LAYER:INTEGRATION<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='MODULE_INTEGRATE_TL'><A href='../../html_code/frame/module_integrate_tl.F.html#MODULE_INTEGRATE_TL' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_integrate_tl</font> <A href='../../call_to/MODULE_INTEGRATE_TL.html' TARGET='index'>1</A><a name='6'>
<a name='7'>
CONTAINS<a name='8'>
<a name='9'>
<A NAME='INTEGRATE_TL'><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='10'>
RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>integrate_tl</font> ( grid, nl_date_string, nl_date_index ) <A href='../../call_to/INTEGRATE_TL.html' TARGET='index'>2</A>,<A href='../../call_from/INTEGRATE_TL.html' TARGET='index'>74</A><a name='11'>
<a name='12'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_49"><a name='13'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_14"><a name='14'>
   USE <A href='../../html_code/frame/module_nesting.F.html#MODULE_NESTING'>module_nesting</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_NESTING_4"><a name='15'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_61"><a name='16'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_12"><a name='17'>
#ifdef DM_PARALLEL<a name='18'>
#ifndef DISK_IO<a name='19'>
   USE <A href='../../html_code/frame/module_linked_lisk.F.html#MODULE_LINKED_LIST'>module_linked_list</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LINKED_LIST_2">, only: pop2restore<a name='20'>
#endif<a name='21'>
#endif<a name='22'>
   USE WRF_ESMF_MOD<a name='23'>
   <a name='24'>
   USE <A href='../../html_code/frame/module_dfi.F.html#MODULE_DFI'>module_dfi</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DFI_2">   <a name='25'>
<a name='26'>
   USE <A href='../../html_code/frame/module_trace.F.html#MODULE_TRACE'>module_trace</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TRACE_16">, only : trace_entry, trace_exit<a name='27'>
<a name='28'>
   IMPLICIT NONE<a name='29'>
<a name='30'>
   <font color=#447700>!  Input data.<a name='31'></font>
<a name='32'>
   TYPE(domain) , POINTER :: grid<a name='33'>
<a name='34'>
   character(len=19), dimension(1000), intent(in)    :: nl_date_string<a name='35'>
   integer,                            intent(inout) :: nl_date_index<a name='36'>
<a name='37'>
<font color=#447700>! module_integrate:integrate<a name='38'></font>
<font color=#447700>! &lt;DESCRIPTION&gt; <a name='39'></font>
<font color=#447700>! This is a driver-level routine that controls the integration of a<a name='40'></font>
<font color=#447700>! domain and subdomains rooted at the domain. <a name='41'></font>
<font color=#447700>! <a name='42'></font>
<font color=#447700>! The integrate routine takes a domain pointed to by the argument<a name='43'></font>
<font color=#447700>! &lt;em&gt;grid&lt;/em&gt; and advances the domain and its associated nests from the<a name='44'></font>
<font color=#447700>! grid's current time, stored as grid%current_time, to a given time<a name='45'></font>
<font color=#447700>! forward in the simulation, stored as grid%stop_subtime. The<a name='46'></font>
<font color=#447700>! stop_subtime value is arbitrary and does not have to be the same as<a name='47'></font>
<font color=#447700>! time that the domain finished integrating.  The simulation stop time<a name='48'></font>
<font color=#447700>! for the grid is known to the grid's clock (grid%domain_clock) and that<a name='49'></font>
<font color=#447700>! is checked with a call to ESMF_ClockIsStopTime prior to beginning the<a name='50'></font>
<font color=#447700>! loop over time period that is specified by the<a name='51'></font>
<font color=#447700>! current_time/stop_subtime interval.<a name='52'></font>
<font color=#447700>! <a name='53'></font>
<font color=#447700>! The clock, the simulation stop time for the domain, and other timing<a name='54'></font>
<font color=#447700>! aspects for the grid are set up in the routine<a name='55'></font>
<font color=#447700>! (&lt;a href="setup_timekeeping.html"&gt;setup_timekeeping&lt;/a&gt;) at the time<a name='56'></font>
<font color=#447700>! that the domain is initialized.<a name='57'></font>
<font color=#447700>! The lower-level time library and the type declarations for the times<a name='58'></font>
<font color=#447700>! and time intervals used are defined in external/esmf_time_f90 which, <a name='59'></font>
<font color=#447700>! depending on build-time options, either incorporates the embedded ESMF <a name='60'></font>
<font color=#447700>! subset implementation contained in that directory or incorporates a <a name='61'></font>
<font color=#447700>! site-specific installation of the ESMF library.  Note that arithmetic and <a name='62'></font>
<font color=#447700>! comparison is performed on these data types using F90 operator overloading, <a name='63'></font>
<font color=#447700>! also defined in that library.<a name='64'></font>
<font color=#447700>! <a name='65'></font>
<font color=#447700>! This routine is the lowest level of the WRF Driver Layer and for the most<a name='66'></font>
<font color=#447700>! part the WRF routines that are called from here are in the topmost level<a name='67'></font>
<font color=#447700>! of the Mediation Layer.  Mediation layer routines typically are not <a name='68'></font>
<font color=#447700>! defined in modules. Therefore, the routines that this routine calls<a name='69'></font>
<font color=#447700>! have explicit interfaces specified in an interface block in this routine.<a name='70'></font>
<font color=#447700>!<a name='71'></font>
<font color=#447700>! As part of the Driver Layer, this routine is intended to be non model-specific<a name='72'></font>
<font color=#447700>! and so a minimum of WRF-specific logic is coded at this level. Rather, there<a name='73'></font>
<font color=#447700>! are a number of calls to mediation layer routines that contain this logic, some<a name='74'></font>
<font color=#447700>! of which are merely stubs in WRF Mediation Layer that sits below this routine<a name='75'></font>
<font color=#447700>! in the call tree.  The routines that integrate calls in WRF are defined in<a name='76'></font>
<font color=#447700>! share/mediation_integrate.F.<a name='77'></font>
<font color=#447700>! <a name='78'></font>
<font color=#447700>! Flow of control<a name='79'></font>
<font color=#447700>! <a name='80'></font>
<font color=#447700>! 1. Check to see that the domain is not finished <a name='81'></font>
<font color=#447700>! by testing the value returned by ESMF_ClockIsStopTime for the<a name='82'></font>
<font color=#447700>! domain.<a name='83'></font>
<font color=#447700>! <a name='84'></font>
<font color=#447700>! 2. &lt;a href=model_to_grid_config_rec.html&gt;Model_to_grid_config_rec&lt;/a&gt; is called to load the local config_flags<a name='85'></font>
<font color=#447700>! structure with the configuration information for the grid stored<a name='86'></font>
<font color=#447700>! in model_config_rec and indexed by the grid's unique integer id. These<a name='87'></font>
<font color=#447700>! structures are defined in frame/module_configure.F.<a name='88'></font>
<font color=#447700>! <a name='89'></font>
<font color=#447700>! 3. The current time of the domain is retrieved from the domain's clock<a name='90'></font>
<font color=#447700>! using ESMF_ClockGet.  There is another call to ESMF_ClockGet<a name='91'></font>
<font color=#447700>! inside the WHILE loop that follows.<a name='92'></font>
<font color=#447700>! <a name='93'></font>
<font color=#447700>! 4. Iterate forward while the current time is less than the stop subtime.<a name='94'></font>
<font color=#447700>! <a name='95'></font>
<font color=#447700>! 4.a. Start timing for this iteration (only on node zero in distributed-memory runs)<a name='96'></font>
<font color=#447700>! <a name='97'></font>
<font color=#447700>! 4.b. Call &lt;a href=med_setup_step.html&gt;med_setup_step&lt;/a&gt; to allow the mediation layer to <a name='98'></font>
<font color=#447700>! do anything that's needed to call the solver for this domain.  In WRF this means setting<a name='99'></font>
<font color=#447700>! the indices into the 4D tracer arrays for the domain.<a name='100'></font>
<font color=#447700>! <a name='101'></font>
<font color=#447700>! 4.c. Check for any nests that need to be started up at this time.  This is done <a name='102'></font>
<font color=#447700>! calling the logical function &lt;a href=nests_to_open.html&gt;nests_to_open&lt;/a&gt; (defined in <a name='103'></font>
<font color=#447700>! frame/module_nesting.F) which returns true and the index into the current domain's list<a name='104'></font>
<font color=#447700>! of children to use for the nest when one needs to be started.<a name='105'></font>
<font color=#447700>! <a name='106'></font>
<font color=#447700>! 4.c.1  Call &lt;a href=alloc_and_configure_domain.html&gt;alloc_and_configure_domain&lt;/a&gt; to allocate<a name='107'></font>
<font color=#447700>! the new nest and link it as a child of this grid.<a name='108'></font>
<font color=#447700>! <a name='109'></font>
<font color=#447700>! 4.c.2  Call &lt;a href=setup_Timekeeping.html&gt;setup_Timekeeping&lt;/a&gt; for the nest.<a name='110'></font>
<font color=#447700>! <a name='111'></font>
<font color=#447700>! 4.c.3  Initialize the nest's arrays by calling &lt;a href=med_nest_initial.html&gt;med_nest_initial&lt;/a&gt;. This will<a name='112'></font>
<font color=#447700>! either interpolate data from this grid onto the nest, read it in from a file, or both. In a restart run, this<a name='113'></font>
<font color=#447700>! is also where the nest reads in its restart file.<a name='114'></font>
<font color=#447700>! <a name='115'></font>
<font color=#447700>! 4.d  If a nest was opened above, check for and resolve overlaps (this is not implemented in WRF 2.0, which<a name='116'></font>
<font color=#447700>! supports multiple nests on the same level but does not support overlapping).<a name='117'></font>
<font color=#447700>! <a name='118'></font>
<font color=#447700>! 4.e  Give the mediation layer an opportunity to do something before the solver is called by<a name='119'></font>
<font color=#447700>! calling &lt;a href=med_before_solve_io.html&gt;med_before_solve_io&lt;/a&gt;. In WRF this is the point at which history and<a name='120'></font>
<font color=#447700>! restart data is output.<a name='121'></font>
<font color=#447700>! <a name='122'></font>
<font color=#447700>! 4.f  Call &lt;a href=solve_interface_tl.html&gt;solve_interface_tl&lt;/a&gt; which calls the solver that advance the domain <a name='123'></font>
<font color=#447700>! one time step, then advance the domain's clock by calling ESMF_ClockAdvance.  Upon advancing the clock,<a name='124'></font>
<font color=#447700>! the current time for the grid is updated by calling ESMF_ClockGet. The enclosing WHILE loop around<a name='125'></font>
<font color=#447700>! this section is for handling other domains with which this domain may overlap.  It is not active in WRF 2.0 and<a name='126'></font>
<font color=#447700>! only executes one trip.  <a name='127'></font>
<font color=#447700>! <a name='128'></font>
<font color=#447700>! 4.g Call med_calc_model_time and med_after_solve_io, which are stubs in WRF.<a name='129'></font>
<font color=#447700>! <a name='130'></font>
<font color=#447700>! 4.h Iterate over the children of this domain (&lt;tt&gt;DO kid = 1, max_nests&lt;/tt&gt;) and check each child pointer to see<a name='131'></font>
<font color=#447700>! if it is associated (and therefore, active).<a name='132'></font>
<font color=#447700>! <a name='133'></font>
<font color=#447700>! 4.h.1  Force the nested domain boundaries from this domain by calling &lt;a href=med_nest_force.html&gt;med_nest_force&lt;/a&gt;.<a name='134'></font>
<font color=#447700>! <a name='135'></font>
<font color=#447700>! 4.h.2  Setup the time period over which the nest is to run. Sine the current grid has been advanced one time step<a name='136'></font>
<font color=#447700>! and the nest has not, the start for the nest is this grid's current time minus one time step.  The nest's stop_subtime<a name='137'></font>
<font color=#447700>! is the current time, bringing the nest up the same time level as this grid, its parent.<a name='138'></font>
<font color=#447700>! <a name='139'></font>
<font color=#447700>! 4.h.3  Recursively call this routine, integrate, to advance the nest's time.  Since it is recursive, this will<a name='140'></font>
<font color=#447700>! also advance all the domains who are nests of this nest and so on.  In other words, when this call returns, all<a name='141'></font>
<font color=#447700>! the domains rooted at the nest will be at the current time.<a name='142'></font>
<font color=#447700>! <a name='143'></font>
<font color=#447700>! 4.h.4  Feedback data from the nested domain back onto this domain by calling &lt;a href=med_nest_feedback.html&gt;med_nest_feedback&lt;/a&gt;.<a name='144'></font>
<font color=#447700>! <a name='145'></font>
<font color=#447700>! 4.i  Write the time to compute this grid and its subtree. This marks the end of the loop begun at step 4, above.<a name='146'></font>
<font color=#447700>! <a name='147'></font>
<font color=#447700>! 5. Give the mediation layer an opportunity to do I/O at the end of the sequence of steps that brought the<a name='148'></font>
<font color=#447700>! grid up to stop_subtime with a call to &lt;a href=med_last_solve_io.html&gt;med_last_solve_io&lt;/a&gt;.  In WRF, this <a name='149'></font>
<font color=#447700>! is used to generate the final history and/or restart output when the domain reaches the end of it's integration.<a name='150'></font>
<font color=#447700>! There is logic here to make sure this occurs correctly on a nest, since the nest may finish before its parent.<a name='151'></font>
<font color=#447700>! &lt;/DESCRIPTION&gt;<a name='152'></font>
<a name='153'>
   <font color=#447700>!  Local data.<a name='154'></font>
<a name='155'>
   CHARACTER*32                           :: outname, rstname<a name='156'>
   TYPE(domain) , POINTER                 :: grid_ptr , new_nest<a name='157'>
   TYPE(domain)                           :: intermediate_grid<a name='158'>
   INTEGER                                :: step<a name='159'>
   INTEGER                                :: nestid , kid<a name='160'>
   LOGICAL                                :: a_nest_was_opened<a name='161'>
   INTEGER                                :: fid , rid<a name='162'>
   LOGICAL                                :: lbc_opened<a name='163'>
   REAL                                   :: time, btime, bfrq<a name='164'>
   CHARACTER*256                          :: message, message2<a name='165'>
   TYPE (grid_config_rec_type)            :: config_flags<a name='166'>
   LOGICAL , EXTERNAL                     :: wrf_dm_on_monitor<a name='167'>
   INTEGER                                :: idum1 , idum2 , ierr , open_status<a name='168'>
   INTEGER                                :: rc ,dfi_counter<a name='169'>
<a name='170'>
   CHARACTER (LEN=25)                     :: currTime_str, tmpTime_str<a name='171'>
<a name='172'>
   <font color=#447700>! interface<a name='173'></font>
   INTERFACE<a name='174'>
       <font color=#447700>! mediation-supplied solver<a name='175'></font>
     SUBROUTINE solve_interface_tl ( grid )<a name='176'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_50"><a name='177'>
       TYPE (domain) grid<a name='178'>
     END SUBROUTINE solve_interface_tl<a name='179'>
       <font color=#447700>! mediation-supplied routine to allow driver to pass time information<a name='180'></font>
       <font color=#447700>! down to mediation/model layer<a name='181'></font>
     SUBROUTINE med_calc_model_time ( grid , config_flags )<a name='182'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_51"><a name='183'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_62"><a name='184'>
       TYPE (domain) grid<a name='185'>
       TYPE (grid_config_rec_type) config_flags<a name='186'>
     END SUBROUTINE med_calc_model_time<a name='187'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='188'></font>
       <font color=#447700>! perform I/O before the call to the solve routine<a name='189'></font>
     SUBROUTINE med_before_solve_io ( grid , config_flags )<a name='190'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_52"><a name='191'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_63"><a name='192'>
       TYPE (domain) grid<a name='193'>
       TYPE (grid_config_rec_type) config_flags<a name='194'>
     END SUBROUTINE med_before_solve_io<a name='195'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='196'></font>
       <font color=#447700>! perform I/O after the call to the solve routine<a name='197'></font>
     SUBROUTINE med_after_solve_io ( grid , config_flags )<a name='198'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_53"><a name='199'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_64"><a name='200'>
       TYPE (domain) grid<a name='201'>
       TYPE (grid_config_rec_type) config_flags<a name='202'>
     END SUBROUTINE med_after_solve_io<a name='203'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='204'></font>
       <font color=#447700>! perform I/O to initialize a new nest<a name='205'></font>
     SUBROUTINE med_nest_initial ( parent , grid , config_flags )<a name='206'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_54"><a name='207'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_65"><a name='208'>
       TYPE (domain), POINTER ::  grid , parent<a name='209'>
       TYPE (grid_config_rec_type) config_flags<a name='210'>
     END SUBROUTINE med_nest_initial<a name='211'>
<a name='212'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='213'></font>
       <font color=#447700>! provide parent-&gt;nest forcing<a name='214'></font>
     SUBROUTINE med_nest_force ( parent , grid , config_flags )<a name='215'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_55"><a name='216'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_66"><a name='217'>
       TYPE (domain), POINTER ::  grid , parent<a name='218'>
       TYPE (grid_config_rec_type) config_flags<a name='219'>
     END SUBROUTINE med_nest_force<a name='220'>
<a name='221'>
#ifdef MOVE_NESTS<a name='222'>
     SUBROUTINE med_nest_move ( parent , grid )<a name='223'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_56"><a name='224'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_67"><a name='225'>
       TYPE (domain), POINTER ::  grid , parent<a name='226'>
     END SUBROUTINE med_nest_move<a name='227'>
#endif<a name='228'>
<a name='229'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='230'></font>
       <font color=#447700>! provide parent-&gt;nest feedback<a name='231'></font>
     SUBROUTINE med_nest_feedback ( parent , grid , config_flags )<a name='232'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_57"><a name='233'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_68"><a name='234'>
       TYPE (domain), POINTER ::  grid , parent<a name='235'>
       TYPE (grid_config_rec_type) config_flags<a name='236'>
     END SUBROUTINE med_nest_feedback<a name='237'>
<a name='238'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='239'></font>
       <font color=#447700>! perform I/O prior to the close of this call to integrate<a name='240'></font>
     SUBROUTINE med_last_solve_io ( grid , config_flags )<a name='241'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_58"><a name='242'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_69"><a name='243'>
       TYPE (domain) grid<a name='244'>
       TYPE (grid_config_rec_type) config_flags<a name='245'>
     END SUBROUTINE med_last_solve_io<a name='246'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='247'></font>
       <font color=#447700>! perform setup before iteration over steps in this call to integrate<a name='248'></font>
     SUBROUTINE med_setup_step ( grid , config_flags )<a name='249'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_59"><a name='250'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_70"><a name='251'>
       TYPE (domain) grid<a name='252'>
       TYPE (grid_config_rec_type) config_flags<a name='253'>
     END SUBROUTINE med_setup_step<a name='254'>
       <font color=#447700>! mediation-supplied routine that intializes the nest from the grid<a name='255'></font>
       <font color=#447700>! by interpolation<a name='256'></font>
<a name='257'>
     SUBROUTINE Setup_Timekeeping( grid )<a name='258'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_60"><a name='259'>
       TYPE(domain), POINTER :: grid<a name='260'>
     END SUBROUTINE<a name='261'>
<a name='262'>
   END INTERFACE<a name='263'>
<a name='264'>
   if(grid%trace_use) call <A href='../../html_code/frame/module_trace.F.html#TRACE_ENTRY'>trace_entry</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRACE_ENTRY_107">("integrate_tl")<a name='265'>
<a name='266'>
   IF ( .NOT. ESMF_ClockIsStopTime(grid%domain_clock ,rc=rc) ) THEN<a name='267'>
      CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_13"> ( grid%id , model_config_rec , config_flags )<a name='268'>
      CALL ESMF_ClockGet( grid%domain_clock, currTime=grid%current_time, rc=rc )<a name='269'>
      CALL <A href='../../html_code/share/module_date_time.F.html#WRF_CLOCKPRINT'>wrf_clockprint</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_CLOCKPRINT_10"> ( 150, grid%domain_clock, &amp;<a name='270'>
                            'DEBUG:  top of integrate_tl(),' )<a name='271'>
<a name='272'>
      CALL ESMF_TimeIntervalPrint(grid%domain_clock%TimeStep, 'DEBUG:  integrate_tl.', rc)<a name='273'>
      CALL print_a_timeinterval(grid%domain_clock%TimeStep)<a name='274'>
      if ( grid%jcdfi_io) then<a name='275'>
         CALL <A href='../../html_code/frame/module_dfi.F.html#JCDFI_INIT_COEF'>jcdfi_init_coef</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="JCDFI_INIT_COEF_2"> ( grid , config_flags )<a name='276'>
         CALL <A href='../../html_code/frame/module_dfi.F.html#JCDFI_ZERO_AD'>jcdfi_zero_ad</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="JCDFI_ZERO_AD_1"> ( grid )<a name='277'>
         dfi_counter = 0<a name='278'>
         CALL <A href='../../html_code/frame/module_dfi.F.html#JCDFI_TL'>jcdfi_tl</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="JCDFI_TL_1"> ( grid, dfi_counter )<a name='279'>
      endif<a name='280'>
      DO WHILE ( grid%current_time .LT. grid%stop_subtime )<a name='281'>
<font color=#447700>!         IF ( wrf_dm_on_monitor() ) THEN<a name='282'></font>
           CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_7"><a name='283'>
<font color=#447700>!         END IF<a name='284'></font>
         CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_SETUP_STEP'>med_setup_step</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_SETUP_STEP_3"> ( grid , config_flags )<a name='285'>
         a_nest_was_opened = .false.<a name='286'>
         <font color=#447700>! for each nest whose time has come...<a name='287'></font>
         DO WHILE ( nests_to_open( grid , nestid , kid ) )<a name='288'>
            <font color=#447700>! nestid is index into model_config_rec (module_configure) of the grid<a name='289'></font>
            <font color=#447700>! to be opened; kid is index into an open slot in grid's list of children<a name='290'></font>
            a_nest_was_opened = .true.<a name='291'>
            CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_AND_CONFIGURE_DOMAIN'>alloc_and_configure_domain</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_AND_CONFIGURE_DOMAIN_3"> ( domain_id  = nestid ,                          &amp;<a name='292'>
                                              grid       = new_nest ,                        &amp;<a name='293'>
                                              parent     = grid ,                            &amp;<a name='294'>
                                              kid        = kid                               )<a name='295'>
            CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_3"> (new_nest)<a name='296'>
            CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL'>med_nest_initial</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_INITIAL_3"> ( grid , new_nest , config_flags )<a name='297'>
         END DO<a name='298'>
         IF ( a_nest_was_opened ) THEN<a name='299'>
            CALL <A href='../../html_code/frame/module_nesting.F.html#SET_OVERLAPS'>set_overlaps</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_OVERLAPS_3"> ( grid )   <font color=#447700>! find overlapping and set pointers<a name='300'></font>
         END IF<a name='301'>
         CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO'>med_before_solve_io</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_BEFORE_SOLVE_IO_2"> ( grid , config_flags )<a name='302'>
         grid_ptr =&gt; grid<a name='303'>
         DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='304'>
<a name='305'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_76">( 100 , 'module_integrate_tl: calling solve interface _tl' )<a name='306'>
<a name='307'>
            CALL <A href='../../html_code/share/module_date_time.F.html#WRF_CLOCKPRINT'>wrf_clockprint</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_CLOCKPRINT_11"> ( 150, grid%domain_clock, 'DEBUG:  integrate_tl(),' )<a name='308'>
<a name='309'>
            CALL <A href='../../html_code/share/module_date_time.F.html#WRF_TIMETOA'>wrf_timetoa</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_TIMETOA_7">( grid%current_time, currTime_str )<a name='310'>
<a name='311'>
            if(currTime_str(1:19) .eq. nl_date_string(nl_date_index)(1:19)) then<a name='312'>
<a name='313'>
<font color=#447700>!!!!  for exactly trajectory update   08/02/2006   Xin Zhang<a name='314'></font>
<font color=#447700>!!!!           CALL med_auxinput2_in ( grid , config_flags , nl_date_string(nl_date_index) )<a name='315'></font>
#ifdef DM_PARALLEL<a name='316'>
#ifndef DISK_IO<a name='317'>
               call <A href='../../html_code/frame/module_linked_lisk.F.html#POP2RESTORE'>pop2restore</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP2RESTORE_1">(grid%moist_2,"moist_2")<a name='318'>
               call <A href='../../html_code/frame/module_linked_lisk.F.html#POP2RESTORE'>pop2restore</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP2RESTORE_2">(grid%em_u_2, grid%em_v_2, grid%em_w_2, grid%em_ph_2, grid%em_t_2, "u_2, v_2, w_2, ph_2, t_2")<a name='319'>
               call <A href='../../html_code/frame/module_linked_lisk.F.html#POP2RESTORE'>pop2restore</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP2RESTORE_3">(grid%em_mu_2,grid%em_mu0,"mu_2, mu0")<a name='320'>
#else<a name='321'>
               CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT2_IN4AD'>med_auxinput2_in4ad</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_AUXINPUT2_IN4AD_4"> ( grid , config_flags , nl_date_string(nl_date_index) )<a name='322'>
#endif<a name='323'>
#else<a name='324'>
               CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT2_IN4AD'>med_auxinput2_in4ad</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_AUXINPUT2_IN4AD_5"> ( grid , config_flags , nl_date_string(nl_date_index) )<a name='325'>
#endif<a name='326'>
               nl_date_index = nl_date_index + 1<a name='327'>
<a name='328'>
            else<a name='329'>
<a name='330'>
<font color=#447700>!!!!  for Non-exactly trajectory update   08/02/2006   Xin Zhang<a name='331'></font>
<font color=#447700>!!!!          CALL med_auxinput2_in ( grid , config_flags , nl_date_string(nl_date_index-1) )<a name='332'></font>
              CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT2_IN4AD'>med_auxinput2_in4ad</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_AUXINPUT2_IN4AD_6"> ( grid , config_flags , nl_date_string(nl_date_index-1) )<a name='333'>
<a name='334'>
            endif<a name='335'>
<a name='336'>
            CALL <A href='../../html_code/share/solve_interface_tl.F.html#SOLVE_INTERFACE_TL'>solve_interface_tl</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOLVE_INTERFACE_TL_1"> ( grid_ptr ) <a name='337'>
            CALL <A href='../../html_code/share/module_date_time.F.html#WRF_CLOCKPRINT'>wrf_clockprint</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_CLOCKPRINT_12"> ( 150, grid_ptr%domain_clock, &amp;<a name='338'>
                                  'DEBUG integrate_tl():  before ESMF_ClockAdvance,' )<a name='339'>
            CALL ESMF_ClockAdvance( grid_ptr%domain_clock, rc=rc )<a name='340'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_CHECK_ERROR'>wrf_check_error</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_CHECK_ERROR_3">( ESMF_SUCCESS, rc, &amp;<a name='341'>
                                  'ESMF_ClockAdvance() FAILED', &amp;<a name='342'>
                                  __FILE__ , &amp;<a name='343'>
                                  __LINE__  )<a name='344'>
            CALL <A href='../../html_code/share/module_date_time.F.html#WRF_CLOCKPRINT'>wrf_clockprint</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_CLOCKPRINT_13"> ( 150, grid_ptr%domain_clock, &amp;<a name='345'>
                                  'DEBUG integrate_tl():  after ESMF_ClockAdvance,' )<a name='346'>
            CALL ESMF_ClockGet( grid_ptr%domain_clock, currTime=grid_ptr%current_time, rc=rc )<a name='347'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_77">( 100 , 'module_integrate_tl: back from solve interface _tl' )<a name='348'>
            grid_ptr =&gt; grid_ptr%sibling<a name='349'>
         END DO<a name='350'>
         CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_CALC_MODEL_TIME'>med_calc_model_time</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_CALC_MODEL_TIME_2"> ( grid , config_flags )<a name='351'>
         CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_AFTER_SOLVE_IO'>med_after_solve_io</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_AFTER_SOLVE_IO_2"> ( grid , config_flags )<a name='352'>
         grid_ptr =&gt; grid<a name='353'>
         DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='354'>
            DO kid = 1, max_nests<a name='355'>
              IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='356'>
                <font color=#447700>! Recursive -- advance nests from previous time level to this time level.<a name='357'></font>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_78">( 100 , 'module_integrate_tl: calling med_nest_force ' )<a name='358'>
                CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FORCE'>med_nest_force</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_FORCE_3"> ( grid_ptr , grid_ptr%nests(kid)%ptr , config_flags )<a name='359'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_79">( 100 , 'module_integrate_tl: back from med_nest_force ' )<a name='360'>
                grid_ptr%nests(kid)%ptr%start_subtime = grid%current_time - grid%step_time<a name='361'>
                grid_ptr%nests(kid)%ptr%stop_subtime = grid%current_time<a name='362'>
                CALL <A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL'>integrate_tl</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTEGRATE_TL_1"> ( grid_ptr%nests(kid)%ptr, nl_date_string, nl_date_index ) <a name='363'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_80">( 100 , 'module_integrate_tl: back from recursive call to integrate_tl ' )<a name='364'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_81">( 100 , 'module_integrate_tl: calling med_nest_feedback ' )<a name='365'>
                CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK'>med_nest_feedback</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_FEEDBACK_3"> ( grid_ptr , grid_ptr%nests(kid)%ptr , config_flags )<a name='366'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_82">( 100 , 'module_integrate_tl: back from med_nest_feedback ' )<a name='367'>
#ifdef MOVE_NESTS<a name='368'>
                CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_MOVE'>med_nest_move</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_MOVE_3"> ( grid_ptr , grid_ptr%nests(kid)%ptr )<a name='369'>
#endif<a name='370'>
              END IF<a name='371'>
            END DO<a name='372'>
            grid_ptr =&gt; grid_ptr%sibling<a name='373'>
         END DO<a name='374'>
         <font color=#447700>!  Report on the timing for a single time step.<a name='375'></font>
<font color=#447700>!         IF ( wrf_dm_on_monitor() ) THEN<a name='376'></font>
           CALL <A href='../../html_code/share/module_date_time.F.html#WRF_TIMETOA'>wrf_timetoa</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_TIMETOA_8"> ( grid%current_time, message2 )<a name='377'>
           WRITE ( message , FMT = '("main: time ",A," on domain ",I3)' ) TRIM(message2), grid%id<a name='378'>
           CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_7"> ( TRIM(message) )<a name='379'>
<font color=#447700>!         END IF<a name='380'></font>
         if ( grid%jcdfi_io) then<a name='381'>
            dfi_counter = dfi_counter + 1<a name='382'>
            CALL <A href='../../html_code/frame/module_dfi.F.html#JCDFI_TL'>jcdfi_tl</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="JCDFI_TL_2"> ( grid, dfi_counter )<a name='383'>
         endif<a name='384'>
      END DO<a name='385'>
      if ( grid%jcdfi_io) then<a name='386'>
         CALL <A href='../../html_code/frame/module_dfi.F.html#JCDFI_OUTPUT_FORCING'>jcdfi_output_forcing</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="JCDFI_OUTPUT_FORCING_1"> ( grid ,config_flags )<a name='387'>
         CALL <A href='../../html_code/frame/module_dfi.F.html#JCDFI_FINALIZE'>jcdfi_finalize</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="JCDFI_FINALIZE_2"><a name='388'>
      endif<a name='389'>
      <font color=#447700>! Avoid double writes on nests if this is not really the last time;<a name='390'></font>
      <font color=#447700>! Do check for write if the parent domain is ending.<a name='391'></font>
<font color=#447700>!-----Need to check how to output tl variables.<a name='392'></font>
      IF ( grid%id .EQ. 1 ) THEN               <font color=#447700>! head_grid<a name='393'></font>
        CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO'>med_last_solve_io</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_LAST_SOLVE_IO_3"> ( grid , config_flags )<a name='394'>
      ELSE<a name='395'>
        IF ( ESMF_ClockIsStopTime(grid%domain_clock , rc=rc) .OR. &amp;<a name='396'>
             ESMF_ClockIsStopTime(grid%parents(1)%ptr%domain_clock , rc=rc ) ) THEN<a name='397'>
           CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO'>med_last_solve_io</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_LAST_SOLVE_IO_4"> ( grid , config_flags )<a name='398'>
        ENDIF<a name='399'>
      ENDIF<a name='400'>
   END IF<a name='401'>
<a name='402'>
   if(grid%trace_use) call <A href='../../html_code/frame/module_trace.F.html#TRACE_EXIT'>trace_exit</A><A href='../../html_code/frame/module_integrate_tl.F.html#INTEGRATE_TL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRACE_EXIT_107">("integrate_tl")<a name='403'>
<a name='404'>
END SUBROUTINE integrate_tl<a name='405'>
<a name='406'>
END MODULE module_integrate_tl<a name='407'>
<a name='408'>
</pre></body></html>