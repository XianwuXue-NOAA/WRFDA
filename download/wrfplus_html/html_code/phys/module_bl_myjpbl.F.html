<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_BL_MYJPBL'><A href='../../html_code/phys/module_bl_myjpbl.F.html#MODULE_BL_MYJPBL' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
      <font color=#993300>MODULE </font><font color=#cc0000>MODULE_BL_MYJPBL</font> <A href='../../call_to/MODULE_BL_MYJPBL.html' TARGET='index'>2</A><a name='5'>
<font color=#447700>!<a name='6'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='7'></font>
<font color=#447700>!<a name='8'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/phys/module_bl_myjpbl.F.html#module_bl_myjpbl.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_32"><a name='9'>
<font color=#447700>!<a name='10'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='11'></font>
<font color=#447700>!<a name='12'></font>
<font color=#447700>! REFERENCES:  Janjic (2001), NCEP Office Note 437<a name='13'></font>
<font color=#447700>!              Mellor and Yamada (1982), Rev. Geophys. Space Phys.<a name='14'></font>
<font color=#447700>!              Mellor and Yamada (1974), J. Atmos. Sci.<a name='15'></font>
<font color=#447700>!<a name='16'></font>
<font color=#447700>! ABSTRACT:<a name='17'></font>
<font color=#447700>!     MYJ UPDATES THE TURBULENT KINETIC ENERGY WITH THE PRODUCTION/<a name='18'></font>
<font color=#447700>!     DISSIPATION TERM AND THE VERTICAL DIFFUSION TERM<a name='19'></font>
<font color=#447700>!     (USING AN IMPLICIT FORMULATION) FROM MELLOR-YAMADA<a name='20'></font>
<font color=#447700>!     LEVEL 2.5 AS EXTENDED BY JANJIC.  EXCHANGE COEFFICIENTS FOR<a name='21'></font>
<font color=#447700>!     THE SURFACE AND FOR ALL LAYER INTERFACES ARE COMPUTED FROM<a name='22'></font>
<font color=#447700>!     MONIN-OBUKHOV THEORY.<a name='23'></font>
<font color=#447700>!     THE TURBULENT VERTICAL EXCHANGE IS THEN EXECUTED.<a name='24'></font>
<font color=#447700>!<a name='25'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='26'></font>
<font color=#447700>!<a name='27'></font>
      INTEGER :: ITRMX=5 <font color=#447700>! Iteration count for mixing length computation<a name='28'></font>
<font color=#447700>!<a name='29'></font>
<font color=#447700>!     REAL,PARAMETER :: G=9.81,PI=3.1415926,R_D=287.04,R_V=461.6        &amp;<a name='30'></font>
<font color=#447700>!    &amp;                 ,VKARMAN=0.4<a name='31'></font>
      REAL,PARAMETER :: PI=3.1415926,VKARMAN=0.4<a name='32'>
<font color=#447700>!     REAL,PARAMETER :: CP=7.*R_D/2.<a name='33'></font>
      REAL,PARAMETER :: CAPA=R_D/CP<a name='34'>
      REAL,PARAMETER :: RLIVWV=XLS/XLV,ELOCP=2.72E6/CP<a name='35'>
      REAL,PARAMETER :: EPS1=1.E-12,EPS2=0.<a name='36'>
      REAL,PARAMETER :: EPSL=0.10,EPSRU=1.E-7,EPSRS=1.E-7               &amp;<a name='37'>
     &amp;                 ,EPSTRB=1.E-24<a name='38'>
      REAL,PARAMETER :: EPSA=1.E-8,EPSIT=1.E-4,EPSU2=1.E-4,EPSUST=0.07 <a name='39'>
      REAL,PARAMETER :: ALPH=0.30,BETA=1./273.,EL0MAX=1000.,EL0MIN=1.   &amp;<a name='40'>
     &amp;                 ,ELFC=0.23*0.5,GAM1=0.2222222222222222222        &amp;<a name='41'>
     &amp;                 ,PRT=1.<a name='42'>
      REAL,PARAMETER :: A1=0.659888514560862645                         &amp;<a name='43'>
     &amp;                 ,A2x=0.6574209922667784586                       &amp;<a name='44'>
     &amp;                 ,B1=11.87799326209552761                         &amp;<a name='45'>
     &amp;                 ,B2=7.226971804046074028                         &amp;<a name='46'>
     &amp;                 ,C1=0.000830955950095854396<a name='47'>
      REAL,PARAMETER :: A2S=17.2693882,A3S=273.16,A4S=35.86<a name='48'>
      REAL,PARAMETER :: ELZ0=0.,ESQ=5.0,EXCM=0.001                      &amp;<a name='49'>
     &amp;                 ,FHNEU=0.8,GLKBR=10.,GLKBS=30.                   &amp;<a name='50'>
     &amp;                 ,QVISC=2.1E-5,RFC=0.191,RIC=0.505,SMALL=0.35     &amp;<a name='51'>
     &amp;                 ,SQPR=0.84,SQSC=0.84,SQVISC=258.2,TVISC=2.1E-5   &amp;<a name='52'>
     &amp;                 ,USTC=0.7,USTR=0.225,VISC=1.5E-5                 &amp;<a name='53'>
     &amp;                 ,WOLD=0.15,WWST=1.2,ZTMAX=1.,ZTFC=1.,ZTMIN=-5.<a name='54'>
<font color=#447700>!<a name='55'></font>
      REAL,PARAMETER :: SEAFC=0.98,PQ0SEA=PQ0*SEAFC<a name='56'>
<font color=#447700>!<a name='57'></font>
      REAL,PARAMETER :: BTG=BETA*G,CZIV=SMALL*GLKBS                     &amp;<a name='58'>
<font color=#447700>!    &amp;                 ,EP_1=R_V/R_D-1.,ESQHF=0.5*5.0,GRRS=GLKBR/GLKBS  &amp;<a name='59'></font>
     &amp;                 ,ESQHF=0.5*5.0,GRRS=GLKBR/GLKBS                  &amp;<a name='60'>
     &amp;                 ,RB1=1./B1,RTVISC=1./TVISC,RVISC=1./VISC         &amp;<a name='61'>
     &amp;                 ,ZQRZT=SQSC/SQPR<a name='62'>
<font color=#447700>!<a name='63'></font>
      REAL,PARAMETER :: ADNH= 9.*A1*A2x*A2x*(12.*A1+3.*B2)*BTG*BTG      &amp;                  <a name='64'>
     &amp;                 ,ADNM=18.*A1*A1*A2x*(B2-3.*A2x)*BTG              &amp; <a name='65'>
     &amp;                 ,ANMH=-9.*A1*A2x*A2x*BTG*BTG                     &amp;<a name='66'>
     &amp;                 ,ANMM=-3.*A1*A2x*(3.*A2x+3.*B2*C1+18.*A1*C1-B2)  &amp;<a name='67'>
     &amp;                                *BTG                              &amp;   <a name='68'>
     &amp;                 ,BDNH= 3.*A2x*(7.*A1+B2)*BTG                     &amp;<a name='69'>
     &amp;                 ,BDNM= 6.*A1*A1                                  &amp;<a name='70'>
     &amp;                 ,BEQH= A2x*B1*BTG+3.*A2x*(7.*A1+B2)*BTG          &amp;<a name='71'>
     &amp;                 ,BEQM=-A1*B1*(1.-3.*C1)+6.*A1*A1                 &amp;<a name='72'>
     &amp;                 ,BNMH=-A2x*BTG                                   &amp;     <a name='73'>
     &amp;                 ,BNMM=A1*(1.-3.*C1)                              &amp;<a name='74'>
     &amp;                 ,BSHH=9.*A1*A2x*A2x*BTG                          &amp;<a name='75'>
     &amp;                 ,BSHM=18.*A1*A1*A2x*C1                           &amp;<a name='76'>
     &amp;                 ,BSMH=-3.*A1*A2x*(3.*A2x+3.*B2*C1+12.*A1*C1-B2)  &amp;<a name='77'>
     &amp;                                *BTG                              &amp;<a name='78'>
     &amp;                 ,CESH=A2x                                        &amp;<a name='79'>
     &amp;                 ,CESM=A1*(1.-3.*C1)                              &amp;<a name='80'>
     &amp;                 ,CNV=EP_1*G/BTG                                  &amp;<a name='81'>
     &amp;                 ,ELFCS=VKARMAN*BTG                               &amp;<a name='82'>
     &amp;                 ,FZQ1=RTVISC*QVISC*ZQRZT                         &amp;<a name='83'>
     &amp;                 ,FZQ2=RTVISC*QVISC*ZQRZT                         &amp;<a name='84'>
     &amp;                 ,FZT1=RVISC *TVISC*SQPR                          &amp;<a name='85'>
     &amp;                 ,FZT2=CZIV*GRRS*TVISC*SQPR                       &amp;<a name='86'>
     &amp;                 ,FZU1=CZIV*VISC                                  &amp;<a name='87'>
     &amp;                 ,PIHF=0.5*PI                                     &amp;<a name='88'>
     &amp;                 ,RFAC=RIC/(FHNEU*RFC*RFC)                        &amp;<a name='89'>
     &amp;                 ,RQVISC=1./QVISC                                 &amp;<a name='90'>
     &amp;                 ,RRIC=1./RIC                                     &amp;<a name='91'>
     &amp;                 ,USTFC=0.018/G                                   &amp;<a name='92'>
     &amp;                 ,WNEW=1.-WOLD                                    &amp;<a name='93'>
     &amp;                 ,WWST2=WWST*WWST<a name='94'>
<font color=#447700>!<a name='95'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='96'></font>
<font color=#447700>!***  FREE TERM IN THE EQUILIBRIUM EQUATION FOR (L/Q)**2<a name='97'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='98'></font>
<font color=#447700>!<a name='99'></font>
      REAL,PARAMETER :: AEQH=9.*A1*A2x*A2x*B1*BTG*BTG                   &amp;<a name='100'>
     &amp;                      +9.*A1*A2x*A2x*(12.*A1+3.*B2)*BTG*BTG       &amp;<a name='101'>
     &amp;                 ,AEQM=3.*A1*A2x*B1*(3.*A2x+3.*B2*C1+18.*A1*C1-B2)&amp;<a name='102'>
     &amp;                      *BTG+18.*A1*A1*A2x*(B2-3.*A2x)*BTG<a name='103'>
<font color=#447700>!<a name='104'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='105'></font>
<font color=#447700>!***  FORBIDDEN TURBULENCE AREA<a name='106'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='107'></font>
<font color=#447700>!<a name='108'></font>
      REAL,PARAMETER :: REQU=-AEQH/AEQM                                 &amp;<a name='109'>
     &amp;                 ,EPSGH=1.E-9,EPSGM=REQU*EPSGH<a name='110'>
<font color=#447700>!<a name='111'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='112'></font>
<font color=#447700>!***  NEAR ISOTROPY FOR SHEAR TURBULENCE, WW/Q2 LOWER LIMIT<a name='113'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='114'></font>
<font color=#447700>! <a name='115'></font>
      REAL,PARAMETER :: UBRYL=(18.*REQU*A1*A1*A2x*B2*C1*BTG             &amp;<a name='116'>
     &amp;                         +9.*A1*A2x*A2x*B2*BTG*BTG)               &amp;<a name='117'>
     &amp;                        /(REQU*ADNM+ADNH)                         &amp;<a name='118'>
     &amp;                 ,UBRY=(1.+EPSRS)*UBRYL,UBRY3=3.*UBRY<a name='119'>
<font color=#447700>!<a name='120'></font>
      REAL,PARAMETER :: AUBH=27.*A1*A2x*A2x*B2*BTG*BTG-ADNH*UBRY3       &amp;<a name='121'>
     &amp;                 ,AUBM=54.*A1*A1*A2x*B2*C1*BTG -ADNM*UBRY3        &amp;<a name='122'>
     &amp;                 ,BUBH=(9.*A1*A2x+3.*A2x*B2)*BTG-BDNH*UBRY3       &amp;<a name='123'>
     &amp;                 ,BUBM=18.*A1*A1*C1           -BDNM*UBRY3         &amp;<a name='124'>
     &amp;                 ,CUBR=1.                     -     UBRY3         &amp;<a name='125'>
     &amp;                 ,RCUBR=1./CUBR<a name='126'>
<font color=#447700>!<a name='127'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='128'></font>
<font color=#447700>!<a name='129'></font>
      CONTAINS<a name='130'>
<font color=#447700>!<a name='131'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='132'></font>
<A NAME='MYJPBL'><A href='../../html_code/phys/module_bl_myjpbl.F.html#MYJPBL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='133'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MYJPBL</font>(DT,STEPBL,HT,DZ                                &amp; <A href='../../call_to/MYJPBL.html' TARGET='index'>1</A>,<A href='../../call_from/MYJPBL.html' TARGET='index'>6</A><a name='134'>
     &amp;                 ,PMID,PINT,TH,T,EXNER,QV,CWM,U,V,RHO            &amp;<a name='135'>
     &amp;                 ,TSK,QSFC,CHKLOWQ,THZ0,QZ0,UZ0,VZ0              &amp;<a name='136'>
     &amp;                 ,LOWLYR,XLAND,SICE,SNOW                         &amp;<a name='137'>
     &amp;                 ,TKE_MYJ,EXCH_H,USTAR,ZNT,PBLH,KPBL,CT          &amp;<a name='138'>
     &amp;                 ,AKHS,AKMS,ELFLX                                &amp;<a name='139'>
     &amp;                 ,RUBLTEN,RVBLTEN,RTHBLTEN,RQVBLTEN,RQCBLTEN     &amp;<a name='140'>
     &amp;                 ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='141'>
     &amp;                 ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='142'>
     &amp;                 ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='143'>
<font color=#447700>!----------------------------------------------------------------------<a name='144'></font>
<font color=#447700>!<a name='145'></font>
      IMPLICIT NONE<a name='146'>
<font color=#447700>!<a name='147'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='148'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='149'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='150'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='151'>
<font color=#447700>!<a name='152'></font>
      INTEGER,INTENT(IN) :: STEPBL<a name='153'>
<a name='154'>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: LOWLYR<a name='155'>
<font color=#447700>!<a name='156'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: KPBL<a name='157'>
<font color=#447700>!<a name='158'></font>
      REAL,INTENT(IN) :: DT<a name='159'>
<font color=#447700>!<a name='160'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: HT,SICE,SNOW       &amp;<a name='161'>
     &amp;                                             ,TSK,XLAND<a name='162'>
<font color=#447700>!<a name='163'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: CWM,DZ     &amp;<a name='164'>
     &amp;                                                     ,EXNER      &amp;<a name='165'>
     &amp;                                                     ,PMID,PINT  &amp;<a name='166'>
     &amp;                                                     ,QV,RHO     &amp;<a name='167'>
     &amp;                                                     ,T,TH,U,V   <a name='168'>
<font color=#447700>!<a name='169'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: PBLH<a name='170'>
<font color=#447700>!<a name='171'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: AKHS,AKMS<a name='172'>
<font color=#447700>!<a name='173'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME)                          &amp;<a name='174'>
     &amp;    ,INTENT(OUT) ::                      RQCBLTEN,RQVBLTEN       &amp;<a name='175'>
     &amp;                                        ,RTHBLTEN                &amp;<a name='176'>
     &amp;                                        ,RUBLTEN,RVBLTEN        <a name='177'>
<font color=#447700>!<a name='178'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: CT,QSFC,QZ0     &amp;<a name='179'>
     &amp;                                                ,THZ0,USTAR      &amp;<a name='180'>
     &amp;                                                ,UZ0,VZ0,ZNT<a name='181'>
<font color=#447700>!<a name='182'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME)                          &amp;<a name='183'>
     &amp;    ,INTENT(INOUT) ::                    EXCH_H,TKE_MYJ<a name='184'>
<font color=#447700>!<a name='185'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: CHKLOWQ,ELFLX<a name='186'>
<font color=#447700>!<a name='187'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='188'></font>
<font color=#447700>!***<a name='189'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='190'></font>
<font color=#447700>!***<a name='191'></font>
      INTEGER :: I,J,K,KFLIP,LLOW,LMH<a name='192'>
<font color=#447700>!<a name='193'></font>
      INTEGER,DIMENSION(ITS:ITE,JTS:JTE) :: LPBL<a name='194'>
<font color=#447700>!<a name='195'></font>
      REAL :: APEX,DCDT,DQDT,DTDIF,DTDT,DTTURBL,DUDT,DVDT,EXNSFC,FFSK  &amp;<a name='196'>
     &amp;       ,PLOW,PSFC,PTOP,QFC1,QLOW,QOLD,RATIOMX,RDTTURBL,RG,RWMSK  &amp;<a name='197'>
     &amp;       ,SEAMASK,THNEW,THOLD,TX,ULOW,VLOW,WMSK<a name='198'>
<font color=#447700>!<a name='199'></font>
      REAL,DIMENSION(KTS:KTE) :: CWMK,PK,Q2K,QK,THEK,TK,UK,VK<a name='200'>
<font color=#447700>!<a name='201'></font>
      REAL,DIMENSION(KTS:KTE-1) :: AKHK,AKMK,EL,GH,GM<a name='202'>
<font color=#447700>!<a name='203'></font>
      REAL,DIMENSION(KTS:KTE+1) :: ZHK<a name='204'>
<font color=#447700>!<a name='205'></font>
      REAL,DIMENSION(ITS:ITE,JTS:JTE) :: THSK<a name='206'>
<font color=#447700>!<a name='207'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE) :: RHOD<a name='208'>
<font color=#447700>!<a name='209'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE,JTS:JTE) :: APE,THE<a name='210'>
<font color=#447700>!<a name='211'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE-1,JTS:JTE) :: AKH,AKM<a name='212'>
<font color=#447700>!<a name='213'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE+1,JTS:JTE) :: ZINT<a name='214'>
<font color=#447700>!<a name='215'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='216'></font>
<font color=#447700>!**********************************************************************<a name='217'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='218'></font>
<font color=#447700>!<a name='219'></font>
<font color=#447700>!***  MAKE PREPARATIONS<a name='220'></font>
<font color=#447700>!<a name='221'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='222'></font>
      DTTURBL=DT*STEPBL<a name='223'>
      RDTTURBL=1./DTTURBL<a name='224'>
      DTDIF=DTTURBL<a name='225'>
      RG=1./G<a name='226'>
<font color=#447700>!<a name='227'></font>
      DO J=JTS,JTE<a name='228'>
      DO K=KTS,KTE-1<a name='229'>
      DO I=ITS,ITE<a name='230'>
        AKM(I,K,J)=0.<a name='231'>
      ENDDO<a name='232'>
      ENDDO<a name='233'>
      ENDDO<a name='234'>
<font color=#447700>!<a name='235'></font>
      DO J=JTS,JTE<a name='236'>
      DO K=KTS,KTE+1<a name='237'>
      DO I=ITS,ITE<a name='238'>
        ZINT(I,K,J)=0.<a name='239'>
      ENDDO<a name='240'>
      ENDDO<a name='241'>
      ENDDO<a name='242'>
<font color=#447700>!<a name='243'></font>
      DO J=JTS,JTE<a name='244'>
      DO I=ITS,ITE<a name='245'>
        ZINT(I,KTE+1,J)=HT(I,J)     <font color=#447700>! Z at bottom of lowest sigma layer<a name='246'></font>
<font color=#447700>!<a name='247'></font>
<font color=#447700>!!!!!!!!!<a name='248'></font>
<font color=#447700>!!!!!! UNCOMMENT THESE LINES IF USING ETA COORDINATES<a name='249'></font>
<font color=#447700>!!!!!!!!!<a name='250'></font>
<font color=#447700>!!!!!!  ZINT(I,KTE+1,J)=1.E-4       ! Z of bottom of lowest eta layer<a name='251'></font>
<font color=#447700>!!!!!!  ZHK(KTE+1)=1.E-4            ! Z of bottom of lowest eta layer<a name='252'></font>
<font color=#447700>!<a name='253'></font>
      ENDDO<a name='254'>
      ENDDO<a name='255'>
<font color=#447700>!<a name='256'></font>
      DO J=JTS,JTE<a name='257'>
      DO K=KTE,KTS,-1<a name='258'>
        KFLIP=KTE+1-K<a name='259'>
        DO I=ITS,ITE<a name='260'>
          ZINT(I,K,J)=ZINT(I,K+1,J)+DZ(I,KFLIP,J)<a name='261'>
          APEX=1./EXNER(I,K,J)<a name='262'>
          APE(I,K,J)=APEX<a name='263'>
          TX=T(I,K,J)<a name='264'>
          THE(I,K,J)=(CWM(I,K,J)*(-ELOCP/TX)+1.)*TH(I,K,J)<a name='265'>
        ENDDO<a name='266'>
      ENDDO<a name='267'>
      ENDDO<a name='268'>
<font color=#447700>!<a name='269'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='270'></font>
        setup_integration:  DO J=JTS,JTE<a name='271'>
<font color=#447700>!----------------------------------------------------------------------<a name='272'></font>
<font color=#447700>!<a name='273'></font>
        DO I=ITS,ITE<a name='274'>
<font color=#447700>!<a name='275'></font>
<font color=#447700>!***  LOWEST LAYER ABOVE GROUND MUST BE FLIPPED<a name='276'></font>
<font color=#447700>!<a name='277'></font>
          LMH=KTE-LOWLYR(I,J)+1<a name='278'>
<font color=#447700>!<a name='279'></font>
          PTOP=PINT(I,KTE+1,J)      <font color=#447700>! KTE+1=KME<a name='280'></font>
          PSFC=PINT(I,LOWLYR(I,J),J)<a name='281'>
<font color=#447700>!<a name='282'></font>
<font color=#447700>!***  CONVERT LAND MASK (1 FOR SEA; 0 FOR LAND)<a name='283'></font>
<font color=#447700>!<a name='284'></font>
          SEAMASK=XLAND(I,J)-1.<a name='285'>
<font color=#447700>!<a name='286'></font>
<font color=#447700>!***  FILL 1-D VERTICAL ARRAYS<a name='287'></font>
<font color=#447700>!***  AND FLIP DIRECTION SINCE MYJ SCHEME<a name='288'></font>
<font color=#447700>!***  COUNTS DOWNWARD FROM THE DOMAIN'S TOP<a name='289'></font>
<font color=#447700>!<a name='290'></font>
          DO K=KTE,KTS,-1<a name='291'>
            KFLIP=KTE+1-K<a name='292'>
            TK(K)=T(I,KFLIP,J)<a name='293'>
            THEK(K)=THE(I,KFLIP,J)<a name='294'>
            RATIOMX=QV(I,KFLIP,J)<a name='295'>
            QK(K)=RATIOMX/(1.+RATIOMX)<a name='296'>
            CWMK(K)=CWM(I,KFLIP,J)<a name='297'>
            PK(K)=PMID(I,KFLIP,J)<a name='298'>
            UK(K)=U(I,KFLIP,J)<a name='299'>
            VK(K)=V(I,KFLIP,J)<a name='300'>
<font color=#447700>!<a name='301'></font>
<font color=#447700>!***  TKE=0.5*(q**2) ==&gt; q**2=2.*TKE<a name='302'></font>
<font color=#447700>!<a name='303'></font>
            Q2K(K)=2.*TKE_MYJ(I,KFLIP,J)<a name='304'>
<font color=#447700>!<a name='305'></font>
<font color=#447700>!***  COMPUTE THE HEIGHTS OF THE LAYER INTERFACES<a name='306'></font>
<font color=#447700>!<a name='307'></font>
            ZHK(K)=ZINT(I,K,J)<a name='308'>
<font color=#447700>!<a name='309'></font>
          ENDDO<a name='310'>
          ZHK(KTE+1)=HT(I,J)          <font color=#447700>! Z at bottom of lowest sigma layer<a name='311'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='312'></font>
<font color=#447700>!***<a name='313'></font>
<font color=#447700>!***  FIND THE MIXING LENGTH<a name='314'></font>
<font color=#447700>!***<a name='315'></font>
          CALL <A href='../../html_code/phys/module_bl_myjpbl.F.html#MIXLEN'>MIXLEN</A><A href='../../html_code/phys/module_bl_myjpbl.F.html#MYJPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MIXLEN_1">(LMH,UK,VK,TK,THEK,QK,CWMK                        &amp;<a name='316'>
     &amp;               ,Q2K,ZHK,GM,GH,EL                                 &amp;<a name='317'>
     &amp;               ,PBLH(I,J),LPBL(I,J),CT(I,J)                      &amp;<a name='318'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                          &amp;<a name='319'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='320'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='321'>
<font color=#447700>!<a name='322'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='323'></font>
<font color=#447700>!***<a name='324'></font>
<font color=#447700>!***  SOLVE FOR THE PRODUCTION/DISSIPATION OF<a name='325'></font>
<font color=#447700>!***  THE TURBULENT KINETIC ENERGY<a name='326'></font>
<font color=#447700>!***<a name='327'></font>
<font color=#447700>!<a name='328'></font>
          CALL <A href='../../html_code/phys/module_bl_myjpbl.F.html#PRODQ2'>PRODQ2</A><A href='../../html_code/phys/module_bl_myjpbl.F.html#MYJPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRODQ2_1">(LMH,DTTURBL,USTAR(I,J),GM,GH,EL,Q2K              &amp;<a name='329'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                          &amp;<a name='330'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='331'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='332'>
<font color=#447700>!<a name='333'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='334'></font>
<font color=#447700>!*** THE MODEL LAYER (COUNTING UPWARD) CONTAINING THE TOP OF THE PBL<a name='335'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='336'></font>
<font color=#447700>!<a name='337'></font>
          KPBL(I,J)=KTE-LPBL(I,J)+1<a name='338'>
<font color=#447700>!<a name='339'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='340'></font>
<font color=#447700>!***<a name='341'></font>
<font color=#447700>!***  FIND THE EXCHANGE COEFFICIENTS IN THE FREE ATMOSPHERE<a name='342'></font>
<font color=#447700>!***<a name='343'></font>
          CALL <A href='../../html_code/phys/module_bl_myjpbl.F.html#DIFCOF'>DIFCOF</A><A href='../../html_code/phys/module_bl_myjpbl.F.html#MYJPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIFCOF_1">(LMH,LPBL(I,J),GM,GH,EL,TK,Q2K,ZHK,AKMK,AKHK      &amp;<a name='344'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                          &amp;<a name='345'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='346'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='347'>
<font color=#447700>!<a name='348'></font>
          DO K=KTS,KTE-1<a name='349'>
            KFLIP=KTE+1-K<a name='350'>
            AKH(I,K,J)=AKHK(K)<a name='351'>
            AKM(I,K,J)=AKMK(K)<a name='352'>
            IF(K&gt;KTS)EXCH_H(I,K,J)=AKHK(KFLIP)<a name='353'>
          ENDDO<a name='354'>
<font color=#447700>!<a name='355'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='356'></font>
<font color=#447700>!***<a name='357'></font>
<font color=#447700>!***  CARRY OUT THE VERTICAL DIFFUSION OF<a name='358'></font>
<font color=#447700>!***  TURBULENT KINETIC ENERGY<a name='359'></font>
<font color=#447700>!***<a name='360'></font>
<font color=#447700>!<a name='361'></font>
          CALL <A href='../../html_code/phys/module_bl_myjpbl.F.html#VDIFQ'>VDIFQ</A><A href='../../html_code/phys/module_bl_myjpbl.F.html#MYJPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VDIFQ_1">(LMH,DTDIF,Q2K,EL,ZHK                              &amp;<a name='362'>
     &amp;              ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='363'>
     &amp;              ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='364'>
     &amp;              ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='365'>
<font color=#447700>!<a name='366'></font>
<font color=#447700>!***  SAVE THE NEW TKE<a name='367'></font>
<font color=#447700>!<a name='368'></font>
          DO K=KTS,KTE<a name='369'>
            KFLIP=KTE+1-K<a name='370'>
            Q2K(KFLIP)=AMAX1(Q2K(KFLIP),EPSQ2)<a name='371'>
            TKE_MYJ(I,K,J)=0.5*Q2K(KFLIP)<a name='372'>
          ENDDO<a name='373'>
<font color=#447700>!<a name='374'></font>
<font color=#447700>!<a name='375'></font>
        ENDDO<a name='376'>
<font color=#447700>!<a name='377'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='378'></font>
      ENDDO setup_integration<a name='379'>
<font color=#447700>!----------------------------------------------------------------------<a name='380'></font>
<font color=#447700>!<a name='381'></font>
<font color=#447700>!***  CONVERT SURFACE SENSIBLE TEMPERATURE TO POTENTIAL TEMPERATURE.<a name='382'></font>
<font color=#447700>!<a name='383'></font>
      DO J=JTS,JTE<a name='384'>
      DO I=ITS,ITE<a name='385'>
        PSFC=PINT(I,LOWLYR(I,J),J)<a name='386'>
        THSK(I,J)=TSK(I,J)*(1.E5/PSFC)**CAPA<a name='387'>
      ENDDO<a name='388'>
      ENDDO<a name='389'>
<font color=#447700>!<a name='390'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='391'></font>
<font color=#447700>!<a name='392'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='393'></font>
      main_integration:  DO J=JTS,JTE<a name='394'>
<font color=#447700>!----------------------------------------------------------------------<a name='395'></font>
<font color=#447700>!<a name='396'></font>
        DO I=ITS,ITE<a name='397'>
<font color=#447700>!<a name='398'></font>
<font color=#447700>!***  FILL 1-D VERTICAL ARRAYS<a name='399'></font>
<font color=#447700>!***  AND FLIP DIRECTION SINCE MYJ SCHEME<a name='400'></font>
<font color=#447700>!***  COUNTS DOWNWARD FROM THE DOMAIN'S TOP<a name='401'></font>
<font color=#447700>!<a name='402'></font>
          DO K=KTE-1,KTS,-1<a name='403'>
            KFLIP=KTE-K<a name='404'>
            AKHK(K)=AKH(I,K,J)<a name='405'>
          ENDDO <a name='406'>
<font color=#447700>!<a name='407'></font>
          DO K=KTE,KTS,-1<a name='408'>
            KFLIP=KTE+1-K<a name='409'>
            THEK(K)=THE(I,KFLIP,J)<a name='410'>
            RATIOMX=QV(I,KFLIP,J)<a name='411'>
            QK(K)=RATIOMX/(1.+RATIOMX)<a name='412'>
            CWMK(K)=CWM(I,KFLIP,J)<a name='413'>
            ZHK(K)=ZINT(I,K,J)<a name='414'>
          ENDDO<a name='415'>
<font color=#447700>!<a name='416'></font>
          ZHK(KTE+1)=ZINT(I,KTE+1,J)<a name='417'>
<font color=#447700>!<a name='418'></font>
          SEAMASK=XLAND(I,J)-1.<a name='419'>
          THZ0(I,J)=(1.-SEAMASK)*THSK(I,J)+SEAMASK*THZ0(I,J)<a name='420'>
<font color=#447700>!<a name='421'></font>
          IF(SEAMASK&lt;0.5)THEN<a name='422'>
            LLOW=LOWLYR(I,J)<a name='423'>
            PLOW=PMID(I,LLOW,J)<a name='424'>
            QLOW=QK(KTE+1-LLOW)<a name='425'>
            FFSK=AKHS(I,J)*PLOW/                                       &amp;<a name='426'>
     &amp;           ((QLOW*P608-CWM(I,LLOW,J)+1.)*T(I,LLOW,J)*R_D)<a name='427'>
            QFC1=FFSK*XLV<a name='428'>
            QFC1=QFC1*CHKLOWQ(I,J)<a name='429'>
<font color=#447700>!<a name='430'></font>
            IF(SNOW(I,J)&gt;0..OR.SICE(I,J)&gt;0.5)THEN<a name='431'>
              QFC1=QFC1*RLIVWV<a name='432'>
            ENDIF<a name='433'>
<font color=#447700>!<a name='434'></font>
            IF(QFC1&gt;0.)THEN<a name='435'>
              QSFC(I,J)=QLOW+ELFLX(I,J)/QFC1<a name='436'>
            ENDIF<a name='437'>
<font color=#447700>!<a name='438'></font>
          ELSE<a name='439'>
            PSFC=PINT(I,LOWLYR(I,J),J)<a name='440'>
            EXNSFC=(1.E5/PSFC)**CAPA<a name='441'>
            QSFC(I,J)=PQ0SEA/PSFC                                      &amp;<a name='442'>
     &amp;         *EXP(A2*(THSK(I,J)-A3*EXNSFC)/(THSK(I,J)-A4*EXNSFC))<a name='443'>
          ENDIF<a name='444'>
<font color=#447700>!<a name='445'></font>
          QZ0 (I,J)=(1.-SEAMASK)*QSFC(I,J)+SEAMASK*QZ0 (I,J)<a name='446'>
<font color=#447700>!<a name='447'></font>
<font color=#447700>!***  LOWEST LAYER ABOVE GROUND MUST BE FLIPPED<a name='448'></font>
<font color=#447700>!<a name='449'></font>
          LMH=KTE-LOWLYR(I,J)+1<a name='450'>
<font color=#447700>!<a name='451'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='452'></font>
<font color=#447700>!***  CARRY OUT THE VERTICAL DIFFUSION OF<a name='453'></font>
<font color=#447700>!***  TEMPERATURE AND WATER VAPOR<a name='454'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='455'></font>
<font color=#447700>!<a name='456'></font>
          CALL <A href='../../html_code/phys/module_bl_myjpbl.F.html#VDIFH'>VDIFH</A><A href='../../html_code/phys/module_bl_myjpbl.F.html#MYJPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VDIFH_1">(DTDIF,LMH,THZ0(I,J),QZ0(I,J)                      &amp;<a name='457'>
     &amp;              ,AKHS(I,J),CHKLOWQ(I,J),CT(I,J)                    &amp;<a name='458'>
     &amp;              ,THEK,QK,CWMK,AKHK,ZHK                             &amp;<a name='459'>
     &amp;              ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='460'>
     &amp;              ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='461'>
     &amp;              ,ITS,ITE,JTS,JTE,KTS,KTE,i,j)<a name='462'>
<font color=#447700>!----------------------------------------------------------------------<a name='463'></font>
<font color=#447700>!***<a name='464'></font>
<font color=#447700>!***  COMPUTE PRIMARY VARIABLE TENDENCIES<a name='465'></font>
<font color=#447700>!***<a name='466'></font>
          DO K=KTS,KTE<a name='467'>
            KFLIP=KTE+1-K<a name='468'>
            THOLD=TH(I,K,J)<a name='469'>
            THNEW=THEK(KFLIP)+CWMK(KFLIP)*ELOCP*APE(I,K,J)<a name='470'>
            DTDT=(THNEW-THOLD)*RDTTURBL<a name='471'>
            QOLD=QV(I,K,J)/(1.+QV(I,K,J))<a name='472'>
            DQDT=(QK(KFLIP)-QOLD)*RDTTURBL<a name='473'>
            DCDT=(CWMK(KFLIP)-CWM(I,K,J))*RDTTURBL<a name='474'>
<font color=#447700>!<a name='475'></font>
            RHOD(I,K)=PMID(I,K,J)/(R_D*T(I,K,J))<a name='476'>
            RTHBLTEN(I,K,J)=DTDT<a name='477'>
            RQVBLTEN(I,K,J)=DQDT/(1.-QK(KFLIP))**2<a name='478'>
            RQCBLTEN(I,K,J)=DCDT<a name='479'>
          ENDDO<a name='480'>
<font color=#447700>!----------------------------------------------------------------------<a name='481'></font>
        ENDDO<a name='482'>
<font color=#447700>!----------------------------------------------------------------------<a name='483'></font>
        DO I=ITS,ITE<a name='484'>
<font color=#447700>!<a name='485'></font>
<font color=#447700>!***  FILL 1-D VERTICAL ARRAYS<a name='486'></font>
<font color=#447700>!***  AND FLIP DIRECTION SINCE MYJ SCHEME<a name='487'></font>
<font color=#447700>!***  COUNTS DOWNWARD FROM THE DOMAIN'S TOP<a name='488'></font>
<font color=#447700>!<a name='489'></font>
          DO K=KTE-1,KTS,-1<a name='490'>
            AKMK(K)=AKM(I,K,J)<a name='491'>
          ENDDO<a name='492'>
<font color=#447700>!<a name='493'></font>
          DO K=KTE,KTS,-1<a name='494'>
            KFLIP=KTE+1-K<a name='495'>
            UK(K)=U(I,KFLIP,J)<a name='496'>
            VK(K)=V(I,KFLIP,J)<a name='497'>
            ZHK(K)=ZINT(I,K,J)<a name='498'>
          ENDDO<a name='499'>
          ZHK(KTE+1)=ZINT(I,KTE+1,J)<a name='500'>
<font color=#447700>!<a name='501'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='502'></font>
<font color=#447700>!***  CARRY OUT THE VERTICAL DIFFUSION OF<a name='503'></font>
<font color=#447700>!***  VELOCITY COMPONENTS<a name='504'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='505'></font>
<font color=#447700>!<a name='506'></font>
          CALL <A href='../../html_code/phys/module_bl_myjpbl.F.html#VDIFV'>VDIFV</A><A href='../../html_code/phys/module_bl_myjpbl.F.html#MYJPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VDIFV_1">(LMH,DTDIF,UZ0(I,J),VZ0(I,J)                       &amp;<a name='507'>
     &amp;              ,AKMS(I,J),UK,VK,AKMK,ZHK                          &amp;<a name='508'>
     &amp;              ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='509'>
     &amp;              ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='510'>
     &amp;              ,ITS,ITE,JTS,JTE,KTS,KTE,i,j)<a name='511'>
<font color=#447700>!<a name='512'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='513'></font>
<font color=#447700>!***<a name='514'></font>
<font color=#447700>!***  COMPUTE PRIMARY VARIABLE TENDENCIES<a name='515'></font>
<font color=#447700>!***<a name='516'></font>
          DO K=KTS,KTE<a name='517'>
            KFLIP=KTE+1-K<a name='518'>
            DUDT=(UK(KFLIP)-U(I,K,J))*RDTTURBL<a name='519'>
            DVDT=(VK(KFLIP)-V(I,K,J))*RDTTURBL<a name='520'>
            RUBLTEN(I,K,J)=DUDT<a name='521'>
            RVBLTEN(I,K,J)=DVDT<a name='522'>
          ENDDO<a name='523'>
<font color=#447700>!<a name='524'></font>
        ENDDO<a name='525'>
<font color=#447700>!----------------------------------------------------------------------<a name='526'></font>
<font color=#447700>!<a name='527'></font>
      ENDDO main_integration<a name='528'>
<font color=#447700>!<a name='529'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='530'></font>
<font color=#447700>!<a name='531'></font>
      END SUBROUTINE MYJPBL<a name='532'>
<font color=#447700>!<a name='533'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='534'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='535'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='536'></font>
<A NAME='MIXLEN'><A href='../../html_code/phys/module_bl_myjpbl.F.html#MIXLEN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='537'>
                          <font color=#993300>SUBROUTINE </font><font color=#cc0000>MIXLEN</font>                            &amp; <A href='../../call_to/MIXLEN.html' TARGET='index'>1</A><a name='538'>
<font color=#447700>!----------------------------------------------------------------------<a name='539'></font>
<font color=#447700>!   ******************************************************************<a name='540'></font>
<font color=#447700>!   *                                                                *<a name='541'></font>
<font color=#447700>!   *                   LEVEL 2.5 MIXING LENGTH                      *<a name='542'></font>
<font color=#447700>!   *                                                                *<a name='543'></font>
<font color=#447700>!   ******************************************************************<a name='544'></font>
<font color=#447700>!<a name='545'></font>
     &amp;(LMH,U,V,T,THE,Q,CWM,Q2,Z,GM,GH,EL,PBLH,LPBL,CT                  &amp;<a name='546'>
     &amp;,IDS,IDE,JDS,JDE,KDS,KDE                                         &amp;<a name='547'>
     &amp;,IMS,IME,JMS,JME,KMS,KME                                         &amp;<a name='548'>
     &amp;,ITS,ITE,JTS,JTE,KTS,KTE)<a name='549'>
<font color=#447700>!----------------------------------------------------------------------<a name='550'></font>
<font color=#447700>!<a name='551'></font>
      IMPLICIT NONE<a name='552'>
<font color=#447700>!<a name='553'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='554'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='555'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='556'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='557'>
<font color=#447700>!<a name='558'></font>
      INTEGER,INTENT(IN) :: LMH<a name='559'>
<font color=#447700>!<a name='560'></font>
      INTEGER,INTENT(OUT) :: LPBL<a name='561'>
<font color=#447700>!<a name='562'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(IN) :: CWM,Q,Q2,T,THE,U,V<a name='563'>
<font color=#447700>!<a name='564'></font>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: Z<a name='565'>
<font color=#447700>!<a name='566'></font>
      REAL,INTENT(OUT) :: PBLH <a name='567'>
<font color=#447700>!<a name='568'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(OUT) :: EL,GH,GM<a name='569'>
<font color=#447700>!<a name='570'></font>
      REAL,INTENT(INOUT) :: CT<a name='571'>
<font color=#447700>!----------------------------------------------------------------------<a name='572'></font>
<font color=#447700>!***<a name='573'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='574'></font>
<font color=#447700>!***<a name='575'></font>
      INTEGER :: K,LPBLM<a name='576'>
<font color=#447700>!<a name='577'></font>
      REAL :: A,ADEN,B,BDEN,AUBR,BUBR,EL0,ELOQ2X,GHL,GML               &amp;<a name='578'>
     &amp;       ,QOL2ST,QOL2UN,QDZL,RDZ,SQ,SZQ,TEM,THM,VKRMZ<a name='579'>
<font color=#447700>!<a name='580'></font>
      REAL,DIMENSION(KTS:KTE) :: Q1<a name='581'>
<font color=#447700>!<a name='582'></font>
      REAL,DIMENSION(KTS:KTE-1) :: DTH,ELM<a name='583'>
<font color=#447700>!<a name='584'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='585'></font>
<font color=#447700>!**********************************************************************<a name='586'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='587'></font>
<font color=#447700>!<a name='588'></font>
      DO K=KTS,LMH<a name='589'>
        Q1(K)=0.<a name='590'>
      ENDDO<a name='591'>
<font color=#447700>!<a name='592'></font>
      DO K=1,LMH-1<a name='593'>
        DTH(K)=THE(K)-THE(K+1)<a name='594'>
      ENDDO<a name='595'>
<font color=#447700>!<a name='596'></font>
      DO K=LMH-2,1,-1<a name='597'>
        IF(DTH(K)&gt;0..AND.DTH(K+1)&lt;=0.)THEN<a name='598'>
          DTH(K)=DTH(K)+CT<a name='599'>
          EXIT<a name='600'>
        ENDIF<a name='601'>
      ENDDO<a name='602'>
<font color=#447700>!<a name='603'></font>
      CT=0.<a name='604'>
<font color=#447700>!----------------------------------------------------------------------<a name='605'></font>
      DO K=KTS,LMH-1<a name='606'>
        RDZ=2./(Z(K)-Z(K+2))<a name='607'>
        GML=((U(K)-U(K+1))**2+(V(K)-V(K+1))**2)*RDZ*RDZ<a name='608'>
        GM(K)=MAX(GML,EPSGM)<a name='609'>
<font color=#447700>!<a name='610'></font>
        TEM=(T(K)+T(K+1))*0.5<a name='611'>
        THM=(THE(K)+THE(K+1))*0.5<a name='612'>
<font color=#447700>!<a name='613'></font>
        A=THM*P608<a name='614'>
        B=(ELOCP/TEM-1.-P608)*THM<a name='615'>
<font color=#447700>!<a name='616'></font>
        GHL=(DTH(K)*((Q(K)+Q(K+1))*(0.5*P608)+1.)                      &amp;<a name='617'>
     &amp;     +(Q(K)-Q(K+1))*A                                            &amp;<a name='618'>
     &amp;     +(CWM(K)-CWM(K+1))*B)*RDZ<a name='619'>
<font color=#447700>!<a name='620'></font>
        IF(ABS(GHL)&lt;=EPSGH)GHL=EPSGH<a name='621'>
        GH(K)=GHL<a name='622'>
      ENDDO<a name='623'>
<font color=#447700>!<a name='624'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='625'></font>
<font color=#447700>!***  FIND MAXIMUM MIXING LENGTHS AND THE LEVEL OF THE PBL TOP<a name='626'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='627'></font>
<font color=#447700>!<a name='628'></font>
      LPBL=LMH<a name='629'>
<font color=#447700>!<a name='630'></font>
      DO K=KTS,LMH-1<a name='631'>
        GML=GM(K)<a name='632'>
        GHL=GH(K)<a name='633'>
<font color=#447700>!<a name='634'></font>
        IF(GHL&gt;=EPSGH)THEN<a name='635'>
          IF(GML/GHL&lt;=REQU)THEN<a name='636'>
            ELM(K)=EPSL<a name='637'>
            LPBL=K<a name='638'>
          ELSE<a name='639'>
            AUBR=(AUBM*GML+AUBH*GHL)*GHL<a name='640'>
            BUBR= BUBM*GML+BUBH*GHL<a name='641'>
            QOL2ST=(-0.5*BUBR+SQRT(BUBR*BUBR*0.25-AUBR*CUBR))*RCUBR<a name='642'>
            ELOQ2X=1./QOL2ST<a name='643'>
            ELM(K)=MAX(SQRT(ELOQ2X*Q2(K)),EPSL)<a name='644'>
          ENDIF<a name='645'>
        ELSE<a name='646'>
          ADEN=(ADNM*GML+ADNH*GHL)*GHL<a name='647'>
          BDEN= BDNM*GML+BDNH*GHL<a name='648'>
          QOL2UN=-0.5*BDEN+SQRT(BDEN*BDEN*0.25-ADEN)<a name='649'>
          ELOQ2X=1./(QOL2UN+EPSRU)       <font color=#447700>! repsr1/qol2un<a name='650'></font>
          ELM(K)=MAX(SQRT(ELOQ2X*Q2(K)),EPSL)<a name='651'>
        ENDIF<a name='652'>
      ENDDO<a name='653'>
<font color=#447700>!<a name='654'></font>
      IF(ELM(LMH-1)==EPSL)LPBL=LMH<a name='655'>
<font color=#447700>!<a name='656'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='657'></font>
<font color=#447700>!***  THE HEIGHT OF THE PBL<a name='658'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='659'></font>
<font color=#447700>!<a name='660'></font>
      PBLH=Z(LPBL)-Z(LMH+1)<a name='661'>
<font color=#447700>!<a name='662'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='663'></font>
      DO K=LPBL,LMH<a name='664'>
        Q1(K)=SQRT(Q2(K))<a name='665'>
      ENDDO<a name='666'>
<font color=#447700>!----------------------------------------------------------------------<a name='667'></font>
      SZQ=0.<a name='668'>
      SQ =0.<a name='669'>
<font color=#447700>!<a name='670'></font>
      DO K=KTS,LMH-1<a name='671'>
        QDZL=(Q1(K)+Q1(K+1))*(Z(K+1)-Z(K+2))<a name='672'>
        SZQ=(Z(K+1)+Z(K+2)-Z(LMH+1)-Z(LMH+1))*QDZL+SZQ<a name='673'>
        SQ=QDZL+SQ<a name='674'>
      ENDDO<a name='675'>
<font color=#447700>!<a name='676'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='677'></font>
<font color=#447700>!***  COMPUTATION OF ASYMPTOTIC L IN BLACKADAR FORMULA<a name='678'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='679'></font>
<font color=#447700>!<a name='680'></font>
      EL0=MIN(ALPH*SZQ*0.5/SQ,EL0MAX)<a name='681'>
      EL0=MAX(EL0            ,EL0MIN)<a name='682'>
<font color=#447700>!<a name='683'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='684'></font>
<font color=#447700>!***  INSIDE THE PBL<a name='685'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='686'></font>
<font color=#447700>!<a name='687'></font>
      DO K=KTS,LMH-1<a name='688'>
        VKRMZ=(Z(K+1)-Z(LMH+1))*VKARMAN<a name='689'>
        EL(K)=MIN(VKRMZ/(VKRMZ/EL0+1.),ELM(K))<a name='690'>
      ENDDO<a name='691'>
<font color=#447700>!<a name='692'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='693'></font>
<font color=#447700>!***  CORRECTION ABOVE THE PBL TOP<a name='694'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='695'></font>
<font color=#447700>!<a name='696'></font>
      LPBLM=MAX(LPBL-1,1)<a name='697'>
<font color=#447700>!<a name='698'></font>
      DO K=1,LPBLM<a name='699'>
        EL(K)=MIN((Z(K)-Z(K+2))*ELFC,ELM(K))<a name='700'>
      ENDDO<a name='701'>
<font color=#447700>!----------------------------------------------------------------------<a name='702'></font>
      END SUBROUTINE MIXLEN<a name='703'>
<font color=#447700>!----------------------------------------------------------------------<a name='704'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='705'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='706'></font>
<A NAME='PRODQ2'><A href='../../html_code/phys/module_bl_myjpbl.F.html#PRODQ2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='707'>
                          <font color=#993300>SUBROUTINE </font><font color=#cc0000>PRODQ2</font>                            &amp; <A href='../../call_to/PRODQ2.html' TARGET='index'>1</A><a name='708'>
<font color=#447700>!----------------------------------------------------------------------<a name='709'></font>
<font color=#447700>!   ******************************************************************<a name='710'></font>
<font color=#447700>!   *                                                                *<a name='711'></font>
<font color=#447700>!   *            LEVEL 2.5 Q2 PRODUCTION/DISSIPATION                 *<a name='712'></font>
<font color=#447700>!   *                                                                *<a name='713'></font>
<font color=#447700>!   ******************************************************************<a name='714'></font>
<font color=#447700>!<a name='715'></font>
     &amp;(LMH,DTTURBL,USTAR,GM,GH,EL,Q2                                   &amp;<a name='716'>
     &amp;,IDS,IDE,JDS,JDE,KDS,KDE                                         &amp;<a name='717'>
     &amp;,IMS,IME,JMS,JME,KMS,KME                                         &amp;<a name='718'>
     &amp;,ITS,ITE,JTS,JTE,KTS,KTE)<a name='719'>
<font color=#447700>!----------------------------------------------------------------------<a name='720'></font>
<font color=#447700>!<a name='721'></font>
      IMPLICIT NONE<a name='722'>
<font color=#447700>!<a name='723'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='724'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='725'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='726'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='727'>
<font color=#447700>!<a name='728'></font>
      INTEGER,INTENT(IN) :: LMH<a name='729'>
<font color=#447700>!<a name='730'></font>
      REAL,INTENT(IN) :: DTTURBL,USTAR<a name='731'>
<font color=#447700>!<a name='732'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(IN) :: GH,GM<a name='733'>
      REAL,DIMENSION(KTS:KTE-1),INTENT(INOUT) :: EL<a name='734'>
<font color=#447700>!<a name='735'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(INOUT) :: Q2<a name='736'>
<font color=#447700>!----------------------------------------------------------------------<a name='737'></font>
<font color=#447700>!***<a name='738'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='739'></font>
<font color=#447700>!***<a name='740'></font>
      INTEGER :: K<a name='741'>
<font color=#447700>!<a name='742'></font>
      REAL :: ADEN,AEQU,ANUM,ARHS,BDEN,BEQU,BNUM,BRHS,CDEN,CRHS        &amp;<a name='743'>
     &amp;       ,DLOQ1,ELOQ11,ELOQ12,ELOQ13,ELOQ21,ELOQ22,ELOQ31,ELOQ32   &amp;<a name='744'>
     &amp;       ,ELOQ41,ELOQ42,ELOQ51,ELOQ52,ELOQN,EQOL2,GHL,GML          &amp;<a name='745'>
     &amp;       ,RDEN1,RDEN2,RHS2,RHSP1,RHSP2,RHST2<a name='746'>
<font color=#447700>!<a name='747'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='748'></font>
<font color=#447700>!**********************************************************************<a name='749'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='750'></font>
<font color=#447700>!<a name='751'></font>
      main_integration: DO K=1,LMH-1<a name='752'>
        GML=GM(K)<a name='753'>
        GHL=GH(K)<a name='754'>
<font color=#447700>!<a name='755'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='756'></font>
<font color=#447700>!***  COEFFICIENTS OF THE EQUILIBRIUM EQUATION<a name='757'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='758'></font>
<font color=#447700>!<a name='759'></font>
        AEQU=(AEQM*GML+AEQH*GHL)*GHL<a name='760'>
        BEQU= BEQM*GML+BEQH*GHL<a name='761'>
<font color=#447700>!<a name='762'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='763'></font>
<font color=#447700>!***  EQUILIBRIUM SOLUTION FOR L/Q<a name='764'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='765'></font>
<font color=#447700>!<a name='766'></font>
        EQOL2=-0.5*BEQU+SQRT(BEQU*BEQU*0.25-AEQU)<a name='767'>
<font color=#447700>!<a name='768'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='769'></font>
<font color=#447700>!***  IS THERE PRODUCTION/DISSIPATION ?<a name='770'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='771'></font>
<font color=#447700>!<a name='772'></font>
        IF((GML+GHL*GHL&lt;=EPSTRB)                                       &amp;<a name='773'>
     &amp;   .OR.(GHL&gt;=EPSGH.AND.GML/GHL&lt;=REQU)                            &amp;<a name='774'>
     &amp;   .OR.(EQOL2&lt;=EPS2))THEN<a name='775'>
<font color=#447700>!<a name='776'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='777'></font>
<font color=#447700>!***  NO TURBULENCE<a name='778'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='779'></font>
<font color=#447700>!<a name='780'></font>
          Q2(K)=EPSQ2<a name='781'>
          EL(K)=EPSL<a name='782'>
<font color=#447700>!----------------------------------------------------------------------<a name='783'></font>
<font color=#447700>!<a name='784'></font>
        ELSE<a name='785'>
<font color=#447700>!<a name='786'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='787'></font>
<font color=#447700>!***  TURBULENCE<a name='788'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='789'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='790'></font>
<font color=#447700>!***  COEFFICIENTS OF THE TERMS IN THE NUMERATOR<a name='791'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='792'></font>
<font color=#447700>!<a name='793'></font>
          ANUM=(ANMM*GML+ANMH*GHL)*GHL<a name='794'>
          BNUM= BNMM*GML+BNMH*GHL<a name='795'>
<font color=#447700>!<a name='796'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='797'></font>
<font color=#447700>!***  COEFFICIENTS OF THE TERMS IN THE DENOMINATOR<a name='798'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='799'></font>
<font color=#447700>!<a name='800'></font>
          ADEN=(ADNM*GML+ADNH*GHL)*GHL<a name='801'>
          BDEN= BDNM*GML+BDNH*GHL<a name='802'>
          CDEN= 1.<a name='803'>
<font color=#447700>!<a name='804'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='805'></font>
<font color=#447700>!***  COEFFICIENTS OF THE NUMERATOR OF THE LINEARIZED EQ.<a name='806'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='807'></font>
<font color=#447700>!<a name='808'></font>
          ARHS=-(ANUM*BDEN-BNUM*ADEN)*2.<a name='809'>
          BRHS=- ANUM*4.<a name='810'>
          CRHS=- BNUM*2.<a name='811'>
<font color=#447700>!<a name='812'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='813'></font>
<font color=#447700>!***  INITIAL VALUE OF L/Q<a name='814'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='815'></font>
<font color=#447700>!<a name='816'></font>
          DLOQ1=EL(K)/SQRT(Q2(K))<a name='817'>
<font color=#447700>!<a name='818'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='819'></font>
<font color=#447700>!***  FIRST ITERATION FOR L/Q, RHS=0<a name='820'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='821'></font>
<font color=#447700>!<a name='822'></font>
          ELOQ21=1./EQOL2<a name='823'>
          ELOQ11=SQRT(ELOQ21)<a name='824'>
          ELOQ31=ELOQ21*ELOQ11<a name='825'>
          ELOQ41=ELOQ21*ELOQ21<a name='826'>
          ELOQ51=ELOQ21*ELOQ31<a name='827'>
<font color=#447700>!<a name='828'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='829'></font>
<font color=#447700>!***  1./DENOMINATOR<a name='830'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='831'></font>
<font color=#447700>!<a name='832'></font>
          RDEN1=1./(ADEN*ELOQ41+BDEN*ELOQ21+CDEN)<a name='833'>
<font color=#447700>!<a name='834'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='835'></font>
<font color=#447700>!***  D(RHS)/D(L/Q)<a name='836'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='837'></font>
<font color=#447700>!<a name='838'></font>
          RHSP1=(ARHS*ELOQ51+BRHS*ELOQ31+CRHS*ELOQ11)*RDEN1*RDEN1<a name='839'>
<font color=#447700>!<a name='840'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='841'></font>
<font color=#447700>!***  FIRST-GUESS SOLUTION<a name='842'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='843'></font>
<font color=#447700>!<a name='844'></font>
          ELOQ12=ELOQ11+(DLOQ1-ELOQ11)*EXP(RHSP1*DTTURBL)<a name='845'>
          ELOQ12=MAX(ELOQ12,EPS1)<a name='846'>
<font color=#447700>!<a name='847'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='848'></font>
<font color=#447700>!***  SECOND ITERATION FOR L/Q<a name='849'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='850'></font>
<font color=#447700>!<a name='851'></font>
          ELOQ22=ELOQ12*ELOQ12<a name='852'>
          ELOQ32=ELOQ22*ELOQ12<a name='853'>
          ELOQ42=ELOQ22*ELOQ22<a name='854'>
          ELOQ52=ELOQ22*ELOQ32<a name='855'>
<font color=#447700>!<a name='856'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='857'></font>
<font color=#447700>!***  1./DENOMINATOR<a name='858'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='859'></font>
<font color=#447700>!<a name='860'></font>
          RDEN2=1./(ADEN*ELOQ42+BDEN*ELOQ22+CDEN)<a name='861'>
          RHS2 =-(ANUM*ELOQ42+BNUM*ELOQ22)*RDEN2+RB1<a name='862'>
          RHSP2= (ARHS*ELOQ52+BRHS*ELOQ32+CRHS*ELOQ12)*RDEN2*RDEN2<a name='863'>
          RHST2=RHS2/RHSP2<a name='864'>
<font color=#447700>!<a name='865'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='866'></font>
<font color=#447700>!***  CORRECTED SOLUTION<a name='867'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='868'></font>
<font color=#447700>!<a name='869'></font>
          ELOQ13=ELOQ12-RHST2+(RHST2+DLOQ1-ELOQ12)*EXP(RHSP2*DTTURBL)<a name='870'>
          ELOQ13=AMAX1(ELOQ13,EPS1)<a name='871'>
<font color=#447700>!<a name='872'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='873'></font>
<font color=#447700>!***  TWO ITERATIONS IS ENOUGH IN MOST CASES ...<a name='874'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='875'></font>
<font color=#447700>!<a name='876'></font>
          ELOQN=ELOQ13<a name='877'>
<font color=#447700>!<a name='878'></font>
          IF(ELOQN&gt;EPS1)THEN<a name='879'>
            Q2(K)=EL(K)*EL(K)/(ELOQN*ELOQN)<a name='880'>
            Q2(K)=AMAX1(Q2(K),EPSQ2)<a name='881'>
          ELSE<a name='882'>
            Q2(K)=EPSQ2<a name='883'>
          ENDIF<a name='884'>
<font color=#447700>!<a name='885'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='886'></font>
<font color=#447700>!***  END OF TURBULENT BRANCH<a name='887'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='888'></font>
<font color=#447700>!<a name='889'></font>
        ENDIF<a name='890'>
<font color=#447700>!----------------------------------------------------------------------<a name='891'></font>
<font color=#447700>!***  END OF PRODUCTION/DISSIPATION LOOP<a name='892'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='893'></font>
<font color=#447700>!<a name='894'></font>
      ENDDO main_integration<a name='895'>
<font color=#447700>!<a name='896'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='897'></font>
<font color=#447700>!***  LOWER BOUNDARY CONDITION FOR Q2<a name='898'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='899'></font>
<font color=#447700>!<a name='900'></font>
      Q2(LMH)=AMAX1(B1**(2./3.)*USTAR*USTAR,EPSQ2)<a name='901'>
<font color=#447700>!----------------------------------------------------------------------<a name='902'></font>
<font color=#447700>!<a name='903'></font>
      END SUBROUTINE PRODQ2<a name='904'>
<font color=#447700>!<a name='905'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='906'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='907'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='908'></font>
<A NAME='DIFCOF'><A href='../../html_code/phys/module_bl_myjpbl.F.html#DIFCOF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='909'>
                           <font color=#993300>SUBROUTINE </font><font color=#cc0000>DIFCOF</font>                           &amp; <A href='../../call_to/DIFCOF.html' TARGET='index'>1</A><a name='910'>
<font color=#447700>!   ******************************************************************<a name='911'></font>
<font color=#447700>!   *                                                                *<a name='912'></font>
<font color=#447700>!   *                LEVEL 2.5 DIFFUSION COEFFICIENTS                *<a name='913'></font>
<font color=#447700>!   *                                                                *<a name='914'></font>
<font color=#447700>!   ******************************************************************<a name='915'></font>
     &amp;(LMH,LPBL,GM,GH,EL,T,Q2,Z,AKM,AKH                                &amp;<a name='916'>
     &amp;,IDS,IDE,JDS,JDE,KDS,KDE                                         &amp;<a name='917'>
     &amp;,IMS,IME,JMS,JME,KMS,KME                                         &amp;<a name='918'>
     &amp;,ITS,ITE,JTS,JTE,KTS,KTE)<a name='919'>
<font color=#447700>!----------------------------------------------------------------------<a name='920'></font>
<font color=#447700>!<a name='921'></font>
      IMPLICIT NONE<a name='922'>
<font color=#447700>!<a name='923'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='924'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='925'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='926'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='927'>
<font color=#447700>!<a name='928'></font>
      INTEGER,INTENT(IN) :: LMH,LPBL<a name='929'>
<font color=#447700>!<a name='930'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(IN) :: Q2,T<a name='931'>
      REAL,DIMENSION(KTS:KTE-1),INTENT(IN) :: EL,GH,GM<a name='932'>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: Z<a name='933'>
<font color=#447700>!<a name='934'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(OUT) :: AKH,AKM<a name='935'>
<font color=#447700>!----------------------------------------------------------------------<a name='936'></font>
<font color=#447700>!***<a name='937'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='938'></font>
<font color=#447700>!***<a name='939'></font>
      INTEGER :: K,KINV<a name='940'>
<font color=#447700>!<a name='941'></font>
      REAL :: ADEN,AKMIN,BDEN,BESH,BESM,CDEN,D2T,ELL,ELOQ2,ELOQ4,ELQDZ &amp;<a name='942'>
     &amp;       ,ESH,ESM,GHL,GML,Q1L,RDEN,RDZ<a name='943'>
<font color=#447700>!<a name='944'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='945'></font>
<font color=#447700>!**********************************************************************<a name='946'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='947'></font>
<font color=#447700>!<a name='948'></font>
      DO K=1,LMH-1<a name='949'>
        ELL=EL(K)<a name='950'>
<font color=#447700>!<a name='951'></font>
        ELOQ2=ELL*ELL/Q2(K)<a name='952'>
        ELOQ4=ELOQ2*ELOQ2<a name='953'>
<font color=#447700>!<a name='954'></font>
        GML=GM(K)<a name='955'>
        GHL=GH(K)<a name='956'>
<font color=#447700>!<a name='957'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='958'></font>
<font color=#447700>!***  COEFFICIENTS OF THE TERMS IN THE DENOMINATOR<a name='959'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='960'></font>
<font color=#447700>!<a name='961'></font>
        ADEN=(ADNM*GML+ADNH*GHL)*GHL<a name='962'>
        BDEN= BDNM*GML+BDNH*GHL<a name='963'>
        CDEN= 1.<a name='964'>
<font color=#447700>!<a name='965'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='966'></font>
<font color=#447700>!***  COEFFICIENTS FOR THE SM DETERMINANT<a name='967'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='968'></font>
<font color=#447700>!<a name='969'></font>
        BESM=BSMH*GHL<a name='970'>
<font color=#447700>!<a name='971'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='972'></font>
<font color=#447700>!***  COEFFICIENTS FOR THE SH DETERMINANT<a name='973'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='974'></font>
<font color=#447700>!<a name='975'></font>
        BESH=BSHM*GML+BSHH*GHL<a name='976'>
<font color=#447700>!<a name='977'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='978'></font>
<font color=#447700>!***  1./DENOMINATOR<a name='979'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='980'></font>
<font color=#447700>!<a name='981'></font>
        RDEN=1./(ADEN*ELOQ4+BDEN*ELOQ2+CDEN)<a name='982'>
<font color=#447700>!<a name='983'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='984'></font>
<font color=#447700>!***  SM AND SH<a name='985'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='986'></font>
<font color=#447700>!<a name='987'></font>
        ESM=(BESM*ELOQ2+CESM)*RDEN<a name='988'>
        ESH=(BESH*ELOQ2+CESH)*RDEN<a name='989'>
<font color=#447700>!<a name='990'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='991'></font>
<font color=#447700>!***  DIFFUSION COEFFICIENTS<a name='992'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='993'></font>
<font color=#447700>!<a name='994'></font>
        RDZ=2./(Z(K)-Z(K+2))<a name='995'>
        Q1L=SQRT(Q2(K))<a name='996'>
        ELQDZ=ELL*Q1L*RDZ<a name='997'>
        AKM(K)=ELQDZ*ESM<a name='998'>
        AKH(K)=ELQDZ*ESH<a name='999'>
<font color=#447700>!----------------------------------------------------------------------<a name='1000'></font>
      ENDDO<a name='1001'>
<font color=#447700>!----------------------------------------------------------------------<a name='1002'></font>
<font color=#447700>!<a name='1003'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1004'></font>
<font color=#447700>!***  INVERSIONS<a name='1005'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1006'></font>
<font color=#447700>!<a name='1007'></font>
      IF(LPBL==LMH)THEN<a name='1008'>
        DO K=KTS+1,LMH-1<a name='1009'>
          D2T=T(K-1)-2.*T(K)+T(K+1)<a name='1010'>
          IF(D2T&lt;0.)KINV=K<a name='1011'>
        ENDDO<a name='1012'>
        IF(KINV&lt;LMH)THEN<a name='1013'>
          DO K=KINV-1,LMH-1<a name='1014'>
            RDZ=2./(Z(K)-Z(K+2))<a name='1015'>
            AKMIN=0.5*RDZ<a name='1016'>
            AKM(K)=MAX(AKM(K),AKMIN)<a name='1017'>
            AKH(K)=MAX(AKH(K),AKMIN)<a name='1018'>
          ENDDO<a name='1019'>
        ENDIF<a name='1020'>
      ENDIF<a name='1021'>
<font color=#447700>!----------------------------------------------------------------------<a name='1022'></font>
<font color=#447700>!<a name='1023'></font>
      END SUBROUTINE DIFCOF<a name='1024'>
<font color=#447700>!<a name='1025'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1026'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='1027'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1028'></font>
<A NAME='VDIFQ'><A href='../../html_code/phys/module_bl_myjpbl.F.html#VDIFQ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1029'>
                           <font color=#993300>SUBROUTINE </font><font color=#cc0000>VDIFQ</font>                            &amp; <A href='../../call_to/VDIFQ.html' TARGET='index'>1</A><a name='1030'>
<font color=#447700>!   ******************************************************************<a name='1031'></font>
<font color=#447700>!   *                                                                *<a name='1032'></font>
<font color=#447700>!   *               VERTICAL DIFFUSION OF Q2 (TKE)                   *<a name='1033'></font>
<font color=#447700>!   *                                                                *<a name='1034'></font>
<font color=#447700>!   ******************************************************************<a name='1035'></font>
     &amp;(LMH,DTDIF,Q2,EL,Z                                               &amp;<a name='1036'>
     &amp;,IDS,IDE,JDS,JDE,KDS,KDE                                         &amp;<a name='1037'>
     &amp;,IMS,IME,JMS,JME,KMS,KME                                         &amp;<a name='1038'>
     &amp;,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1039'>
<font color=#447700>!----------------------------------------------------------------------<a name='1040'></font>
<font color=#447700>!<a name='1041'></font>
      IMPLICIT NONE<a name='1042'>
<font color=#447700>!<a name='1043'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1044'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='1045'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='1046'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='1047'>
<font color=#447700>!<a name='1048'></font>
      INTEGER,INTENT(IN) :: LMH<a name='1049'>
<font color=#447700>!<a name='1050'></font>
      REAL,INTENT(IN) :: DTDIF<a name='1051'>
<font color=#447700>!<a name='1052'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(IN) :: EL<a name='1053'>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: Z<a name='1054'>
<font color=#447700>!<a name='1055'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(INOUT) :: Q2<a name='1056'>
<font color=#447700>!----------------------------------------------------------------------<a name='1057'></font>
<font color=#447700>!***<a name='1058'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='1059'></font>
<font color=#447700>!***<a name='1060'></font>
      INTEGER :: K<a name='1061'>
<font color=#447700>!<a name='1062'></font>
      REAL :: ADEN,AKQS,BDEN,BESH,BESM,CDEN,CF,DTOZS,ELL,ELOQ2,ELOQ4   &amp;<a name='1063'>
     &amp;       ,ELQDZ,ESH,ESM,ESQHF,GHL,GML,Q1L,RDEN,RDZ<a name='1064'>
<font color=#447700>!<a name='1065'></font>
      REAL,DIMENSION(KTS:KTE-2) :: AKQ,CM,CR,DTOZ,RSQ2<a name='1066'>
<font color=#447700>!----------------------------------------------------------------------<a name='1067'></font>
<font color=#447700>!**********************************************************************<a name='1068'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1069'></font>
<font color=#447700>!***<a name='1070'></font>
<font color=#447700>!***  VERTICAL TURBULENT DIFFUSION<a name='1071'></font>
<font color=#447700>!***<a name='1072'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1073'></font>
      ESQHF=0.5*ESQ<a name='1074'>
<font color=#447700>!<a name='1075'></font>
      DO K=KTS,LMH-2<a name='1076'>
        DTOZ(K)=(DTDIF+DTDIF)/(Z(K)-Z(K+2))<a name='1077'>
        AKQ(K)=SQRT((Q2(K)+Q2(K+1))*0.5)*(EL(K)+EL(K+1))*ESQHF         &amp;<a name='1078'>
     &amp;        /(Z(K+1)-Z(K+2))<a name='1079'>
        CR(K)=-DTOZ(K)*AKQ(K)<a name='1080'>
      ENDDO<a name='1081'>
<font color=#447700>!<a name='1082'></font>
      CM(1)=DTOZ(1)*AKQ(1)+1.<a name='1083'>
      RSQ2(1)=Q2(1)<a name='1084'>
<font color=#447700>!<a name='1085'></font>
      DO K=KTS+1,LMH-2<a name='1086'>
        CF=-DTOZ(K)*AKQ(K-1)/CM(K-1)<a name='1087'>
        CM(K)=-CR(K-1)*CF+(AKQ(K-1)+AKQ(K))*DTOZ(K)+1.<a name='1088'>
        RSQ2(K)=-RSQ2(K-1)*CF+Q2(K)<a name='1089'>
      ENDDO<a name='1090'>
<font color=#447700>!<a name='1091'></font>
      DTOZS=(DTDIF+DTDIF)/(Z(LMH-1)-Z(LMH+1))<a name='1092'>
      AKQS=SQRT((Q2(LMH-1)+Q2(LMH))*0.5)*(EL(LMH-1)+ELZ0)*ESQHF        &amp;<a name='1093'>
     &amp;    /(Z(LMH)-Z(LMH+1))<a name='1094'>
<font color=#447700>!<a name='1095'></font>
      CF=-DTOZS*AKQ(LMH-2)/CM(LMH-2)<a name='1096'>
<font color=#447700>!<a name='1097'></font>
      Q2(LMH-1)=(DTOZS*AKQS*Q2(LMH)-RSQ2(LMH-2)*CF+Q2(LMH-1))          &amp;<a name='1098'>
     &amp;        /((AKQ(LMH-2)+AKQS)*DTOZS-CR(LMH-2)*CF+1.)<a name='1099'>
<font color=#447700>!<a name='1100'></font>
      DO K=LMH-2,KTS,-1<a name='1101'>
        Q2(K)=(-CR(K)*Q2(K+1)+RSQ2(K))/CM(K)<a name='1102'>
      ENDDO<a name='1103'>
<font color=#447700>!----------------------------------------------------------------------<a name='1104'></font>
<font color=#447700>!<a name='1105'></font>
      END SUBROUTINE VDIFQ<a name='1106'>
<font color=#447700>!<a name='1107'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1108'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='1109'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1110'></font>
<A NAME='VDIFH'><A href='../../html_code/phys/module_bl_myjpbl.F.html#VDIFH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1111'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>VDIFH</font>(DTDIF,LMH,THZ0,QZ0,AKHS,CHKLOWQ,CT             &amp; <A href='../../call_to/VDIFH.html' TARGET='index'>1</A><a name='1112'>
     &amp;                ,THE,Q,CWM,AKH,Z                                &amp;<a name='1113'>
     &amp;                ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='1114'>
     &amp;                ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='1115'>
     &amp;                ,ITS,ITE,JTS,JTE,KTS,KTE,i,j)<a name='1116'>
<font color=#447700>!     ***************************************************************<a name='1117'></font>
<font color=#447700>!     *                                                             *<a name='1118'></font>
<font color=#447700>!     *         VERTICAL DIFFUSION OF MASS VARIABLES                *<a name='1119'></font>
<font color=#447700>!     *                                                             *<a name='1120'></font>
<font color=#447700>!     ***************************************************************<a name='1121'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1122'></font>
<font color=#447700>!<a name='1123'></font>
      IMPLICIT NONE<a name='1124'>
<font color=#447700>!<a name='1125'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1126'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='1127'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='1128'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE,i,j<a name='1129'>
<font color=#447700>!<a name='1130'></font>
      INTEGER,INTENT(IN) :: LMH<a name='1131'>
<font color=#447700>!<a name='1132'></font>
      REAL,INTENT(IN) :: AKHS,CHKLOWQ,CT,DTDIF,QZ0,THZ0<a name='1133'>
<font color=#447700>!<a name='1134'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(IN) :: AKH<a name='1135'>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: Z<a name='1136'>
      REAL,DIMENSION(KTS:KTE),INTENT(INOUT) :: CWM,Q,THE<a name='1137'>
<font color=#447700>! <a name='1138'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1139'></font>
<font color=#447700>!***<a name='1140'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='1141'></font>
<font color=#447700>!***<a name='1142'></font>
      INTEGER :: K<a name='1143'>
<font color=#447700>!<a name='1144'></font>
      REAL :: AKHH,AKQS,CF,CMB,CMCB,CMQB,CMTB,CTHF,DTOZL,DTOZS         &amp;<a name='1145'>
     &amp;       ,RCML,RSCB,RSQB,RSTB<a name='1146'>
<font color=#447700>!<a name='1147'></font>
      REAL,DIMENSION(KTS:KTE-1) :: AKCT,CM,CR,DTOZ,RSC,RSQ,RST<a name='1148'>
<font color=#447700>!<a name='1149'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1150'></font>
<font color=#447700>!**********************************************************************<a name='1151'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1152'></font>
      CTHF=0.5*CT<a name='1153'>
<font color=#447700>!<a name='1154'></font>
      DO K=KTS,LMH-1<a name='1155'>
        DTOZ(K)=DTDIF/(Z(K)-Z(K+1))<a name='1156'>
        CR(K)=-DTOZ(K)*AKH(K)<a name='1157'>
        AKCT(K)=AKH(K)*(Z(K)-Z(K+2))*CTHF<a name='1158'>
      ENDDO<a name='1159'>
<font color=#447700>!<a name='1160'></font>
      CM(KTS)=DTOZ(KTS)*AKH(KTS)+1.<a name='1161'>
<font color=#447700>!----------------------------------------------------------------------<a name='1162'></font>
      RST(KTS)=-AKCT(KTS)*DTOZ(KTS)+THE(KTS)<a name='1163'>
      RSQ(KTS)=Q(KTS)<a name='1164'>
      RSC(KTS)=CWM(KTS)<a name='1165'>
<font color=#447700>!----------------------------------------------------------------------<a name='1166'></font>
      DO K=KTS+1,LMH-1<a name='1167'>
        DTOZL=DTOZ(K)<a name='1168'>
        CF=-DTOZL*AKH(K-1)/CM(K-1)<a name='1169'>
        CM(K)=-CR(K-1)*CF+(AKH(K-1)+AKH(K))*DTOZL+1.<a name='1170'>
        RST(K)=-RST(K-1)*CF+(AKCT(K-1)-AKCT(K))*DTOZL+THE(K)<a name='1171'>
        RSQ(K)=-RSQ(K-1)*CF+Q(K)<a name='1172'>
        RSC(K)=-RSC(K-1)*CF+CWM(K)<a name='1173'>
      ENDDO<a name='1174'>
<font color=#447700>!<a name='1175'></font>
      DTOZS=DTDIF/(Z(LMH)-Z(LMH+1))<a name='1176'>
      AKHH=AKH(LMH-1)<a name='1177'>
<font color=#447700>!<a name='1178'></font>
      CF=-DTOZS*AKHH/CM(LMH-1)<a name='1179'>
      AKQS=AKHS*CHKLOWQ<a name='1180'>
<font color=#447700>!<a name='1181'></font>
      CMB=CR(LMH-1)*CF<a name='1182'>
      CMTB=-CMB+(AKHH+AKHS)*DTOZS+1.<a name='1183'>
      CMQB=-CMB+(AKHH+AKQS)*DTOZS+1.<a name='1184'>
      CMCB=-CMB+(AKHH     )*DTOZS+1.<a name='1185'>
<font color=#447700>!<a name='1186'></font>
      RSTB=-RST(LMH-1)*CF+(AKCT(LMH-1)-AKHS*CT)*DTOZS+THE(LMH)<a name='1187'>
      RSQB=-RSQ(LMH-1)*CF+Q(LMH)<a name='1188'>
      RSCB=-RSC(LMH-1)*CF+CWM(LMH)<a name='1189'>
<font color=#447700>!----------------------------------------------------------------------<a name='1190'></font>
      THE(LMH)=(DTOZS*AKHS*THZ0+RSTB)/CMTB<a name='1191'>
      Q(LMH)  =(DTOZS*AKQS*QZ0 +RSQB)/CMQB<a name='1192'>
      CWM(LMH)=(                RSCB)/CMCB<a name='1193'>
<font color=#447700>!----------------------------------------------------------------------<a name='1194'></font>
      DO K=LMH-1,KTS,-1<a name='1195'>
        RCML=1./CM(K)<a name='1196'>
        THE(K)=(-CR(K)*THE(K+1)+RST(K))*RCML<a name='1197'>
        Q(K)  =(-CR(K)*  Q(K+1)+RSQ(K))*RCML<a name='1198'>
        CWM(K)=(-CR(K)*CWM(K+1)+RSC(K))*RCML<a name='1199'>
      ENDDO<a name='1200'>
<font color=#447700>!----------------------------------------------------------------------<a name='1201'></font>
<font color=#447700>!<a name='1202'></font>
      END SUBROUTINE VDIFH<a name='1203'>
<a name='1204'>
<font color=#447700>!---------------------------------------------------------------------<a name='1205'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='1206'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1207'></font>
<A NAME='VDIFV'><A href='../../html_code/phys/module_bl_myjpbl.F.html#VDIFV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1208'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>VDIFV</font>(LMH,DTDIF,UZ0,VZ0,AKMS,U,V,AKM,Z               &amp; <A href='../../call_to/VDIFV.html' TARGET='index'>1</A><a name='1209'>
     &amp;                ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='1210'>
     &amp;                ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='1211'>
                      ,ITS,ITE,JTS,JTE,KTS,KTE,i,j)<a name='1212'>
<font color=#447700>!     ***************************************************************<a name='1213'></font>
<font color=#447700>!     *                                                             *<a name='1214'></font>
<font color=#447700>!     *        VERTICAL DIFFUSION OF VELOCITY COMPONENTS            *<a name='1215'></font>
<font color=#447700>!     *                                                             *<a name='1216'></font>
<font color=#447700>!     ***************************************************************<a name='1217'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1218'></font>
<font color=#447700>!<a name='1219'></font>
      IMPLICIT NONE<a name='1220'>
<font color=#447700>!<a name='1221'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1222'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                   &amp;<a name='1223'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                   &amp;<a name='1224'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE,i,j<a name='1225'>
<font color=#447700>!<a name='1226'></font>
      INTEGER,INTENT(IN) :: LMH<a name='1227'>
<font color=#447700>!<a name='1228'></font>
      REAL,INTENT(IN) :: AKMS,DTDIF,UZ0,VZ0<a name='1229'>
<font color=#447700>!<a name='1230'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(IN) :: AKM<a name='1231'>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: Z<a name='1232'>
<font color=#447700>!<a name='1233'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(INOUT) :: U,V<a name='1234'>
<font color=#447700>!----------------------------------------------------------------------<a name='1235'></font>
<font color=#447700>!***<a name='1236'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='1237'></font>
<font color=#447700>!***<a name='1238'></font>
      INTEGER :: K<a name='1239'>
<font color=#447700>!<a name='1240'></font>
      REAL :: AKMH,CF,DTOZAK,DTOZL,DTOZS,RCML,RCMVB<a name='1241'>
<font color=#447700>!<a name='1242'></font>
      REAL,DIMENSION(KTS:KTE-1) :: CM,CR,DTOZ,RSU,RSV<a name='1243'>
<font color=#447700>!----------------------------------------------------------------------<a name='1244'></font>
<font color=#447700>!**********************************************************************<a name='1245'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1246'></font>
      DO K=1,LMH-1<a name='1247'>
        DTOZ(K)=DTDIF/(Z(K)-Z(K+1))<a name='1248'>
        CR(K)=-DTOZ(K)*AKM(K)<a name='1249'>
      ENDDO<a name='1250'>
<font color=#447700>!<a name='1251'></font>
      CM(1)=DTOZ(1)*AKM(1)+1.<a name='1252'>
      RSU(1)=U(1)<a name='1253'>
      RSV(1)=V(1)<a name='1254'>
<font color=#447700>!----------------------------------------------------------------------<a name='1255'></font>
      DO K=2,LMH-1<a name='1256'>
        DTOZL=DTOZ(K)<a name='1257'>
        CF=-DTOZL*AKM(K-1)/CM(K-1)<a name='1258'>
        CM(K)=-CR(K-1)*CF+(AKM(K-1)+AKM(K))*DTOZL+1.<a name='1259'>
        RSU(K)=-RSU(K-1)*CF+U(K)<a name='1260'>
        RSV(K)=-RSV(K-1)*CF+V(K)<a name='1261'>
      ENDDO<a name='1262'>
<font color=#447700>!----------------------------------------------------------------------<a name='1263'></font>
      DTOZS=DTDIF/(Z(LMH)-Z(LMH+1))<a name='1264'>
      AKMH=AKM(LMH-1)<a name='1265'>
<font color=#447700>!<a name='1266'></font>
      CF=-DTOZS*AKMH/CM(LMH-1)<a name='1267'>
      RCMVB=1./((AKMH+AKMS)*DTOZS-CR(LMH-1)*CF+1.)<a name='1268'>
      DTOZAK=DTOZS*AKMS<a name='1269'>
<font color=#447700>!----------------------------------------------------------------------<a name='1270'></font>
      U(LMH)=(DTOZAK*UZ0-RSU(LMH-1)*CF+U(LMH))*RCMVB<a name='1271'>
      V(LMH)=(DTOZAK*VZ0-RSV(LMH-1)*CF+V(LMH))*RCMVB<a name='1272'>
<font color=#447700>!----------------------------------------------------------------------<a name='1273'></font>
      DO K=LMH-1,1,-1<a name='1274'>
        RCML=1./CM(K)<a name='1275'>
        U(K)=(-CR(K)*U(K+1)+RSU(K))*RCML<a name='1276'>
        V(K)=(-CR(K)*V(K+1)+RSV(K))*RCML<a name='1277'>
      ENDDO<a name='1278'>
<font color=#447700>!----------------------------------------------------------------------<a name='1279'></font>
<font color=#447700>!<a name='1280'></font>
      END SUBROUTINE VDIFV<a name='1281'>
<font color=#447700>!<a name='1282'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1283'></font>
<font color=#447700>!<a name='1284'></font>
<font color=#447700>!=======================================================================<a name='1285'></font>
<A NAME='MYJPBLINIT'><A href='../../html_code/phys/module_bl_myjpbl.F.html#MYJPBLINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1286'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MYJPBLINIT</font>(RUBLTEN,RVBLTEN,RTHBLTEN,RQVBLTEN,          &amp; <A href='../../call_to/MYJPBLINIT.html' TARGET='index'>1</A><a name='1287'>
     &amp;                      TKE_MYJ,EXCH_H,RESTART,ALLOWED_TO_READ,     &amp;<a name='1288'>
     &amp;                      IDS,IDE,JDS,JDE,KDS,KDE,                    &amp;<a name='1289'>
     &amp;                      IMS,IME,JMS,JME,KMS,KME,                    &amp;<a name='1290'>
     &amp;                      ITS,ITE,JTS,JTE,KTS,KTE                 )<a name='1291'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1292'></font>
      IMPLICIT NONE<a name='1293'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1294'></font>
      LOGICAL,INTENT(IN) :: ALLOWED_TO_READ,RESTART<a name='1295'>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE,                    &amp;<a name='1296'>
     &amp;                      IMS,IME,JMS,JME,KMS,KME,                    &amp;<a name='1297'>
     &amp;                      ITS,ITE,JTS,JTE,KTS,KTE<a name='1298'>
<a name='1299'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) ::    EXCH_H, &amp;<a name='1300'>
     &amp;                                                         RUBLTEN, &amp;<a name='1301'>
     &amp;                                                         RVBLTEN, &amp;<a name='1302'>
     &amp;                                                        RTHBLTEN, &amp;<a name='1303'>
     &amp;                                                        RQVBLTEN, &amp;<a name='1304'>
     &amp;                                                         TKE_MYJ<a name='1305'>
      INTEGER :: I,J,K,ITF,JTF,KTF<a name='1306'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1307'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1308'></font>
<a name='1309'>
      JTF=MIN0(JTE,JDE-1)<a name='1310'>
      KTF=MIN0(KTE,KDE-1)<a name='1311'>
      ITF=MIN0(ITE,IDE-1)<a name='1312'>
<a name='1313'>
      IF(.NOT.RESTART)THEN<a name='1314'>
        DO J=JTS,JTF<a name='1315'>
        DO K=KTS,KTF<a name='1316'>
        DO I=ITS,ITF<a name='1317'>
          TKE_MYJ(I,K,J)=EPSQ2<a name='1318'>
          RUBLTEN(I,K,J)=0.<a name='1319'>
          RVBLTEN(I,K,J)=0.<a name='1320'>
          RTHBLTEN(I,K,J)=0.<a name='1321'>
          RQVBLTEN(I,K,J)=0.<a name='1322'>
          EXCH_H(I,K,J)=0.<a name='1323'>
        ENDDO<a name='1324'>
        ENDDO<a name='1325'>
        ENDDO<a name='1326'>
      ENDIF<a name='1327'>
<a name='1328'>
      END SUBROUTINE MYJPBLINIT<a name='1329'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1330'></font>
<font color=#447700>!<a name='1331'></font>
      END MODULE MODULE_BL_MYJPBL<a name='1332'>
<font color=#447700>!<a name='1333'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1334'></font>
</pre></body></html>