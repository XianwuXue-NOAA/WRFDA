<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_CU_KFETA'><A href='../../html_code/phys/module_cu_kfeta.F.html#MODULE_CU_KFETA' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_kfeta</font> <A href='../../call_to/MODULE_CU_KFETA.html' TARGET='index'>3</A><a name='3'>
<a name='4'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_cu_kfeta.F.html#module_cu_kfeta.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_34"><a name='5'>
<a name='6'>
<font color=#447700>!--------------------------------------------------------------------<a name='7'></font>
<font color=#447700>! Lookup table variables:<a name='8'></font>
      INTEGER, PARAMETER :: KFNT=250,KFNP=220<a name='9'>
      REAL, DIMENSION(KFNT,KFNP),PRIVATE, SAVE :: TTAB,QSTAB<a name='10'>
      REAL, DIMENSION(KFNP),PRIVATE, SAVE :: THE0K<a name='11'>
      REAL, DIMENSION(200),PRIVATE, SAVE :: ALU<a name='12'>
      REAL, PRIVATE, SAVE :: RDPR,RDTHK,PLUTOP<a name='13'>
<font color=#447700>! Note:  KF Lookup table is used by subroutines KF_eta_PARA, TPMIX2,<a name='14'></font>
<font color=#447700>!        TPMIX2DD, ENVIRTHT<a name='15'></font>
<font color=#447700>! End of Lookup table variables:<a name='16'></font>
<a name='17'>
CONTAINS<a name='18'>
<a name='19'>
<A NAME='KF_ETA_CPS'><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_CPS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='20'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>KF_eta_CPS</font>(                                    &amp; <A href='../../call_to/KF_ETA_CPS.html' TARGET='index'>1</A>,<A href='../../call_from/KF_ETA_CPS.html' TARGET='index'>3</A><a name='21'>
              ids,ide, jds,jde, kds,kde                      &amp;<a name='22'>
             ,ims,ime, jms,jme, kms,kme                      &amp;<a name='23'>
             ,its,ite, jts,jte, kts,kte                      &amp;<a name='24'>
             ,DT,KTAU,DX                                     &amp;<a name='25'>
             ,rho,RAINCV,NCA                                 &amp;<a name='26'>
             ,U,V,TH,T,W,dz8w,Pcps,pi                        &amp;<a name='27'>
             ,W0AVG,XLV0,XLV1,XLS0,XLS1,CP,R,G,EP1           &amp;<a name='28'>
             ,EP2,SVP1,SVP2,SVP3,SVPT0                       &amp;<a name='29'>
             ,STEPCU,CU_ACT_FLAG,warm_rain,CUTOP,CUBOT       &amp;<a name='30'>
             ,QV                                             &amp;<a name='31'>
            <font color=#447700>! optionals<a name='32'></font>
             ,F_QV    ,F_QC    ,F_QR    ,F_QI    ,F_QS       &amp;<a name='33'>
             ,RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN            &amp;<a name='34'>
             ,RQICUTEN,RQSCUTEN                              &amp;<a name='35'>
                                                             )<a name='36'>
<font color=#447700>!<a name='37'></font>
<font color=#447700>!-------------------------------------------------------------<a name='38'></font>
   IMPLICIT NONE<a name='39'>
<font color=#447700>!-------------------------------------------------------------<a name='40'></font>
   INTEGER,      INTENT(IN   ) ::                            &amp;<a name='41'>
                                  ids,ide, jds,jde, kds,kde, &amp;<a name='42'>
                                  ims,ime, jms,jme, kms,kme, &amp;<a name='43'>
                                  its,ite, jts,jte, kts,kte<a name='44'>
<a name='45'>
   INTEGER,      INTENT(IN   ) :: STEPCU<a name='46'>
   LOGICAL,      INTENT(IN   ) :: warm_rain<a name='47'>
<a name='48'>
   REAL,         INTENT(IN   ) :: XLV0,XLV1,XLS0,XLS1<a name='49'>
   REAL,         INTENT(IN   ) :: CP,R,G,EP1,EP2<a name='50'>
   REAL,         INTENT(IN   ) :: SVP1,SVP2,SVP3,SVPT0<a name='51'>
<a name='52'>
   INTEGER,      INTENT(IN   ) :: KTAU           <a name='53'>
<a name='54'>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='55'>
          INTENT(IN   ) ::                                   &amp;<a name='56'>
                                                          U, &amp;<a name='57'>
                                                          V, &amp;<a name='58'>
                                                          W, &amp;<a name='59'>
                                                         TH, &amp;<a name='60'>
                                                          T, &amp;<a name='61'>
                                                         QV, &amp;<a name='62'>
                                                       dz8w, &amp;<a name='63'>
                                                       Pcps, &amp;<a name='64'>
                                                        rho, &amp;<a name='65'>
                                                         pi<a name='66'>
<font color=#447700>!<a name='67'></font>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='68'>
          INTENT(INOUT) ::                                   &amp;<a name='69'>
                                                      W0AVG<a name='70'>
<a name='71'>
   REAL,  INTENT(IN   ) :: DT, DX<a name='72'>
<font color=#447700>!<a name='73'></font>
   REAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='74'>
          INTENT(INOUT) ::                           RAINCV<a name='75'>
<a name='76'>
   REAL,    DIMENSION( ims:ime , jms:jme ),                  &amp;<a name='77'>
            INTENT(INOUT) ::                            NCA<a name='78'>
<a name='79'>
   REAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='80'>
          INTENT(OUT) ::                              CUBOT, &amp;<a name='81'>
                                                      CUTOP    <a name='82'>
<a name='83'>
   LOGICAL, DIMENSION( ims:ime , jms:jme ),                  &amp;<a name='84'>
          INTENT(INOUT) :: CU_ACT_FLAG<a name='85'>
<a name='86'>
<font color=#447700>!<a name='87'></font>
<font color=#447700>! Optional arguments<a name='88'></font>
<font color=#447700>!<a name='89'></font>
<a name='90'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),           &amp;<a name='91'>
         OPTIONAL,                                           &amp;<a name='92'>
         INTENT(INOUT) ::                                    &amp;<a name='93'>
                                                   RTHCUTEN, &amp;<a name='94'>
                                                   RQVCUTEN, &amp;<a name='95'>
                                                   RQCCUTEN, &amp;<a name='96'>
                                                   RQRCUTEN, &amp;<a name='97'>
                                                   RQICUTEN, &amp;<a name='98'>
                                                   RQSCUTEN<a name='99'>
<a name='100'>
<font color=#447700>!<a name='101'></font>
<font color=#447700>! Flags relating to the optional tendency arrays declared above<a name='102'></font>
<font color=#447700>! Models that carry the optional tendencies will provdide the<a name='103'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='104'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in<a name='105'></font>
<font color=#447700>! use or not.<a name='106'></font>
<font color=#447700>!<a name='107'></font>
   LOGICAL, OPTIONAL ::                                      &amp;<a name='108'>
                                                   F_QV      &amp;<a name='109'>
                                                  ,F_QC      &amp;<a name='110'>
                                                  ,F_QR      &amp;<a name='111'>
                                                  ,F_QI      &amp;<a name='112'>
                                                  ,F_QS<a name='113'>
<a name='114'>
<a name='115'>
<font color=#447700>! LOCAL VARS<a name='116'></font>
<a name='117'>
   LOGICAL :: flag_qr, flag_qi, flag_qs<a name='118'>
<a name='119'>
   REAL, DIMENSION( kts:kte ) ::                             &amp;<a name='120'>
                                                        U1D, &amp;<a name='121'>
                                                        V1D, &amp;<a name='122'>
                                                        T1D, &amp;<a name='123'>
                                                       DZ1D, &amp;<a name='124'>
                                                       QV1D, &amp;<a name='125'>
                                                        P1D, &amp;<a name='126'>
                                                      RHO1D, &amp;<a name='127'>
                                                    W0AVG1D<a name='128'>
<a name='129'>
   REAL, DIMENSION( kts:kte )::                              &amp;<a name='130'>
                                                       DQDT, &amp;<a name='131'>
                                                      DQIDT, &amp;<a name='132'>
                                                      DQCDT, &amp;<a name='133'>
                                                      DQRDT, &amp;<a name='134'>
                                                      DQSDT, &amp;<a name='135'>
                                                       DTDT<a name='136'>
<a name='137'>
   REAL    ::         TST,tv,PRS,RHOE,W0,SCR1,DXSQ,tmp,RTHCUMAX<a name='138'>
<a name='139'>
   INTEGER :: i,j,k,NTST,ICLDCK<a name='140'>
<font color=#447700>!<a name='141'></font>
   DXSQ=DX*DX<a name='142'>
<a name='143'>
<font color=#447700>!----------------------<a name='144'></font>
   NTST=STEPCU<a name='145'>
   TST=float(NTST*2)<a name='146'>
   flag_qr = .FALSE.<a name='147'>
   flag_qi = .FALSE.<a name='148'>
   flag_qs = .FALSE.<a name='149'>
   IF ( PRESENT(F_QR) ) flag_qr = F_QR<a name='150'>
   IF ( PRESENT(F_QI) ) flag_qi = F_QI<a name='151'>
   IF ( PRESENT(F_QS) ) flag_qs = F_QS<a name='152'>
<font color=#447700>!<a name='153'></font>
  DO J = jts,jte<a name='154'>
      DO K=kts,kte<a name='155'>
         DO I= its,ite<a name='156'>
<font color=#447700>!            SCR1=-5.0E-4*G*rho(I,K,J)*(w(I,K,J)+w(I,K+1,J))<a name='157'></font>
<font color=#447700>!            TV=T(I,K,J)*(1.+EP1*QV(I,K,J))<a name='158'></font>
<font color=#447700>!            RHOE=Pcps(I,K,J)/(R*TV)<a name='159'></font>
<font color=#447700>!            W0=-101.9368*SCR1/RHOE<a name='160'></font>
            W0=0.5*(w(I,K,J)+w(I,K+1,J))<a name='161'>
            W0AVG(I,K,J)=(W0AVG(I,K,J)*(TST-1.)+W0)/TST<a name='162'>
         ENDDO<a name='163'>
      ENDDO<a name='164'>
   ENDDO<a name='165'>
<font color=#447700>!<a name='166'></font>
<font color=#447700>!...CHECK FOR CONVECTIVE INITIATION EVERY 5 MINUTES (OR NTST/2)...<a name='167'></font>
<font color=#447700>!<a name='168'></font>
<font color=#447700>!----------------------<a name='169'></font>
   ICLDCK=MOD(KTAU,NTST)<a name='170'>
   IF(ICLDCK.EQ.0 .or. KTAU .eq. 1) then<a name='171'>
<font color=#447700>!<a name='172'></font>
     DO J = jts,jte<a name='173'>
     DO I= its,ite<a name='174'>
        CU_ACT_FLAG(i,j) = .true.<a name='175'>
     ENDDO<a name='176'>
     ENDDO<a name='177'>
<a name='178'>
     DO J = jts,jte<a name='179'>
       DO I=its,ite<a name='180'>
<a name='181'>
         IF ( NINT(NCA(I,J)) .gt. 0 ) then<a name='182'>
            CU_ACT_FLAG(i,j) = .false.<a name='183'>
         ELSE<a name='184'>
<a name='185'>
            DO k=kts,kte<a name='186'>
               DQDT(k)=0.<a name='187'>
               DQIDT(k)=0.<a name='188'>
               DQCDT(k)=0.<a name='189'>
               DQRDT(k)=0.<a name='190'>
               DQSDT(k)=0.<a name='191'>
               DTDT(k)=0.<a name='192'>
            ENDDO<a name='193'>
            RAINCV(I,J)=0.<a name='194'>
<font color=#447700>!<a name='195'></font>
<font color=#447700>! assign vars from 3D to 1D<a name='196'></font>
<a name='197'>
            DO K=kts,kte<a name='198'>
               U1D(K) =U(I,K,J)<a name='199'>
               V1D(K) =V(I,K,J)<a name='200'>
               T1D(K) =T(I,K,J)<a name='201'>
               RHO1D(K) =rho(I,K,J)<a name='202'>
               QV1D(K)=QV(I,K,J)<a name='203'>
               P1D(K) =Pcps(I,K,J)<a name='204'>
               W0AVG1D(K) =W0AVG(I,K,J)<a name='205'>
               DZ1D(k)=dz8w(I,K,J)<a name='206'>
            ENDDO<a name='207'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_146">(500,'in kf_eta_para')<a name='208'>
            CALL <A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA'>KF_eta_PARA</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KF_ETA_PARA_1">(I, J,                  &amp;<a name='209'>
                 U1D,V1D,T1D,QV1D,P1D,DZ1D,         &amp;<a name='210'>
                 W0AVG1D,DT,DX,DXSQ,RHO1D,          &amp;<a name='211'>
                 XLV0,XLV1,XLS0,XLS1,CP,R,G,        &amp;<a name='212'>
                 EP2,SVP1,SVP2,SVP3,SVPT0,          &amp;<a name='213'>
                 DQDT,DQIDT,DQCDT,DQRDT,DQSDT,DTDT, &amp;<a name='214'>
                 RAINCV,NCA,NTST,                   &amp;<a name='215'>
                 flag_QI,flag_QS,warm_rain,         &amp;<a name='216'>
                 CUTOP,CUBOT,                       &amp;<a name='217'>
                 ids,ide, jds,jde, kds,kde,         &amp;<a name='218'>
                 ims,ime, jms,jme, kms,kme,         &amp;<a name='219'>
                 its,ite, jts,jte, kts,kte)<a name='220'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_147">(500,'after kf_eta_para')<a name='221'>
            IF(PRESENT(rthcuten).AND.PRESENT(rqvcuten)) THEN<a name='222'>
              DO K=kts,kte<a name='223'>
                 RTHCUTEN(I,K,J)=DTDT(K)/pi(I,K,J)<a name='224'>
<font color=#447700>!              RTHCUMAX=max(abs(RTHCUTEN(I,K,J)),RTHCUMAX)<a name='225'></font>
                 RQVCUTEN(I,K,J)=DQDT(K)<a name='226'>
              ENDDO<a name='227'>
            ENDIF<a name='228'>
<a name='229'>
            IF(PRESENT(rqrcuten).AND.PRESENT(rqccuten)) THEN<a name='230'>
              IF( F_QR )THEN<a name='231'>
                DO K=kts,kte<a name='232'>
                   RQRCUTEN(I,K,J)=DQRDT(K)<a name='233'>
                   RQCCUTEN(I,K,J)=DQCDT(K)<a name='234'>
                ENDDO<a name='235'>
              ELSE<a name='236'>
<font color=#447700>! This is the case for Eta microphysics without 3d rain field<a name='237'></font>
                DO K=kts,kte<a name='238'>
                   RQRCUTEN(I,K,J)=0.<a name='239'>
                   RQCCUTEN(I,K,J)=DQRDT(K)+DQCDT(K)<a name='240'>
                ENDDO<a name='241'>
              ENDIF<a name='242'>
            ENDIF<a name='243'>
<a name='244'>
<font color=#447700>!......     QSTEN STORES GRAUPEL TENDENCY IF IT EXISTS, OTHERISE SNOW (V2)<a name='245'></font>
<a name='246'>
<a name='247'>
            IF(PRESENT( rqicuten )) THEN<a name='248'>
              IF ( F_QI ) THEN<a name='249'>
                DO K=kts,kte<a name='250'>
                   RQICUTEN(I,K,J)=DQIDT(K)<a name='251'>
                ENDDO<a name='252'>
              ENDIF<a name='253'>
            ENDIF<a name='254'>
<a name='255'>
            IF(PRESENT( rqscuten )) THEN<a name='256'>
              IF ( F_QS ) THEN<a name='257'>
                DO K=kts,kte<a name='258'>
                   RQSCUTEN(I,K,J)=DQSDT(K)<a name='259'>
                ENDDO<a name='260'>
              ENDIF<a name='261'>
            ENDIF<a name='262'>
<font color=#447700>!<a name='263'></font>
         ENDIF <a name='264'>
       ENDDO<a name='265'>
     ENDDO<a name='266'>
   ENDIF<a name='267'>
<font color=#447700>!<a name='268'></font>
   END SUBROUTINE KF_eta_CPS<a name='269'>
<font color=#447700>! ****************************************************************************<a name='270'></font>
<font color=#447700>!-----------------------------------------------------------<a name='271'></font>
<A NAME='KF_ETA_PARA'><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='272'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>KF_eta_PARA</font> (I, J,                           &amp; <A href='../../call_to/KF_ETA_PARA.html' TARGET='index'>1</A>,<A href='../../call_from/KF_ETA_PARA.html' TARGET='index'>17</A><a name='273'>
                      U0,V0,T0,QV0,P0,DZQ,W0AVG1D,         &amp;<a name='274'>
                      DT,DX,DXSQ,rhoe,                     &amp;<a name='275'>
                      XLV0,XLV1,XLS0,XLS1,CP,R,G,          &amp;<a name='276'>
                      EP2,SVP1,SVP2,SVP3,SVPT0,            &amp;<a name='277'>
                      DQDT,DQIDT,DQCDT,DQRDT,DQSDT,DTDT,   &amp;<a name='278'>
                      RAINCV,NCA,NTST,                     &amp;<a name='279'>
                      F_QI,F_QS,warm_rain,                 &amp;<a name='280'>
                      CUTOP,CUBOT,                         &amp;<a name='281'>
                      ids,ide, jds,jde, kds,kde,           &amp;<a name='282'>
                      ims,ime, jms,jme, kms,kme,           &amp;<a name='283'>
                      its,ite, jts,jte, kts,kte)<a name='284'>
<font color=#447700>!-----------------------------------------------------------<a name='285'></font>
<font color=#447700>!***** The KF scheme that is currently used in experimental runs of EMCs <a name='286'></font>
<font color=#447700>!***** Eta model....jsk 8/00<a name='287'></font>
<font color=#447700>!<a name='288'></font>
      IMPLICIT NONE<a name='289'>
<font color=#447700>!-----------------------------------------------------------<a name='290'></font>
      INTEGER, INTENT(IN   ) :: ids,ide, jds,jde, kds,kde, &amp;<a name='291'>
                                ims,ime, jms,jme, kms,kme, &amp;<a name='292'>
                                its,ite, jts,jte, kts,kte, &amp;<a name='293'>
                                I,J,NTST<a name='294'>
          <font color=#447700>! ,P_QI,P_QS,P_FIRST_SCALAR<a name='295'></font>
<a name='296'>
      LOGICAL, INTENT(IN   ) :: F_QI, F_QS<a name='297'>
<a name='298'>
      LOGICAL, INTENT(IN   ) :: warm_rain<a name='299'>
<font color=#447700>!<a name='300'></font>
      REAL, DIMENSION( kts:kte ),                          &amp;<a name='301'>
            INTENT(IN   ) ::                           U0, &amp;<a name='302'>
                                                       V0, &amp;<a name='303'>
                                                       T0, &amp;<a name='304'>
                                                      QV0, &amp;<a name='305'>
                                                       P0, &amp;<a name='306'>
                                                     rhoe, &amp;<a name='307'>
                                                      DZQ, &amp;<a name='308'>
                                                  W0AVG1D<a name='309'>
<font color=#447700>!<a name='310'></font>
      REAL,  INTENT(IN   ) :: DT,DX,DXSQ<a name='311'>
<font color=#447700>!<a name='312'></font>
<a name='313'>
      REAL,  INTENT(IN   ) :: XLV0,XLV1,XLS0,XLS1,CP,R,G<a name='314'>
      REAL,  INTENT(IN   ) :: EP2,SVP1,SVP2,SVP3,SVPT0<a name='315'>
<a name='316'>
<font color=#447700>!<a name='317'></font>
      REAL, DIMENSION( kts:kte ), INTENT(INOUT) ::         &amp;<a name='318'>
                                                     DQDT, &amp;<a name='319'>
                                                    DQIDT, &amp;<a name='320'>
                                                    DQCDT, &amp;<a name='321'>
                                                    DQRDT, &amp;<a name='322'>
                                                    DQSDT, &amp;<a name='323'>
                                                     DTDT<a name='324'>
<a name='325'>
      REAL,    DIMENSION( ims:ime , jms:jme ),             &amp;<a name='326'>
            INTENT(INOUT) ::                          NCA<a name='327'>
<a name='328'>
      REAL, DIMENSION( ims:ime , jms:jme ),                &amp;<a name='329'>
            INTENT(INOUT) ::                       RAINCV<a name='330'>
<a name='331'>
      REAL, DIMENSION( ims:ime , jms:jme ),                &amp;<a name='332'>
            INTENT(OUT) ::                          CUBOT, &amp;<a name='333'>
                                                    CUTOP<a name='334'>
<font color=#447700>!<a name='335'></font>
<font color=#447700>!...DEFINE LOCAL VARIABLES...<a name='336'></font>
<font color=#447700>!<a name='337'></font>
      REAL, DIMENSION( kts:kte ) ::                        &amp;<a name='338'>
            Q0,Z0,TV0,TU,TVU,QU,TZ,TVD,                    &amp;<a name='339'>
            QD,QES,THTES,TG,TVG,QG,WU,WD,W0,EMS,EMSD,      &amp;<a name='340'>
            UMF,UER,UDR,DMF,DER,DDR,UMF2,UER2,             &amp;<a name='341'>
            UDR2,DMF2,DER2,DDR2,DZA,THTA0,THETEE,          &amp;<a name='342'>
            THTAU,THETEU,THTAD,THETED,QLIQ,QICE,           &amp;<a name='343'>
            QLQOUT,QICOUT,PPTLIQ,PPTICE,DETLQ,DETIC,       &amp;<a name='344'>
            DETLQ2,DETIC2,RATIO,RATIO2<a name='345'>
<a name='346'>
<a name='347'>
      REAL, DIMENSION( kts:kte ) ::                        &amp;<a name='348'>
            DOMGDP,EXN,TVQU,DP,RH,EQFRC,WSPD,              &amp;<a name='349'>
            QDT,FXM,THTAG,THPA,THFXOUT,                    &amp;<a name='350'>
            THFXIN,QPA,QFXOUT,QFXIN,QLPA,QLFXIN,           &amp;<a name='351'>
            QLFXOUT,QIPA,QIFXIN,QIFXOUT,QRPA,              &amp;<a name='352'>
            QRFXIN,QRFXOUT,QSPA,QSFXIN,QSFXOUT,            &amp;<a name='353'>
            QL0,QLG,QI0,QIG,QR0,QRG,QS0,QSG<a name='354'>
<a name='355'>
<a name='356'>
      REAL, DIMENSION( kts:kte+1 ) :: OMG<a name='357'>
      REAL, DIMENSION( kts:kte ) :: RAINFB,SNOWFB<a name='358'>
      REAL, DIMENSION( kts:kte ) ::                        &amp;<a name='359'>
            CLDHGT,QSD,DILFRC,DDILFRC,TKE,TGU,QGU,THTEEG<a name='360'>
<a name='361'>
<font color=#447700>! LOCAL VARS<a name='362'></font>
<a name='363'>
      REAL    :: P00,T00,RLF,RHIC,RHBC,PIE,         &amp;<a name='364'>
                 TTFRZ,TBFRZ,C5,RATE<a name='365'>
      REAL    :: GDRY,ROCP,ALIQ,BLIQ,                      &amp;<a name='366'>
                 CLIQ,DLIQ<a name='367'>
      REAL    :: FBFRC,P300,DPTHMX,THMIX,QMIX,ZMIX,PMIX,   &amp;<a name='368'>
                 ROCPQ,TMIX,EMIX,TLOG,TDPT,TLCL,TVLCL,     &amp;<a name='369'>
                 CPORQ,PLCL,ES,DLP,TENV,QENV,TVEN,TVBAR,   &amp;<a name='370'>
                 ZLCL,WKL,WABS,TRPPT,WSIGNE,DTLCL,GDT,WLCL,&amp;<a name='371'>
                 TVAVG,QESE,WTW,RHOLCL,AU0,VMFLCL,UPOLD,   &amp;<a name='372'>
                 UPNEW,ABE,WKLCL,TTEMP,FRC1,   &amp;<a name='373'>
                 QNEWIC,RL,R1,QNWFRZ,EFFQ,BE,BOTERM,ENTERM,&amp;<a name='374'>
                 DZZ,UDLBE,REI,EE2,UD2,TTMP,F1,F2,         &amp;<a name='375'>
                 THTTMP,QTMP,TMPLIQ,TMPICE,TU95,TU10,EE1,  &amp;<a name='376'>
                 UD1,DPTT,QNEWLQ,DUMFDP,EE,TSAT,           &amp;<a name='377'>
                 THTA,VCONV,TIMEC,SHSIGN,VWS,PEF, &amp;<a name='378'>
                 CBH,RCBH,PEFCBH,PEFF,PEFF2,TDER,THTMIN,   &amp;<a name='379'>
                 DTMLTD,QS,TADVEC,DPDD,FRC,DPT,RDD,A1,     &amp;<a name='380'>
                 DSSDT,DTMP,T1RH,QSRH,PPTFLX,CPR,CNDTNF,   &amp;<a name='381'>
                 UPDINC,AINCM2,DEVDMF,PPR,RCED,DPPTDF,     &amp;<a name='382'>
                 DMFLFS,DMFLFS2,RCED2,DDINC,AINCMX,AINCM1, &amp;<a name='383'>
                 AINC,TDER2,PPTFL2,FABE,STAB,DTT,DTT1,     &amp;<a name='384'>
                 DTIME,TMA,TMB,TMM,BCOEFF,ACOEFF,QVDIFF,   &amp;<a name='385'>
                 TOPOMG,CPM,DQ,ABEG,DABE,DFDA,FRC2,DR,     &amp;<a name='386'>
                 UDFRC,TUC,QGS,RH0,RHG,QINIT,QFNL,ERR2,    &amp;<a name='387'>
                 RELERR,RLC,RLS,RNC,FABEOLD,AINCOLD,UEFRC, &amp;<a name='388'>
                 DDFRC,TDC,DEFRC,RHBAR,DMFFRC,DPMIN,DILBE<a name='389'>
   REAL    ::    ASTRT,TP,VALUE,AINTRP,TKEMAX,QFRZ,&amp;<a name='390'>
                 QSS,PPTMLT,DTMELT,RHH,EVAC,BINC<a name='391'>
<font color=#447700>!<a name='392'></font>
      INTEGER :: INDLU,NU,NUCHM,NNN,KLFS<a name='393'>
   REAL    :: CHMIN,PM15,CHMAX,DTRH,RAD,DPPP<a name='394'>
   REAL    :: TVDIFF,DTTOT,ABSOMG,ABSOMGTC,FRDP<a name='395'>
<a name='396'>
      INTEGER :: KX,K,KL<a name='397'>
<font color=#447700>!<a name='398'></font>
      INTEGER :: NCHECK<a name='399'>
      INTEGER, DIMENSION (kts:kte) :: KCHECK<a name='400'>
<a name='401'>
      INTEGER :: ISTOP,ML,L5,KMIX,LOW,                     &amp;<a name='402'>
                 LC,MXLAYR,LLFC,NLAYRS,NK,                 &amp;<a name='403'>
                 KPBL,KLCL,LCL,LET,IFLAG,                  &amp;<a name='404'>
                 NK1,LTOP,NJ,LTOP1,                        &amp;<a name='405'>
                 LTOPM1,LVF,KSTART,KMIN,LFS,               &amp;<a name='406'>
                 ND,NIC,LDB,LDT,ND1,NDK,                   &amp;<a name='407'>
                 NM,LMAX,NCOUNT,NOITR,                     &amp;<a name='408'>
                 NSTEP,NTC,NCHM,ISHALL,NSHALL<a name='409'>
      LOGICAL :: IPRNT<a name='410'>
<font color=#447700>!<a name='411'></font>
      DATA P00,T00/1.E5,273.16/<a name='412'>
      DATA RLF/3.339E5/<a name='413'>
      DATA RHIC,RHBC/1.,0.90/<a name='414'>
      DATA PIE,TTFRZ,TBFRZ,C5/3.141592654,268.16,248.16,1.0723E-3/<a name='415'>
      DATA RATE/0.03/<a name='416'>
<font color=#447700>!-----------------------------------------------------------<a name='417'></font>
      IPRNT=.FALSE.<a name='418'>
      GDRY=-G/CP<a name='419'>
      ROCP=R/CP<a name='420'>
      NSHALL = 0<a name='421'>
      KL=kte<a name='422'>
      KX=kte<a name='423'>
<font color=#447700>!<a name='424'></font>
<font color=#447700>!     ALIQ = 613.3<a name='425'></font>
<font color=#447700>!     BLIQ = 17.502<a name='426'></font>
<font color=#447700>!     CLIQ = 4780.8<a name='427'></font>
<font color=#447700>!     DLIQ = 32.19<a name='428'></font>
      ALIQ = SVP1*1000.<a name='429'>
      BLIQ = SVP2<a name='430'>
      CLIQ = SVP2*SVPT0<a name='431'>
      DLIQ = SVP3<a name='432'>
<font color=#447700>!<a name='433'></font>
<font color=#447700>!<a name='434'></font>
<font color=#447700>!****************************************************************************<a name='435'></font>
<font color=#447700>!                                                      ! PPT FB MODS<a name='436'></font>
<font color=#447700>!...OPTION TO FEED CONVECTIVELY GENERATED RAINWATER    ! PPT FB MODS<a name='437'></font>
<font color=#447700>!...INTO GRID-RESOLVED RAINWATER (OR SNOW/GRAUPEL)     ! PPT FB MODS<a name='438'></font>
<font color=#447700>!...FIELD.  "FBFRC" IS THE FRACTION OF AVAILABLE       ! PPT FB MODS<a name='439'></font>
<font color=#447700>!...PRECIPITATION TO BE FED BACK (0.0 - 1.0)...        ! PPT FB MODS<a name='440'></font>
      FBFRC=0.0                                        <font color=#447700>! PPT FB MODS<a name='441'></font>
<font color=#447700>!...mods to allow shallow convection...<a name='442'></font>
      NCHM = 0<a name='443'>
      ISHALL = 0<a name='444'>
      DPMIN = 5.E3<a name='445'>
<font color=#447700>!...<a name='446'></font>
      P300=P0(1)-30000.<a name='447'>
<font color=#447700>!<a name='448'></font>
<font color=#447700>!...PRESSURE PERTURBATION TERM IS ONLY DEFINED AT MID-POINT OF<a name='449'></font>
<font color=#447700>!...VERTICAL LAYERS...SINCE TOTAL PRESSURE IS NEEDED AT THE TOP AND<a name='450'></font>
<font color=#447700>!...BOTTOM OF LAYERS BELOW, DO AN INTERPOLATION...<a name='451'></font>
<font color=#447700>!<a name='452'></font>
<font color=#447700>!...INPUT A VERTICAL SOUNDING ... NOTE THAT MODEL LAYERS ARE NUMBERED<a name='453'></font>
<font color=#447700>!...FROM BOTTOM-UP IN THE KF SCHEME...<a name='454'></font>
<font color=#447700>!<a name='455'></font>
      ML=0 <a name='456'>
<font color=#447700>!SUE  tmprpsb=1./PSB(I,J)<a name='457'></font>
<font color=#447700>!SUE  CELL=PTOP*tmprpsb<a name='458'></font>
<font color=#447700>!<a name='459'></font>
      DO K=1,KX<a name='460'>
<font color=#447700>!<a name='461'></font>
<font color=#447700>!...IF Q0 IS ABOVE SATURATION VALUE, REDUCE IT TO SATURATION LEVEL...<a name='462'></font>
<font color=#447700>!<a name='463'></font>
         ES=ALIQ*EXP((BLIQ*T0(K)-CLIQ)/(T0(K)-DLIQ))<a name='464'>
         QES(K)=0.622*ES/(P0(K)-ES)<a name='465'>
         Q0(K)=AMIN1(QES(K),QV0(K))<a name='466'>
         Q0(K)=AMAX1(0.000001,Q0(K))<a name='467'>
         QL0(K)=0.<a name='468'>
         QI0(K)=0.<a name='469'>
         QR0(K)=0.<a name='470'>
         QS0(K)=0.<a name='471'>
         RH(K) = Q0(K)/QES(K)<a name='472'>
         DILFRC(K) = 1.<a name='473'>
         TV0(K)=T0(K)*(1.+0.608*Q0(K))<a name='474'>
<font color=#447700>!        RHOE(K)=P0(K)/(R*TV0(K))<a name='475'></font>
<font color=#447700>!   DP IS THE PRESSURE INTERVAL BETWEEN FULL SIGMA LEVELS...<a name='476'></font>
         DP(K)=rhoe(k)*g*DZQ(k)<a name='477'>
<font color=#447700>! IF Turbulent Kinetic Energy (TKE) is available from turbulent mixing scheme<a name='478'></font>
<font color=#447700>! use it for shallow convection...For now, assume it is not available....<a name='479'></font>
<font color=#447700>!         TKE(K) = Q2(I,J,NK)<a name='480'></font>
         TKE(K) = 0.<a name='481'>
         CLDHGT(K) = 0.<a name='482'>
         IF(P0(K).GE.500E2)L5=K<a name='483'>
         IF(P0(K).GE.P300)LLFC=K<a name='484'>
         IF(T0(K).GT.T00)ML=K<a name='485'>
      ENDDO<a name='486'>
<font color=#447700>!<a name='487'></font>
<font color=#447700>!...DZQ IS DZ BETWEEN SIGMA SURFACES, DZA IS DZ BETWEEN MODEL HALF LEVEL<a name='488'></font>
        Z0(1)=.5*DZQ(1)<a name='489'>
        DO K=2,KL<a name='490'>
          Z0(K)=Z0(K-1)+.5*(DZQ(K)+DZQ(K-1))<a name='491'>
          DZA(K-1)=Z0(K)-Z0(K-1)<a name='492'>
        ENDDO   <a name='493'>
        DZA(KL)=0.<a name='494'>
<font color=#447700>!<a name='495'></font>
<font color=#447700>!<a name='496'></font>
<font color=#447700>!  To save time, specify a pressure interval to move up in sequential<a name='497'></font>
<font color=#447700>!  check of different ~50 mb deep groups of adjacent model layers in<a name='498'></font>
<font color=#447700>!  the process of identifying updraft source layer (USL).  Note that <a name='499'></font>
<font color=#447700>!  this search is terminated as soon as a buoyant parcel is found and <a name='500'></font>
<font color=#447700>!  this parcel can produce a cloud greater than specifed minimum depth<a name='501'></font>
<font color=#447700>!  (CHMIN)...For now, set interval at 15 mb...<a name='502'></font>
<font color=#447700>!<a name='503'></font>
       NCHECK = 1<a name='504'>
       KCHECK(NCHECK)=1<a name='505'>
       PM15 = P0(1)-15.E2<a name='506'>
       DO K=2,LLFC<a name='507'>
         IF(P0(K).LT.PM15)THEN<a name='508'>
           NCHECK = NCHECK+1<a name='509'>
           KCHECK(NCHECK) = K<a name='510'>
           PM15 = PM15-15.E2<a name='511'>
         ENDIF<a name='512'>
       ENDDO<a name='513'>
<font color=#447700>!<a name='514'></font>
       NU=0<a name='515'>
       NUCHM=0<a name='516'>
usl:   DO<a name='517'>
           NU = NU+1<a name='518'>
           IF(NU.GT.NCHECK)THEN <a name='519'>
             IF(ISHALL.EQ.1)THEN<a name='520'>
               CHMAX = 0.<a name='521'>
               NCHM = 0<a name='522'>
               DO NK = 1,NCHECK<a name='523'>
                 NNN=KCHECK(NK)<a name='524'>
                 IF(CLDHGT(NNN).GT.CHMAX)THEN<a name='525'>
                   NCHM = NNN<a name='526'>
                   NUCHM = NK<a name='527'>
                   CHMAX = CLDHGT(NNN)<a name='528'>
                 ENDIF<a name='529'>
               ENDDO<a name='530'>
               NU = NUCHM-1<a name='531'>
               FBFRC=1.<a name='532'>
               CYCLE usl<a name='533'>
             ELSE<a name='534'>
               RETURN<a name='535'>
             ENDIF<a name='536'>
           ENDIF      <a name='537'>
           KMIX = KCHECK(NU)<a name='538'>
           LOW=KMIX<a name='539'>
<font color=#447700>!...<a name='540'></font>
           LC = LOW<a name='541'>
<font color=#447700>!<a name='542'></font>
<font color=#447700>!...ASSUME THAT IN ORDER TO SUPPORT A DEEP UPDRAFT YOU NEED A LAYER OF<a name='543'></font>
<font color=#447700>!...UNSTABLE AIR AT LEAST 50 mb DEEP...TO APPROXIMATE THIS, ISOLATE A<a name='544'></font>
<font color=#447700>!...GROUP OF ADJACENT INDIVIDUAL MODEL LAYERS, WITH THE BASE AT LEVEL<a name='545'></font>
<font color=#447700>!...LC, SUCH THAT THE COMBINED DEPTH OF THESE LAYERS IS AT LEAST 50 mb..<a name='546'></font>
<font color=#447700>!   <a name='547'></font>
           NLAYRS=0<a name='548'>
           DPTHMX=0.<a name='549'>
           NK=LC-1<a name='550'>
           DO <a name='551'>
             NK=NK+1   <a name='552'>
             DPTHMX=DPTHMX+DP(NK)<a name='553'>
             NLAYRS=NLAYRS+1<a name='554'>
             IF(DPTHMX.GT.DPMIN)THEN<a name='555'>
               EXIT <a name='556'>
             ENDIF<a name='557'>
           END DO    <a name='558'>
           IF(DPTHMX.LT.DPMIN)THEN <a name='559'>
             RETURN<a name='560'>
           ENDIF<a name='561'>
           KPBL=LC+NLAYRS-1   <a name='562'>
<font color=#447700>!<a name='563'></font>
<font color=#447700>!...********************************************************<a name='564'></font>
<font color=#447700>!...for computational simplicity without much loss in accuracy,<a name='565'></font>
<font color=#447700>!...mix temperature instead of theta for evaluating convective<a name='566'></font>
<font color=#447700>!...initiation (triggering) potential...<a name='567'></font>
<font color=#447700>!          THMIX=0.<a name='568'></font>
           TMIX=0.<a name='569'>
           QMIX=0.<a name='570'>
           ZMIX=0.<a name='571'>
           PMIX=0.<a name='572'>
<font color=#447700>!<a name='573'></font>
<font color=#447700>!...FIND THE THERMODYNAMIC CHARACTERISTICS OF THE LAYER BY<a name='574'></font>
<font color=#447700>!...MASS-WEIGHTING THE CHARACTERISTICS OF THE INDIVIDUAL MODEL<a name='575'></font>
<font color=#447700>!...LAYERS...<a name='576'></font>
<font color=#447700>!<a name='577'></font>
           DO NK=LC,KPBL<a name='578'>
             TMIX=TMIX+DP(NK)*T0(NK)<a name='579'>
             QMIX=QMIX+DP(NK)*Q0(NK)<a name='580'>
             ZMIX=ZMIX+DP(NK)*Z0(NK)<a name='581'>
             PMIX=PMIX+DP(NK)*P0(NK)<a name='582'>
           ENDDO   <a name='583'>
<font color=#447700>!         THMIX=THMIX/DPTHMX<a name='584'></font>
          TMIX=TMIX/DPTHMX<a name='585'>
          QMIX=QMIX/DPTHMX<a name='586'>
          ZMIX=ZMIX/DPTHMX<a name='587'>
          PMIX=PMIX/DPTHMX<a name='588'>
          EMIX=QMIX*PMIX/(0.622+QMIX)<a name='589'>
<font color=#447700>!<a name='590'></font>
<font color=#447700>!...FIND THE TEMPERATURE OF THE MIXTURE AT ITS LCL...<a name='591'></font>
<font color=#447700>!<a name='592'></font>
<font color=#447700>!        TLOG=ALOG(EMIX/ALIQ)<a name='593'></font>
<font color=#447700>! ...calculate dewpoint using lookup table...<a name='594'></font>
<font color=#447700>!<a name='595'></font>
          astrt=1.e-3<a name='596'>
          ainc=0.075<a name='597'>
          a1=emix/aliq<a name='598'>
          tp=(a1-astrt)/ainc<a name='599'>
          indlu=int(tp)+1<a name='600'>
          value=(indlu-1)*ainc+astrt<a name='601'>
          aintrp=(a1-value)/ainc<a name='602'>
          tlog=aintrp*alu(indlu+1)+(1-aintrp)*alu(indlu)<a name='603'>
          TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)<a name='604'>
          TLCL=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(TMIX-T00))*(TMIX-TDPT)<a name='605'>
          TLCL=AMIN1(TLCL,TMIX)<a name='606'>
          TVLCL=TLCL*(1.+0.608*QMIX)<a name='607'>
          ZLCL = ZMIX+(TLCL-TMIX)/GDRY<a name='608'>
          NK = LC-1<a name='609'>
          DO <a name='610'>
            NK = NK+1<a name='611'>
            KLCL=NK<a name='612'>
            IF(ZLCL.LE.Z0(NK) .or. NK.GT.KL)THEN<a name='613'>
              EXIT<a name='614'>
            ENDIF <a name='615'>
          ENDDO   <a name='616'>
          IF(NK.GT.KL)THEN<a name='617'>
            RETURN  <a name='618'>
          ENDIF<a name='619'>
          K=KLCL-1<a name='620'>
          DLP=(ZLCL-Z0(K))/(Z0(KLCL)-Z0(K))<a name='621'>
<font color=#447700>!     <a name='622'></font>
<font color=#447700>!...ESTIMATE ENVIRONMENTAL TEMPERATURE AND MIXING RATIO AT THE LCL...<a name='623'></font>
<font color=#447700>!     <a name='624'></font>
          TENV=T0(K)+(T0(KLCL)-T0(K))*DLP<a name='625'>
          QENV=Q0(K)+(Q0(KLCL)-Q0(K))*DLP<a name='626'>
          TVEN=TENV*(1.+0.608*QENV)<a name='627'>
<font color=#447700>!     <a name='628'></font>
<font color=#447700>!...CHECK TO SEE IF CLOUD IS BUOYANT USING FRITSCH-CHAPPELL TRIGGER<a name='629'></font>
<font color=#447700>!...FUNCTION DESCRIBED IN KAIN AND FRITSCH (1992)...W0 IS AN<a name='630'></font>
<font color=#447700>!...APROXIMATE VALUE FOR THE RUNNING-MEAN GRID-SCALE VERTICAL<a name='631'></font>
<font color=#447700>!...VELOCITY, WHICH GIVES SMOOTHER FIELDS OF CONVECTIVE INITIATION<a name='632'></font>
<font color=#447700>!...THAN THE INSTANTANEOUS VALUE...FORMULA RELATING TEMPERATURE<a name='633'></font>
<font color=#447700>!...PERTURBATION TO VERTICAL VELOCITY HAS BEEN USED WITH THE MOST<a name='634'></font>
<font color=#447700>!...SUCCESS AT GRID LENGTHS NEAR 25 km.  FOR DIFFERENT GRID-LENGTHS,<a name='635'></font>
<font color=#447700>!...ADJUST VERTICAL VELOCITY TO EQUIVALENT VALUE FOR 25 KM GRID<a name='636'></font>
<font color=#447700>!...LENGTH, ASSUMING LINEAR DEPENDENCE OF W ON GRID LENGTH...<a name='637'></font>
<font color=#447700>!     <a name='638'></font>
          IF(ZLCL.LT.2.E3)THEN<a name='639'>
            WKLCL=0.02*ZLCL/2.E3<a name='640'>
          ELSE<a name='641'>
            WKLCL=0.02<a name='642'>
          ENDIF<a name='643'>
          WKL=(W0AVG1D(K)+(W0AVG1D(KLCL)-W0AVG1D(K))*DLP)*DX/25.E3-WKLCL<a name='644'>
          IF(WKL.LT.0.0001)THEN<a name='645'>
            DTLCL=0.<a name='646'>
          ELSE <a name='647'>
            DTLCL=4.64*WKL**0.33<a name='648'>
          ENDIF<a name='649'>
<font color=#447700>!<a name='650'></font>
<font color=#447700>!...for ETA model, give parcel an extra temperature perturbation based<a name='651'></font>
<font color=#447700>!...the threshold RH for condensation (U00)...<a name='652'></font>
<font color=#447700>!<a name='653'></font>
<font color=#447700>!...for now, just assume U00=0.75...<a name='654'></font>
<font color=#447700>!...!!!!!! for MM5, SET DTRH = 0. !!!!!!!!<a name='655'></font>
<font color=#447700>!         U00 = 0.75<a name='656'></font>
<font color=#447700>!         IF(U00.lt.1.)THEN<a name='657'></font>
<font color=#447700>!           QSLCL=QES(K)+(QES(KLCL)-QES(K))*DLP<a name='658'></font>
<font color=#447700>!           RHLCL = QENV/QSLCL<a name='659'></font>
<font color=#447700>!           DQSSDT = QMIX*(CLIQ-BLIQ*DLIQ)/((TLCL-DLIQ)*(TLCL-DLIQ))<a name='660'></font>
<font color=#447700>!           IF(RHLCL.ge.0.75 .and. RHLCL.le.0.95)then<a name='661'></font>
<font color=#447700>!             DTRH = 0.25*(RHLCL-0.75)*QMIX/DQSSDT<a name='662'></font>
<font color=#447700>!           ELSEIF(RHLCL.GT.0.95)THEN<a name='663'></font>
<font color=#447700>!             DTRH = (1./RHLCL-1.)*QMIX/DQSSDT<a name='664'></font>
<font color=#447700>!           ELSE<a name='665'></font>
               DTRH = 0.<a name='666'>
<font color=#447700>!           ENDIF<a name='667'></font>
<font color=#447700>!         ENDIF   <a name='668'></font>
<font color=#447700>!         IF(ISHALL.EQ.1)IPRNT=.TRUE.<a name='669'></font>
<font color=#447700>!         IPRNT=.TRUE.<a name='670'></font>
<font color=#447700>!         IF(TLCL+DTLCL.GT.TENV)GOTO 45<a name='671'></font>
<font color=#447700>!<a name='672'></font>
trigger:  IF(TLCL+DTLCL+DTRH.LT.TENV)THEN   <a name='673'>
<font color=#447700>!<a name='674'></font>
<font color=#447700>! Parcel not buoyant, CYCLE back to start of trigger and evaluate next potential USL...<a name='675'></font>
<font color=#447700>!<a name='676'></font>
            CYCLE usl<a name='677'>
<font color=#447700>!<a name='678'></font>
          ELSE                            <font color=#447700>! Parcel is buoyant, determine updraft<a name='679'></font>
<font color=#447700>!     <a name='680'></font>
<font color=#447700>!...CONVECTIVE TRIGGERING CRITERIA HAS BEEN SATISFIED...COMPUTE<a name='681'></font>
<font color=#447700>!...EQUIVALENT POTENTIAL TEMPERATURE<a name='682'></font>
<font color=#447700>!...(THETEU) AND VERTICAL VELOCITY OF THE RISING PARCEL AT THE LCL...<a name='683'></font>
<font color=#447700>!     <a name='684'></font>
            CALL <A href='../../html_code/phys/module_cu_kfeta.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_5">(PMIX,TMIX,QMIX,THETEU(K),ALIQ,BLIQ,CLIQ,DLIQ)<a name='685'>
<font color=#447700>!<a name='686'></font>
<font color=#447700>!...modify calculation of initial parcel vertical velocity...jsk 11/26/97<a name='687'></font>
<font color=#447700>!<a name='688'></font>
            DTTOT = DTLCL+DTRH<a name='689'>
            IF(DTTOT.GT.1.E-4)THEN<a name='690'>
              GDT=2.*G*DTTOT*500./TVEN<a name='691'>
              WLCL=1.+0.5*SQRT(GDT)<a name='692'>
              WLCL = AMIN1(WLCL,3.)<a name='693'>
            ELSE<a name='694'>
              WLCL=1.<a name='695'>
            ENDIF<a name='696'>
            PLCL=P0(K)+(P0(KLCL)-P0(K))*DLP<a name='697'>
            WTW=WLCL*WLCL<a name='698'>
<font color=#447700>!<a name='699'></font>
            TVLCL=TLCL*(1.+0.608*QMIX)<a name='700'>
            RHOLCL=PLCL/(R*TVLCL)<a name='701'>
<font color=#447700>!        <a name='702'></font>
            LCL=KLCL<a name='703'>
            LET=LCL<a name='704'>
<font color=#447700>! make RAD a function of background vertical velocity...<a name='705'></font>
            IF(WKL.LT.0.)THEN<a name='706'>
              RAD = 1000.<a name='707'>
            ELSEIF(WKL.GT.0.1)THEN<a name='708'>
              RAD = 2000.<a name='709'>
            ELSE<a name='710'>
              RAD = 1000.+1000*WKL/0.1<a name='711'>
            ENDIF<a name='712'>
<font color=#447700>!     <a name='713'></font>
<font color=#447700>!*******************************************************************<a name='714'></font>
<font color=#447700>!                                                                  *<a name='715'></font>
<font color=#447700>!                 COMPUTE UPDRAFT PROPERTIES                       *<a name='716'></font>
<font color=#447700>!                                                                  *<a name='717'></font>
<font color=#447700>!*******************************************************************<a name='718'></font>
<font color=#447700>!     <a name='719'></font>
<font color=#447700>!     <a name='720'></font>
<font color=#447700>!...<a name='721'></font>
<font color=#447700>!...ESTIMATE INITIAL UPDRAFT MASS FLUX (UMF(K))...<a name='722'></font>
<font color=#447700>!     <a name='723'></font>
            WU(K)=WLCL<a name='724'>
            AU0=0.01*DXSQ<a name='725'>
            UMF(K)=RHOLCL*AU0<a name='726'>
            VMFLCL=UMF(K)<a name='727'>
            UPOLD=VMFLCL<a name='728'>
            UPNEW=UPOLD<a name='729'>
<font color=#447700>!     <a name='730'></font>
<font color=#447700>!...RATIO2 IS THE DEGREE OF GLACIATION IN THE CLOUD (0 TO 1),<a name='731'></font>
<font color=#447700>!...UER IS THE ENVIR ENTRAINMENT RATE, ABE IS AVAILABLE<a name='732'></font>
<font color=#447700>!...BUOYANT ENERGY, TRPPT IS THE TOTAL RATE OF PRECIPITATION<a name='733'></font>
<font color=#447700>!...PRODUCTION...<a name='734'></font>
<font color=#447700>!     <a name='735'></font>
            RATIO2(K)=0.<a name='736'>
            UER(K)=0.<a name='737'>
            ABE=0.<a name='738'>
            TRPPT=0.<a name='739'>
            TU(K)=TLCL<a name='740'>
            TVU(K)=TVLCL<a name='741'>
            QU(K)=QMIX<a name='742'>
            EQFRC(K)=1.<a name='743'>
            QLIQ(K)=0.<a name='744'>
            QICE(K)=0.<a name='745'>
            QLQOUT(K)=0.<a name='746'>
            QICOUT(K)=0.<a name='747'>
            DETLQ(K)=0.<a name='748'>
            DETIC(K)=0.<a name='749'>
            PPTLIQ(K)=0.<a name='750'>
            PPTICE(K)=0.<a name='751'>
            IFLAG=0<a name='752'>
<font color=#447700>!     <a name='753'></font>
<font color=#447700>!...TTEMP IS USED DURING CALCULATION OF THE LINEAR GLACIATION<a name='754'></font>
<font color=#447700>!...PROCESS; IT IS INITIALLY SET TO THE TEMPERATURE AT WHICH<a name='755'></font>
<font color=#447700>!...FREEZING IS SPECIFIED TO BEGIN.  WITHIN THE GLACIATION<a name='756'></font>
<font color=#447700>!...INTERVAL, IT IS SET EQUAL TO THE UPDRAFT TEMP AT THE<a name='757'></font>
<font color=#447700>!...PREVIOUS MODEL LEVEL...<a name='758'></font>
<font color=#447700>!     <a name='759'></font>
            TTEMP=TTFRZ<a name='760'>
<font color=#447700>!     <a name='761'></font>
<font color=#447700>!...ENTER THE LOOP FOR UPDRAFT CALCULATIONS...CALCULATE UPDRAFT TEMP,<a name='762'></font>
<font color=#447700>!...MIXING RATIO, VERTICAL MASS FLUX, LATERAL DETRAINMENT OF MASS AND<a name='763'></font>
<font color=#447700>!...MOISTURE, PRECIPITATION RATES AT EACH MODEL LEVEL...<a name='764'></font>
<font color=#447700>!     <a name='765'></font>
<font color=#447700>!     <a name='766'></font>
            EE1=1.<a name='767'>
            UD1=0.<a name='768'>
            REI = 0.<a name='769'>
            DILBE = 0.<a name='770'>
updraft:    DO NK=K,KL-1<a name='771'>
              NK1=NK+1<a name='772'>
              RATIO2(NK1)=RATIO2(NK)<a name='773'>
              FRC1=0.<a name='774'>
              TU(NK1)=T0(NK1)<a name='775'>
              THETEU(NK1)=THETEU(NK)<a name='776'>
              QU(NK1)=QU(NK)<a name='777'>
              QLIQ(NK1)=QLIQ(NK)<a name='778'>
              QICE(NK1)=QICE(NK)<a name='779'>
              call <A href='../../html_code/phys/module_cu_kfeta.F.html#TPMIX2'>tpmix2</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2_1">(p0(nk1),theteu(nk1),tu(nk1),qu(nk1),qliq(nk1),        &amp;<a name='780'>
                     qice(nk1),qnewlq,qnewic,XLV1,XLV0)<a name='781'>
<font color=#447700>!<a name='782'></font>
<font color=#447700>!<a name='783'></font>
<font color=#447700>!...CHECK TO SEE IF UPDRAFT TEMP IS ABOVE THE TEMPERATURE AT WHICH<a name='784'></font>
<font color=#447700>!...GLACIATION IS ASSUMED TO INITIATE; IF IT IS, CALCULATE THE<a name='785'></font>
<font color=#447700>!...FRACTION OF REMAINING LIQUID WATER TO FREEZE...TTFRZ IS THE<a name='786'></font>
<font color=#447700>!...TEMP AT WHICH FREEZING BEGINS, TBFRZ THE TEMP BELOW WHICH ALL<a name='787'></font>
<font color=#447700>!...LIQUID WATER IS FROZEN AT EACH LEVEL...<a name='788'></font>
<font color=#447700>!<a name='789'></font>
              IF(TU(NK1).LE.TTFRZ)THEN<a name='790'>
                IF(TU(NK1).GT.TBFRZ)THEN<a name='791'>
                  IF(TTEMP.GT.TTFRZ)TTEMP=TTFRZ<a name='792'>
                  FRC1=(TTEMP-TU(NK1))/(TTEMP-TBFRZ)<a name='793'>
                ELSE<a name='794'>
                  FRC1=1.<a name='795'>
                  IFLAG=1<a name='796'>
                ENDIF<a name='797'>
                TTEMP=TU(NK1)<a name='798'>
<font color=#447700>!<a name='799'></font>
<font color=#447700>!  DETERMINE THE EFFECTS OF LIQUID WATER FREEZING WHEN TEMPERATURE<a name='800'></font>
<font color=#447700>!...IS BELOW TTFRZ...<a name='801'></font>
<font color=#447700>!<a name='802'></font>
                QFRZ = (QLIQ(NK1)+QNEWLQ)*FRC1<a name='803'>
                QNEWIC=QNEWIC+QNEWLQ*FRC1<a name='804'>
                QNEWLQ=QNEWLQ-QNEWLQ*FRC1<a name='805'>
                QICE(NK1) = QICE(NK1)+QLIQ(NK1)*FRC1<a name='806'>
                QLIQ(NK1) = QLIQ(NK1)-QLIQ(NK1)*FRC1<a name='807'>
                CALL <A href='../../html_code/phys/module_cu_kfeta.F.html#DTFRZNEW'>DTFRZNEW</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DTFRZNEW_2">(TU(NK1),P0(NK1),THETEU(NK1),QU(NK1),QFRZ,         &amp;<a name='808'>
                          QICE(NK1),ALIQ,BLIQ,CLIQ,DLIQ)<a name='809'>
              ENDIF<a name='810'>
              TVU(NK1)=TU(NK1)*(1.+0.608*QU(NK1))<a name='811'>
<font color=#447700>!<a name='812'></font>
<font color=#447700>!  CALCULATE UPDRAFT VERTICAL VELOCITY AND PRECIPITATION FALLOUT...<a name='813'></font>
<font color=#447700>!<a name='814'></font>
              IF(NK.EQ.K)THEN<a name='815'>
                BE=(TVLCL+TVU(NK1))/(TVEN+TV0(NK1))-1.<a name='816'>
                BOTERM=2.*(Z0(NK1)-ZLCL)*G*BE/1.5<a name='817'>
                DZZ=Z0(NK1)-ZLCL<a name='818'>
              ELSE<a name='819'>
                BE=(TVU(NK)+TVU(NK1))/(TV0(NK)+TV0(NK1))-1.<a name='820'>
                BOTERM=2.*DZA(NK)*G*BE/1.5<a name='821'>
                DZZ=DZA(NK)<a name='822'>
              ENDIF<a name='823'>
              ENTERM=2.*REI*WTW/UPOLD<a name='824'>
<a name='825'>
              CALL <A href='../../html_code/phys/module_cu_kfeta.F.html#CONDLOAD'>CONDLOAD</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDLOAD_2">(QLIQ(NK1),QICE(NK1),WTW,DZZ,BOTERM,ENTERM,      &amp;<a name='826'>
                        RATE,QNEWLQ,QNEWIC,QLQOUT(NK1),QICOUT(NK1),G)<a name='827'>
<font color=#447700>!<a name='828'></font>
<font color=#447700>!...IF VERT VELOCITY IS LESS THAN ZERO, EXIT THE UPDRAFT LOOP AND,<a name='829'></font>
<font color=#447700>!...IF CLOUD IS TALL ENOUGH, FINALIZE UPDRAFT CALCULATIONS...<a name='830'></font>
<font color=#447700>!<a name='831'></font>
              IF(WTW.LT.1.E-3)THEN<a name='832'>
                EXIT<a name='833'>
              ELSE<a name='834'>
                WU(NK1)=SQRT(WTW)<a name='835'>
              ENDIF<a name='836'>
<font color=#447700>!...Calculate value of THETA-E in environment to entrain into updraft...<a name='837'></font>
<font color=#447700>!<a name='838'></font>
              CALL <A href='../../html_code/phys/module_cu_kfeta.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_6">(P0(NK1),T0(NK1),Q0(NK1),THETEE(NK1),ALIQ,BLIQ,CLIQ,DLIQ)<a name='839'>
<font color=#447700>!<a name='840'></font>
<font color=#447700>!...REI IS THE RATE OF ENVIRONMENTAL INFLOW...<a name='841'></font>
<font color=#447700>!<a name='842'></font>
              REI=VMFLCL*DP(NK1)*0.03/RAD<a name='843'>
              TVQU(NK1)=TU(NK1)*(1.+0.608*QU(NK1)-QLIQ(NK1)-QICE(NK1))<a name='844'>
              IF(NK.EQ.K)THEN<a name='845'>
                DILBE=((TVLCL+TVQU(NK1))/(TVEN+TV0(NK1))-1.)*DZZ<a name='846'>
              ELSE<a name='847'>
                DILBE=((TVQU(NK)+TVQU(NK1))/(TV0(NK)+TV0(NK1))-1.)*DZZ<a name='848'>
              ENDIF<a name='849'>
              IF(DILBE.GT.0.)ABE=ABE+DILBE*G<a name='850'>
<font color=#447700>!<a name='851'></font>
<font color=#447700>!...IF CLOUD PARCELS ARE VIRTUALLY COLDER THAN THE ENVIRONMENT, MINIMAL <a name='852'></font>
<font color=#447700>!...ENTRAINMENT (0.5*REI) IS IMPOSED...<a name='853'></font>
<font color=#447700>!<a name='854'></font>
              IF(TVQU(NK1).LE.TV0(NK1))THEN    <font color=#447700>! Entrain/Detrain IF BLOCK<a name='855'></font>
                EE2=0.5<a name='856'>
                UD2=1.<a name='857'>
                EQFRC(NK1)=0.<a name='858'>
              ELSE<a name='859'>
                LET=NK1<a name='860'>
                TTMP=TVQU(NK1)<a name='861'>
<font color=#447700>!<a name='862'></font>
<font color=#447700>!...DETERMINE THE CRITICAL MIXED FRACTION OF UPDRAFT AND ENVIRONMENTAL AIR...<a name='863'></font>
<font color=#447700>!<a name='864'></font>
                F1=0.95<a name='865'>
                F2=1.-F1<a name='866'>
                THTTMP=F1*THETEE(NK1)+F2*THETEU(NK1)<a name='867'>
                QTMP=F1*Q0(NK1)+F2*QU(NK1)<a name='868'>
                TMPLIQ=F2*QLIQ(NK1)<a name='869'>
                TMPICE=F2*QICE(NK1)<a name='870'>
                call <A href='../../html_code/phys/module_cu_kfeta.F.html#TPMIX2'>tpmix2</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2_2">(p0(nk1),thttmp,ttmp,qtmp,tmpliq,tmpice,        &amp;<a name='871'>
                           qnewlq,qnewic,XLV1,XLV0)<a name='872'>
                TU95=TTMP*(1.+0.608*QTMP-TMPLIQ-TMPICE)<a name='873'>
                IF(TU95.GT.TV0(NK1))THEN<a name='874'>
                  EE2=1.<a name='875'>
                  UD2=0.<a name='876'>
                  EQFRC(NK1)=1.0<a name='877'>
                ELSE<a name='878'>
                  F1=0.10<a name='879'>
                  F2=1.-F1<a name='880'>
                  THTTMP=F1*THETEE(NK1)+F2*THETEU(NK1)<a name='881'>
                  QTMP=F1*Q0(NK1)+F2*QU(NK1)<a name='882'>
                  TMPLIQ=F2*QLIQ(NK1)<a name='883'>
                  TMPICE=F2*QICE(NK1)<a name='884'>
                  call <A href='../../html_code/phys/module_cu_kfeta.F.html#TPMIX2'>tpmix2</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2_3">(p0(nk1),thttmp,ttmp,qtmp,tmpliq,tmpice,        &amp;<a name='885'>
                               qnewlq,qnewic,XLV1,XLV0)<a name='886'>
                  TU10=TTMP*(1.+0.608*QTMP-TMPLIQ-TMPICE)<a name='887'>
                  TVDIFF = ABS(TU10-TVQU(NK1))<a name='888'>
                  IF(TVDIFF.LT.1.e-3)THEN<a name='889'>
                    EE2=1.<a name='890'>
                    UD2=0.<a name='891'>
                    EQFRC(NK1)=1.0<a name='892'>
                  ELSE<a name='893'>
                    EQFRC(NK1)=(TV0(NK1)-TVQU(NK1))*F1/(TU10-TVQU(NK1))<a name='894'>
                    EQFRC(NK1)=AMAX1(0.0,EQFRC(NK1))<a name='895'>
                    EQFRC(NK1)=AMIN1(1.0,EQFRC(NK1))<a name='896'>
                    IF(EQFRC(NK1).EQ.1)THEN<a name='897'>
                      EE2=1.<a name='898'>
                      UD2=0.<a name='899'>
                    ELSEIF(EQFRC(NK1).EQ.0.)THEN<a name='900'>
                      EE2=0.<a name='901'>
                      UD2=1.<a name='902'>
                    ELSE<a name='903'>
<font color=#447700>!<a name='904'></font>
<font color=#447700>!...SUBROUTINE PROF5 INTEGRATES OVER THE GAUSSIAN DIST TO DETERMINE THE<a name='905'></font>
<font color=#447700>!   FRACTIONAL ENTRAINMENT AND DETRAINMENT RATES...<a name='906'></font>
<font color=#447700>!<a name='907'></font>
                      CALL <A href='../../html_code/phys/module_cu_kfeta.F.html#PROF5'>PROF5</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PROF5_2">(EQFRC(NK1),EE2,UD2)<a name='908'>
                    ENDIF<a name='909'>
                  ENDIF<a name='910'>
                ENDIF<a name='911'>
              ENDIF                            <font color=#447700>! End of Entrain/Detrain IF BLOCK<a name='912'></font>
<font color=#447700>!<a name='913'></font>
<font color=#447700>!<a name='914'></font>
<font color=#447700>!...NET ENTRAINMENT AND DETRAINMENT RATES ARE GIVEN BY THE AVERAGE FRACTIONAL<a name='915'></font>
<font color=#447700>!   VALUES IN THE LAYER...<a name='916'></font>
<font color=#447700>!<a name='917'></font>
              EE2 = AMAX1(EE2,0.5)<a name='918'>
              UD2 = 1.5*UD2<a name='919'>
              UER(NK1)=0.5*REI*(EE1+EE2)<a name='920'>
              UDR(NK1)=0.5*REI*(UD1+UD2)<a name='921'>
<font color=#447700>!<a name='922'></font>
<font color=#447700>!...IF THE CALCULATED UPDRAFT DETRAINMENT RATE IS GREATER THAN THE TOTAL<a name='923'></font>
<font color=#447700>!   UPDRAFT MASS FLUX, ALL CLOUD MASS DETRAINS, EXIT UPDRAFT CALCULATIONS...<a name='924'></font>
<font color=#447700>!<a name='925'></font>
              IF(UMF(NK)-UDR(NK1).LT.10.)THEN<a name='926'>
<font color=#447700>!<a name='927'></font>
<font color=#447700>!...IF THE CALCULATED DETRAINED MASS FLUX IS GREATER THAN THE TOTAL UPD MASS<a name='928'></font>
<font color=#447700>!   FLUX, IMPOSE TOTAL DETRAINMENT OF UPDRAFT MASS AT THE PREVIOUS MODEL LVL..<a name='929'></font>
<font color=#447700>!   First, correct ABE calculation if needed...<a name='930'></font>
<font color=#447700>!<a name='931'></font>
                IF(DILBE.GT.0.)THEN<a name='932'>
                  ABE=ABE-DILBE*G<a name='933'>
                ENDIF<a name='934'>
                LET=NK<a name='935'>
<font color=#447700>!               WRITE(98,1015)P0(NK1)/100.<a name='936'></font>
                EXIT <a name='937'>
              ELSE<a name='938'>
                EE1=EE2<a name='939'>
                UD1=UD2<a name='940'>
                UPOLD=UMF(NK)-UDR(NK1)<a name='941'>
                UPNEW=UPOLD+UER(NK1)<a name='942'>
                UMF(NK1)=UPNEW<a name='943'>
                DILFRC(NK1) = UPNEW/UPOLD<a name='944'>
<font color=#447700>!<a name='945'></font>
<font color=#447700>!...DETLQ AND DETIC ARE THE RATES OF DETRAINMENT OF LIQUID AND<a name='946'></font>
<font color=#447700>!...ICE IN THE DETRAINING UPDRAFT MASS...<a name='947'></font>
<font color=#447700>!<a name='948'></font>
                DETLQ(NK1)=QLIQ(NK1)*UDR(NK1)<a name='949'>
                DETIC(NK1)=QICE(NK1)*UDR(NK1)<a name='950'>
                QDT(NK1)=QU(NK1)<a name='951'>
                QU(NK1)=(UPOLD*QU(NK1)+UER(NK1)*Q0(NK1))/UPNEW<a name='952'>
                THETEU(NK1)=(THETEU(NK1)*UPOLD+THETEE(NK1)*UER(NK1))/UPNEW<a name='953'>
                QLIQ(NK1)=QLIQ(NK1)*UPOLD/UPNEW<a name='954'>
                QICE(NK1)=QICE(NK1)*UPOLD/UPNEW<a name='955'>
<font color=#447700>!<a name='956'></font>
<font color=#447700>!...PPTLIQ IS THE RATE OF GENERATION (FALLOUT) OF<a name='957'></font>
<font color=#447700>!...LIQUID PRECIP AT A GIVEN MODEL LVL, PPTICE THE SAME FOR ICE,<a name='958'></font>
<font color=#447700>!...TRPPT IS THE TOTAL RATE OF PRODUCTION OF PRECIP UP TO THE<a name='959'></font>
<font color=#447700>!...CURRENT MODEL LEVEL...<a name='960'></font>
<font color=#447700>!<a name='961'></font>
                PPTLIQ(NK1)=QLQOUT(NK1)*UMF(NK)<a name='962'>
                PPTICE(NK1)=QICOUT(NK1)*UMF(NK)<a name='963'>
<font color=#447700>!<a name='964'></font>
                TRPPT=TRPPT+PPTLIQ(NK1)+PPTICE(NK1)<a name='965'>
                IF(NK1.LE.KPBL)UER(NK1)=UER(NK1)+VMFLCL*DP(NK1)/DPTHMX<a name='966'>
              ENDIF<a name='967'>
<font color=#447700>!<a name='968'></font>
            END DO updraft<a name='969'>
<font color=#447700>!<a name='970'></font>
<font color=#447700>!...CHECK CLOUD DEPTH...IF CLOUD IS TALL ENOUGH, ESTIMATE THE EQUILIBRIU<a name='971'></font>
<font color=#447700>!   TEMPERATURE LEVEL (LET) AND ADJUST MASS FLUX PROFILE AT CLOUD TOP SO<a name='972'></font>
<font color=#447700>!   THAT MASS FLUX DECREASES TO ZERO AS A LINEAR FUNCTION OF PRESSURE BE<a name='973'></font>
<font color=#447700>!   THE LET AND CLOUD TOP...<a name='974'></font>
<font color=#447700>!     <a name='975'></font>
<font color=#447700>!...LTOP IS THE MODEL LEVEL JUST BELOW THE LEVEL AT WHICH VERTICAL VELOC<a name='976'></font>
<font color=#447700>!   FIRST BECOMES NEGATIVE...<a name='977'></font>
<font color=#447700>!     <a name='978'></font>
            LTOP=NK<a name='979'>
            CLDHGT(LC)=Z0(LTOP)-ZLCL <a name='980'>
<font color=#447700>!<a name='981'></font>
<font color=#447700>!...Instead of using the same minimum cloud height (for deep convection)<a name='982'></font>
<font color=#447700>!...everywhere, try specifying minimum cloud depth as a function of TLCL...<a name='983'></font>
<font color=#447700>!<a name='984'></font>
<font color=#447700>!<a name='985'></font>
<font color=#447700>!<a name='986'></font>
            IF(TLCL.GT.293.)THEN<a name='987'>
              CHMIN = 4.E3<a name='988'>
            ELSEIF(TLCL.LE.293. .and. TLCL.GE.273)THEN<a name='989'>
              CHMIN = 2.E3 + 100.*(TLCL-273.)<a name='990'>
            ELSEIF(TLCL.LT.273.)THEN<a name='991'>
              CHMIN = 2.E3<a name='992'>
            ENDIF<a name='993'>
<a name='994'>
<font color=#447700>!     <a name='995'></font>
<font color=#447700>!...If cloud top height is less than the specified minimum for deep <a name='996'></font>
<font color=#447700>!...convection, save value to consider this level as source for <a name='997'></font>
<font color=#447700>!...shallow convection, go back up to check next level...<a name='998'></font>
<font color=#447700>!     <a name='999'></font>
<font color=#447700>!...Try specifying minimum cloud depth as a function of TLCL...<a name='1000'></font>
<font color=#447700>!<a name='1001'></font>
<font color=#447700>!<a name='1002'></font>
<font color=#447700>!...DO NOT ALLOW ANY CLOUD FROM THIS LAYER IF:<a name='1003'></font>
<font color=#447700>!<a name='1004'></font>
<font color=#447700>!...            1.) if there is no CAPE, or <a name='1005'></font>
<font color=#447700>!...            2.) cloud top is at model level just above LCL, or<a name='1006'></font>
<font color=#447700>!...            3.) cloud top is within updraft source layer, or<a name='1007'></font>
<font color=#447700>!...            4.) cloud-top detrainment layer begins within <a name='1008'></font>
<font color=#447700>!...                updraft source layer.<a name='1009'></font>
<font color=#447700>!<a name='1010'></font>
            IF(LTOP.LE.KLCL .or. LTOP.LE.KPBL .or. LET+1.LE.KPBL)THEN  <font color=#447700>! No Convection Allowed<a name='1011'></font>
              CLDHGT(LC)=0.<a name='1012'>
              DO NK=K,LTOP<a name='1013'>
                UMF(NK)=0.<a name='1014'>
                UDR(NK)=0.<a name='1015'>
                UER(NK)=0.<a name='1016'>
                DETLQ(NK)=0.<a name='1017'>
                DETIC(NK)=0.<a name='1018'>
                PPTLIQ(NK)=0.<a name='1019'>
                PPTICE(NK)=0.<a name='1020'>
              ENDDO<a name='1021'>
<font color=#447700>!        <a name='1022'></font>
            ELSEIF(CLDHGT(LC).GT.CHMIN .and. ABE.GT.1)THEN      <font color=#447700>! Deep Convection allowed<a name='1023'></font>
              ISHALL=0<a name='1024'>
              EXIT usl<a name='1025'>
            ELSE<a name='1026'>
<font color=#447700>!<a name='1027'></font>
<font color=#447700>!...TO DISALLOW SHALLOW CONVECTION, COMMENT OUT NEXT LINE !!!!!!!!<a name='1028'></font>
              ISHALL = 1<a name='1029'>
              IF(NU.EQ.NUCHM)THEN<a name='1030'>
                EXIT usl               <font color=#447700>! Shallow Convection from this layer<a name='1031'></font>
              ELSE<a name='1032'>
<font color=#447700>! Remember this layer (by virtue of non-zero CLDHGT) as potential shallow-cloud layer<a name='1033'></font>
                DO NK=K,LTOP<a name='1034'>
                  UMF(NK)=0.<a name='1035'>
                  UDR(NK)=0.<a name='1036'>
                  UER(NK)=0.<a name='1037'>
                  DETLQ(NK)=0.<a name='1038'>
                  DETIC(NK)=0.<a name='1039'>
                  PPTLIQ(NK)=0.<a name='1040'>
                  PPTICE(NK)=0.<a name='1041'>
                ENDDO<a name='1042'>
              ENDIF<a name='1043'>
            ENDIF<a name='1044'>
          ENDIF trigger<a name='1045'>
        END DO usl<a name='1046'>
    IF(ISHALL.EQ.1)THEN<a name='1047'>
      KSTART=MAX0(KPBL,KLCL)<a name='1048'>
      LET=KSTART<a name='1049'>
    endif<a name='1050'>
<font color=#447700>!     <a name='1051'></font>
<font color=#447700>!...IF THE LET AND LTOP ARE THE SAME, DETRAIN ALL OF THE UPDRAFT MASS FL<a name='1052'></font>
<font color=#447700>!   THIS LEVEL...<a name='1053'></font>
<font color=#447700>!     <a name='1054'></font>
    IF(LET.EQ.LTOP)THEN<a name='1055'>
      UDR(LTOP)=UMF(LTOP)+UDR(LTOP)-UER(LTOP)<a name='1056'>
      DETLQ(LTOP)=QLIQ(LTOP)*UDR(LTOP)*UPNEW/UPOLD<a name='1057'>
      DETIC(LTOP)=QICE(LTOP)*UDR(LTOP)*UPNEW/UPOLD<a name='1058'>
      UER(LTOP)=0.<a name='1059'>
      UMF(LTOP)=0.<a name='1060'>
    ELSE <a name='1061'>
<font color=#447700>!     <a name='1062'></font>
<font color=#447700>!   BEGIN TOTAL DETRAINMENT AT THE LEVEL ABOVE THE LET...<a name='1063'></font>
<font color=#447700>!     <a name='1064'></font>
      DPTT=0.<a name='1065'>
      DO NJ=LET+1,LTOP<a name='1066'>
        DPTT=DPTT+DP(NJ)<a name='1067'>
      ENDDO<a name='1068'>
      DUMFDP=UMF(LET)/DPTT<a name='1069'>
<font color=#447700>!     <a name='1070'></font>
<font color=#447700>!...ADJUST MASS FLUX PROFILES, DETRAINMENT RATES, AND PRECIPITATION FALL<a name='1071'></font>
<font color=#447700>!   RATES TO REFLECT THE LINEAR DECREASE IN MASS FLX BETWEEN THE LET AND<a name='1072'></font>
<font color=#447700>!     <a name='1073'></font>
      DO NK=LET+1,LTOP<a name='1074'>
<font color=#447700>!<a name='1075'></font>
<font color=#447700>!...entrainment is allowed at every level except for LTOP, so disallow<a name='1076'></font>
<font color=#447700>!...entrainment at LTOP and adjust entrainment rates between LET and LTOP<a name='1077'></font>
<font color=#447700>!...so the the dilution factor due to entyrianment is not changed but <a name='1078'></font>
<font color=#447700>!...the actual entrainment rate will change due due forced total <a name='1079'></font>
<font color=#447700>!...detrainment in this layer...<a name='1080'></font>
<font color=#447700>!<a name='1081'></font>
        IF(NK.EQ.LTOP)THEN<a name='1082'>
          UDR(NK) = UMF(NK-1)<a name='1083'>
          UER(NK) = 0.<a name='1084'>
          DETLQ(NK) = UDR(NK)*QLIQ(NK)*DILFRC(NK)<a name='1085'>
          DETIC(NK) = UDR(NK)*QICE(NK)*DILFRC(NK)<a name='1086'>
        ELSE<a name='1087'>
          UMF(NK)=UMF(NK-1)-DP(NK)*DUMFDP<a name='1088'>
          UER(NK)=UMF(NK)*(1.-1./DILFRC(NK))<a name='1089'>
          UDR(NK)=UMF(NK-1)-UMF(NK)+UER(NK)<a name='1090'>
          DETLQ(NK)=UDR(NK)*QLIQ(NK)*DILFRC(NK)<a name='1091'>
          DETIC(NK)=UDR(NK)*QICE(NK)*DILFRC(NK)<a name='1092'>
        ENDIF<a name='1093'>
        IF(NK.GE.LET+2)THEN<a name='1094'>
          TRPPT=TRPPT-PPTLIQ(NK)-PPTICE(NK)<a name='1095'>
          PPTLIQ(NK)=UMF(NK-1)*QLQOUT(NK)<a name='1096'>
          PPTICE(NK)=UMF(NK-1)*QICOUT(NK)<a name='1097'>
          TRPPT=TRPPT+PPTLIQ(NK)+PPTICE(NK)<a name='1098'>
        ENDIF<a name='1099'>
      ENDDO<a name='1100'>
    ENDIF<a name='1101'>
<font color=#447700>!     <a name='1102'></font>
<font color=#447700>! Initialize some arrays below cloud base and above cloud top...<a name='1103'></font>
<font color=#447700>!<a name='1104'></font>
    DO NK=1,K<a name='1105'>
      IF(NK.GE.LC)THEN<a name='1106'>
        IF(NK.EQ.LC)THEN<a name='1107'>
          UMF(NK)=VMFLCL*DP(NK)/DPTHMX<a name='1108'>
          UER(NK)=VMFLCL*DP(NK)/DPTHMX<a name='1109'>
        ELSEIF(NK.LE.KPBL)THEN<a name='1110'>
          UER(NK)=VMFLCL*DP(NK)/DPTHMX<a name='1111'>
          UMF(NK)=UMF(NK-1)+UER(NK)<a name='1112'>
        ELSE<a name='1113'>
          UMF(NK)=VMFLCL<a name='1114'>
          UER(NK)=0.<a name='1115'>
        ENDIF<a name='1116'>
        TU(NK)=TMIX+(Z0(NK)-ZMIX)*GDRY<a name='1117'>
        QU(NK)=QMIX<a name='1118'>
        WU(NK)=WLCL<a name='1119'>
      ELSE<a name='1120'>
        TU(NK)=0.<a name='1121'>
        QU(NK)=0.<a name='1122'>
        UMF(NK)=0.<a name='1123'>
        WU(NK)=0.<a name='1124'>
        UER(NK)=0.<a name='1125'>
      ENDIF<a name='1126'>
      UDR(NK)=0.<a name='1127'>
      QDT(NK)=0.<a name='1128'>
      QLIQ(NK)=0.<a name='1129'>
      QICE(NK)=0.<a name='1130'>
      QLQOUT(NK)=0.<a name='1131'>
      QICOUT(NK)=0.<a name='1132'>
      PPTLIQ(NK)=0.<a name='1133'>
      PPTICE(NK)=0.<a name='1134'>
      DETLQ(NK)=0.<a name='1135'>
      DETIC(NK)=0.<a name='1136'>
      RATIO2(NK)=0.<a name='1137'>
      CALL <A href='../../html_code/phys/module_cu_kfeta.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_7">(P0(NK),T0(NK),Q0(NK),THETEE(NK),ALIQ,BLIQ,CLIQ,DLIQ)<a name='1138'>
      EQFRC(NK)=1.0<a name='1139'>
    ENDDO<a name='1140'>
<font color=#447700>!     <a name='1141'></font>
      LTOP1=LTOP+1<a name='1142'>
      LTOPM1=LTOP-1<a name='1143'>
<font color=#447700>!     <a name='1144'></font>
<font color=#447700>!...DEFINE VARIABLES ABOVE CLOUD TOP...<a name='1145'></font>
<font color=#447700>!     <a name='1146'></font>
      DO NK=LTOP1,KX<a name='1147'>
        UMF(NK)=0.<a name='1148'>
        UDR(NK)=0.<a name='1149'>
        UER(NK)=0.<a name='1150'>
        QDT(NK)=0.<a name='1151'>
        QLIQ(NK)=0.<a name='1152'>
        QICE(NK)=0.<a name='1153'>
        QLQOUT(NK)=0.<a name='1154'>
        QICOUT(NK)=0.<a name='1155'>
        DETLQ(NK)=0.<a name='1156'>
        DETIC(NK)=0.<a name='1157'>
        PPTLIQ(NK)=0.<a name='1158'>
        PPTICE(NK)=0.<a name='1159'>
        IF(NK.GT.LTOP1)THEN<a name='1160'>
          TU(NK)=0.<a name='1161'>
          QU(NK)=0.<a name='1162'>
          WU(NK)=0.<a name='1163'>
        ENDIF<a name='1164'>
        THTA0(NK)=0.<a name='1165'>
        THTAU(NK)=0.<a name='1166'>
        EMS(NK)=0.<a name='1167'>
        EMSD(NK)=0.<a name='1168'>
        TG(NK)=T0(NK)<a name='1169'>
        QG(NK)=Q0(NK)<a name='1170'>
        QLG(NK)=0.<a name='1171'>
        QIG(NK)=0.<a name='1172'>
        QRG(NK)=0.<a name='1173'>
        QSG(NK)=0.<a name='1174'>
        OMG(NK)=0.<a name='1175'>
      ENDDO<a name='1176'>
        OMG(KX+1)=0.<a name='1177'>
        DO NK=1,LTOP<a name='1178'>
          EMS(NK)=DP(NK)*DXSQ/G<a name='1179'>
          EMSD(NK)=1./EMS(NK)<a name='1180'>
<font color=#447700>!     <a name='1181'></font>
<font color=#447700>!...INITIALIZE SOME VARIABLES TO BE USED LATER IN THE VERT ADVECTION SCH<a name='1182'></font>
<font color=#447700>!     <a name='1183'></font>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*QDT(NK)))<a name='1184'>
          THTAU(NK)=TU(NK)*EXN(NK)<a name='1185'>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*Q0(NK)))<a name='1186'>
          THTA0(NK)=T0(NK)*EXN(NK)<a name='1187'>
          DDILFRC(NK) = 1./DILFRC(NK)<a name='1188'>
          OMG(NK)=0.<a name='1189'>
        ENDDO<a name='1190'>
<font color=#447700>!     IF (XTIME.LT.10.)THEN<a name='1191'></font>
<font color=#447700>!      WRITE(98,1025)KLCL,ZLCL,DTLCL,LTOP,P0(LTOP),IFLAG,<a name='1192'></font>
<font color=#447700>!    * TMIX-T00,PMIX,QMIX,ABE<a name='1193'></font>
<font color=#447700>!      WRITE(98,1030)P0(LET)/100.,P0(LTOP)/100.,VMFLCL,PLCL/100.,<a name='1194'></font>
<font color=#447700>!    * WLCL,CLDHGT<a name='1195'></font>
<font color=#447700>!     ENDIF<a name='1196'></font>
<font color=#447700>!     <a name='1197'></font>
<font color=#447700>!...COMPUTE CONVECTIVE TIME SCALE(TIMEC). THE MEAN WIND AT THE LCL<a name='1198'></font>
<font color=#447700>!...AND MIDTROPOSPHERE IS USED.<a name='1199'></font>
<font color=#447700>!     <a name='1200'></font>
        WSPD(KLCL)=SQRT(U0(KLCL)*U0(KLCL)+V0(KLCL)*V0(KLCL))<a name='1201'>
        WSPD(L5)=SQRT(U0(L5)*U0(L5)+V0(L5)*V0(L5))<a name='1202'>
        WSPD(LTOP)=SQRT(U0(LTOP)*U0(LTOP)+V0(LTOP)*V0(LTOP))<a name='1203'>
        VCONV=.5*(WSPD(KLCL)+WSPD(L5))<a name='1204'>
<font color=#447700>!...for ETA model, DX is a function of location...<a name='1205'></font>
<font color=#447700>!       TIMEC=DX(I,J)/VCONV<a name='1206'></font>
        TIMEC=DX/VCONV<a name='1207'>
        TADVEC=TIMEC<a name='1208'>
        TIMEC=AMAX1(1800.,TIMEC)<a name='1209'>
        TIMEC=AMIN1(3600.,TIMEC)<a name='1210'>
        IF(ISHALL.EQ.1)TIMEC=2400.<a name='1211'>
        NIC=NINT(TIMEC/DT)<a name='1212'>
        TIMEC=FLOAT(NIC)*DT<a name='1213'>
<font color=#447700>!     <a name='1214'></font>
<font color=#447700>!...COMPUTE WIND SHEAR AND PRECIPITATION EFFICIENCY.<a name='1215'></font>
<font color=#447700>!     <a name='1216'></font>
        IF(WSPD(LTOP).GT.WSPD(KLCL))THEN<a name='1217'>
          SHSIGN=1.<a name='1218'>
        ELSE<a name='1219'>
          SHSIGN=-1.<a name='1220'>
        ENDIF<a name='1221'>
        VWS=(U0(LTOP)-U0(KLCL))*(U0(LTOP)-U0(KLCL))+(V0(LTOP)-V0(KLCL))*   &amp;<a name='1222'>
            (V0(LTOP)-V0(KLCL))<a name='1223'>
        VWS=1.E3*SHSIGN*SQRT(VWS)/(Z0(LTOP)-Z0(LCL))<a name='1224'>
        PEF=1.591+VWS*(-.639+VWS*(9.53E-2-VWS*4.96E-3))<a name='1225'>
        PEF=AMAX1(PEF,.2)<a name='1226'>
        PEF=AMIN1(PEF,.9)<a name='1227'>
<font color=#447700>!     <a name='1228'></font>
<font color=#447700>!...PRECIPITATION EFFICIENCY IS A FUNCTION OF THE HEIGHT OF CLOUD BASE.<a name='1229'></font>
<font color=#447700>!     <a name='1230'></font>
        CBH=(ZLCL-Z0(1))*3.281E-3<a name='1231'>
        IF(CBH.LT.3.)THEN<a name='1232'>
          RCBH=.02<a name='1233'>
        ELSE<a name='1234'>
          RCBH=.96729352+CBH*(-.70034167+CBH*(.162179896+CBH*(-            &amp;<a name='1235'>
               1.2569798E-2+CBH*(4.2772E-4-CBH*5.44E-6))))<a name='1236'>
        ENDIF<a name='1237'>
        IF(CBH.GT.25)RCBH=2.4<a name='1238'>
        PEFCBH=1./(1.+RCBH)<a name='1239'>
        PEFCBH=AMIN1(PEFCBH,.9)<a name='1240'>
<font color=#447700>!     <a name='1241'></font>
<font color=#447700>!... MEAN PEF. IS USED TO COMPUTE RAINFALL.<a name='1242'></font>
<font color=#447700>!     <a name='1243'></font>
        PEFF=.5*(PEF+PEFCBH)<a name='1244'>
        PEFF2 = PEFF                                <font color=#447700>! JSK MODS<a name='1245'></font>
       IF(IPRNT)THEN  <a name='1246'>
         WRITE(98,1035)PEF,PEFCBH,LC,LET,WKL,VWS<a name='1247'>
<font color=#447700>!       call flush(98)   <a name='1248'></font>
       endif     <a name='1249'>
<font color=#447700>!        WRITE(98,1035)PEF,PEFCBH,LC,LET,WKL,VWS<a name='1250'></font>
<font color=#447700>!*****************************************************************<a name='1251'></font>
<font color=#447700>!                                                                *<a name='1252'></font>
<font color=#447700>!                  COMPUTE DOWNDRAFT PROPERTIES                  *<a name='1253'></font>
<font color=#447700>!                                                                *<a name='1254'></font>
<font color=#447700>!*****************************************************************<a name='1255'></font>
<font color=#447700>!     <a name='1256'></font>
<font color=#447700>!     <a name='1257'></font>
       TDER=0.<a name='1258'>
 devap:IF(ISHALL.EQ.1)THEN<a name='1259'>
         LFS = 1<a name='1260'>
       ELSE<a name='1261'>
<font color=#447700>!<a name='1262'></font>
<font color=#447700>!...start downdraft about 150 mb above cloud base...<a name='1263'></font>
<font color=#447700>!<a name='1264'></font>
<font color=#447700>!        KSTART=MAX0(KPBL,KLCL)<a name='1265'></font>
<font color=#447700>!        KSTART=KPBL                                  ! Changed 7/23/99<a name='1266'></font>
         KSTART=KPBL+1                                <font color=#447700>! Changed 7/23/99<a name='1267'></font>
         DO NK = KSTART+1,KL<a name='1268'>
           DPPP = P0(KSTART)-P0(NK)<a name='1269'>
<font color=#447700>!          IF(DPPP.GT.200.E2)THEN<a name='1270'></font>
           IF(DPPP.GT.150.E2)THEN<a name='1271'>
             KLFS = NK<a name='1272'>
             EXIT <a name='1273'>
           ENDIF<a name='1274'>
         ENDDO<a name='1275'>
         KLFS = MIN0(KLFS,LET-1)<a name='1276'>
         LFS = KLFS<a name='1277'>
<font color=#447700>!<a name='1278'></font>
<font color=#447700>!...if LFS is not at least 50 mb above cloud base (implying that the <a name='1279'></font>
<font color=#447700>!...level of equil temp, LET, is just above cloud base) do not allow a<a name='1280'></font>
<font color=#447700>!...downdraft...<a name='1281'></font>
<font color=#447700>!<a name='1282'></font>
        IF((P0(KSTART)-P0(LFS)).GT.50.E2)THEN<a name='1283'>
          THETED(LFS) = THETEE(LFS)<a name='1284'>
          QD(LFS) = Q0(LFS)<a name='1285'>
<font color=#447700>!<a name='1286'></font>
<font color=#447700>!...call tpmix2dd to find wet-bulb temp, qv...<a name='1287'></font>
<font color=#447700>!<a name='1288'></font>
          call <A href='../../html_code/phys/module_cu_kfeta.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_1">(p0(lfs),theted(lfs),tz(lfs),qss)<a name='1289'>
          THTAD(LFS)=TZ(LFS)*(P00/P0(LFS))**(0.2854*(1.-0.28*QSS))<a name='1290'>
<font color=#447700>!     <a name='1291'></font>
<font color=#447700>!...TAKE A FIRST GUESS AT THE INITIAL DOWNDRAFT MASS FLUX...<a name='1292'></font>
<font color=#447700>!     <a name='1293'></font>
          TVD(LFS)=TZ(LFS)*(1.+0.608*QSS)<a name='1294'>
          RDD=P0(LFS)/(R*TVD(LFS))<a name='1295'>
          A1=(1.-PEFF)*AU0<a name='1296'>
          DMF(LFS)=-A1*RDD<a name='1297'>
          DER(LFS)=DMF(LFS)<a name='1298'>
          DDR(LFS)=0.<a name='1299'>
          RHBAR = RH(LFS)*DP(LFS)<a name='1300'>
          DPTT = DP(LFS)<a name='1301'>
          DO ND = LFS-1,KSTART,-1<a name='1302'>
            ND1 = ND+1<a name='1303'>
            DER(ND)=DER(LFS)*EMS(ND)/EMS(LFS)<a name='1304'>
            DDR(ND)=0.<a name='1305'>
            DMF(ND)=DMF(ND1)+DER(ND)<a name='1306'>
            THETED(ND)=(THETED(ND1)*DMF(ND1)+THETEE(ND)*DER(ND))/DMF(ND)<a name='1307'>
            QD(ND)=(QD(ND1)*DMF(ND1)+Q0(ND)*DER(ND))/DMF(ND)    <a name='1308'>
            DPTT = DPTT+DP(ND)<a name='1309'>
            RHBAR = RHBAR+RH(ND)*DP(ND)<a name='1310'>
          ENDDO<a name='1311'>
          RHBAR = RHBAR/DPTT<a name='1312'>
          DMFFRC = 2.*(1.-RHBAR)<a name='1313'>
          DPDD = 0.<a name='1314'>
<font color=#447700>!...Calculate melting effect<a name='1315'></font>
<font color=#447700>!... first, compute total frozen precipitation generated...<a name='1316'></font>
<font color=#447700>!<a name='1317'></font>
          pptmlt = 0.<a name='1318'>
          DO NK = KLCL,LTOP<a name='1319'>
            PPTMLT = PPTMLT+PPTICE(NK)<a name='1320'>
          ENDDO<a name='1321'>
          if(lc.lt.ml)then<a name='1322'>
<font color=#447700>!...For now, calculate melting effect as if DMF = -UMF at KLCL, i.e., as<a name='1323'></font>
<font color=#447700>!...if DMFFRC=1.  Otherwise, for small DMFFRC, DTMELT gets too large!<a name='1324'></font>
<font color=#447700>!...12/14/98 jsk...<a name='1325'></font>
            DTMELT = RLF*PPTMLT/(CP*UMF(KLCL))<a name='1326'>
          else<a name='1327'>
            DTMELT = 0.<a name='1328'>
          endif<a name='1329'>
          LDT = MIN0(LFS-1,KSTART-1)<a name='1330'>
<font color=#447700>!<a name='1331'></font>
          call <A href='../../html_code/phys/module_cu_kfeta.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_2">(p0(kstart),theted(kstart),tz(kstart),qss)<a name='1332'>
<font color=#447700>!<a name='1333'></font>
          tz(kstart) = tz(kstart)-dtmelt<a name='1334'>
          ES=ALIQ*EXP((BLIQ*TZ(KSTART)-CLIQ)/(TZ(KSTART)-DLIQ))<a name='1335'>
          QSS=0.622*ES/(P0(KSTART)-ES)<a name='1336'>
          THETED(KSTART)=TZ(KSTART)*(1.E5/P0(KSTART))**(0.2854*(1.-0.28*QSS))*    &amp;<a name='1337'>
                EXP((3374.6525/TZ(KSTART)-2.5403)*QSS*(1.+0.81*QSS))<a name='1338'>
<font color=#447700>!....  <a name='1339'></font>
          LDT = MIN0(LFS-1,KSTART-1)<a name='1340'>
          DO ND = LDT,1,-1<a name='1341'>
            DPDD = DPDD+DP(ND)<a name='1342'>
            THETED(ND) = THETED(KSTART)<a name='1343'>
            QD(ND)     = QD(KSTART)       <a name='1344'>
<font color=#447700>!<a name='1345'></font>
<font color=#447700>!...call tpmix2dd to find wet bulb temp, saturation mixing ratio...<a name='1346'></font>
<font color=#447700>!<a name='1347'></font>
            call <A href='../../html_code/phys/module_cu_kfeta.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_3">(p0(nd),theted(nd),tz(nd),qss)<a name='1348'>
            qsd(nd) = qss<a name='1349'>
<font color=#447700>!<a name='1350'></font>
<font color=#447700>!...specify RH decrease of 20%/km in downdraft...<a name='1351'></font>
<font color=#447700>!<a name='1352'></font>
            RHH = 1.-0.2/1000.*(Z0(KSTART)-Z0(ND))<a name='1353'>
<font color=#447700>!<a name='1354'></font>
<font color=#447700>!...adjust downdraft TEMP, Q to specified RH:<a name='1355'></font>
<font color=#447700>!<a name='1356'></font>
            IF(RHH.LT.1.)THEN<a name='1357'>
              DSSDT=(CLIQ-BLIQ*DLIQ)/((TZ(ND)-DLIQ)*(TZ(ND)-DLIQ))<a name='1358'>
              RL=XLV0-XLV1*TZ(ND)<a name='1359'>
              DTMP=RL*QSS*(1.-RHH)/(CP+RL*RHH*QSS*DSSDT)<a name='1360'>
              T1RH=TZ(ND)+DTMP<a name='1361'>
              ES=RHH*ALIQ*EXP((BLIQ*T1RH-CLIQ)/(T1RH-DLIQ))<a name='1362'>
              QSRH=0.622*ES/(P0(ND)-ES)<a name='1363'>
<font color=#447700>!<a name='1364'></font>
<font color=#447700>!...CHECK TO SEE IF MIXING RATIO AT SPECIFIED RH IS LESS THAN ACTUAL<a name='1365'></font>
<font color=#447700>!...MIXING RATIO...IF SO, ADJUST TO GIVE ZERO EVAPORATION...<a name='1366'></font>
<font color=#447700>!<a name='1367'></font>
              IF(QSRH.LT.QD(ND))THEN<a name='1368'>
                QSRH=QD(ND)<a name='1369'>
                T1RH=TZ(ND)+(QSS-QSRH)*RL/CP<a name='1370'>
              ENDIF<a name='1371'>
              TZ(ND)=T1RH<a name='1372'>
              QSS=QSRH<a name='1373'>
              QSD(ND) = QSS<a name='1374'>
            ENDIF         <a name='1375'>
            TVD(nd) = tz(nd)*(1.+0.608*qsd(nd))<a name='1376'>
            IF(TVD(ND).GT.TV0(ND).OR.ND.EQ.1)THEN<a name='1377'>
              LDB=ND<a name='1378'>
              EXIT<a name='1379'>
            ENDIF<a name='1380'>
          ENDDO<a name='1381'>
          IF((P0(LDB)-P0(LFS)) .gt. 50.E2)THEN   <font color=#447700>! minimum Downdraft depth! <a name='1382'></font>
            DO ND=LDT,LDB,-1<a name='1383'>
              ND1 = ND+1<a name='1384'>
              DDR(ND) = -DMF(KSTART)*DP(ND)/DPDD<a name='1385'>
              DER(ND) = 0.<a name='1386'>
              DMF(ND) = DMF(ND1)+DDR(ND)<a name='1387'>
              TDER=TDER+(QSD(nd)-QD(ND))*DDR(ND)<a name='1388'>
              QD(ND)=QSD(nd)<a name='1389'>
              THTAD(ND)=TZ(ND)*(P00/P0(ND))**(0.2854*(1.-0.28*QD(ND)))<a name='1390'>
            ENDDO<a name='1391'>
          ENDIF<a name='1392'>
        ENDIF<a name='1393'>
      ENDIF devap<a name='1394'>
<font color=#447700>!<a name='1395'></font>
<font color=#447700>!...IF DOWNDRAFT DOES NOT EVAPORATE ANY WATER FOR SPECIFIED RELATIVE<a name='1396'></font>
<font color=#447700>!...HUMIDITY, NO DOWNDRAFT IS ALLOWED...<a name='1397'></font>
<font color=#447700>!<a name='1398'></font>
d_mf:   IF(TDER.LT.1.)THEN<a name='1399'>
<font color=#447700>!           WRITE(98,3004)I,J <a name='1400'></font>
<font color=#447700>!3004       FORMAT(' ','No Downdraft!;  I=',I3,2X,'J=',I3,'ISHALL =',I2)<a name='1401'></font>
          PPTFLX=TRPPT<a name='1402'>
          CPR=TRPPT<a name='1403'>
          TDER=0.<a name='1404'>
          CNDTNF=0.<a name='1405'>
          UPDINC=1.<a name='1406'>
          LDB=LFS<a name='1407'>
          DO NDK=1,LTOP<a name='1408'>
            DMF(NDK)=0.<a name='1409'>
            DER(NDK)=0.<a name='1410'>
            DDR(NDK)=0.<a name='1411'>
            THTAD(NDK)=0.<a name='1412'>
            WD(NDK)=0.<a name='1413'>
            TZ(NDK)=0.<a name='1414'>
            QD(NDK)=0.<a name='1415'>
          ENDDO<a name='1416'>
          AINCM2=100.<a name='1417'>
        ELSE <a name='1418'>
          DDINC = -DMFFRC*UMF(KLCL)/DMF(KSTART)<a name='1419'>
          UPDINC=1.<a name='1420'>
          IF(TDER*DDINC.GT.TRPPT)THEN<a name='1421'>
            DDINC = TRPPT/TDER<a name='1422'>
          ENDIF<a name='1423'>
          TDER = TDER*DDINC<a name='1424'>
          DO NK=LDB,LFS<a name='1425'>
            DMF(NK)=DMF(NK)*DDINC<a name='1426'>
            DER(NK)=DER(NK)*DDINC<a name='1427'>
            DDR(NK)=DDR(NK)*DDINC<a name='1428'>
          ENDDO<a name='1429'>
         CPR=TRPPT<a name='1430'>
         PPTFLX = TRPPT-TDER<a name='1431'>
         PEFF=PPTFLX/TRPPT<a name='1432'>
         IF(IPRNT)THEN<a name='1433'>
           write(98,*)'PRECIP EFFICIENCY =',PEFF<a name='1434'>
<font color=#447700>!          call flush(98)   <a name='1435'></font>
         ENDIF<a name='1436'>
<font color=#447700>!<a name='1437'></font>
<font color=#447700>!<a name='1438'></font>
<font color=#447700>!...ADJUST UPDRAFT MASS FLUX, MASS DETRAINMENT RATE, AND LIQUID WATER AN<a name='1439'></font>
<font color=#447700>!   DETRAINMENT RATES TO BE CONSISTENT WITH THE TRANSFER OF THE ESTIMATE<a name='1440'></font>
<font color=#447700>!   FROM THE UPDRAFT TO THE DOWNDRAFT AT THE LFS...<a name='1441'></font>
<font color=#447700>!     <a name='1442'></font>
<font color=#447700>!         DO NK=LC,LFS<a name='1443'></font>
<font color=#447700>!           UMF(NK)=UMF(NK)*UPDINC<a name='1444'></font>
<font color=#447700>!           UDR(NK)=UDR(NK)*UPDINC<a name='1445'></font>
<font color=#447700>!           UER(NK)=UER(NK)*UPDINC<a name='1446'></font>
<font color=#447700>!           PPTLIQ(NK)=PPTLIQ(NK)*UPDINC<a name='1447'></font>
<font color=#447700>!           PPTICE(NK)=PPTICE(NK)*UPDINC<a name='1448'></font>
<font color=#447700>!           DETLQ(NK)=DETLQ(NK)*UPDINC<a name='1449'></font>
<font color=#447700>!           DETIC(NK)=DETIC(NK)*UPDINC<a name='1450'></font>
<font color=#447700>!         ENDDO<a name='1451'></font>
<font color=#447700>!     <a name='1452'></font>
<font color=#447700>!...ZERO OUT THE ARRAYS FOR DOWNDRAFT DATA AT LEVELS ABOVE AND BELOW THE<a name='1453'></font>
<font color=#447700>!...DOWNDRAFT...<a name='1454'></font>
<font color=#447700>!     <a name='1455'></font>
         IF(LDB.GT.1)THEN<a name='1456'>
           DO NK=1,LDB-1<a name='1457'>
             DMF(NK)=0.<a name='1458'>
             DER(NK)=0.<a name='1459'>
             DDR(NK)=0.<a name='1460'>
             WD(NK)=0.<a name='1461'>
             TZ(NK)=0.<a name='1462'>
             QD(NK)=0.<a name='1463'>
             THTAD(NK)=0.<a name='1464'>
           ENDDO<a name='1465'>
         ENDIF<a name='1466'>
         DO NK=LFS+1,KX<a name='1467'>
           DMF(NK)=0.<a name='1468'>
           DER(NK)=0.<a name='1469'>
           DDR(NK)=0.<a name='1470'>
           WD(NK)=0.<a name='1471'>
           TZ(NK)=0.<a name='1472'>
           QD(NK)=0.<a name='1473'>
           THTAD(NK)=0.<a name='1474'>
         ENDDO<a name='1475'>
         DO NK=LDT+1,LFS-1<a name='1476'>
           TZ(NK)=0.<a name='1477'>
           QD(NK)=0.<a name='1478'>
           THTAD(NK)=0.<a name='1479'>
         ENDDO<a name='1480'>
       ENDIF d_mf<a name='1481'>
<font color=#447700>!<a name='1482'></font>
<font color=#447700>!...SET LIMITS ON THE UPDRAFT AND DOWNDRAFT MASS FLUXES SO THAT THE INFL<a name='1483'></font>
<font color=#447700>!   INTO CONVECTIVE DRAFTS FROM A GIVEN LAYER IS NO MORE THAN IS AVAILAB<a name='1484'></font>
<font color=#447700>!   IN THAT LAYER INITIALLY...<a name='1485'></font>
<font color=#447700>!     <a name='1486'></font>
       AINCMX=1000.<a name='1487'>
       LMAX=MAX0(KLCL,LFS)<a name='1488'>
       DO NK=LC,LMAX<a name='1489'>
         IF((UER(NK)-DER(NK)).GT.1.e-3)THEN<a name='1490'>
           AINCM1=EMS(NK)/((UER(NK)-DER(NK))*TIMEC)<a name='1491'>
           AINCMX=AMIN1(AINCMX,AINCM1)<a name='1492'>
         ENDIF<a name='1493'>
       ENDDO<a name='1494'>
       AINC=1.<a name='1495'>
       IF(AINCMX.LT.AINC)AINC=AINCMX<a name='1496'>
<font color=#447700>!     <a name='1497'></font>
<font color=#447700>!...SAVE THE RELEVENT VARIABLES FOR A UNIT UPDRAFT AND DOWNDRAFT...THEY WILL <a name='1498'></font>
<font color=#447700>!...BE ITERATIVELY ADJUSTED BY THE FACTOR AINC TO SATISFY THE STABILIZATION<a name='1499'></font>
<font color=#447700>!...CLOSURE...<a name='1500'></font>
<font color=#447700>!     <a name='1501'></font>
       TDER2=TDER<a name='1502'>
       PPTFL2=PPTFLX<a name='1503'>
       DO NK=1,LTOP<a name='1504'>
         DETLQ2(NK)=DETLQ(NK)<a name='1505'>
         DETIC2(NK)=DETIC(NK)<a name='1506'>
         UDR2(NK)=UDR(NK)<a name='1507'>
         UER2(NK)=UER(NK)<a name='1508'>
         DDR2(NK)=DDR(NK)<a name='1509'>
         DER2(NK)=DER(NK)<a name='1510'>
         UMF2(NK)=UMF(NK)<a name='1511'>
         DMF2(NK)=DMF(NK)<a name='1512'>
       ENDDO<a name='1513'>
       FABE=1.<a name='1514'>
       STAB=0.95<a name='1515'>
       NOITR=0<a name='1516'>
       ISTOP=0<a name='1517'>
<font color=#447700>!<a name='1518'></font>
        IF(ISHALL.EQ.1)THEN                              <font color=#447700>! First for shallow convection<a name='1519'></font>
<font color=#447700>!<a name='1520'></font>
<font color=#447700>! No iteration for shallow convection; if turbulent kinetic energy (TKE) is available<a name='1521'></font>
<font color=#447700>! from a turbulence parameterization, scale cloud-base updraft mass flux as a function<a name='1522'></font>
<font color=#447700>! of TKE, but for now, just specify shallow-cloud mass flux using TKEMAX = 5...<a name='1523'></font>
<font color=#447700>!<a name='1524'></font>
<font color=#447700>!...find the maximum TKE value between LC and KLCL...<a name='1525'></font>
<font color=#447700>!         TKEMAX = 0.<a name='1526'></font>
          TKEMAX = 5.<a name='1527'>
<font color=#447700>!          DO 173 K = LC,KLCL<a name='1528'></font>
<font color=#447700>!            NK = KX-K+1<a name='1529'></font>
<font color=#447700>!            TKEMAX = AMAX1(TKEMAX,Q2(I,J,NK))<a name='1530'></font>
<font color=#447700>! 173      CONTINUE<a name='1531'></font>
<font color=#447700>!          TKEMAX = AMIN1(TKEMAX,10.)<a name='1532'></font>
<font color=#447700>!          TKEMAX = AMAX1(TKEMAX,5.)<a name='1533'></font>
<font color=#447700>!c         TKEMAX = 10.<a name='1534'></font>
<font color=#447700>!c...3_24_99...DPMIN was changed for shallow convection so that it is the<a name='1535'></font>
<font color=#447700>!c...          the same as for deep convection (5.E3).  Since this doubles<a name='1536'></font>
<font color=#447700>!c...          (roughly) the value of DPTHMX, add a factor of 0.5 to calcu-<a name='1537'></font>
<font color=#447700>!c...          lation of EVAC...<a name='1538'></font>
<font color=#447700>!c         EVAC  = TKEMAX*0.1<a name='1539'></font>
          EVAC  = 0.5*TKEMAX*0.1<a name='1540'>
<font color=#447700>!         AINC = 0.1*DPTHMX*DXIJ*DXIJ/(VMFLCL*G*TIMEC)<a name='1541'></font>
<font color=#447700>!          AINC = EVAC*DPTHMX*DX(I,J)*DX(I,J)/(VMFLCL*G*TIMEC)<a name='1542'></font>
          AINC = EVAC*DPTHMX*DXSQ/(VMFLCL*G*TIMEC)<a name='1543'>
          TDER=TDER2*AINC<a name='1544'>
          PPTFLX=PPTFL2*AINC<a name='1545'>
          DO NK=1,LTOP<a name='1546'>
            UMF(NK)=UMF2(NK)*AINC<a name='1547'>
            DMF(NK)=DMF2(NK)*AINC<a name='1548'>
            DETLQ(NK)=DETLQ2(NK)*AINC<a name='1549'>
            DETIC(NK)=DETIC2(NK)*AINC<a name='1550'>
            UDR(NK)=UDR2(NK)*AINC<a name='1551'>
            UER(NK)=UER2(NK)*AINC<a name='1552'>
            DER(NK)=DER2(NK)*AINC<a name='1553'>
            DDR(NK)=DDR2(NK)*AINC<a name='1554'>
          ENDDO<a name='1555'>
        ENDIF                                           <font color=#447700>! Otherwise for deep convection<a name='1556'></font>
<font color=#447700>! use iterative procedure to find mass fluxes...<a name='1557'></font>
iter:     DO NCOUNT=1,10<a name='1558'>
<font color=#447700>!     <a name='1559'></font>
<font color=#447700>!*****************************************************************<a name='1560'></font>
<font color=#447700>!                                                                *<a name='1561'></font>
<font color=#447700>!           COMPUTE PROPERTIES FOR COMPENSATIONAL SUBSIDENCE     *<a name='1562'></font>
<font color=#447700>!                                                                *<a name='1563'></font>
<font color=#447700>!*****************************************************************<a name='1564'></font>
<font color=#447700>!     <a name='1565'></font>
<font color=#447700>!...DETERMINE OMEGA VALUE NECESSARY AT TOP AND BOTTOM OF EACH LAYER TO<a name='1566'></font>
<font color=#447700>!...SATISFY MASS CONTINUITY...<a name='1567'></font>
<font color=#447700>!     <a name='1568'></font>
            DTT=TIMEC<a name='1569'>
            DO NK=1,LTOP<a name='1570'>
              DOMGDP(NK)=-(UER(NK)-DER(NK)-UDR(NK)-DDR(NK))*EMSD(NK)<a name='1571'>
              IF(NK.GT.1)THEN<a name='1572'>
                OMG(NK)=OMG(NK-1)-DP(NK-1)*DOMGDP(NK-1)<a name='1573'>
                ABSOMG = ABS(OMG(NK))<a name='1574'>
                ABSOMGTC = ABSOMG*TIMEC<a name='1575'>
                FRDP = 0.75*DP(NK-1)<a name='1576'>
                IF(ABSOMGTC.GT.FRDP)THEN<a name='1577'>
                  DTT1 = FRDP/ABSOMG<a name='1578'>
                  DTT=AMIN1(DTT,DTT1)<a name='1579'>
                ENDIF<a name='1580'>
              ENDIF<a name='1581'>
            ENDDO<a name='1582'>
            DO NK=1,LTOP<a name='1583'>
              THPA(NK)=THTA0(NK)<a name='1584'>
              QPA(NK)=Q0(NK)<a name='1585'>
              NSTEP=NINT(TIMEC/DTT+1)<a name='1586'>
              DTIME=TIMEC/FLOAT(NSTEP)<a name='1587'>
              FXM(NK)=OMG(NK)*DXSQ/G<a name='1588'>
            ENDDO<a name='1589'>
<font color=#447700>!     <a name='1590'></font>
<font color=#447700>!...DO AN UPSTREAM/FORWARD-IN-TIME ADVECTION OF THETA, QV...<a name='1591'></font>
<font color=#447700>!     <a name='1592'></font>
        DO NTC=1,NSTEP<a name='1593'>
<font color=#447700>!     <a name='1594'></font>
<font color=#447700>!...ASSIGN THETA AND Q VALUES AT THE TOP AND BOTTOM OF EACH LAYER BASED<a name='1595'></font>
<font color=#447700>!...SIGN OF OMEGA...<a name='1596'></font>
<font color=#447700>!     <a name='1597'></font>
            DO  NK=1,LTOP<a name='1598'>
              THFXIN(NK)=0.<a name='1599'>
              THFXOUT(NK)=0.<a name='1600'>
              QFXIN(NK)=0.<a name='1601'>
              QFXOUT(NK)=0.<a name='1602'>
            ENDDO<a name='1603'>
            DO NK=2,LTOP<a name='1604'>
              IF(OMG(NK).LE.0.)THEN<a name='1605'>
                THFXIN(NK)=-FXM(NK)*THPA(NK-1)<a name='1606'>
                QFXIN(NK)=-FXM(NK)*QPA(NK-1)<a name='1607'>
                THFXOUT(NK-1)=THFXOUT(NK-1)+THFXIN(NK)<a name='1608'>
                QFXOUT(NK-1)=QFXOUT(NK-1)+QFXIN(NK)<a name='1609'>
              ELSE<a name='1610'>
                THFXOUT(NK)=FXM(NK)*THPA(NK)<a name='1611'>
                QFXOUT(NK)=FXM(NK)*QPA(NK)<a name='1612'>
                THFXIN(NK-1)=THFXIN(NK-1)+THFXOUT(NK)<a name='1613'>
                QFXIN(NK-1)=QFXIN(NK-1)+QFXOUT(NK)<a name='1614'>
              ENDIF<a name='1615'>
            ENDDO<a name='1616'>
<font color=#447700>!     <a name='1617'></font>
<font color=#447700>!...UPDATE THE THETA AND QV VALUES AT EACH LEVEL...<a name='1618'></font>
<font color=#447700>!     <a name='1619'></font>
            DO NK=1,LTOP<a name='1620'>
              THPA(NK)=THPA(NK)+(THFXIN(NK)+UDR(NK)*THTAU(NK)+DDR(NK)*      &amp;<a name='1621'>
                       THTAD(NK)-THFXOUT(NK)-(UER(NK)-DER(NK))*THTA0(NK))*  &amp;<a name='1622'>
                       DTIME*EMSD(NK)<a name='1623'>
              QPA(NK)=QPA(NK)+(QFXIN(NK)+UDR(NK)*QDT(NK)+DDR(NK)*QD(NK)-    &amp;<a name='1624'>
                      QFXOUT(NK)-(UER(NK)-DER(NK))*Q0(NK))*DTIME*EMSD(NK)<a name='1625'>
            ENDDO   <a name='1626'>
          ENDDO   <a name='1627'>
          DO NK=1,LTOP<a name='1628'>
            THTAG(NK)=THPA(NK)<a name='1629'>
            QG(NK)=QPA(NK)<a name='1630'>
          ENDDO<a name='1631'>
<font color=#447700>!     <a name='1632'></font>
<font color=#447700>!...CHECK TO SEE IF MIXING RATIO DIPS BELOW ZERO ANYWHERE;  IF SO, BORRO<a name='1633'></font>
<font color=#447700>!...MOISTURE FROM ADJACENT LAYERS TO BRING IT BACK UP ABOVE ZERO...<a name='1634'></font>
<font color=#447700>!     <a name='1635'></font>
        DO NK=1,LTOP<a name='1636'>
          IF(QG(NK).LT.0.)THEN<a name='1637'>
            IF(NK.EQ.1)THEN                             <font color=#447700>! JSK MODS<a name='1638'></font>
<font color=#447700>!              PRINT *,' PROBLEM WITH KF SCHEME:  ' ! JSK MODS<a name='1639'></font>
<font color=#447700>!              PRINT *,'QG = 0 AT THE SURFACE!!!!!!!'    ! JSK MODS<a name='1640'></font>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_143"> ( 'QG, QG(NK).LT.0') <font color=#447700>! JSK MODS<a name='1641'></font>
            ENDIF                                       <font color=#447700>! JSK MODS<a name='1642'></font>
            NK1=NK+1<a name='1643'>
            IF(NK.EQ.LTOP)THEN<a name='1644'>
              NK1=KLCL<a name='1645'>
            ENDIF<a name='1646'>
            TMA=QG(NK1)*EMS(NK1)<a name='1647'>
            TMB=QG(NK-1)*EMS(NK-1)<a name='1648'>
            TMM=(QG(NK)-1.E-9)*EMS(NK  )<a name='1649'>
            BCOEFF=-TMM/((TMA*TMA)/TMB+TMB)<a name='1650'>
            ACOEFF=BCOEFF*TMA/TMB<a name='1651'>
            TMB=TMB*(1.-BCOEFF)<a name='1652'>
            TMA=TMA*(1.-ACOEFF)<a name='1653'>
            IF(NK.EQ.LTOP)THEN<a name='1654'>
              QVDIFF=(QG(NK1)-TMA*EMSD(NK1))*100./QG(NK1)<a name='1655'>
<font color=#447700>!              IF(ABS(QVDIFF).GT.1.)THEN<a name='1656'></font>
<font color=#447700>!             PRINT *,'!!!WARNING!!! CLOUD BASE WATER VAPOR CHANGES BY ',     &amp;<a name='1657'></font>
<font color=#447700>!                      QVDIFF,                                                &amp;<a name='1658'></font>
<font color=#447700>!                     '% WHEN MOISTURE IS BORROWED TO PREVENT NEGATIVE ',     &amp;<a name='1659'></font>
<font color=#447700>!                     'VALUES IN KAIN-FRITSCH'<a name='1660'></font>
<font color=#447700>!              ENDIF<a name='1661'></font>
            ENDIF<a name='1662'>
            QG(NK)=1.E-9<a name='1663'>
            QG(NK1)=TMA*EMSD(NK1)<a name='1664'>
            QG(NK-1)=TMB*EMSD(NK-1)<a name='1665'>
          ENDIF<a name='1666'>
        ENDDO<a name='1667'>
        TOPOMG=(UDR(LTOP)-UER(LTOP))*DP(LTOP)*EMSD(LTOP)<a name='1668'>
        IF(ABS(TOPOMG-OMG(LTOP)).GT.1.E-3)THEN<a name='1669'>
<font color=#447700>!       WRITE(99,*)'ERROR:  MASS DOES NOT BALANCE IN KF SCHEME;            &amp;<a name='1670'></font>
<font color=#447700>!      TOPOMG, OMG =',TOPOMG,OMG(LTOP)<a name='1671'></font>
<font color=#447700>!      TOPOMG, OMG =',TOPOMG,OMG(LTOP)<a name='1672'></font>
          ISTOP=1<a name='1673'>
          IPRNT=.TRUE.<a name='1674'>
          EXIT iter<a name='1675'>
        ENDIF<a name='1676'>
<font color=#447700>!     <a name='1677'></font>
<font color=#447700>!...CONVERT THETA TO T...<a name='1678'></font>
<font color=#447700>!     <a name='1679'></font>
        DO NK=1,LTOP<a name='1680'>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*QG(NK)))<a name='1681'>
          TG(NK)=THTAG(NK)/EXN(NK)<a name='1682'>
          TVG(NK)=TG(NK)*(1.+0.608*QG(NK))<a name='1683'>
        ENDDO<a name='1684'>
        IF(ISHALL.EQ.1)THEN<a name='1685'>
          EXIT iter<a name='1686'>
        ENDIF<a name='1687'>
<font color=#447700>!     <a name='1688'></font>
<font color=#447700>!*******************************************************************<a name='1689'></font>
<font color=#447700>!                                                                  *<a name='1690'></font>
<font color=#447700>!     COMPUTE NEW CLOUD AND CHANGE IN AVAILABLE BUOYANT ENERGY.    *<a name='1691'></font>
<font color=#447700>!                                                                  *<a name='1692'></font>
<font color=#447700>!*******************************************************************<a name='1693'></font>
<font color=#447700>!     <a name='1694'></font>
<font color=#447700>!...THE FOLLOWING COMPUTATIONS ARE SIMILAR TO THAT FOR UPDRAFT<a name='1695'></font>
<font color=#447700>!     <a name='1696'></font>
<font color=#447700>!        THMIX=0.<a name='1697'></font>
          TMIX=0.<a name='1698'>
          QMIX=0.<a name='1699'>
<font color=#447700>!<a name='1700'></font>
<font color=#447700>!...FIND THE THERMODYNAMIC CHARACTERISTICS OF THE LAYER BY<a name='1701'></font>
<font color=#447700>!...MASS-WEIGHTING THE CHARACTERISTICS OF THE INDIVIDUAL MODEL<a name='1702'></font>
<font color=#447700>!...LAYERS...<a name='1703'></font>
<font color=#447700>!<a name='1704'></font>
          DO NK=LC,KPBL<a name='1705'>
            TMIX=TMIX+DP(NK)*TG(NK)<a name='1706'>
            QMIX=QMIX+DP(NK)*QG(NK)  <a name='1707'>
          ENDDO<a name='1708'>
          TMIX=TMIX/DPTHMX<a name='1709'>
          QMIX=QMIX/DPTHMX<a name='1710'>
          ES=ALIQ*EXP((TMIX*BLIQ-CLIQ)/(TMIX-DLIQ))<a name='1711'>
          QSS=0.622*ES/(PMIX-ES)<a name='1712'>
<font color=#447700>!     <a name='1713'></font>
<font color=#447700>!...REMOVE SUPERSATURATION FOR DIAGNOSTIC PURPOSES, IF NECESSARY...<a name='1714'></font>
<font color=#447700>!     <a name='1715'></font>
          IF(QMIX.GT.QSS)THEN<a name='1716'>
            RL=XLV0-XLV1*TMIX<a name='1717'>
            CPM=CP*(1.+0.887*QMIX)<a name='1718'>
            DSSDT=QSS*(CLIQ-BLIQ*DLIQ)/((TMIX-DLIQ)*(TMIX-DLIQ))<a name='1719'>
            DQ=(QMIX-QSS)/(1.+RL*DSSDT/CPM)<a name='1720'>
            TMIX=TMIX+RL/CP*DQ<a name='1721'>
            QMIX=QMIX-DQ<a name='1722'>
            TLCL=TMIX<a name='1723'>
          ELSE<a name='1724'>
            QMIX=AMAX1(QMIX,0.)<a name='1725'>
            EMIX=QMIX*PMIX/(0.622+QMIX)<a name='1726'>
            astrt=1.e-3<a name='1727'>
            binc=0.075<a name='1728'>
            a1=emix/aliq<a name='1729'>
            tp=(a1-astrt)/binc<a name='1730'>
            indlu=int(tp)+1<a name='1731'>
            value=(indlu-1)*binc+astrt<a name='1732'>
            aintrp=(a1-value)/binc<a name='1733'>
            tlog=aintrp*alu(indlu+1)+(1-aintrp)*alu(indlu)<a name='1734'>
            TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)<a name='1735'>
            TLCL=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(TMIX-T00))*(TMIX-TDPT)<a name='1736'>
            TLCL=AMIN1(TLCL,TMIX)<a name='1737'>
          ENDIF<a name='1738'>
          TVLCL=TLCL*(1.+0.608*QMIX)<a name='1739'>
          ZLCL = ZMIX+(TLCL-TMIX)/GDRY<a name='1740'>
          DO NK = LC,KL<a name='1741'>
            KLCL=NK<a name='1742'>
            IF(ZLCL.LE.Z0(NK))THEN<a name='1743'>
              EXIT <a name='1744'>
            ENDIF<a name='1745'>
          ENDDO<a name='1746'>
          K=KLCL-1<a name='1747'>
          DLP=(ZLCL-Z0(K))/(Z0(KLCL)-Z0(K))<a name='1748'>
<font color=#447700>!     <a name='1749'></font>
<font color=#447700>!...ESTIMATE ENVIRONMENTAL TEMPERATURE AND MIXING RATIO AT THE LCL...<a name='1750'></font>
<font color=#447700>!     <a name='1751'></font>
          TENV=TG(K)+(TG(KLCL)-TG(K))*DLP<a name='1752'>
          QENV=QG(K)+(QG(KLCL)-QG(K))*DLP<a name='1753'>
          TVEN=TENV*(1.+0.608*QENV)<a name='1754'>
          PLCL=P0(K)+(P0(KLCL)-P0(K))*DLP<a name='1755'>
          THETEU(K)=TMIX*(1.E5/PMIX)**(0.2854*(1.-0.28*QMIX))*             &amp;<a name='1756'>
                  EXP((3374.6525/TLCL-2.5403)*QMIX*(1.+0.81*QMIX))<a name='1757'>
<font color=#447700>!     <a name='1758'></font>
<font color=#447700>!...COMPUTE ADJUSTED ABE(ABEG).<a name='1759'></font>
<font color=#447700>!     <a name='1760'></font>
          ABEG=0.<a name='1761'>
          DO NK=K,LTOPM1<a name='1762'>
            NK1=NK+1<a name='1763'>
            THETEU(NK1) = THETEU(NK)<a name='1764'>
<font color=#447700>!<a name='1765'></font>
            call <A href='../../html_code/phys/module_cu_kfeta.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_4">(p0(nk1),theteu(nk1),tgu(nk1),qgu(nk1))<a name='1766'>
<font color=#447700>!<a name='1767'></font>
            TVQU(NK1)=TGU(NK1)*(1.+0.608*QGU(NK1)-QLIQ(NK1)-QICE(NK1))<a name='1768'>
            IF(NK.EQ.K)THEN<a name='1769'>
              DZZ=Z0(KLCL)-ZLCL<a name='1770'>
              DILBE=((TVLCL+TVQU(NK1))/(TVEN+TVG(NK1))-1.)*DZZ<a name='1771'>
            ELSE<a name='1772'>
              DZZ=DZA(NK)<a name='1773'>
              DILBE=((TVQU(NK)+TVQU(NK1))/(TVG(NK)+TVG(NK1))-1.)*DZZ<a name='1774'>
            ENDIF<a name='1775'>
            IF(DILBE.GT.0.)ABEG=ABEG+DILBE*G<a name='1776'>
<font color=#447700>!<a name='1777'></font>
<font color=#447700>!...DILUTE BY ENTRAINMENT BY THE RATE AS ORIGINAL UPDRAFT...<a name='1778'></font>
<font color=#447700>!<a name='1779'></font>
            CALL <A href='../../html_code/phys/module_cu_kfeta.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_8">(P0(NK1),TG(NK1),QG(NK1),THTEEG(NK1),ALIQ,BLIQ,CLIQ,DLIQ)<a name='1780'>
            THETEU(NK1)=THETEU(NK1)*DDILFRC(NK1)+THTEEG(NK1)*(1.-DDILFRC(NK1))<a name='1781'>
          ENDDO<a name='1782'>
<font color=#447700>!     <a name='1783'></font>
<font color=#447700>!...ASSUME AT LEAST 90% OF CAPE (ABE) IS REMOVED BY CONVECTION DURING<a name='1784'></font>
<font color=#447700>!...THE PERIOD TIMEC...<a name='1785'></font>
<font color=#447700>!     <a name='1786'></font>
          IF(NOITR.EQ.1)THEN<a name='1787'>
<font color=#447700>!         write(98,*)' '<a name='1788'></font>
<font color=#447700>!         write(98,*)'TAU, I, J, =',NTSD,I,J<a name='1789'></font>
<font color=#447700>!         WRITE(98,1060)FABE<a name='1790'></font>
<font color=#447700>!          GOTO 265<a name='1791'></font>
          EXIT iter<a name='1792'>
          ENDIF<a name='1793'>
          DABE=AMAX1(ABE-ABEG,0.1*ABE)<a name='1794'>
          FABE=ABEG/ABE<a name='1795'>
          IF(FABE.GT.1. .and. ISHALL.EQ.0)THEN<a name='1796'>
<font color=#447700>!          WRITE(98,*)'UPDRAFT/DOWNDRAFT COUPLET INCREASES CAPE AT THIS<a name='1797'></font>
<font color=#447700>!     *GRID POINT; NO CONVECTION ALLOWED!'<a name='1798'></font>
            RETURN  <a name='1799'>
          ENDIF<a name='1800'>
          IF(NCOUNT.NE.1)THEN<a name='1801'>
            IF(ABS(AINC-AINCOLD).LT.0.0001)THEN<a name='1802'>
              NOITR=1<a name='1803'>
              AINC=AINCOLD<a name='1804'>
              CYCLE iter<a name='1805'>
            ENDIF<a name='1806'>
            DFDA=(FABE-FABEOLD)/(AINC-AINCOLD)<a name='1807'>
            IF(DFDA.GT.0.)THEN<a name='1808'>
              NOITR=1<a name='1809'>
              AINC=AINCOLD<a name='1810'>
              CYCLE iter<a name='1811'>
            ENDIF<a name='1812'>
          ENDIF<a name='1813'>
          AINCOLD=AINC<a name='1814'>
          FABEOLD=FABE<a name='1815'>
          IF(AINC/AINCMX.GT.0.999.AND.FABE.GT.1.05-STAB)THEN<a name='1816'>
<font color=#447700>!           write(98,*)' '<a name='1817'></font>
<font color=#447700>!           write(98,*)'TAU, I, J, =',NTSD,I,J<a name='1818'></font>
<font color=#447700>!           WRITE(98,1055)FABE<a name='1819'></font>
<font color=#447700>!            GOTO 265<a name='1820'></font>
            EXIT<a name='1821'>
          ENDIF<a name='1822'>
          IF((FABE.LE.1.05-STAB.AND.FABE.GE.0.95-STAB) .or. NCOUNT.EQ.10)THEN<a name='1823'>
            EXIT iter<a name='1824'>
          ELSE<a name='1825'>
            IF(NCOUNT.GT.10)THEN<a name='1826'>
<font color=#447700>!             write(98,*)' '<a name='1827'></font>
<font color=#447700>!             write(98,*)'TAU, I, J, =',NTSD,I,J<a name='1828'></font>
<font color=#447700>!             WRITE(98,1060)FABE<a name='1829'></font>
<font color=#447700>!             GOTO 265<a name='1830'></font>
              EXIT<a name='1831'>
            ENDIF<a name='1832'>
<font color=#447700>!     <a name='1833'></font>
<font color=#447700>!...IF MORE THAN 10% OF THE ORIGINAL CAPE REMAINS, INCREASE THE CONVECTI<a name='1834'></font>
<font color=#447700>!...MASS FLUX BY THE FACTOR AINC:<a name='1835'></font>
<font color=#447700>!     <a name='1836'></font>
            IF(FABE.EQ.0.)THEN<a name='1837'>
              AINC=AINC*0.5<a name='1838'>
            ELSE<a name='1839'>
              IF(DABE.LT.1.e-4)THEN<a name='1840'>
                NOITR=1<a name='1841'>
                AINC=AINCOLD<a name='1842'>
                CYCLE iter<a name='1843'>
              ELSE<a name='1844'>
                AINC=AINC*STAB*ABE/DABE<a name='1845'>
              ENDIF<a name='1846'>
            ENDIF<a name='1847'>
<font color=#447700>!           AINC=AMIN1(AINCMX,AINC)<a name='1848'></font>
            AINC=AMIN1(AINCMX,AINC)<a name='1849'>
<font color=#447700>!...IF AINC BECOMES VERY SMALL, EFFECTS OF CONVECTION ! JSK MODS<a name='1850'></font>
<font color=#447700>!...WILL BE MINIMAL SO JUST IGNORE IT...              ! JSK MODS<a name='1851'></font>
            IF(AINC.LT.0.05)then<a name='1852'>
              RETURN                          <font color=#447700>! JSK MODS<a name='1853'></font>
            ENDIF<a name='1854'>
<font color=#447700>!            AINC=AMAX1(AINC,0.05)                        ! JSK MODS<a name='1855'></font>
            TDER=TDER2*AINC<a name='1856'>
            PPTFLX=PPTFL2*AINC<a name='1857'>
<font color=#447700>!           IF (XTIME.LT.10.)THEN<a name='1858'></font>
<font color=#447700>!           WRITE(98,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,<a name='1859'></font>
<font color=#447700>!          *              FABEOLD,AINCOLD <a name='1860'></font>
<font color=#447700>!           ENDIF<a name='1861'></font>
            DO NK=1,LTOP<a name='1862'>
              UMF(NK)=UMF2(NK)*AINC<a name='1863'>
              DMF(NK)=DMF2(NK)*AINC<a name='1864'>
              DETLQ(NK)=DETLQ2(NK)*AINC<a name='1865'>
              DETIC(NK)=DETIC2(NK)*AINC<a name='1866'>
              UDR(NK)=UDR2(NK)*AINC<a name='1867'>
              UER(NK)=UER2(NK)*AINC<a name='1868'>
              DER(NK)=DER2(NK)*AINC<a name='1869'>
              DDR(NK)=DDR2(NK)*AINC<a name='1870'>
            ENDDO<a name='1871'>
<font color=#447700>!     <a name='1872'></font>
<font color=#447700>!...GO BACK UP FOR ANOTHER ITERATION...<a name='1873'></font>
<font color=#447700>!     <a name='1874'></font>
          ENDIF<a name='1875'>
        ENDDO iter<a name='1876'>
<font color=#447700>!     <a name='1877'></font>
<font color=#447700>!...COMPUTE HYDROMETEOR TENDENCIES AS IS DONE FOR T, QV...<a name='1878'></font>
<font color=#447700>!     <a name='1879'></font>
<font color=#447700>!...FRC2 IS THE FRACTION OF TOTAL CONDENSATE      !  PPT FB MODS<a name='1880'></font>
<font color=#447700>!...GENERATED THAT GOES INTO PRECIPITIATION       !  PPT FB MODS<a name='1881'></font>
<font color=#447700>!<a name='1882'></font>
<font color=#447700>!  Redistribute hydormeteors according to the final mass-flux values:<a name='1883'></font>
<font color=#447700>!<a name='1884'></font>
        IF(CPR.GT.0.)THEN <a name='1885'>
          FRC2=PPTFLX/(CPR*AINC)                    <font color=#447700>!  PPT FB MODS<a name='1886'></font>
        ELSE<a name='1887'>
           FRC2=0.<a name='1888'>
        ENDIF<a name='1889'>
        DO NK=1,LTOP<a name='1890'>
          QLPA(NK)=QL0(NK)<a name='1891'>
          QIPA(NK)=QI0(NK)<a name='1892'>
          QRPA(NK)=QR0(NK)<a name='1893'>
          QSPA(NK)=QS0(NK)<a name='1894'>
          RAINFB(NK)=PPTLIQ(NK)*AINC*FBFRC*FRC2   <font color=#447700>!  PPT FB MODS<a name='1895'></font>
          SNOWFB(NK)=PPTICE(NK)*AINC*FBFRC*FRC2   <font color=#447700>!  PPT FB MODS<a name='1896'></font>
        ENDDO<a name='1897'>
        DO NTC=1,NSTEP<a name='1898'>
<font color=#447700>!     <a name='1899'></font>
<font color=#447700>!...ASSIGN HYDROMETEORS CONCENTRATIONS AT THE TOP AND BOTTOM OF EACH LAY<a name='1900'></font>
<font color=#447700>!...BASED ON THE SIGN OF OMEGA...<a name='1901'></font>
<font color=#447700>!     <a name='1902'></font>
          DO NK=1,LTOP<a name='1903'>
            QLFXIN(NK)=0.<a name='1904'>
            QLFXOUT(NK)=0.<a name='1905'>
            QIFXIN(NK)=0.<a name='1906'>
            QIFXOUT(NK)=0.<a name='1907'>
            QRFXIN(NK)=0.<a name='1908'>
            QRFXOUT(NK)=0.<a name='1909'>
            QSFXIN(NK)=0.<a name='1910'>
            QSFXOUT(NK)=0.<a name='1911'>
          ENDDO   <a name='1912'>
          DO NK=2,LTOP<a name='1913'>
            IF(OMG(NK).LE.0.)THEN<a name='1914'>
              QLFXIN(NK)=-FXM(NK)*QLPA(NK-1)<a name='1915'>
              QIFXIN(NK)=-FXM(NK)*QIPA(NK-1)<a name='1916'>
              QRFXIN(NK)=-FXM(NK)*QRPA(NK-1)<a name='1917'>
              QSFXIN(NK)=-FXM(NK)*QSPA(NK-1)<a name='1918'>
              QLFXOUT(NK-1)=QLFXOUT(NK-1)+QLFXIN(NK)<a name='1919'>
              QIFXOUT(NK-1)=QIFXOUT(NK-1)+QIFXIN(NK)<a name='1920'>
              QRFXOUT(NK-1)=QRFXOUT(NK-1)+QRFXIN(NK)<a name='1921'>
              QSFXOUT(NK-1)=QSFXOUT(NK-1)+QSFXIN(NK)<a name='1922'>
            ELSE<a name='1923'>
              QLFXOUT(NK)=FXM(NK)*QLPA(NK)<a name='1924'>
              QIFXOUT(NK)=FXM(NK)*QIPA(NK)<a name='1925'>
              QRFXOUT(NK)=FXM(NK)*QRPA(NK)<a name='1926'>
              QSFXOUT(NK)=FXM(NK)*QSPA(NK)<a name='1927'>
              QLFXIN(NK-1)=QLFXIN(NK-1)+QLFXOUT(NK)<a name='1928'>
              QIFXIN(NK-1)=QIFXIN(NK-1)+QIFXOUT(NK)<a name='1929'>
              QRFXIN(NK-1)=QRFXIN(NK-1)+QRFXOUT(NK)<a name='1930'>
              QSFXIN(NK-1)=QSFXIN(NK-1)+QSFXOUT(NK)<a name='1931'>
            ENDIF<a name='1932'>
          ENDDO   <a name='1933'>
<font color=#447700>!     <a name='1934'></font>
<font color=#447700>!...UPDATE THE HYDROMETEOR CONCENTRATION VALUES AT EACH LEVEL...<a name='1935'></font>
<font color=#447700>!     <a name='1936'></font>
          DO NK=1,LTOP<a name='1937'>
            QLPA(NK)=QLPA(NK)+(QLFXIN(NK)+DETLQ(NK)-QLFXOUT(NK))*DTIME*EMSD(NK)<a name='1938'>
            QIPA(NK)=QIPA(NK)+(QIFXIN(NK)+DETIC(NK)-QIFXOUT(NK))*DTIME*EMSD(NK)<a name='1939'>
            QRPA(NK)=QRPA(NK)+(QRFXIN(NK)-QRFXOUT(NK)+RAINFB(NK))*DTIME*EMSD(NK)         <font color=#447700>!  PPT FB MODS<a name='1940'></font>
            QSPA(NK)=QSPA(NK)+(QSFXIN(NK)-QSFXOUT(NK)+SNOWFB(NK))*DTIME*EMSD(NK)         <font color=#447700>!  PPT FB MODS<a name='1941'></font>
          ENDDO     <a name='1942'>
        ENDDO<a name='1943'>
        DO NK=1,LTOP<a name='1944'>
          QLG(NK)=QLPA(NK)<a name='1945'>
          QIG(NK)=QIPA(NK)<a name='1946'>
          QRG(NK)=QRPA(NK)<a name='1947'>
          QSG(NK)=QSPA(NK)<a name='1948'>
        ENDDO   <a name='1949'>
<font color=#447700>!<a name='1950'></font>
<font color=#447700>!...CLEAN THINGS UP, CALCULATE CONVECTIVE FEEDBACK TENDENCIES FOR THIS<a name='1951'></font>
<font color=#447700>!...GRID POINT...<a name='1952'></font>
<font color=#447700>!     <a name='1953'></font>
<font color=#447700>!     IF (XTIME.LT.10.)THEN<a name='1954'></font>
<font color=#447700>!     WRITE(98,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,FABE,AINC <a name='1955'></font>
<font color=#447700>!     ENDIF<a name='1956'></font>
       IF(IPRNT)THEN  <a name='1957'>
         WRITE(98,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,FABE,AINC<a name='1958'>
<font color=#447700>!        call flush(98)   <a name='1959'></font>
       endif  <a name='1960'>
<font color=#447700>!     <a name='1961'></font>
<font color=#447700>!...SEND FINAL PARAMETERIZED VALUES TO OUTPUT FILES...<a name='1962'></font>
<font color=#447700>!     <a name='1963'></font>
<font color=#447700>!297   IF(IPRNT)then <a name='1964'></font>
       IF(IPRNT)then <a name='1965'>
<font color=#447700>!    if(I.eq.16 .and. J.eq.41)then<a name='1966'></font>
<font color=#447700>!      IF(ISTOP.EQ.1)THEN<a name='1967'></font>
         write(98,*)<a name='1968'>
<font color=#447700>!        write(98,*)'At t(h), I, J =',float(NTSD)*72./3600.,I,J<a name='1969'></font>
         write(98,*)'P(LC), DTP, WKL, WKLCL =',p0(LC)/100.,       &amp;<a name='1970'>
                     TLCL+DTLCL+dtrh-TENV,WKL,WKLCL<a name='1971'>
         write(98,*)'TLCL, DTLCL, DTRH, TENV =',TLCL,DTLCL,       &amp;<a name='1972'>
                      DTRH,TENV   <a name='1973'>
         WRITE(98,1025)KLCL,ZLCL,DTLCL,LTOP,P0(LTOP),IFLAG,       &amp;<a name='1974'>
         TMIX-T00,PMIX,QMIX,ABE<a name='1975'>
         WRITE(98,1030)P0(LET)/100.,P0(LTOP)/100.,VMFLCL,PLCL/100.,  &amp;<a name='1976'>
         WLCL,CLDHGT(LC)<a name='1977'>
         WRITE(98,1035)PEF,PEFCBH,LC,LET,WKL,VWS <a name='1978'>
         write(98,*)'PRECIP EFFICIENCY =',PEFF <a name='1979'>
      WRITE(98,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,FABE,AINC<a name='1980'>
<font color=#447700>!      ENDIF<a name='1981'></font>
<font color=#447700>!!!!! HERE !!!!!!!<a name='1982'></font>
           WRITE(98,1070)'  P  ','   DP ',' DT K/D ',' DR K/D ','   OMG  ',        &amp;<a name='1983'>
          ' DOMGDP ','   UMF  ','   UER  ','   UDR  ','   DMF  ','   DER  '        &amp;<a name='1984'>
          ,'   DDR  ','   EMS  ','    W0  ','  DETLQ ',' DETIC '<a name='1985'>
           write(98,*)'just before DO 300...'<a name='1986'>
<font color=#447700>!          call flush(98)<a name='1987'></font>
           DO NK=1,LTOP<a name='1988'>
             K=LTOP-NK+1<a name='1989'>
             DTT=(TG(K)-T0(K))*86400./TIMEC<a name='1990'>
             RL=XLV0-XLV1*TG(K)<a name='1991'>
             DR=-(QG(K)-Q0(K))*RL*86400./(TIMEC*CP)<a name='1992'>
             UDFRC=UDR(K)*TIMEC*EMSD(K)<a name='1993'>
             UEFRC=UER(K)*TIMEC*EMSD(K)<a name='1994'>
             DDFRC=DDR(K)*TIMEC*EMSD(K)<a name='1995'>
             DEFRC=-DER(K)*TIMEC*EMSD(K)<a name='1996'>
             WRITE(98,1075)P0(K)/100.,DP(K)/100.,DTT,DR,OMG(K),DOMGDP(K)*1.E4,       &amp;<a name='1997'>
             UMF(K)/1.E6,UEFRC,UDFRC,DMF(K)/1.E6,DEFRC,DDFRC,EMS(K)/1.E11,           &amp;<a name='1998'>
             W0AVG1D(K)*1.E2,DETLQ(K)*TIMEC*EMSD(K)*1.E3,DETIC(K)*                   &amp;<a name='1999'>
             TIMEC*EMSD(K)*1.E3<a name='2000'>
           ENDDO<a name='2001'>
           WRITE(98,1085)'K','P','Z','T0','TG','DT','TU','TD','Q0','QG',             &amp;<a name='2002'>
                  'DQ','QU','QD','QLG','QIG','QRG','QSG','RH0','RHG'<a name='2003'>
           DO NK=1,KL<a name='2004'>
             K=KX-NK+1<a name='2005'>
             DTT=TG(K)-T0(K)<a name='2006'>
             TUC=TU(K)-T00<a name='2007'>
             IF(K.LT.LC.OR.K.GT.LTOP)TUC=0.<a name='2008'>
             TDC=TZ(K)-T00<a name='2009'>
             IF((K.LT.LDB.OR.K.GT.LDT).AND.K.NE.LFS)TDC=0.<a name='2010'>
             IF(T0(K).LT.T00)THEN<a name='2011'>
               ES=ALIQ*EXP((BLIQ*TG(K)-CLIQ)/(TG(K)-DLIQ))<a name='2012'>
             ELSE<a name='2013'>
               ES=ALIQ*EXP((BLIQ*TG(K)-CLIQ)/(TG(K)-DLIQ))<a name='2014'>
             ENDIF  <a name='2015'>
             QGS=ES*0.622/(P0(K)-ES)<a name='2016'>
             RH0=Q0(K)/QES(K)<a name='2017'>
             RHG=QG(K)/QGS<a name='2018'>
             WRITE(98,1090)K,P0(K)/100.,Z0(K),T0(K)-T00,TG(K)-T00,DTT,TUC,            &amp;<a name='2019'>
             TDC,Q0(K)*1000.,QG(K)*1000.,(QG(K)-Q0(K))*1000.,QU(K)*                   &amp;<a name='2020'>
             1000.,QD(K)*1000.,QLG(K)*1000.,QIG(K)*1000.,QRG(K)*1000.,                &amp;<a name='2021'>
             QSG(K)*1000.,RH0,RHG<a name='2022'>
           ENDDO<a name='2023'>
<font color=#447700>!     <a name='2024'></font>
<font color=#447700>!...IF CALCULATIONS ABOVE SHOW AN ERROR IN THE MASS BUDGET, PRINT OUT A<a name='2025'></font>
<font color=#447700>!...TO BE USED LATER FOR DIAGNOSTIC PURPOSES, THEN ABORT RUN...<a name='2026'></font>
<font color=#447700>!     <a name='2027'></font>
<font color=#447700>!         IF(ISTOP.EQ.1 .or. ISHALL.EQ.1)THEN<a name='2028'></font>
<a name='2029'>
<font color=#447700>!         IF(ISHALL.NE.1)THEN<a name='2030'></font>
<font color=#447700>!            write(98,4421)i,j,iyr,imo,idy,ihr,imn<a name='2031'></font>
<font color=#447700>!           write(98)i,j,iyr,imo,idy,ihr,imn,kl<a name='2032'></font>
<font color=#447700>! 4421       format(7i4)<a name='2033'></font>
<font color=#447700>!            write(98,4422)kl<a name='2034'></font>
<font color=#447700>! 4422       format(i6) <a name='2035'></font>
            DO 310 NK = 1,KL<a name='2036'>
              k = kl - nk + 1<a name='2037'>
              write(98,4455) p0(k)/100.,t0(k)-273.16,q0(k)*1000.,       &amp;<a name='2038'>
                       u0(k),v0(k),W0AVG1D(K),dp(k),tke(k)<a name='2039'>
<font color=#447700>!             write(98) p0,t0,q0,u0,v0,w0,dp,tke<a name='2040'></font>
<font color=#447700>!           WRITE(98,1115)Z0(K),P0(K)/100.,T0(K)-273.16,Q0(K)*1000.,<a name='2041'></font>
<font color=#447700>!    *               U0(K),V0(K),DP(K)/100.,W0AVG(I,J,K)<a name='2042'></font>
 310        CONTINUE<a name='2043'>
            IF(ISTOP.EQ.1)THEN<a name='2044'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_144"> ( 'KAIN-FRITSCH, istop=1, diags' )<a name='2045'>
            ENDIF<a name='2046'>
<font color=#447700>!         ENDIF<a name='2047'></font>
  4455  format(8f11.3) <a name='2048'>
       ENDIF<a name='2049'>
        CNDTNF=(1.-EQFRC(LFS))*(QLIQ(LFS)+QICE(LFS))*DMF(LFS)<a name='2050'>
        RAINCV(I,J)=DT*PPTFLX*(1.-FBFRC)/DXSQ     <font color=#447700>!  PPT FB MODS<a name='2051'></font>
<font color=#447700>!        RAINCV(I,J)=.1*.5*DT*PPTFLX/DXSQ               !  PPT FB MODS<a name='2052'></font>
<font color=#447700>!         RNC=0.1*TIMEC*PPTFLX/DXSQ<a name='2053'></font>
        RNC=RAINCV(I,J)*NIC<a name='2054'>
       IF(ISHALL.EQ.0.AND.IPRNT)write (98,909)I,J,RNC<a name='2055'>
<a name='2056'>
<font color=#447700>!     WRITE(98,1095)CPR*AINC,TDER+PPTFLX+CNDTNF<a name='2057'></font>
<font color=#447700>!     <a name='2058'></font>
<font color=#447700>!  EVALUATE MOISTURE BUDGET...<a name='2059'></font>
<font color=#447700>!     <a name='2060'></font>
<a name='2061'>
        QINIT=0.<a name='2062'>
        QFNL=0.<a name='2063'>
        DPT=0.<a name='2064'>
        DO 315 NK=1,LTOP<a name='2065'>
          DPT=DPT+DP(NK)<a name='2066'>
          QINIT=QINIT+Q0(NK)*EMS(NK)<a name='2067'>
          QFNL=QFNL+QG(NK)*EMS(NK)<a name='2068'>
          QFNL=QFNL+(QLG(NK)+QIG(NK)+QRG(NK)+QSG(NK))*EMS(NK)<a name='2069'>
  315   CONTINUE<a name='2070'>
        QFNL=QFNL+PPTFLX*TIMEC*(1.-FBFRC)       <font color=#447700>!  PPT FB MODS<a name='2071'></font>
<font color=#447700>!        QFNL=QFNL+PPTFLX*TIMEC                 !  PPT FB MODS<a name='2072'></font>
        ERR2=(QFNL-QINIT)*100./QINIT<a name='2073'>
       IF(IPRNT)WRITE(98,1110)QINIT,QFNL,ERR2<a name='2074'>
      IF(ABS(ERR2).GT.0.05 .AND. ISTOP.EQ.0)THEN <a name='2075'>
<font color=#447700>!       write(99,*)'!!!!!!!! MOISTURE BUDGET ERROR IN KFPARA !!!'<a name='2076'></font>
<font color=#447700>!       WRITE(99,1110)QINIT,QFNL,ERR2<a name='2077'></font>
        IPRNT=.TRUE.<a name='2078'>
        ISTOP=1<a name='2079'>
            write(98,4422)kl<a name='2080'>
 4422       format(i6)<a name='2081'>
            DO 311 NK = 1,KL<a name='2082'>
              k = kl - nk + 1<a name='2083'>
<font color=#447700>!             write(99,4455) p0(k)/100.,t0(k)-273.16,q0(k)*1000.,       &amp;<a name='2084'></font>
<font color=#447700>!                      u0(k),v0(k),W0AVG1D(K),dp(k)<a name='2085'></font>
<font color=#447700>!             write(98) p0,t0,q0,u0,v0,w0,dp,tke<a name='2086'></font>
<font color=#447700>!           WRITE(98,1115)P0(K)/100.,T0(K)-273.16,Q0(K)*1000.,          &amp;<a name='2087'></font>
<font color=#447700>!                    U0(K),V0(K),W0AVG1D(K),dp(k)/100.,tke(k)<a name='2088'></font>
            WRITE(98,4456)P0(K)/100.,T0(K)-273.16,Q0(K)*1000.,          &amp;<a name='2089'>
                     U0(K),V0(K),W0AVG1D(K),dp(k)/100.,tke(k)<a name='2090'>
 311        CONTINUE<a name='2091'>
<font color=#447700>!           call flush(98)<a name='2092'></font>
<a name='2093'>
<font color=#447700>!        GOTO 297<a name='2094'></font>
<font color=#447700>!         STOP 'QVERR'<a name='2095'></font>
      ENDIF<a name='2096'>
 1115 FORMAT (2X,F7.2,2X,F5.1,2X,F6.3,2(2X,F5.1),2X,F7.2,2X,F7.4)<a name='2097'>
 4456  format(8f12.3)<a name='2098'>
        IF(PPTFLX.GT.0.)THEN<a name='2099'>
          RELERR=ERR2*QINIT/(PPTFLX*TIMEC)<a name='2100'>
        ELSE<a name='2101'>
          RELERR=0.<a name='2102'>
        ENDIF<a name='2103'>
     IF(IPRNT)THEN<a name='2104'>
        WRITE(98,1120)RELERR<a name='2105'>
        WRITE(98,*)'TDER, CPR, TRPPT =',              &amp;<a name='2106'>
          TDER,CPR*AINC,TRPPT*AINC<a name='2107'>
     ENDIF<a name='2108'>
<font color=#447700>!     <a name='2109'></font>
<font color=#447700>!...FEEDBACK TO RESOLVABLE SCALE TENDENCIES.<a name='2110'></font>
<font color=#447700>!     <a name='2111'></font>
<font color=#447700>!...IF THE ADVECTIVE TIME PERIOD (TADVEC) IS LESS THAN SPECIFIED MINIMUM<a name='2112'></font>
<font color=#447700>!...TIMEC, ALLOW FEEDBACK TO OCCUR ONLY DURING TADVEC...<a name='2113'></font>
<font color=#447700>!     <a name='2114'></font>
        IF(TADVEC.LT.TIMEC)NIC=NINT(TADVEC/DT)<a name='2115'>
        NCA(I,J)=FLOAT(NIC)<a name='2116'>
        IF(ISHALL.EQ.1)THEN<a name='2117'>
          TIMEC = 2400.<a name='2118'>
          NCA(I,J) = FLOAT(NTST)<a name='2119'>
          NSHALL = NSHALL+1<a name='2120'>
        ENDIF <a name='2121'>
        DO K=1,KX<a name='2122'>
<font color=#447700>!         IF(IMOIST(INEST).NE.2)THEN<a name='2123'></font>
<font color=#447700>!<a name='2124'></font>
<font color=#447700>!...IF HYDROMETEORS ARE NOT ALLOWED, THEY MUST BE EVAPORATED OR SUBLIMAT<a name='2125'></font>
<font color=#447700>!...AND FED BACK AS VAPOR, ALONG WITH ASSOCIATED CHANGES IN TEMPERATURE.<a name='2126'></font>
<font color=#447700>!...NOTE:  THIS WILL INTRODUCE CHANGES IN THE CONVECTIVE TEMPERATURE AND<a name='2127'></font>
<font color=#447700>!...WATER VAPOR FEEDBACK TENDENCIES AND MAY LEAD TO SUPERSATURATED VALUE<a name='2128'></font>
<font color=#447700>!...OF QG...<a name='2129'></font>
<font color=#447700>!<a name='2130'></font>
<font color=#447700>!           RLC=XLV0-XLV1*TG(K)<a name='2131'></font>
<font color=#447700>!           RLS=XLS0-XLS1*TG(K)<a name='2132'></font>
<font color=#447700>!           CPM=CP*(1.+0.887*QG(K))<a name='2133'></font>
<font color=#447700>!           TG(K)=TG(K)-(RLC*(QLG(K)+QRG(K))+RLS*(QIG(K)+QSG(K)))/CPM<a name='2134'></font>
<font color=#447700>!           QG(K)=QG(K)+(QLG(K)+QRG(K)+QIG(K)+QSG(K))<a name='2135'></font>
<font color=#447700>!           DQLDT(I,J,NK)=0.<a name='2136'></font>
<font color=#447700>!           DQIDT(I,J,NK)=0.<a name='2137'></font>
<font color=#447700>!           DQRDT(I,J,NK)=0.<a name='2138'></font>
<font color=#447700>!           DQSDT(I,J,NK)=0.<a name='2139'></font>
<font color=#447700>!         ELSE<a name='2140'></font>
<font color=#447700>!<a name='2141'></font>
<font color=#447700>!...IF ICE PHASE IS NOT ALLOWED, MELT ALL FROZEN HYDROMETEORS...<a name='2142'></font>
<font color=#447700>!<a name='2143'></font>
          IF(.NOT. F_QI .and. warm_rain)THEN<a name='2144'>
<a name='2145'>
            CPM=CP*(1.+0.887*QG(K))<a name='2146'>
            TG(K)=TG(K)-(QIG(K)+QSG(K))*RLF/CPM<a name='2147'>
            DQCDT(K)=(QLG(K)+QIG(K)-QL0(K)-QI0(K))/TIMEC<a name='2148'>
            DQIDT(K)=0.<a name='2149'>
            DQRDT(K)=(QRG(K)+QSG(K)-QR0(K)-QS0(K))/TIMEC<a name='2150'>
            DQSDT(K)=0.<a name='2151'>
          ELSEIF(.NOT. F_QI .and. .not. warm_rain)THEN<a name='2152'>
<font color=#447700>!<a name='2153'></font>
<font color=#447700>!...IF ICE PHASE IS ALLOWED, BUT MIXED PHASE IS NOT, MELT FROZEN HYDROME<a name='2154'></font>
<font color=#447700>!...BELOW THE MELTING LEVEL, FREEZE LIQUID WATER ABOVE THE MELTING LEVEL<a name='2155'></font>
<font color=#447700>!<a name='2156'></font>
            CPM=CP*(1.+0.887*QG(K))<a name='2157'>
            IF(K.LE.ML)THEN<a name='2158'>
              TG(K)=TG(K)-(QIG(K)+QSG(K))*RLF/CPM<a name='2159'>
            ELSEIF(K.GT.ML)THEN<a name='2160'>
              TG(K)=TG(K)+(QLG(K)+QRG(K))*RLF/CPM<a name='2161'>
            ENDIF<a name='2162'>
            DQCDT(K)=(QLG(K)+QIG(K)-QL0(K)-QI0(K))/TIMEC<a name='2163'>
            DQIDT(K)=0.<a name='2164'>
            DQRDT(K)=(QRG(K)+QSG(K)-QR0(K)-QS0(K))/TIMEC<a name='2165'>
            DQSDT(K)=0.<a name='2166'>
          ELSEIF(F_QI) THEN<a name='2167'>
<font color=#447700>!<a name='2168'></font>
<font color=#447700>!...IF MIXED PHASE HYDROMETEORS ARE ALLOWED, FEED BACK CONVECTIVE TENDEN<a name='2169'></font>
<font color=#447700>!...OF HYDROMETEORS DIRECTLY...<a name='2170'></font>
<font color=#447700>!<a name='2171'></font>
            DQCDT(K)=(QLG(K)-QL0(K))/TIMEC<a name='2172'>
            DQIDT(K)=(QIG(K)-QI0(K))/TIMEC<a name='2173'>
            DQRDT(K)=(QRG(K)-QR0(K))/TIMEC<a name='2174'>
            IF (F_QS) THEN<a name='2175'>
               DQSDT(K)=(QSG(K)-QS0(K))/TIMEC<a name='2176'>
            ELSE<a name='2177'>
               DQIDT(K)=DQIDT(K)+(QSG(K)-QS0(K))/TIMEC<a name='2178'>
            ENDIF<a name='2179'>
          ELSE<a name='2180'>
<font color=#447700>!              PRINT *,'THIS COMBINATION OF IMOIST, IEXICE, IICE NOT ALLOWED!'<a name='2181'></font>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_145"> ( 'KAIN-FRITSCH, THIS COMBINATION OF IMOIST, IEXICE, IICE NOT ALLOWED' )<a name='2182'>
          ENDIF<a name='2183'>
          DTDT(K)=(TG(K)-T0(K))/TIMEC<a name='2184'>
          DQDT(K)=(QG(K)-Q0(K))/TIMEC<a name='2185'>
        ENDDO<a name='2186'>
        RAINCV(I,J)=DT*PPTFLX*(1.-FBFRC)/DXSQ     <font color=#447700>!  PPT FB MODS<a name='2187'></font>
<font color=#447700>!        RAINCV(I,J)=.1*.5*DT*PPTFLX/DXSQ               !  PPT FB MODS<a name='2188'></font>
<font color=#447700>!         RNC=0.1*TIMEC*PPTFLX/DXSQ<a name='2189'></font>
        RNC=RAINCV(I,J)*NIC<a name='2190'>
 909     FORMAT('AT I, J =',i3,1x,i3,' CONVECTIVE RAINFALL =',F8.4,' mm')<a name='2191'>
<font color=#447700>!      write (98,909)I,J,RNC<a name='2192'></font>
<font color=#447700>!      write (6,909)I,J,RNC<a name='2193'></font>
<font color=#447700>!      WRITE(98,*)'at NTSD =',NTSD,',No. of KF points activated =',<a name='2194'></font>
<font color=#447700>!     *            NCCNT<a name='2195'></font>
<font color=#447700>!      call flush(98)<a name='2196'></font>
1000  FORMAT(' ',10A8)<a name='2197'>
1005  FORMAT(' ',F6.0,2X,F6.4,2X,F7.3,1X,F6.4,2X,4(F6.3,2X),2(F7.3,1X))<a name='2198'>
1010  FORMAT(' ',' VERTICAL VELOCITY IS NEGATIVE AT ',F4.0,' MB')<a name='2199'>
1015   FORMAT(' ','ALL REMAINING MASS DETRAINS BELOW ',F4.0,' MB')<a name='2200'>
1025   FORMAT(5X,' KLCL=',I2,' ZLCL=',F7.1,'M',                         &amp;<a name='2201'>
        ' DTLCL=',F5.2,' LTOP=',I2,' P0(LTOP)=',-2PF5.1,'MB FRZ LV=',   &amp;<a name='2202'>
        I2,' TMIX=',0PF4.1,1X,'PMIX=',-2PF6.1,' QMIX=',3PF5.1,          &amp;<a name='2203'>
        ' CAPE=',0PF7.1)<a name='2204'>
1030   FORMAT(' ',' P0(LET) = ',F6.1,' P0(LTOP) = ',F6.1,' VMFLCL =',   &amp;<a name='2205'>
      E12.3,' PLCL =',F6.1,' WLCL =',F6.3,' CLDHGT =',                  &amp;<a name='2206'>
      F8.1)<a name='2207'>
1035  FORMAT(1X,'PEF(WS)=',F4.2,'(CB)=',F4.2,'LC,LET=',2I3,'WKL='       &amp;<a name='2208'>
      ,F6.3,'VWS=',F5.2)<a name='2209'>
<font color=#447700>!1055  FORMAT('*** DEGREE OF STABILIZATION =',F5.3,                  &amp;<a name='2210'></font>
<font color=#447700>!      ', NO MORE MASS FLUX IS ALLOWED!')<a name='2211'></font>
<font color=#447700>!1060     FORMAT(' ITERATION DOES NOT CONVERGE TO GIVE THE SPECIFIED    &amp;<a name='2212'></font>
<font color=#447700>!      &amp;DEGREE OF STABILIZATION!  FABE= ',F6.4) <a name='2213'></font>
 1070 FORMAT (16A8) <a name='2214'>
 1075 FORMAT (F8.2,3(F8.2),2(F8.3),F8.2,2F8.3,F8.2,6F8.3) <a name='2215'>
 1080 FORMAT(2X,'LFS,LDB,LDT =',3I3,' TIMEC, TADVEC, NSTEP=',           &amp;<a name='2216'>
              2(1X,F5.0),I3,'NCOUNT, FABE, AINC=',I2,1X,F5.3,F6.2) <a name='2217'>
 1085 FORMAT (A3,16A7,2A8) <a name='2218'>
 1090 FORMAT (I3,F7.2,F7.0,10F7.2,4F7.3,2F8.3) <a name='2219'>
 1095 FORMAT(' ','  PPT PRODUCTION RATE= ',F10.0,' TOTAL EVAP+PPT= ',F10.0)<a name='2220'>
1105   FORMAT(' ','NET LATENT HEAT RELEASE =',E12.5,' ACTUAL HEATING =',&amp;<a name='2221'>
       E12.5,' J/KG-S, DIFFERENCE = ',F9.3,'%')<a name='2222'>
1110   FORMAT(' ','INITIAL WATER =',E12.5,' FINAL WATER =',E12.5,       &amp;<a name='2223'>
       ' TOTAL WATER CHANGE =',F8.2,'%')<a name='2224'>
<font color=#447700>! 1115 FORMAT (2X,F6.0,2X,F7.2,2X,F5.1,2X,F6.3,2(2X,F5.1),2X,F7.2,2X,F7.4)<a name='2225'></font>
1120   FORMAT(' ','MOISTURE ERROR AS FUNCTION OF TOTAL PPT =',F9.3,'%')<a name='2226'>
<font color=#447700>!<a name='2227'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2228'></font>
<font color=#447700>!--------------SAVE CLOUD TOP AND BOTTOM FOR RADIATION------------------<a name='2229'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2230'></font>
<font color=#447700>!<a name='2231'></font>
      CUTOP(I,J)=REAL(LTOP)<a name='2232'>
      CUBOT(I,J)=REAL(LCL)<a name='2233'>
<font color=#447700>!<a name='2234'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2235'></font>
   END SUBROUTINE  KF_eta_PARA<a name='2236'>
<font color=#447700>!********************************************************************<a name='2237'></font>
<font color=#447700>! ***********************************************************************<a name='2238'></font>
<A NAME='TPMIX2'><A href='../../html_code/phys/module_cu_kfeta.F.html#TPMIX2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2239'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>TPMIX2</font>(p,thes,tu,qu,qliq,qice,qnewlq,qnewic,XLV1,XLV0) <A href='../../call_to/TPMIX2.html' TARGET='index'>3</A><a name='2240'>
<font color=#447700>!<a name='2241'></font>
<font color=#447700>! Lookup table variables:<a name='2242'></font>
<font color=#447700>!     INTEGER, PARAMETER :: (KFNT=250,KFNP=220)<a name='2243'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNT,1:KFNP) :: TTAB,QSTAB<a name='2244'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNP) :: THE0K<a name='2245'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:200) :: ALU<a name='2246'></font>
<font color=#447700>!     REAL, SAVE :: RDPR,RDTHK,PLUTOP<a name='2247'></font>
<font color=#447700>! End of Lookup table variables:<a name='2248'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2249'></font>
   IMPLICIT NONE<a name='2250'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2251'></font>
   REAL,         INTENT(IN   )   :: P,THES,XLV1,XLV0<a name='2252'>
   REAL,         INTENT(OUT  )   :: QNEWLQ,QNEWIC<a name='2253'>
   REAL,         INTENT(INOUT)   :: TU,QU,QLIQ,QICE<a name='2254'>
   REAL    ::    TP,QQ,BTH,TTH,PP,T00,T10,T01,T11,Q00,Q10,Q01,Q11,          &amp;<a name='2255'>
                 TEMP,QS,QNEW,DQ,QTOT,RLL,CPP<a name='2256'>
   INTEGER ::    IPTB,ITHTB<a name='2257'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2258'></font>
<a name='2259'>
<font color=#447700>!c******** LOOKUP TABLE VARIABLES... ****************************<a name='2260'></font>
<font color=#447700>!      parameter(kfnt=250,kfnp=220)<a name='2261'></font>
<font color=#447700>!c<a name='2262'></font>
<font color=#447700>!      COMMON/KFLUT/ ttab(kfnt,kfnp),qstab(kfnt,kfnp),the0k(kfnp),<a name='2263'></font>
<font color=#447700>!     *              alu(200),rdpr,rdthk,plutop <a name='2264'></font>
<font color=#447700>!C*************************************************************** <a name='2265'></font>
<font color=#447700>!c<a name='2266'></font>
<font color=#447700>!c***********************************************************************<a name='2267'></font>
<font color=#447700>!c     scaling pressure and tt table index                         <a name='2268'></font>
<font color=#447700>!c***********************************************************************<a name='2269'></font>
<font color=#447700>!c<a name='2270'></font>
      tp=(p-plutop)*rdpr<a name='2271'>
      qq=tp-aint(tp)<a name='2272'>
      iptb=int(tp)+1<a name='2273'>
<a name='2274'>
<font color=#447700>!<a name='2275'></font>
<font color=#447700>!***********************************************************************<a name='2276'></font>
<font color=#447700>!              base and scaling factor for the                           <a name='2277'></font>
<font color=#447700>!***********************************************************************<a name='2278'></font>
<font color=#447700>!<a name='2279'></font>
<font color=#447700>!  scaling the and tt table index                                        <a name='2280'></font>
      bth=(the0k(iptb+1)-the0k(iptb))*qq+the0k(iptb)<a name='2281'>
      tth=(thes-bth)*rdthk<a name='2282'>
      pp   =tth-aint(tth)<a name='2283'>
      ithtb=int(tth)+1<a name='2284'>
       IF(IPTB.GE.220 .OR. IPTB.LE.1 .OR. ITHTB.GE.250 .OR. ITHTB.LE.1)THEN<a name='2285'>
         write(98,*)'**** OUT OF BOUNDS *********'<a name='2286'>
<font color=#447700>!        call flush(98)<a name='2287'></font>
       ENDIF<a name='2288'>
<font color=#447700>!<a name='2289'></font>
      t00=ttab(ithtb  ,iptb  )<a name='2290'>
      t10=ttab(ithtb+1,iptb  )<a name='2291'>
      t01=ttab(ithtb  ,iptb+1)<a name='2292'>
      t11=ttab(ithtb+1,iptb+1)<a name='2293'>
<font color=#447700>!<a name='2294'></font>
      q00=qstab(ithtb  ,iptb  )<a name='2295'>
      q10=qstab(ithtb+1,iptb  )<a name='2296'>
      q01=qstab(ithtb  ,iptb+1)<a name='2297'>
      q11=qstab(ithtb+1,iptb+1)<a name='2298'>
<font color=#447700>!<a name='2299'></font>
<font color=#447700>!***********************************************************************<a name='2300'></font>
<font color=#447700>!              parcel temperature                                        <a name='2301'></font>
<font color=#447700>!***********************************************************************<a name='2302'></font>
<font color=#447700>!<a name='2303'></font>
      temp=(t00+(t10-t00)*pp+(t01-t00)*qq+(t00-t10-t01+t11)*pp*qq)<a name='2304'>
<font color=#447700>!<a name='2305'></font>
      qs=(q00+(q10-q00)*pp+(q01-q00)*qq+(q00-q10-q01+q11)*pp*qq)<a name='2306'>
<font color=#447700>!<a name='2307'></font>
      DQ=QS-QU<a name='2308'>
      IF(DQ.LE.0.)THEN<a name='2309'>
        QNEW=QU-QS<a name='2310'>
        QU=QS<a name='2311'>
      ELSE <a name='2312'>
<font color=#447700>!<a name='2313'></font>
<font color=#447700>!   IF THE PARCEL IS SUBSATURATED, TEMPERATURE AND MIXING RATIO MUST BE<a name='2314'></font>
<font color=#447700>!   ADJUSTED...IF LIQUID WATER IS PRESENT, IT IS ALLOWED TO EVAPORATE<a name='2315'></font>
<font color=#447700>! <a name='2316'></font>
        QNEW=0.<a name='2317'>
        QTOT=QLIQ+QICE<a name='2318'>
<font color=#447700>!<a name='2319'></font>
<font color=#447700>!   IF THERE IS ENOUGH LIQUID OR ICE TO SATURATE THE PARCEL, TEMP STAYS AT ITS<a name='2320'></font>
<font color=#447700>!   WET BULB VALUE, VAPOR MIXING RATIO IS AT SATURATED LEVEL, AND THE MIXING<a name='2321'></font>
<font color=#447700>!   RATIOS OF LIQUID AND ICE ARE ADJUSTED TO MAKE UP THE ORIGINAL SATURATION<a name='2322'></font>
<font color=#447700>!   DEFICIT... OTHERWISE, ANY AVAILABLE LIQ OR ICE VAPORIZES AND APPROPRIATE<a name='2323'></font>
<font color=#447700>!   ADJUSTMENTS TO PARCEL TEMP; VAPOR, LIQUID, AND ICE MIXING RATIOS ARE MADE.<a name='2324'></font>
<font color=#447700>!<a name='2325'></font>
<font color=#447700>!...subsaturated values only occur in calculations involving various mixtures of<a name='2326'></font>
<font color=#447700>!...updraft and environmental air for estimation of entrainment and detrainment.<a name='2327'></font>
<font color=#447700>!...For these purposes, assume that reasonable estimates can be given using <a name='2328'></font>
<font color=#447700>!...liquid water saturation calculations only - i.e., ignore the effect of the<a name='2329'></font>
<font color=#447700>!...ice phase in this process only...will not affect conservative properties...<a name='2330'></font>
<font color=#447700>!<a name='2331'></font>
        IF(QTOT.GE.DQ)THEN<a name='2332'>
          qliq=qliq-dq*qliq/(qtot+1.e-10)<a name='2333'>
          qice=qice-dq*qice/(qtot+1.e-10)<a name='2334'>
          QU=QS<a name='2335'>
        ELSE<a name='2336'>
          RLL=XLV0-XLV1*TEMP<a name='2337'>
          CPP=1004.5*(1.+0.89*QU)<a name='2338'>
          IF(QTOT.LT.1.E-10)THEN<a name='2339'>
<font color=#447700>!<a name='2340'></font>
<font color=#447700>!...IF NO LIQUID WATER OR ICE IS AVAILABLE, TEMPERATURE IS GIVEN BY:<a name='2341'></font>
            TEMP=TEMP+RLL*(DQ/(1.+DQ))/CPP<a name='2342'>
          ELSE<a name='2343'>
<font color=#447700>!<a name='2344'></font>
<font color=#447700>!...IF SOME LIQ WATER/ICE IS AVAILABLE, BUT NOT ENOUGH TO ACHIEVE SATURATION,<a name='2345'></font>
<font color=#447700>!   THE TEMPERATURE IS GIVEN BY:<a name='2346'></font>
<font color=#447700>!<a name='2347'></font>
            TEMP=TEMP+RLL*((DQ-QTOT)/(1+DQ-QTOT))/CPP<a name='2348'>
            QU=QU+QTOT<a name='2349'>
            QTOT=0.<a name='2350'>
            QLIQ=0.<a name='2351'>
            QICE=0.<a name='2352'>
          ENDIF<a name='2353'>
        ENDIF<a name='2354'>
      ENDIF<a name='2355'>
      TU=TEMP<a name='2356'>
      qnewlq=qnew<a name='2357'>
      qnewic=0.<a name='2358'>
<font color=#447700>!<a name='2359'></font>
   END SUBROUTINE TPMIX2<a name='2360'>
<font color=#447700>!******************************************************************************<a name='2361'></font>
<A NAME='DTFRZNEW'><A href='../../html_code/phys/module_cu_kfeta.F.html#DTFRZNEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2362'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>DTFRZNEW</font>(TU,P,THTEU,QU,QFRZ,QICE,ALIQ,BLIQ,CLIQ,DLIQ) <A href='../../call_to/DTFRZNEW.html' TARGET='index'>2</A><a name='2363'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2364'></font>
   IMPLICIT NONE<a name='2365'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2366'></font>
   REAL,         INTENT(IN   )   :: P,QFRZ,ALIQ,BLIQ,CLIQ,DLIQ<a name='2367'>
   REAL,         INTENT(INOUT)   :: TU,THTEU,QU,QICE<a name='2368'>
   REAL    ::    RLC,RLS,RLF,CPP,A,DTFRZ,ES,QS,DQEVAP,PII<a name='2369'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2370'></font>
<font color=#447700>!<a name='2371'></font>
<font color=#447700>!...ALLOW THE FREEZING OF LIQUID WATER IN THE UPDRAFT TO PROCEED AS AN <a name='2372'></font>
<font color=#447700>!...APPROXIMATELY LINEAR FUNCTION OF TEMPERATURE IN THE TEMPERATURE RANGE <a name='2373'></font>
<font color=#447700>!...TTFRZ TO TBFRZ...<a name='2374'></font>
<font color=#447700>!...FOR COLDER TERMPERATURES, FREEZE ALL LIQUID WATER...<a name='2375'></font>
<font color=#447700>!...THERMODYNAMIC PROPERTIES ARE STILL CALCULATED WITH RESPECT TO LIQUID WATER<a name='2376'></font>
<font color=#447700>!...TO ALLOW THE USE OF LOOKUP TABLE TO EXTRACT TMP FROM THETAE...<a name='2377'></font>
<font color=#447700>!<a name='2378'></font>
      RLC=2.5E6-2369.276*(TU-273.16)<a name='2379'>
      RLS=2833922.-259.532*(TU-273.16)<a name='2380'>
      RLF=RLS-RLC<a name='2381'>
      CPP=1004.5*(1.+0.89*QU)<a name='2382'>
<font color=#447700>!<a name='2383'></font>
<font color=#447700>!  A = D(es)/DT IS THAT CALCULATED FROM BUCK (1981) EMPERICAL FORMULAS<a name='2384'></font>
<font color=#447700>!  FOR SATURATION VAPOR PRESSURE...<a name='2385'></font>
<font color=#447700>!<a name='2386'></font>
      A=(CLIQ-BLIQ*DLIQ)/((TU-DLIQ)*(TU-DLIQ))<a name='2387'>
      DTFRZ = RLF*QFRZ/(CPP+RLS*QU*A)<a name='2388'>
      TU = TU+DTFRZ<a name='2389'>
      <a name='2390'>
      ES = ALIQ*EXP((BLIQ*TU-CLIQ)/(TU-DLIQ))<a name='2391'>
      QS = ES*0.622/(P-ES)<a name='2392'>
<font color=#447700>!<a name='2393'></font>
<font color=#447700>!...FREEZING WARMS THE AIR AND IT BECOMES UNSATURATED...ASSUME THAT SOME OF THE <a name='2394'></font>
<font color=#447700>!...LIQUID WATER THAT IS AVAILABLE FOR FREEZING EVAPORATES TO MAINTAIN SATURA-<a name='2395'></font>
<font color=#447700>!...TION...SINCE THIS WATER HAS ALREADY BEEN TRANSFERRED TO THE ICE CATEGORY,<a name='2396'></font>
<font color=#447700>!...SUBTRACT IT FROM ICE CONCENTRATION, THEN SET UPDRAFT MIXING RATIO AT THE NEW<a name='2397'></font>
<font color=#447700>!...TEMPERATURE TO THE SATURATION VALUE...<a name='2398'></font>
<font color=#447700>!<a name='2399'></font>
      DQEVAP = QS-QU<a name='2400'>
      QICE = QICE-DQEVAP<a name='2401'>
      QU = QU+DQEVAP<a name='2402'>
      PII=(1.E5/P)**(0.2854*(1.-0.28*QU))<a name='2403'>
      THTEU=TU*PII*EXP((3374.6525/TU-2.5403)*QU*(1.+0.81*QU))<a name='2404'>
<font color=#447700>!<a name='2405'></font>
   END SUBROUTINE DTFRZNEW<a name='2406'>
<font color=#447700>! --------------------------------------------------------------------------------<a name='2407'></font>
<a name='2408'>
<A NAME='CONDLOAD'><A href='../../html_code/phys/module_cu_kfeta.F.html#CONDLOAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2409'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CONDLOAD</font>(QLIQ,QICE,WTW,DZ,BOTERM,ENTERM,RATE,QNEWLQ,           &amp; <A href='../../call_to/CONDLOAD.html' TARGET='index'>2</A><a name='2410'>
                          QNEWIC,QLQOUT,QICOUT,G)<a name='2411'>
<a name='2412'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2413'></font>
   IMPLICIT NONE<a name='2414'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2415'></font>
<font color=#447700>!  9/18/88...THIS PRECIPITATION FALLOUT SCHEME IS BASED ON THE SCHEME US<a name='2416'></font>
<font color=#447700>!  BY OGURA AND CHO (1973).  LIQUID WATER FALLOUT FROM A PARCEL IS CAL-<a name='2417'></font>
<font color=#447700>!  CULATED USING THE EQUATION DQ=-RATE*Q*DT, BUT TO SIMULATE A QUASI-<a name='2418'></font>
<font color=#447700>!  CONTINUOUS PROCESS, AND TO ELIMINATE A DEPENDENCY ON VERTICAL<a name='2419'></font>
<font color=#447700>!  RESOLUTION THIS IS EXPRESSED AS Q=Q*EXP(-RATE*DZ).<a name='2420'></font>
<a name='2421'>
      REAL, INTENT(IN   )   :: G<a name='2422'>
      REAL, INTENT(IN   )   :: DZ,BOTERM,ENTERM,RATE<a name='2423'>
      REAL, INTENT(INOUT)   :: QLQOUT,QICOUT,WTW,QLIQ,QICE,QNEWLQ,QNEWIC<a name='2424'>
      REAL :: QTOT,QNEW,QEST,G1,WAVG,CONV,RATIO3,OLDQ,RATIO4,DQ,PPTDRG<a name='2425'>
<a name='2426'>
<font color=#447700>!<a name='2427'></font>
<font color=#447700>!  9/18/88...THIS PRECIPITATION FALLOUT SCHEME IS BASED ON THE SCHEME US<a name='2428'></font>
<font color=#447700>!  BY OGURA AND CHO (1973).  LIQUID WATER FALLOUT FROM A PARCEL IS CAL- <a name='2429'></font>
<font color=#447700>!  CULATED USING THE EQUATION DQ=-RATE*Q*DT, BUT TO SIMULATE A QUASI-   <a name='2430'></font>
<font color=#447700>!  CONTINUOUS PROCESS, AND TO ELIMINATE A DEPENDENCY ON VERTICAL        <a name='2431'></font>
<font color=#447700>!  RESOLUTION THIS IS EXPRESSED AS Q=Q*EXP(-RATE*DZ).                   <a name='2432'></font>
      QTOT=QLIQ+QICE                                                    <a name='2433'>
      QNEW=QNEWLQ+QNEWIC                                                <a name='2434'>
<font color=#447700>!                                                                       <a name='2435'></font>
<font color=#447700>!  ESTIMATE THE VERTICAL VELOCITY SO THAT AN AVERAGE VERTICAL VELOCITY <a name='2436'></font>
<font color=#447700>!  BE CALCULATED TO ESTIMATE THE TIME REQUIRED FOR ASCENT BETWEEN MODEL <a name='2437'></font>
<font color=#447700>!  LEVELS...                                                            <a name='2438'></font>
<font color=#447700>!                                                                       <a name='2439'></font>
      QEST=0.5*(QTOT+QNEW)                                              <a name='2440'>
      G1=WTW+BOTERM-ENTERM-2.*G*DZ*QEST/1.5                             <a name='2441'>
      IF(G1.LT.0.0)G1=0.                                                <a name='2442'>
      WAVG=0.5*(SQRT(WTW)+SQRT(G1))                                      <a name='2443'>
      CONV=RATE*DZ/WAVG                                                 <a name='2444'>
<font color=#447700>!                                                                       <a name='2445'></font>
<font color=#447700>!  RATIO3 IS THE FRACTION OF LIQUID WATER IN FRESH CONDENSATE, RATIO4 IS<a name='2446'></font>
<font color=#447700>!  THE FRACTION OF LIQUID WATER IN THE TOTAL AMOUNT OF CONDENSATE INVOLV<a name='2447'></font>
<font color=#447700>!  IN THE PRECIPITATION PROCESS - NOTE THAT ONLY 60% OF THE FRESH CONDEN<a name='2448'></font>
<font color=#447700>!  SATE IS IS ALLOWED TO PARTICIPATE IN THE CONVERSION PROCESS...       <a name='2449'></font>
<font color=#447700>!                                                                       <a name='2450'></font>
      RATIO3=QNEWLQ/(QNEW+1.E-8)                                       <a name='2451'>
<font color=#447700>!     OLDQ=QTOT                                                         <a name='2452'></font>
      QTOT=QTOT+0.6*QNEW                                                <a name='2453'>
      OLDQ=QTOT                                                         <a name='2454'>
      RATIO4=(0.6*QNEWLQ+QLIQ)/(QTOT+1.E-8)                            <a name='2455'>
      QTOT=QTOT*EXP(-CONV)                                              <a name='2456'>
<font color=#447700>!                                                                       <a name='2457'></font>
<font color=#447700>!  DETERMINE THE AMOUNT OF PRECIPITATION THAT FALLS OUT OF THE UPDRAFT  <a name='2458'></font>
<font color=#447700>!  PARCEL AT THIS LEVEL...                                              <a name='2459'></font>
<font color=#447700>!                                                                       <a name='2460'></font>
      DQ=OLDQ-QTOT                                                      <a name='2461'>
      QLQOUT=RATIO4*DQ                                                  <a name='2462'>
      QICOUT=(1.-RATIO4)*DQ                                             <a name='2463'>
<font color=#447700>!                                                                       <a name='2464'></font>
<font color=#447700>!  ESTIMATE THE MEAN LOAD OF CONDENSATE ON THE UPDRAFT IN THE LAYER, CAL<a name='2465'></font>
<font color=#447700>!  LATE VERTICAL VELOCITY                                               <a name='2466'></font>
<font color=#447700>!                                                                       <a name='2467'></font>
      PPTDRG=0.5*(OLDQ+QTOT-0.2*QNEW)                                   <a name='2468'>
      WTW=WTW+BOTERM-ENTERM-2.*G*DZ*PPTDRG/1.5                          <a name='2469'>
      IF(ABS(WTW).LT.1.E-4)WTW=1.E-4<a name='2470'>
<font color=#447700>!                                                                       <a name='2471'></font>
<font color=#447700>!  DETERMINE THE NEW LIQUID WATER AND ICE CONCENTRATIONS INCLUDING LOSSE<a name='2472'></font>
<font color=#447700>!  DUE TO PRECIPITATION AND GAINS FROM CONDENSATION...                  <a name='2473'></font>
<font color=#447700>!                                                                       <a name='2474'></font>
      QLIQ=RATIO4*QTOT+RATIO3*0.4*QNEW                                  <a name='2475'>
      QICE=(1.-RATIO4)*QTOT+(1.-RATIO3)*0.4*QNEW                        <a name='2476'>
      QNEWLQ=0.                                                         <a name='2477'>
      QNEWIC=0.                                                         <a name='2478'>
<a name='2479'>
   END SUBROUTINE CONDLOAD<a name='2480'>
<a name='2481'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2482'></font>
<A NAME='PROF5'><A href='../../html_code/phys/module_cu_kfeta.F.html#PROF5' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2483'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>PROF5</font>(EQ,EE,UD)                                         <A href='../../call_to/PROF5.html' TARGET='index'>2</A><a name='2484'>
<font color=#447700>!<a name='2485'></font>
<font color=#447700>!***********************************************************************<a name='2486'></font>
<font color=#447700>!*****    GAUSSIAN TYPE MIXING PROFILE....******************************<a name='2487'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2488'></font>
<font color=#447700>!  THIS SUBROUTINE INTEGRATES THE AREA UNDER THE CURVE IN THE GAUSSIAN  <a name='2489'></font>
<font color=#447700>!  DISTRIBUTION...THE NUMERICAL APPROXIMATION TO THE INTEGRAL IS TAKEN FROM<a name='2490'></font>
<font color=#447700>!  "HANDBOOK OF MATHEMATICAL FUNCTIONS WITH FORMULAS, GRAPHS AND MATHEMATICS TABLES"<a name='2491'></font>
<font color=#447700>!  ED. BY ABRAMOWITZ AND STEGUN, NATL BUREAU OF STANDARDS APPLIED<a name='2492'></font>
<font color=#447700>!  MATHEMATICS SERIES.  JUNE, 1964., MAY, 1968.                         <a name='2493'></font>
<font color=#447700>!                                     JACK KAIN                         <a name='2494'></font>
<font color=#447700>!                                     7/6/89                            <a name='2495'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2496'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2497'></font>
   IMPLICIT NONE<a name='2498'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2499'></font>
   REAL,         INTENT(IN   )   :: EQ<a name='2500'>
   REAL,         INTENT(INOUT)   :: EE,UD<a name='2501'>
   REAL ::       SQRT2P,A1,A2,A3,P,SIGMA,FE,X,Y,EY,E45,T1,T2,C1,C2<a name='2502'>
<a name='2503'>
      DATA SQRT2P,A1,A2,A3,P,SIGMA,FE/2.506628,0.4361836,-0.1201676,       &amp;<a name='2504'>
           0.9372980,0.33267,0.166666667,0.202765151/                        <a name='2505'>
      X=(EQ-0.5)/SIGMA                                                  <a name='2506'>
      Y=6.*EQ-3.                                                        <a name='2507'>
      EY=EXP(Y*Y/(-2))                                                  <a name='2508'>
      E45=EXP(-4.5)                                                     <a name='2509'>
      T2=1./(1.+P*ABS(Y))                                               <a name='2510'>
      T1=0.500498                                                       <a name='2511'>
      C1=A1*T1+A2*T1*T1+A3*T1*T1*T1                                     <a name='2512'>
      C2=A1*T2+A2*T2*T2+A3*T2*T2*T2                                     <a name='2513'>
      IF(Y.GE.0.)THEN                                                   <a name='2514'>
        EE=SIGMA*(0.5*(SQRT2P-E45*C1-EY*C2)+SIGMA*(E45-EY))-E45*EQ*EQ/2.<a name='2515'>
        UD=SIGMA*(0.5*(EY*C2-E45*C1)+SIGMA*(E45-EY))-E45*(0.5+EQ*EQ/2.-    &amp;<a name='2516'>
           EQ)                                                          <a name='2517'>
      ELSE                                                              <a name='2518'>
        EE=SIGMA*(0.5*(EY*C2-E45*C1)+SIGMA*(E45-EY))-E45*EQ*EQ/2.       <a name='2519'>
        UD=SIGMA*(0.5*(SQRT2P-E45*C1-EY*C2)+SIGMA*(E45-EY))-E45*(0.5+EQ*   &amp;<a name='2520'>
           EQ/2.-EQ)                                                    <a name='2521'>
      ENDIF                                                             <a name='2522'>
      EE=EE/FE                                                          <a name='2523'>
      UD=UD/FE                                                          <a name='2524'>
<a name='2525'>
   END SUBROUTINE PROF5<a name='2526'>
<a name='2527'>
<font color=#447700>! ------------------------------------------------------------------------<a name='2528'></font>
<A NAME='TPMIX2DD'><A href='../../html_code/phys/module_cu_kfeta.F.html#TPMIX2DD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2529'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>TPMIX2DD</font>(p,thes,ts,qs) <A href='../../call_to/TPMIX2DD.html' TARGET='index'>4</A><a name='2530'>
<font color=#447700>!<a name='2531'></font>
<font color=#447700>! Lookup table variables:<a name='2532'></font>
<font color=#447700>!     INTEGER, PARAMETER :: (KFNT=250,KFNP=220)<a name='2533'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNT,1:KFNP) :: TTAB,QSTAB<a name='2534'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNP) :: THE0K<a name='2535'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:200) :: ALU<a name='2536'></font>
<font color=#447700>!     REAL, SAVE :: RDPR,RDTHK,PLUTOP<a name='2537'></font>
<font color=#447700>! End of Lookup table variables:<a name='2538'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2539'></font>
   IMPLICIT NONE<a name='2540'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2541'></font>
   REAL,         INTENT(IN   )   :: P,THES<a name='2542'>
   REAL,         INTENT(INOUT)   :: TS,QS<a name='2543'>
   REAL    ::    TP,QQ,BTH,TTH,PP,T00,T10,T01,T11,Q00,Q10,Q01,Q11<a name='2544'>
   INTEGER ::    IPTB,ITHTB<a name='2545'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2546'></font>
<a name='2547'>
<font color=#447700>!<a name='2548'></font>
<font color=#447700>!******** LOOKUP TABLE VARIABLES (F77 format)... ****************************<a name='2549'></font>
<font color=#447700>!     parameter(kfnt=250,kfnp=220)<a name='2550'></font>
<font color=#447700>!<a name='2551'></font>
<font color=#447700>!     COMMON/KFLUT/ ttab(kfnt,kfnp),qstab(kfnt,kfnp),the0k(kfnp),        &amp;<a name='2552'></font>
<font color=#447700>!                   alu(200),rdpr,rdthk,plutop <a name='2553'></font>
<font color=#447700>!*************************************************************** <a name='2554'></font>
<font color=#447700>!<a name='2555'></font>
<font color=#447700>!***********************************************************************<a name='2556'></font>
<font color=#447700>!     scaling pressure and tt table index                         <a name='2557'></font>
<font color=#447700>!***********************************************************************<a name='2558'></font>
<font color=#447700>!<a name='2559'></font>
      tp=(p-plutop)*rdpr<a name='2560'>
      qq=tp-aint(tp)<a name='2561'>
      iptb=int(tp)+1<a name='2562'>
<font color=#447700>!<a name='2563'></font>
<font color=#447700>!***********************************************************************<a name='2564'></font>
<font color=#447700>!              base and scaling factor for the                           <a name='2565'></font>
<font color=#447700>!***********************************************************************<a name='2566'></font>
<font color=#447700>!<a name='2567'></font>
<font color=#447700>!  scaling the and tt table index                                        <a name='2568'></font>
      bth=(the0k(iptb+1)-the0k(iptb))*qq+the0k(iptb)<a name='2569'>
      tth=(thes-bth)*rdthk<a name='2570'>
      pp   =tth-aint(tth)<a name='2571'>
      ithtb=int(tth)+1<a name='2572'>
<font color=#447700>!<a name='2573'></font>
      t00=ttab(ithtb  ,iptb  )<a name='2574'>
      t10=ttab(ithtb+1,iptb  )<a name='2575'>
      t01=ttab(ithtb  ,iptb+1)<a name='2576'>
      t11=ttab(ithtb+1,iptb+1)<a name='2577'>
<font color=#447700>!<a name='2578'></font>
      q00=qstab(ithtb  ,iptb  )<a name='2579'>
      q10=qstab(ithtb+1,iptb  )<a name='2580'>
      q01=qstab(ithtb  ,iptb+1)<a name='2581'>
      q11=qstab(ithtb+1,iptb+1)<a name='2582'>
<font color=#447700>!<a name='2583'></font>
<font color=#447700>!***********************************************************************<a name='2584'></font>
<font color=#447700>!              parcel temperature and saturation mixing ratio                                        <a name='2585'></font>
<font color=#447700>!***********************************************************************<a name='2586'></font>
<font color=#447700>!<a name='2587'></font>
      ts=(t00+(t10-t00)*pp+(t01-t00)*qq+(t00-t10-t01+t11)*pp*qq)<a name='2588'>
<font color=#447700>!<a name='2589'></font>
      qs=(q00+(q10-q00)*pp+(q01-q00)*qq+(q00-q10-q01+q11)*pp*qq)<a name='2590'>
<font color=#447700>!<a name='2591'></font>
   END SUBROUTINE TPMIX2DD<a name='2592'>
<a name='2593'>
<font color=#447700>! -----------------------------------------------------------------------<a name='2594'></font>
<A NAME='ENVIRTHT'><A href='../../html_code/phys/module_cu_kfeta.F.html#ENVIRTHT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2595'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ENVIRTHT</font>(P1,T1,Q1,THT1,ALIQ,BLIQ,CLIQ,DLIQ)                        <A href='../../call_to/ENVIRTHT.html' TARGET='index'>8</A><a name='2596'>
<font color=#447700>!<a name='2597'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2598'></font>
   IMPLICIT NONE<a name='2599'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2600'></font>
   REAL,         INTENT(IN   )   :: P1,T1,Q1,ALIQ,BLIQ,CLIQ,DLIQ<a name='2601'>
   REAL,         INTENT(INOUT)   :: THT1<a name='2602'>
   REAL    ::    EE,TLOG,ASTRT,AINC,A1,TP,VALUE,AINTRP,TDPT,TSAT,THT,      &amp;<a name='2603'>
                 T00,P00,C1,C2,C3,C4,C5<a name='2604'>
   INTEGER ::    INDLU<a name='2605'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2606'></font>
      DATA T00,P00,C1,C2,C3,C4,C5/273.16,1.E5,3374.6525,2.5403,3114.834,   &amp;<a name='2607'>
           0.278296,1.0723E-3/                                          <a name='2608'>
<font color=#447700>!                                                                       <a name='2609'></font>
<font color=#447700>!  CALCULATE ENVIRONMENTAL EQUIVALENT POTENTIAL TEMPERATURE...          <a name='2610'></font>
<font color=#447700>!                                                                       <a name='2611'></font>
<font color=#447700>! NOTE: Calculations for mixed/ice phase no longer used...jsk 8/00<a name='2612'></font>
<font color=#447700>!<a name='2613'></font>
      EE=Q1*P1/(0.622+Q1)                                             <a name='2614'>
<font color=#447700>!     TLOG=ALOG(EE/ALIQ)                                              <a name='2615'></font>
<font color=#447700>! ...calculate LOG term using lookup table...<a name='2616'></font>
<font color=#447700>!<a name='2617'></font>
      astrt=1.e-3<a name='2618'>
      ainc=0.075<a name='2619'>
      a1=ee/aliq<a name='2620'>
      tp=(a1-astrt)/ainc<a name='2621'>
      indlu=int(tp)+1<a name='2622'>
      value=(indlu-1)*ainc+astrt<a name='2623'>
      aintrp=(a1-value)/ainc<a name='2624'>
      tlog=aintrp*alu(indlu+1)+(1-aintrp)*alu(indlu)<a name='2625'>
<font color=#447700>!<a name='2626'></font>
      TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)                               <a name='2627'>
      TSAT=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(T1-T00))*(T1-TDPT) <a name='2628'>
      THT=T1*(P00/P1)**(0.2854*(1.-0.28*Q1))                          <a name='2629'>
      THT1=THT*EXP((C1/TSAT-C2)*Q1*(1.+0.81*Q1))                      <a name='2630'>
<font color=#447700>!<a name='2631'></font>
  END SUBROUTINE ENVIRTHT                                                              <a name='2632'>
<font color=#447700>! ***********************************************************************<a name='2633'></font>
<font color=#447700>!====================================================================<a name='2634'></font>
<A NAME='KF_ETA_INIT'><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2635'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>kf_eta_init</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN,      &amp; <A href='../../call_to/KF_ETA_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/KF_ETA_INIT.html' TARGET='index'>1</A><a name='2636'>
                     RQICUTEN,RQSCUTEN,NCA,W0AVG,P_QI,P_QS,         &amp;<a name='2637'>
                     SVP1,SVP2,SVP3,SVPT0,                          &amp;<a name='2638'>
                     P_FIRST_SCALAR,restart,allowed_to_read,        &amp;<a name='2639'>
                     ids, ide, jds, jde, kds, kde,                  &amp;<a name='2640'>
                     ims, ime, jms, jme, kms, kme,                  &amp;<a name='2641'>
                     its, ite, jts, jte, kts, kte                   )<a name='2642'>
<font color=#447700>!--------------------------------------------------------------------<a name='2643'></font>
   IMPLICIT NONE<a name='2644'>
<font color=#447700>!--------------------------------------------------------------------<a name='2645'></font>
   LOGICAL , INTENT(IN)           ::  restart,allowed_to_read<a name='2646'>
   INTEGER , INTENT(IN)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='2647'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='2648'>
                                      its, ite, jts, jte, kts, kte<a name='2649'>
   INTEGER , INTENT(IN)           ::  P_QI,P_QS,P_FIRST_SCALAR<a name='2650'>
<a name='2651'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='2652'>
                                                          RTHCUTEN, &amp;<a name='2653'>
                                                          RQVCUTEN, &amp;<a name='2654'>
                                                          RQCCUTEN, &amp;<a name='2655'>
                                                          RQRCUTEN, &amp;<a name='2656'>
                                                          RQICUTEN, &amp;<a name='2657'>
                                                          RQSCUTEN<a name='2658'>
<a name='2659'>
   REAL ,   DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) :: W0AVG<a name='2660'>
<a name='2661'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT):: NCA<a name='2662'>
<a name='2663'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='2664'>
   REAL, INTENT(IN)    :: SVP1,SVP2,SVP3,SVPT0<a name='2665'>
<a name='2666'>
   jtf=min0(jte,jde-1)<a name='2667'>
   ktf=min0(kte,kde-1)<a name='2668'>
   itf=min0(ite,ide-1)<a name='2669'>
<a name='2670'>
   IF(.not.restart)THEN<a name='2671'>
<a name='2672'>
      DO j=jts,jtf<a name='2673'>
      DO k=kts,ktf<a name='2674'>
      DO i=its,itf<a name='2675'>
         RTHCUTEN(i,k,j)=0.<a name='2676'>
         RQVCUTEN(i,k,j)=0.<a name='2677'>
         RQCCUTEN(i,k,j)=0.<a name='2678'>
         RQRCUTEN(i,k,j)=0.<a name='2679'>
      ENDDO<a name='2680'>
      ENDDO<a name='2681'>
      ENDDO<a name='2682'>
<a name='2683'>
      IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='2684'>
         DO j=jts,jtf<a name='2685'>
         DO k=kts,ktf<a name='2686'>
         DO i=its,itf<a name='2687'>
            RQICUTEN(i,k,j)=0.<a name='2688'>
         ENDDO<a name='2689'>
         ENDDO<a name='2690'>
         ENDDO<a name='2691'>
      ENDIF<a name='2692'>
<a name='2693'>
      IF (P_QS .ge. P_FIRST_SCALAR) THEN<a name='2694'>
         DO j=jts,jtf<a name='2695'>
         DO k=kts,ktf<a name='2696'>
         DO i=its,itf<a name='2697'>
            RQSCUTEN(i,k,j)=0.<a name='2698'>
         ENDDO<a name='2699'>
         ENDDO<a name='2700'>
         ENDDO<a name='2701'>
      ENDIF<a name='2702'>
<a name='2703'>
      DO j=jts,jtf<a name='2704'>
      DO i=its,itf<a name='2705'>
         NCA(i,j)=-100.<a name='2706'>
      ENDDO<a name='2707'>
      ENDDO<a name='2708'>
<a name='2709'>
      DO j=jts,jtf<a name='2710'>
      DO k=kts,ktf<a name='2711'>
      DO i=its,itf<a name='2712'>
         W0AVG(i,k,j)=0.<a name='2713'>
      ENDDO<a name='2714'>
      ENDDO<a name='2715'>
      ENDDO<a name='2716'>
<a name='2717'>
   endif<a name='2718'>
 <a name='2719'>
   CALL <A href='../../html_code/phys/module_cu_kfeta.F.html#KF_LUTAB'>KF_LUTAB</A><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_ETA_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KF_LUTAB_1">(SVP1,SVP2,SVP3,SVPT0)<a name='2720'>
<a name='2721'>
   END SUBROUTINE kf_eta_init<a name='2722'>
<a name='2723'>
<font color=#447700>!-------------------------------------------------------<a name='2724'></font>
<a name='2725'>
<A NAME='KF_LUTAB'><A href='../../html_code/phys/module_cu_kfeta.F.html#KF_LUTAB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2726'>
      <font color=#993300>subroutine </font><font color=#cc0000>kf_lutab</font>(SVP1,SVP2,SVP3,SVPT0) <A href='../../call_to/KF_LUTAB.html' TARGET='index'>1</A><a name='2727'>
<font color=#447700>!<a name='2728'></font>
<font color=#447700>!  This subroutine is a lookup table.<a name='2729'></font>
<font color=#447700>!  Given a series of series of saturation equivalent potential <a name='2730'></font>
<font color=#447700>!  temperatures, the temperature is calculated.<a name='2731'></font>
<font color=#447700>!<a name='2732'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='2733'></font>
   IMPLICIT NONE<a name='2734'>
<font color=#447700>!--------------------------------------------------------------------<a name='2735'></font>
<font color=#447700>! Lookup table variables<a name='2736'></font>
<font color=#447700>!     INTEGER, SAVE, PARAMETER :: KFNT=250,KFNP=220<a name='2737'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNT,1:KFNP) :: TTAB,QSTAB<a name='2738'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNP) :: THE0K<a name='2739'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:200) :: ALU<a name='2740'></font>
<font color=#447700>!     REAL, SAVE :: RDPR,RDTHK,PLUTOP<a name='2741'></font>
<font color=#447700>! End of Lookup table variables<a name='2742'></font>
<a name='2743'>
     INTEGER :: KP,IT,ITCNT,I<a name='2744'>
     REAL :: DTH,TMIN,TOLER,PBOT,DPR,                               &amp;<a name='2745'>
             TEMP,P,ES,QS,PI,THES,TGUES,THGUES,F0,T1,T0,THGS,F1,DT, &amp;<a name='2746'>
             ASTRT,AINC,A1,THTGS<a name='2747'>
<font color=#447700>!    REAL    :: ALIQ,BLIQ,CLIQ,DLIQ,SVP1,SVP2,SVP3,SVPT0<a name='2748'></font>
     REAL    :: ALIQ,BLIQ,CLIQ,DLIQ<a name='2749'>
     REAL, INTENT(IN)    :: SVP1,SVP2,SVP3,SVPT0<a name='2750'>
<font color=#447700>!<a name='2751'></font>
<font color=#447700>! equivalent potential temperature increment<a name='2752'></font>
      data dth/1./<a name='2753'>
<font color=#447700>! minimum starting temp <a name='2754'></font>
      data tmin/150./<a name='2755'>
<font color=#447700>! tolerance for accuracy of temperature <a name='2756'></font>
      data toler/0.001/<a name='2757'>
<font color=#447700>! top pressure (pascals)<a name='2758'></font>
      plutop=5000.0<a name='2759'>
<font color=#447700>! bottom pressure (pascals)<a name='2760'></font>
      pbot=110000.0<a name='2761'>
<a name='2762'>
      ALIQ = SVP1*1000.<a name='2763'>
      BLIQ = SVP2<a name='2764'>
      CLIQ = SVP2*SVPT0<a name='2765'>
      DLIQ = SVP3<a name='2766'>
<a name='2767'>
<font color=#447700>!<a name='2768'></font>
<font color=#447700>! compute parameters<a name='2769'></font>
<font color=#447700>!<a name='2770'></font>
<font color=#447700>! 1._over_(sat. equiv. theta increment)<a name='2771'></font>
      rdthk=1./dth<a name='2772'>
<font color=#447700>! pressure increment<a name='2773'></font>
<font color=#447700>!<a name='2774'></font>
      DPR=(PBOT-PLUTOP)/REAL(KFNP-1)<a name='2775'>
<font color=#447700>!      dpr=(pbot-plutop)/REAL(kfnp-1)<a name='2776'></font>
<font color=#447700>! 1._over_(pressure increment)<a name='2777'></font>
      rdpr=1./dpr<a name='2778'>
<font color=#447700>! compute the spread of thes<a name='2779'></font>
<font color=#447700>!     thespd=dth*(kfnt-1)<a name='2780'></font>
<font color=#447700>!<a name='2781'></font>
<font color=#447700>! calculate the starting sat. equiv. theta<a name='2782'></font>
<font color=#447700>!<a name='2783'></font>
      temp=tmin <a name='2784'>
      p=plutop-dpr<a name='2785'>
      do kp=1,kfnp<a name='2786'>
        p=p+dpr<a name='2787'>
        es=aliq*exp((bliq*temp-cliq)/(temp-dliq))<a name='2788'>
        qs=0.622*es/(p-es)<a name='2789'>
        pi=(1.e5/p)**(0.2854*(1.-0.28*qs))<a name='2790'>
        the0k(kp)=temp*pi*exp((3374.6525/temp-2.5403)*qs*        &amp;<a name='2791'>
               (1.+0.81*qs))<a name='2792'>
      enddo   <a name='2793'>
<font color=#447700>!<a name='2794'></font>
<font color=#447700>! compute temperatures for each sat. equiv. potential temp.<a name='2795'></font>
<font color=#447700>!<a name='2796'></font>
      p=plutop-dpr<a name='2797'>
      do kp=1,kfnp<a name='2798'>
        thes=the0k(kp)-dth<a name='2799'>
        p=p+dpr<a name='2800'>
        do it=1,kfnt<a name='2801'>
<font color=#447700>! define sat. equiv. pot. temp.<a name='2802'></font>
          thes=thes+dth<a name='2803'>
<font color=#447700>! iterate to find temperature<a name='2804'></font>
<font color=#447700>! find initial guess<a name='2805'></font>
          if(it.eq.1) then<a name='2806'>
            tgues=tmin<a name='2807'>
          else<a name='2808'>
            tgues=ttab(it-1,kp)<a name='2809'>
          endif<a name='2810'>
          es=aliq*exp((bliq*tgues-cliq)/(tgues-dliq))<a name='2811'>
          qs=0.622*es/(p-es)<a name='2812'>
          pi=(1.e5/p)**(0.2854*(1.-0.28*qs))<a name='2813'>
          thgues=tgues*pi*exp((3374.6525/tgues-2.5403)*qs*      &amp;<a name='2814'>
               (1.+0.81*qs))<a name='2815'>
          f0=thgues-thes<a name='2816'>
          t1=tgues-0.5*f0<a name='2817'>
          t0=tgues<a name='2818'>
          itcnt=0<a name='2819'>
<font color=#447700>! iteration loop<a name='2820'></font>
          do itcnt=1,11<a name='2821'>
            es=aliq*exp((bliq*t1-cliq)/(t1-dliq))<a name='2822'>
            qs=0.622*es/(p-es)<a name='2823'>
            pi=(1.e5/p)**(0.2854*(1.-0.28*qs))<a name='2824'>
            thtgs=t1*pi*exp((3374.6525/t1-2.5403)*qs*(1.+0.81*qs))<a name='2825'>
            f1=thtgs-thes<a name='2826'>
            if(abs(f1).lt.toler)then<a name='2827'>
              exit<a name='2828'>
            endif<a name='2829'>
<font color=#447700>!           itcnt=itcnt+1<a name='2830'></font>
            dt=f1*(t1-t0)/(f1-f0)<a name='2831'>
            t0=t1<a name='2832'>
            f0=f1<a name='2833'>
            t1=t1-dt<a name='2834'>
          enddo <a name='2835'>
          ttab(it,kp)=t1 <a name='2836'>
          qstab(it,kp)=qs<a name='2837'>
        enddo<a name='2838'>
      enddo   <a name='2839'>
<font color=#447700>!<a name='2840'></font>
<font color=#447700>! lookup table for tlog(emix/aliq)<a name='2841'></font>
<font color=#447700>!<a name='2842'></font>
<font color=#447700>! set up intial values for lookup tables<a name='2843'></font>
<font color=#447700>!<a name='2844'></font>
       astrt=1.e-3<a name='2845'>
       ainc=0.075<a name='2846'>
<font color=#447700>!<a name='2847'></font>
       a1=astrt-ainc<a name='2848'>
       do i=1,200<a name='2849'>
         a1=a1+ainc<a name='2850'>
         alu(i)=alog(a1)<a name='2851'>
       enddo   <a name='2852'>
<font color=#447700>!<a name='2853'></font>
   END SUBROUTINE KF_LUTAB<a name='2854'>
<a name='2855'>
END MODULE module_cu_kfeta<a name='2856'>
</pre></body></html>