<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#define LSMRUC_DBG_LVL 3000<a name='2'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<A NAME='MODULE_SF_RUCLSM'><A href='../../html_code/phys/module_sf_ruclsm.F.html#MODULE_SF_RUCLSM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_ruclsm</font> <A href='../../call_to/MODULE_SF_RUCLSM.html' TARGET='index'>2</A><a name='6'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#module_sf_ruclsm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_42"><a name='7'>
<a name='8'>
CONTAINS<a name='9'>
<a name='10'>
<font color=#447700>!-----------------------------------------------------------------<a name='11'></font>
<A NAME='LSMRUC'><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='12'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>LSMRUC</font>(                                           &amp; <A href='../../call_to/LSMRUC.html' TARGET='index'>1</A>,<A href='../../call_from/LSMRUC.html' TARGET='index'>4</A><a name='13'>
                   DT,KTAU,NSL,ZS,                               &amp;<a name='14'>
                   RAINBL,SNOW,SNOWC,                            &amp;<a name='15'>
                   Z3D,P8W,T3D,QV3D,QC3D,RHO3D,                  &amp; <font color=#447700>!p8W in [PA]<a name='16'></font>
                   GLW,GSW,EMISS,CHKLOWQ,                         &amp; <a name='17'>
                   FLQC,FLHC,MAVAIL,CANWAT,VEGFRA,ALB,ZNT,       &amp;<a name='18'>
                   QSFC,QSG,QVG,QCG,SOILT1,TSNAV,                &amp;<a name='19'>
                   TBOT,IVGTYP,ISLTYP,XLAND,XICE,                &amp;<a name='20'>
                   CP,G0,LV,STBOLT,                              &amp;<a name='21'>
                   SOILMOIS,SMAVAIL,SMMAX,                       &amp;<a name='22'>
                   TSO,SOILT,HFX,QFX,LH,                         &amp;<a name='23'>
                   SFCRUNOFF,UDRUNOFF,SFCEXC,                    &amp;<a name='24'>
                   SFCEVP,GRDFLX,ACSNOW,                         &amp;<a name='25'>
                   SMFR3D,KEEPFR3DFLAG,                          &amp;<a name='26'>
                   ids,ide, jds,jde, kds,kde,                    &amp;<a name='27'>
                   ims,ime, jms,jme, kms,kme,                    &amp;<a name='28'>
                   its,ite, jts,jte, kts,kte                     )<a name='29'>
<font color=#447700>!-----------------------------------------------------------------<a name='30'></font>
   IMPLICIT NONE<a name='31'>
<font color=#447700>!-----------------------------------------------------------------<a name='32'></font>
<font color=#447700>!<a name='33'></font>
<font color=#447700>!-- DT            time step (second)<a name='34'></font>
<font color=#447700>!        ktau - number of time step<a name='35'></font>
<font color=#447700>!        NSL  - number of soil layers<a name='36'></font>
<font color=#447700>!        NZS  - number of levels in soil<a name='37'></font>
<font color=#447700>!        ZS   - depth of soil levels (m)<a name='38'></font>
<font color=#447700>!-- RAINBL    - accumulated rain in [mm] between the PBL calls<a name='39'></font>
<font color=#447700>!-- RAINNCV         one time step grid scale precipitation (mm/step)<a name='40'></font>
<font color=#447700>!        SNOW - snow water equivalent [mm]<a name='41'></font>
<font color=#447700>!-- SNOWC       flag indicating snow coverage (1 for snow cover)<a name='42'></font>
<font color=#447700>!-- Z3D         heights (m)<a name='43'></font>
<font color=#447700>!-- P8W         3D pressure (Pa)<a name='44'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='45'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='46'></font>
<font color=#447700>!        QC3D - 3D cloud water mixing ratio (Kg/Kg)<a name='47'></font>
<font color=#447700>!       RHO3D - 3D air density (kg/m^3)<a name='48'></font>
<font color=#447700>!-- GLW         downward long wave flux at ground surface (W/m^2)<a name='49'></font>
<font color=#447700>!-- GSW         absorbed short wave flux at ground surface (W/m^2)<a name='50'></font>
<font color=#447700>!-- EMISS       surface emissivity (between 0 and 1)<a name='51'></font>
<font color=#447700>!        FLQC - surface exchange coefficient for moisture (kg/m^2/s)<a name='52'></font>
<font color=#447700>!        FLHC - surface exchange coefficient for heat [W/m^2/s/degreeK]     <a name='53'></font>
<font color=#447700>!      SFCEXC - surface exchange coefficient for heat [m/s]<a name='54'></font>
<font color=#447700>!      CANWAT - CANOPY MOISTURE CONTENT (mm)<a name='55'></font>
<font color=#447700>!      VEGFRA - vegetation fraction (between 0 and 1)<a name='56'></font>
<font color=#447700>!         ALB - surface albedo (between 0 and 1)<a name='57'></font>
<font color=#447700>!         ZNT - roughness length [m]<a name='58'></font>
<font color=#447700>!-- TBOT        soil temperature at lower boundary (K)<a name='59'></font>
<font color=#447700>!      IVGTYP - USGS vegetation type (24 classes)<a name='60'></font>
<font color=#447700>!      ISLTYP - STASGO soil type (16 classes)<a name='61'></font>
<font color=#447700>!-- XLAND       land mask (1 for land, 2 for water)<a name='62'></font>
<font color=#447700>!-- CP          heat capacity at constant pressure for dry air (J/kg/K)<a name='63'></font>
<font color=#447700>!-- G0          acceleration due to gravity (m/s^2)<a name='64'></font>
<font color=#447700>!-- LV          latent heat of melting (J/kg)<a name='65'></font>
<font color=#447700>!-- STBOLT      Stefan-Boltzmann constant (W/m^2/K^4)<a name='66'></font>
<font color=#447700>!    SOILMOIS - soil moisture content (volumetric fraction)<a name='67'></font>
<font color=#447700>!         TSO - soil temp (K)<a name='68'></font>
<font color=#447700>!-- SOILT       surface temperature (K)<a name='69'></font>
<font color=#447700>!-- HFX         upward heat flux at the surface (W/m^2)<a name='70'></font>
<font color=#447700>!-- QFX         upward moisture flux at the surface (kg/m^2/s)<a name='71'></font>
<font color=#447700>!-- LH          upward latent heat flux (W/m^2)<a name='72'></font>
<font color=#447700>!   SFCRUNOFF - ground surface runoff [mm]<a name='73'></font>
<font color=#447700>!    UDRUNOFF - underground runoff<a name='74'></font>
<font color=#447700>!      SFCEVP - total evaporation in [kg/m^2]<a name='75'></font>
<font color=#447700>!      GRDFLX - soil heat flux (W/m^2: negative, if downward from surface)<a name='76'></font>
<font color=#447700>!      ACSNOW - accumulation of snow water [m]   <a name='77'></font>
<font color=#447700>!-- CHKLOWQ - is either 0 or 1 (so far set equal to 1).<a name='78'></font>
<font color=#447700>!--           used only in MYJPBL. <a name='79'></font>
<font color=#447700>!-- ims           start index for i in memory<a name='80'></font>
<font color=#447700>!-- ime           end index for i in memory<a name='81'></font>
<font color=#447700>!-- jms           start index for j in memory<a name='82'></font>
<font color=#447700>!-- jme           end index for j in memory<a name='83'></font>
<font color=#447700>!-- kms           start index for k in memory<a name='84'></font>
<font color=#447700>!-- kme           end index for k in memory<a name='85'></font>
<font color=#447700>!-------------------------------------------------------------------------<a name='86'></font>
<font color=#447700>!   INTEGER,     PARAMETER            ::     nzss=5<a name='87'></font>
<font color=#447700>!   INTEGER,     PARAMETER            ::     nddzs=2*(nzss-2)<a name='88'></font>
<a name='89'>
   INTEGER,     PARAMETER            ::     nvegclas=24<a name='90'>
<a name='91'>
   REAL,       INTENT(IN   )    ::     DT<a name='92'>
   INTEGER,    INTENT(IN   )    ::     ktau, nsl,                 &amp;<a name='93'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='94'>
                                       ids,ide, jds,jde, kds,kde, &amp;<a name='95'>
                                       its,ite, jts,jte, kts,kte<a name='96'>
<a name='97'>
   REAL,    DIMENSION( ims:ime, kms:kme, jms:jme )            , &amp;<a name='98'>
            INTENT(IN   )    ::                           QV3D, &amp;<a name='99'>
                                                          QC3D, &amp;<a name='100'>
                                                           p8w, &amp;<a name='101'>
                                                         rho3D, &amp;<a name='102'>
                                                           T3D, &amp;<a name='103'>
                                                           z3D<a name='104'>
<a name='105'>
   REAL,       DIMENSION( ims:ime , jms:jme ),                   &amp;<a name='106'>
               INTENT(IN   )    ::                       RAINBL, &amp;<a name='107'>
                                                            GLW, &amp;<a name='108'>
                                                            GSW, &amp;<a name='109'>
                                                           FLHC, &amp;<a name='110'>
                                                           FLQC, &amp;<a name='111'>
                                                          EMISS, &amp;<a name='112'>
<font color=#447700>!                                                         MAVAIL, &amp;<a name='113'></font>
                                                           XICE, &amp;<a name='114'>
                                                          XLAND, &amp;<a name='115'>
                                                         VEGFRA, &amp;<a name='116'>
                                                           TBOT<a name='117'>
<a name='118'>
   REAL,       DIMENSION( 1:nsl), INTENT(IN   )      ::      ZS<a name='119'>
<a name='120'>
   REAL,       DIMENSION( ims:ime , jms:jme ),                   &amp;<a name='121'>
               INTENT(INOUT)    ::                               &amp;<a name='122'>
                                                           SNOW, &amp; <font color=#447700>!new<a name='123'></font>
                                                          SNOWC, &amp;<a name='124'>
                                                         CANWAT, &amp; <font color=#447700>! new<a name='125'></font>
                                                            ALB, &amp;<a name='126'>
                                                         MAVAIL, &amp; <a name='127'>
                                                         SFCEXC, &amp;<a name='128'>
                                                            ZNT<a name='129'>
<a name='130'>
   INTEGER,    DIMENSION( ims:ime , jms:jme ),                   &amp;<a name='131'>
               INTENT(IN   )    ::                       IVGTYP, &amp;<a name='132'>
                                                         ISLTYP<a name='133'>
<a name='134'>
   REAL, INTENT(IN   )          ::              CP,G0,LV,STBOLT<a name='135'>
 <a name='136'>
   REAL,       DIMENSION( ims:ime , 1:nsl, jms:jme )           , &amp;<a name='137'>
               INTENT(INOUT)    ::                 SOILMOIS,TSO<a name='138'>
<a name='139'>
   REAL,       DIMENSION( ims:ime, jms:jme )                   , &amp;<a name='140'>
               INTENT(INOUT)    ::                        SOILT, &amp;<a name='141'>
                                                            HFX, &amp;<a name='142'>
                                                            QFX, &amp;<a name='143'>
                                                             LH, &amp;<a name='144'>
                                                         SFCEVP, &amp;<a name='145'>
                                                      SFCRUNOFF, &amp;<a name='146'>
                                                       UDRUNOFF, &amp;<a name='147'>
                                                         GRDFLX, &amp;<a name='148'>
                                                         ACSNOW, &amp;<a name='149'>
                                                            QVG, &amp;<a name='150'>
                                                            QCG, &amp;<a name='151'>
                                                           QSFC, &amp;<a name='152'>
                                                            QSG, &amp;<a name='153'>
                                                        CHKLOWQ, &amp;<a name='154'>
                                                         SOILT1, &amp;<a name='155'>
                                                          TSNAV<a name='156'>
<a name='157'>
   REAL,       DIMENSION( ims:ime, jms:jme )                   , &amp; <a name='158'>
               INTENT(INOUT)    ::                      SMAVAIL, &amp;<a name='159'>
                                                          SMMAX<a name='160'>
<a name='161'>
   REAL,       DIMENSION( its:ite, jts:jte )    ::          DEW, &amp;<a name='162'>
                                                             PC, &amp;<a name='163'>
                                                        RUNOFF1, &amp;<a name='164'>
                                                        RUNOFF2, &amp;<a name='165'>
                                                         EMISSL, &amp;<a name='166'>
                                                           ZNTL, &amp;<a name='167'>
                                                        LMAVAIL, &amp;<a name='168'>
                                                          SMELT, &amp;<a name='169'>
                                                           SNOH, &amp;<a name='170'>
                                                          SNFLX, &amp;<a name='171'>
                                                           SNOM, &amp;<a name='172'>
                                                           EDIR, &amp;<a name='173'>
                                                             EC, &amp;<a name='174'>
                                                            ETT, &amp;<a name='175'>
                                                         SUBLIM, &amp;<a name='176'>
                                                          EVAPL, &amp;<a name='177'>
                                                          PRCPL, &amp;<a name='178'>
                                                        INFILTR<a name='179'>
<a name='180'>
<font color=#447700>!--- soil/snow properties<a name='181'></font>
   REAL,       DIMENSION( ims:ime, 1:nsl, jms:jme)               &amp;<a name='182'>
                                             ::    KEEPFR3DFLAG, &amp;<a name='183'>
                                                         SMFR3D<a name='184'>
<a name='185'>
   REAL                                                          &amp;<a name='186'>
                             ::                           RHOCS, &amp;<a name='187'>
                                                          RHOSN, &amp;<a name='188'>
                                                           BCLH, &amp;<a name='189'>
                                                            DQM, &amp;<a name='190'>
                                                           KSAT, &amp;<a name='191'>
                                                           PSIS, &amp;<a name='192'>
                                                           QMIN, &amp;<a name='193'>
                                                          QWRTZ, &amp;<a name='194'>
                                                            REF, &amp;<a name='195'>
                                                           WILT, &amp;<a name='196'>
                                                        CANWATR, &amp;<a name='197'>
                                                           SNWE<a name='198'>
<a name='199'>
   REAL                                      ::              CN, &amp;<a name='200'>
                                                         SAT,CW, &amp;<a name='201'>
                                                           C1SN, &amp;<a name='202'>
                                                           C2SN, &amp;<a name='203'>
                                                         KQWRTZ, &amp;<a name='204'>
                                                           KICE, &amp;<a name='205'>
                                                            KWT<a name='206'>
<a name='207'>
<a name='208'>
   REAL,     DIMENSION(1:NSL)                ::          ZSMAIN, &amp;<a name='209'>
                                                         ZSHALF, &amp;<a name='210'>
                                                         DTDZS2<a name='211'>
<a name='212'>
   REAL,     DIMENSION(1:2*(nsl-2))          ::           DTDZS<a name='213'>
<a name='214'>
   REAL,     DIMENSION(1:4001)               ::             TBQ<a name='215'>
<a name='216'>
<a name='217'>
   REAL,     DIMENSION( 1:nsl )              ::         SOILM1D, &amp; <a name='218'>
                                                          TSO1D, &amp;<a name='219'>
                                                        SOILICE, &amp;<a name='220'>
                                                        SOILIQW, &amp;<a name='221'>
                                                       SMFRKEEP<a name='222'>
<a name='223'>
   REAL,     DIMENSION( 1:nsl )              ::          KEEPFR<a name='224'>
                                                <a name='225'>
<a name='226'>
   REAL                           ::                        RSM, &amp;<a name='227'>
                                                      SNWEPRINT, &amp;<a name='228'>
                                                     SNHEIPRINT<a name='229'>
<a name='230'>
   REAL                           ::                     PRCPMS, &amp;<a name='231'>
                                                           PATM, &amp;<a name='232'>
                                                           TABS, &amp;<a name='233'>
                                                          QVATM, &amp;<a name='234'>
                                                          QCATM, &amp;<a name='235'>
                                                         CONFLX, &amp;<a name='236'>
                                                            RHO, &amp;<a name='237'>
                                                           QKMS, &amp;<a name='238'>
                                                           TKMS, &amp;<a name='239'>
                                                       INFILTRP<a name='240'>
   REAL      ::  cq,r61,r273,arp,brp,x<a name='241'>
<a name='242'>
   INTEGER   ::  NROOT<a name='243'>
   INTEGER   ::  ILAND,ISOIL<a name='244'>
 <a name='245'>
   INTEGER, DIMENSION ( 1:nvegclas )          ::        IFOREST<a name='246'>
<a name='247'>
   INTEGER   ::  I,J,K,NZS,NZS1,NDDZS<a name='248'>
   INTEGER   ::  k1,l,k2,kp,km<a name='249'>
<a name='250'>
<a name='251'>
<font color=#447700>!-----------------------------------------------------------------<a name='252'></font>
<a name='253'>
         NZS=NSL<a name='254'>
         NDDZS=2*(nzs-2)<a name='255'>
<a name='256'>
<font color=#447700>!---- table TBQ is for resolution of balance equation in VILKA<a name='257'></font>
        CQ=173.15-.05<a name='258'>
        R61=6.1/1.61<a name='259'>
        R273=1./273.15<a name='260'>
        ARP=77455.*41.9/460.<a name='261'>
        BRP=64.*41.9/460.<a name='262'>
        DO K=1,4001<a name='263'>
          CQ=CQ+.05<a name='264'>
          TBQ(K)=R61*EXP(ARP*(R273-1./CQ)-BRP*LOG(CQ*R273))<a name='265'>
        END DO<a name='266'>
<a name='267'>
<font color=#447700>!--- Initialize soil/vegetation parameters<a name='268'></font>
<font color=#447700>!--- This is temporary until SI is added to mass coordinate ---!!!!!<a name='269'></font>
<a name='270'>
     if(ktau.eq.1) then<a name='271'>
     DO J=jts,jte<a name='272'>
         DO i=its,ite<a name='273'>
            do k=1,nsl<a name='274'>
<font color=#447700>!       smfr3d  (i,k,j)=soilmois(i,k,j)/900.*1.e3<a name='275'></font>
       keepfr3dflag(i,k,j)=0.<a name='276'>
            enddo<a name='277'>
<font color=#447700>!--- initializing of snow temp<a name='278'></font>
           soilt1(i,j)=soilt(i,j)<a name='279'>
           tsnav(i,j) =0.5*(soilt(i,j)+tso(i,1,j))-273.<a name='280'>
           qcg  (i,j) =0.<a name='281'>
           patm=P8w(i,kms,j)*1.e-2<a name='282'>
           QSG  (i,j) = <A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN'>QSN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSN_1">(SOILT(i,j),TBQ)/PATM<a name='283'>
           qvg  (i,j) = QSG(i,j)*mavail(i,j)<a name='284'>
<font color=#447700>!           qvg  (i,j) =qv3d(i,kms,j)<a name='285'></font>
           qsfc(i,j) = qvg(i,j)/(1.+qvg(i,j))<a name='286'>
           SMELT(i,j) = 0.<a name='287'>
           SNOM (i,j) = 0.<a name='288'>
           SNFLX(i,j) = 0.<a name='289'>
           DEW  (i,j) = 0.<a name='290'>
           PC   (i,j) = 0.<a name='291'>
           zntl (i,j) = 0.<a name='292'>
           RUNOFF1(i,j) = 0.<a name='293'>
           RUNOFF2(i,j) = 0.<a name='294'>
           emissl (i,j) = 0.<a name='295'>
           lmavail(i,j) = mavail(i,j)<a name='296'>
<font color=#447700>! For RUC LSM CHKLOWQ needed for MYJPBL should <a name='297'></font>
<font color=#447700>! 1 because is actual specific humidity at the surface, and<a name='298'></font>
<font color=#447700>! not the saturation value<a name='299'></font>
           chklowq(i,j) = 1.<a name='300'>
           infiltr(i,j) = 0.<a name='301'>
           snoh  (i,j) = 0.<a name='302'>
           edir  (i,j) = 0.<a name='303'>
           ec    (i,j) = 0.<a name='304'>
           ett   (i,j) = 0.<a name='305'>
           sublim(i,j) = 0.<a name='306'>
           evapl (i,j) = 0.<a name='307'>
           prcpl (i,j) = 0.<a name='308'>
         ENDDO<a name='309'>
     ENDDO<a name='310'>
<a name='311'>
        do k=1,nsl<a name='312'>
           soilice(k)=0.<a name='313'>
           soiliqw(k)=0.<a name='314'>
        enddo<a name='315'>
     endif<a name='316'>
<a name='317'>
<font color=#447700>!-----------------------------------------------------------------<a name='318'></font>
<a name='319'>
        PRCPMS = 0.<a name='320'>
        NROOT  = 4<a name='321'>
<a name='322'>
<a name='323'>
   DO J=jts,jte<a name='324'>
<a name='325'>
      DO i=its,ite<a name='326'>
<a name='327'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='328'>
      print *,' IN LSMRUC ','ims,ime,jms,jme,its,ite,jts,jte,nzs,zsmain,zshalf', &amp;<a name='329'>
                ims,ime,jms,jme,its,ite,jts,jte,nzs,zsmain,zshalf<a name='330'>
      print *,' IVGTYP, ISLTYP ', ivgtyp(i,j),isltyp(i,j)<a name='331'>
      print *,' SOILT,QVG,P8w',soilt(i,j),qvg(i,j),p8w(i,1,j)<a name='332'>
      print *, 'LSMRUC, I,J,xland, QFX,HFX from SFCLAY',i,j,xland(i,j), &amp;<a name='333'>
                  qfx(i,j),hfx(i,j)<a name='334'>
      print *, ' GSW, GLW =',gsw(i,j),glw(i,j)<a name='335'>
      print *, 'SOILT, TSO start of time step =',soilt(i,j),(tso(i,k,j),k=1,nsl)<a name='336'>
      print *, 'SOILMOIS start of time step =',(soilmois(i,k,j),k=1,nsl)<a name='337'>
      print *, 'SMFROZEN start of time step =',(smfr3d(i,k,j),k=1,nsl)<a name='338'>
      print *, ' I,J=, after SFCLAY FLQC,FLHC ',i,j,flqc(i,j),flhc(i,j),mavail(i,j)<a name='339'>
      print *, 'LSMRUC, IVGTYP,ISLTYP,ZNT,ALB = ', ivgtyp(i,j),isltyp(i,j),znt(i,j),alb(i,j)<a name='340'>
      print *, 'LSMRUC  I,J,DT,RAINBL =',I,J,dt,RAINBL(i,j)<a name='341'>
      print *, 'XLAND ----&gt;',xland(i,j)<a name='342'>
    ENDIF<a name='343'>
<a name='344'>
<a name='345'>
         ILAND     = IVGTYP(i,j)<a name='346'>
         ISOIL     = ISLTYP(I,J)<a name='347'>
         TABS      = T3D(i,kms,j)<a name='348'>
         QVATM     = QV3D(i,kms,j)<a name='349'>
         QCATM     = QC3D(i,kms,j)<a name='350'>
         PATM      = P8w(i,kms,j)*1.e-5<a name='351'>
<font color=#447700>!---- what height is the first level?---- check!!!!!<a name='352'></font>
<font color=#447700>!-- need to de-stagger from w levels to P levels<a name='353'></font>
         CONFLX    = Z3D(i,kms,j)<a name='354'>
<font color=#447700>!         CONFLX    = 0.5*Z3D(i,kms,j)<a name='355'></font>
<font color=#447700>!         CONFLX    = 5.<a name='356'></font>
         RHO       = RHO3D(I,kms,J)<a name='357'>
<font color=#447700>!--- 1*e-3 is to convert from mm/s to m/s<a name='358'></font>
         PRCPMS    = RAINBL(i,j)/DT*1.e-3<a name='359'>
<font color=#447700>!--- rooting depth is 5 levels for forests<a name='360'></font>
        if(iforest(ivgtyp(i,j)).eq.1) nroot=5<a name='361'>
<font color=#447700>!--- convert exchange coeff to [m/s]<a name='362'></font>
         QKMS=FLQC(I,J)/RHO/MAVAIL(I,J)<a name='363'>
         TKMS=FLHC(I,J)/RHO/CP<a name='364'>
<font color=#447700>!--- convert incoming snow and canwat from mm to m<a name='365'></font>
         SNWE=SNOW(I,J)*1.E-3<a name='366'>
         CANWATR=CANWAT(I,J)*1.E-3<a name='367'>
<a name='368'>
<font color=#447700>!-----<a name='369'></font>
             zsmain(1)=0.<a name='370'>
             zshalf(1)=0.<a name='371'>
          do k=2,nzs<a name='372'>
             zsmain(k)= zs(k)<a name='373'>
             zshalf(k)=0.5*(zsmain(k-1) + zsmain(k))<a name='374'>
          enddo<a name='375'>
<a name='376'>
<font color=#447700>!-----<a name='377'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='378'>
         print *,' ZS, ZSMAIN, ZSHALF, CONFLX ---&gt;', zs,zsmain,zshalf,conflx<a name='379'>
    ENDIF<a name='380'>
<a name='381'>
<font color=#447700>!------------------------------------------------------------<a name='382'></font>
<font color=#447700>!-----  DDZS and DSDZ1 are for implicit soilution of soil eqns.<a name='383'></font>
<font color=#447700>!-------------------------------------------------------------<a name='384'></font>
        NZS1=NZS-1<a name='385'>
<font color=#447700>!-----<a name='386'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='387'>
         print *,' DT,NZS1, ZSMAIN, ZSHALF ---&gt;', dt,nzs1,zsmain,zshalf<a name='388'>
    ENDIF<a name='389'>
<a name='390'>
        DO  K=2,NZS1<a name='391'>
          K1=2*K-3<a name='392'>
          K2=K1+1<a name='393'>
          X=DT/2./(ZSHALF(K+1)-ZSHALF(K))<a name='394'>
          DTDZS(K1)=X/(ZSMAIN(K)-ZSMAIN(K-1))<a name='395'>
          DTDZS2(K-1)=X<a name='396'>
          DTDZS(K2)=X/(ZSMAIN(K+1)-ZSMAIN(K))<a name='397'>
        END DO<a name='398'>
<a name='399'>
<a name='400'>
        CN=0.5     <font color=#447700>! exponent<a name='401'></font>
        SAT=0.0005   <font color=#447700>! canopy water saturated<a name='402'></font>
<a name='403'>
        CW =4.183E6<a name='404'>
<a name='405'>
<a name='406'>
<font color=#447700>!--- Constants used in Johansen soil thermal<a name='407'></font>
<font color=#447700>!--- conductivity method<a name='408'></font>
<a name='409'>
        KQWRTZ=7.7<a name='410'>
        KICE=2.2<a name='411'>
        KWT=0.57<a name='412'>
<a name='413'>
<font color=#447700>!***********************************************************************<a name='414'></font>
<font color=#447700>!--- Constants for snow density calculations C1SN and C2SN<a name='415'></font>
<a name='416'>
        c1sn=0.01<a name='417'>
        c2sn=21.<a name='418'>
<a name='419'>
<font color=#447700>!***********************************************************************<a name='420'></font>
<a name='421'>
        NROOT= 4<a name='422'>
<font color=#447700>!           ! rooting depth<a name='423'></font>
<a name='424'>
        RHOSN = 200.<a name='425'>
<a name='426'>
<font color=#447700>!--- initializing soil and surface properties<a name='427'></font>
     CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILVEGIN'>SOILVEGIN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILVEGIN_1">  ( ILAND,ISOIL,IFOREST,                     &amp;<a name='428'>
                     EMISSL(I,J),PC(i,j),ZNTL(I,J),QWRTZ,       &amp;<a name='429'>
                     RHOCS,BCLH,DQM,KSAT,PSIS,QMIN,REF,WILT     )<a name='430'>
<a name='431'>
<font color=#447700>!*** SET ZERO-VALUE FOR SOME OUTPUT DIAGNOSTIC ARRAYS<a name='432'></font>
        IF((XLAND(I,J)-1.5).GE.0.)THEN<a name='433'>
<font color=#447700>!-- Water point<a name='434'></font>
           SMAVAIL(I,J)=1.0<a name='435'>
             SMMAX(I,J)=1.0<a name='436'>
              SNOW(I,J)=0.0<a name='437'>
           LMAVAIL(I,J)=1.0<a name='438'>
<a name='439'>
           ILAND=16<a name='440'>
           ISOIL=14<a name='441'>
<a name='442'>
           patm=P8w(i,kms,j)*1.e-2<a name='443'>
           qvg  (i,j) = <A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN'>QSN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSN_2">(SOILT(i,j),TBQ)/PATM<a name='444'>
           qsfc(i,j) = qvg(i,j)/(1.+qvg(i,j))<a name='445'>
           chklowq(i,j) = 1.<a name='446'>
<a name='447'>
            DO K=1,NZS<a name='448'>
              SOILMOIS(I,K,J)=1.0<a name='449'>
              TSO(I,K,J)= SOILT(I,J)<a name='450'>
            ENDDO<a name='451'>
<a name='452'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='453'>
              PRINT*,'  water point, I=',I,                      &amp;<a name='454'>
              'J=',J, 'SOILT=', SOILT(i,j)<a name='455'>
    ENDIF<a name='456'>
         IF(XICE(I,J).EQ.1.)THEN<a name='457'>
<font color=#447700>!-- Sea-ice case<a name='458'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='459'>
              PRINT*,' sea-ice at water point, I=',I,            &amp;<a name='460'>
              'J=',J<a name='461'>
    ENDIF<a name='462'>
            ILAND = 24<a name='463'>
            ISOIL = 16<a name='464'>
<a name='465'>
            SMAVAIL(I,J)=1.0<a name='466'>
            SMMAX(I,J)=1.0<a name='467'>
            SOILT(I,J) = MIN(273.15,SOILT(I,J))<a name='468'>
<a name='469'>
            DO K=1,NZS<a name='470'>
              SOILMOIS(I,K,J)=1.0<a name='471'>
              TSO(I,K,J)= MIN(273.15,SOILT(I,J))<a name='472'>
            ENDDO<a name='473'>
          ENDIF<a name='474'>
<a name='475'>
           ELSE<a name='476'>
<a name='477'>
<font color=#447700>!-- Land point<a name='478'></font>
<a name='479'>
<font color=#447700>!              soilm1d (1) = min(max(0.,soilmois(i,1,j)-qmin(i,j)),dqm(i,j))<a name='480'></font>
<font color=#447700>! soil moisture minus residual is nitialized from RUC background<a name='481'></font>
<a name='482'>
           DO k=1,nzs<a name='483'>
<font color=#447700>!              soilm1d (k) = min(max(0.,soilmois(i,k-1,j)-qmin(i,j)),dqm(i,j))<a name='484'></font>
<font color=#447700>! soil moisture minus residual is nitialized from RUC background<a name='485'></font>
              soilm1d (k) = min(max(0.,soilmois(i,k,j)),dqm)<a name='486'>
              tso1d   (k) = tso(i,k,j)<a name='487'>
           ENDDO <a name='488'>
<a name='489'>
           do k=1,nzs<a name='490'>
              smfrkeep(k) = smfr3d(i,k,j)<a name='491'>
              keepfr  (k) = keepfr3dflag(i,k,j)<a name='492'>
           enddo<a name='493'>
<a name='494'>
              LMAVAIL(I,J)=min(dqm,soilmois(i,1,j))/DQM<a name='495'>
<a name='496'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='497'>
   print *,'LAND, i,j,tso1d,soilm1d,PATM,TABS,QVATM,QCATM,RHO',  &amp;<a name='498'>
                  i,j,tso1d,soilm1d,PATM,TABS,QVATM,QCATM,RHO<a name='499'>
   print *,'CONFLX =',CONFLX <a name='500'>
   print *,'SMFRKEEP,KEEPFR   ',SMFRKEEP,KEEPFR<a name='501'>
    ENDIF<a name='502'>
<a name='503'>
<font color=#447700>!-----------------------------------------------------------------<a name='504'></font>
         CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP'>SFCTMP</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCTMP_1"> (dt,ktau,conflx,i,j,                        &amp;<a name='505'>
<font color=#447700>!--- input variables<a name='506'></font>
                nzs,nddzs,nroot,                                 &amp;<a name='507'>
                iland,isoil,xland(i,j),ivgtyp(i,j),              &amp;  <a name='508'>
                PRCPMS,SNWE,RHOSN,                               &amp;<a name='509'>
                PATM,TABS,QVATM,QCATM,RHO,                       &amp;<a name='510'>
                GLW(I,J),GSW(I,J),EMISSL(I,J),                   &amp;<a name='511'>
                QKMS,TKMS,PC(I,J),LMAVAIL(I,J),                  &amp;<a name='512'>
                canwatr,vegfra(I,J),alb(I,J),znt(I,J),           &amp;<a name='513'>
<font color=#447700>!--- soil fixed fields<a name='514'></font>
                QWRTZ,                                           &amp;<a name='515'>
                rhocs,dqm,qmin,ref,                              &amp;<a name='516'>
                wilt,psis,bclh,ksat,                             &amp;<a name='517'>
                sat,cn,zsmain,zshalf,DTDZS,DTDZS2,tbq,           &amp;<a name='518'>
<font color=#447700>!--- constants<a name='519'></font>
                cp,g0,lv,stbolt,cw,c1sn,c2sn,                    &amp;<a name='520'>
                KQWRTZ,KICE,KWT,                                 &amp;<a name='521'>
<font color=#447700>!--- output variables<a name='522'></font>
                snweprint,snheiprint,rsm,                        &amp;<a name='523'>
                soilm1d,tso1d,smfrkeep,keepfr,                   &amp;<a name='524'>
                soilt(I,J),soilt1(i,j),tsnav(i,j),dew(I,J),      &amp;<a name='525'>
                qvg(I,J),qsg(I,J),qcg(I,J),SMELT(I,J),           &amp;<a name='526'>
                SNOH(I,J),SNFLX(I,J),SNOM(I,J),ACSNOW(I,J),      &amp;<a name='527'>
                edir(I,J),ec(I,J),ett(I,J),sfcevp(I,J),          &amp;<a name='528'>
                qfx(I,J),hfx(I,J),grdflx(I,J),sublim(I,J),       &amp;<a name='529'>
                evapl(I,J),prcpl(I,J),runoff1(I,J),              &amp;<a name='530'>
                runoff2(I,J),soilice,soiliqw,infiltrp)<a name='531'>
<font color=#447700>!-----------------------------------------------------------------<a name='532'></font>
<a name='533'>
<font color=#447700>!***  DIAGNOSTICS<a name='534'></font>
<font color=#447700>!--- available and maximum soil moisture content in the soil<a name='535'></font>
<font color=#447700>!--- domain<a name='536'></font>
        smavail(i,j) = 0.<a name='537'>
        smmax (i,j)  = 0.  <a name='538'>
<a name='539'>
      do k=1,nzs-1<a name='540'>
        smavail(i,j)=smavail(i,j)+(qmin+soilm1d(k))*             &amp;<a name='541'>
                    (zshalf(k+1)-zshalf(k))<a name='542'>
        smmax (i,j) =smmax (i,j)+(qmin+dqm)*                     &amp;<a name='543'>
                    (zshalf(k+1)-zshalf(k))<a name='544'>
      enddo<a name='545'>
<a name='546'>
        smavail(i,j)=smavail(i,j)+(qmin+soilm1d(nzs))*           &amp;<a name='547'>
                    (zsmain(nzs)-zshalf(nzs))<a name='548'>
        smmax (i,j) =smmax (i,j)+(qmin+dqm)*                     &amp;<a name='549'>
                    (zsmain(nzs)-zshalf(nzs))<a name='550'>
<a name='551'>
<font color=#447700>!--- Convert the water unit into mm<a name='552'></font>
        SFCRUNOFF(I,J) = SFCRUNOFF(I,J)+RUNOFF1(I,J)*DT*1000.0<a name='553'>
        UDRUNOFF (I,J) = UDRUNOFF(I,J)+RUNOFF2(I,J)*1000.0<a name='554'>
        SMAVAIL  (I,J) = SMAVAIL(I,J) * 1000.<a name='555'>
        SMMAX    (I,J) = SMMAX(I,J) * 1000.<a name='556'>
        SFCEXC   (I,J) = TKMS<a name='557'>
        QSFC(I,J) = QVG(I,J)/(1.+QVG(I,J))<a name='558'>
        CHKLOWQ(I,J) = 1.<a name='559'>
        MAVAIL (i,j) = LMAVAIL(I,J)  <a name='560'>
<font color=#447700>! SNOW is in [mm], SNWE is in [m]; CANWAT is in mm, CANWATR is in m<a name='561'></font>
        SNOW   (i,j) = SNWE*1000.<a name='562'>
        CANWAT (I,J) = CANWATR*1000.<a name='563'>
<a name='564'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='565'>
       print *,' LAND, I=,J=, QFX, HFX after SFCTMP', i,j,QFX(i,j),hfx(i,j)<a name='566'>
    ENDIF<a name='567'>
        LH       (I,J) = QFX(I,J)<a name='568'>
        QFX      (I,J) = QFX(I,J)/LV<a name='569'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='570'>
       print *,' QFX after change', i,j, QFX(i,j)<a name='571'>
    ENDIF<a name='572'>
<font color=#447700>!--- SNOWC snow cover flag<a name='573'></font>
        IF(SNOW(I,J).GT.10.0)THEN<a name='574'>
            SNOWC(I,J)=1.0<a name='575'>
        ELSE<a name='576'>
            SNOWC(I,J)=0.0<a name='577'>
        ENDIF<a name='578'>
<a name='579'>
        INFILTR(I,J) = INFILTRP<a name='580'>
<a name='581'>
<font color=#447700>!--- get 3d soil fields<a name='582'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='583'>
   print *,'LAND, i,j,tso1d,soilm1d - end of time step',         &amp;<a name='584'>
                  i,j,tso1d,soilm1d<a name='585'>
    ENDIF<a name='586'>
<a name='587'>
        do k=1,nzs<a name='588'>
<font color=#447700>! soil moisture minus residual is in soilmois initialized from RUC<a name='589'></font>
<font color=#447700>!             soilmois(i,k,j) = (soilm1d(k+1)+qmin(i,j))<a name='590'></font>
<a name='591'>
             soilmois(i,k,j) = soilm1d(k)<a name='592'>
                  tso(i,k,j) = tso1d(k)<a name='593'>
        enddo<a name='594'>
<a name='595'>
        do k=1,nzs<a name='596'>
             smfr3d(i,k,j) = smfrkeep(k) <a name='597'>
           keepfr3dflag(i,k,j) = keepfr (k)<a name='598'>
        enddo<a name='599'>
<a name='600'>
        ENDIF<a name='601'>
<a name='602'>
      ENDDO<a name='603'>
<a name='604'>
   ENDDO<a name='605'>
<a name='606'>
<font color=#447700>!-----------------------------------------------------------------<a name='607'></font>
   END SUBROUTINE LSMRUC<a name='608'>
<font color=#447700>!-----------------------------------------------------------------<a name='609'></font>
<a name='610'>
<a name='611'>
<a name='612'>
<A NAME='SFCTMP'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='613'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCTMP</font> (delt,ktau,conflx,i,j,                      &amp; <A href='../../call_to/SFCTMP.html' TARGET='index'>1</A>,<A href='../../call_from/SFCTMP.html' TARGET='index'>2</A><a name='614'>
<font color=#447700>!--- input variables<a name='615'></font>
                nzs,nddzs,nroot,                                 &amp;<a name='616'>
                ILAND,ISOIL,XLAND,IVGTYP,                        &amp;<a name='617'>
                PRCPMS,SNWE,RHOSN,                               &amp;<a name='618'>
                PATM,TABS,QVATM,QCATM,rho,                       &amp;<a name='619'>
                GLW,GSW,EMISS,QKMS,TKMS,PC,                      &amp;<a name='620'>
                MAVAIL,CST,VEGFRA,ALB,ZNT,                       &amp;<a name='621'>
<font color=#447700>!--- soil fixed fields<a name='622'></font>
                QWRTZ,rhocs,dqm,qmin,ref,wilt,psis,bclh,ksat,    &amp;<a name='623'>
                sat,cn,zsmain,zshalf,DTDZS,DTDZS2,tbq,           &amp;<a name='624'>
<font color=#447700>!--- constants<a name='625'></font>
                cp,g0,lv,stbolt,cw,c1sn,c2sn,                    &amp;<a name='626'>
                KQWRTZ,KICE,KWT,                                 &amp;<a name='627'>
<font color=#447700>!--- output variables<a name='628'></font>
                snweprint,snheiprint,rsm,                        &amp;<a name='629'>
                soilm1d,ts1d,smfrkeep,keepfr,soilt,soilt1,       &amp;<a name='630'>
                tsnav,dew,qvg,qsg,qcg,                           &amp;<a name='631'>
                SMELT,SNOH,SNFLX,SNOM,ACSNOW,                    &amp;<a name='632'>
                edir1,ec1,ett1,eeta,qfx,hfx,s,sublim,            &amp;<a name='633'>
                evapl,prcpl,runoff1,runoff2,soilice,             &amp;<a name='634'>
                soiliqw,infiltr)<a name='635'>
<font color=#447700>!-----------------------------------------------------------------<a name='636'></font>
       IMPLICIT NONE<a name='637'>
<font color=#447700>!-----------------------------------------------------------------<a name='638'></font>
<a name='639'>
<font color=#447700>!--- input variables<a name='640'></font>
<a name='641'>
   INTEGER,  INTENT(IN   )   ::  i,j,nroot,ktau,nzs            , &amp;<a name='642'>
                                 nddzs                             <font color=#447700>!nddzs=2*(nzs-2)<a name='643'></font>
<a name='644'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX<a name='645'>
   REAL,     INTENT(IN   )   ::  C1SN,C2SN<a name='646'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='647'></font>
   REAL                                                        , &amp;<a name='648'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='649'>
                                                           TABS, &amp;<a name='650'>
                                                          QVATM, &amp;<a name='651'>
                                                          QCATM<a name='652'>
   REAL                                                        , &amp;<a name='653'>
            INTENT(IN   )    ::                             GLW, &amp;<a name='654'>
                                                            GSW, &amp;<a name='655'>
                                                             PC, &amp;<a name='656'>
                                                         VEGFRA, &amp;<a name='657'>
                                                          XLAND, &amp;<a name='658'>
                                                            RHO, &amp;<a name='659'>
                                                           QKMS, &amp;<a name='660'>
                                                           TKMS<a name='661'>
                                                             <a name='662'>
   INTEGER,   INTENT(IN   )  ::                          IVGTYP<a name='663'>
<font color=#447700>!--- 2-D variables<a name='664'></font>
   REAL                                                        , &amp;<a name='665'>
            INTENT(INOUT)    ::                           EMISS, &amp;<a name='666'>
                                                         MAVAIL, &amp;<a name='667'>
                                                            ALB, &amp;<a name='668'>
                                                            CST<a name='669'>
<a name='670'>
<font color=#447700>!--- soil properties<a name='671'></font>
   REAL                      ::                                  &amp;<a name='672'>
                                                          RHOCS, &amp;<a name='673'>
                                                           BCLH, &amp;<a name='674'>
                                                            DQM, &amp;<a name='675'>
                                                           KSAT, &amp;<a name='676'>
                                                           PSIS, &amp;<a name='677'>
                                                           QMIN, &amp;<a name='678'>
                                                          QWRTZ, &amp;<a name='679'>
                                                            REF, &amp;<a name='680'>
                                                            SAT, &amp;<a name='681'>
                                                           WILT<a name='682'>
<a name='683'>
   REAL,     INTENT(IN   )   ::                              CN, &amp;<a name='684'>
                                                             CW, &amp;<a name='685'>
                                                             CP, &amp;<a name='686'>
                                                             G0, &amp;<a name='687'>
                                                             LV, &amp;<a name='688'>
                                                         STBOLT, &amp;<a name='689'>
                                                         KQWRTZ, &amp;<a name='690'>
                                                           KICE, &amp;<a name='691'>
                                                            KWT<a name='692'>
<a name='693'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='694'>
                                                         ZSHALF, &amp;<a name='695'>
                                                         DTDZS2 <a name='696'>
<a name='697'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='698'>
<a name='699'>
   REAL,     DIMENSION(1:4001), INTENT(IN)  ::              TBQ<a name='700'>
<a name='701'>
<a name='702'>
<font color=#447700>!--- input/output variables<a name='703'></font>
<font color=#447700>!-------- 3-d soil moisture and temperature<a name='704'></font>
   REAL,     DIMENSION( 1:nzs )                                , &amp;<a name='705'>
             INTENT(INOUT)   ::                            TS1D, &amp; <a name='706'>
                                                        SOILM1D, &amp;<a name='707'>
                                                       SMFRKEEP<a name='708'>
   REAL,  DIMENSION( 1:nzs )                                   , &amp;<a name='709'>
             INTENT(INOUT)   ::                          KEEPFR<a name='710'>
          <a name='711'>
<a name='712'>
   INTEGER, INTENT(INOUT)    ::                     ILAND,ISOIL<a name='713'>
<a name='714'>
<font color=#447700>!-------- 2-d variables<a name='715'></font>
   REAL                                                        , &amp;<a name='716'>
             INTENT(INOUT)   ::                             DEW, &amp;<a name='717'>
                                                          EDIR1, &amp;<a name='718'>
                                                            EC1, &amp;<a name='719'>
                                                           ETT1, &amp;<a name='720'>
                                                           EETA, &amp;<a name='721'>
                                                          EVAPL, &amp;<a name='722'>
                                                        INFILTR, &amp;<a name='723'>
                                                          RHOSN, &amp; <a name='724'>
                                                         SUBLIM, &amp;<a name='725'>
                                                          PRCPL, &amp;<a name='726'>
                                                            QVG, &amp;<a name='727'>
                                                            QSG, &amp;<a name='728'>
                                                            QCG, &amp;<a name='729'>
                                                            QFX, &amp;<a name='730'>
                                                            HFX, &amp;<a name='731'>
                                                              S, &amp;  <a name='732'>
                                                        RUNOFF1, &amp;<a name='733'>
                                                        RUNOFF2, &amp;<a name='734'>
                                                         ACSNOW, &amp;<a name='735'>
                                                           SNWE, &amp;<a name='736'>
                                                          SMELT, &amp;<a name='737'>
                                                           SNOM, &amp;<a name='738'>
                                                           SNOH, &amp;<a name='739'>
                                                          SNFLX, &amp;<a name='740'>
                                                          SOILT, &amp;<a name='741'>
                                                         SOILT1, &amp;<a name='742'>
                                                          TSNAV, &amp;<a name='743'>
                                                            ZNT<a name='744'>
<a name='745'>
<font color=#447700>!-------- 1-d variables<a name='746'></font>
   REAL,     DIMENSION(1:NZS), INTENT(OUT)  ::          SOILICE, &amp;<a name='747'>
                                                        SOILIQW<a name='748'>
<a name='749'>
   REAL,     INTENT(OUT)                    ::              RSM, &amp;  <a name='750'>
                                                      SNWEPRINT, &amp;<a name='751'>
                                                     SNHEIPRINT<a name='752'>
<font color=#447700>!--- Local variables<a name='753'></font>
<a name='754'>
   INTEGER ::  K,ILNB<a name='755'>
<a name='756'>
   REAL    ::  BSN, XSN, RHONEWSN, SNHEI                       , &amp;<a name='757'>
               RAINF, SNTH, NEWSN, PRCPMS                      , &amp;<a name='758'>
               T3, UPFLUX, XINET<a name='759'>
   REAL    ::  alb_snow,alb_snow_free,snhei_crit               , &amp;<a name='760'>
               keep_snow_albedo<a name='761'>
<a name='762'>
   REAL    ::  RNET,GSWNEW,EMISSN,ALBSN,ZNTSN<a name='763'>
   REAL    ::  VEGFRAC<a name='764'>
<a name='765'>
<font color=#447700>!-----------------------------------------------------------------<a name='766'></font>
        integer,   parameter      ::      ilsnow=99 <a name='767'>
        <a name='768'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='769'>
        print *,' in SFCTMP',i,j,nzs,nddzs,nroot,                 &amp;<a name='770'>
                 SNWE,RHOSN,SNOM,SMELT,TS1D<a name='771'>
    ENDIF<a name='772'>
<font color=#447700>!       print *,' in SFCTMP',i,j,nzs,nddzs,nroot,                 &amp;<a name='773'></font>
<font color=#447700>!                IVGTYP,ISOIL,ILAND,                              &amp;<a name='774'></font>
<font color=#447700>!                PRCPMS,SNWE,RHOSN,                               &amp;<a name='775'></font>
<font color=#447700>!                PATM,TABS,QVATM,QCATM,rho<a name='776'></font>
<font color=#447700>!                GLW,GSW,EMISS,QKMS,TKMS,PC,                      &amp;<a name='777'></font>
<font color=#447700>!                cst,vegfrac,alb,znt,                             &amp;<a name='778'></font>
<font color=#447700>!--- soil fixed fields<a name='779'></font>
<font color=#447700>!                QWRTZ,rhocs,dqm,qmin,ref,wilt,psis,bclh,ksat,    &amp;<a name='780'></font>
<font color=#447700>!                sat,cn,zsmain,zshalf,DTDZS,DTDZS2,tbq,           &amp;<a name='781'></font>
<font color=#447700>!--- constants<a name='782'></font>
<font color=#447700>!                cp,g0,lv,stbolt,cw,c1sn,c2sn,                    &amp; <a name='783'></font>
<font color=#447700>!                KQWRTZ,KICE,KWT                            <a name='784'></font>
<a name='785'>
        NEWSN=0.<a name='786'>
        RAINF = 0.<a name='787'>
        RSM=0.<a name='788'>
        INFILTR=0.<a name='789'>
        VEGFRAC=0.01*VEGFRA<a name='790'>
<a name='791'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='792'>
        print *,'I,J,KTAU,QKMS,TKMS', i,j,ktau,qkms,tkms<a name='793'>
        print *,'GSW, GLW, SOILT, STBOLT, EMISS',           &amp;<a name='794'>
                 GSW, GLW, SOILT, STBOLT, EMISS<a name='795'>
    ENDIF<a name='796'>
<a name='797'>
<a name='798'>
        SNHEI   = SNWE * 1000. / RHOSN<a name='799'>
<font color=#447700>!--------------<a name='800'></font>
        T3      = STBOLT*SOILT*SOILT*SOILT<a name='801'>
        UPFLUX  = T3 *SOILT<a name='802'>
        XINET   = EMISS*(GLW-UPFLUX)<a name='803'>
        RNET    = GSW + XINET<a name='804'>
<a name='805'>
<font color=#447700>!*** Calculate the amount (m) of fresh snow<a name='806'></font>
<a name='807'>
      if(snhei.gt.0.0081*1.e3/rhosn) then<a name='808'>
<font color=#447700>!*** Correct snow density for current temperature (Koren et al. 1999)<a name='809'></font>
        BSN=delt/3600.*c1sn*exp(0.08*tsnav-c2sn*rhosn*1.e-3)<a name='810'>
       if(bsn*snwe*100..lt.1.e-4) goto 777<a name='811'>
        XSN=rhosn*(exp(bsn*snwe*100.)-1.)/(bsn*snwe*100.)<a name='812'>
        rhosn=MIN(MAX(50.,XSN),400.)<a name='813'>
 777   continue<a name='814'>
<a name='815'>
      else<a name='816'>
        rhosn     =200.<a name='817'>
        rhonewsn  =100.<a name='818'>
      endif<a name='819'>
<a name='820'>
         IF(TABS.LE.273.15)THEN<a name='821'>
<a name='822'>
           newsn=prcpms*delt<a name='823'>
<font color=#447700>!--- ACSNOW - accumulation of snow water [m]<a name='824'></font>
           acsnow=acsnow+newsn<a name='825'>
<a name='826'>
       IF(NEWSN.GE.1.E-8) THEN<a name='827'>
<font color=#447700>!*** Calculate fresh snow density (t &gt; -15C, else MIN value)<a name='828'></font>
<font color=#447700>!*** Eq. 10 from Koren et al. (1999)<a name='829'></font>
<a name='830'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='831'>
      print *, 'THERE IS NEW SNOW, newsn', newsn<a name='832'>
    ENDIF<a name='833'>
        if(tabs.lt.258.15) then<a name='834'>
          rhonewsn=50.<a name='835'>
<font color=#447700>!          rhonewsn=100.<a name='836'></font>
<a name='837'>
        else<a name='838'>
          rhonewsn=1.e3*max((0.05+0.0017*(Tabs-273.15+15.)**1.5) &amp;<a name='839'>
                                 , 0.05)<a name='840'>
          rhonewsn=MIN(rhonewsn,400.)<a name='841'>
<font color=#447700>!          rhonewsn=100.<a name='842'></font>
        endif<a name='843'>
<a name='844'>
<a name='845'>
<font color=#447700>!*** Define average snow density of the snow pack considering<a name='846'></font>
<font color=#447700>!*** the amount of fresh snow (eq. 9 in Koren et al.(1999) <a name='847'></font>
<font color=#447700>!*** without snow melt )<a name='848'></font>
         xsn=(rhosn*snwe+rhonewsn*newsn)/                         &amp;<a name='849'>
             (snwe+newsn)<a name='850'>
         rhosn=MIN(MAX(50.,XSN),400.)<a name='851'>
<a name='852'>
         snwe=snwe+newsn<a name='853'>
         snhei=snwe*1.E3/rhosn<a name='854'>
         NEWSN=NEWSN*1.E3/rhosn<a name='855'>
        endif<a name='856'>
<a name='857'>
         ELSE<a name='858'>
<font color=#447700>!--- TABS is above freezing. Needed precip rates from microphysics<a name='859'></font>
<font color=#447700>!--- to do a better job with mixed phase precip.<a name='860'></font>
<a name='861'>
        NEWSN = 0.<a name='862'>
<a name='863'>
         ENDIF<a name='864'>
<a name='865'>
       IF(PRCPMS.NE.0.) THEN<a name='866'>
<a name='867'>
<font color=#447700>! PRCPMS is liquid precipitation rate<a name='868'></font>
<font color=#447700>! RAINF is a flag used for calculation of rain water<a name='869'></font>
<font color=#447700>! heat content contribution into heat budget equation. Rain's temperature<a name='870'></font>
<font color=#447700>! is set equal to air temperature at the first atmospheric<a name='871'></font>
<font color=#447700>! level.  <a name='872'></font>
<a name='873'>
           RAINF=1.<a name='874'>
       ENDIF<a name='875'>
<a name='876'>
<font color=#447700>!      IF((XLAND-1.5).GE.0.)THEN<a name='877'></font>
<font color=#447700>!      IF(ILAND.EQ.16) THEN<a name='878'></font>
<font color=#447700>!         SNHEI=0.<a name='879'></font>
<font color=#447700>!         SNWE=0.<a name='880'></font>
<font color=#447700>!      ELSE<a name='881'></font>
<a name='882'>
        IF(SNHEI.GT.0.02) THEN<a name='883'>
<font color=#447700>!--- Set of surface parameters should be changed to snow values for grid<a name='884'></font>
<font color=#447700>!--- points where the snow cover exceeds snow threshold of 2 cm<a name='885'></font>
<font color=#447700>!              ALB    = 0.75<a name='886'></font>
<a name='887'>
<font color=#447700>!         ALB    = 0.7<a name='888'></font>
         EMISS = 0.91<a name='889'>
<a name='890'>
<font color=#447700>!         GSWNEW = GSW<a name='891'></font>
<font color=#447700>! The following lines compute albedo depending on snow<a name='892'></font>
<font color=#447700>! depth. For now commented out.<a name='893'></font>
         alb_snow_free=0.2<a name='894'>
         alb_snow=0.70<a name='895'>
         SNHEI_CRIT=0.1<a name='896'>
         KEEP_SNOW_ALBEDO = 0.<a name='897'>
      IF (NEWSN.GT.0.) KEEP_SNOW_ALBEDO = 1.<a name='898'>
<a name='899'>
<font color=#447700>!---  GSW in-coming solar<a name='900'></font>
         gswnew=gsw/(1.-alb)<a name='901'>
<a name='902'>
       ALB   = MAX(keep_snow_albedo*alb_snow,                   &amp;<a name='903'>
            MIN((alb_snow_free +                                &amp;<a name='904'>
           (alb_snow - alb_snow_free) *                         &amp;<a name='905'>
           (snhei/SNHEI_CRIT)), alb_snow))<a name='906'>
<font color=#447700>!--- recompute absorbed solar radiation and net radiation<a name='907'></font>
<font color=#447700>!--- for new value of albedo<a name='908'></font>
         gswnew=gswnew*(1.-alb)<a name='909'>
        RNET    = GSWnew + XINET<a name='910'>
<a name='911'>
         CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL'>SNOWSOIL</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWSOIL_1"> (                                        &amp; <font color=#447700>!--- input variables<a name='912'></font>
            i,j,isoil,delt,ktau,conflx,nzs,nddzs,nroot,         &amp;<a name='913'>
            ILAND,PRCPMS,RAINF,NEWSN,snhei,SNWE,                &amp;<a name='914'>
            RHOSN,PATM,QVATM,QCATM,                             &amp;<a name='915'>
            GLW,GSWnew,EMISS,RNET,IVGTYP,                       &amp;<a name='916'>
            QKMS,TKMS,PC,CST,                                   &amp;<a name='917'>
            RHO,VEGFRAC,ALB,ZNT,                                &amp;<a name='918'>
<font color=#447700>!--- soil fixed fields<a name='919'></font>
            QWRTZ,rhocs,dqm,qmin,ref,wilt,psis,bclh,ksat,       &amp;<a name='920'>
            sat,cn,zsmain,zshalf,DTDZS,DTDZS2,tbq,              &amp; <a name='921'>
<font color=#447700>!--- constants<a name='922'></font>
            lv,CP,G0,cw,stbolt,tabs,                            &amp;<a name='923'>
            KQWRTZ,KICE,KWT,                                    &amp;<a name='924'>
<font color=#447700>!--- output variables<a name='925'></font>
            ilnb,snweprint,snheiprint,rsm,                      &amp;<a name='926'>
            soilm1d,ts1d,smfrkeep,keepfr,                       &amp;<a name='927'>
            dew,soilt,soilt1,tsnav,qvg,qsg,qcg,                 &amp;<a name='928'>
            SMELT,SNOH,SNFLX,SNOM,edir1,ec1,ett1,eeta,          &amp;<a name='929'>
            qfx,hfx,s,sublim,prcpl,runoff1,runoff2,             &amp;<a name='930'>
            mavail,soilice,soiliqw,infiltr                      )<a name='931'>
<a name='932'>
         if(snhei.le.2.e-2) then<a name='933'>
<font color=#447700>!--- all snow is melted<a name='934'></font>
<font color=#447700>!           gswnew=gswnew/(1.-alb)<a name='935'></font>
           alb=alb_snow_free<a name='936'>
<font color=#447700>!           gswnew=gswnew*(1.-alb)<a name='937'></font>
         endif<a name='938'>
<a name='939'>
        ELSE<a name='940'>
<a name='941'>
           snheiprint=0.<a name='942'>
           snweprint=0.<a name='943'>
<a name='944'>
         CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL'>SOIL</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_1">(                                             &amp;<a name='945'>
<font color=#447700>!--- input variables<a name='946'></font>
            i,j,iland,isoil,delt,ktau,conflx,nzs,nddzs,nroot,   &amp;<a name='947'>
            PRCPMS,RAINF,PATM,QVATM,QCATM,GLW,GSW,              &amp;<a name='948'>
            EMISS,RNET,QKMS,TKMS,PC,cst,rho,vegfrac,            &amp;<a name='949'>
<font color=#447700>!--- soil fixed fields <a name='950'></font>
            QWRTZ,rhocs,dqm,qmin,ref,wilt,                      &amp;<a name='951'>
            psis,bclh,ksat,sat,cn,                              &amp;<a name='952'>
            zsmain,zshalf,DTDZS,DTDZS2,tbq,                     &amp;<a name='953'>
<font color=#447700>!--- constants<a name='954'></font>
            lv,CP,G0,cw,stbolt,tabs,                            &amp;<a name='955'>
            KQWRTZ,KICE,KWT,                                    &amp;<a name='956'>
<font color=#447700>!--- output variables<a name='957'></font>
            soilm1d,ts1d,smfrkeep,keepfr,                       &amp;<a name='958'>
            dew,soilt,qvg,qsg,qcg,edir1,ec1,                    &amp;<a name='959'>
            ett1,eeta,qfx,hfx,s,evapl,prcpl,runoff1,            &amp;<a name='960'>
            runoff2,mavail,soilice,soiliqw,                     &amp;<a name='961'>
            infiltr)<a name='962'>
<a name='963'>
        ENDIF<a name='964'>
<font color=#447700>!      ENDIF<a name='965'></font>
<a name='966'>
<font color=#447700>!<a name='967'></font>
<a name='968'>
<font color=#447700>!      RETURN<a name='969'></font>
<font color=#447700>!       END<a name='970'></font>
<font color=#447700>!---------------------------------------------------------------<a name='971'></font>
   END SUBROUTINE SFCTMP<a name='972'>
<font color=#447700>!---------------------------------------------------------------<a name='973'></font>
<a name='974'>
<a name='975'>
<A NAME='QSN'><A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='976'>
       <font color=#993300>FUNCTION </font><font color=#cc0000>QSN</font>(TN,T) <A href='../../call_to/QSN.html' TARGET='index'>4</A><a name='977'>
<font color=#447700>!****************************************************************<a name='978'></font>
   REAL,     DIMENSION(1:4001),  INTENT(IN   )   ::  T<a name='979'>
   REAL,     INTENT(IN  )   ::  TN<a name='980'>
<a name='981'>
      REAL    QSN, R,R1,R2<a name='982'>
      INTEGER I<a name='983'>
<a name='984'>
       R=(TN-173.15)/.05+1.<a name='985'>
       I=INT(R)<a name='986'>
       IF(I.GE.1) goto 10<a name='987'>
       I=1<a name='988'>
       R=1.<a name='989'>
  10   IF(I.LE.4000) GOTO 20<a name='990'>
       I=4000<a name='991'>
       R=4001.<a name='992'>
  20   R1=T(I)<a name='993'>
       R2=R-I<a name='994'>
       QSN=(T(I+1)-R1)*R2 + R1<a name='995'>
<font color=#447700>!       print *,' in QSN, I,R,R1,R2,T(I+1),TN, QSN', I,R,r1,r2,t(i+1),tn,QSN<a name='996'></font>
<font color=#447700>!       RETURN<a name='997'></font>
<font color=#447700>!       END<a name='998'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='999'></font>
  END FUNCTION QSN<a name='1000'>
<font color=#447700>!------------------------------------------------------------------------<a name='1001'></font>
<a name='1002'>
<a name='1003'>
<A NAME='SOIL'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1004'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOIL</font> (                                    &amp; <A href='../../call_to/SOIL.html' TARGET='index'>1</A>,<A href='../../call_from/SOIL.html' TARGET='index'>4</A><a name='1005'>
<font color=#447700>!--- input variables<a name='1006'></font>
            i,j,iland,isoil,delt,ktau,conflx,nzs,nddzs,nroot,&amp;<a name='1007'>
            PRCPMS,RAINF,PATM,QVATM,QCATM,                   &amp;<a name='1008'>
            GLW,GSW,EMISS,RNET,                              &amp;<a name='1009'>
            QKMS,TKMS,PC,cst,rho,vegfrac,                    &amp;<a name='1010'>
<font color=#447700>!--- soil fixed fields<a name='1011'></font>
            QWRTZ,rhocs,dqm,qmin,ref,wilt,psis,bclh,ksat,    &amp;<a name='1012'>
            sat,cn,zsmain,zshalf,DTDZS,DTDZS2,tbq,           &amp;<a name='1013'>
<font color=#447700>!--- constants<a name='1014'></font>
            xlv,CP,G0_P,cw,stbolt,TABS,                      &amp;<a name='1015'>
            KQWRTZ,KICE,KWT,                                 &amp;<a name='1016'>
<font color=#447700>!--- output variables<a name='1017'></font>
            soilmois,tso,smfrkeep,keepfr,                    &amp;<a name='1018'>
            dew,soilt,qvg,qsg,qcg,                           &amp;<a name='1019'>
            edir1,ec1,ett1,eeta,qfx,hfx,s,evapl,             &amp;<a name='1020'>
            prcpl,runoff1,runoff2,mavail,soilice,            &amp;<a name='1021'>
            soiliqw,infiltrp)<a name='1022'>
<a name='1023'>
<font color=#447700>!*************************************************************<a name='1024'></font>
<font color=#447700>!   Energy and moisture budget for vegetated surfaces <a name='1025'></font>
<font color=#447700>!   without snow, heat diffusion amf Richards eqns. in<a name='1026'></font>
<font color=#447700>!   soil<a name='1027'></font>
<font color=#447700>!<a name='1028'></font>
<font color=#447700>!     DELT - time step<a name='1029'></font>
<font color=#447700>!     ktau - numver of time step<a name='1030'></font>
<font color=#447700>!     CONFLX - depth of constant flux layer (m)<a name='1031'></font>
<font color=#447700>!     J,I - the location of grid point<a name='1032'></font>
<font color=#447700>!     IME, JME, KME, NZS - dimensions of the domain<a name='1033'></font>
<font color=#447700>!     NROOT - number of levels within the root zone<a name='1034'></font>
<font color=#447700>!     PRCPMS - precipitation rate in m/s<a name='1035'></font>
<font color=#447700>!     PATM - pressure [bar]<a name='1036'></font>
<font color=#447700>!     QVATM,QCATM - cloud and water vapor mixing ratio<a name='1037'></font>
<font color=#447700>!                   at the first atm. level<a name='1038'></font>
<font color=#447700>!     GLW, GSW - incoming longwave and absorbed shortwave<a name='1039'></font>
<font color=#447700>!                radiation at the surface <a name='1040'></font>
<font color=#447700>!     EMISS,RNET - emissivity of the ground surface and net<a name='1041'></font>
<font color=#447700>!                  radiation at the surface<a name='1042'></font>
<font color=#447700>!     QKMS - exchange coefficient for water vapor in the<a name='1043'></font>
<font color=#447700>!              surface layer (m/s)<a name='1044'></font>
<font color=#447700>!     TKMS - exchange coefficient for heat in the surface<a name='1045'></font>
<font color=#447700>!              layer (m/s)<a name='1046'></font>
<font color=#447700>!     PC - plant coefficient (resistance)<a name='1047'></font>
<font color=#447700>!     RHO - density of atmosphere near sueface<a name='1048'></font>
<font color=#447700>!     VEGFRAC - greeness fraction<a name='1049'></font>
<font color=#447700>!     RHOCS - volumetric heat capacity of dry soil<a name='1050'></font>
<font color=#447700>!     DQM, QMIN - porosity minus residual soil moisture QMIN<a name='1051'></font>
<font color=#447700>!     REF, WILT - field capacity soil moisture and the <a name='1052'></font>
<font color=#447700>!                 wilting point<a name='1053'></font>
<font color=#447700>!     PSIS - matrix potential at saturation<a name='1054'></font>
<font color=#447700>!     BCLH - exponent for Clapp-Hornberger parameterization<a name='1055'></font>
<font color=#447700>!     KSAT - saturated hydraulic conductivity<a name='1056'></font>
<font color=#447700>!     SAT - maximum value of water intercepted by canopy<a name='1057'></font>
<font color=#447700>!     CN - exponent for calculation of canopy water<a name='1058'></font>
<font color=#447700>!     ZSMAIN - main levels in soil<a name='1059'></font>
<font color=#447700>!     ZSHALF - middle of the soil layers<a name='1060'></font>
<font color=#447700>!     DTDZS,DTDZS2 - dt/(2.*dzshalf*dzmain) and dt/dzshalf in soil<a name='1061'></font>
<font color=#447700>!     TBQ - table to define saturated mixing ration<a name='1062'></font>
<font color=#447700>!           of water vapor for given temperature and pressure<a name='1063'></font>
<font color=#447700>!     SOILMOIS,TSO - soil moisture and temperature<a name='1064'></font>
<font color=#447700>!     DEW -  dew in kg/m^2s<a name='1065'></font>
<font color=#447700>!     SOILT - skin temperature<a name='1066'></font>
<font color=#447700>!     QSG,QVG,QCG - saturated mixing ratio, mixing ratio of<a name='1067'></font>
<font color=#447700>!                   water vapor and cloud at the ground<a name='1068'></font>
<font color=#447700>!                   surface, respectively<a name='1069'></font>
<font color=#447700>!     EDIR1, EC1, ETT1, EETA - direct evaporation, evaporation of<a name='1070'></font>
<font color=#447700>!            canopy water, transpiration in kg m-2 s-1 and total<a name='1071'></font>
<font color=#447700>!            evaporation in m s-1.<a name='1072'></font>
<font color=#447700>!     QFX, HFX - latent and sensible heat fluxes<a name='1073'></font>
<font color=#447700>!     S - soil heat flux in the top layer <a name='1074'></font>
<font color=#447700>!     RUNOFF - surface runoff (m/s)<a name='1075'></font>
<font color=#447700>!     RUNOFF2 - underground runoff (m)<a name='1076'></font>
<font color=#447700>!     MAVAIL - moisture availability in the top soil layer<a name='1077'></font>
<font color=#447700>!     INFILTRP - infiltration flux from the top of soil domain<a name='1078'></font>
<font color=#447700>!<a name='1079'></font>
<font color=#447700>!*****************************************************************<a name='1080'></font>
        IMPLICIT NONE<a name='1081'>
<font color=#447700>!-----------------------------------------------------------------<a name='1082'></font>
<a name='1083'>
<font color=#447700>!--- input variables<a name='1084'></font>
<a name='1085'>
   INTEGER,  INTENT(IN   )   ::  nroot,ktau,nzs                , &amp;<a name='1086'>
                                 nddzs                    <font color=#447700>!nddzs=2*(nzs-2)<a name='1087'></font>
   INTEGER,  INTENT(IN   )   ::  i,j,iland,isoil<a name='1088'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX<a name='1089'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='1090'></font>
   REAL,                                                         &amp;<a name='1091'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='1092'>
                                                          QVATM, &amp;<a name='1093'>
                                                          QCATM<a name='1094'>
<font color=#447700>!--- 2-D variables<a name='1095'></font>
   REAL,                                                         &amp;<a name='1096'>
            INTENT(IN   )    ::                             GLW, &amp;<a name='1097'>
                                                            GSW, &amp;<a name='1098'>
                                                          EMISS, &amp;<a name='1099'>
                                                            RHO, &amp;<a name='1100'>
                                                             PC, &amp;<a name='1101'>
                                                        VEGFRAC, &amp;<a name='1102'>
                                                           QKMS, &amp;<a name='1103'>
                                                           TKMS<a name='1104'>
<a name='1105'>
<font color=#447700>!--- soil properties<a name='1106'></font>
   REAL,                                                         &amp;<a name='1107'>
            INTENT(IN   )    ::                           RHOCS, &amp;<a name='1108'>
                                                           BCLH, &amp;<a name='1109'>
                                                            DQM, &amp;<a name='1110'>
                                                           KSAT, &amp;<a name='1111'>
                                                           PSIS, &amp;<a name='1112'>
                                                           QMIN, &amp;<a name='1113'>
                                                          QWRTZ, &amp;<a name='1114'>
                                                            REF, &amp;<a name='1115'>
                                                           WILT<a name='1116'>
<a name='1117'>
   REAL,     INTENT(IN   )   ::                              CN, &amp;<a name='1118'>
                                                             CW, &amp;<a name='1119'>
                                                         KQWRTZ, &amp;<a name='1120'>
                                                           KICE, &amp;<a name='1121'>
                                                            KWT, &amp;<a name='1122'>
                                                            XLV, &amp;<a name='1123'>
                                                            g0_p<a name='1124'>
<a name='1125'>
<a name='1126'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='1127'>
                                                         ZSHALF, &amp;<a name='1128'>
                                                         DTDZS2<a name='1129'>
<a name='1130'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='1131'>
<a name='1132'>
   REAL,     DIMENSION(1:4001), INTENT(IN)  ::              TBQ<a name='1133'>
<a name='1134'>
<a name='1135'>
<font color=#447700>!--- input/output variables<a name='1136'></font>
<font color=#447700>!-------- 3-d soil moisture and temperature<a name='1137'></font>
   REAL,     DIMENSION( 1:nzs )                                , &amp;<a name='1138'>
             INTENT(INOUT)   ::                             TSO, &amp;<a name='1139'>
                                                       SOILMOIS, &amp;<a name='1140'>
                                                       SMFRKEEP<a name='1141'>
<a name='1142'>
   REAL,     DIMENSION( 1:nzs )                                , &amp;<a name='1143'>
             INTENT(INOUT)   ::                          KEEPFR<a name='1144'>
<a name='1145'>
<font color=#447700>!-------- 2-d variables<a name='1146'></font>
   REAL,                                                         &amp;<a name='1147'>
             INTENT(INOUT)   ::                             DEW, &amp;<a name='1148'>
                                                            CST, &amp;<a name='1149'>
                                                          EDIR1, &amp;<a name='1150'>
                                                            EC1, &amp;<a name='1151'>
                                                           ETT1, &amp;<a name='1152'>
                                                           EETA, &amp;<a name='1153'>
                                                          EVAPL, &amp;<a name='1154'>
                                                          PRCPL, &amp;<a name='1155'>
                                                         MAVAIL, &amp;<a name='1156'>
                                                            QVG, &amp;<a name='1157'>
                                                            QSG, &amp;<a name='1158'>
                                                            QCG, &amp;<a name='1159'>
                                                           RNET, &amp;<a name='1160'>
                                                            QFX, &amp;<a name='1161'>
                                                            HFX, &amp;<a name='1162'>
                                                              S, &amp;<a name='1163'>
                                                            SAT, &amp;<a name='1164'>
                                                        RUNOFF1, &amp;<a name='1165'>
                                                        RUNOFF2, &amp;<a name='1166'>
                                                          SOILT<a name='1167'>
<a name='1168'>
<font color=#447700>!-------- 1-d variables<a name='1169'></font>
   REAL,     DIMENSION(1:NZS), INTENT(OUT)  ::          SOILICE, &amp;<a name='1170'>
                                                        SOILIQW<a name='1171'>
<a name='1172'>
<font color=#447700>!--- Local variables<a name='1173'></font>
<a name='1174'>
   REAL    ::  INFILTRP, transum                               , &amp;<a name='1175'>
               RAINF,  PRCPMS                                  , &amp;<a name='1176'>
               TABS, T3, UPFLUX, XINET<a name='1177'>
   REAL    ::  CP,G0,LV,STBOLT,xlmelt,dzstop                   , &amp;<a name='1178'>
               can,epot,fac,fltot,ft,fq,hft                    , &amp;<a name='1179'>
               q1,ras,rhoice,sph                               , &amp;<a name='1180'>
               trans,zn,ci,cvw,tln,tavln,pi                    , &amp;<a name='1181'>
               DD1,CMC2MS,DRYCAN,WETCAN                        , &amp;<a name='1182'>
               INFMAX,RIW<a name='1183'>
   REAL,     DIMENSION(1:NZS)  ::  transp,cap,diffu,hydro      , &amp;<a name='1184'>
                                   thdif,tranf,tav,soilmoism   , &amp;<a name='1185'>
                                   soilicem,soiliqwm,detal     , &amp;<a name='1186'>
                                   fwsat,lwsat,told,smold<a name='1187'>
<a name='1188'>
   REAL                        ::  drip<a name='1189'>
<a name='1190'>
   INTEGER ::  nzs1,nzs2,k<a name='1191'>
<a name='1192'>
<font color=#447700>!-----------------------------------------------------------------<a name='1193'></font>
<a name='1194'>
<font color=#447700>!-- define constants<a name='1195'></font>
<font color=#447700>!        STBOLT=5.670151E-8<a name='1196'></font>
        RHOICE=900.<a name='1197'>
        CI=RHOICE*2100.<a name='1198'>
        XLMELT=3.335E+5<a name='1199'>
        cvw=cw<a name='1200'>
<a name='1201'>
        SAT=0.0004<a name='1202'>
        prcpl=prcpms<a name='1203'>
<a name='1204'>
<font color=#447700>!--- Initializing local arrays<a name='1205'></font>
        DO K=1,NZS<a name='1206'>
          TRANSP   (K)=0.<a name='1207'>
          soilmoism(k)=0.<a name='1208'>
          soilice  (k)=0.<a name='1209'>
          soiliqw  (k)=0.<a name='1210'>
          soilicem (k)=0.<a name='1211'>
          soiliqwm (k)=0.<a name='1212'>
          lwsat    (k)=0.<a name='1213'>
          fwsat    (k)=0.<a name='1214'>
          tav      (k)=0.<a name='1215'>
          cap      (k)=0.<a name='1216'>
          thdif    (k)=0.<a name='1217'>
          diffu    (k)=0.<a name='1218'>
          hydro    (k)=0.   <a name='1219'>
          tranf    (k)=0.<a name='1220'>
          detal    (k)=0.<a name='1221'>
          told     (k)=0.<a name='1222'>
          smold    (k)=0.<a name='1223'>
        ENDDO<a name='1224'>
<a name='1225'>
          NZS1=NZS-1<a name='1226'>
          NZS2=NZS-2<a name='1227'>
        dzstop=1./(zsmain(2)-zsmain(1))<a name='1228'>
        RAS=RHO*1.E-3<a name='1229'>
        RIW=rhoice*1.e-3<a name='1230'>
<a name='1231'>
<font color=#447700>!--- Computation of volumetric content of ice in soil <a name='1232'></font>
<a name='1233'>
         DO K=1,NZS<a name='1234'>
<font color=#447700>!- main levels<a name='1235'></font>
         tln=log(tso(k)/273.15)<a name='1236'>
         if(tln.lt.0.) then<a name='1237'>
           soiliqw(k)=(dqm+qmin)*(XLMELT*                        &amp;<a name='1238'>
         (tso(k)-273.15)/tso(k)/9.81/psis)                       &amp;<a name='1239'>
          **(-1./bclh)-qmin<a name='1240'>
           soiliqw(k)=max(0.,soiliqw(k))<a name='1241'>
           soiliqw(k)=min(soiliqw(k),soilmois(k))<a name='1242'>
           soilice(k)=(soilmois(k)-soiliqw(k))/RIW<a name='1243'>
<a name='1244'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='1245'></font>
       if(keepfr(k).eq.1.) then<a name='1246'>
           soilice(k)=min(soilice(k),smfrkeep(k))<a name='1247'>
           soiliqw(k)=max(0.,soilmois(k)-soilice(k)*riw)<a name='1248'>
       endif<a name='1249'>
<a name='1250'>
         else<a name='1251'>
           soilice(k)=0.<a name='1252'>
           soiliqw(k)=soilmois(k)<a name='1253'>
         endif<a name='1254'>
<a name='1255'>
          ENDDO<a name='1256'>
<a name='1257'>
          DO K=1,NZS1<a name='1258'>
<font color=#447700>!- middle of soil layers<a name='1259'></font>
         tav(k)=0.5*(tso(k)+tso(k+1))<a name='1260'>
         soilmoism(k)=0.5*(soilmois(k)+soilmois(k+1))<a name='1261'>
         tavln=log(tav(k)/273.15)<a name='1262'>
<a name='1263'>
         if(tavln.lt.0.) then<a name='1264'>
           soiliqwm(k)=(dqm+qmin)*(XLMELT*                       &amp;<a name='1265'>
         (tav(k)-273.15)/tav(k)/9.81/psis)                       &amp;<a name='1266'>
          **(-1./bclh)-qmin<a name='1267'>
           fwsat(k)=dqm-soiliqwm(k)<a name='1268'>
           lwsat(k)=soiliqwm(k)+qmin<a name='1269'>
           soiliqwm(k)=max(0.,soiliqwm(k))<a name='1270'>
           soiliqwm(k)=min(soiliqwm(k), soilmoism(k))<a name='1271'>
           soilicem(k)=(soilmoism(k)-soiliqwm(k))/riw<a name='1272'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='1273'></font>
       if(keepfr(k).eq.1.) then<a name='1274'>
           soilicem(k)=min(soilicem(k),                          &amp;<a name='1275'>
                   0.5*(smfrkeep(k)+smfrkeep(k+1)))<a name='1276'>
           soiliqwm(k)=max(0.,soilmoism(k)-soilicem(k)*riw)<a name='1277'>
           fwsat(k)=dqm-soiliqwm(k)<a name='1278'>
           lwsat(k)=soiliqwm(k)+qmin<a name='1279'>
       endif<a name='1280'>
<a name='1281'>
         else<a name='1282'>
           soilicem(k)=0.<a name='1283'>
           soiliqwm(k)=soilmoism(k)<a name='1284'>
           lwsat(k)=dqm+qmin<a name='1285'>
           fwsat(k)=0.<a name='1286'>
         endif<a name='1287'>
<a name='1288'>
          ENDDO<a name='1289'>
<a name='1290'>
          do k=1,nzs<a name='1291'>
           if(soilice(k).gt.0.) then<a name='1292'>
             smfrkeep(k)=soilice(k)<a name='1293'>
           else<a name='1294'>
             smfrkeep(k)=soilmois(k)/riw<a name='1295'>
           endif<a name='1296'>
          enddo<a name='1297'>
<a name='1298'>
<font color=#447700>!******************************************************************<a name='1299'></font>
<font color=#447700>! SOILPROP computes thermal diffusivity, and diffusional and<a name='1300'></font>
<font color=#447700>!          hydraulic condeuctivities<a name='1301'></font>
<font color=#447700>!******************************************************************<a name='1302'></font>
          CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILPROP'>SOILPROP</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILPROP_1">(                                          &amp;<a name='1303'>
<font color=#447700>!--- input variables<a name='1304'></font>
               nzs,fwsat,lwsat,tav,keepfr,                        &amp;<a name='1305'>
               soilmois,soiliqw,soilice,                          &amp;<a name='1306'>
               soilmoism,soiliqwm,soilicem,                       &amp;<a name='1307'>
<font color=#447700>!--- soil fixed fields<a name='1308'></font>
               QWRTZ,rhocs,dqm,qmin,psis,bclh,ksat,               &amp;<a name='1309'>
<font color=#447700>!--- constants<a name='1310'></font>
               riw,xlmelt,CP,G0_P,cvw,ci,                         &amp;<a name='1311'>
               kqwrtz,kice,kwt,                                   &amp;<a name='1312'>
<font color=#447700>!--- output variables<a name='1313'></font>
               thdif,diffu,hydro,cap)<a name='1314'>
<a name='1315'>
<font color=#447700>!********************************************************************<a name='1316'></font>
<font color=#447700>!--- CALCULATION OF CANOPY WATER (EQ.16) AND DEW <a name='1317'></font>
 <a name='1318'>
        DRIP=0.<a name='1319'>
        DD1=0.<a name='1320'>
<a name='1321'>
        FQ=QKMS<a name='1322'>
<a name='1323'>
        DEW=0.<a name='1324'>
        IF(QVATM.GE.QSG)THEN<a name='1325'>
          DEW=FQ*(QVATM-QSG)<a name='1326'>
        ENDIF<a name='1327'>
        IF(DEW.NE.0.)THEN<a name='1328'>
          DD1=CST+DELT*(PRCPMS +DEW*RAS)*vegfrac<a name='1329'>
        ELSE<a name='1330'>
          DD1=CST+                                                 &amp;<a name='1331'>
            DELT*(PRCPMS+RAS*FQ*(QVATM-QSG)                        &amp;<a name='1332'>
           *(CST/SAT)**CN)*vegfrac<a name='1333'>
        ENDIF<a name='1334'>
<a name='1335'>
        IF(DD1.LT.0.) DD1=0.<a name='1336'>
        if(vegfrac.eq.0.)then<a name='1337'>
          cst=0.<a name='1338'>
          drip=0.<a name='1339'>
        endif<a name='1340'>
        IF (vegfrac.GT.0.) THEN<a name='1341'>
          CST=DD1<a name='1342'>
        IF(CST.GT.SAT) THEN<a name='1343'>
          CST=SAT<a name='1344'>
          DRIP=DD1-SAT<a name='1345'>
        ENDIF<a name='1346'>
        ENDIF<a name='1347'>
<a name='1348'>
<font color=#447700>!--- WETCAN is the fraction of vegetated area covered by canopy<a name='1349'></font>
<font color=#447700>!--- water, and DRYCAN is the fraction of vegetated area where<a name='1350'></font>
<font color=#447700>!--- transpiration may take place.<a name='1351'></font>
<a name='1352'>
          WETCAN=(CST/SAT)**CN<a name='1353'>
          DRYCAN=1.-WETCAN<a name='1354'>
<a name='1355'>
<font color=#447700>!       print *,'CST,DRIP',cst,drip<a name='1356'></font>
<a name='1357'>
<font color=#447700>!**************************************************************<a name='1358'></font>
<font color=#447700>!  TRANSF computes transpiration function<a name='1359'></font>
<font color=#447700>!**************************************************************<a name='1360'></font>
           CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#TRANSF'>TRANSF</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRANSF_1">(                                       &amp;<a name='1361'>
<font color=#447700>!--- input variables<a name='1362'></font>
              nzs,nroot,soiliqw,                              &amp;<a name='1363'>
<font color=#447700>!--- soil fixed fields<a name='1364'></font>
              dqm,qmin,ref,wilt,zshalf,                       &amp;<a name='1365'>
<font color=#447700>!--- output variables<a name='1366'></font>
              tranf,transum)<a name='1367'>
<a name='1368'>
<a name='1369'>
<font color=#447700>!--- Save soil temp and moisture from the beginning of time step<a name='1370'></font>
          do k=1,nzs<a name='1371'>
           told(k)=tso(k)<a name='1372'>
           smold(k)=soilmois(k)<a name='1373'>
          enddo<a name='1374'>
<a name='1375'>
<font color=#447700>!**************************************************************<a name='1376'></font>
<font color=#447700>!  SOILTEMP soilves heat budget and diffusion eqn. in soil<a name='1377'></font>
<font color=#447700>!**************************************************************<a name='1378'></font>
<a name='1379'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILTEMP'>SOILTEMP</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILTEMP_1">(                                        &amp;<a name='1380'>
<font color=#447700>!--- input variables<a name='1381'></font>
             i,j,iland,isoil,                                 &amp;<a name='1382'>
             delt,ktau,conflx,nzs,nddzs,nroot,                &amp;<a name='1383'>
             PRCPMS,RAINF,                                    &amp;<a name='1384'>
             PATM,TABS,QVATM,QCATM,EMISS,RNET,                &amp;<a name='1385'>
             QKMS,TKMS,PC,rho,vegfrac,                        &amp;<a name='1386'>
             thdif,cap,drycan,wetcan,                         &amp; <a name='1387'>
             transum,dew,mavail,                              &amp;<a name='1388'>
<font color=#447700>!--- soil fixed fields<a name='1389'></font>
             dqm,qmin,bclh,zsmain,zshalf,DTDZS,tbq,           &amp;<a name='1390'>
<font color=#447700>!--- constants<a name='1391'></font>
             xlv,CP,G0_P,cvw,stbolt,                          &amp;<a name='1392'>
<font color=#447700>!--- output variables<a name='1393'></font>
             tso,soilt,qvg,qsg,qcg)<a name='1394'>
<a name='1395'>
<font color=#447700>!************************************************************************<a name='1396'></font>
<a name='1397'>
<font color=#447700>!--- CALCULATION OF DEW USING NEW VALUE OF QSG OR TRANSP IF NO DEW<a name='1398'></font>
        ETT1=0.<a name='1399'>
        DEW=0.<a name='1400'>
<a name='1401'>
        IF(QVATM.GE.QSG)THEN<a name='1402'>
          DEW=QKMS*(QVATM-QSG)<a name='1403'>
          DO K=1,NZS<a name='1404'>
            TRANSP(K)=0.<a name='1405'>
          ENDDO<a name='1406'>
        ELSE<a name='1407'>
          DO K=1,NROOT<a name='1408'>
            TRANSP(K)=VEGFRAC*RAS*QKMS*                       &amp;<a name='1409'>
                    (QVATM-QSG)*                              &amp;<a name='1410'>
                     PC*TRANF(K)*DRYCAN/ZSHALF(NROOT+1)<a name='1411'>
               IF(TRANSP(K).GT.0.) TRANSP(K)=0.<a name='1412'>
            ETT1=ETT1-TRANSP(K)<a name='1413'>
          ENDDO<a name='1414'>
          DO k=nroot+1,nzs<a name='1415'>
            transp(k)=0.<a name='1416'>
          enddo<a name='1417'>
        ENDIF<a name='1418'>
<a name='1419'>
<font color=#447700>!-- Recalculating of volumetric content of frozen water in soil<a name='1420'></font>
         DO K=1,NZS<a name='1421'>
<font color=#447700>!- main levels<a name='1422'></font>
           tln=log(tso(k)/273.15)<a name='1423'>
         if(tln.lt.0.) then<a name='1424'>
           soiliqw(k)=(dqm+qmin)*(XLMELT*                     &amp;<a name='1425'>
          (tso(k)-273.15)/tso(k)/9.81/psis)                   &amp; <a name='1426'>
           **(-1./bclh)-qmin<a name='1427'>
           soiliqw(k)=max(0.,soiliqw(k))<a name='1428'>
           soiliqw(k)=min(soiliqw(k),soilmois(k))<a name='1429'>
           soilice(k)=(soilmois(k)-soiliqw(k))/riw<a name='1430'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='1431'></font>
       if(keepfr(k).eq.1.) then<a name='1432'>
           soilice(k)=min(soilice(k),smfrkeep(k))<a name='1433'>
           soiliqw(k)=max(0.,soilmois(k)-soilice(k)*riw)<a name='1434'>
       endif<a name='1435'>
<a name='1436'>
         else<a name='1437'>
           soilice(k)=0.<a name='1438'>
           soiliqw(k)=soilmois(k)<a name='1439'>
         endif<a name='1440'>
         ENDDO<a name='1441'>
<a name='1442'>
       INFMAX=999.<a name='1443'>
<font color=#447700>!--- The threshold when the infiltration stops is:<a name='1444'></font>
<font color=#447700>!--- volumetric content of unfrozen pores  &lt; 0.12<a name='1445'></font>
       if((dqm+qmin-riw*soilicem(1)).lt.0.12)                 &amp;<a name='1446'>
               INFMAX=0.<a name='1447'>
<a name='1448'>
<font color=#447700>!*************************************************************************<a name='1449'></font>
<font color=#447700>! SOILMOIST solves moisture budget (EQ.22,28) and Richards eqn.<a name='1450'></font>
<font color=#447700>!*************************************************************************<a name='1451'></font>
          CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILMOIST'>SOILMOIST</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILMOIST_1"> (                                     &amp;<a name='1452'>
<font color=#447700>!-- input<a name='1453'></font>
               delt,nzs,nddzs,DTDZS,DTDZS2,                    &amp;<a name='1454'>
               zsmain,zshalf,diffu,hydro,                      &amp;<a name='1455'>
               QSG,QVG,QCG,QCATM,QVATM,-PRCPMS,                &amp;<a name='1456'>
               QKMS,TRANSP,DRIP,DEW,0.,SOILICE,VEGFRAC,        &amp;<a name='1457'>
<font color=#447700>!-- soil properties<a name='1458'></font>
               DQM,QMIN,REF,KSAT,RAS,INFMAX,                   &amp;<a name='1459'>
<font color=#447700>!-- output<a name='1460'></font>
               SOILMOIS,MAVAIL,RUNOFF1,                        &amp;<a name='1461'>
               RUNOFF2,INFILTRP)<a name='1462'>
        <a name='1463'>
<font color=#447700>!--- KEEPFR is 1 when the temperature and moisture in soil<a name='1464'></font>
<font color=#447700>!--- are both increasing. In this case soil ice should not<a name='1465'></font>
<font color=#447700>!--- be increasing according to the freezing curve.<a name='1466'></font>
<font color=#447700>!--- Some part of ice is melted, but additional water is<a name='1467'></font>
<font color=#447700>!--- getting frozen. Thus, only structure of frozen soil is<a name='1468'></font>
<font color=#447700>!--- changed, and phase changes are not affecting the heat<a name='1469'></font>
<font color=#447700>!--- transfer. This situation may happen when it rains on the<a name='1470'></font>
<font color=#447700>!--- frozen soil.<a name='1471'></font>
 <a name='1472'>
        do k=1,nzs<a name='1473'>
       if (soilice(k).gt.0.) then<a name='1474'>
          if(tso(k).gt.told(k).and.soilmois(k).gt.smold(k)) then<a name='1475'>
              keepfr(k)=1.<a name='1476'>
          else<a name='1477'>
              keepfr(k)=0.<a name='1478'>
          endif<a name='1479'>
       endif<a name='1480'>
        enddo<a name='1481'>
<font color=#447700>!--- THE DIAGNOSTICS OF SURFACE FLUXES <a name='1482'></font>
<a name='1483'>
          T3      = STBOLT*SOILT*SOILT*SOILT<a name='1484'>
          UPFLUX  = T3 *SOILT<a name='1485'>
          XINET   = EMISS*(GLW-UPFLUX)<a name='1486'>
          RNET    = GSW + XINET<a name='1487'>
          HFT=-TKMS*CP*RHO*(TABS-SOILT)<a name='1488'>
          Q1=-QKMS*RAS*(QVATM - QSG)<a name='1489'>
          EDIR1 =-(1.-vegfrac)*QKMS*RAS*                       &amp;<a name='1490'>
                       (QVATM-QVG)<a name='1491'>
        IF (Q1.LE.0.) THEN<a name='1492'>
<font color=#447700>! ---  condensation<a name='1493'></font>
          EC1=0.<a name='1494'>
          EDIR1=0.<a name='1495'>
          ETT1=0.<a name='1496'>
          EETA=0.<a name='1497'>
          QFX=- XLV*RHO*DEW<a name='1498'>
        ELSE<a name='1499'>
<font color=#447700>! ---  evaporation<a name='1500'></font>
          EC1 = Q1 * WETCAN<a name='1501'>
          CMC2MS=CST/DELT<a name='1502'>
         if(EC1.gt.CMC2MS) cst=0.<a name='1503'>
          EC1=MIN(CMC2MS,EC1)*vegfrac<a name='1504'>
          EETA = (EDIR1 + EC1 + ETT1)*1.E3<a name='1505'>
<font color=#447700>! to convert from kg m-2 s-1 to m s-1: 1/rho water=1.e-3************<a name='1506'></font>
          QFX= XLV * EETA<a name='1507'>
        ENDIF<a name='1508'>
          EVAPL=QFX/XLV<a name='1509'>
          S=THDIF(1)*CAP(1)*DZSTOP*(TSO(1)-TSO(2))<a name='1510'>
          HFX=HFT<a name='1511'>
          FLTOT=RNET-HFT-QFX-S<a name='1512'>
<a name='1513'>
 222    CONTINUE<a name='1514'>
<a name='1515'>
 1123    FORMAT(I5,8F12.3)<a name='1516'>
 1133    FORMAT(I7,8E12.4)<a name='1517'>
  123   format(i6,f6.2,7f8.1)<a name='1518'>
  122   FORMAT(1X,2I3,6F8.1,F8.3,F8.2)<a name='1519'>
<a name='1520'>
<a name='1521'>
<font color=#447700>!      RETURN                                                                 <a name='1522'></font>
<font color=#447700>!      END                                                                    <a name='1523'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='1524'></font>
   END SUBROUTINE SOIL<a name='1525'>
<font color=#447700>!-------------------------------------------------------------------<a name='1526'></font>
<a name='1527'>
<a name='1528'>
<A NAME='SNOWSOIL'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1529'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWSOIL</font> (                                  &amp; <A href='../../call_to/SNOWSOIL.html' TARGET='index'>1</A>,<A href='../../call_from/SNOWSOIL.html' TARGET='index'>6</A><a name='1530'>
<font color=#447700>!--- input variables<a name='1531'></font>
             i,j,isoil,delt,ktau,conflx,nzs,nddzs,nroot,       &amp;<a name='1532'>
             ILAND,PRCPMS,RAINF,NEWSNOW,snhei,SNWE,RHOSN,      &amp;<a name='1533'>
             PATM,QVATM,QCATM,                                 &amp;<a name='1534'>
             GLW,GSW,EMISS,RNET,IVGTYP,                        &amp;<a name='1535'>
             QKMS,TKMS,PC,cst,rho,vegfrac,alb,znt,             &amp; <a name='1536'>
<font color=#447700>!--- soil fixed fields<a name='1537'></font>
             QWRTZ,rhocs,dqm,qmin,ref,wilt,psis,bclh,ksat,     &amp;<a name='1538'>
             sat,cn,zsmain,zshalf,DTDZS,DTDZS2,tbq,            &amp;<a name='1539'>
<font color=#447700>!--- constants<a name='1540'></font>
             xlv,CP,G0_P,cw,stbolt,TABS,                       &amp;<a name='1541'>
             KQWRTZ,KICE,KWT,                                  &amp;<a name='1542'>
<font color=#447700>!--- output variables<a name='1543'></font>
             ilnb,snweprint,snheiprint,rsm,                    &amp;<a name='1544'>
             soilmois,tso,smfrkeep,keepfr,                     &amp;<a name='1545'>
             dew,soilt,soilt1,tsnav,                           &amp;<a name='1546'>
             qvg,qsg,qcg,SMELT,SNOH,SNFLX,SNOM,                &amp;<a name='1547'>
             edir1,ec1,ett1,eeta,qfx,hfx,s,sublim,             &amp;<a name='1548'>
             prcpl,runoff1,runoff2,mavail,soilice,             &amp;<a name='1549'>
             soiliqw,infiltrp                                  )<a name='1550'>
<a name='1551'>
<font color=#447700>!***************************************************************<a name='1552'></font>
<font color=#447700>!   Energy and moisture budget for snow, heat diffusion eqns.<a name='1553'></font>
<font color=#447700>!   in snow and soil, Richards eqn. for soil covered with snow<a name='1554'></font>
<font color=#447700>!<a name='1555'></font>
<font color=#447700>!     DELT - time step<a name='1556'></font>
<font color=#447700>!     ktau - numver of time step<a name='1557'></font>
<font color=#447700>!     CONFLX - depth of constant flux layer (m)<a name='1558'></font>
<font color=#447700>!     J,I - the location of grid point<a name='1559'></font>
<font color=#447700>!     IME, JME,  NZS - dimensions of the domain<a name='1560'></font>
<font color=#447700>!     NROOT - number of levels within the root zone<a name='1561'></font>
<font color=#447700>!     PRCPMS - precipitation rate in m/s<a name='1562'></font>
<font color=#447700>!     NEWSNOW - pcpn in soilid form (m)<a name='1563'></font>
<font color=#447700>!     SNHEI, SNWE - snow height and snow water equivalent (m)<a name='1564'></font>
<font color=#447700>!     RHOSN - snow density<a name='1565'></font>
<font color=#447700>!     PATM - pressure [bar]<a name='1566'></font>
<font color=#447700>!     QVATM,QCATM - cloud and water vapor mixing ratio<a name='1567'></font>
<font color=#447700>!                   at the first atm. level<a name='1568'></font>
<font color=#447700>!     GLW, GSW - incoming longwave and absorbed shortwave<a name='1569'></font>
<font color=#447700>!                radiation at the surface<a name='1570'></font>
<font color=#447700>!     EMISS,RNET - emissivity of the ground surface and net<a name='1571'></font>
<font color=#447700>!                  radiation at the surface<a name='1572'></font>
<font color=#447700>!     QKMS - exchange coefficient for water vapor in the<a name='1573'></font>
<font color=#447700>!              surface layer (m/s)<a name='1574'></font>
<font color=#447700>!     TKMS - exchange coefficient for heat in the surface<a name='1575'></font>
<font color=#447700>!              layer (m/s)<a name='1576'></font>
<font color=#447700>!     PC - plant coefficient (resistance)<a name='1577'></font>
<font color=#447700>!     RHO - density of atmosphere near sueface<a name='1578'></font>
<font color=#447700>!     VEGFRAC - greeness fraction<a name='1579'></font>
<font color=#447700>!     RHOCS - volumetric heat capacity of dry soil<a name='1580'></font>
<font color=#447700>!     DQM, QMIN - porosity minus residual soil moisture QMIN<a name='1581'></font>
<font color=#447700>!     REF, WILT - field capacity soil moisture and the<a name='1582'></font>
<font color=#447700>!                 wilting point<a name='1583'></font>
<font color=#447700>!     PSIS - matrix potential at saturation<a name='1584'></font>
<font color=#447700>!     BCLH - exponent for Clapp-Hornberger parameterization<a name='1585'></font>
<font color=#447700>!     KSAT - saturated hydraulic conductivity<a name='1586'></font>
<font color=#447700>!     SAT - maximum value of water intercepted by canopy<a name='1587'></font>
<font color=#447700>!     CN - exponent for calculation of canopy water<a name='1588'></font>
<font color=#447700>!     ZSMAIN - main levels in soil<a name='1589'></font>
<font color=#447700>!     ZSHALF - middle of the soil layers<a name='1590'></font>
<font color=#447700>!     DTDZS,DTDZS2 - dt/(2.*dzshalf*dzmain) and dt/dzshalf in soil<a name='1591'></font>
<font color=#447700>!     TBQ - table to define saturated mixing ration<a name='1592'></font>
<font color=#447700>!           of water vapor for given temperature and pressure<a name='1593'></font>
<font color=#447700>!     ilnb - number of layers in snow<a name='1594'></font>
<font color=#447700>!     rsm - liquid water inside snow pack (m)<a name='1595'></font>
<font color=#447700>!     SOILMOIS,TSO - soil moisture and temperature<a name='1596'></font>
<font color=#447700>!     DEW -  dew in kg/m^2s<a name='1597'></font>
<font color=#447700>!     SOILT - skin temperature (K)<a name='1598'></font>
<font color=#447700>!     SOILT1 - snow temperature at 7.5 cm depth (K)<a name='1599'></font>
<font color=#447700>!     TSNAV - average temperature of snow pack (C)<a name='1600'></font>
<font color=#447700>!     QSG,QVG,QCG - saturated mixing ratio, mixing ratio of<a name='1601'></font>
<font color=#447700>!                   water vapor and cloud at the ground<a name='1602'></font>
<font color=#447700>!                   surface, respectively<a name='1603'></font>
<font color=#447700>!     EDIR1, EC1, ETT1, EETA - direct evaporation, evaporation of<a name='1604'></font>
<font color=#447700>!            canopy water, transpiration in kg m-2 s-1 and total<a name='1605'></font>
<font color=#447700>!            evaporation in m s-1.<a name='1606'></font>
<font color=#447700>!     QFX, HFX - latent and sensible heat fluxes<a name='1607'></font>
<font color=#447700>!     S - soil heat flux in the top layer<a name='1608'></font>
<font color=#447700>!     SUBLIM - snow sublimation<a name='1609'></font>
<font color=#447700>!     RUNOFF1 - surface runoff (m/s)<a name='1610'></font>
<font color=#447700>!     RUNOFF2 - underground runoff (m)<a name='1611'></font>
<font color=#447700>!     MAVAIL - moisture availability in the top soil layer<a name='1612'></font>
<font color=#447700>!     SOILICE - content of soil ice in soil layers<a name='1613'></font>
<font color=#447700>!     SOILIQW - lliquid water in soil layers<a name='1614'></font>
<font color=#447700>!     INFILTRP - infiltration flux from the top of soil domain<a name='1615'></font>
<font color=#447700>!     XINET - net long-wave radiation<a name='1616'></font>
<font color=#447700>!<a name='1617'></font>
<font color=#447700>!*******************************************************************<a name='1618'></font>
<a name='1619'>
        IMPLICIT NONE<a name='1620'>
<font color=#447700>!-------------------------------------------------------------------<a name='1621'></font>
<font color=#447700>!--- input variables<a name='1622'></font>
<a name='1623'>
   INTEGER,  INTENT(IN   )   ::  nroot,ktau,nzs                , &amp;<a name='1624'>
                                 nddzs                         <font color=#447700>!nddzs=2*(nzs-2)<a name='1625'></font>
   INTEGER,  INTENT(IN   )   ::  i,j,isoil<a name='1626'>
<a name='1627'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX,PRCPMS            , &amp;<a name='1628'>
                                 RAINF,NEWSNOW<a name='1629'>
<a name='1630'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='1631'></font>
   REAL,                                                         &amp;<a name='1632'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='1633'>
                                                          QVATM, &amp;<a name='1634'>
                                                          QCATM<a name='1635'>
<font color=#447700>!--- 2-D variables<a name='1636'></font>
   REAL                                                        , &amp;<a name='1637'>
            INTENT(IN   )    ::                             GLW, &amp;<a name='1638'>
                                                            GSW, &amp;<a name='1639'>
                                                            RHO, &amp;<a name='1640'>
                                                             PC, &amp;<a name='1641'>
                                                        VEGFRAC, &amp;<a name='1642'>
                                                           QKMS, &amp;<a name='1643'>
                                                           TKMS<a name='1644'>
<a name='1645'>
   INTEGER,  INTENT(IN   )   ::                          IVGTYP<a name='1646'>
<font color=#447700>!--- soil properties<a name='1647'></font>
   REAL                                                        , &amp;<a name='1648'>
            INTENT(IN   )    ::                           RHOCS, &amp;<a name='1649'>
                                                           BCLH, &amp;<a name='1650'>
                                                            DQM, &amp;<a name='1651'>
                                                           KSAT, &amp;<a name='1652'>
                                                           PSIS, &amp;<a name='1653'>
                                                           QMIN, &amp;<a name='1654'>
                                                          QWRTZ, &amp;<a name='1655'>
                                                            REF, &amp;<a name='1656'>
                                                            SAT, &amp;<a name='1657'>
                                                           WILT<a name='1658'>
<a name='1659'>
   REAL,     INTENT(IN   )   ::                              CN, &amp;<a name='1660'>
                                                             CW, &amp;<a name='1661'>
                                                            XLV, &amp;<a name='1662'>
                                                           G0_P, &amp; <a name='1663'>
                                                         KQWRTZ, &amp;<a name='1664'>
                                                           KICE, &amp;<a name='1665'>
                                                            KWT <a name='1666'>
<a name='1667'>
<a name='1668'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='1669'>
                                                         ZSHALF, &amp;<a name='1670'>
                                                         DTDZS2<a name='1671'>
<a name='1672'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='1673'>
<a name='1674'>
   REAL,     DIMENSION(1:4001), INTENT(IN)  ::              TBQ<a name='1675'>
<a name='1676'>
<a name='1677'>
<font color=#447700>!--- input/output variables<a name='1678'></font>
<font color=#447700>!-------- 3-d soil moisture and temperature<a name='1679'></font>
   REAL,     DIMENSION(  1:nzs )                               , &amp;<a name='1680'>
             INTENT(INOUT)   ::                             TSO, &amp;<a name='1681'>
                                                       SOILMOIS, &amp;<a name='1682'>
                                                       SMFRKEEP<a name='1683'>
<a name='1684'>
   REAL,  DIMENSION( 1:nzs )                                   , &amp;<a name='1685'>
             INTENT(INOUT)   ::                          KEEPFR<a name='1686'>
<a name='1687'>
<a name='1688'>
   INTEGER,  INTENT(INOUT)    ::                           ILAND<a name='1689'>
<a name='1690'>
<a name='1691'>
<font color=#447700>!-------- 2-d variables<a name='1692'></font>
   REAL                                                        , &amp;<a name='1693'>
             INTENT(INOUT)   ::                             DEW, &amp;<a name='1694'>
                                                            CST, &amp;<a name='1695'>
                                                          EDIR1, &amp;<a name='1696'>
                                                            EC1, &amp;<a name='1697'>
                                                           ETT1, &amp;<a name='1698'>
                                                           EETA, &amp;<a name='1699'>
                                                          RHOSN, &amp;<a name='1700'>
                                                         SUBLIM, &amp;<a name='1701'>
                                                          PRCPL, &amp;<a name='1702'>
                                                            ALB, &amp;<a name='1703'>
                                                          EMISS, &amp;<a name='1704'>
                                                            ZNT, &amp;<a name='1705'>
                                                         MAVAIL, &amp;<a name='1706'>
                                                            QVG, &amp;<a name='1707'>
                                                            QSG, &amp;<a name='1708'>
                                                            QCG, &amp;<a name='1709'>
                                                            QFX, &amp;<a name='1710'>
                                                            HFX, &amp;<a name='1711'>
                                                              S, &amp;<a name='1712'>
                                                        RUNOFF1, &amp;<a name='1713'>
                                                        RUNOFF2, &amp;<a name='1714'>
                                                           SNWE, &amp;<a name='1715'>
                                                          SNHEI, &amp;<a name='1716'>
                                                          SMELT, &amp;<a name='1717'>
                                                           SNOM, &amp;<a name='1718'>
                                                           SNOH, &amp;<a name='1719'>
                                                          SNFLX, &amp;<a name='1720'>
                                                          SOILT, &amp;<a name='1721'>
                                                         SOILT1, &amp;<a name='1722'>
                                                          TSNAV<a name='1723'>
<a name='1724'>
   INTEGER, INTENT(INOUT)    ::                            ILNB<a name='1725'>
<a name='1726'>
<font color=#447700>!-------- 1-d variables<a name='1727'></font>
   REAL,     DIMENSION(1:NZS), INTENT(OUT)  ::          SOILICE, &amp;<a name='1728'>
                                                        SOILIQW<a name='1729'>
<a name='1730'>
   REAL,     INTENT(OUT)                    ::              RSM, &amp;<a name='1731'>
                                                      SNWEPRINT, &amp;<a name='1732'>
                                                     SNHEIPRINT<a name='1733'>
<font color=#447700>!--- Local variables<a name='1734'></font>
<a name='1735'>
<a name='1736'>
   INTEGER ::  nzs1,nzs2,k<a name='1737'>
<a name='1738'>
   REAL    ::  INFILTRP, RHONEWSN,TRANSUM                      , &amp;<a name='1739'>
               SNTH, NEWSN                                     , &amp;<a name='1740'>
               TABS, T3, UPFLUX, XINET                         , &amp;<a name='1741'>
               BETA, SNWEPR,EPDT,PP<a name='1742'>
   REAL    ::  CP,G0,LV,xlvm,STBOLT,xlmelt,dzstop              , &amp;<a name='1743'>
               can,epot,fac,fltot,ft,fq,hft                    , &amp;<a name='1744'>
               q1,ras,rhoice,sph                               , &amp;<a name='1745'>
               trans,zn,ci,cvw,tln,tavln,pi                    , &amp;<a name='1746'>
               DD1,CMC2MS,DRYCAN,WETCAN                        , &amp;<a name='1747'>
               INFMAX,RIW,DELTSN,H,UMVEG<a name='1748'>
<a name='1749'>
   REAL,     DIMENSION(1:NZS)  ::  transp,cap,diffu,hydro      , &amp;<a name='1750'>
                                   thdif,tranf,tav,soilmoism   , &amp;<a name='1751'>
                                   soilicem,soiliqwm,detal     , &amp;<a name='1752'>
                                   fwsat,lwsat,told,smold<a name='1753'>
   REAL                                     ::             drip<a name='1754'>
<a name='1755'>
   REAL                                     ::             RNET<a name='1756'>
<a name='1757'>
<font color=#447700>!-----------------------------------------------------------------<a name='1758'></font>
<a name='1759'>
        cvw=cw<a name='1760'>
        XLMELT=3.335E+5<a name='1761'>
<font color=#447700>!-- the next line calculates heat of sublimation of water vapor<a name='1762'></font>
        XLVm=XLV+XLMELT<a name='1763'>
<font color=#447700>!        STBOLT=5.670151E-8<a name='1764'></font>
<a name='1765'>
<font color=#447700>!--- SNOW flag -- 99<a name='1766'></font>
         ILAND=99<a name='1767'>
<a name='1768'>
<font color=#447700>!--- DELTSN - is the threshold for splitting the snow layer into 2 layers.<a name='1769'></font>
<font color=#447700>!--- With snow density 400 kg/m^3, this threshold is equal to 7.5 cm,<a name='1770'></font>
<font color=#447700>!--- equivalent to 0.03 m SNWE. For other snow densities the threshold is<a name='1771'></font>
<font color=#447700>!--- computed using SNWE=0.03 m and current snow density.<a name='1772'></font>
<font color=#447700>!--- SNTH - the threshold below which the snow layer is combined with<a name='1773'></font>
<font color=#447700>!--- the top soil layer. SNTH is computed using snwe=0.016 m, and<a name='1774'></font>
<font color=#447700>!--- equals 4 cm for snow density 400 kg/m^3.<a name='1775'></font>
<a name='1776'>
           DELTSN=0.0301*1.e3/rhosn<a name='1777'>
           snth=0.01601*1.e3/rhosn<a name='1778'>
<a name='1779'>
        RHOICE=900.<a name='1780'>
        CI=RHOICE*2100.<a name='1781'>
        RAS=RHO*1.E-3<a name='1782'>
        RIW=rhoice*1.e-3<a name='1783'>
        MAVAIL=1.<a name='1784'>
        RSM=0.<a name='1785'>
<a name='1786'>
        DO K=1,NZS<a name='1787'>
          TRANSP     (K)=0.<a name='1788'>
          soilmoism  (k)=0.<a name='1789'>
          soiliqwm   (k)=0.<a name='1790'>
          soilice    (k)=0.<a name='1791'>
          soilicem   (k)=0.<a name='1792'>
          lwsat      (k)=0.<a name='1793'>
          fwsat      (k)=0.<a name='1794'>
          tav        (k)=0.<a name='1795'>
          cap        (k)=0.<a name='1796'>
          diffu      (k)=0.<a name='1797'>
          hydro      (k)=0.<a name='1798'>
          thdif      (k)=0.  <a name='1799'>
          tranf      (k)=0.<a name='1800'>
          detal      (k)=0.<a name='1801'>
          told       (k)=0.<a name='1802'>
          smold      (k)=0. <a name='1803'>
        ENDDO<a name='1804'>
<a name='1805'>
        snweprint=0.<a name='1806'>
        snheiprint=0.<a name='1807'>
        prcpl=prcpms<a name='1808'>
<a name='1809'>
<font color=#447700>!*** DELTSN is the depth of the top layer of snow where<a name='1810'></font>
<font color=#447700>!*** there is a temperature gradient, the rest of the snow layer<a name='1811'></font>
<font color=#447700>!*** is considered to have constant temperature<a name='1812'></font>
<a name='1813'>
<a name='1814'>
          NZS1=NZS-1<a name='1815'>
          NZS2=NZS-2<a name='1816'>
        DZSTOP=1./(zsmain(2)-zsmain(1))<a name='1817'>
<a name='1818'>
<font color=#447700>!----- THE CALCULATION OF THERMAL DIFFUSIVITY, DIFFUSIONAL AND ---<a name='1819'></font>
<font color=#447700>!----- HYDRAULIC CONDUCTIVITY (SMIRNOVA ET AL. 1996? EQ.2,5,6) ---<a name='1820'></font>
<font color=#447700>!tgs - the following loop is added to define the amount of frozen<a name='1821'></font>
<font color=#447700>!tgs - water in soil if ther is any<a name='1822'></font>
         DO K=1,NZS<a name='1823'>
<a name='1824'>
         tln=log(tso(k)/273.15)<a name='1825'>
         if(tln.lt.0.) then<a name='1826'>
           soiliqw(k)=(dqm+qmin)*(XLMELT*                          &amp;<a name='1827'>
         (tso(k)-273.15)/tso(k)/9.81/psis)                         &amp;<a name='1828'>
          **(-1./bclh)-qmin<a name='1829'>
           soiliqw(k)=max(0.,soiliqw(k))<a name='1830'>
           soiliqw(k)=min(soiliqw(k),soilmois(k))<a name='1831'>
           soilice(k)=(soilmois(k)-soiliqw(k))/riw<a name='1832'>
<a name='1833'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='1834'></font>
       if(keepfr(k).eq.1.) then<a name='1835'>
           soilice(k)=min(soilice(k),smfrkeep(k))<a name='1836'>
           soiliqw(k)=max(0.,soilmois(k)-soilice(k)*rhoice*1.e-3)<a name='1837'>
       endif<a name='1838'>
<a name='1839'>
         else<a name='1840'>
           soilice(k)=0.<a name='1841'>
           soiliqw(k)=soilmois(k)<a name='1842'>
         endif<a name='1843'>
<a name='1844'>
          ENDDO<a name='1845'>
<a name='1846'>
          DO K=1,NZS1<a name='1847'>
<a name='1848'>
         tav(k)=0.5*(tso(k)+tso(k+1))<a name='1849'>
         soilmoism(k)=0.5*(soilmois(k)+soilmois(k+1))<a name='1850'>
         tavln=log(tav(k)/273.15)<a name='1851'>
<a name='1852'>
         if(tavln.lt.0.) then<a name='1853'>
           soiliqwm(k)=(dqm+qmin)*(XLMELT*                         &amp;<a name='1854'>
         (tav(k)-273.15)/tav(k)/9.81/psis)                         &amp;<a name='1855'>
          **(-1./bclh)-qmin<a name='1856'>
           fwsat(k)=dqm-soiliqwm(k)<a name='1857'>
           lwsat(k)=soiliqwm(k)+qmin<a name='1858'>
           soiliqwm(k)=max(0.,soiliqwm(k))<a name='1859'>
           soiliqwm(k)=min(soiliqwm(k), soilmoism(k))<a name='1860'>
           soilicem(k)=(soilmoism(k)-soiliqwm(k))/riw<a name='1861'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='1862'></font>
       if(keepfr(k).eq.1.) then<a name='1863'>
           soilicem(k)=min(soilicem(k),                            &amp;<a name='1864'>
                    0.5*(smfrkeep(k)+smfrkeep(k+1)))<a name='1865'>
           soiliqwm(k)=max(0.,soilmoism(k)-soilicem(k)*riw)<a name='1866'>
           fwsat(k)=dqm-soiliqwm(k)<a name='1867'>
           lwsat(k)=soiliqwm(k)+qmin<a name='1868'>
       endif<a name='1869'>
<a name='1870'>
         else<a name='1871'>
           soilicem(k)=0.<a name='1872'>
           soiliqwm(k)=soilmoism(k)<a name='1873'>
           lwsat(k)=dqm+qmin<a name='1874'>
           fwsat(k)=0.<a name='1875'>
<a name='1876'>
         endif<a name='1877'>
          ENDDO<a name='1878'>
<a name='1879'>
          do k=1,nzs<a name='1880'>
           if(soilice(k).gt.0.) then<a name='1881'>
             smfrkeep(k)=soilice(k)<a name='1882'>
           else<a name='1883'>
             smfrkeep(k)=soilmois(k)/riw<a name='1884'>
           endif<a name='1885'>
          enddo<a name='1886'>
<a name='1887'>
<a name='1888'>
<font color=#447700>!         print *,'etaf,etal,etamf,etaml,lwsat,fwsat',<a name='1889'></font>
<font color=#447700>!     1      soilice,soiliqw,soilicem,soiliqwm,lwsat,fwsat<a name='1890'></font>
<a name='1891'>
<font color=#447700>!******************************************************************<a name='1892'></font>
<font color=#447700>! SOILPROP computes thermal diffusivity, and diffusional and<a name='1893'></font>
<font color=#447700>!          hydraulic condeuctivities<a name='1894'></font>
<font color=#447700>!******************************************************************<a name='1895'></font>
          CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILPROP'>SOILPROP</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILPROP_2">(                                         &amp;<a name='1896'>
<font color=#447700>!--- input variables<a name='1897'></font>
               nzs,fwsat,lwsat,tav,keepfr,                       &amp;<a name='1898'>
               soilmois,soiliqw,soilice,                         &amp;<a name='1899'>
               soilmoism,soiliqwm,soilicem,                      &amp;<a name='1900'>
<font color=#447700>!--- soil fixed fields<a name='1901'></font>
               QWRTZ,rhocs,dqm,qmin,psis,bclh,ksat,              &amp; <a name='1902'>
<font color=#447700>!--- constants<a name='1903'></font>
               riw,xlmelt,CP,G0_P,cvw,ci,                        &amp;<a name='1904'>
               kqwrtz,kice,kwt,                                  &amp;<a name='1905'>
<font color=#447700>!--- output variables<a name='1906'></font>
               thdif,diffu,hydro,cap)<a name='1907'>
<a name='1908'>
<font color=#447700>!******************************************************************** <a name='1909'></font>
<font color=#447700>!--- CALCULATION OF CANOPY WATER (EQ.16) AND DEW <a name='1910'></font>
 <a name='1911'>
        DRIP=0.<a name='1912'>
        SMELT=0.<a name='1913'>
        DD1=0.<a name='1914'>
        H=1.<a name='1915'>
<a name='1916'>
        FQ=QKMS<a name='1917'>
<a name='1918'>
<a name='1919'>
<font color=#447700>!--- If vegfrac.ne.0. then part of falling snow can be<a name='1920'></font>
<font color=#447700>!--- intercepted by the canopy. <a name='1921'></font>
<a name='1922'>
        DEW=0.<a name='1923'>
        UMVEG=1.-vegfrac<a name='1924'>
        EPOT = -FQ*(QVATM-QSG) <a name='1925'>
<a name='1926'>
      IF(vegfrac.EQ.0.) then<a name='1927'>
           cst=0.<a name='1928'>
           drip=0.<a name='1929'>
      ELSE<a name='1930'>
       IF(EPOT.GE.0.) THEN<a name='1931'>
<font color=#447700>! Evaporation<a name='1932'></font>
         DD1=CST+(NEWSNOW*RHOSN*1.E-3                            &amp;<a name='1933'>
              -DELT*(-PRCPMS+RAS*EPOT                            &amp;<a name='1934'>
              *(CST/SAT)**CN)) *vegfrac<a name='1935'>
        ELSE<a name='1936'>
<font color=#447700>! Sublimation<a name='1937'></font>
         DEW = - EPOT<a name='1938'>
         DD1=CST+(NEWSNOW*RHOSN*1.E-3+delt*(PRCPMS               &amp;<a name='1939'>
                     +DEW*RAS)) *vegfrac<a name='1940'>
       ENDIF<a name='1941'>
<a name='1942'>
        IF(DD1.LT.0.) DD1=0.<a name='1943'>
      IF (vegfrac.GT.0.) THEN<a name='1944'>
          CST=DD1<a name='1945'>
        IF(CST.GT.SAT) THEN<a name='1946'>
          CST=SAT<a name='1947'>
          DRIP=DD1-SAT<a name='1948'>
        ENDIF<a name='1949'>
      ENDIF<a name='1950'>
<a name='1951'>
<a name='1952'>
<font color=#447700>!--- In SFCTMP NEWSNOW is added to SNHEI as if there is no vegetation<a name='1953'></font>
<font color=#447700>!--- With vegetation part of NEWSNOW can be intercepted by canopy until<a name='1954'></font>
<font color=#447700>!--- the saturation is reached. After the canopy saturation is reached<a name='1955'></font>
<font color=#447700>!--- DRIP in the solid form will be added to SNOW cover.<a name='1956'></font>
<a name='1957'>
   SNWE=(SNHEI-vegfrac*NEWSNOW)*RHOSN*1.E-3                      &amp;<a name='1958'>
                  + DRIP<a name='1959'>
<a name='1960'>
       ENDIF<a name='1961'>
 <a name='1962'>
        DRIP=0.<a name='1963'>
        SNHEI=SNWE*1.e3/RHOSN<a name='1964'>
          SNWEPR=SNWE<a name='1965'>
<a name='1966'>
<font color=#447700>!  check if all snow can evaporate during DT<a name='1967'></font>
         BETA=1.<a name='1968'>
         EPDT = EPOT * RAS *DELT*UMVEG<a name='1969'>
         IF(SNWEPR.LE.EPDT) THEN <a name='1970'>
            BETA=SNWEPR/max(1.e-8,EPDT)<a name='1971'>
            SNWE=0.<a name='1972'>
            SNHEI=0.<a name='1973'>
         ENDIF<a name='1974'>
<a name='1975'>
          WETCAN=(CST/SAT)**CN<a name='1976'>
          DRYCAN=1.-WETCAN<a name='1977'>
<a name='1978'>
<font color=#447700>!**************************************************************<a name='1979'></font>
<font color=#447700>!  TRANSF computes transpiration function<a name='1980'></font>
<font color=#447700>!**************************************************************<a name='1981'></font>
           CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#TRANSF'>TRANSF</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRANSF_2">(                                       &amp;<a name='1982'>
<font color=#447700>!--- input variables<a name='1983'></font>
              nzs,nroot,soiliqw,                              &amp;<a name='1984'>
<font color=#447700>!--- soil fixed fields<a name='1985'></font>
              dqm,qmin,ref,wilt,zshalf,                       &amp; <a name='1986'>
<font color=#447700>!--- output variables<a name='1987'></font>
              tranf,transum)<a name='1988'>
<a name='1989'>
<font color=#447700>!--- Save soil temp and moisture from the beginning of time step<a name='1990'></font>
          do k=1,nzs<a name='1991'>
           told(k)=tso(k)<a name='1992'>
           smold(k)=soilmois(k)<a name='1993'>
          enddo<a name='1994'>
<a name='1995'>
<font color=#447700>!**************************************************************<a name='1996'></font>
<font color=#447700>! SOILTEMP soilves heat budget and diffusion eqn. in soil<a name='1997'></font>
<font color=#447700>!**************************************************************<a name='1998'></font>
<a name='1999'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2000'>
print *, 'TSO before calling SNOWTEMP: ', tso<a name='2001'>
    ENDIF<a name='2002'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWTEMP'>SNOWTEMP</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWTEMP_1">(                                        &amp;<a name='2003'>
<font color=#447700>!--- input variables<a name='2004'></font>
             i,j,iland,isoil,                                 &amp;<a name='2005'>
             delt,ktau,conflx,nzs,nddzs,nroot,                &amp;<a name='2006'>
             snwe,snwepr,snhei,newsnow,                       &amp;<a name='2007'>
             beta,deltsn,snth,rhosn,                          &amp;<a name='2008'>
             PRCPMS,RAINF,                                    &amp;<a name='2009'>
             PATM,TABS,QVATM,QCATM,                           &amp;<a name='2010'>
             GLW,GSW,EMISS,RNET,                              &amp;<a name='2011'>
             QKMS,TKMS,PC,rho,vegfrac,                        &amp;<a name='2012'>
             thdif,cap,drycan,wetcan,cst,                     &amp;<a name='2013'>
             tranf,transum,dew,mavail,                        &amp;<a name='2014'>
<font color=#447700>!--- soil fixed fields<a name='2015'></font>
             dqm,qmin,psis,bclh,                              &amp;<a name='2016'>
             zsmain,zshalf,DTDZS,tbq,                         &amp;<a name='2017'>
<font color=#447700>!--- constants<a name='2018'></font>
             xlvm,CP,G0_P,cvw,stbolt,                         &amp;<a name='2019'>
<font color=#447700>!--- output variables<a name='2020'></font>
             snweprint,snheiprint,rsm,                        &amp;<a name='2021'>
             tso,soilt,soilt1,tsnav,qvg,qsg,qcg,              &amp;<a name='2022'>
             smelt,snoh,snflx,ilnb)<a name='2023'>
<a name='2024'>
<font color=#447700>!************************************************************************<a name='2025'></font>
<font color=#447700>!--- RECALCULATION OF DEW USING NEW VALUE OF QSG OR TRANSP IF NO DEW<a name='2026'></font>
         DEW=0.<a name='2027'>
         ETT1=0.<a name='2028'>
         PP=PATM*1.E3<a name='2029'>
         QSG= <A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN'>QSN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSN_3">(SOILT,TBQ)/PP<a name='2030'>
         EPOT = -FQ*(QVATM-QSG)<a name='2031'>
       IF(EPOT.GE.0.) THEN<a name='2032'>
<font color=#447700>! Evaporation<a name='2033'></font>
          DO K=1,NROOT<a name='2034'>
            TRANSP(K)=vegfrac*RAS*FQ*(QVATM-QSG)              &amp;<a name='2035'>
                     *PC*tranf(K)*DRYCAN/zshalf(NROOT+1)<a name='2036'>
           IF(TRANSP(K).GT.0.) TRANSP(K)=0.<a name='2037'>
            ETT1=ETT1-TRANSP(K)<a name='2038'>
          ENDDO<a name='2039'>
          DO k=nroot+1,nzs<a name='2040'>
            transp(k)=0.<a name='2041'>
          enddo<a name='2042'>
<a name='2043'>
        ELSE<a name='2044'>
<font color=#447700>! Sublimation<a name='2045'></font>
          DEW=-EPOT<a name='2046'>
          DO K=1,NZS<a name='2047'>
            TRANSP(K)=0.<a name='2048'>
          ENDDO<a name='2049'>
        ETT1=0.<a name='2050'>
        ENDIF<a name='2051'>
<a name='2052'>
<font color=#447700>!-- recalculating of frozen water in soil<a name='2053'></font>
         DO K=1,NZS<a name='2054'>
         tln=log(tso(k)/273.15)<a name='2055'>
         if(tln.lt.0.) then<a name='2056'>
           soiliqw(k)=(dqm+qmin)*(XLMELT*                    &amp;<a name='2057'>
         (tso(k)-273.15)/tso(k)/9.81/psis)                   &amp;<a name='2058'>
          **(-1./bclh)-qmin<a name='2059'>
           soiliqw(k)=max(0.,soiliqw(k))<a name='2060'>
           soiliqw(k)=min(soiliqw(k),soilmois(k))<a name='2061'>
           soilice(k)=(soilmois(k)-soiliqw(k))/riw<a name='2062'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='2063'></font>
       if(keepfr(k).eq.1.) then<a name='2064'>
           soilice(k)=min(soilice(k),smfrkeep(k))<a name='2065'>
           soiliqw(k)=max(0.,soilmois(k)-soilice(k)*riw)<a name='2066'>
       endif<a name='2067'>
<a name='2068'>
         else<a name='2069'>
           soilice(k)=0.<a name='2070'>
           soiliqw(k)=soilmois(k)<a name='2071'>
         endif<a name='2072'>
         ENDDO<a name='2073'>
<a name='2074'>
       INFMAX=999.<a name='2075'>
<font color=#447700>!--- The threshold when the infiltration stops is:<a name='2076'></font>
<font color=#447700>!--- volumetric content of unfrozen pores  &lt; 0.12<a name='2077'></font>
        soilicem(1)=0.5*(soilice(1)+soilice(2))<a name='2078'>
       if((dqm+qmin-riw*soilicem(1)).lt.0.12)                &amp;<a name='2079'>
               INFMAX=0.<a name='2080'>
<a name='2081'>
<font color=#447700>!*************************************************************************<a name='2082'></font>
<font color=#447700>!--- TQCAN FOR SOLUTION OF MOISTURE BALANCE EQ.22,28 AND TSO,ETA PROFILES<a name='2083'></font>
<font color=#447700>!*************************************************************************<a name='2084'></font>
                CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILMOIST'>SOILMOIST</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILMOIST_2"> (                                   &amp;<a name='2085'>
<font color=#447700>!-- input<a name='2086'></font>
               delt,nzs,nddzs,DTDZS,DTDZS2,                        &amp;<a name='2087'>
               zsmain,zshalf,diffu,hydro,                          &amp;<a name='2088'>
               QSG,QVG,QCG,QCATM,QVATM,-PRCPMS,                    &amp;<a name='2089'>
               0.,TRANSP,0.,                                       &amp;<a name='2090'>
               0.,SMELT,soilice,vegfrac,                           &amp;<a name='2091'>
<font color=#447700>!-- soil properties<a name='2092'></font>
               DQM,QMIN,REF,KSAT,RAS,INFMAX,                       &amp;<a name='2093'>
<font color=#447700>!-- output<a name='2094'></font>
               soilmois,MAVAIL,RUNOFF1,                            &amp;<a name='2095'>
               RUNOFF2,infiltrp) <a name='2096'>
 <a name='2097'>
<font color=#447700>!-- Restore land-use parameters if snow is less than threshold<a name='2098'></font>
         IF(SNHEI.LE.2.E-2)  then<a name='2099'>
          tsnav=soilt-273.15<a name='2100'>
          CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWFREE'>SNOWFREE</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWFREE_1">(ivgtyp,emiss,                              &amp; <a name='2101'>
                        znt,iland)<a name='2102'>
          smelt=smelt+snwe/delt<a name='2103'>
<font color=#447700>!          snwe=0.<a name='2104'></font>
         ENDIF<a name='2105'>
<a name='2106'>
        SNOM=SNOM+SMELT*DELT<a name='2107'>
<a name='2108'>
<font color=#447700>!--- KEEPFR is 1 when the temperature and moisture in soil<a name='2109'></font>
<font color=#447700>!--- are both increasing. In this case soil ice should not<a name='2110'></font>
<font color=#447700>!--- be increasing according to the freezing curve.<a name='2111'></font>
<font color=#447700>!--- Some part of ice is melted, but additional water is<a name='2112'></font>
<font color=#447700>!--- getting frozen. Thus, only structure of frozen soil is<a name='2113'></font>
<font color=#447700>!--- changed, and phase changes are not affecting the heat<a name='2114'></font>
<font color=#447700>!--- transfer. This situation may happen when it rains on the<a name='2115'></font>
<font color=#447700>!--- frozen soil.<a name='2116'></font>
<a name='2117'>
        do k=1,nzs<a name='2118'>
       if (soilice(k).gt.0.) then<a name='2119'>
          if(tso(k).gt.told(k).and.soilmois(k).gt.smold(k)) then<a name='2120'>
              keepfr(k)=1.<a name='2121'>
          else<a name='2122'>
              keepfr(k)=0.<a name='2123'>
          endif<a name='2124'>
       endif<a name='2125'>
        enddo<a name='2126'>
<font color=#447700>!--- THE DIAGNOSTICS OF SURFACE FLUXES<a name='2127'></font>
<a name='2128'>
        T3      = STBOLT*SOILT*SOILT*SOILT<a name='2129'>
        UPFLUX  = T3 *SOILT<a name='2130'>
        XINET   = EMISS*(GLW-UPFLUX)   <a name='2131'>
        RNET    = GSW + XINET<a name='2132'>
        HFT=- TKMS*CP*RHO*(TABS-SOILT)<a name='2133'>
        Q1 = - FQ*RAS* (QVATM - QSG)<a name='2134'>
        EDIR1 = Q1*UMVEG *BETA<a name='2135'>
<a name='2136'>
        IF (Q1.LT.0.) THEN<a name='2137'>
<font color=#447700>! ---  condensation<a name='2138'></font>
         EC1=0.<a name='2139'>
         EDIR1=0.<a name='2140'>
         ETT1=0.<a name='2141'>
         EETA=0.<a name='2142'>
         DEW=FQ*(QVATM-QSG)<a name='2143'>
        QFX= -XLVm*RHO*DEW<a name='2144'>
        sublim=QFX/XLVm<a name='2145'>
       ELSE<a name='2146'>
<font color=#447700>! ---  evaporation<a name='2147'></font>
        EC1 = Q1 * WETCAN <a name='2148'>
        CMC2MS=CST/DELT <a name='2149'>
        if(EC1.gt.CMC2MS) cst=0.<a name='2150'>
        EC1=MIN(CMC2MS,EC1)*vegfrac<a name='2151'>
        EETA = (EDIR1 + EC1 + ETT1)*1.E3<a name='2152'>
<font color=#447700>! to convert from kg m-2 s-1 to m s-1: 1/rho water=1.e-3************<a name='2153'></font>
        QFX= XLVm * EETA<a name='2154'>
        sublim=(EDIR1 + EC1)*1.E3<a name='2155'>
       ENDIF<a name='2156'>
        s=THDIF(1)*CAP(1)*dzstop*(tso(1)-tso(2))<a name='2157'>
        HFX=HFT<a name='2158'>
        FLTOT=RNET-HFT-QFX-S<a name='2159'>
<a name='2160'>
 222     CONTINUE<a name='2161'>
<a name='2162'>
 1123    FORMAT(I5,8F12.3)<a name='2163'>
 1133    FORMAT(I7,8E12.4)<a name='2164'>
  123   format(i6,f6.2,7f8.1)<a name='2165'>
 122    FORMAT(1X,2I3,6F8.1,F8.3,F8.2)<a name='2166'>
<a name='2167'>
<a name='2168'>
<font color=#447700>!      RETURN                                                                 <a name='2169'></font>
<font color=#447700>!      END                                                                    <a name='2170'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='2171'></font>
   END SUBROUTINE SNOWSOIL<a name='2172'>
<font color=#447700>!-------------------------------------------------------------------<a name='2173'></font>
<a name='2174'>
<a name='2175'>
<A NAME='SOILTEMP'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILTEMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2176'>
           <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOILTEMP</font>(                             &amp; <A href='../../call_to/SOILTEMP.html' TARGET='index'>1</A>,<A href='../../call_from/SOILTEMP.html' TARGET='index'>2</A><a name='2177'>
<font color=#447700>!--- input variables<a name='2178'></font>
           i,j,iland,isoil,                                 &amp;<a name='2179'>
           delt,ktau,conflx,nzs,nddzs,nroot,                &amp;<a name='2180'>
           PRCPMS,RAINF,PATM,TABS,QVATM,QCATM,              &amp;<a name='2181'>
           EMISS,RNET,                                      &amp;<a name='2182'>
           QKMS,TKMS,PC,RHO,VEGFRAC,                        &amp;<a name='2183'>
           THDIF,CAP,DRYCAN,WETCAN,                         &amp;<a name='2184'>
           TRANSUM,DEW,MAVAIL,                              &amp;<a name='2185'>
<font color=#447700>!--- soil fixed fields<a name='2186'></font>
           DQM,QMIN,BCLH,                                   &amp;<a name='2187'>
           ZSMAIN,ZSHALF,DTDZS,TBQ,                         &amp;<a name='2188'>
<font color=#447700>!--- constants<a name='2189'></font>
           XLV,CP,G0_P,CVW,STBOLT,                          &amp;<a name='2190'>
<font color=#447700>!--- output variables<a name='2191'></font>
           TSO,SOILT,QVG,QSG,QCG)<a name='2192'>
<a name='2193'>
<font color=#447700>!*************************************************************<a name='2194'></font>
<font color=#447700>!   Energy budget equation and heat diffusion eqn are <a name='2195'></font>
<font color=#447700>!   solved here and<a name='2196'></font>
<font color=#447700>!<a name='2197'></font>
<font color=#447700>!     DELT - time step<a name='2198'></font>
<font color=#447700>!     ktau - numver of time step<a name='2199'></font>
<font color=#447700>!     CONFLX - depth of constant flux layer (m)<a name='2200'></font>
<font color=#447700>!     IME, JME, KME, NZS - dimensions of the domain <a name='2201'></font>
<font color=#447700>!     NROOT - number of levels within the root zone<a name='2202'></font>
<font color=#447700>!     PRCPMS - precipitation rate in m/s<a name='2203'></font>
<font color=#447700>!     COTSO, RHTSO - coefficients for implicit solution of<a name='2204'></font>
<font color=#447700>!                     heat diffusion equation<a name='2205'></font>
<font color=#447700>!     THDIF - thermal diffusivity<a name='2206'></font>
<font color=#447700>!     QSG,QVG,QCG - saturated mixing ratio, mixing ratio of<a name='2207'></font>
<font color=#447700>!                   water vapor and cloud at the ground<a name='2208'></font>
<font color=#447700>!                   surface, respectively<a name='2209'></font>
<font color=#447700>!     PATM -  pressure [baa]<a name='2210'></font>
<font color=#447700>!     QC3D,QV3D - cloud and water vapor mixing ratio<a name='2211'></font>
<font color=#447700>!                   at the first atm. level<a name='2212'></font>
<font color=#447700>!     EMISS,RNET - emissivity of the ground surface and net<a name='2213'></font>
<font color=#447700>!                  radiation at the surface<a name='2214'></font>
<font color=#447700>!     QKMS - exchange coefficient for water vapor in the<a name='2215'></font>
<font color=#447700>!              surface layer (m/s)<a name='2216'></font>
<font color=#447700>!     TKMS - exchange coefficient for heat in the surface<a name='2217'></font>
<font color=#447700>!              layer (m/s)<a name='2218'></font>
<font color=#447700>!     PC - plant coefficient (resistance)<a name='2219'></font>
<font color=#447700>!     RHO - density of atmosphere near sueface <a name='2220'></font>
<font color=#447700>!     VEGFRAC - greeness fraction<a name='2221'></font>
<font color=#447700>!     CAP - volumetric heat capacity <a name='2222'></font>
<font color=#447700>!     DRYCAN - dry fraction of vegetated area where<a name='2223'></font>
<font color=#447700>!              transpiration may take place<a name='2224'></font>
<font color=#447700>!     WETCAN - fraction of vegetated area covered by canopy<a name='2225'></font>
<font color=#447700>!              water<a name='2226'></font>
<font color=#447700>!     TRANSUM - transpiration function integrated over the <a name='2227'></font>
<font color=#447700>!               rooting zone<a name='2228'></font>
<font color=#447700>!     DEW -  dew in kg/m^2s<a name='2229'></font>
<font color=#447700>!     MAVAIL - fraction of maximum soil moisture in the top<a name='2230'></font>
<font color=#447700>!               layer<a name='2231'></font>
<font color=#447700>!     ZSMAIN - main levels in soil<a name='2232'></font>
<font color=#447700>!     ZSHALF - middle of the soil layers<a name='2233'></font>
<font color=#447700>!     DTDZS - dt/(2.*dzshalf*dzmain)<a name='2234'></font>
<font color=#447700>!     TBQ - table to define saturated mixing ration<a name='2235'></font>
<font color=#447700>!           of water vapor for given temperature and pressure<a name='2236'></font>
<font color=#447700>!     TSO - soil temperature<a name='2237'></font>
<font color=#447700>!     SOILT - skin temperature<a name='2238'></font>
<font color=#447700>!<a name='2239'></font>
<font color=#447700>!****************************************************************<a name='2240'></font>
<a name='2241'>
        IMPLICIT NONE<a name='2242'>
<font color=#447700>!-----------------------------------------------------------------<a name='2243'></font>
<a name='2244'>
<font color=#447700>!--- input variables<a name='2245'></font>
<a name='2246'>
   INTEGER,  INTENT(IN   )   ::  nroot,ktau,nzs                , &amp;<a name='2247'>
                                 nddzs                         <font color=#447700>!nddzs=2*(nzs-2)<a name='2248'></font>
   INTEGER,  INTENT(IN   )   ::  i,j,iland,isoil<a name='2249'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX,PRCPMS, RAINF<a name='2250'>
   REAL,     INTENT(INOUT)   ::  DRYCAN,WETCAN,TRANSUM<a name='2251'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='2252'></font>
   REAL,                                                         &amp;<a name='2253'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='2254'>
                                                          QVATM, &amp;<a name='2255'>
                                                          QCATM<a name='2256'>
<font color=#447700>!--- 2-D variables<a name='2257'></font>
   REAL                                                        , &amp;<a name='2258'>
            INTENT(IN   )    ::                                  &amp;<a name='2259'>
                                                          EMISS, &amp;<a name='2260'>
                                                            RHO, &amp;<a name='2261'>
                                                           RNET, &amp;  <a name='2262'>
                                                             PC, &amp;<a name='2263'>
                                                        VEGFRAC, &amp;<a name='2264'>
                                                            DEW, &amp; <a name='2265'>
                                                           QKMS, &amp;<a name='2266'>
                                                           TKMS<a name='2267'>
<a name='2268'>
<font color=#447700>!--- soil properties<a name='2269'></font>
   REAL                                                        , &amp;<a name='2270'>
            INTENT(IN   )    ::                                  &amp;<a name='2271'>
                                                           BCLH, &amp;<a name='2272'>
                                                            DQM, &amp;<a name='2273'>
                                                           QMIN<a name='2274'>
<a name='2275'>
   REAL,     INTENT(IN   )   ::                              CP, &amp;<a name='2276'>
                                                            CVW, &amp;<a name='2277'>
                                                            XLV, &amp;<a name='2278'>
                                                         STBOLT, &amp;<a name='2279'>
                                                           TABS, &amp;<a name='2280'>
                                                           G0_P<a name='2281'>
<a name='2282'>
<a name='2283'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='2284'>
                                                         ZSHALF, &amp;<a name='2285'>
                                                          THDIF, &amp;<a name='2286'>
                                                            CAP<a name='2287'>
<a name='2288'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='2289'>
<a name='2290'>
   REAL,     DIMENSION(1:4001), INTENT(IN)  ::              TBQ<a name='2291'>
<a name='2292'>
<a name='2293'>
<font color=#447700>!--- input/output variables<a name='2294'></font>
<font color=#447700>!-------- 3-d soil moisture and temperature<a name='2295'></font>
   REAL,     DIMENSION( 1:nzs )                                , &amp;<a name='2296'>
             INTENT(INOUT)   ::                             TSO<a name='2297'>
<a name='2298'>
<font color=#447700>!-------- 2-d variables<a name='2299'></font>
   REAL                                                        , &amp;<a name='2300'>
             INTENT(INOUT)   ::                                  &amp;<a name='2301'>
                                                         MAVAIL, &amp;<a name='2302'>
                                                            QVG, &amp;<a name='2303'>
                                                            QSG, &amp;<a name='2304'>
                                                            QCG, &amp;<a name='2305'>
                                                          SOILT<a name='2306'>
<a name='2307'>
<a name='2308'>
<font color=#447700>!--- Local variables<a name='2309'></font>
<a name='2310'>
   REAL    ::  x,x1,x2,x4,dzstop,can,ft,sph                    , &amp;<a name='2311'>
               tn,trans,umveg,denom<a name='2312'>
<a name='2313'>
   REAL    ::  FKT,D1,D2,D9,D10,DID,R211,R21,R22,R6,R7,D11     , &amp;<a name='2314'>
               PI,H,FKQ,R210,AA,BB,PP,Q1,QS1,TS1,TQ2,TX2       , &amp;<a name='2315'>
               TDENOM<a name='2316'>
<a name='2317'>
   REAL    ::  C,CC,AA1,RHCS,H1<a name='2318'>
<a name='2319'>
   REAL,     DIMENSION(1:NZS)  ::                   cotso,rhtso<a name='2320'>
<a name='2321'>
   INTEGER ::  nzs1,nzs2,k,k1,kn,kk<a name='2322'>
<a name='2323'>
<font color=#447700>!-----------------------------------------------------------------<a name='2324'></font>
<a name='2325'>
<a name='2326'>
          NZS1=NZS-1<a name='2327'>
          NZS2=NZS-2<a name='2328'>
        dzstop=1./(ZSMAIN(2)-ZSMAIN(1))<a name='2329'>
<a name='2330'>
        do k=1,nzs<a name='2331'>
           cotso(k)=0.<a name='2332'>
           rhtso(k)=0.<a name='2333'>
        enddo<a name='2334'>
<font color=#447700>!******************************************************************************<a name='2335'></font>
<font color=#447700>!       COEFFICIENTS FOR THOMAS ALGORITHM FOR TSO<a name='2336'></font>
<font color=#447700>!******************************************************************************<a name='2337'></font>
<font color=#447700>!         did=2.*(ZSMAIN(nzs)-ZSHALF(nzs))<a name='2338'></font>
<font color=#447700>!         h1=DTDZS(8)*THDIF(nzs-1)*(ZSHALF(nzs)-ZSHALF(nzs-1))/did<a name='2339'></font>
<font color=#447700>!         cotso(1)=h1/(1.+h1)<a name='2340'></font>
<font color=#447700>!         rhtso(1)=(tso(nzs)+h1*(tso(nzs-1)-tso(nzs)))/<a name='2341'></font>
<font color=#447700>!     1         (1.+h1)<a name='2342'></font>
        cotso(1)=0.<a name='2343'>
        rhtso(1)=TSO(NZS)<a name='2344'>
        DO 33 K=1,NZS2<a name='2345'>
          KN=NZS-K<a name='2346'>
          K1=2*KN-3<a name='2347'>
          X1=DTDZS(K1)*THDIF(KN-1)<a name='2348'>
          X2=DTDZS(K1+1)*THDIF(KN)<a name='2349'>
          FT=TSO(KN)+X1*(TSO(KN-1)-TSO(KN))                             &amp;<a name='2350'>
             -X2*(TSO(KN)-TSO(KN+1))<a name='2351'>
          DENOM=1.+X1+X2-X2*cotso(K)<a name='2352'>
          cotso(K+1)=X1/DENOM<a name='2353'>
          rhtso(K+1)=(FT+X2*rhtso(K))/DENOM<a name='2354'>
   33  CONTINUE<a name='2355'>
<a name='2356'>
<font color=#447700>!************************************************************************<a name='2357'></font>
<font color=#447700>!--- THE HEAT BALANCE EQUATION (EQ. 21,26)<a name='2358'></font>
<a name='2359'>
        RHCS=CAP(1)<a name='2360'>
        H=MAVAIL<a name='2361'>
        IF(DEW.NE.0.)THEN<a name='2362'>
          DRYCAN=0.<a name='2363'>
          WETCAN=1.<a name='2364'>
        ENDIf<a name='2365'>
        TRANS=PC*TRANSUM*DRYCAN/ZSHALF(NROOT+1)<a name='2366'>
        CAN=WETCAN+TRANS<a name='2367'>
        UMVEG=1.-VEGFRAC<a name='2368'>
        FKT=TKMS<a name='2369'>
        D1=cotso(NZS1)<a name='2370'>
        D2=rhtso(NZS1)<a name='2371'>
        TN=SOILT<a name='2372'>
        D9=THDIF(1)*RHCS*dzstop<a name='2373'>
        D10=TKMS*CP*RHO<a name='2374'>
        R211=.5*CONFLX/DELT<a name='2375'>
        R21=R211*CP*RHO<a name='2376'>
        R22=.5/(THDIF(1)*DELT*dzstop**2)<a name='2377'>
        R6=EMISS *STBOLT*.5*TN**4<a name='2378'>
        R7=R6/TN<a name='2379'>
        D11=RNET+R6<a name='2380'>
        TDENOM=D9*(1.-D1+R22)+D10+R21+R7                              &amp;<a name='2381'>
              +RAINF*CVW*PRCPMS<a name='2382'>
        FKQ=QKMS*RHO<a name='2383'>
        R210=R211*RHO<a name='2384'>
        C=VEGFRAC*FKQ*CAN<a name='2385'>
        CC=C*XLV/TDENOM<a name='2386'>
        AA=XLV*(FKQ*UMVEG+R210)/TDENOM<a name='2387'>
        BB=(D10*TABS+R21*TN+XLV*(QVATM*                               &amp;<a name='2388'>
        (FKQ*UMVEG+C)                                                 &amp; <a name='2389'>
        +R210*QVG)+D11+D9*(D2+R22*TN)                                 &amp;<a name='2390'>
        +RAINF*CVW*PRCPMS*TABS                                        &amp;<a name='2391'>
         )/TDENOM<a name='2392'>
        AA1=AA+CC<a name='2393'>
        PP=PATM*1.E3<a name='2394'>
        AA1=AA1/PP<a name='2395'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2396'>
        PRINT *,' VILKA-1'<a name='2397'>
        print *,'D10,TABS,R21,TN,QVATM,FKQ,UMVEG,VEGFRAC,CAN',        &amp;<a name='2398'>
                 D10,TABS,R21,TN,QVATM,FKQ,UMVEG,VEGFRAC,CAN<a name='2399'>
        print *,'RNET, EMISS, STBOLT, SOILT',RNET, EMISS, STBOLT, SOILT<a name='2400'>
        print *,'R210,QVG,D11,D9,D2,R22,RAINF,CVW,PRCPMS,TDENOM',     &amp;<a name='2401'>
                 R210,QVG,D11,D9,D2,R22,RAINF,CVW,PRCPMS,TDENOM<a name='2402'>
        print *,'tn,aa1,bb,pp,umveg,fkq,r210,vegfrac',                &amp;<a name='2403'>
                 tn,aa1,bb,pp,umveg,fkq,r210,vegfrac<a name='2404'>
    ENDIF<a name='2405'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA'>VILKA</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILTEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VILKA_1">(TN,AA1,BB,PP,QS1,TS1,TBQ,KTAU,i,j,iland,isoil)<a name='2406'>
        TQ2=QVATM+QCATM<a name='2407'>
        TX2=TQ2*(1.-H)<a name='2408'>
        Q1=TX2+H*QS1<a name='2409'>
        IF(Q1.LT.QS1) GOTO 100<a name='2410'>
<font color=#447700>!--- if no saturation - goto 100<a name='2411'></font>
<font color=#447700>!--- if saturation - goto 90<a name='2412'></font>
   90   QVG=QS1<a name='2413'>
        QSG=QS1<a name='2414'>
        TSO(1)=TS1<a name='2415'>
        QCG=Q1-QS1<a name='2416'>
        GOTO 200<a name='2417'>
  100   BB=BB-AA*TX2<a name='2418'>
        AA=(AA*H+CC)/PP<a name='2419'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2420'>
<font color=#447700>!      if(i.eq.1.and.j.eq.57) then<a name='2421'></font>
        PRINT *,' VILKA-2'<a name='2422'>
        print *,'D10,TABS,R21,TN,QVATM,FKQ,UMVEG,VEGFRAC,CAN',        &amp;<a name='2423'>
                 D10,TABS,R21,TN,QVATM,FKQ,UMVEG,VEGFRAC,CAN<a name='2424'>
        print *,'R210,QVG,D11,D9,D2,R22,RAINF,CVW,PRCPMS,TDENOM',     &amp;<a name='2425'>
                 R210,QVG,D11,D9,D2,R22,RAINF,CVW,PRCPMS,TDENOM<a name='2426'>
<a name='2427'>
        print *,'tn,aa1,bb,pp,umveg,fkq,r210,vegfrac',                &amp;<a name='2428'>
                 tn,aa1,bb,pp,umveg,fkq,r210,vegfrac<a name='2429'>
    ENDIF<a name='2430'>
<a name='2431'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA'>VILKA</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILTEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VILKA_2">(TN,AA,BB,PP,QS1,TS1,TBQ,KTAU,i,j,iland,isoil)<a name='2432'>
        Q1=TX2+H*QS1<a name='2433'>
        IF(Q1.GT.QS1) GOTO 90<a name='2434'>
        QSG=QS1<a name='2435'>
        QVG=Q1<a name='2436'>
        TSO(1)=TS1<a name='2437'>
        QCG=0.<a name='2438'>
  200   CONTINUE<a name='2439'>
<a name='2440'>
<font color=#447700>!--- SOILT - skin temperature<a name='2441'></font>
          SOILT=TS1<a name='2442'>
<a name='2443'>
<font color=#447700>!---- Final solution for soil temperature - TSO<a name='2444'></font>
          DO K=2,NZS<a name='2445'>
            KK=NZS-K+1<a name='2446'>
            TSO(K)=rhtso(KK)+cotso(KK)*TSO(K-1)<a name='2447'>
          END DO<a name='2448'>
<a name='2449'>
<font color=#447700>!        return<a name='2450'></font>
<font color=#447700>!        end<a name='2451'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='2452'></font>
   END SUBROUTINE SOILTEMP<a name='2453'>
<font color=#447700>!--------------------------------------------------------------------<a name='2454'></font>
<a name='2455'>
<a name='2456'>
<A NAME='SNOWTEMP'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWTEMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2457'>
           <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWTEMP</font>(                                    &amp;  <A href='../../call_to/SNOWTEMP.html' TARGET='index'>1</A>,<A href='../../call_from/SNOWTEMP.html' TARGET='index'>2</A><a name='2458'>
<font color=#447700>!--- input variables<a name='2459'></font>
           i,j,iland,isoil,                                        &amp;<a name='2460'>
           delt,ktau,conflx,nzs,nddzs,nroot,                       &amp;<a name='2461'>
           snwe,snwepr,snhei,newsnow,                              &amp;<a name='2462'>
           beta,deltsn,snth,rhosn,                                 &amp;<a name='2463'>
           PRCPMS,RAINF,                                           &amp;<a name='2464'>
           PATM,TABS,QVATM,QCATM,                                  &amp;<a name='2465'>
           GLW,GSW,EMISS,RNET,                                     &amp;<a name='2466'>
           QKMS,TKMS,PC,RHO,VEGFRAC,                               &amp;<a name='2467'>
           THDIF,CAP,DRYCAN,WETCAN,CST,                            &amp;<a name='2468'>
           TRANF,TRANSUM,DEW,MAVAIL,                               &amp;<a name='2469'>
<font color=#447700>!--- soil fixed fields<a name='2470'></font>
           DQM,QMIN,PSIS,BCLH,                                     &amp;<a name='2471'>
           ZSMAIN,ZSHALF,DTDZS,TBQ,                                &amp;<a name='2472'>
<font color=#447700>!--- constants<a name='2473'></font>
           XLVM,CP,G0_P,CVW,STBOLT,                                &amp;<a name='2474'>
<font color=#447700>!--- output variables<a name='2475'></font>
           SNWEPRINT,SNHEIPRINT,RSM,                               &amp;<a name='2476'>
           TSO,SOILT,SOILT1,TSNAV,QVG,QSG,QCG,                     &amp;<a name='2477'>
           SMELT,SNOH,SNFLX,ILNB)<a name='2478'>
<a name='2479'>
<font color=#447700>!********************************************************************<a name='2480'></font>
<font color=#447700>!   Energy budget equation and heat diffusion eqn are <a name='2481'></font>
<font color=#447700>!   solved here to obtain snow and soil temperatures<a name='2482'></font>
<font color=#447700>!<a name='2483'></font>
<font color=#447700>!     DELT - time step<a name='2484'></font>
<font color=#447700>!     ktau - numver of time step<a name='2485'></font>
<font color=#447700>!     CONFLX - depth of constant flux layer (m)<a name='2486'></font>
<font color=#447700>!     IME, JME, KME, NZS - dimensions of the domain <a name='2487'></font>
<font color=#447700>!     NROOT - number of levels within the root zone<a name='2488'></font>
<font color=#447700>!     PRCPMS - precipitation rate in m/s<a name='2489'></font>
<font color=#447700>!     COTSO, RHTSO - coefficients for implicit solution of<a name='2490'></font>
<font color=#447700>!                     heat diffusion equation<a name='2491'></font>
<font color=#447700>!     THDIF - thermal diffusivity<a name='2492'></font>
<font color=#447700>!     QSG,QVG,QCG - saturated mixing ratio, mixing ratio of<a name='2493'></font>
<font color=#447700>!                   water vapor and cloud at the ground<a name='2494'></font>
<font color=#447700>!                   surface, respectively<a name='2495'></font>
<font color=#447700>!     PATM - pressure [bar]<a name='2496'></font>
<font color=#447700>!     QCATM,QVATM - cloud and water vapor mixing ratio<a name='2497'></font>
<font color=#447700>!                   at the first atm. level<a name='2498'></font>
<font color=#447700>!     EMISS,RNET - emissivity of the ground surface and net<a name='2499'></font>
<font color=#447700>!                  radiation at the surface<a name='2500'></font>
<font color=#447700>!     QKMS - exchange coefficient for water vapor in the<a name='2501'></font>
<font color=#447700>!              surface layer (m/s)<a name='2502'></font>
<font color=#447700>!     TKMS - exchange coefficient for heat in the surface<a name='2503'></font>
<font color=#447700>!              layer (m/s)<a name='2504'></font>
<font color=#447700>!     PC - plant coefficient (resistance)<a name='2505'></font>
<font color=#447700>!     RHO - density of atmosphere near sueface <a name='2506'></font>
<font color=#447700>!     VEGFRAC - greeness fraction<a name='2507'></font>
<font color=#447700>!     CAP - volumetric heat capacity <a name='2508'></font>
<font color=#447700>!     DRYCAN - dry fraction of vegetated area where<a name='2509'></font>
<font color=#447700>!              transpiration may take place<a name='2510'></font>
<font color=#447700>!     WETCAN - fraction of vegetated area covered by canopy<a name='2511'></font>
<font color=#447700>!              water<a name='2512'></font>
<font color=#447700>!     TRANSUM - transpiration function integrated over the <a name='2513'></font>
<font color=#447700>!               rooting zone<a name='2514'></font>
<font color=#447700>!     DEW -  dew in kg/m^2s<a name='2515'></font>
<font color=#447700>!     MAVAIL - fraction of maximum soil moisture in the top<a name='2516'></font>
<font color=#447700>!               layer<a name='2517'></font>
<font color=#447700>!     ZSMAIN - main levels in soil<a name='2518'></font>
<font color=#447700>!     ZSHALF - middle of the soil layers<a name='2519'></font>
<font color=#447700>!     DTDZS - dt/(2.*dzshalf*dzmain)<a name='2520'></font>
<font color=#447700>!     TBQ - table to define saturated mixing ration<a name='2521'></font>
<font color=#447700>!           of water vapor for given temperature and pressure<a name='2522'></font>
<font color=#447700>!     TSO - soil temperature<a name='2523'></font>
<font color=#447700>!     SOILT - skin temperature<a name='2524'></font>
<font color=#447700>!<a name='2525'></font>
<font color=#447700>!*********************************************************************<a name='2526'></font>
<a name='2527'>
        IMPLICIT NONE<a name='2528'>
<font color=#447700>!---------------------------------------------------------------------<a name='2529'></font>
<font color=#447700>!--- input variables<a name='2530'></font>
<a name='2531'>
   INTEGER,  INTENT(IN   )   ::  nroot,ktau,nzs                , &amp;<a name='2532'>
                                 nddzs                             <font color=#447700>!nddzs=2*(nzs-2)<a name='2533'></font>
<a name='2534'>
   INTEGER,  INTENT(IN   )   ::  i,j,iland,isoil<a name='2535'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX,PRCPMS            , &amp;<a name='2536'>
                                 RAINF,NEWSNOW,DELTSN,SNTH     , &amp;<a name='2537'>
                                 TABS,TRANSUM,SNWEPR<a name='2538'>
<a name='2539'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='2540'></font>
   REAL,                                                         &amp;<a name='2541'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='2542'>
                                                          QVATM, &amp;<a name='2543'>
                                                          QCATM<a name='2544'>
<font color=#447700>!--- 2-D variables<a name='2545'></font>
   REAL                                                        , &amp;<a name='2546'>
            INTENT(IN   )    ::                             GLW, &amp;<a name='2547'>
                                                            GSW, &amp;<a name='2548'>
                                                            RHO, &amp;<a name='2549'>
                                                             PC, &amp;<a name='2550'>
                                                        VEGFRAC, &amp;<a name='2551'>
                                                           QKMS, &amp;<a name='2552'>
                                                           TKMS<a name='2553'>
<a name='2554'>
<font color=#447700>!--- soil properties<a name='2555'></font>
   REAL                                                        , &amp;<a name='2556'>
            INTENT(IN   )    ::                                  &amp;<a name='2557'>
                                                           BCLH, &amp;<a name='2558'>
                                                            DQM, &amp;<a name='2559'>
                                                           PSIS, &amp;<a name='2560'>
                                                           QMIN<a name='2561'>
<a name='2562'>
   REAL,     INTENT(IN   )   ::                              CP, &amp;<a name='2563'>
                                                            CVW, &amp;<a name='2564'>
                                                         STBOLT, &amp;<a name='2565'>
                                                           XLVM, &amp;<a name='2566'>
                                                            G0_P<a name='2567'>
<a name='2568'>
<a name='2569'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='2570'>
                                                         ZSHALF, &amp;<a name='2571'>
                                                          THDIF, &amp;<a name='2572'>
                                                            CAP, &amp;<a name='2573'>
                                                          TRANF <a name='2574'>
<a name='2575'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='2576'>
<a name='2577'>
   REAL,     DIMENSION(1:4001), INTENT(IN)  ::              TBQ<a name='2578'>
<a name='2579'>
<a name='2580'>
<font color=#447700>!--- input/output variables<a name='2581'></font>
<font color=#447700>!-------- 3-d soil moisture and temperature<a name='2582'></font>
   REAL,     DIMENSION(  1:nzs )                               , &amp;<a name='2583'>
             INTENT(INOUT)   ::                             TSO<a name='2584'>
<a name='2585'>
<a name='2586'>
<font color=#447700>!-------- 2-d variables<a name='2587'></font>
   REAL                                                        , &amp;<a name='2588'>
             INTENT(INOUT)   ::                             DEW, &amp;<a name='2589'>
                                                            CST, &amp;<a name='2590'>
                                                          RHOSN, &amp;<a name='2591'>
                                                          EMISS, &amp;<a name='2592'>
                                                         MAVAIL, &amp;<a name='2593'>
                                                            QVG, &amp;<a name='2594'>
                                                            QSG, &amp;<a name='2595'>
                                                            QCG, &amp;<a name='2596'>
                                                           SNWE, &amp;<a name='2597'>
                                                          SNHEI, &amp;<a name='2598'>
                                                          SMELT, &amp;<a name='2599'>
                                                           SNOH, &amp;<a name='2600'>
                                                          SNFLX, &amp;<a name='2601'>
                                                          SOILT, &amp;<a name='2602'>
                                                         SOILT1, &amp;<a name='2603'>
                                                          TSNAV<a name='2604'>
<a name='2605'>
   REAL,     INTENT(INOUT)                  ::   DRYCAN, WETCAN           <a name='2606'>
<a name='2607'>
   REAL,     INTENT(OUT)                    ::              RSM, &amp;<a name='2608'>
                                                      SNWEPRINT, &amp;<a name='2609'>
                                                     SNHEIPRINT<a name='2610'>
   INTEGER,  INTENT(OUT)                    ::             ilnb<a name='2611'>
<font color=#447700>!--- Local variables<a name='2612'></font>
<a name='2613'>
<a name='2614'>
   INTEGER ::  nzs1,nzs2,k,k1,kn,kk<a name='2615'>
<a name='2616'>
   REAL    ::  x,x1,x2,x4,dzstop,can,ft,sph,                     &amp;<a name='2617'>
               tn,trans,umveg,denom<a name='2618'>
<a name='2619'>
   REAL    ::  cotsn,rhtsn,xsn1,ddzsn1,x1sn1,ftsnow,denomsn<a name='2620'>
<a name='2621'>
   REAL    ::  t3,upflux,xinet,ras,                              &amp;<a name='2622'>
               xlmelt,rhocsn,thdifsn,                            &amp;<a name='2623'>
               beta,epot,xsn,ddzsn,x1sn,d1sn,d2sn,d9sn,r22sn<a name='2624'>
<a name='2625'>
   REAL    ::  fso,fsn,                                          &amp;<a name='2626'>
               FKT,D1,D2,D9,D10,DID,R211,R21,R22,R6,R7,D11,      &amp;<a name='2627'>
               PI,H,FKQ,R210,AA,BB,PP,Q1,QS1,TS1,TQ2,TX2,        &amp;<a name='2628'>
               TDENOM,C,CC,AA1,RHCS,H1,                          &amp;<a name='2629'>
               tsob, snprim, sh1, sh2,                           &amp;<a name='2630'>
               smeltg,snohg,snodif,soh,                          &amp;<a name='2631'>
               CMC2MS,TNOLD,QGOLD,SNOHGNEW                            <a name='2632'>
<a name='2633'>
   REAL,     DIMENSION(1:NZS)  ::  transp,cotso,rhtso<a name='2634'>
   REAL                        ::                         edir1, &amp;<a name='2635'>
                                                            ec1, &amp;<a name='2636'>
                                                           ett1, &amp;<a name='2637'>
                                                           eeta, &amp;<a name='2638'>
                                                              s, &amp;<a name='2639'>
                                                            qfx, &amp;<a name='2640'>
                                                            hfx<a name='2641'>
<a name='2642'>
   REAL                        ::                          RNET<a name='2643'>
<a name='2644'>
<font color=#447700>!-----------------------------------------------------------------<a name='2645'></font>
<a name='2646'>
       do k=1,nzs<a name='2647'>
          transp   (k)=0.<a name='2648'>
          cotso    (k)=0.<a name='2649'>
          rhtso    (k)=0.<a name='2650'>
       enddo<a name='2651'>
<a name='2652'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2653'>
print *, 'SNOWTEMP: SNHEI,SNTH,SOILT1: ',SNHEI,SNTH,SOILT1,soilt <a name='2654'>
    ENDIF<a name='2655'>
        XLMELT=3.335E+5<a name='2656'>
        RHOCSN=2090.* RHOSN<a name='2657'>
        THDIFSN = 0.265/RHOCSN<a name='2658'>
        RAS=RHO*1.E-3<a name='2659'>
<a name='2660'>
        SMELT=0.<a name='2661'>
        SOH=0.<a name='2662'>
        SMELTG=0.<a name='2663'>
        SNOHG=0.<a name='2664'>
        SNODIF=0.<a name='2665'>
        RSM = 0.<a name='2666'>
        fsn=0.<a name='2667'>
        fso=1.<a name='2668'>
<a name='2669'>
          NZS1=NZS-1<a name='2670'>
          NZS2=NZS-2<a name='2671'>
<a name='2672'>
        QGOLD=QVG<a name='2673'>
        TNOLD=SOILT<a name='2674'>
        DZSTOP=1./(ZSMAIN(2)-ZSMAIN(1))<a name='2675'>
<a name='2676'>
<font color=#447700>!******************************************************************************<a name='2677'></font>
<font color=#447700>!       COEFFICIENTS FOR THOMAS ALGORITHM FOR TSO<a name='2678'></font>
<font color=#447700>!******************************************************************************<a name='2679'></font>
<font color=#447700>!         did=2.*(ZSMAIN(nzs)-ZSHALF(nzs))<a name='2680'></font>
<font color=#447700>!         h1=DTDZS(8)*THDIF(nzs-1)*(ZSHALF(nzs)-ZSHALF(nzs-1))/did<a name='2681'></font>
<font color=#447700>!         cotso(1)=h1/(1.+h1)<a name='2682'></font>
<font color=#447700>!         rhtso(1)=(tso(nzs)+h1*(tso(nzs-1)-tso(nzs)))/<a name='2683'></font>
<font color=#447700>!     1         (1.+h1)<a name='2684'></font>
<a name='2685'>
        cotso(1)=0.<a name='2686'>
        rhtso(1)=TSO(NZS)<a name='2687'>
        DO 33 K=1,NZS2<a name='2688'>
          KN=NZS-K<a name='2689'>
          K1=2*KN-3<a name='2690'>
          X1=DTDZS(K1)*THDIF(KN-1)<a name='2691'>
          X2=DTDZS(K1+1)*THDIF(KN)<a name='2692'>
          FT=TSO(KN)+X1*(TSO(KN-1)-TSO(KN))                           &amp;<a name='2693'>
             -X2*(TSO(KN)-TSO(KN+1))<a name='2694'>
          DENOM=1.+X1+X2-X2*cotso(K)<a name='2695'>
          cotso(K+1)=X1/DENOM<a name='2696'>
          rhtso(K+1)=(FT+X2*rhtso(K))/DENOM<a name='2697'>
   33  CONTINUE<a name='2698'>
<font color=#447700>!--- THE NZS element in COTSO and RHTSO will be for snow<a name='2699'></font>
<font color=#447700>!--- There will be 2 layers in snow if it is deeper than DELTSN+SNTH<a name='2700'></font>
       IF(SNHEI.GE.SNTH) then<a name='2701'>
<font color=#447700>!        if(snhei.le.DELTSN+DELTSN) then<a name='2702'></font>
        if(snhei.le.DELTSN+SNTH) then<a name='2703'>
<font color=#447700>!-- 1-layer snow model<a name='2704'></font>
         ilnb=1<a name='2705'>
         snprim=snhei<a name='2706'>
         soilt1=tso(1)<a name='2707'>
         tsob=tso(1)<a name='2708'>
         XSN = DELT/2./(zshalf(2)+0.5*SNPRIM)<a name='2709'>
         DDZSN = XSN / SNPRIM<a name='2710'>
         X1SN = DDZSN * thdifsn<a name='2711'>
         X2 = DTDZS(1)*THDIF(1)<a name='2712'>
         FT = TSO(1)+X1SN*(SOILT-TSO(1))                              &amp;<a name='2713'>
              -X2*(TSO(1)-TSO(2))<a name='2714'>
         DENOM = 1. + X1SN + X2 -X2*cotso(NZS1)<a name='2715'>
         cotso(NZS)=X1SN/DENOM<a name='2716'>
         rhtso(NZS)=(FT+X2*rhtso(NZS1))/DENOM<a name='2717'>
         cotsn=cotso(NZS)<a name='2718'>
         rhtsn=rhtso(NZS)<a name='2719'>
<font color=#447700>!*** Average temperature of snow pack (C)<a name='2720'></font>
         tsnav=0.5*(soilt+tso(1))                                     &amp;<a name='2721'>
                     -273.15<a name='2722'>
<a name='2723'>
        else<a name='2724'>
<font color=#447700>!-- 2 layers in snow, SOILT1 is temperasture at DELTSN depth<a name='2725'></font>
         ilnb=2<a name='2726'>
         snprim=deltsn<a name='2727'>
         tsob=soilt1<a name='2728'>
         XSN = DELT/2./(0.5*SNHEI)<a name='2729'>
         XSN1= DELT/2./(zshalf(2)+0.5*(SNHEI-DELTSN))<a name='2730'>
         DDZSN = XSN / DELTSN<a name='2731'>
         DDZSN1 = XSN1 / (SNHEI-DELTSN)<a name='2732'>
         X1SN = DDZSN * thdifsn<a name='2733'>
         X1SN1 = DDZSN1 * thdifsn<a name='2734'>
         X2 = DTDZS(1)*THDIF(1)<a name='2735'>
         FT = TSO(1)+X1SN1*(SOILT1-TSO(1))                            &amp;<a name='2736'>
              -X2*(TSO(1)-TSO(2))<a name='2737'>
         DENOM = 1. + X1SN1 + X2 - X2*cotso(NZS1)<a name='2738'>
         cotso(nzs)=x1sn1/denom<a name='2739'>
         rhtso(nzs)=(ft+x2*rhtso(nzs1))/denom<a name='2740'>
         ftsnow = soilt1+x1sn*(soilt-soilt1)                          &amp;<a name='2741'>
               -x1sn1*(soilt1-tso(1))<a name='2742'>
         denomsn = 1. + X1SN + X1SN1 - X1SN1*cotso(NZS)<a name='2743'>
         cotsn=x1sn/denomsn<a name='2744'>
         rhtsn=(ftsnow+X1SN1*rhtso(NZS))/denomsn<a name='2745'>
<font color=#447700>!*** Average temperature of snow pack (C)<a name='2746'></font>
         tsnav=0.5/snhei*((soilt+soilt1)*deltsn                       &amp;<a name='2747'>
                     +(soilt1+tso(1))*(SNHEI-DELTSN))                 &amp;<a name='2748'>
                     -273.15<a name='2749'>
        endif<a name='2750'>
       ENDIF<a name='2751'>
<a name='2752'>
       IF(SNHEI.LT.SNTH.AND.SNHEI.GT.0.) then<a name='2753'>
<font color=#447700>!--- snow is too thin to be treated separately, therefore it<a name='2754'></font>
<font color=#447700>!--- is combined with the first soil layer.<a name='2755'></font>
         fsn=SNHEI/(SNHEI+zsmain(2))<a name='2756'>
         fso=1.-fsn<a name='2757'>
         soilt1=tso(1)<a name='2758'>
         tsob=tso(2)<a name='2759'>
         snprim=SNHEI+zsmain(2)<a name='2760'>
         XSN = DELT/2./((zshalf(3)-zsmain(2))+0.5*snprim)<a name='2761'>
         DDZSN = XSN /snprim<a name='2762'>
         X1SN = DDZSN * (fsn*thdifsn+fso*thdif(1))<a name='2763'>
         X2=DTDZS(2)*THDIF(2)<a name='2764'>
         FT=TSO(2)+X1SN*(SOILT-TSO(2))-                              &amp;<a name='2765'>
                       X2*(TSO(2)-TSO(3))<a name='2766'>
         denom = 1. + x1sn + x2 - x2*cotso(nzs-2)<a name='2767'>
         cotso(nzs1) = x1sn/denom<a name='2768'>
         rhtso(nzs1)=(FT+X2*rhtso(NZS-2))/denom<a name='2769'>
         tsnav=0.5*(soilt+tso(1))                                    &amp;<a name='2770'>
                     -273.15<a name='2771'>
       ENDIF<a name='2772'>
<a name='2773'>
<font color=#447700>!************************************************************************<a name='2774'></font>
<font color=#447700>!--- THE HEAT BALANCE EQUATION (EQ. 21,26)<a name='2775'></font>
<a name='2776'>
        ETT1=0.<a name='2777'>
        EPOT=-QKMS*(QVATM-QSG)<a name='2778'>
        RHCS=CAP(1)<a name='2779'>
        H=MAVAIL<a name='2780'>
        IF(DEW.NE.0.)THEN<a name='2781'>
          DRYCAN=0.<a name='2782'>
          WETCAN=1.<a name='2783'>
        ENDIF<a name='2784'>
        TRANS=PC*TRANSUM*DRYCAN/ZSHALF(NROOT+1)<a name='2785'>
        CAN=WETCAN+TRANS<a name='2786'>
        UMVEG=1.-VEGFRAC<a name='2787'>
        FKT=TKMS<a name='2788'>
        D1=cotso(NZS1)<a name='2789'>
        D2=rhtso(NZS1)<a name='2790'>
        TN=SOILT<a name='2791'>
        D9=THDIF(1)*RHCS*dzstop<a name='2792'>
        D10=TKMS*CP*RHO<a name='2793'>
        R211=.5*CONFLX/DELT<a name='2794'>
        R21=R211*CP*RHO<a name='2795'>
        R22=.5/(THDIF(1)*DELT*dzstop**2)<a name='2796'>
        R6=EMISS *STBOLT*.5*TN**4<a name='2797'>
        R7=R6/TN<a name='2798'>
        D11=RNET+R6<a name='2799'>
<a name='2800'>
      IF(SNHEI.GE.SNTH) THEN<a name='2801'>
<font color=#447700>!        if(snhei.le.DELTSN+DELTSN) then<a name='2802'></font>
        if(snhei.le.DELTSN+SNTH) then<a name='2803'>
<font color=#447700>!--- 1-layer snow<a name='2804'></font>
          D1SN = cotso(NZS)<a name='2805'>
          D2SN = rhtso(NZS)<a name='2806'>
        else<a name='2807'>
<font color=#447700>!--- 2-layer snow<a name='2808'></font>
          D1SN = cotsn<a name='2809'>
          D2SN = rhtsn<a name='2810'>
        endif<a name='2811'>
        D9SN= THDIFSN*RHOCSN / SNPRIM<a name='2812'>
        R22SN = SNPRIM*SNPRIM*0.5/(THDIFSN*DELT)<a name='2813'>
      ENDIF<a name='2814'>
<a name='2815'>
       IF(SNHEI.LT.SNTH.AND.SNHEI.GT.0.) then<a name='2816'>
<font color=#447700>!--- thin snow is combined with soil<a name='2817'></font>
         D1SN = D1<a name='2818'>
         D2SN = D2<a name='2819'>
         D9SN = (fsn*THDIFSN*RHOCSN+fso*THDIF(1)*RHCS)/              &amp;<a name='2820'>
                 snprim<a name='2821'>
         R22SN = snprim*snprim*0.5                                   &amp;<a name='2822'>
                 /((fsn*THDIFSN+fso*THDIF(1))*delt)<a name='2823'>
      ENDIF<a name='2824'>
<a name='2825'>
      IF(SNHEI.eq.0.)then<a name='2826'>
<font color=#447700>!--- all snow is sublimated<a name='2827'></font>
        D9SN = D9<a name='2828'>
        R22SN = R22<a name='2829'>
        D1SN = D1<a name='2830'>
        D2SN = D2<a name='2831'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2832'>
        print *,' SNHEI = 0, D9SN,R22SN,D1SN,D2SN: ',D9SN,R22SN,D1SN,D2SN<a name='2833'>
    ENDIF<a name='2834'>
      ENDIF<a name='2835'>
<a name='2836'>
<font color=#447700>!---- TDENOM for snow<a name='2837'></font>
<a name='2838'>
        TDENOM = D9SN*(1.-D1SN +R22SN)+D10+R21+R7                    &amp;<a name='2839'>
              +RAINF*CVW*PRCPMS                                      &amp;<a name='2840'>
              +RHOCSN*NEWSNOW/DELT<a name='2841'>
<a name='2842'>
        FKQ=QKMS*RHO<a name='2843'>
        R210=R211*RHO<a name='2844'>
        C=VEGFRAC*FKQ*CAN<a name='2845'>
        CC=C*XLVM/TDENOM<a name='2846'>
        AA=XLVM*(BETA*FKQ*UMVEG+R210)/TDENOM<a name='2847'>
        BB=(D10*TABS+R21*TN+XLVM*(QVATM*                             &amp;<a name='2848'>
        (BETA*FKQ*UMVEG+C)                                           &amp;<a name='2849'>
        +R210*QVG)+D11+D9SN*(D2SN+R22SN*TN)                          &amp;<a name='2850'>
        +RAINF*CVW*PRCPMS*TABS                                       &amp;<a name='2851'>
        + RHOCSN*NEWSNOW/DELT*TABS                                   &amp;<a name='2852'>
         )/TDENOM<a name='2853'>
        AA1=AA+CC<a name='2854'>
        PP=PATM*1.E3<a name='2855'>
        AA1=AA1/PP<a name='2856'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2857'>
        print *,'VILKA-SNOW'<a name='2858'>
        print *,'tn,aa1,bb,pp,umveg,fkq,r210,vegfrac',               &amp;<a name='2859'>
                 tn,aa1,bb,pp,umveg,fkq,r210,vegfrac<a name='2860'>
    ENDIF<a name='2861'>
<a name='2862'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA'>VILKA</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWTEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VILKA_3">(TN,AA1,BB,PP,QS1,TS1,TBQ,KTAU,i,j,iland,isoil)<a name='2863'>
        TQ2=QVATM+QCATM<a name='2864'>
        TX2=TQ2*(1.-H)<a name='2865'>
        Q1=TX2+H*QS1<a name='2866'>
<font color=#447700>!--- it is saturation over snow <a name='2867'></font>
   90   QVG=QS1<a name='2868'>
        QSG=QS1<a name='2869'>
        QCG=Q1-QS1<a name='2870'>
<a name='2871'>
<font color=#447700>!--- SOILT - skin temperature<a name='2872'></font>
        SOILT=TS1<a name='2873'>
<a name='2874'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2875'>
        print *,' AFTER VILKA-SNOW'<a name='2876'>
        print *,' TS1,QS1: ', ts1,qs1<a name='2877'>
    ENDIF<a name='2878'>
<a name='2879'>
<font color=#447700>! Solution for temperature at 7.5 cm depth and snow-soil interface<a name='2880'></font>
       IF(SNHEI.GE.SNTH) THEN<a name='2881'>
<font color=#447700>!        if(snhei.gt.DELTSN+DELTSN) then<a name='2882'></font>
        if(snhei.gt.DELTSN+SNTH) then<a name='2883'>
<font color=#447700>!-- 2-layer snow model<a name='2884'></font>
          SOILT1=rhtsn+cotsn*SOILT<a name='2885'>
          TSO(1)=rhtso(NZS)+cotso(NZS)*SOILT1<a name='2886'>
          tsob=soilt1<a name='2887'>
        else<a name='2888'>
<font color=#447700>!-- 1 layer in snow<a name='2889'></font>
          TSO(1)=rhtso(NZS)+cotso(NZS)*SOILT<a name='2890'>
          SOILT1=TSO(1)<a name='2891'>
          tsob=tso(1)<a name='2892'>
        endif<a name='2893'>
       ELSE<a name='2894'>
<font color=#447700>!-- all snow is evaporated<a name='2895'></font>
         TSO(1)=SOILT<a name='2896'>
         SOILT1=SOILT<a name='2897'>
         tsob=SOILT<a name='2898'>
       ENDIF<a name='2899'>
<a name='2900'>
<font color=#447700>!---- Final solution for TSO<a name='2901'></font>
          DO K=2,NZS<a name='2902'>
            KK=NZS-K+1<a name='2903'>
            TSO(K)=rhtso(KK)+cotso(KK)*TSO(K-1)<a name='2904'>
          END DO<a name='2905'>
<font color=#447700>!--- For thin snow layer combined with the top soil layer<a name='2906'></font>
<font color=#447700>!--- TSO is computed by linear inmterpolation between SOILT<a name='2907'></font>
<font color=#447700>!--- and TSO(2)<a name='2908'></font>
<a name='2909'>
       if(SNHEI.LT.SNTH.AND.SNHEI.GT.0.)then<a name='2910'>
          tso(1)=tso(2)+(soilt-tso(2))*fso<a name='2911'>
          SOILT1=TSO(1)<a name='2912'>
          tsob=tso(1)<a name='2913'>
       endif<a name='2914'>
<a name='2915'>
<font color=#447700>!--- IF SOILT &gt; 273.15 F then melting of snow can happen<a name='2916'></font>
   IF(SOILT.GE.273.15.AND.SNHEI.GT.0.) THEN<a name='2917'>
         SOILT=273.15<a name='2918'>
         QSG= <A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN'>QSN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWTEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSN_4">(273.15,TBQ)/PP<a name='2919'>
         QVG=QSG<a name='2920'>
        T3      = STBOLT*SOILT*SOILT*SOILT<a name='2921'>
        UPFLUX  = T3 * SOILT<a name='2922'>
        XINET   = EMISS*(GLW-UPFLUX)<a name='2923'>
        RNET = GSW + XINET<a name='2924'>
         EPOT = -QKMS*(QVATM-QSG)<a name='2925'>
         Q1=EPOT*RAS<a name='2926'>
<a name='2927'>
        IF (Q1.LE.0.) THEN<a name='2928'>
<font color=#447700>! ---  condensation<a name='2929'></font>
          DEW=-EPOT<a name='2930'>
          DO K=1,NZS<a name='2931'>
            TRANSP(K)=0.<a name='2932'>
          ENDDO<a name='2933'>
<a name='2934'>
        QFX= XLVM*RHO*DEW<a name='2935'>
       ELSE<a name='2936'>
<font color=#447700>! ---  evaporation<a name='2937'></font>
          DO K=1,NROOT<a name='2938'>
            TRANSP(K)=-VEGFRAC*q1                                     &amp;<a name='2939'>
                      *PC*TRANF(K)*DRYCAN/zshalf(NROOT+1)<a name='2940'>
           IF(TRANSP(K).GT.0.) TRANSP(K)=0.<a name='2941'>
            ETT1=ETT1-TRANSP(K)<a name='2942'>
          ENDDO<a name='2943'>
          DO k=nroot+1,nzs<a name='2944'>
            transp(k)=0.<a name='2945'>
          enddo<a name='2946'>
<a name='2947'>
        EDIR1 = Q1*UMVEG * BETA<a name='2948'>
        EC1 = Q1 * WETCAN *VEGFRAC<a name='2949'>
        CMC2MS=CST/DELT<a name='2950'>
        EC1=MIN(CMC2MS,EC1)<a name='2951'>
        EETA = (EDIR1 + EC1 + ETT1)*1.E3<a name='2952'>
<font color=#447700>! to convert from kg m-2 s-1 to m s-1: 1/rho water=1.e-3************ <a name='2953'></font>
        QFX= - XLVM * EETA<a name='2954'>
       ENDIF<a name='2955'>
<a name='2956'>
         HFX=D10*(TABS-273.15)<a name='2957'>
<a name='2958'>
       IF(SNHEI.GE.SNTH)then<a name='2959'>
         SOH=thdifsn*RHOCSN*(273.15-TSOB)/SNPRIM<a name='2960'>
       ELSE<a name='2961'>
         SOH=(fsn*thdifsn*rhocsn+fso*thdif(1)*rhcs)*                  &amp;<a name='2962'>
              (273.15-TSOB)/snprim<a name='2963'>
       ENDIF<a name='2964'>
<a name='2965'>
         X= (R21+D9SN*R22SN)*(273.15-TNOLD) +                         &amp;<a name='2966'>
            XLVM*R210*(QSG-QGOLD)<a name='2967'>
<font color=#447700>!-- SNOH is energy flux of snow phase change<a name='2968'></font>
        SNOH=AMAX1(0.,RNET+QFX                                        &amp;<a name='2969'>
                      +HFX                                            &amp; <a name='2970'>
                  +RHOCSN*NEWSNOW/DELT*(TABS-273.15)                  &amp;<a name='2971'>
                  -SOH-X+RAINF*CVW*PRCPMS*                            &amp;<a name='2972'>
                  (TABS-273.15)) <a name='2973'>
<font color=#447700>!-- SMELT is speed of melting in M/S<a name='2974'></font>
        SMELT= SNOH /XLMELT*1.E-3<a name='2975'>
<font color=#447700>!        SMELT=AMIN1(SMELT,SNWEPR/DELT-BETA*EPOT*RAS)<a name='2976'></font>
        SMELT=AMIN1(SMELT,SNWEPR/DELT-BETA*EPOT*RAS*UMVEG)<a name='2977'>
<a name='2978'>
        SNOHGNEW=SMELT*XLMELT*1.E3<a name='2979'>
        SNODIF=AMAX1(0.,SNOH-SNOHGNEW)<a name='2980'>
<a name='2981'>
        SNOH=SNOHGNEW<a name='2982'>
<font color=#447700>!       SNOHSMELT*XLMELT*1.E3<a name='2983'></font>
<a name='2984'>
<font color=#447700>!*** From Koren et al. (1999) 13% of snow melt stays in the snow pack<a name='2985'></font>
        rsm=0.13*smelt*delt<a name='2986'>
<a name='2987'>
        SMELT=SMELT-rsm/delt<a name='2988'>
<a name='2989'>
<font color=#447700>!-- correction of liquid equivalent of snow depth<a name='2990'></font>
<font color=#447700>!-- due to evaporation and snow melt<a name='2991'></font>
        SNWE = AMAX1(0.,SNWEPR-                                      &amp;<a name='2992'>
<font color=#447700>!     1              (SMELT+BETA*EPOT*RAS)*DELT<a name='2993'></font>
                    (SMELT+BETA*EPOT*RAS*UMVEG)*DELT                 &amp;<a name='2994'>
                                          )<a name='2995'>
<a name='2996'>
<font color=#447700>!--- If all snow melts, then 13% of snow melt we kept in the<a name='2997'></font>
<font color=#447700>!--- snow pack should be added back to snow melt and infiltrate<a name='2998'></font>
<font color=#447700>!--- into soil.<a name='2999'></font>
        if(snwe.le.rsm) then<a name='3000'>
           smelt=smelt+rsm/delt<a name='3001'>
           snwe=0.<a name='3002'>
           rsm=0.<a name='3003'>
           SOILT=SNODIF*DELT/RHCS*ZSHALF(2)                          &amp;  <a name='3004'>
                   +273.15<a name='3005'>
        else<a name='3006'>
<font color=#447700>!*** Correct snow density on effect of snow melt, melted<a name='3007'></font>
<font color=#447700>!*** from the top of the snow. 13% of melted water<a name='3008'></font>
<font color=#447700>!*** remains in the pack and changes its density.<a name='3009'></font>
<font color=#447700>!*** Eq. 9 (with my correction) in Koren et al. (1999)<a name='3010'></font>
           <a name='3011'>
          if(snwe.gt.snth*rhosn*1.e-3) then<a name='3012'>
         xsn=(rhosn*(snwe-rsm)+1.e3*rsm)/                            &amp;<a name='3013'>
             snwe<a name='3014'>
         rhosn=MIN(XSN,400.)<a name='3015'>
<a name='3016'>
        RHOCSN=2090.* RHOSN<a name='3017'>
        thdifsn = 0.265/RHOCSN<a name='3018'>
          endif  <a name='3019'>
<a name='3020'>
        endif<a name='3021'>
<a name='3022'>
<font color=#447700>!--- If there is no snow melting then just evaporation<a name='3023'></font>
<font color=#447700>!--- or condensation cxhanges SNWE<a name='3024'></font>
      ELSE<a name='3025'>
               SNWE = AMAX1(0.,SNWEPR-                               &amp;<a name='3026'>
                    BETA*EPOT*RAS*UMVEG*DELT)<a name='3027'>
<a name='3028'>
      ENDIF<a name='3029'>
<font color=#447700>!*** Correct snow density on effect of snow melt, melted<a name='3030'></font>
<font color=#447700>!*** from the top of the snow. 13% of melted water<a name='3031'></font>
<font color=#447700>!*** remains in the pack and changes its density.<a name='3032'></font>
<font color=#447700>!*** Eq. 9 (with my correction) in Koren et al. (1999)<a name='3033'></font>
<a name='3034'>
        SNHEI=SNWE *1.E3 / RHOSN<a name='3035'>
<a name='3036'>
<font color=#447700>!--  Snow melt from the top is done. But if ground surface temperature<a name='3037'></font>
<font color=#447700>!--  is above freezing snow can melt from the bottom. The following<a name='3038'></font>
<font color=#447700>!--  piece of code will check if bottom melting is possible.<a name='3039'></font>
<a name='3040'>
        IF(TSO(1).GE.273.15.AND.SNHEI.GT.0.) THEN<a name='3041'>
        SNOHG=(TSO(1)-273.15)*(RHCS*zshalf(2)+                       &amp;<a name='3042'>
               RHOCSN*0.5*SNHEI) / DELT<a name='3043'>
        SNODIF=0. <a name='3044'>
          TSO(1)=273.15<a name='3045'>
        SMELTG=SNOHG/XLMELT*1.E-3<a name='3046'>
        SMELTG=AMIN1(SMELTG,SNWE/DELT)<a name='3047'>
        SNOHGNEW=SMELTG*XLMELT*1.e3<a name='3048'>
        SNODIF=AMAX1(0.,SNOHG-SNOHGNEW)<a name='3049'>
        SNWE = AMAX1(0.,SNWE-SMELTG*DELT)<a name='3050'>
         if(snwe.eq.0.)then<a name='3051'>
        TSO(1)=SNODIF*DELT/RHCS*zshalf(2) + 273.15<a name='3052'>
          endif<a name='3053'>
<a name='3054'>
        SMELT=SMELT+SMELTG<a name='3055'>
        SNOH=SNOH+SNOHGNEW<a name='3056'>
<a name='3057'>
       ENDIF<a name='3058'>
<a name='3059'>
        SNHEI=SNWE *1.E3 / RHOSN<a name='3060'>
<a name='3061'>
        snweprint=snwe                                              &amp;<a name='3062'>
<font color=#447700>!--- if VEGFRAC.ne.0. then some snow stays on the canopy<a name='3063'></font>
<font color=#447700>!--- and should be added to SNWE for water conservation<a name='3064'></font>
                    +VEGFRAC*cst<a name='3065'>
        snheiprint=snweprint*1.E3 / RHOSN<a name='3066'>
<a name='3067'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3068'>
print *, 'snweprint : ',snweprint<a name='3069'>
print *, 'D9SN,SOILT,TSOB : ', D9SN,SOILT,TSOB<a name='3070'>
    ENDIF<a name='3071'>
<font color=#447700>!--- Compute flux in the top snow layer<a name='3072'></font>
      SNFLX=D9SN*(SOILT-TSOB)<a name='3073'>
<a name='3074'>
<font color=#447700>!        return<a name='3075'></font>
<font color=#447700>!        end<a name='3076'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3077'></font>
   END SUBROUTINE SNOWTEMP<a name='3078'>
<font color=#447700>!------------------------------------------------------------------------<a name='3079'></font>
<a name='3080'>
<a name='3081'>
<A NAME='SOILMOIST'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILMOIST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3082'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOILMOIST</font> (                                  &amp; <A href='../../call_to/SOILMOIST.html' TARGET='index'>2</A><a name='3083'>
<font color=#447700>!--input parameters<a name='3084'></font>
              DELT,NZS,NDDZS,DTDZS,DTDZS2,                      &amp;<a name='3085'>
              ZSMAIN,ZSHALF,DIFFU,HYDRO,                        &amp;<a name='3086'>
              QSG,QVG,QCG,QCATM,QVATM,PRCP,                     &amp;<a name='3087'>
              QKMS,TRANSP,DRIP,                                 &amp;<a name='3088'>
              DEW,SMELT,SOILICE,VEGFRAC,                        &amp;<a name='3089'>
<font color=#447700>!--soil properties<a name='3090'></font>
              DQM,QMIN,REF,KSAT,RAS,INFMAX,                     &amp;<a name='3091'>
<font color=#447700>!--output<a name='3092'></font>
              SOILMOIS,MAVAIL,RUNOFF,RUNOFF2,INFILTRP)<a name='3093'>
<font color=#447700>!*************************************************************************<a name='3094'></font>
<font color=#447700>!   moisture balance equation and Richards eqn.<a name='3095'></font>
<font color=#447700>!   are solved here <a name='3096'></font>
<font color=#447700>!   <a name='3097'></font>
<font color=#447700>!     DELT - time step<a name='3098'></font>
<font color=#447700>!     IME,JME,NZS - dimensions of soil domain<a name='3099'></font>
<font color=#447700>!     ZSMAIN - main levels in soil<a name='3100'></font>
<font color=#447700>!     ZSHALF - middle of the soil layers<a name='3101'></font>
<font color=#447700>!     DTDZS -  dt/(2.*dzshalf*dzmain)<a name='3102'></font>
<font color=#447700>!     DTDZS2 - dt/(2.*dzshalf)<a name='3103'></font>
<font color=#447700>!     DIFFU - diffusional conductivity<a name='3104'></font>
<font color=#447700>!     HYDRO - hydraulic conductivity<a name='3105'></font>
<font color=#447700>!     QSG,QVG,QCG - saturated mixing ratio, mixing ratio of<a name='3106'></font>
<font color=#447700>!                   water vapor and cloud at the ground<a name='3107'></font>
<font color=#447700>!                   surface, respectively<a name='3108'></font>
<font color=#447700>!     QCATM,QVATM - cloud and water vapor mixing ratio<a name='3109'></font>
<font color=#447700>!                   at the first atm. level<a name='3110'></font>
<font color=#447700>!     PRCP - precipitation rate in m/s<a name='3111'></font>
<font color=#447700>!     QKMS - exchange coefficient for water vapor in the<a name='3112'></font>
<font color=#447700>!              surface layer (m/s)<a name='3113'></font>
<font color=#447700>!     TRANSP - transpiration from the soil layers<a name='3114'></font>
<font color=#447700>!     DRIP - liquid water dripping from the canopy to soil<a name='3115'></font>
<font color=#447700>!     DEW -  dew in kg/m^2s<a name='3116'></font>
<font color=#447700>!     SMELT - melting rate in m/s<a name='3117'></font>
<font color=#447700>!     SOILICE - volumetric content of ice in soil<a name='3118'></font>
<font color=#447700>!     VEGFRAC - greeness fraction<a name='3119'></font>
<font color=#447700>!     RAS - ration of air density to soil density<a name='3120'></font>
<font color=#447700>!     INFMAX - maximum infiltration rate<a name='3121'></font>
<font color=#447700>!    <a name='3122'></font>
<font color=#447700>!     SOILMOIS - volumetric soil moisture, 6 levels<a name='3123'></font>
<font color=#447700>!     MAVAIL - fraction of maximum soil moisture in the top<a name='3124'></font>
<font color=#447700>!               layer<a name='3125'></font>
<font color=#447700>!     RUNOFF - surface runoff (m/s)<a name='3126'></font>
<font color=#447700>!     RUNOFF2 - underground runoff (m)<a name='3127'></font>
<font color=#447700>!     INFILTRP - point infiltration flux into soil (m/s)<a name='3128'></font>
<font color=#447700>!            /(snow bottom runoff) (mm/s)<a name='3129'></font>
<font color=#447700>!<a name='3130'></font>
<font color=#447700>!     COSMC, RHSMC - coefficients for implicit solution of<a name='3131'></font>
<font color=#447700>!                     Richards equation<a name='3132'></font>
<font color=#447700>!******************************************************************<a name='3133'></font>
        IMPLICIT NONE<a name='3134'>
<font color=#447700>!------------------------------------------------------------------<a name='3135'></font>
<font color=#447700>!--- input variables<a name='3136'></font>
   REAL,     INTENT(IN   )   ::  DELT<a name='3137'>
   INTEGER,  INTENT(IN   )   ::  NZS,NDDZS<a name='3138'>
<a name='3139'>
<font color=#447700>! input variables<a name='3140'></font>
<a name='3141'>
   REAL,     DIMENSION(1:NZS), INTENT(IN   )  ::         ZSMAIN, &amp;<a name='3142'>
                                                         ZSHALF, &amp;<a name='3143'>
                                                          DIFFU, &amp;<a name='3144'>
                                                          HYDRO, &amp;<a name='3145'>
                                                         TRANSP, &amp;<a name='3146'>
                                                        SOILICE, &amp;<a name='3147'>
                                                         DTDZS2<a name='3148'>
<a name='3149'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='3150'>
<a name='3151'>
   REAL,     INTENT(IN   )   ::    QSG,QVG,QCG,QCATM,QVATM     , &amp;<a name='3152'>
                                   QKMS,VEGFRAC,DRIP,PRCP      , &amp;<a name='3153'>
                                   DEW,SMELT                   , &amp;<a name='3154'>
                                   DQM,QMIN,REF,KSAT,RAS<a name='3155'>
                         <a name='3156'>
<font color=#447700>! output<a name='3157'></font>
<a name='3158'>
   REAL,     DIMENSION(  1:nzs )                               , &amp;<a name='3159'>
<a name='3160'>
             INTENT(INOUT)   ::                        SOILMOIS     <a name='3161'>
                                                  <a name='3162'>
   REAL,     INTENT(INOUT)   ::  MAVAIL,RUNOFF,RUNOFF2,INFILTRP, &amp;<a name='3163'>
                                                        INFMAX<a name='3164'>
<a name='3165'>
<font color=#447700>! local variables<a name='3166'></font>
<a name='3167'>
   REAL,     DIMENSION( 1:nzs )  ::  COSMC,RHSMC<a name='3168'>
<a name='3169'>
   REAL    ::  DZS,R1,R2,R3,R4,R5,R6,R7,R8,R9,R10<a name='3170'>
   REAL    ::  REFKDT,REFDK,DELT1,F1MAX,F2MAX<a name='3171'>
   REAL    ::  F1,F2,FD,KDT,VAL,DDT,PX<a name='3172'>
   REAL    ::  QQ,UMVEG,INFMAX1,TRANS<a name='3173'>
   REAL    ::  TOTLIQ,FLX,FLXSAT,QTOT<a name='3174'>
   REAL    ::  DID,X1,X2,X4,DENOM,Q2,Q4<a name='3175'>
   REAL    ::  dice,fcr,acrt,frzx,sum,cvfrz<a name='3176'>
<a name='3177'>
   INTEGER ::  NZS1,NZS2,K,KK,K1,KN,ialp1,jj,jk<a name='3178'>
<a name='3179'>
<font color=#447700>!******************************************************************************<a name='3180'></font>
<font color=#447700>!       COEFFICIENTS FOR THOMAS ALGORITHM FOR SOILMOIS<a name='3181'></font>
<font color=#447700>!******************************************************************************<a name='3182'></font>
          NZS1=NZS-1                                                            <a name='3183'>
          NZS2=NZS-2<a name='3184'>
<a name='3185'>
 118      format(6(10Pf23.19))<a name='3186'>
<a name='3187'>
           do k=1,nzs<a name='3188'>
            cosmc(k)=0.<a name='3189'>
            rhsmc(k)=0.<a name='3190'>
           enddo<a name='3191'>
 <a name='3192'>
        DID=(ZSMAIN(NZS)-ZSHALF(NZS))*2.<a name='3193'>
        X1=ZSMAIN(NZS)-ZSMAIN(NZS1)<a name='3194'>
<font color=#447700>!        DENOM=DID/DELT+DIFFU(NZS1)/X1<a name='3195'></font>
<font color=#447700>!        COSMC(1)=DIFFU(NZS1)/X1/DENOM<a name='3196'></font>
<font color=#447700>!        RHSMC(1)=(SOILMOIS(NZS)*DID/DELT<a name='3197'></font>
<font color=#447700>!     1   +TRANSP(NZS)-(HYDRO(NZS)*SOILMOIS(NZS)<a name='3198'></font>
<font color=#447700>!     1   -HYDRO(NZS1)*SOILMOIS(NZS1))*DID<a name='3199'></font>
<font color=#447700>!     1   /X1) /DENOM<a name='3200'></font>
<a name='3201'>
        DENOM=(1.+DIFFU(nzs1)/X1/DID*DELT+HYDRO(NZS)/(2.*DID)*DELT)<a name='3202'>
        COSMC(1)=DELT*(DIFFU(nzs1)/DID/X1                                 &amp;<a name='3203'>
                    +HYDRO(NZS1)/2./DID)/DENOM<a name='3204'>
        RHSMC(1)=(SOILMOIS(NZS)+TRANSP(NZS)*DELT/                         &amp;<a name='3205'>
               DID)/DENOM<a name='3206'>
<a name='3207'>
        DO 330 K=1,NZS2<a name='3208'>
          KN=NZS-K<a name='3209'>
          K1=2*KN-3<a name='3210'>
          X4=2.*DTDZS(K1)*DIFFU(KN-1)<a name='3211'>
          X2=2.*DTDZS(K1+1)*DIFFU(KN)<a name='3212'>
          Q4=X4+HYDRO(KN-1)*DTDZS2(KN-1)<a name='3213'>
          Q2=X2-HYDRO(KN+1)*DTDZS2(KN-1)<a name='3214'>
          DENOM=1.+X2+X4-Q2*COSMC(K)<a name='3215'>
          COSMC(K+1)=Q4/DENOM<a name='3216'>
 330      RHSMC(K+1)=(SOILMOIS(KN)+Q2*RHSMC(K)                            &amp;<a name='3217'>
                   +TRANSP(KN)                                            &amp;<a name='3218'>
                   /(ZSHALF(KN+1)-ZSHALF(KN))                             &amp;<a name='3219'>
                   *DELT)/DENOM<a name='3220'>
<a name='3221'>
<font color=#447700>! --- MOISTURE BALANCE BEGINS HERE<a name='3222'></font>
<a name='3223'>
          TRANS=TRANSP(1)<a name='3224'>
          UMVEG=1.-VEGFRAC<a name='3225'>
<a name='3226'>
          RUNOFF=0.<a name='3227'>
          RUNOFF2=0.<a name='3228'>
          DZS=ZSMAIN(2)<a name='3229'>
          R1=COSMC(NZS1)<a name='3230'>
          R2= RHSMC(NZS1)<a name='3231'>
          R3=DIFFU(1)/DZS<a name='3232'>
          R4=R3+HYDRO(1)*.5          <a name='3233'>
          R5=R3-HYDRO(2)*.5<a name='3234'>
          R6=QKMS*RAS<a name='3235'>
<font color=#447700>!-- Total liquid water available on the top of soil domain<a name='3236'></font>
<font color=#447700>!-- Without snow - 3 sources of water: precipitation,<a name='3237'></font>
<font color=#447700>!--         water dripping from the canopy and dew <a name='3238'></font>
<font color=#447700>!-- With snow - only one source of water - snow melt<a name='3239'></font>
<a name='3240'>
<font color=#447700>!        print *,'PRCP,DRIP,DEW,umveg,ras,smelt',<a name='3241'></font>
<font color=#447700>!     1       PRCP,DRIP,DEW,umveg,ras,smelt<a name='3242'></font>
<font color=#447700>!        if (drip.ne.0.) then<a name='3243'></font>
<font color=#447700>!          print *,'DRIP non-zero'<a name='3244'></font>
<font color=#447700>!          write(6,191) drip<a name='3245'></font>
<font color=#447700>!          write (6,191)soilmois(1)<a name='3246'></font>
<font color=#447700>!         write (6,191)soilmois(2)<a name='3247'></font>
<font color=#447700>!        endif<a name='3248'></font>
  191   format (f23.19)<a name='3249'>
<a name='3250'>
        TOTLIQ=UMVEG*PRCP-DRIP/DELT-UMVEG*DEW*RAS-SMELT<a name='3251'>
<a name='3252'>
<a name='3253'>
        FLX=TOTLIQ<a name='3254'>
        INFILTRP=TOTLIQ<a name='3255'>
<a name='3256'>
<font color=#447700>! -----------     FROZEN GROUND VERSION    -------------------------<a name='3257'></font>
<font color=#447700>!   REFERENCE FROZEN GROUND PARAMETER, CVFRZ, IS A SHAPE PARAMETER OF<a name='3258'></font>
<font color=#447700>!   AREAL DISTRIBUTION FUNCTION OF SOIL ICE CONTENT WHICH EQUALS 1/CV.<a name='3259'></font>
<font color=#447700>!   CV IS A COEFFICIENT OF SPATIAL VARIATION OF SOIL ICE CONTENT.<a name='3260'></font>
<font color=#447700>!   BASED ON FIELD DATA CV DEPENDS ON AREAL MEAN OF FROZEN DEPTH, AND IT<a name='3261'></font>
<font color=#447700>!   CLOSE TO CONSTANT = 0.6 IF AREAL MEAN FROZEN DEPTH IS ABOVE 20 CM.<a name='3262'></font>
<font color=#447700>!   THAT IS WHY PARAMETER CVFRZ = 3 (INT{1/0.6*0.6})<a name='3263'></font>
<font color=#447700>!<a name='3264'></font>
<font color=#447700>!   Current logic doesn't allow CVFRZ be bigger than 3<a name='3265'></font>
         CVFRZ = 3.<a name='3266'>
<a name='3267'>
<font color=#447700>!-- SCHAAKE/KOREN EXPRESSION for calculation of max infiltration<a name='3268'></font>
         REFKDT=3.<a name='3269'>
         REFDK=3.4341E-6<a name='3270'>
         DELT1=DELT/86400.<a name='3271'>
         F1MAX=DQM*ZSHALF(2)<a name='3272'>
         F2MAX=DQM*(ZSHALF(3)-ZSHALF(2))<a name='3273'>
         F1=F1MAX*(1.-SOILMOIS(1)/DQM)<a name='3274'>
         F2=F2MAX*(1.-SOILMOIS(2)/DQM)<a name='3275'>
         FD=F1+F2<a name='3276'>
         KDT=REFKDT*KSAT/REFDK<a name='3277'>
         VAL=(1.-EXP(-KDT*DELT1))<a name='3278'>
         DDT = FD*VAL<a name='3279'>
         PX= - TOTLIQ * DELT<a name='3280'>
         IF(PX.LT.0.0) PX = 0.0<a name='3281'>
       if(ddt.eq.0.) then<a name='3282'>
         infmax1=ksat<a name='3283'>
        else<a name='3284'>
         INFMAX1 = (PX*(DDT/(PX+DDT)))/DELT<a name='3285'>
         INFMAX1 = MIN(INFMAX1, KSAT)<a name='3286'>
        endif<a name='3287'>
<font color=#447700>!         print *,'INFMAX1=,ksat',infmax1,ksat,f1,f2,kdt,val,ddt,px<a name='3288'></font>
<font color=#447700>! -----------     FROZEN GROUND VERSION    --------------------------<a name='3289'></font>
<font color=#447700>!    REDUCTION OF INFILTRATION BASED ON FROZEN GROUND PARAMETERS<a name='3290'></font>
<font color=#447700>!<a name='3291'></font>
<font color=#447700>! ------------------------------------------------------------------<a name='3292'></font>
<a name='3293'>
          DICE = soilice(1)*zshalf(2)<a name='3294'>
      DO K=2,NZS1<a name='3295'>
          DICE = DICE + ( ZSHALF(K+1) - ZSHALF(K) ) * soilice(k)<a name='3296'>
      ENDDO<a name='3297'>
         FRZX= 0.28*((dqm+qmin)/ref) * (0.400 / 0.482)<a name='3298'>
         FCR = 1.<a name='3299'>
         IF ( DICE .GT. 1.E-2) THEN<a name='3300'>
           ACRT = CVFRZ * FRZX / DICE<a name='3301'>
           SUM = 1.<a name='3302'>
           IALP1 = CVFRZ - 1<a name='3303'>
           DO JK = 1,IALP1<a name='3304'>
              K = 1<a name='3305'>
              DO JJ = JK+1, IALP1<a name='3306'>
                K = K * JJ<a name='3307'>
              END DO<a name='3308'>
              SUM = SUM + (ACRT ** ( CVFRZ-JK)) / FLOAT (K)<a name='3309'>
           END DO<a name='3310'>
           FCR = 1. - EXP(-ACRT) * SUM<a name='3311'>
         END IF<a name='3312'>
<font color=#447700>!          print *,'FCR--------',fcr<a name='3313'></font>
         INFMAX1 = INFMAX1* FCR<a name='3314'>
         INFMAX1 = MIN(INFMAX1, KSAT)<a name='3315'>
<font color=#447700>! -------------------------------------------------------------------<a name='3316'></font>
<a name='3317'>
         INFMAX = MIN(INFMAX,INFMAX1)<a name='3318'>
<font color=#447700>!----<a name='3319'></font>
          IF (-TOTLIQ.GE.INFMAX)THEN<a name='3320'>
            RUNOFF=-TOTLIQ-INFMAX<a name='3321'>
            FLX=-INFMAX<a name='3322'>
          ENDIF<a name='3323'>
<font color=#447700>! INFILTRP is total infiltration flux in M/S<a name='3324'></font>
          INFILTRP=FLX<a name='3325'>
<font color=#447700>!           print *,'PRCIP',infiltrp,flx,infmax<a name='3326'></font>
<font color=#447700>! Solution of moisture budget<a name='3327'></font>
          R7=.5*DZS/DELT<a name='3328'>
          R4=R4+R7<a name='3329'>
          FLX=FLX-SOILMOIS(1)*R7<a name='3330'>
          R8=UMVEG*R6<a name='3331'>
          QTOT=QVATM+QCATM<a name='3332'>
          R9=TRANS<a name='3333'>
          R10=QTOT-QSG<a name='3334'>
<font color=#447700>!-- evaporation regime<a name='3335'></font>
          IF(R10.LE.0.) THEN<a name='3336'>
            QQ=(R5*R2-FLX+R9)/(R4-R5*R1-R10*R8/(REF-QMIN))<a name='3337'>
            FLXSAT=-DQM*(R4-R5*R1-R10*R8/(REF-QMIN))                &amp;<a name='3338'>
                   +R5*R2+R9<a name='3339'>
          ELSE<a name='3340'>
<font color=#447700>!-- dew formation regime<a name='3341'></font>
            QQ=(R2*R5-FLX+R8*(QTOT-QCG-QVG)+R9)/(R4-R1*R5)<a name='3342'>
            FLXSAT=-DQM*(R4-R1*R5)+R2*R5+R8*(QTOT-QVG-QCG)+R9<a name='3343'>
          END IF<a name='3344'>
<a name='3345'>
          IF(QQ.LT.0.) THEN<a name='3346'>
            SOILMOIS(1)=0.<a name='3347'>
<a name='3348'>
          ELSE IF(QQ.GT.DQM) THEN<a name='3349'>
<font color=#447700>!-- saturation<a name='3350'></font>
            SOILMOIS(1)=DQM<a name='3351'>
            RUNOFF2=runoff2+(FLXSAT-FLX)*DELT<a name='3352'>
            RUNOFF=RUNOFF+(FLXSAT-FLX)<a name='3353'>
          ELSE<a name='3354'>
            SOILMOIS(1)=QQ<a name='3355'>
          END IF<a name='3356'>
<a name='3357'>
<font color=#447700>!--- FINAL SOLUTION FOR SOILMOIS <a name='3358'></font>
          DO K=2,NZS<a name='3359'>
            KK=NZS-K+1<a name='3360'>
            QQ=COSMC(KK)*SOILMOIS(K-1)+RHSMC(KK)<a name='3361'>
<a name='3362'>
           IF (QQ.LT.0.) THEN<a name='3363'>
            SOILMOIS(K)=0.<a name='3364'>
<a name='3365'>
           ELSE IF(QQ.GT.DQM) THEN<a name='3366'>
<font color=#447700>!-- saturation<a name='3367'></font>
            SOILMOIS(K)=DQM<a name='3368'>
             IF(K.EQ.NZS)THEN<a name='3369'>
               RUNOFF2=RUNOFF2+(QQ-DQM)*(ZSMAIN(K)-ZSHALF(K))<a name='3370'>
             ELSE<a name='3371'>
               RUNOFF2=RUNOFF2+(QQ-DQM)*(ZSMAIN(K+1)-ZSHALF(K))<a name='3372'>
             ENDIF<a name='3373'>
           ELSE<a name='3374'>
            SOILMOIS(K)= QQ<a name='3375'>
           END IF<a name='3376'>
          END DO<a name='3377'>
<a name='3378'>
           MAVAIL=min(1.,SOILMOIS(1)/DQM)<a name='3379'>
          if (MAVAIL.EQ.0.) MAVAIL=.000001<a name='3380'>
<a name='3381'>
<font color=#447700>!        RETURN<a name='3382'></font>
<font color=#447700>!        END<a name='3383'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='3384'></font>
    END SUBROUTINE SOILMOIST<a name='3385'>
<font color=#447700>!-------------------------------------------------------------------<a name='3386'></font>
<a name='3387'>
<a name='3388'>
<A NAME='SOILPROP'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILPROP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3389'>
            <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOILPROP</font>(                                  &amp; <A href='../../call_to/SOILPROP.html' TARGET='index'>2</A><a name='3390'>
<font color=#447700>!--- input variables<a name='3391'></font>
         nzs,fwsat,lwsat,tav,keepfr,                              &amp;<a name='3392'>
         soilmois,soiliqw,soilice,                                &amp;<a name='3393'>
         soilmoism,soiliqwm,soilicem,                             &amp;<a name='3394'>
<font color=#447700>!--- soil fixed fields<a name='3395'></font>
         QWRTZ,rhocs,dqm,qmin,psis,bclh,ksat,                     &amp;<a name='3396'>
<font color=#447700>!--- constants<a name='3397'></font>
         riw,xlmelt,CP,G0_P,cvw,ci,                               &amp; <a name='3398'>
         kqwrtz,kice,kwt,                                         &amp;<a name='3399'>
<font color=#447700>!--- output variables<a name='3400'></font>
         thdif,diffu,hydro,cap)<a name='3401'>
<a name='3402'>
<font color=#447700>!******************************************************************<a name='3403'></font>
<font color=#447700>! SOILPROP computes thermal diffusivity, and diffusional and<a name='3404'></font>
<font color=#447700>!          hydraulic condeuctivities<a name='3405'></font>
<font color=#447700>!******************************************************************<a name='3406'></font>
<font color=#447700>! NX,NY,NZS - dimensions of soil domain<a name='3407'></font>
<font color=#447700>! FWSAT, LWSAT - volumetric content of frozen and liquid water<a name='3408'></font>
<font color=#447700>!                for saturated condition at given temperatures<a name='3409'></font>
<font color=#447700>! TAV - temperature averaged for soil layers<a name='3410'></font>
<font color=#447700>! SOILMOIS - volumetric soil moisture at the main soil levels<a name='3411'></font>
<font color=#447700>! SOILMOISM - volumetric soil moisture averaged for layers<a name='3412'></font>
<font color=#447700>! SOILIQWM - volumetric liquid soil moisture averaged for layers<a name='3413'></font>
<font color=#447700>! SOILICEM - volumetric content of soil ice averaged for layers<a name='3414'></font>
<font color=#447700>! THDIF - thermal diffusivity for soil layers<a name='3415'></font>
<font color=#447700>! DIFFU - diffusional conductivity <a name='3416'></font>
<font color=#447700>! HYDRO - hydraulic conductivity<a name='3417'></font>
<font color=#447700>! CAP - volumetric heat capacity<a name='3418'></font>
<font color=#447700>!<a name='3419'></font>
<font color=#447700>!******************************************************************<a name='3420'></font>
<a name='3421'>
        IMPLICIT NONE<a name='3422'>
<font color=#447700>!-----------------------------------------------------------------<a name='3423'></font>
<a name='3424'>
<font color=#447700>!--- soil properties<a name='3425'></font>
   INTEGER, INTENT(IN   )    ::                            NZS<a name='3426'>
   REAL                                                        , &amp;<a name='3427'>
            INTENT(IN   )    ::                           RHOCS, &amp;<a name='3428'>
                                                           BCLH, &amp;<a name='3429'>
                                                            DQM, &amp;<a name='3430'>
                                                           KSAT, &amp;<a name='3431'>
                                                           PSIS, &amp;<a name='3432'>
                                                          QWRTZ, &amp;  <a name='3433'>
                                                           QMIN<a name='3434'>
<a name='3435'>
   REAL,    DIMENSION(  1:nzs )                                , &amp;<a name='3436'>
            INTENT(IN   )    ::                        SOILMOIS, &amp;<a name='3437'>
                                                         keepfr<a name='3438'>
<a name='3439'>
<a name='3440'>
   REAL,     INTENT(IN   )   ::                              CP, &amp;<a name='3441'>
                                                            CVW, &amp;<a name='3442'>
                                                            RIW, &amp;  <a name='3443'>
                                                         kqwrtz, &amp;<a name='3444'>
                                                           kice, &amp;<a name='3445'>
                                                            kwt, &amp;<a name='3446'>
                                                         XLMELT, &amp;<a name='3447'>
                                                            G0_P<a name='3448'>
<a name='3449'>
<a name='3450'>
<a name='3451'>
<font color=#447700>!--- output variables<a name='3452'></font>
   REAL,     DIMENSION(1:NZS)                                  , &amp;<a name='3453'>
            INTENT(INOUT)  ::      cap,diffu,hydro             , &amp;<a name='3454'>
                                   thdif,tav                   , &amp;<a name='3455'>
                                   soilmoism                   , &amp;<a name='3456'>
                                   soiliqw,soilice             , &amp;<a name='3457'>
                                   soilicem,soiliqwm           , &amp;<a name='3458'>
                                   fwsat,lwsat<a name='3459'>
<a name='3460'>
<font color=#447700>!--- local variables<a name='3461'></font>
   REAL,     DIMENSION(1:NZS)  ::  hk,detal,kasat,kjpl<a name='3462'>
<a name='3463'>
   REAL    ::  x,x1,x2,x4,ws,wd,fact,fach,facd,psif,ci<a name='3464'>
   REAL    ::  tln,tavln,tn,pf,a,am,ame,h<a name='3465'>
   INTEGER ::  nzs1,k<a name='3466'>
<a name='3467'>
<font color=#447700>!-- for Johansen thermal conductivity<a name='3468'></font>
   REAL    ::  kzero,gamd,kdry,kas,x5,sr,ke       <a name='3469'>
               <a name='3470'>
<a name='3471'>
         nzs1=nzs-1<a name='3472'>
<a name='3473'>
<font color=#447700>!-- Constants for Johansen (1975) thermal conductivity<a name='3474'></font>
         kzero =2.       <font color=#447700>! if qwrtz &gt; 0.2<a name='3475'></font>
<a name='3476'>
<a name='3477'>
         do k=1,nzs<a name='3478'>
            detal (k)=0.<a name='3479'>
            kasat (k)=0.<a name='3480'>
            kjpl  (k)=0.<a name='3481'>
            hk    (k)=0.<a name='3482'>
         enddo<a name='3483'>
<a name='3484'>
           ws=dqm+qmin<a name='3485'>
           x1=xlmelt/(g0_p*psis)<a name='3486'>
           x2=x1/bclh*ws<a name='3487'>
           x4=(bclh+1.)/bclh<a name='3488'>
<font color=#447700>!--- Next 3 lines are for Johansen thermal conduct.<a name='3489'></font>
           gamd=(1.-ws)*2700.<a name='3490'>
           kdry=(0.135*gamd+64.7)/(2700.-0.947*gamd)<a name='3491'>
           kas=kqwrtz**qwrtz*kzero**(1.-qwrtz)<a name='3492'>
<a name='3493'>
         DO K=1,NZS1<a name='3494'>
           tn=tav(k) - 273.15<a name='3495'>
           wd=ws - riw*soilicem(k)<a name='3496'>
           psif=psis*100.*(wd/(soiliqwm(k)+qmin))**bclh            &amp;<a name='3497'>
                * (ws/wd)**3.<a name='3498'>
<font color=#447700>!--- PSIF should be in [CM] to compute PF<a name='3499'></font>
           pf=log10(abs(psif))<a name='3500'>
           fact=1.+riw*soilicem(k)<a name='3501'>
<font color=#447700>!--- HK is for McCumber thermal conductivity<a name='3502'></font>
         IF(PF.LE.5.2) THEN<a name='3503'>
           HK(K)=420.*EXP(-(PF+2.7))*fact<a name='3504'>
         ELSE<a name='3505'>
           HK(K)=.1744*fact<a name='3506'>
         END IF<a name='3507'>
<a name='3508'>
           IF(soilicem(k).NE.0.AND.TN.LT.0.) then<a name='3509'>
<font color=#447700>!--- DETAL is taking care of energy spent on freezing or released from <a name='3510'></font>
<font color=#447700>!          melting of soil water<a name='3511'></font>
<a name='3512'>
              DETAL(K)=273.15*X2/(TAV(K)*TAV(K))*                  &amp;<a name='3513'>
                     (TAV(K)/(X1*TN))**X4<a name='3514'>
<a name='3515'>
              if(keepfr(k).eq.1.) then<a name='3516'>
                 detal(k)=0.<a name='3517'>
              endif<a name='3518'>
<a name='3519'>
           ENDIF<a name='3520'>
<a name='3521'>
<font color=#447700>!--- Next 10 lines calculate Johansen thermal conductivity KJPL<a name='3522'></font>
           kasat(k)=kas**(1.-ws)*kice**fwsat(k)                    &amp;<a name='3523'>
                    *kwt**lwsat(k)<a name='3524'>
<a name='3525'>
           X5=(soilmoism(k)+qmin)/ws<a name='3526'>
         if(soilicem(k).eq.0.) then<a name='3527'>
           sr=max(0.101,x5)<a name='3528'>
           ke=log10(sr)+1.<a name='3529'>
<font color=#447700>!--- next 2 lines - for coarse soils<a name='3530'></font>
<font color=#447700>!           sr=max(0.0501,x5)<a name='3531'></font>
<font color=#447700>!           ke=0.7*log10(sr)+1.<a name='3532'></font>
         else<a name='3533'>
           ke=x5<a name='3534'>
         endif<a name='3535'>
<a name='3536'>
           kjpl(k)=ke*(kasat(k)-kdry)+kdry<a name='3537'>
<a name='3538'>
<font color=#447700>!--- CAP -volumetric heat capacity<a name='3539'></font>
            CAP(K)=(1.-WS)*RHOCS                                    &amp;<a name='3540'>
                  + (soiliqwm(K)+qmin)*CVW                          &amp;<a name='3541'>
                  + soilicem(K)*CI                                  &amp;<a name='3542'>
                  + (dqm-soilmoism(k))*CP*1.2                       &amp;<a name='3543'>
            - DETAL(K)*1.e3*xlmelt<a name='3544'>
<a name='3545'>
           a=RIW*soilicem(K)<a name='3546'>
<a name='3547'>
        if((ws-a).lt.0.12)then<a name='3548'>
           diffu(K)=0.<a name='3549'>
        else<a name='3550'>
           H=max(0.,(soilmoism(K)-a)/(max(1.e-8,(dqm-a))))<a name='3551'>
           facd=1.<a name='3552'>
        if(a.ne.0.)facd=1.-a/max(1.e-8,soilmoism(K))<a name='3553'>
          ame=max(1.e-8,dqm-riw*soilicem(K))<a name='3554'>
<font color=#447700>!--- DIFFU is diffusional conductivity of soil water<a name='3555'></font>
          diffu(K)=-BCLH*KSAT*PSIS/ame*                             &amp;<a name='3556'>
                  (dqm/ame)**3.                                     &amp;<a name='3557'>
                  *H**(BCLH+2.)*facd<a name='3558'>
         endif<a name='3559'>
<a name='3560'>
<font color=#447700>!          diffu(K)=-BCLH*KSAT*PSIS/dqm                              &amp;<a name='3561'></font>
<font color=#447700>!                 *H**(BCLH+2.)<a name='3562'></font>
<a name='3563'>
<a name='3564'>
<font color=#447700>!--- thdif - thermal diffusivity<a name='3565'></font>
<font color=#447700>!           thdif(K)=HK(K)/CAP(K)<a name='3566'></font>
<font color=#447700>!--- Use thermal conductivity from Johansen (1975)<a name='3567'></font>
            thdif(K)=KJPL(K)/CAP(K)<a name='3568'>
<a name='3569'>
         END DO<a name='3570'>
<a name='3571'>
         DO K=1,NZS<a name='3572'>
<a name='3573'>
         if((ws-riw*soilice(k)).lt.0.12)then<a name='3574'>
            hydro(k)=0.<a name='3575'>
         else<a name='3576'>
            fach=1.<a name='3577'>
          if(soilice(k).ne.0.)                                     &amp;<a name='3578'>
             fach=1.-riw*soilice(k)/max(1.e-8,soilmois(k))<a name='3579'>
         am=max(1.e-8,dqm-riw*soilice(k))<a name='3580'>
<font color=#447700>!--- HYDRO is hydraulic conductivity of soil water<a name='3581'></font>
          hydro(K)=KSAT/am*                                        &amp; <a name='3582'>
                  (soiliqw(K)/am)                                  &amp;<a name='3583'>
                  **(2.*BCLH+2.)                                   &amp;<a name='3584'>
                  * fach<a name='3585'>
         endif<a name='3586'>
<a name='3587'>
       ENDDO<a name='3588'>
<a name='3589'>
<font color=#447700>!       RETURN<a name='3590'></font>
<font color=#447700>!       END<a name='3591'></font>
<a name='3592'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3593'></font>
   END SUBROUTINE SOILPROP<a name='3594'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3595'></font>
<a name='3596'>
<a name='3597'>
<A NAME='TRANSF'><A href='../../html_code/phys/module_sf_ruclsm.F.html#TRANSF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3598'>
           <font color=#993300>SUBROUTINE </font><font color=#cc0000>TRANSF</font>(                                    &amp; <A href='../../call_to/TRANSF.html' TARGET='index'>2</A><a name='3599'>
<font color=#447700>!--- input variables<a name='3600'></font>
              nzs,nroot,soiliqw,                                 &amp;<a name='3601'>
<font color=#447700>!--- soil fixed fields<a name='3602'></font>
              dqm,qmin,ref,wilt,zshalf,                          &amp;<a name='3603'>
<font color=#447700>!--- output variables<a name='3604'></font>
              tranf,transum)<a name='3605'>
<a name='3606'>
<font color=#447700>!-------------------------------------------------------------------<a name='3607'></font>
<font color=#447700>!--- TRANF(K) - THE TRANSPIRATION FUNCTION (EQ. 18,19)<a name='3608'></font>
<font color=#447700>!*******************************************************************<a name='3609'></font>
<font color=#447700>! NX,NY,NZS - dimensions of soil domain<a name='3610'></font>
<font color=#447700>! SOILIQW - volumetric liquid soil moisture at the main levels<a name='3611'></font>
<font color=#447700>! TRANF - the transpiration function at levels<a name='3612'></font>
<font color=#447700>! TRANSUM - transpiration function integrated over the rooting zone<a name='3613'></font>
<font color=#447700>!<a name='3614'></font>
<font color=#447700>!*******************************************************************<a name='3615'></font>
        IMPLICIT NONE<a name='3616'>
<font color=#447700>!-------------------------------------------------------------------<a name='3617'></font>
<a name='3618'>
<font color=#447700>!--- input variables<a name='3619'></font>
<a name='3620'>
   INTEGER,  INTENT(IN   )   ::  nroot,nzs<a name='3621'>
<a name='3622'>
<font color=#447700>!--- soil properties<a name='3623'></font>
   REAL                                                        , &amp;<a name='3624'>
            INTENT(IN   )    ::                             DQM, &amp;<a name='3625'>
                                                           QMIN, &amp;<a name='3626'>
                                                            REF, &amp;<a name='3627'>
                                                           WILT<a name='3628'>
<a name='3629'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::           soiliqw, &amp;<a name='3630'>
                                                         ZSHALF<a name='3631'>
<a name='3632'>
<font color=#447700>!-- output <a name='3633'></font>
   REAL,     DIMENSION(1:NZS), INTENT(OUT)  ::            TRANF<a name='3634'>
   REAL,     INTENT(OUT)  ::                            TRANSUM  <a name='3635'>
<a name='3636'>
<font color=#447700>!-- local variables<a name='3637'></font>
   REAL    ::  totliq, did<a name='3638'>
   INTEGER ::  k<a name='3639'>
<a name='3640'>
<font color=#447700>!-- for non-linear root distribution<a name='3641'></font>
   REAL    ::  gx,sm1,sm2,sm3,sm4,ap0,ap1,ap2,ap3,ap4<a name='3642'>
   REAL,     DIMENSION(1:NZS)   ::           PART<a name='3643'>
<font color=#447700>!--------------------------------------------------------------------<a name='3644'></font>
<a name='3645'>
        do k=1,nzs<a name='3646'>
           part(k)=0.<a name='3647'>
        enddo<a name='3648'>
<a name='3649'>
        transum=0.<a name='3650'>
        totliq=soiliqw(1)+qmin<a name='3651'>
           sm1=totliq<a name='3652'>
           sm2=sm1*sm1<a name='3653'>
           sm3=sm2*sm1<a name='3654'>
           sm4=sm3*sm1<a name='3655'>
           ap0=0.299<a name='3656'>
           ap1=-8.152<a name='3657'>
           ap2=61.653<a name='3658'>
           ap3=-115.876<a name='3659'>
           ap4=59.656<a name='3660'>
           gx=ap0+ap1*sm1+ap2*sm2+ap3*sm3+ap4*sm4<a name='3661'>
          if(totliq.ge.ref) gx=1.<a name='3662'>
          if(totliq.le.0.) gx=0.<a name='3663'>
          if(gx.gt.1.) gx=1.<a name='3664'>
          if(gx.lt.0.) gx=0.<a name='3665'>
        DID=zshalf(2)<a name='3666'>
          part(1)=DID*gx<a name='3667'>
        IF(TOTLIQ.GT.REF) THEN<a name='3668'>
          TRANF(1)=DID<a name='3669'>
        ELSE IF(TOTLIQ.LE.WILT) THEN<a name='3670'>
          TRANF(1)=0.<a name='3671'>
        ELSE<a name='3672'>
          TRANF(1)=(TOTLIQ-WILT)/(REF-WILT)*DID<a name='3673'>
        ENDIF <a name='3674'>
<font color=#447700>!-- uncomment next line for non-linear root distribution<a name='3675'></font>
<font color=#447700>!cc           TRANF(1)=part(1)<a name='3676'></font>
        DO K=2,NROOT<a name='3677'>
        totliq=soiliqw(k)+qmin<a name='3678'>
           sm1=totliq<a name='3679'>
           sm2=sm1*sm1<a name='3680'>
           sm3=sm2*sm1<a name='3681'>
           sm4=sm3*sm1<a name='3682'>
           gx=ap0+ap1*sm1+ap2*sm2+ap3*sm3+ap4*sm4<a name='3683'>
          if(totliq.ge.ref) gx=1.<a name='3684'>
          if(totliq.le.0.) gx=0.<a name='3685'>
          if(gx.gt.1.) gx=1.<a name='3686'>
          if(gx.lt.0.) gx=0.<a name='3687'>
          DID=zshalf(K+1)-zshalf(K)<a name='3688'>
          part(k)=did*gx<a name='3689'>
        IF(totliq.GE.REF) THEN<a name='3690'>
          TRANF(K)=DID<a name='3691'>
        ELSE IF(totliq.LE.WILT) THEN<a name='3692'>
          TRANF(K)=0.<a name='3693'>
        ELSE<a name='3694'>
          TRANF(K)=(totliq-WILT)                                &amp;<a name='3695'>
                /(REF-WILT)*DID<a name='3696'>
        ENDIF<a name='3697'>
<font color=#447700>!-- uncomment next line for non-linear root distribution<a name='3698'></font>
<font color=#447700>!cc          TRANF(k)=part(k)<a name='3699'></font>
        END DO<a name='3700'>
<a name='3701'>
<font color=#447700>!-- TRANSUM - total for the rooting zone<a name='3702'></font>
          transum=0.<a name='3703'>
        DO K=1,NROOT<a name='3704'>
          transum=transum+tranf(k)<a name='3705'>
        END DO<a name='3706'>
<a name='3707'>
<font color=#447700>!        RETURN<a name='3708'></font>
<font color=#447700>!        END<a name='3709'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='3710'></font>
   END SUBROUTINE TRANSF<a name='3711'>
<font color=#447700>!-----------------------------------------------------------------<a name='3712'></font>
<a name='3713'>
<a name='3714'>
<A NAME='VILKA'><A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3715'>
       <font color=#993300>SUBROUTINE </font><font color=#cc0000>VILKA</font>(TN,D1,D2,PP,QS,TS,TT,NSTEP,ii,j,iland,isoil) <A href='../../call_to/VILKA.html' TARGET='index'>3</A>,<A href='../../call_from/VILKA.html' TARGET='index'>1</A><a name='3716'>
<font color=#447700>!--------------------------------------------------------------<a name='3717'></font>
<font color=#447700>!--- VILKA finds the solution of energy budget at the surface<a name='3718'></font>
<font color=#447700>!--- using table T,QS computed from Clausius-Klapeiron<a name='3719'></font>
<font color=#447700>!--------------------------------------------------------------<a name='3720'></font>
   REAL,     DIMENSION(1:4001),  INTENT(IN   )   ::  TT<a name='3721'>
   REAL,     INTENT(IN  )   ::  TN,D1,D2,PP<a name='3722'>
   INTEGER,  INTENT(IN  )   ::  NSTEP,ii,j,iland,isoil<a name='3723'>
<a name='3724'>
   REAL,     INTENT(OUT  )  ::  QS, TS<a name='3725'>
<a name='3726'>
   REAL    ::  F1,T1,T2,RN<a name='3727'>
   INTEGER ::  I,I1<a name='3728'>
     <a name='3729'>
       I=(TN-1.7315E2)/.05+1<a name='3730'>
       T1=173.1+FLOAT(I)*.05<a name='3731'>
       F1=T1+D1*TT(I)-D2<a name='3732'>
       I1=I-F1/(.05+D1*(TT(I+1)-TT(I)))<a name='3733'>
       I=I1<a name='3734'>
       IF(I.GT.4000.OR.I.LT.1) GOTO 1<a name='3735'>
  10   I1=I<a name='3736'>
       T1=173.1+FLOAT(I)*.05<a name='3737'>
       F1=T1+D1*TT(I)-D2<a name='3738'>
       RN=F1/(.05+D1*(TT(I+1)-TT(I)))<a name='3739'>
       I=I-INT(RN)                      <a name='3740'>
       IF(I.GT.4000.OR.I.LT.1) GOTO 1<a name='3741'>
       IF(I1.NE.I) GOTO 10<a name='3742'>
       TS=T1-.05*RN<a name='3743'>
       QS=(TT(I)+(TT(I)-TT(I+1))*RN)/PP<a name='3744'>
       GOTO 20<a name='3745'>
   1   PRINT *,'     AVOST IN VILKA      '<a name='3746'>
<font color=#447700>!       WRITE(12,*)'AVOST',TN,D1,D2,PP,NSTEP<a name='3747'></font>
       PRINT *,TN,D1,D2,PP,NSTEP,I,TT(i),ii,j,iland,isoil<a name='3748'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_200"> ('     AVOST IN VILKA      ' )<a name='3749'>
   20  CONTINUE<a name='3750'>
<font color=#447700>!       RETURN<a name='3751'></font>
<font color=#447700>!       END<a name='3752'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3753'></font>
   END SUBROUTINE VILKA<a name='3754'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3755'></font>
<a name='3756'>
<a name='3757'>
<A NAME='SOILVEGIN'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILVEGIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3758'>
     <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOILVEGIN</font>  ( IVGTYP,ISLTYP,IFOREST,                &amp; <A href='../../call_to/SOILVEGIN.html' TARGET='index'>1</A><a name='3759'>
                     EMISS,PC,ZNT,QWRTZ,                           &amp;<a name='3760'>
                     RHOCS,BCLH,DQM,KSAT,PSIS,QMIN,REF,WILT        )<a name='3761'>
<a name='3762'>
<font color=#447700>!************************************************************************<a name='3763'></font>
<font color=#447700>!  Set-up soil and vegetation Parameters in the case when<a name='3764'></font>
<font color=#447700>!  snow disappears during the forecast and snow parameters<a name='3765'></font>
<font color=#447700>!  shold be replaced by surface parameters according to<a name='3766'></font>
<font color=#447700>!  soil and vegetation types in this point.<a name='3767'></font>
<font color=#447700>!<a name='3768'></font>
<font color=#447700>!        Output:<a name='3769'></font>
<font color=#447700>!<a name='3770'></font>
<font color=#447700>!<a name='3771'></font>
<font color=#447700>!             Soil parameters:<a name='3772'></font>
<font color=#447700>!               DQM: MAX soil moisture content - MIN<a name='3773'></font>
<font color=#447700>!               REF:        Reference soil moisture<a name='3774'></font>
<font color=#447700>!               WILT: Wilting PT soil moisture contents<a name='3775'></font>
<font color=#447700>!               QMIN: Air dry soil moist content limits<a name='3776'></font>
<font color=#447700>!               PSIS: SAT soil potential coefs.<a name='3777'></font>
<font color=#447700>!               KSAT:  SAT soil diffusivity/conductivity coefs.<a name='3778'></font>
<font color=#447700>!               BCLH: Soil diffusivity/conductivity exponent.<a name='3779'></font>
<font color=#447700>!<a name='3780'></font>
<font color=#447700>! ************************************************************************<a name='3781'></font>
   IMPLICIT NONE<a name='3782'>
<font color=#447700>!---------------------------------------------------------------------------<a name='3783'></font>
      integer,   parameter      ::      nsoilclas=19<a name='3784'>
      integer,   parameter      ::      nvegclas=24<a name='3785'>
      integer,   parameter      ::      iwater=16<a name='3786'>
      integer,   parameter      ::      ilsnow=99<a name='3787'>
<a name='3788'>
<a name='3789'>
<font color=#447700>!---    soiltyp classification according to STATSGO(nclasses=16)<a name='3790'></font>
<font color=#447700>!<a name='3791'></font>
<font color=#447700>!             1          SAND                  SAND<a name='3792'></font>
<font color=#447700>!             2          LOAMY SAND            LOAMY SAND<a name='3793'></font>
<font color=#447700>!             3          SANDY LOAM            SANDY LOAM<a name='3794'></font>
<font color=#447700>!             4          SILT LOAM             SILTY LOAM<a name='3795'></font>
<font color=#447700>!             5          SILT                  SILTY LOAM<a name='3796'></font>
<font color=#447700>!             6          LOAM                  LOAM<a name='3797'></font>
<font color=#447700>!             7          SANDY CLAY LOAM       SANDY CLAY LOAM<a name='3798'></font>
<font color=#447700>!             8          SILTY CLAY LOAM       SILTY CLAY LOAM<a name='3799'></font>
<font color=#447700>!             9          CLAY LOAM             CLAY LOAM<a name='3800'></font>
<font color=#447700>!            10          SANDY CLAY            SANDY CLAY<a name='3801'></font>
<font color=#447700>!            11          SILTY CLAY            SILTY CLAY<a name='3802'></font>
<font color=#447700>!            12          CLAY                  LIGHT CLAY<a name='3803'></font>
<font color=#447700>!            13          ORGANIC MATERIALS     LOAM<a name='3804'></font>
<font color=#447700>!            14          WATER<a name='3805'></font>
<font color=#447700>!            15          BEDROCK<a name='3806'></font>
<font color=#447700>!                        Bedrock is reclassified as class 14<a name='3807'></font>
<font color=#447700>!            16          OTHER (land-ice)<a name='3808'></font>
<font color=#447700>!            17          Playa<a name='3809'></font>
<font color=#447700>!            18          Lava<a name='3810'></font>
<font color=#447700>!            19          White Sand<a name='3811'></font>
<font color=#447700>!<a name='3812'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3813'></font>
         REAL  LQMA(nsoilclas),LRHC(nsoilclas),                       &amp;<a name='3814'>
               LPSI(nsoilclas),LQMI(nsoilclas),                       &amp;<a name='3815'>
               LBCL(nsoilclas),LKAS(nsoilclas),                       &amp;<a name='3816'>
               LWIL(nsoilclas),LREF(nsoilclas),                       &amp;<a name='3817'>
               DATQTZ(nsoilclas)<a name='3818'>
<font color=#447700>!-- LQMA Rawls et al.[1982]<a name='3819'></font>
<font color=#447700>!        DATA LQMA /0.417, 0.437, 0.453, 0.501, 0.486, 0.463, 0.398,<a name='3820'></font>
<font color=#447700>!     &amp;  0.471, 0.464, 0.430, 0.479, 0.475, 0.439, 1.0, 0.20, 0.401/<a name='3821'></font>
<font color=#447700>!---<a name='3822'></font>
<font color=#447700>!-- Clapp et al. [1978]<a name='3823'></font>
     DATA LQMA /0.395, 0.410, 0.435, 0.485, 0.485, 0.451, 0.420,      &amp;<a name='3824'>
                0.477, 0.476, 0.426, 0.492, 0.482, 0.451, 1.0,        &amp;<a name='3825'>
                0.20,  0.435, 0.468, 0.200, 0.339/<a name='3826'>
<a name='3827'>
<font color=#447700>!-- LREF Rawls et al.[1982]<a name='3828'></font>
<font color=#447700>!        DATA LREF /0.091, 0.125, 0.207, 0.330, 0.360, 0.270, 0.255,<a name='3829'></font>
<font color=#447700>!     &amp;  0.366, 0.318, 0.339, 0.387, 0.396, 0.329, 1.0, 0.108, 0.283/<a name='3830'></font>
<a name='3831'>
<font color=#447700>!-- Clapp et al. [1978]<a name='3832'></font>
        DATA LREF /0.174, 0.179, 0.249, 0.369, 0.369, 0.314, 0.299,   &amp;<a name='3833'>
                   0.357, 0.391, 0.316, 0.409, 0.400, 0.314, 1.,      &amp;<a name='3834'>
                   0.1,   0.249, 0.454, 0.17,  0.236/<a name='3835'>
<a name='3836'>
<font color=#447700>!-- LWIL Rawls et al.[1982]<a name='3837'></font>
<font color=#447700>!        DATA LWIL/0.033, 0.055, 0.095, 0.133, 0.133, 0.117, 0.148,<a name='3838'></font>
<font color=#447700>!     &amp;  0.208, 0.197, 0.239, 0.250, 0.272, 0.066, 0.0, 0.006, 0.029/<a name='3839'></font>
<a name='3840'>
<font color=#447700>!-- Clapp et al. [1978]<a name='3841'></font>
        DATA LWIL/0.068, 0.075, 0.114, 0.179, 0.179, 0.155, 0.175,    &amp;<a name='3842'>
                  0.218, 0.250, 0.219, 0.283, 0.286, 0.155, 0.0,      &amp;<a name='3843'>
                  0.006, 0.114, 0.030, 0.006, 0.01/<a name='3844'>
<a name='3845'>
<font color=#447700>!        DATA LQMI/0.010, 0.028, 0.047, 0.084, 0.084, 0.066, 0.067,<a name='3846'></font>
<font color=#447700>!     &amp;  0.120, 0.103, 0.100, 0.126, 0.138, 0.066, 0.0, 0.006, 0.028/<a name='3847'></font>
<a name='3848'>
<font color=#447700>!-- Carsel and Parrish [1988]<a name='3849'></font>
        DATA LQMI/0.045, 0.057, 0.065, 0.067, 0.034, 0.078, 0.10,     &amp;<a name='3850'>
                  0.089, 0.095, 0.10,  0.070, 0.068, 0.078, 0.0,      &amp;<a name='3851'>
                  0.004, 0.065, 0.020, 0.004, 0.008/<a name='3852'>
<a name='3853'>
<font color=#447700>!-- LPSI Cosby et al[1984]<a name='3854'></font>
<font color=#447700>!        DATA LPSI/0.060, 0.036, 0.141, 0.759, 0.759, 0.355, 0.135,<a name='3855'></font>
<font color=#447700>!     &amp;  0.617, 0.263, 0.098, 0.324, 0.468, 0.355, 0.0, 0.069, 0.036/<a name='3856'></font>
<font color=#447700>!     &amp;  0.617, 0.263, 0.098, 0.324, 0.468, 0.355, 0.0, 0.069, 0.036/<a name='3857'></font>
<a name='3858'>
<font color=#447700>!-- Clapp et al. [1978]<a name='3859'></font>
       DATA LPSI/0.121, 0.090, 0.218, 0.786, 0.786, 0.478, 0.299,     &amp;<a name='3860'>
                 0.356, 0.630, 0.153, 0.490, 0.405, 0.478, 0.0,       &amp;<a name='3861'>
                 0.121, 0.218, 0.468, 0.069, 0.069/<a name='3862'>
<a name='3863'>
<font color=#447700>!-- LKAS Rawls et al.[1982]<a name='3864'></font>
<font color=#447700>!        DATA LKAS/5.83E-5, 1.70E-5, 7.19E-6, 1.89E-6, 1.89E-6,<a name='3865'></font>
<font color=#447700>!     &amp;  3.67E-6, 1.19E-6, 4.17E-7, 6.39E-7, 3.33E-7, 2.50E-7,<a name='3866'></font>
<font color=#447700>!     &amp;  1.67E-7, 3.38E-6, 0.0, 1.41E-4, 1.41E-5/<a name='3867'></font>
<a name='3868'>
<font color=#447700>!-- Clapp et al. [1978]<a name='3869'></font>
        DATA LKAS/1.76E-4, 1.56E-4, 3.47E-5, 7.20E-6, 7.20E-6,         &amp;<a name='3870'>
                  6.95E-6, 6.30E-6, 1.70E-6, 2.45E-6, 2.17E-6,         &amp;<a name='3871'>
                  1.03E-6, 1.28E-6, 6.95E-6, 0.0,     1.41E-4,         &amp;<a name='3872'>
                  3.47E-5, 1.28E-6, 1.41E-4, 1.76E-4/<a name='3873'>
<a name='3874'>
<font color=#447700>!-- LBCL Cosby et al [1984]<a name='3875'></font>
<font color=#447700>!        DATA LBCL/2.79,  4.26,  4.74,  5.33,  5.33,  5.25,  6.66,<a name='3876'></font>
<font color=#447700>!     &amp;  8.72,  8.17,  10.73, 10.39, 11.55, 5.25,  0.0, 2.79,  4.26/<a name='3877'></font>
<a name='3878'>
<font color=#447700>!-- Clapp et al. [1978]<a name='3879'></font>
        DATA LBCL/4.05,  4.38,  4.90,  5.30,  5.30,  5.39,  7.12,      &amp;<a name='3880'>
                  7.75,  8.52, 10.40, 10.40, 11.40,  5.39,  0.0,       &amp;<a name='3881'>
                  4.05,  4.90, 11.55,  2.79,  2.79/<a name='3882'>
<a name='3883'>
        DATA LRHC /1.47,1.41,1.34,1.27,1.27,1.21,1.18,1.32,1.23,       &amp;<a name='3884'>
                   1.18,1.15,1.09,1.21,4.18,2.03,2.10,1.09,2.03,1.47/<a name='3885'>
<a name='3886'>
        DATA DATQTZ/0.92,0.82,0.60,0.25,0.10,0.40,0.60,0.10,0.35,      &amp;<a name='3887'>
                    0.52,0.10,0.25,0.00,0.,0.60,0.0,0.25,0.60,0.92/<a name='3888'>
<a name='3889'>
<font color=#447700>!--------------------------------------------------------------------------<a name='3890'></font>
<font color=#447700>!<a name='3891'></font>
<font color=#447700>!     USGS Vegetation Types<a name='3892'></font>
<font color=#447700>!<a name='3893'></font>
<font color=#447700>!    1:   Urban and Built-Up Land<a name='3894'></font>
<font color=#447700>!    2:   Dryland Cropland and Pasture<a name='3895'></font>
<font color=#447700>!    3:   Irrigated Cropland and Pasture<a name='3896'></font>
<font color=#447700>!    4:   Mixed Dryland/Irrigated Cropland and Pasture<a name='3897'></font>
<font color=#447700>!    5:   Cropland/Grassland Mosaic<a name='3898'></font>
<font color=#447700>!    6:   Cropland/Woodland Mosaic<a name='3899'></font>
<font color=#447700>!    7:   Grassland<a name='3900'></font>
<font color=#447700>!    8:   Shrubland<a name='3901'></font>
<font color=#447700>!    9:   Mixed Shrubland/Grassland<a name='3902'></font>
<font color=#447700>!   10:   Savanna<a name='3903'></font>
<font color=#447700>!   11:   Deciduous Broadleaf Forest<a name='3904'></font>
<font color=#447700>!   12:   Deciduous Needleleaf Forest<a name='3905'></font>
<font color=#447700>!   13:   Evergreen Broadleaf Forest<a name='3906'></font>
<font color=#447700>!   14:   Evergreen Needleleaf Fores<a name='3907'></font>
<font color=#447700>!   15:   Mixed Forest<a name='3908'></font>
<font color=#447700>!   16:   Water Bodies<a name='3909'></font>
<font color=#447700>!   17:   Herbaceous Wetland<a name='3910'></font>
<font color=#447700>!   18:   Wooded Wetland<a name='3911'></font>
<font color=#447700>!   19:   Barren or Sparsely Vegetated<a name='3912'></font>
<font color=#447700>!   20:   Herbaceous Tundra<a name='3913'></font>
<font color=#447700>!   21:   Wooded Tundra<a name='3914'></font>
<font color=#447700>!   22:   Mixed Tundra<a name='3915'></font>
<font color=#447700>!   23:   Bare Ground Tundra<a name='3916'></font>
<font color=#447700>!   24:   Snow or Ice<a name='3917'></font>
<a name='3918'>
<font color=#447700>!----  Below are the arrays for the vegetation parameters<a name='3919'></font>
         REAL LALB(nvegclas),LMOI(nvegclas),LEMI(nvegclas),            &amp;<a name='3920'>
              LROU(nvegclas),LTHI(nvegclas),LSIG(nvegclas),            &amp;<a name='3921'>
              LPC(nvegclas), NROTBL(nvegclas)<a name='3922'>
<a name='3923'>
<font color=#447700>!************************************************************************<a name='3924'></font>
<font color=#447700>!----     vegetation parameters<a name='3925'></font>
<font color=#447700>!<a name='3926'></font>
<font color=#447700>!-- USGS model<a name='3927'></font>
<font color=#447700>!<a name='3928'></font>
        DATA  LALB/.18,.17,.18,.18,.18,.16,.19,.22,.20,.20,.16,.14,     &amp;<a name='3929'>
                   .12,.12,.13,.08,.14,.14,.25,.15,.15,.15,.25,.55/<a name='3930'>
        DATA LEMI/.88,4*.92,.93,.92,.88,.9,.92,.93,.94,                 &amp;<a name='3931'>
                  .95,.95,.94,.98,.95,.95,.85,.92,.93,.92,.85,.95/<a name='3932'>
<font color=#447700>!-- Roughness length is changed for forests and some others<a name='3933'></font>
        DATA LROU/.5,.06,.075,.065,.05,.2,.075,.1,.11,.15,.8,.85,       &amp;<a name='3934'>
                  2.0,1.0,.563,.0001,.2,.4,.05,.1,.15,.1,.065,.05/<a name='3935'>
<font color=#447700>!        DATA LROU/.5,.15,.15,.15,.14,.2,.12,.1,.11,.15,.5,.5,<a name='3936'></font>
<font color=#447700>!                  .5,.5,.5,.0001,.2,.4,.1,.1,.3,.15,.1,.05/<a name='3937'></font>
        DATA LMOI/.1,.3,.5,.25,.25,.35,.15,.1,.15,.15,.3,.3,            &amp;<a name='3938'>
                  .5,.3,.3,1.,.6,.35,.02,.5,.5,.5,.02,.95/<a name='3939'>
<font color=#447700>!<a name='3940'></font>
<font color=#447700>!---- still needs to be corrected<a name='3941'></font>
<font color=#447700>!<a name='3942'></font>
<font color=#447700>!       DATA LPC/ 15*.8,0.,.8,.8,.5,.5,.5,.5,.5,.0/<a name='3943'></font>
       DATA LPC /0.6,6*0.8,0.7,0.75,6*0.8,0.,0.8,0.8,                   &amp;<a name='3944'>
                 0.5,0.7,0.6,0.7,0.5,0./<a name='3945'>
<a name='3946'>
<a name='3947'>
<font color=#447700>!***************************************************************************<a name='3948'></font>
<a name='3949'>
<a name='3950'>
   INTEGER      ::                &amp;<a name='3951'>
                                                         IVGTYP, &amp;<a name='3952'>
                                                         ISLTYP<a name='3953'>
<a name='3954'>
<a name='3955'>
<a name='3956'>
   REAL                                                        , &amp;<a name='3957'>
            INTENT (  OUT)            ::                     pc<a name='3958'>
<a name='3959'>
   REAL                                                        , &amp;<a name='3960'>
            INTENT (INOUT   )         ::                  emiss, &amp;<a name='3961'>
                                                            znt<a name='3962'>
<font color=#447700>!--- soil properties<a name='3963'></font>
   REAL                                                        , &amp;<a name='3964'>
            INTENT(  OUT)    ::                           RHOCS, &amp;<a name='3965'>
                                                           BCLH, &amp;<a name='3966'>
                                                            DQM, &amp;<a name='3967'>
                                                           KSAT, &amp;<a name='3968'>
                                                           PSIS, &amp;<a name='3969'>
                                                           QMIN, &amp;<a name='3970'>
                                                          QWRTZ, &amp;<a name='3971'>
                                                            REF, &amp;<a name='3972'>
                                                           WILT<a name='3973'>
<a name='3974'>
   INTEGER, DIMENSION( 1:nvegclas )                            , &amp;<a name='3975'>
            INTENT (  OUT)            ::                iforest<a name='3976'>
<a name='3977'>
<a name='3978'>
<a name='3979'>
   INTEGER, DIMENSION( 1:nvegclas )   ::   if1<a name='3980'>
   INTEGER   ::   kstart, kfin, lstart, lfin<a name='3981'>
   INTEGER   ::   i,j,k<a name='3982'>
<a name='3983'>
<font color=#447700>!***********************************************************************<a name='3984'></font>
<font color=#447700>!        DATA ZS1/0.0,0.05,0.20,0.40,1.6,3.0/   ! o -  levels in soil<a name='3985'></font>
<font color=#447700>!        DATA ZS2/0.0,0.025,0.125,0.30,1.,2.3/   ! x - levels in soil<a name='3986'></font>
        DATA IF1/12*0,1,1,1,9*0/<a name='3987'>
<a name='3988'>
          do k=1,nvegclas<a name='3989'>
             iforest(k)=if1(k)<a name='3990'>
          enddo<a name='3991'>
<a name='3992'>
<a name='3993'>
        EMISS = LEMI(IVGTYP)<a name='3994'>
        ZNT   = LROU(IVGTYP)<a name='3995'>
        PC     = LPC (IVGTYP)<a name='3996'>
<a name='3997'>
          RHOCS  = LRHC(ISLTYP)*1.E6<a name='3998'>
          BCLH   = LBCL(ISLTYP)<a name='3999'>
          DQM    = LQMA(ISLTYP)-                               &amp;<a name='4000'>
                   LQMI(ISLTYP)<a name='4001'>
          KSAT   = LKAS(ISLTYP)<a name='4002'>
          PSIS   = - LPSI(ISLTYP)<a name='4003'>
          QMIN   = LQMI(ISLTYP)<a name='4004'>
          REF    = LREF(ISLTYP)<a name='4005'>
          WILT   = LWIL(ISLTYP)<a name='4006'>
          QWRTZ  = DATQTZ(ISLTYP)<a name='4007'>
<a name='4008'>
<font color=#447700>!--------------------------------------------------------------------------<a name='4009'></font>
   END SUBROUTINE SOILVEGIN<a name='4010'>
<font color=#447700>!--------------------------------------------------------------------------<a name='4011'></font>
<a name='4012'>
<a name='4013'>
<A NAME='SNOWFREE'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWFREE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4014'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWFREE</font> (ivgtyp,emiss,znt,iland) <A href='../../call_to/SNOWFREE.html' TARGET='index'>1</A><a name='4015'>
<font color=#447700>!************************************************************************<a name='4016'></font>
<font color=#447700>!  Set-up soil and vegetation Parameters in the case when<a name='4017'></font>
<font color=#447700>!  snow disappears during the forecast and snow parameters<a name='4018'></font>
<font color=#447700>!  shold be replaced by surface parameters according to<a name='4019'></font>
<font color=#447700>!  soil and vegetation types in this point.<a name='4020'></font>
<font color=#447700>!<a name='4021'></font>
<font color=#447700>!***************************************************************************<a name='4022'></font>
   IMPLICIT NONE<a name='4023'>
<font color=#447700>!---------------------------------------------------------------------------<a name='4024'></font>
   integer,   parameter      ::      nvegclas=24<a name='4025'>
<a name='4026'>
<a name='4027'>
   INTEGER                   ::      IVGTYP<a name='4028'>
   REAL,     INTENT(INOUT)   ::                                 &amp;<a name='4029'>
                                                         emiss, &amp;<a name='4030'>
                                                           znt  <a name='4031'>
   INTEGER,  INTENT(INOUT)   ::      ILAND<a name='4032'>
 <a name='4033'>
<font color=#447700>!----  Below are the arrays for the vegetation parameters <a name='4034'></font>
   REAL,    DIMENSION( 1:nvegclas )   ::                  LALB, &amp;<a name='4035'>
                                                          LEMI, &amp;<a name='4036'>
                                                          LROU<a name='4037'>
<a name='4038'>
<font color=#447700>!************************************************************************<a name='4039'></font>
<font color=#447700>!-- USGS model<a name='4040'></font>
<font color=#447700>!<a name='4041'></font>
        DATA  LALB/.18,.17,.18,.18,.18,.16,.19,.22,.20,.20,.16,.14,     &amp;<a name='4042'>
                   .12,.12,.13,.08,.14,.14,.25,.15,.15,.15,.25,.55/<a name='4043'>
        DATA LEMI/.88,4*.92,.93,.92,.88,.9,.92,.93,.94,                 &amp;<a name='4044'>
                  .95,.95,.94,.98,.95,.95,.85,.92,.93,.92,.85,.95/<a name='4045'>
<font color=#447700>!-- Roughness length is changed for forests and some others<a name='4046'></font>
        DATA LROU/.5,.06,.075,.065,.05,.2,.075,.1,.11,.15,.8,.85,       &amp;<a name='4047'>
                  2.0,1.0,.563,.0001,.2,.4,.05,.1,.15,.1,.065,.05/<a name='4048'>
<a name='4049'>
<font color=#447700>!--------------------------------------------------------------------------<a name='4050'></font>
<a name='4051'>
        EMISS  = LEMI(IVGTYP)<a name='4052'>
        ZNT    = LROU(IVGTYP)<a name='4053'>
        ILAND  =      IVGTYP<a name='4054'>
<font color=#447700>! --- <a name='4055'></font>
<a name='4056'>
<font color=#447700>!        RETURN<a name='4057'></font>
<font color=#447700>!        END<a name='4058'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='4059'></font>
   END SUBROUTINE SNOWFREE<a name='4060'>
<a name='4061'>
<A NAME='LSMRUCINIT'><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUCINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4062'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>LSMRUCINIT</font>( SMFR3D,TSLB,SMOIS,ISLTYP,                 &amp; <A href='../../call_to/LSMRUCINIT.html' TARGET='index'>1</A>,<A href='../../call_from/LSMRUCINIT.html' TARGET='index'>1</A><a name='4063'>
                     nzs, restart,                                 &amp;<a name='4064'>
                     allowed_to_read ,                             &amp;<a name='4065'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='4066'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='4067'>
                     its,ite, jts,jte, kts,kte                     )<a name='4068'>
<a name='4069'>
   IMPLICIT NONE<a name='4070'>
<a name='4071'>
<a name='4072'>
   INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='4073'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='4074'>
                                    its,ite, jts,jte, kts,kte,  &amp;<a name='4075'>
                                    nzs<a name='4076'>
<a name='4077'>
   REAL, DIMENSION( ims:ime, 1:nzs, jms:jme )                  , &amp;<a name='4078'>
            INTENT(IN)    ::                               TSLB, &amp;<a name='4079'>
                                                          SMOIS<a name='4080'>
<a name='4081'>
   INTEGER, DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='4082'>
            INTENT(INOUT)    ::                         ISLTYP<a name='4083'>
<a name='4084'>
   REAL, DIMENSION( ims:ime, 1:nzs, jms:jme )                  , &amp;<a name='4085'>
            INTENT(INOUT)    ::                          SMFR3D<a name='4086'>
<a name='4087'>
   REAL, DIMENSION ( 1:nzs )  ::                        soiliqw<a name='4088'>
<a name='4089'>
   LOGICAL , INTENT(IN) :: restart, allowed_to_read <a name='4090'>
<a name='4091'>
<font color=#447700>!<a name='4092'></font>
  INTEGER ::  I,J,L,itf,jtf<a name='4093'>
  REAL    ::  RIW,XLMELT,TLN,DQM,PSIS,QMIN,BCLH<a name='4094'>
<a name='4095'>
   itf=min0(ite,ide-1)<a name='4096'>
   jtf=min0(jte,jde-1)<a name='4097'>
<a name='4098'>
<a name='4099'>
        RIW=900.*1.e-3<a name='4100'>
        XLMELT=3.335E+5<a name='4101'>
<a name='4102'>
   DO J=jts,jtf<a name='4103'>
       DO I=its,itf<a name='4104'>
<a name='4105'>
     CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILIN'>SOILIN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUCINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILIN_1">     ( ISLTYP(I,J), DQM,  PSIS, QMIN, BCLH )<a name='4106'>
<a name='4107'>
<font color=#447700>!--- Computation of volumetric content of ice in soil<a name='4108'></font>
<a name='4109'>
     IF (.not.restart) THEN<a name='4110'>
         DO L=1,NZS<a name='4111'>
    if(isltyp(i,j).ne.14) then<a name='4112'>
<font color=#447700>!-- for land points initialize soil ice<a name='4113'></font>
         tln=log(TSLB(i,l,j)/273.15)<a name='4114'>
<a name='4115'>
         if(tln.lt.0.) then<a name='4116'>
           soiliqw(l)=(dqm+qmin)*(XLMELT*                        &amp;<a name='4117'>
         (tslb(i,l,j)-273.15)/tslb(i,l,j)/9.81/psis)             &amp;<a name='4118'>
          **(-1./bclh)-qmin<a name='4119'>
           soiliqw(l)=max(0.,soiliqw(l))<a name='4120'>
           soiliqw(l)=min(soiliqw(l),smois(i,l,j))<a name='4121'>
           smfr3d(i,l,j)=(smois(i,l,j)-soiliqw(l))/RIW<a name='4122'>
<a name='4123'>
         else<a name='4124'>
           smfr3d(i,l,j)=0.<a name='4125'>
         endif<a name='4126'>
    else<a name='4127'>
<font color=#447700>!-- for water points<a name='4128'></font>
       smfr3d(i,l,j)=0.<a name='4129'>
    endif<a name='4130'>
<a name='4131'>
          ENDDO<a name='4132'>
     ENDIF<a name='4133'>
<a name='4134'>
    ENDDO<a name='4135'>
   ENDDO<a name='4136'>
<a name='4137'>
  END SUBROUTINE lsmrucinit<a name='4138'>
<a name='4139'>
<A NAME='SOILIN'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4140'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOILIN</font> (ISLTYP, DQM, PSIS, QMIN, BCLH ) <A href='../../call_to/SOILIN.html' TARGET='index'>1</A><a name='4141'>
<a name='4142'>
<font color=#447700>!---    soiltyp classification according to STATSGO(nclasses=16)<a name='4143'></font>
<font color=#447700>!<a name='4144'></font>
<font color=#447700>!             1          SAND                  SAND<a name='4145'></font>
<font color=#447700>!             2          LOAMY SAND            LOAMY SAND<a name='4146'></font>
<font color=#447700>!             3          SANDY LOAM            SANDY LOAM<a name='4147'></font>
<font color=#447700>!             4          SILT LOAM             SILTY LOAM<a name='4148'></font>
<font color=#447700>!             5          SILT                  SILTY LOAM<a name='4149'></font>
<font color=#447700>!             6          LOAM                  LOAM<a name='4150'></font>
<font color=#447700>!             7          SANDY CLAY LOAM       SANDY CLAY LOAM<a name='4151'></font>
<font color=#447700>!             8          SILTY CLAY LOAM       SILTY CLAY LOAM<a name='4152'></font>
<font color=#447700>!             9          CLAY LOAM             CLAY LOAM<a name='4153'></font>
<font color=#447700>!            10          SANDY CLAY            SANDY CLAY<a name='4154'></font>
<font color=#447700>!            11          SILTY CLAY            SILTY CLAY<a name='4155'></font>
<font color=#447700>!            12          CLAY                  LIGHT CLAY<a name='4156'></font>
<font color=#447700>!            13          ORGANIC MATERIALS     LOAM<a name='4157'></font>
<font color=#447700>!            14          WATER<a name='4158'></font>
<font color=#447700>!            15          BEDROCK<a name='4159'></font>
<font color=#447700>!                        Bedrock is reclassified as class 14<a name='4160'></font>
<font color=#447700>!            16          OTHER (land-ice)<a name='4161'></font>
<font color=#447700>! extra classes from Fei Chen<a name='4162'></font>
<font color=#447700>!            17          Playa<a name='4163'></font>
<font color=#447700>!            18          Lava<a name='4164'></font>
<font color=#447700>!            19          White Sand<a name='4165'></font>
<font color=#447700>!<a name='4166'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4167'></font>
         integer,   parameter      ::      nsoilclas=19<a name='4168'>
<a name='4169'>
         integer, intent ( in)  ::                          isltyp<a name='4170'>
         real,    intent ( out) ::                  dqm, qmin,psis<a name='4171'>
<a name='4172'>
         REAL  LQMA(nsoilclas),LBCL(nsoilclas),                      &amp;<a name='4173'>
               LPSI(nsoilclas),LQMI(nsoilclas)<a name='4174'>
<a name='4175'>
<font color=#447700>!-- LQMA Rawls et al.[1982]<a name='4176'></font>
<font color=#447700>!        DATA LQMA /0.417, 0.437, 0.453, 0.501, 0.486, 0.463, 0.398,<a name='4177'></font>
<font color=#447700>!     &amp;  0.471, 0.464, 0.430, 0.479, 0.475, 0.439, 1.0, 0.20, 0.401/<a name='4178'></font>
<font color=#447700>!---<a name='4179'></font>
<font color=#447700>!-- Clapp et al. [1978]<a name='4180'></font>
     DATA LQMA /0.395, 0.410, 0.435, 0.485, 0.485, 0.451, 0.420,      &amp;<a name='4181'>
                0.477, 0.476, 0.426, 0.492, 0.482, 0.451, 1.0,        &amp;<a name='4182'>
                0.20,  0.435, 0.468, 0.200, 0.339/<a name='4183'>
<a name='4184'>
<font color=#447700>!-- Carsel and Parrish [1988]<a name='4185'></font>
        DATA LQMI/0.045, 0.057, 0.065, 0.067, 0.034, 0.078, 0.10,     &amp;<a name='4186'>
                  0.089, 0.095, 0.10,  0.070, 0.068, 0.078, 0.0,      &amp;<a name='4187'>
                  0.004, 0.065, 0.020, 0.004, 0.008/<a name='4188'>
<a name='4189'>
<font color=#447700>!-- Clapp et al. [1978]<a name='4190'></font>
       DATA LPSI/0.121, 0.090, 0.218, 0.786, 0.786, 0.478, 0.299,     &amp;<a name='4191'>
                 0.356, 0.630, 0.153, 0.490, 0.405, 0.478, 0.0,       &amp;<a name='4192'>
                 0.121, 0.218, 0.468, 0.069, 0.069/<a name='4193'>
<a name='4194'>
<font color=#447700>!-- Clapp et al. [1978]<a name='4195'></font>
        DATA LBCL/4.05,  4.38,  4.90,  5.30,  5.30,  5.39,  7.12,      &amp;<a name='4196'>
                  7.75,  8.52, 10.40, 10.40, 11.40,  5.39,  0.0,       &amp;<a name='4197'>
                  4.05,  4.90, 11.55,  2.79,  2.79/<a name='4198'>
<a name='4199'>
<a name='4200'>
          DQM    = LQMA(ISLTYP)-                               &amp;<a name='4201'>
                   LQMI(ISLTYP)<a name='4202'>
          PSIS   = - LPSI(ISLTYP)<a name='4203'>
          QMIN   = LQMI(ISLTYP)<a name='4204'>
          BCLH   = LBCL(ISLTYP)<a name='4205'>
<a name='4206'>
  END SUBROUTINE SOILIN<a name='4207'>
<a name='4208'>
END MODULE module_sf_ruclsm<a name='4209'>
</pre></body></html>