<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_SF_LSM_NMM'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#MODULE_SF_LSM_NMM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>MODULE_SF_LSM_NMM</font> <A href='../../call_to/MODULE_SF_LSM_NMM.html' TARGET='index'>2</A><a name='5'>
<a name='6'>
USE <A href='../../html_code/share/module_MPP.F.html#MODULE_MPP'>MODULE_MPP</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#module_sf_lsm_nmm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MPP_1"><a name='7'>
USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#module_sf_lsm_nmm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_41"><a name='8'>
<a name='9'>
  REAL, SAVE    :: SCFX(30)<a name='10'>
<a name='11'>
  INTEGER, SAVE :: ISEASON<a name='12'>
  CHARACTER*256 :: errmess<a name='13'>
 <a name='14'>
CONTAINS<a name='15'>
<a name='16'>
<font color=#447700>!-----------------------------------------------------------------------<a name='17'></font>
<A NAME='NMMLSM'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#NMMLSM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='18'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>NMMLSM</font>(DZ8W,QV3D,P8W3D,RHO3D,                          &amp; <A href='../../call_to/NMMLSM.html' TARGET='index'>1</A>,<A href='../../call_from/NMMLSM.html' TARGET='index'>1</A><a name='19'>
     &amp;               T3D,TH3D,TSK,CHS,                                  &amp;<a name='20'>
     &amp;               HFX,QFX,QGH,GSW,GLW,ELFLX,RMOL,                    &amp; <font color=#447700>! added for WRF CHEM<a name='21'></font>
     &amp;               SMSTAV,SMSTOT,SFCRUNOFF,                           &amp;<a name='22'>
     &amp;               UDRUNOFF,IVGTYP,ISLTYP,VEGFRA,SFCEVP,POTEVP,       &amp;<a name='23'>
     &amp;               GRDFLX,SFCEXC,ACSNOW,ACSNOM,SNOPCX,                &amp;<a name='24'>
     &amp;               ALBSF,TMN,XLAND,XICE,QZ0,                          &amp;<a name='25'>
     &amp;               TH2,Q2,SNOWC,CHS2,QSFC,TBOT,CHKLOWQ,RAINBL,        &amp;<a name='26'>
     &amp;               NUM_SOIL_LAYERS,DT,DZS,ITIMESTEP,                  &amp;<a name='27'>
     &amp;               SMOIS,TSLB,SNOW,CANWAT,CPM,ROVCP,SR,               &amp; <a name='28'>
     &amp;               ALB,SNOALB,SMLIQ,SNOWH,                            &amp;<a name='29'>
     &amp;               IDS,IDE, JDS,JDE, KDS,KDE,                         &amp;<a name='30'>
     &amp;               IMS,IME, JMS,JME, KMS,KME,                         &amp;<a name='31'>
     &amp;               ITS,ITE, JTS,JTE, KTS,KTE                     )<a name='32'>
<font color=#447700>!-----------------------------------------------------------------------<a name='33'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='34'></font>
    IMPLICIT NONE<a name='35'>
<font color=#447700>!-----------------------------------------------------------------------<a name='36'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='37'></font>
<font color=#447700>!-- DZ8W        thickness of layers (m)<a name='38'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='39'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='40'></font>
<font color=#447700>!-- P8W3D       3D pressure on layer interfaces (Pa)<a name='41'></font>
<font color=#447700>!-- FLHC        exchange coefficient for heat (m/s)<a name='42'></font>
<font color=#447700>!-- FLQC        exchange coefficient for moisture (m/s)<a name='43'></font>
<font color=#447700>!-- PSFC        surface pressure (Pa)<a name='44'></font>
<font color=#447700>!-- XLAND       land mask (1 for land, 2 for water)<a name='45'></font>
<font color=#447700>!-- TMN         soil temperature at lower boundary (K)<a name='46'></font>
<font color=#447700>!-- HFX         upward heat flux at the surface (W/m^2)<a name='47'></font>
<font color=#447700>!-- QFX         upward moisture flux at the surface (kg/m^2/s)<a name='48'></font>
<font color=#447700>!-- TSK         surface temperature (K)<a name='49'></font>
<font color=#447700>!-- GSW         NET downward short wave flux at ground surface (W/m^2)<a name='50'></font>
<font color=#447700>!-- GLW         downward long wave flux at ground surface (W/m^2)<a name='51'></font>
<font color=#447700>!-- ELFLX       actual latent heat flux (w m-2: positive, if up from surface)<a name='52'></font>
<font color=#447700>!-- SFCEVP      accumulated surface evaporation (W/m^2)<a name='53'></font>
<font color=#447700>!-- POTEVP      accumulated potential evaporation (W/m^2)<a name='54'></font>
<font color=#447700>!-- CAPG        heat capacity for soil (J/K/m^3)<a name='55'></font>
<font color=#447700>!-- THC         thermal inertia (Cal/cm/K/s^0.5)<a name='56'></font>
<font color=#447700>!-- TBOT        bottom soil temperature (local yearly-mean sfc air temperature)<a name='57'></font>
<font color=#447700>!-- SNOWC       flag indicating snow coverage (1 for snow cover)<a name='58'></font>
<font color=#447700>!-- EMISS       surface emissivity (between 0 and 1)<a name='59'></font>
<font color=#447700>!-- DELTSM      time step (second)<a name='60'></font>
<font color=#447700>!-- ROVCP       R/CP<a name='61'></font>
<font color=#447700>!-- SR          fraction of frozen precip (0.0 to 1.0)<a name='62'></font>
<font color=#447700>!-- XLV         latent heat of melting (J/kg)<a name='63'></font>
<font color=#447700>!-- DTMIN       time step (minute)<a name='64'></font>
<font color=#447700>!-- IFSNOW      ifsnow=1 for snow-cover effects<a name='65'></font>
<font color=#447700>!-- SVP1        constant for saturation vapor pressure (kPa)<a name='66'></font>
<font color=#447700>!-- SVP2        constant for saturation vapor pressure (dimensionless)<a name='67'></font>
<font color=#447700>!-- SVP3        constant for saturation vapor pressure (K)<a name='68'></font>
<font color=#447700>!-- SVPT0       constant for saturation vapor pressure (K)<a name='69'></font>
<font color=#447700>!-- EP1         constant for virtual temperature (R_v/R_d - 1) (dimensionless)<a name='70'></font>
<font color=#447700>!-- EP2         constant for specific humidity calculation<a name='71'></font>
<font color=#447700>!               (R_d/R_v) (dimensionless)<a name='72'></font>
<font color=#447700>!-- KARMAN      Von Karman constant<a name='73'></font>
<font color=#447700>!-- EOMEG       angular velocity of earth's rotation (rad/s)<a name='74'></font>
<font color=#447700>!-- STBOLT      Stefan-Boltzmann constant (W/m^2/K^4)<a name='75'></font>
<font color=#447700>!-- STEM        soil temperature in 5-layer model<a name='76'></font>
<font color=#447700>!-- ZS          depths of centers of soil layers<a name='77'></font>
<font color=#447700>!-- DZS         thicknesses of soil layers<a name='78'></font>
<font color=#447700>!-- num_soil_layers   the number of soil layers<a name='79'></font>
<font color=#447700>!-- ACSNOW      accumulated snowfall (water equivalent) (mm)<a name='80'></font>
<font color=#447700>!-- ACSNOM      accumulated snowmelt (water equivalent) (mm)<a name='81'></font>
<font color=#447700>!-- SNOPCX      snow phase change heat flux (W/m^2)<a name='82'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='83'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='84'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='85'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='86'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='87'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='88'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='89'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='90'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='91'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='92'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='93'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='94'></font>
<font color=#447700>!-- its         start index for i in tile<a name='95'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='96'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='97'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='98'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='99'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='100'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='101'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE,                    &amp;<a name='102'>
     &amp;                      IMS,IME,JMS,JME,KMS,KME,                    &amp;<a name='103'>
     &amp;                      ITS,ITE,JTS,JTE,KTS,KTE<a name='104'>
<font color=#447700>!<a name='105'></font>
      INTEGER,INTENT(IN) :: NUM_SOIL_LAYERS,ITIMESTEP<a name='106'>
<font color=#447700>!<a name='107'></font>
      REAL,INTENT(IN) :: DT,ROVCP<a name='108'>
<font color=#447700>!<a name='109'></font>
      REAL,DIMENSION(IMS:IME,1:NUM_SOIL_LAYERS,JMS:JME),                &amp;<a name='110'>
     &amp;     INTENT(INOUT) ::                                      SMOIS, &amp; <font color=#447700>! new<a name='111'></font>
					                         SMLIQ, &amp; <font color=#447700>! new<a name='112'></font>
                                                                 TSLB     <font color=#447700>! <a name='113'></font>
<a name='114'>
      REAL,DIMENSION(1:NUM_SOIL_LAYERS),INTENT(IN) :: DZS<a name='115'>
<font color=#447700>!<a name='116'></font>
      REAL,DIMENSION(ims:ime,jms:jme),INTENT(INOUT) ::                  &amp;<a name='117'>
     &amp;                                                             TSK, &amp; <font color=#447700>!was TGB (temperature)<a name='118'></font>
     &amp;                                                             HFX, &amp;     <a name='119'>
     &amp;                                                             QFX, &amp;     <a name='120'>
     &amp;                                                             QSFC,&amp;     <a name='121'>
     &amp;                                                            SNOW, &amp; <font color=#447700>!new<a name='122'></font>
     &amp;                                                           SNOWH, &amp; <font color=#447700>!new<a name='123'></font>
     &amp;                                                             ALB, &amp;<a name='124'>
     &amp;                                                          SNOALB, &amp;<a name='125'>
     &amp;                                                           ALBSF, &amp;<a name='126'>
     &amp;                                                           SNOWC, &amp; <a name='127'>
     &amp;                                                          CANWAT, &amp; <font color=#447700>! new<a name='128'></font>
     &amp;                                                          SMSTAV, &amp;<a name='129'>
     &amp;                                                          SMSTOT, &amp;<a name='130'>
     &amp;                                                       SFCRUNOFF, &amp;<a name='131'>
     &amp;                                                        UDRUNOFF, &amp;<a name='132'>
     &amp;                                                          SFCEVP, &amp;<a name='133'>
     &amp;                                                          POTEVP, &amp;<a name='134'>
     &amp;                                                          GRDFLX, &amp;<a name='135'>
     &amp;                                                          ACSNOW, &amp;<a name='136'>
     &amp;                                                          ACSNOM, &amp;<a name='137'>
     &amp;                                                          SNOPCX, &amp;<a name='138'>
     &amp;                                                              Q2, &amp;<a name='139'>
     &amp;                                                             TH2, &amp;<a name='140'>
     &amp;                                                          SFCEXC<a name='141'>
<a name='142'>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) ::          IVGTYP, &amp;<a name='143'>
                                                                ISLTYP<a name='144'>
<a name='145'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) ::                TMN, &amp;<a name='146'>
                                                                 XLAND, &amp;<a name='147'>
                                                                  XICE, &amp;<a name='148'>
                                                                VEGFRA, &amp;<a name='149'>
                                                                   GSW, &amp;<a name='150'>
                                                                   GLW, &amp;     <a name='151'>
                                                                   QZ0, &amp;<a name='152'>
                                                                    SR    <a name='153'>
<a name='154'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) ::       QV3D, &amp;<a name='155'>
                                                                 P8W3D, &amp;<a name='156'>
                                                                 RHO3D, &amp;<a name='157'>
                                                                  TH3D, &amp;<a name='158'>
                                                                   T3D, &amp;<a name='159'>
                                                                  DZ8W<a name='160'>
<a name='161'>
<font color=#447700>!<a name='162'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) ::             RAINBL<a name='163'>
<font color=#447700>!<a name='164'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) ::               CHS2, &amp;<a name='165'>
                                                                   CHS, &amp;<a name='166'>
                                                                   QGH, &amp;<a name='167'>
                                                                   CPM<a name='168'>
<font color=#447700>!<a name='169'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) ::              TBOT<a name='170'>
<font color=#447700>!<a name='171'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) ::           CHKLOWQ, &amp;<a name='172'>
                                                                 ELFLX<a name='173'>
<font color=#447700>! added for WRF-CHEM, 20041205, JM -- not used in this routine as yet<a name='174'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) ::            RMOL<a name='175'>
<a name='176'>
<font color=#447700>! LOCAL VARS<a name='177'></font>
<a name='178'>
      REAL,DIMENSION(ITS:ITE) ::                                  QV1D, &amp;<a name='179'>
     &amp;                                                             T1D, &amp;<a name='180'>
     &amp;                                                            TH1D, &amp;<a name='181'>
     &amp;                                                            ZA1D, &amp;<a name='182'>
     &amp;                                                           P8W1D, &amp;<a name='183'>
     &amp;                                                          PSFC1D, &amp;<a name='184'>
     &amp;                                                           RHO1D, &amp;<a name='185'>
     &amp;                                                          PREC1D<a name='186'>
                                                                           <a name='187'>
      INTEGER :: I,J<a name='188'>
      REAL :: RATIOMX<a name='189'>
<font color=#447700>!-----------------------------------------------------------------------<a name='190'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='191'></font>
<a name='192'>
      DO J=JTS,JTE<a name='193'>
<a name='194'>
        DO I=ITS,ITE<a name='195'>
          T1D(I)    = T3D(I,1,J)<a name='196'>
          TH1D(I)   = TH3D(I,1,J)<a name='197'>
<font color=#447700>!!!       QV1D(I)   = QV3D(I,1,J)<a name='198'></font>
          RATIOMX   = QV3D(I,1,J)<a name='199'>
          QV1D(I)   = RATIOMX/(1.+RATIOMX)<a name='200'>
          P8W1D(I)  = (P8W3D(I,KTS+1,j)+P8W3D(i,KTS,j))*0.5<a name='201'>
          PSFC1D(I) = P8W3D(I,1,J)<a name='202'>
          ZA1D(I)   = 0.5*DZ8W(I,1,J) <a name='203'>
          RHO1D(I)  = RHO3D(I,1,J)<a name='204'>
          PREC1D(I) = RAINBL(I,J)/DT<a name='205'>
        ENDDO<a name='206'>
<a name='207'>
<font color=#447700>!FLHC = SFCEXC<a name='208'></font>
    <a name='209'>
<font color=#447700>!-----------------------------------------------------------------------<a name='210'></font>
        CALL <A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SURFCE'>SURFCE</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#NMMLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURFCE_1">(J,ZA1D,QV1D,P8W1D,PSFC1D,RHO1D,T1D,TH1D,TSK,        &amp;<a name='211'>
                    CHS(IMS,J),PREC1D,HFX,QFX,QGH(IMS,J),GSW,GLW,       &amp;<a name='212'>
                    SMSTAV,SMSTOT,SFCRUNOFF,                            &amp;<a name='213'>
                    UDRUNOFF,IVGTYP,ISLTYP,VEGFRA,SFCEVP,POTEVP,GRDFLX, &amp;<a name='214'>
                    ELFLX,SFCEXC,ACSNOW,ACSNOM,SNOPCX,                  &amp;<a name='215'>
                    ALBSF,TMN,XLAND,XICE,QZ0,                           &amp;<a name='216'>
                    TH2,Q2,SNOWC,CHS2(IMS,J),QSFC,TBOT,CHKLOWQ,         &amp;<a name='217'>
                    NUM_SOIL_LAYERS,DT,DZS,ITIMESTEP,                   &amp;<a name='218'>
                    SMOIS,TSLB,SNOW,CANWAT,CPM(IMS,J),ROVCP,SR,         &amp; <a name='219'>
                    ALB,SNOALB,SMLIQ,SNOWH,                             &amp;<a name='220'>
                    IMS,IME,JMS,JME,KMS,KME,                            &amp;<a name='221'>
                    ITS,ITE,JTS,JTE,KTS,KTE                            ) <a name='222'>
<font color=#447700>!<a name='223'></font>
      ENDDO<a name='224'>
<a name='225'>
   END SUBROUTINE NMMLSM<a name='226'>
<a name='227'>
<font color=#447700>!-----------------------------------------------------------------------<a name='228'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='229'></font>
<A NAME='SURFCE'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SURFCE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='230'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>SURFCE</font>(J,ZA,QV,P8W,PSFC,RHO,T,TH,TSK,CHS,PREC,HFX,QFX,   &amp; <A href='../../call_to/SURFCE.html' TARGET='index'>1</A>,<A href='../../call_from/SURFCE.html' TARGET='index'>2</A><a name='231'>
                     QGH,GSW,GLW,SMSTAV,SMSTOT,SFCRUNOFF,UDRUNOFF,     &amp;<a name='232'>
                     IVGTYP,ISLTYP,VEGFRA,SFCEVP,POTEVP,GRDFLX,        &amp;<a name='233'>
                     ELFLX,SFCEXC,ACSNOW,ACSNOM,SNOPCX,                &amp;<a name='234'>
                     ALBSF,TMN,XLAND,XICE,QZ0,                         &amp;<a name='235'>
                     TH2,Q2,SNOWC,CHS2,QSFC,TBOT,CHKLOWQ,              &amp;<a name='236'>
                     NUM_SOIL_LAYERS,DT,DZS,ITIMESTEP,                 &amp;<a name='237'>
                     SMOIS,TSLB,SNOW,CANWAT,CPM,ROVCP,SR,              &amp; <a name='238'>
                     ALB,SNOALB,SMLIQ,SNOWH,                           &amp;<a name='239'>
                     IMS,IME,JMS,JME,KMS,KME,                          &amp;<a name='240'>
                     ITS,ITE,JTS,JTE,KTS,KTE                           ) <a name='241'>
<font color=#447700>!------------------------------------------------------------------------     <a name='242'></font>
      IMPLICIT NONE                                                     <a name='243'>
<font color=#447700>!------------------------------------------------------------------------     <a name='244'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK                                    <a name='245'></font>
<font color=#447700>!                .      .    .                                          <a name='246'></font>
<font color=#447700>! SUBPROGRAM:    SURFCE      CALCULATE SURFACE CONDITIONS               <a name='247'></font>
<font color=#447700>!   PRGRMMR: F. CHEN         DATE: 97-12-06                             <a name='248'></font>
<font color=#447700>!                                                                       <a name='249'></font>
<font color=#447700>! ABSTRACT:                                                             <a name='250'></font>
<font color=#447700>!   THIS ROUTINE IS THE DRIVER FOR COMPUTATION OF GROUND CONDITIONS     <a name='251'></font>
<font color=#447700>!   BY USING A LAND SURFACE MODEL (LSM).                                <a name='252'></font>
<font color=#447700>!                                                                       <a name='253'></font>
<font color=#447700>! PROGRAM HISTORY LOG:                                                  <a name='254'></font>
<font color=#447700>!   97-12-06  CHEN - ORIGINATOR                                         <a name='255'></font>
<font color=#447700>!                                                                       <a name='256'></font>
<font color=#447700>! REFERENCES:                                                           <a name='257'></font>
<font color=#447700>!   PAN AND MAHRT (1987) BOUN. LAYER METEOR.                            <a name='258'></font>
<font color=#447700>!   CHEN ET AL. (1996)  J. GEOPHYS. RES.                                <a name='259'></font>
<font color=#447700>!   CHEN ET AL. (1997)  BOUN. LAYER METEOR.                             <a name='260'></font>
<font color=#447700>!   CHEN and Dudhia (2000)  Mon. Wea. Rev. <a name='261'></font>
<font color=#447700>!                                                                       <a name='262'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:                                                 <a name='263'></font>
<font color=#447700>!     SFLX                                                              <a name='264'></font>
<font color=#447700>!                                                                       <a name='265'></font>
<font color=#447700>!     SET LOCAL PARAMETERS.                                             <a name='266'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='267'></font>
   INTEGER,  INTENT(IN   )   ::           IMS,IME, JMS,JME, KMS,KME,  &amp;<a name='268'>
                                          ITS,ITE, JTS,JTE, KTS,KTE,  &amp;<a name='269'>
                                          J,ITIMESTEP      <a name='270'>
<a name='271'>
   INTEGER , INTENT(IN)      ::           NUM_SOIL_LAYERS<a name='272'>
<a name='273'>
   REAL,     INTENT(IN   )   ::           DT,ROVCP<a name='274'>
<a name='275'>
   REAL,     DIMENSION(1:num_soil_layers), INTENT(IN)::DZS<a name='276'>
<a name='277'>
                                                 <a name='278'>
   REAL, PARAMETER  :: PQ0=379.90516<a name='279'>
   REAL, PARAMETER  :: TRESH=.95E0,A2=17.2693882,A3=273.16,A4=35.86,  &amp;<a name='280'>
                       T0=273.16E0,T1=274.16E0,ROW=1.E3,              &amp;<a name='281'>
                       ELWV=2.50E6,ELIV=XLS,ELIW=XLF,                 &amp;<a name='282'>
                       A23M4=A2*(A3-A4), RLIVWV=ELIV/ELWV,            &amp;<a name='283'>
                       ROWLIW=ROW*ELIW,ROWLIV=ROW*ELIV,CAPA=R_D/CP<a name='284'>
<a name='285'>
   INTEGER,  PARAMETER  :: NROOT=3<a name='286'>
<font color=#447700>!                                                                       <a name='287'></font>
   REAL,     DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ),       &amp;<a name='288'>
             INTENT(INOUT)   ::                          SMOIS,       &amp; <font color=#447700>! new<a name='289'></font>
						         SMLIQ,       &amp; <font color=#447700>! new<a name='290'></font>
                                                         TSLB           <font color=#447700>! new  !STEMP<a name='291'></font>
<a name='292'>
<a name='293'>
   REAL,    DIMENSION( ims:ime, jms:jme )                           , &amp;<a name='294'>
            INTENT(INOUT)    ::                                  TSK, &amp; <font color=#447700>!was TGB (temperature)<a name='295'></font>
						                 HFX, &amp; <font color=#447700>!new<a name='296'></font>
						                 QFX, &amp; <font color=#447700>!new<a name='297'></font>
						                 QSFC,&amp; <font color=#447700>!new<a name='298'></font>
						                SNOW, &amp; <font color=#447700>!new<a name='299'></font>
						               SNOWH, &amp; <font color=#447700>!new<a name='300'></font>
						 	         ALB, &amp;<a name='301'>
						 	      SNOALB, &amp;<a name='302'>
						 	       ALBSF, &amp;<a name='303'>
                                                               SNOWC, &amp; <a name='304'>
                                                              CANWAT, &amp; <font color=#447700>! new<a name='305'></font>
                                                              SMSTAV, &amp;<a name='306'>
                                                              SMSTOT, &amp;<a name='307'>
                                                           SFCRUNOFF, &amp;<a name='308'>
                                                            UDRUNOFF, &amp;<a name='309'>
                                                              SFCEVP, &amp;<a name='310'>
                                                              POTEVP, &amp;<a name='311'>
                                                              GRDFLX, &amp;<a name='312'>
                                                              ACSNOW, &amp;<a name='313'>
                                                              ACSNOM, &amp;<a name='314'>
                                                              SNOPCX<a name='315'>
<a name='316'>
   INTEGER, DIMENSION( ims:ime, jms:jme )                           , &amp;<a name='317'>
            INTENT(IN   )    ::                               IVGTYP, &amp;<a name='318'>
                                                              ISLTYP<a name='319'>
<a name='320'>
   REAL,    DIMENSION( ims:ime, jms:jme )                           , &amp;<a name='321'>
            INTENT(IN   )    ::                                  TMN, &amp;<a name='322'>
                                                               XLAND, &amp;<a name='323'>
                                                                XICE, &amp;<a name='324'>
                                                              VEGFRA, &amp;<a name='325'>
                                                                 GSW, &amp;<a name='326'>
                                                                 GLW, &amp;<a name='327'>
                                                                 QZ0, &amp;<a name='328'>
                                                                  SR<a name='329'>
<a name='330'>
   REAL,    DIMENSION( ims:ime, jms:jme )                           , &amp;<a name='331'>
            INTENT(INOUT)    ::                                   Q2, &amp;<a name='332'>
							         TH2, &amp;<a name='333'>
                                                              SFCEXC<a name='334'>
<a name='335'>
   REAL,    DIMENSION( ims:ime, jms:jme )                           , &amp;<a name='336'>
            INTENT(OUT)    ::                                   TBOT<a name='337'>
<a name='338'>
<a name='339'>
   REAL,    DIMENSION( ims:ime, jms:jme )                           , &amp;<a name='340'>
            INTENT(OUT)    ::                                CHKLOWQ, &amp;<a name='341'>
                                                               ELFLX<a name='342'>
<a name='343'>
   REAL,    DIMENSION( ims:ime )                                    , &amp;<a name='344'>
            INTENT(IN   )    ::                                  QGH, &amp;<a name='345'>
                                                                 CHS, &amp;<a name='346'>
                                                                 CPM, &amp;<a name='347'>
                                                                CHS2<a name='348'>
<a name='349'>
<font color=#447700>! MODULE-LOCAL VARIABLES, DEFINED IN  SUBROUTINE LSM<a name='350'></font>
   REAL,    DIMENSION( its:ite )                                    , &amp;<a name='351'>
            INTENT(IN   )    ::                                   ZA, &amp;<a name='352'>
                                                                  TH, &amp;<a name='353'>
                                                                  QV, &amp;<a name='354'>
                                                                   T, &amp;<a name='355'>
                                                                 p8w, &amp;<a name='356'>
                                                                PSFC, &amp;<a name='357'>
                                                                 rho, &amp;<a name='358'>
                                                                PREC    <font color=#447700>! one time step in mm<a name='359'></font>
   REAL,    DIMENSION( its:ite )   ::                          TGDSA <a name='360'>
<a name='361'>
<font color=#447700>! LOCAL VARS<a name='362'></font>
<a name='363'>
    REAL, DIMENSION(1:num_soil_layers) :: SMLIQ1D,SMOIS1D,STEMP1D<a name='364'>
<a name='365'>
<font color=#447700>!---------------------------------------------------------------------- <a name='366'></font>
<font color=#447700>!***  DECLARATIONS FOR IMPLICIT NONE                                    <a name='367'></font>
 <a name='368'>
    REAL :: APELM,APES,FDTLIW,FDTW,Q2SAT,Z,FK,SOLDN,SFCTMP,SFCTH2,    &amp;<a name='369'>
            SFCPRS,PRCP,Q2K,DQSDTK,SATFLG,TBOTK,CHK,VGFRCK,T1K,LWDN,  &amp;<a name='370'>
            CMCK,Q2M,SNODPK,PLFLX,HFLX,GFLX,RNOF1K,                   &amp;<a name='371'>
            RNOF2K,Q1K,SMELTK,SOILQW,SOILQM,T2K,PRESK,CHFF,STIMESTEP, &amp;<a name='372'>
            ALB1D,SNOALB1D,SNOWH1D,ALBSF1D,SOLNET,FFROZP,             &amp;<a name='373'>
            DUM1,DUM2,DUM3,DUM4,DUM5,DUM6,DUM7<a name='374'>
<a name='375'>
    INTEGER :: I,K,NS,ICE,IVGTPK,ISLTPK,ISPTPK,NOOUT,NSOIL,LZ<a name='376'>
<a name='377'>
<font color=#447700>!---------------------------------------------------------------------- <a name='378'></font>
<font color=#447700>!***********************************************************************<a name='379'></font>
<font color=#447700>!                         START SURFCE HERE                             <a name='380'></font>
<font color=#447700>!***                                                                    <a name='381'></font>
<font color=#447700>!***  SET CONSTANTS CALCULATED HERE FOR CLARITY.                        <a name='382'></font>
<font color=#447700>!***                                                                    <a name='383'></font>
      FDTLIW=DT/ROWLIW                                              <a name='384'>
<font color=#447700>!      FDTLIV=DT/ROWLIV                                             <a name='385'></font>
      FDTW=DT/(XLV*RHOWATER)<a name='386'>
<font color=#447700>!***                                                                    <a name='387'></font>
<font color=#447700>!***  SET LSM CONSTANTS AND TIME INDEPENDENT VARIABLES                  <a name='388'></font>
<font color=#447700>!***  INITIALIZE LSM HISTORICAL VARIABLES                               <a name='389'></font>
<font color=#447700>!***                                                                    <a name='390'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='391'></font>
<a name='392'>
      NSOIL=num_soil_layers<a name='393'>
<a name='394'>
      IF(ITIMESTEP.EQ.1)THEN                                                 <a name='395'>
        DO 50 I=its,ite<a name='396'>
<font color=#447700>!*** SET ZERO-VALUE FOR SOME OUTPUT DIAGNOSTIC ARRAYS                   <a name='397'></font>
          IF((XLAND(I,J)-1.5).GE.0.)THEN                                <a name='398'>
<font color=#447700>! check sea-ice point                                                   <a name='399'></font>
            IF(XICE(I,J).EQ.1.)PRINT*,' sea-ice at water point, I=',I,  &amp;<a name='400'>
              'J=',J<a name='401'>
<font color=#447700>!***   Open Water Case                                                  <a name='402'></font>
            SMSTAV(I,J)=1.0                                             <a name='403'>
            SMSTOT(I,J)=1.0                                             <a name='404'>
            DO NS=1,NSOIL                                               <a name='405'>
              SMOIS(I,NS,J)=1.0                                          <a name='406'>
              TSLB(I,NS,J)=273.16                                          <font color=#447700>!STEMP<a name='407'></font>
            ENDDO                                                       <a name='408'>
          ELSE                                                          <a name='409'>
            IF(XICE(I,J).EQ.1.)THEN                                     <a name='410'>
<font color=#447700>!***        SEA-ICE CASE                                                <a name='411'></font>
              SMSTAV(I,J)=1.0                                           <a name='412'>
              SMSTOT(I,J)=1.0                                           <a name='413'>
              DO NS=1,NSOIL                                             <a name='414'>
                SMOIS(I,NS,J)=1.0                                        <a name='415'>
              ENDDO                                                     <a name='416'>
            ENDIF                                                       <a name='417'>
          ENDIF                                                         <a name='418'>
<font color=#447700>!                                                                       <a name='419'></font>
   50   CONTINUE                                                        <a name='420'>
      ENDIF                                                             <a name='421'>
<font color=#447700>!-----------------------------------------------------------------------<a name='422'></font>
      DO 100 I=its,ite                                                    <a name='423'>
<font color=#447700>!       SFCPRS=(A(KL)*PSB(I,J)+PTOP+PP3D(I,J,KL)*0.001)*1.E3          <a name='424'></font>
        SFCPRS=p8w(I)  <font color=#447700>!Pressure in middle of lowest layer<a name='425'></font>
        Q2SAT=QGH(I)                                                  <a name='426'>
<font color=#447700>!       CHKLOWQ(I,J)=1.<a name='427'></font>
        CHFF=CHS(I)*RHO(I)*CPM(I)<a name='428'>
<font color=#447700>!CHK*RHO*CP                                                             <a name='429'></font>
<font color=#447700>! TGDSA: potential T<a name='430'></font>
        TGDSA(I)=TSK(I,J)*(1.E5/SFCPRS)**ROVCP <a name='431'>
<font color=#447700>!<a name='432'></font>
<font color=#447700>!***  CHECK FOR SATURATION AT THE LOWEST MODEL LEVEL                    <a name='433'></font>
<font color=#447700>!<a name='434'></font>
        Q2K=QV(I)<a name='435'>
        APES=(1.E5/PSFC(I))**CAPA<a name='436'>
<font color=#447700>!<a name='437'></font>
        IF((Q2K.GE.Q2SAT*TRESH).AND.Q2K.LT.QZ0(I,J))THEN                                  <a name='438'>
          SATFLG=0.                                                   <a name='439'>
          CHKLOWQ(I,J)=0.<a name='440'>
        ELSE                                                          <a name='441'>
          SATFLG=1.0                                                  <a name='442'>
          CHKLOWQ(I,J)=1.<a name='443'>
        ENDIF                                                         <a name='444'>
<font color=#447700>!<a name='445'></font>
        TBOT(I,J)=273.16<a name='446'>
<font color=#447700>!***                                                                    <a name='447'></font>
<font color=#447700>!***  LOADING AND UNLOADING MM5/LSM LAND SOIL VARIABLES                 <a name='448'></font>
<font color=#447700>!***                                                                    <a name='449'></font>
        IF((XLAND(I,J)-1.5).GE.0.)THEN                                  <a name='450'>
<font color=#447700>!*** Water                                                              <a name='451'></font>
          HFX(I,J)=HFX(I,J)/APES<a name='452'>
          QFX(I,J)=QFX(I,J)*SATFLG<a name='453'>
          SFCEVP(I,J)=SFCEVP(I,J)+QFX(I,J)*DT                       <a name='454'>
        ELSE                                                            <a name='455'>
<font color=#447700>!*** LAND OR SEA-ICE                                                    <a name='456'></font>
<font color=#447700>!ATEC          ICE=INT(XICE(I,J)+0.3)                                   <a name='457'></font>
          IF (XICE(I,J) .GT. 0.5) THEN                                  <a name='458'>
             ICE=1                                                      <a name='459'>
          ELSE                                                          <a name='460'>
             ICE=0                                                      <a name='461'>
          ENDIF                                                         <a name='462'>
<font color=#447700>!<a name='463'></font>
          Q2K=MIN(QV(I),Q2SAT)<a name='464'>
          Z=ZA(I)                                                    <a name='465'>
<font color=#447700>!          FK=GSW(I,J)+GLW(I,J)                                          <a name='466'></font>
          LWDN=GLW(I,J)<a name='467'>
<font color=#447700>!<a name='468'></font>
<font color=#447700>!***  GSW is net downward shortwave<a name='469'></font>
<font color=#447700>!<a name='470'></font>
          SOLNET=GSW(I,J)<a name='471'>
<font color=#447700>!<a name='472'></font>
<font color=#447700>!***  Simple use of albedo to determine total incoming solar shortwave SOLDN<a name='473'></font>
<font color=#447700>!***  (no solar zenith angle correction)<a name='474'></font>
<font color=#447700>!<a name='475'></font>
          SOLDN=SOLNET/(1.-ALB(I,J))                                  <a name='476'>
<font color=#447700>!<a name='477'></font>
          ALBSF1D=ALBSF(I,J)<a name='478'>
          SNOALB1D=SNOALB(I,J)<a name='479'>
          SFCTMP=T(I)                                               <a name='480'>
<font color=#447700>!!!       SFCTH2=SFCTMP+(0.0097545*Z)                                   <a name='481'></font>
          APELM=(1.E5/SFCPRS)**CAPA<a name='482'>
          SFCTH2=SFCTMP*APELM<a name='483'>
          SFCTH2=SFCTH2/APES<a name='484'>
          PRCP=PREC(I)                                                  <a name='485'>
<font color=#447700>!!!       Q2K=QV(I)                                                  <a name='486'></font>
<font color=#447700>!!!       Q2SAT=PQ0/SFCPRS*EXP(A2*(SFCTMP-A3)/(SFCTMP-A4))              <a name='487'></font>
          DQSDTK=Q2SAT*A23M4/(SFCTMP-A4)**2                             <a name='488'>
          IF(ICE.EQ.0)THEN                                              <a name='489'>
            TBOTK=TMN(I,J)                                              <a name='490'>
          ELSE                                                          <a name='491'>
            TBOTK=271.16                                                <a name='492'>
          ENDIF                                                         <a name='493'>
          CHK=CHS(I)                                                    <a name='494'>
          IVGTPK=IVGTYP(I,J)                                            <a name='495'>
          IF(IVGTPK.EQ.0)IVGTPK=13<a name='496'>
          ISLTPK=ISLTYP(I,J)                                            <a name='497'>
          IF(ISLTPK.EQ.0)ISLTPK=9<a name='498'>
<font color=#447700>! hardwire slope type (ISPTPK)=1<a name='499'></font>
          ISPTPK=1<a name='500'>
          VGFRCK=VEGFRA(I,J)/100.                                       <a name='501'>
          IF(IVGTPK.EQ.25) VGFRCK=0.0001<a name='502'>
          IF(ISLTPK.EQ.14.AND.XICE(I,J).EQ.0.)THEN                      <a name='503'>
         PRINT*,' SOIL TYPE FOUND TO BE WATER AT A LAND-POINT'          <a name='504'>
         PRINT*,i,j,'RESET SOIL in surfce.F'                      <a name='505'>
<font color=#447700>!           ISLTYP(I,J)=7                                               <a name='506'></font>
            ISLTPK=7                                                    <a name='507'>
          ENDIF                                                         <a name='508'>
          T1K=TSK(I,J)<a name='509'>
          CMCK=CANWAT(I,J)                                                <a name='510'>
<font color=#447700>!*** convert snow depth from mm to meter                                <a name='511'></font>
          SNODPK=SNOW(I,J)*0.001                                        <a name='512'>
          SNOWH1D=SNOWH(I,J)*0.001                                        <a name='513'>
<font color=#447700>!                                                                       <a name='514'></font>
<font color=#447700>!*** fraction of frozen precip<a name='515'></font>
<font color=#447700>!                                                                       <a name='516'></font>
          FFROZP=SR(I,J)<a name='517'>
<font color=#447700>!<a name='518'></font>
          DO 70 NS=1,NSOIL                                              <a name='519'>
            SMOIS1D(NS)=SMOIS(I,NS,J)                                       <a name='520'>
            SMLIQ1D(NS)=SMLIQ(I,NS,J)                                       <a name='521'>
            STEMP1D(NS)=TSLB(I,NS,J)                                          <font color=#447700>!STEMP<a name='522'></font>
   70     CONTINUE                                                      <a name='523'>
<a name='524'>
<font color=#447700>!                                                                       <a name='525'></font>
<font color=#447700>!        print*,'BF SFLX','ISLTPK',ISLTPK,'IVGTPK=',IVGTPK,'SMOIS1D',&amp;<a name='526'></font>
<font color=#447700>!              SMOIS1D,'STEMP1',STEMP1D,'VGFRCK',VGFRCK<a name='527'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='528'></font>
<font color=#447700>! old WRF call to SFLX<a name='529'></font>
<font color=#447700>!         CALL SFLX(ICE,SATFLG,DT,Z,NSOIL,NROOT,DZS,FK,SOLDN,SFCPRS,    &amp;<a name='530'></font>
<font color=#447700>!              PRCP,SFCTMP,SFCTH2,Q2K,Q2SAT,DQSDTK,TBOTK,CHK,CHFF,      &amp;<a name='531'></font>
<font color=#447700>!              IVGTPK,ISLTPK,VGFRCK,PLFLX,ELFLX,HFLX,GFLX,RNOF1K,RNOF2K,&amp;<a name='532'></font>
<font color=#447700>!              Q1K,SMELTK,T1K,CMCK,SMOIS1D,STEMP1D,SNODPK,SOILQW,SOILQM)      <a name='533'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='534'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='535'></font>
<font color=#447700>! Ek 12 June 2002 - NEW CALL SFLX<a name='536'></font>
<font color=#447700>! ops Eta call to SFLX ...'tailor' this to WRF<a name='537'></font>
<font color=#447700>!        CALL SFLX<a name='538'></font>
<font color=#447700>!     I    (ICE,DTK,Z,NSOIL,SLDPTH,<a name='539'></font>
<font color=#447700>!     I    LWDN,SOLDN,SFCPRS,PRCP,SFCTMP,SFCTH2,Q2K,SFCSPD,Q2SAT,DQSDTK,<a name='540'></font>
<font color=#447700>!     I    IVGTPK,ISLTPK,ISPTPK,<a name='541'></font>
<font color=#447700>!     I    VGFRCK,PTU,TBOT,ALB,SNOALB,<a name='542'></font>
<font color=#447700>!     2    CMCK,T1K,STCK,SMCK,SH2OK,SNOWH,SNODPK,ALB2D,CHK,CMK,<a name='543'></font>
<font color=#447700>!     O    PLFLX,ELFLX,HFLX,GFLX,RNOF1K,RNOF2K,Q1K,SMELTK,<a name='544'></font>
<font color=#447700>!     O    SOILQW,SOILQM,DUM1,DUM2,DUM3,DUM4)<a name='545'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='546'></font>
        CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX'>SFLX</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SURFCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFLX_1">                                                       &amp;<a name='547'>
          (FFROZP,ICE,DT,Z,NSOIL,DZS,                                   &amp;<a name='548'>
          LWDN,SOLDN,SOLNET,SFCPRS,PRCP,SFCTMP,SFCTH2,Q2K,DUM5,Q2SAT,   &amp;<a name='549'>
          DQSDTK,IVGTPK,ISLTPK,ISPTPK,                                  &amp;<a name='550'>
          VGFRCK,DUM6,TBOTK,ALBSF1D,SNOALB1D,                           &amp;<a name='551'>
          CMCK,T1K,STEMP1D,SMOIS1D,SMLIQ1D,SNOWH1D,SNODPK,ALB1D,CHK,DUM7, &amp;<a name='552'>
          PLFLX,ELFLX(I,J),HFLX,GFLX,RNOF1K,RNOF2K,Q1K,SMELTK,          &amp;<a name='553'>
          SOILQW,SOILQM,DUM1,DUM2,DUM3,DUM4)<a name='554'>
<font color=#447700>!-----------------------------------------------------------------------<a name='555'></font>
<font color=#447700>!***  DIAGNOSTICS                                                       <a name='556'></font>
<font color=#447700>!        Convert the water unit into mm                                 <a name='557'></font>
          SFCRUNOFF(I,J)=SFCRUNOFF(I,J)+RNOF1K*DT*1000.0                  <a name='558'>
          UDRUNOFF(I,J)=UDRUNOFF(I,J)+RNOF2K*DT*1000.0                  <a name='559'>
          SMSTAV(I,J)=SOILQW                                            <a name='560'>
<a name='561'>
<font color=#447700>!mp<a name='562'></font>
	if (abs(SMSTAV(I,J)) .lt. 3.5) then<a name='563'>
	else<a name='564'>
	write(errmess,*) 'bad SMSTAV: ', I,J,SMSTAV(I,J)<a name='565'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SURFCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_52">( errmess )<a name='566'>
	endif<a name='567'>
<font color=#447700>!mp	<a name='568'></font>
<a name='569'>
          SMSTOT(I,J)=SOILQM*1000.                                      <a name='570'>
          SFCEXC(I,J)=CHK                                               <a name='571'>
<font color=#447700>!       IF(SNOB(I,J).GT.0..OR.SICE(I,J).GT.0.)THEN                      <a name='572'></font>
<font color=#447700>!         QFC1(I,J)=QFC1(I,J)*RLIVWV                                    <a name='573'></font>
<font color=#447700>!       ENDIF                                                           <a name='574'></font>
          IF(FFROZP.GT.0.5)THEN<a name='575'>
            ACSNOW(I,J)=ACSNOW(I,J)+PREC(I)*DT                     <a name='576'>
          ENDIF                                                         <a name='577'>
          IF(SNOW(I,J).GT.0.)THEN                                       <a name='578'>
            ACSNOM(I,J)=ACSNOM(I,J)+SMELTK*1000.                    <a name='579'>
            SNOPCX(I,J)=SNOPCX(I,J)-SMELTK/FDTLIW                       <a name='580'>
          ENDIF                                                         <a name='581'>
        POTEVP(I,J)=POTEVP(I,J)+PLFLX*FDTW                              <a name='582'>
<font color=#447700>!       POTFLX(I,J)=POTFLX(I,J)-PLFLX                                   <a name='583'></font>
<font color=#447700>!***  WRF LOWER BOUNDARY CONDITIONS                                     <a name='584'></font>
          GRDFLX(I,J)=GFLX                                              <a name='585'>
          HFX(I,J)=HFLX                                                 <a name='586'>
          QFX(I,J)=ELFLX(I,J)/ELWV                                           <a name='587'>
          SFCEVP(I,J)=SFCEVP(I,J)+QFX(I,J)*DT                       <a name='588'>
          TSK(I,J)=T1K<a name='589'>
          T2K=T1K-HFX(I,J)/(RHO(I)*CPM(I)*CHS2(I))<a name='590'>
          TH2(I,J)=T2K*(1.E5/SFCPRS)**ROVCP                                  <a name='591'>
          Q2M=Q1K-QFX(I,J)/(RHO(I)*CHS2(I))                            <a name='592'>
<font color=#447700>!!!!!!    Q2(I,J)=Q2M<a name='593'></font>
<font color=#447700>!!!!!!    Q2(I,J)=Q2K<a name='594'></font>
<font color=#447700>!        t2k=th2k/(1.E5/SFCPRS)**ROVCP                                  <a name='595'></font>
<font color=#447700>!        QS(I,J)=Q1K                                                    <a name='596'></font>
<font color=#447700>!!!      QSFC(I,J)=Q1K                                                    <a name='597'></font>
<font color=#447700>!***  UPDATE STATE VARIABLES <a name='598'></font>
          SNOW(I,J)=SNODPK*1000.0                                       <a name='599'>
          SNOWH(I,J)=SNOWH1D*1000.0                                       <a name='600'>
          CANWAT(I,J)=CMCK                                                <a name='601'>
          IF(SNOW(I,J).GT.1.0)THEN                                      <a name='602'>
<font color=#447700>!           ALB(I,J)=0.01*ALBD(IVGTPK,ISEASON)*(1.+SCFX(IVGTPK))            <a name='603'></font>
            SNOWC(I,J)=1.0                                              <a name='604'>
          ELSE                                                          <a name='605'>
<font color=#447700>!           ALB(I,J)=0.01*ALBD(IVGTPK,ISEASON)                              <a name='606'></font>
            SNOWC(I,J)=0.0                                              <a name='607'>
          ENDIF                                                         <a name='608'>
<font color=#447700>! update albedo<a name='609'></font>
          ALB(I,J)=ALB1D<a name='610'>
<font color=#447700>! update bottom soil temperature<a name='611'></font>
          TBOT(I,J)=TBOTK<a name='612'>
<a name='613'>
          DO 80 NS=1,NSOIL                                              <a name='614'>
           SMOIS(I,NS,J)=SMOIS1D(NS)                                       <a name='615'>
           SMLIQ(I,NS,J)=SMLIQ1D(NS)                                       <a name='616'>
           TSLB(I,NS,J)=STEMP1D(NS)                                        <font color=#447700>!  STEMP<a name='617'></font>
   80     CONTINUE                                                      <a name='618'>
        ENDIF                                                           <a name='619'>
#if 0<a name='620'>
        NOOUT=0                                                         <a name='621'>
<a name='622'>
        IF((ITIMESTEP.EQ.1.OR.MOD(ITIMESTEP,1).EQ.0)  &amp;<a name='623'>
            .AND. I .EQ.29.AND.J.EQ.23) THEN                                             <a name='624'>
<font color=#447700>!         print*, 'GLW',GLW(I,J),'GSW',GSW(I,J)<a name='625'></font>
          print*, 'T2K',T2K,'T1K',T1K,'HFX',HFX(I,J),'RHO',RHO(I),'CPM',CPM(I), &amp;<a name='626'>
                'CHS2',CHS2(I),'soil T',STEMP1D,'soil m', SMOIS1D<a name='627'>
<font color=#447700>!          print*,'Q2M',Q2M,'Q1K',Q1K,'QFX',QFX(I,J),'RHO',RHO(I),'CHS2',CHS2(I),'latent',ELFLX<a name='628'></font>
        ENDIF<a name='629'>
<a name='630'>
        IF(NOOUT.EQ.1)GOTO 100                                          <a name='631'>
<font color=#447700>!     write output to 29                                                <a name='632'></font>
        IF(ITIMESTEP.EQ.1.AND.I.EQ.1.AND.J.EQ.1) &amp;<a name='633'>
                                                            WRITE (29,*)&amp;<a name='634'>
          'itimestep ','   FK     ','  SOLDN   ','  SFCPR   ',          &amp;<a name='635'>
          '  SFCTMP  ','    Q2K   ','   TBOTK  ',          &amp;<a name='636'>
          '   CHK    ','  ELFLX   ','   HFLX   ','   GFLX   ',          &amp;<a name='637'>
          ' RNOF1K   ',' RNOF2K   ','    T1K   ','   CMCK   ',          &amp;<a name='638'>
          '  SMCK1   ','  SMCK2   ','  SMCK3   ','  SMCK4   ',          &amp;<a name='639'>
          '  STCK1   ','  STCK2   ','  STCK3   ','  STCK4   ',          &amp;<a name='640'>
          ' SNODPK   ','      T2   ',                                   &amp;<a name='641'>
          '     Q2   ',' SMSTOT   ',' SFCEVP   ', ' RAIN'                        <a name='642'>
        IF((ITIMESTEP.EQ.1.OR.MOD(ITIMESTEP,1).EQ.0)  &amp;<a name='643'>
            .AND. I .EQ.29.AND.J.EQ.23) THEN                                             <a name='644'>
        print *,'outputting at itimestep =', itimestep<a name='645'>
          STIMESTEP=FLOAT(itimestep)<a name='646'>
          WRITE (29,1029)STIMESTEP,FK,SOLDN,SFCPRS/100.,SFCTMP,1000.*       &amp;<a name='647'>
                         Q2K,TBOTK,1000.*CHK,ELFLX(i,j),HFLX,GFLX,SFCRUNOFF(I,J)&amp;<a name='648'>
                         ,UDRUNOFF(I,J),T1K,CMCK,SMOIS1D,STEMP1D,SNODPK,        &amp;<a name='649'>
<font color=#447700>!                       ,UDRUNOFF(I,J),T1K,CMCK,SMOIS1D(3),SMOIS1D(7),SMOIS1D(11),&amp;<a name='650'></font>
<font color=#447700>!                        SMOIS1D(14),STEMP1D(3), STEMP1D(7),STEMP1D(11), &amp;<a name='651'></font>
<font color=#447700>!                        STEMP1D(14), SNODPK,        &amp;<a name='652'></font>
                         T2K,1000.*Q2M,SMSTOT(I,J),SFCEVP(I,J),PRCP<a name='653'>
 1029     FORMAT (29F10.4)                                              <a name='654'>
<font color=#447700>!         IF(ITIMESTEP.EQ.0)WRITE (39,*)'   P      ','   T      ',      &amp;<a name='655'></font>
<font color=#447700>!           '   TH     ','   Q      ','   U      ','   V      ',        &amp;<a name='656'></font>
<font color=#447700>!           '   QC     '                                                <a name='657'></font>
<font color=#447700>!         WRITE (39,1039)itimestep<a name='658'></font>
<font color=#447700>!         DO K=kts,kte<a name='659'></font>
<font color=#447700>!           WRITE (39,1039)PRESK,TX(I,K),THX(I,K),1000.*QX(I,K),UX(I,K),&amp;<a name='660'></font>
<font color=#447700>!                          VX(I,K),1000.*QCX(I,K)                       <a name='661'></font>
 1039       FORMAT (7F10.5)                                             <a name='662'>
<font color=#447700>!         ENDDO                                                         <a name='663'></font>
        ENDIF                                                           <a name='664'>
<font color=#447700>!                                                                       <a name='665'></font>
#endif<a name='666'>
  100 CONTINUE                                                          <a name='667'>
<font color=#447700>!                                                                       <a name='668'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='669'></font>
  END SUBROUTINE SURFCE<a name='670'>
<font color=#447700>!-----------------------------------------------------------------------<a name='671'></font>
<a name='672'>
<A NAME='SFLX'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='673'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFLX</font> (                                                 &amp; <A href='../../call_to/SFLX.html' TARGET='index'>2</A>,<A href='../../call_from/SFLX.html' TARGET='index'>26</A><a name='674'>
       FFROZP,ICE,DT,Z,NSOIL,SLDPTH,                                    &amp;<a name='675'>
       LWDN,SOLDN,SOLNET,SFCPRS,PRCP,SFCTMP,TH2,Q2,SFCSPD,Q2SAT,        &amp;<a name='676'>
       DQSDT2,VEGTYP,SOILTYP,SLOPETYP,                                  &amp;<a name='677'>
       SHDFAC,PTU,TBOT,ALB,SNOALB,                                      &amp;<a name='678'>
       CMC,T1,STC,SMC,SH2O,SNOWH,SNEQV,ALBEDO,CH,CM,                    &amp;<a name='679'>
       ETP,ETA,H,S,RUNOFF1,RUNOFF2,Q1,SNMAX,                            &amp;<a name='680'>
       SOILW,SOILM, SMCWLT,SMCDRY,SMCREF,SMCMAX)<a name='681'>
<font color=#447700>!<a name='682'></font>
      IMPLICIT NONE<a name='683'>
<font color=#447700>!!<a name='684'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='685'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='686'></font>
<font color=#447700>!C PURPOSE:  SUB-DRIVER FOR "NOAH/OSU LSM" FAMILY OF PHYSICS SUBROUTINES<a name='687'></font>
<font color=#447700>!C           FOR A SOIL/VEG/SNOWPACK LAND-SURFACE MODEL TO UPDATE SOIL <a name='688'></font>
<font color=#447700>!C           MOISTURE, SOIL ICE, SOIL TEMPERATURE, SKIN TEMPERATURE, <a name='689'></font>
<font color=#447700>!C           SNOWPACK WATER CONTENT, SNOWDEPTH, AND ALL TERMS<a name='690'></font>
<font color=#447700>!C           OF THE SURFACE ENERGY BALANCE AND SURFACE WATER<a name='691'></font>
<font color=#447700>!C           BALANCE (EXCLUDING INPUT ATMOSPHERIC FORCINGS OF <a name='692'></font>
<font color=#447700>!C           DOWNWARD RADIATION AND PRECIP)<a name='693'></font>
<font color=#447700>!C<a name='694'></font>
<font color=#447700>!C  VERSION 2.3.1 23 FEBRUARY 2002<a name='695'></font>
<font color=#447700>!C<a name='696'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='697'></font>
<font color=#447700>!C<a name='698'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='699'></font>
<font color=#447700>! ------------    FROZEN GROUND VERSION     ----------------------------<a name='700'></font>
<font color=#447700>!     ADDED STATES: SH2O(NSOIL) - UNFROZEN SOIL MOISTURE<a name='701'></font>
<font color=#447700>!                   SNOWH       - SNOW DEPTH<a name='702'></font>
<font color=#447700>!<a name='703'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='704'></font>
<font color=#447700>!<a name='705'></font>
<font color=#447700>! NOTE ON SNOW STATE VARIABLES:<a name='706'></font>
<font color=#447700>!   SNOWH = actual physical snow depth in m<a name='707'></font>
<font color=#447700>!   SNEQV = liquid water-equivalent snow depth in m<a name='708'></font>
<font color=#447700>!            (time-dependent snow density is obtained from SNEQV/SNOWH)<a name='709'></font>
<font color=#447700>!<a name='710'></font>
<font color=#447700>! NOTE ON ALBEDO FRACTIONS:<a name='711'></font>
<font color=#447700>!   Input:<a name='712'></font>
<font color=#447700>!     ALB    = BASELINE SNOW-FREE ALBEDO, FOR JULIAN DAY OF YEAR <a name='713'></font>
<font color=#447700>!   	       (USUALLY FROM TEMPORAL INTERPOLATION OF MONTHLY MEAN VALUES)<a name='714'></font>
<font color=#447700>!   	       (CALLING PROG MAY OR MAY NOT INCLUDE DIURNAL SUN ANGLE EFFECT)<a name='715'></font>
<font color=#447700>!     SNOALB = UPPER BOUND ON MAXIMUM ALBEDO OVER DEEP SNOW<a name='716'></font>
<font color=#447700>!   	       (E.G. FROM ROBINSON AND KUKLA, 1985, J. CLIM. &amp; APPL. METEOR.)<a name='717'></font>
<font color=#447700>!   Output:<a name='718'></font>
<font color=#447700>!     ALBEDO = COMPUTED ALBEDO WITH SNOWCOVER EFFECTS <a name='719'></font>
<font color=#447700>!   	      (COMPUTED USING ALB, SNOALB, SNEQV, AND SHDFAC-&gt;green veg frac)<a name='720'></font>
<font color=#447700>!<a name='721'></font>
<font color=#447700>!   		 ARGUMENT LIST IN THE CALL TO SFLX<a name='722'></font>
<font color=#447700>!<a name='723'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='724'></font>
<font color=#447700>! 1. CALLING STATEMENT<a name='725'></font>
<font color=#447700>!<a name='726'></font>
<font color=#447700>!     SUBROUTINE SFLX<a name='727'></font>
<font color=#447700>!    I (ICE,DT,Z,NSOIL,SLDPTH,<a name='728'></font>
<font color=#447700>!    I LWDN,SOLDN,SFCPRS,PRCP,SFCTMP,TH2,Q2,Q2SAT,DQSDT2,<a name='729'></font>
<font color=#447700>!    I VEGTYP,SOILTYP,SLOPETYP,<a name='730'></font>
<font color=#447700>!    I SHDFAC,PTU,TBOT,ALB,SNOALB,<a name='731'></font>
<font color=#447700>!    I SFCSPD,<a name='732'></font>
<font color=#447700>!    2 CMC,T1,STC,SMC,SH2O,SNOWH,SNEQV,CH,CM,<a name='733'></font>
<font color=#447700>!    O ETP,ETA,H,S,RUNOFF1,RUNOFF2,Q1,SNMAX,ALBEDO,<a name='734'></font>
<font color=#447700>!    O SOILW,SOILM,SMCWLT,SMCDRY,SMCREF,SMCMAX)<a name='735'></font>
<font color=#447700>!<a name='736'></font>
<font color=#447700>! 2. INPUT (denoted by "I" in column six of argument list at top of routine)<a name='737'></font>
<font color=#447700>!                  ### GENERAL PARAMETERS ###<a name='738'></font>
<font color=#447700>!<a name='739'></font>
<font color=#447700>!          ICE: SEA-ICE FLAG  (=1: SEA-ICE, =0: LAND)<a name='740'></font>
<font color=#447700>!           DT: TIMESTEP (SEC)<a name='741'></font>
<font color=#447700>!               (DT SHOULD NOT EXCEED 3600 SECS, RECOMMEND 1800 SECS OR LESS)<a name='742'></font>
<font color=#447700>!            Z: HEIGHT (M) ABOVE GROUND OF ATMOSPHERIC FORCING VARIABLES<a name='743'></font>
<font color=#447700>!        NSOIL: NUMBER OF SOIL LAYERS  <a name='744'></font>
<font color=#447700>!              (at least 2, and not greater than parameter NSOLD set below)<a name='745'></font>
<font color=#447700>!       SLDPTH: THE THICKNESS OF EACH SOIL LAYER (M) <a name='746'></font>
<font color=#447700>!<a name='747'></font>
<font color=#447700>!                  ### ATMOSPHERIC VARIABLES ###<a name='748'></font>
<font color=#447700>!<a name='749'></font>
<font color=#447700>!         LWDN: LW DOWNWARD RADIATION (W M-2; POSITIVE, not net longwave)<a name='750'></font>
<font color=#447700>!        SOLDN: SOLAR DOWNWARD RADIATION (W M-2; POSITIVE, not net shortwave)<a name='751'></font>
<font color=#447700>!       SFCPRS: PRESSURE AT HEIGHT Z ABOVE GROUND (PASCALS)<a name='752'></font>
<font color=#447700>!         PRCP: PRECIP RATE (KG M-2 S-1) (note, this is a rate)<a name='753'></font>
<font color=#447700>!       SFCTMP: AIR TEMPERATURE (K) AT HEIGHT Z ABOVE GROUND <a name='754'></font>
<font color=#447700>!          TH2: AIR POTENTIAL TEMPERATURE (K) AT HEIGHT Z ABOVE GROUND <a name='755'></font>
<font color=#447700>!           Q2: MIXING RATIO AT HEIGHT Z ABOVE GROUND (KG KG-1)<a name='756'></font>
<font color=#447700>!       SFCSPD: WIND SPEED (M S-1) AT HEIGHT Z ABOVE GROUND<a name='757'></font>
<font color=#447700>!        Q2SAT: SAT MIXING RATIO AT HEIGHT Z ABOVE GROUND (KG KG-1)<a name='758'></font>
<font color=#447700>!       DQSDT2: SLOPE OF SAT SPECIFIC HUMIDITY CURVE AT T=SFCTMP (KG KG-1 K-1)<a name='759'></font>
<font color=#447700>!<a name='760'></font>
<font color=#447700>!                  ### CANOPY/SOIL CHARACTERISTICS ###<a name='761'></font>
<font color=#447700>!<a name='762'></font>
<font color=#447700>!       VEGTYP: VEGETATION TYPE (INTEGER INDEX)<a name='763'></font>
<font color=#447700>!       SOILTYP: SOIL TYPE (INTEGER INDEX)<a name='764'></font>
<font color=#447700>!     SLOPETYP: CLASS OF SFC SLOPE (INTEGER INDEX)<a name='765'></font>
<font color=#447700>!       SHDFAC: AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION (range 0.0-1.0)<a name='766'></font>
<font color=#447700>!          PTU: PHOTO THERMAL UNIT (PLANT PHENOLOGY FOR ANNUALS/CROPS)<a name='767'></font>
<font color=#447700>!              (not yet used, but passed to REDPRM for future use in veg parms)<a name='768'></font>
<font color=#447700>!         TBOT: BOTTOM SOIL TEMPERATURE (LOCAL YEARLY-MEAN SFC AIR TEMPERATURE)<a name='769'></font>
<font color=#447700>!          ALB: BACKROUND SNOW-FREE SURFACE ALBEDO (FRACTION)<a name='770'></font>
<font color=#447700>!       SNOALB: ALBEDO UPPER BOUND OVER DEEP SNOW (FRACTION)<a name='771'></font>
<font color=#447700>!<a name='772'></font>
<font color=#447700>! 3. STATE VARIABLES: BOTH INPUT AND OUTPUT<a name='773'></font>
<font color=#447700>!			 (NOTE: OUTPUT USUALLY MODIFIED FROM INPUT BY PHYSICS)<a name='774'></font>
<font color=#447700>!<a name='775'></font>
<font color=#447700>!      (denoted by "2" in column six of argument list at top of routine)<a name='776'></font>
<font color=#447700>!<a name='777'></font>
<font color=#447700>!       !!! ########### STATE VARIABLES ##############  !!!<a name='778'></font>
<font color=#447700>!<a name='779'></font>
<font color=#447700>!         CMC: CANOPY MOISTURE CONTENT (M)<a name='780'></font>
<font color=#447700>!          T1: GROUND/CANOPY/SNOWPACK) EFFECTIVE SKIN TEMPERATURE (K)<a name='781'></font>
<font color=#447700>!<a name='782'></font>
<font color=#447700>!  STC(NSOIL): SOIL TEMP (K)<a name='783'></font>
<font color=#447700>!  SMC(NSOIL): TOTAL SOIL MOISTURE CONTENT (VOLUMETRIC FRACTION)<a name='784'></font>
<font color=#447700>! SH2O(NSOIL): UNFROZEN SOIL MOISTURE CONTENT (VOLUMETRIC FRACTION)<a name='785'></font>
<font color=#447700>!               NOTE: FROZEN SOIL MOISTURE = SMC - SH2O<a name='786'></font>
<font color=#447700>!<a name='787'></font>
<font color=#447700>!       SNOWH: SNOW DEPTH (M)<a name='788'></font>
<font color=#447700>!       SNEQV: WATER-EQUIVALENT SNOW DEPTH (M)<a name='789'></font>
<font color=#447700>!               NOTE: SNOW DENSITY = SNEQV/SNOWH<a name='790'></font>
<font color=#447700>!      ALBEDO: SURFACE ALBEDO INCLUDING SNOW EFFECT (UNITLESS FRACTION)<a name='791'></font>
<font color=#447700>!          CH: SFC EXCH COEF FOR HEAT AND MOISTURE (M S-1)<a name='792'></font>
<font color=#447700>!          CM: SFC EXCH COEF FOR MOMENTUM (M S-1)<a name='793'></font>
<font color=#447700>!              NOTE: CH AND CM ARE TECHNICALLY CONDUCTANCES SINCE THEY<a name='794'></font>
<font color=#447700>!              HAVE BEEN MULTIPLIED BY THE WIND SPEED.<a name='795'></font>
<font color=#447700>!<a name='796'></font>
<font color=#447700>! 4. OUTPUT (denoted by "O" in column six of argument list at top of routine)<a name='797'></font>
<font color=#447700>!<a name='798'></font>
<font color=#447700>!	NOTE-- SIGN CONVENTION OF SFC ENERGY FLUXES BELOW IS: NEGATIVE IF<a name='799'></font>
<font color=#447700>!            SINK OF ENERGY TO SURFACE<a name='800'></font>
<font color=#447700>!<a name='801'></font>
<font color=#447700>!          ETP: POTENTIAL EVAPORATION (W M-2)<a name='802'></font>
<font color=#447700>!          ETA: ACTUAL LATENT HEAT FLUX (W M-2: POSITIVE, IF UP FROM SURFACE)<a name='803'></font>
<font color=#447700>!            H: SENSIBLE HEAT FLUX (W M-2: POSITIVE, IF UPWARD FROM SURFACE)<a name='804'></font>
<font color=#447700>!            S: SOIL HEAT FLUX (W M-2: POSITIVE, IF DOWNWARD FROM SURFACE)<a name='805'></font>
<font color=#447700>!      RUNOFF1: SURFACE RUNOFF (M S-1), NOT INFILTRATING THE SURFACE<a name='806'></font>
<font color=#447700>!      RUNOFF2: SUBSURFACE RUNOFF (M S-1), DRAINAGE OUT BOTTOM OF LAST SOIL LYR<a name='807'></font>
<font color=#447700>!           Q1: EFFECTIVE MIXING RATIO AT GRND SFC (KG KG-1)<a name='808'></font>
<font color=#447700>!               (NOTE: Q1 IS NUMERICAL EXPENDIENCY FOR EXPRESSING ETA<a name='809'></font>
<font color=#447700>!                     EQUIVALENTLY IN A BULK AERODYNAMIC FORM)<a name='810'></font>
<font color=#447700>!        SNMAX: SNOW MELT (M) (WATER EQUIVALENT)<a name='811'></font>
<font color=#447700>!        SOILW: AVAILABLE SOIL MOISTURE IN ROOT ZONE (UNITLESS FRACTION BETWEEN<a name='812'></font>
<font color=#447700>!               SOIL SATURATION AND WILTING POINT)<a name='813'></font>
<font color=#447700>!        SOILM: TOTAL SOIL COLUMN MOISTURE CONTENT (M) (FROZEN + UNFROZEN)<a name='814'></font>
<font color=#447700>!<a name='815'></font>
<font color=#447700>!           FOR DIAGNOSTIC PURPOSES, RETURN SOME PRIMARY PARAMETERS NEXT<a name='816'></font>
<font color=#447700>!			(SET IN ROUTINE REDPRM)<a name='817'></font>
<font color=#447700>!<a name='818'></font>
<font color=#447700>!       SMCWLT: WILTING POINT (VOLUMETRIC)<a name='819'></font>
<font color=#447700>!       SMCDRY: DRY SOIL MOISTURE THRESHOLD WHERE DIRECT EVAP FRM TOP LYR ENDS<a name='820'></font>
<font color=#447700>!       SMCREF: SOIL MOISTURE THRESHOLD WHERE TRANSPIRATION BEGINS TO STRESS<a name='821'></font>
<font color=#447700>!       SMCMAX: POROSITY, I.E. SATURATED VALUE OF SOIL MOISTURE<a name='822'></font>
      INTEGER NSOLD<a name='823'>
      PARAMETER (NSOLD = 20)<a name='824'>
<font color=#447700>!tst      PARAMETER (NSOLD = 4)<a name='825'></font>
<font color=#447700>!<a name='826'></font>
      LOGICAL SNOWNG<a name='827'>
      LOGICAL FRZGRA<a name='828'>
      LOGICAL SATURATED<a name='829'>
<font color=#447700>!<a name='830'></font>
      INTEGER K<a name='831'>
      INTEGER KZ<a name='832'>
      INTEGER ICE<a name='833'>
      INTEGER NSOIL,VEGTYP,SOILTYP,NROOT<a name='834'>
      INTEGER SLOPETYP<a name='835'>
<font color=#447700>!<a name='836'></font>
      REAL ALBEDO<a name='837'>
      REAL ALB<a name='838'>
      REAL B<a name='839'>
      REAL BETA<a name='840'>
      REAL CFACTR<a name='841'>
<font color=#447700>!..................CH IS SFC EXCHANGE COEF FOR HEAT/MOIST<a name='842'></font>
<font color=#447700>!..................CM IS SFC MOMENTUM DRAG (NOT NEEDED IN SFLX)<a name='843'></font>
      REAL CH<a name='844'>
      REAL CM<a name='845'>
<font color=#447700>!<a name='846'></font>
      REAL CMC<a name='847'>
      REAL CMCMAX<a name='848'>
      REAL CP<a name='849'>
      REAL CSOIL<a name='850'>
      REAL CZIL<a name='851'>
      REAL DEW<a name='852'>
      REAL DF1<a name='853'>
      REAL DF1P<a name='854'>
      REAL DKSAT<a name='855'>
      REAL DT<a name='856'>
      REAL DWSAT<a name='857'>
      REAL DQSDT2<a name='858'>
      REAL DSOIL<a name='859'>
      REAL DTOT<a name='860'>
      REAL DRIP<a name='861'>
      REAL EC<a name='862'>
      REAL EDIR<a name='863'>
      REAL ETT<a name='864'>
      REAL EXPSNO<a name='865'>
      REAL EXPSOI<a name='866'>
      REAL EPSCA<a name='867'>
      REAL ETA<a name='868'>
      REAL ETP<a name='869'>
      REAL EDIR1<a name='870'>
      REAL EC1<a name='871'>
      REAL ETT1<a name='872'>
      REAL F<a name='873'>
      REAL F1<a name='874'>
      REAL FLX1<a name='875'>
      REAL FLX2<a name='876'>
      REAL FLX3<a name='877'>
      REAL FXEXP<a name='878'>
      REAL FRZX<a name='879'>
      REAL H<a name='880'>
      REAL HS<a name='881'>
      REAL KDT<a name='882'>
      REAL LWDN<a name='883'>
      REAL LVH2O<a name='884'>
      REAL PC<a name='885'>
      REAL PRCP<a name='886'>
      REAL PTU<a name='887'>
      REAL PRCP1<a name='888'>
      REAL PSISAT<a name='889'>
      REAL Q1<a name='890'>
      REAL Q2<a name='891'>
      REAL Q2SAT<a name='892'>
      REAL QUARTZ<a name='893'>
      REAL R<a name='894'>
      REAL RCH<a name='895'>
      REAL REFKDT<a name='896'>
      REAL RR<a name='897'>
      REAL RTDIS (NSOLD)<a name='898'>
      REAL RUNOFF1<a name='899'>
      REAL RUNOFF2<a name='900'>
      REAL RGL<a name='901'>
      REAL RUNOF<a name='902'>
      REAL RIB<a name='903'>
      REAL RUNOFF3<a name='904'>
      REAL RSMAX<a name='905'>
      REAL RC<a name='906'>
      REAL RCMIN<a name='907'>
      REAL RSNOW<a name='908'>
      REAL SNDENS<a name='909'>
      REAL SNCOND <a name='910'>
      REAL S<a name='911'>
      REAL SBETA<a name='912'>
      REAL SFCPRS<a name='913'>
      REAL SFCSPD<a name='914'>
      REAL SFCTMP<a name='915'>
      REAL SHDFAC<a name='916'>
      REAL SH2O(NSOIL)<a name='917'>
      REAL SLDPTH(NSOIL)<a name='918'>
      REAL SMCDRY<a name='919'>
      REAL SMCMAX<a name='920'>
      REAL SMCREF<a name='921'>
      REAL SMCWLT<a name='922'>
      REAL SMC(NSOIL)<a name='923'>
      REAL SNEQV<a name='924'>
      REAL SNOWH<a name='925'>
      REAL SNOFAC<a name='926'>
      REAL SN_NEW<a name='927'>
      REAL SLOPE<a name='928'>
      REAL SNUP<a name='929'>
      REAL SALP<a name='930'>
      REAL SNOALB<a name='931'>
      REAL STC(NSOIL)<a name='932'>
      REAL SOLDN<a name='933'>
      REAL SOLNET<a name='934'>
      REAL SNMAX<a name='935'>
      REAL SOILM<a name='936'>
      REAL SOILW<a name='937'>
      REAL SOILWM<a name='938'>
      REAL SOILWW<a name='939'>
      REAL T1<a name='940'>
      REAL T1V<a name='941'>
      REAL T24<a name='942'>
      REAL T2V<a name='943'>
      REAL TBOT<a name='944'>
      REAL TH2<a name='945'>
      REAL TH2V<a name='946'>
      REAL TOPT<a name='947'>
      REAL TFREEZ<a name='948'>
      REAL XLAI<a name='949'>
      REAL Z<a name='950'>
      REAL ZBOT<a name='951'>
      REAL Z0<a name='952'>
      REAL ZSOIL(NSOLD)<a name='953'>
      REAL FFROZP<a name='954'>
<a name='955'>
      CHARACTER(LEN=4) :: veg_def<a name='956'>
<a name='957'>
<font color=#447700>!<a name='958'></font>
      PARAMETER ( TFREEZ = 273.15      )<a name='959'>
      PARAMETER ( LVH2O  = 2.501000E+6 )<a name='960'>
      PARAMETER ( R      = 287.04      )<a name='961'>
      PARAMETER ( CP     = 1004.5      )<a name='962'>
      <a name='963'>
<font color=#447700>!<a name='964'></font>
<font color=#447700>! COMMON BLK "RITE" CARRIES DIAGNOSTIC QUANTITIES FOR PRINTOUT,<a name='965'></font>
<font color=#447700>! BUT IS NOT INVOLVED IN MODEL PHYSICS AND IS NOT PRESENT IN<a name='966'></font>
<font color=#447700>! PARENT MODEL THAT CALLS SFLX<a name='967'></font>
<font color=#447700>!<a name='968'></font>
      COMMON/RITE/ BETA,DRIP,EC,EDIR,ETT,FLX1,FLX2,FLX3,RUNOF,  &amp;<a name='969'>
                   DEW,RIB,RUNOFF3<a name='970'>
<a name='971'>
<font color=#447700>!   INITIALIZATION<a name='972'></font>
<a name='973'>
<a name='974'>
<font color=#447700>!tst<a name='975'></font>
	if (SH2O(1) .lt. 0) then<a name='976'>
	write(errmess,*) 'negative SH2O coming INTO SFLX... ', SH2O(1),SMC(1)<a name='977'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_53">( errmess )<a name='978'>
	endif<a name='979'>
<font color=#447700>!tst<a name='980'></font>
<a name='981'>
      RUNOFF1 = 0.0<a name='982'>
      RUNOFF2 = 0.0<a name='983'>
      RUNOFF3 = 0.0<a name='984'>
      SNMAX = 0.0<a name='985'>
<font color=#447700>!<a name='986'></font>
<font color=#447700>!  THE VARIABLE "ICE" IS A FLAG DENOTING SEA-ICE CASE <a name='987'></font>
<a name='988'>
      IF(ICE .EQ. 1) THEN<a name='989'>
<a name='990'>
<font color=#447700>! SEA-ICE LAYERS ARE EQUAL THICKNESS AND SUM TO 3 METERS<a name='991'></font>
        DO KZ = 1, NSOIL<a name='992'>
          ZSOIL(KZ)=-3.*FLOAT(KZ)/FLOAT(NSOIL)<a name='993'>
        END DO<a name='994'>
<a name='995'>
      ELSE<a name='996'>
<a name='997'>
<font color=#447700>! CALCULATE DEPTH (NEGATIVE) BELOW GROUND FROM TOP SKIN SFC TO <a name='998'></font>
<font color=#447700>! BOTTOM OF EACH SOIL LAYER.<a name='999'></font>
<font color=#447700>! NOTE:!!! SIGN OF ZSOIL IS NEGATIVE (DENOTING BELOW GROUND)<a name='1000'></font>
        ZSOIL(1)=-SLDPTH(1)<a name='1001'>
        DO KZ = 2, NSOIL<a name='1002'>
          ZSOIL(KZ)=-SLDPTH(KZ)+ZSOIL(KZ-1)<a name='1003'>
        END DO<a name='1004'>
<a name='1005'>
      ENDIF<a name='1006'>
         <a name='1007'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1008'></font>
<font color=#447700>!C<a name='1009'></font>
<font color=#447700>!C   NEXT IS CRUCIAL CALL TO SET THE LAND-SURFACE PARAMETERS, <a name='1010'></font>
<font color=#447700>!C   INCLUDING SOIL-TYPE AND VEG-TYPE DEPENDENT PARAMETERS.<a name='1011'></font>
<font color=#447700>!C<a name='1012'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1013'></font>
<font color=#447700>!C<a name='1014'></font>
        veg_def='9999'<a name='1015'>
        call <A href='../../html_code/frame/module_configure.F.html#NL_GET_MMINLU'>nl_get_mminlu</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NL_GET_MMINLU_3">(1,veg_def)<a name='1016'>
<a name='1017'>
        if (veg_def .ne. 'USGS') then<a name='1018'>
        CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM'>REDPRM</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REDPRM_1">(VEGTYP,SOILTYP, SLOPETYP,                         &amp;<a name='1019'>
          CFACTR, CMCMAX, RSMAX, TOPT, REFKDT, KDT, SBETA,            &amp;<a name='1020'>
          SHDFAC, RCMIN, RGL, HS, ZBOT, FRZX, PSISAT, SLOPE,          &amp;<a name='1021'>
          SNUP, SALP, B, DKSAT, DWSAT, SMCMAX, SMCWLT, SMCREF,        &amp;<a name='1022'>
          SMCDRY, F1, QUARTZ, FXEXP, RTDIS, SLDPTH, ZSOIL,            &amp;<a name='1023'>
          NROOT, NSOIL, Z0, CZIL, XLAI, CSOIL, PTU)<a name='1024'>
	else <a name='1025'>
        CALL <A href='../../html_code/phys/module_sf_lsm_nmm.F.html#REDPRM_USGS'>REDPRM_USGS</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REDPRM_USGS_1">(VEGTYP,SOILTYP, SLOPETYP,                         &amp;<a name='1026'>
          CFACTR, CMCMAX, RSMAX, TOPT, REFKDT, KDT, SBETA,            &amp;<a name='1027'>
          SHDFAC, RCMIN, RGL, HS, ZBOT, FRZX, PSISAT, SLOPE,          &amp;<a name='1028'>
          SNUP, SALP, B, DKSAT, DWSAT, SMCMAX, SMCWLT, SMCREF,        &amp;<a name='1029'>
          SMCDRY, F1, QUARTZ, FXEXP, RTDIS, SLDPTH, ZSOIL,            &amp;<a name='1030'>
          NROOT, NSOIL, Z0, CZIL, XLAI, CSOIL, PTU)<a name='1031'>
	<a name='1032'>
	if ( abs(SMCWLT) .lt. 1.5) then<a name='1033'>
<font color=#447700>!okay<a name='1034'></font>
	else<a name='1035'>
	write(errmess,*) 'BAD SMCWLT from REDPRM_USGS: ', SMCWLT<a name='1036'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_54">(errmess)<a name='1037'>
	write(errmess,*) 'BAD VEGTYP,SOILTYP:: ', VEGTYP,SOILTYP<a name='1038'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_55">(errmess)<a name='1039'>
	endif<a name='1040'>
	<a name='1041'>
        endif<a name='1042'>
<a name='1043'>
<font color=#447700>!<a name='1044'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1045'></font>
<font color=#447700>!C<a name='1046'></font>
<font color=#447700>!C  NEXT CALL ROUTINE SFCDIF TO CALCULATE <a name='1047'></font>
<font color=#447700>!C    THE SFC EXCHANGE COEF (CH) FOR HEAT AND MOISTURE<a name='1048'></font>
<font color=#447700>!C<a name='1049'></font>
<font color=#447700>!C  NOTE  NOTE  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1050'></font>
<font color=#447700>!C    <a name='1051'></font>
<font color=#447700>!C          COMMENT OUT CALL SFCDIF, IF SFCDIF ALREADY CALLED<a name='1052'></font>
<font color=#447700>!C          IN CALLING PROGRAM (SUCH AS IN COUPLED ATMOSPHERIC MODEL)<a name='1053'></font>
<font color=#447700>!C<a name='1054'></font>
<font color=#447700>!C  NOTE !!  DO NOT CALL SFCDIF UNTIL AFTER ABOVE CALL TO REDPRM, <a name='1055'></font>
<font color=#447700>!C             IN CASE ALTERNATIVE VALUES OF ROUGHNESS LENGTH (Z0) AND <a name='1056'></font>
<font color=#447700>!C              ZILINTINKEVICH COEF (CZIL) ARE SET THERE VIA NAMELIST I/O<a name='1057'></font>
<font color=#447700>!C<a name='1058'></font>
<font color=#447700>!C   NOTE !! ROUTINE SFCDIF RETURNS A CH THAT REPRESENTS THE WIND SPD<a name='1059'></font>
<font color=#447700>!C          TIMES THE "ORIGINAL" NONDIMENSIONAL "Ch" TYPICAL IN LITERATURE.<a name='1060'></font>
<font color=#447700>!C          HENCE THE CH RETURNED FROM SFCDIF HAS UNITS OF M/S.<a name='1061'></font>
<font color=#447700>!C          THE IMPORTANT COMPANION COEFFICIENT OF CH, CARRIED HERE AS "RCH",<a name='1062'></font>
<font color=#447700>!C          IS THE CH FROM SFCDIF TIMES AIR DENSITY AND PARAMETER "CP".<a name='1063'></font>
<font color=#447700>!C         "RCH" IS COMPUTED IN "CALL PENMAN". RCH RATHER THAN CH IS THE <a name='1064'></font>
<font color=#447700>!          COEFF USUALLY INVOKED LATER IN EQNS.<a name='1065'></font>
<font color=#447700>!C<a name='1066'></font>
<font color=#447700>!C   NOTE !! SFCDIF ALSO RETURNS THE SURFACE EXCHANGE COEFFICIENT FOR<a name='1067'></font>
<font color=#447700>!            MOMENTUM, CM, ALSO KNOWN AS THE SURFACE DRAGE COEFFICIENT,<a name='1068'></font>
<font color=#447700>!            BUT CM IS NOT USED HERE<a name='1069'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1070'></font>
<font color=#447700>!<a name='1071'></font>
    <a name='1072'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1073'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1074'></font>
<font color=#447700>! CALC VIRTUAL TEMPS AND VIRTUAL POTENTIAL TEMPS NEEDED BY <a name='1075'></font>
<font color=#447700>! SUBROUTINES SFCDIF AND PENMAN<a name='1076'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1077'></font>
<a name='1078'>
      T2V  = SFCTMP * (1.0 + 0.61 * Q2 )<a name='1079'>
<font color=#447700>! comment out below 2 lines if CALL SFCDIF is commented out, i.e. in<a name='1080'></font>
<font color=#447700>! the coupled model<a name='1081'></font>
      T1V  =     T1 * (1.0 + 0.61 * Q2 )<a name='1082'>
      TH2V =    TH2 * (1.0 + 0.61 * Q2 )<a name='1083'>
<a name='1084'>
<font color=#447700>!      CALL SFCDIF ( Z, Z0, T1V, TH2V, SFCSPD, CZIL, CM, CH )<a name='1085'></font>
<a name='1086'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1087'></font>
<font color=#447700>!  INITIALIZE MISC VARIABLES.<a name='1088'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1089'></font>
<a name='1090'>
      SNOWNG = .FALSE.<a name='1091'>
      FRZGRA = .FALSE.<a name='1092'>
<a name='1093'>
<font color=#447700>! IF SEA-ICE CASE,        ASSIGN DEFAULT WATER-EQUIV SNOW ON TOP<a name='1094'></font>
      IF(ICE .EQ. 1) THEN<a name='1095'>
        SNEQV = 0.01<a name='1096'>
        SNOWH = 0.05<a name='1097'>
      ENDIF<a name='1098'>
<font color=#447700>!<a name='1099'></font>
<font color=#447700>! IF INPUT SNOWPACK IS NONZERO, THEN COMPUTE SNOW DENSITY "SNDENS"<a name='1100'></font>
<font color=#447700>! AND SNOW THERMAL CONDUCTIVITY "SNCOND"<a name='1101'></font>
<font color=#447700>! (NOTE THAT CSNOW IS A FUNCTION SUBROUTINE)<a name='1102'></font>
<font color=#447700>!<a name='1103'></font>
      IF(SNEQV .EQ. 0.0) THEN<a name='1104'>
        SNDENS = 0.0<a name='1105'>
        SNOWH = 0.0<a name='1106'>
        SNCOND = 1.0<a name='1107'>
      ELSE<a name='1108'>
        SNDENS=SNEQV/SNOWH<a name='1109'>
        SNCOND = CSNOW (SNDENS) <a name='1110'>
      ENDIF<a name='1111'>
<a name='1112'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1113'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1114'></font>
<font color=#447700>!     DETERMINE IF IT'S PRECIPITATING AND WHAT KIND OF PRECIP IT IS.<a name='1115'></font>
<font color=#447700>!     IF IT'S PRCPING AND THE AIR TEMP IS COLDER THAN 0 C, IT'S SNOWING!<a name='1116'></font>
<font color=#447700>!     IF IT'S PRCPING AND THE AIR TEMP IS WARMER THAN 0 C, BUT THE GRND<a name='1117'></font>
<font color=#447700>!     TEMP IS COLDER THAN 0 C, FREEZING RAIN IS PRESUMED TO BE FALLING.<a name='1118'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1119'></font>
<a name='1120'>
      IF ( PRCP .GT. 0.0 ) THEN<a name='1121'>
<font color=#447700>!***  Snow defined when fraction of frozen precip (FFROZP) &gt; 0.5, passed<a name='1122'></font>
<font color=#447700>!***  in from model microphysics.<a name='1123'></font>
        IF (FFROZP .GT. 0.5) THEN<a name='1124'>
          SNOWNG = .TRUE.<a name='1125'>
        ELSE<a name='1126'>
          IF ( T1 .LE. TFREEZ ) FRZGRA = .TRUE.<a name='1127'>
        ENDIF<a name='1128'>
      ENDIF<a name='1129'>
<a name='1130'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1131'></font>
<font color=#447700>! If either prcp flag is set, determine new snowfall (converting prcp<a name='1132'></font>
<font color=#447700>! rate from kg m-2 s-1 to a liquid equiv snow depth in meters) and add<a name='1133'></font>
<font color=#447700>! it to the existing snowpack.<a name='1134'></font>
<font color=#447700>! Note that since all precip is added to snowpack, no precip infiltrates<a name='1135'></font>
<font color=#447700>! into the soil so that PRCP1 is set to zero.<a name='1136'></font>
      IF ( ( SNOWNG ) .OR. ( FRZGRA ) ) THEN<a name='1137'>
        SN_NEW = PRCP * DT * 0.001<a name='1138'>
        SNEQV = SNEQV + SN_NEW<a name='1139'>
        PRCP1 = 0.0<a name='1140'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1141'></font>
<font color=#447700>! Update snow density based on new snowfall, using old and new snow.<a name='1142'></font>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOW_NEW'>SNOW_NEW</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOW_NEW_1"> (SFCTMP,SN_NEW,SNOWH,SNDENS)<a name='1143'>
<font color=#447700>! --- debug ------------------------------------------------------------<a name='1144'></font>
<font color=#447700>!      SNDENS = 0.2<a name='1145'></font>
<font color=#447700>!      SNOWH = SNEQV/SNDENS<a name='1146'></font>
<font color=#447700>! --- debug ------------------------------------------------------------<a name='1147'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1148'></font>
<font color=#447700>! Update snow thermal conductivity<a name='1149'></font>
      SNCOND = CSNOW (SNDENS) <a name='1150'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1151'></font>
<a name='1152'>
      ELSE<a name='1153'>
<font color=#447700>!<a name='1154'></font>
<font color=#447700>! PRECIP IS LIQUID (RAIN), HENCE SAVE IN THE PRECIP VARIABLE THAT<a name='1155'></font>
<font color=#447700>! LATER CAN WHOLELY OR PARTIALLY INFILTRATE THE SOIL (ALONG WITH <a name='1156'></font>
<font color=#447700>! ANY CANOPY "DRIP" ADDED TO THIS LATER)<a name='1157'></font>
<font color=#447700>!<a name='1158'></font>
        PRCP1 = PRCP<a name='1159'>
<a name='1160'>
      ENDIF<a name='1161'>
<a name='1162'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1163'></font>
<font color=#447700>! Update albedo, except over sea-ice<a name='1164'></font>
      IF (ICE .EQ. 0) THEN<a name='1165'>
<a name='1166'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1167'></font>
<font color=#447700>! NEXT IS TIME-DEPENDENT SURFACE ALBEDO MODIFICATION DUE TO <a name='1168'></font>
<font color=#447700>! TIME-DEPENDENT SNOWDEPTH STATE AND TIME-DEPENDENT CANOPY GREENNESS<a name='1169'></font>
      <a name='1170'>
<font color=#447700>!      IF ( (SNEQV .EQ. 0.0) .OR. (ALB .GE. SNOALB) ) THEN<a name='1171'></font>
        IF (SNEQV .EQ. 0.0) THEN<a name='1172'>
          ALBEDO = ALB<a name='1173'>
<a name='1174'>
        ELSE<a name='1175'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1176'></font>
<font color=#447700>! SNUP IS VEG-CLASS DEPENDENT SNOWDEPTH THRESHHOLD (SET IN ROUTINE<a name='1177'></font>
<font color=#447700>! REDPRM)WHERE MAX SNOW ALBEDO EFFECT IS FIRST ATTAINED<a name='1178'></font>
          IF (SNEQV .LT. SNUP) THEN<a name='1179'>
            RSNOW = SNEQV/SNUP<a name='1180'>
            SNOFAC = 1. - ( EXP(-SALP*RSNOW) - RSNOW*EXP(-SALP))<a name='1181'>
          ELSE<a name='1182'>
            SNOFAC = 1.0<a name='1183'>
          ENDIF<a name='1184'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1185'></font>
<font color=#447700>! SNOALB IS ARGUMENT REPRESENTING MAXIMUM ALBEDO OVER DEEP SNOW,<a name='1186'></font>
<font color=#447700>! AS PASSED INTO SFLX, AND ADAPTED FROM THE SATELLITE-BASED MAXIMUM <a name='1187'></font>
<font color=#447700>! SNOW ALBEDO FIELDS PROVIDED BY D. ROBINSON AND G. KUKLA <a name='1188'></font>
<font color=#447700>! (1985, JCAM, VOL 24, 402-411)<a name='1189'></font>
<a name='1190'>
          ALBEDO = ALB + (1.0-SHDFAC)*SNOFAC*(SNOALB-ALB) <a name='1191'>
          IF (ALBEDO .GT. SNOALB) ALBEDO=SNOALB<a name='1192'>
        ENDIF<a name='1193'>
<a name='1194'>
      ELSE<a name='1195'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1196'></font>
<font color=#447700>! albedo over sea-ice<a name='1197'></font>
          ALBEDO = 0.60<a name='1198'>
          SNOFAC = 1.0<a name='1199'>
      ENDIF<a name='1200'>
<a name='1201'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1202'></font>
<font color=#447700>! Thermal conductivity for sea-ice case<a name='1203'></font>
      IF (ICE .EQ. 1) THEN<a name='1204'>
        DF1=2.2<a name='1205'>
      ELSE<a name='1206'>
<font color=#447700>!<a name='1207'></font>
<font color=#447700>! NEXT CALCULATE THE SUBSURFACE HEAT FLUX, WHICH FIRST REQUIRES<a name='1208'></font>
<font color=#447700>! CALCULATION OF THE THERMAL DIFFUSIVITY.  TREATMENT OF THE<a name='1209'></font>
<font color=#447700>! LATTER FOLLOWS THAT ON PAGES 148-149 FROM "HEAT TRANSFER IN <a name='1210'></font>
<font color=#447700>! COLD CLIMATES", BY V. J. LUNARDINI (PUBLISHED IN 1981 <a name='1211'></font>
<font color=#447700>! BY VAN NOSTRAND REINHOLD CO.) I.E. TREATMENT OF TWO CONTIGUOUS <a name='1212'></font>
<font color=#447700>! "PLANE PARALLEL" MEDIUMS (NAMELY HERE THE FIRST SOIL LAYER <a name='1213'></font>
<font color=#447700>! AND THE SNOWPACK LAYER, IF ANY). THIS DIFFUSIVITY TREATMENT <a name='1214'></font>
<font color=#447700>! BEHAVES WELL FOR BOTH ZERO AND NONZERO SNOWPACK, INCLUDING THE <a name='1215'></font>
<font color=#447700>! LIMIT OF VERY THIN SNOWPACK.  THIS TREATMENT ALSO ELIMINATES<a name='1216'></font>
<font color=#447700>! THE NEED TO IMPOSE AN ARBITRARY UPPER BOUND ON SUBSURFACE <a name='1217'></font>
<font color=#447700>! HEAT FLUX WHEN THE SNOWPACK BECOMES EXTREMELY THIN.<a name='1218'></font>
<font color=#447700>!<a name='1219'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1220'></font>
<font color=#447700>! FIRST CALCULATE THERMAL DIFFUSIVITY OF TOP SOIL LAYER, USING<a name='1221'></font>
<font color=#447700>! BOTH THE FROZEN AND LIQUID SOIL MOISTURE, FOLLOWING THE <a name='1222'></font>
<font color=#447700>! SOIL THERMAL DIFFUSIVITY FUNCTION OF PETERS-LIDARD ET AL.<a name='1223'></font>
<font color=#447700>! (1998,JAS, VOL 55, 1209-1224), WHICH REQUIRES THE SPECIFYING<a name='1224'></font>
<font color=#447700>! THE QUARTZ CONTENT OF THE GIVEN SOIL CLASS (SEE ROUTINE REDPRM)<a name='1225'></font>
<font color=#447700>!<a name='1226'></font>
        CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_1"> ( DF1, SMC(1),QUARTZ,SMCMAX,SH2O(1))<a name='1227'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1228'></font>
<font color=#447700>! NEXT ADD SUBSURFACE HEAT FLUX REDUCTION EFFECT FROM THE <a name='1229'></font>
<font color=#447700>! OVERLYING GREEN CANOPY, ADAPTED FROM SECTION 2.1.2 OF <a name='1230'></font>
<font color=#447700>! PETERS-LIDARD ET AL. (1997, JGR, VOL 102(D4))<a name='1231'></font>
<font color=#447700>!<a name='1232'></font>
        DF1 = DF1 * EXP(SBETA*SHDFAC)<a name='1233'>
      ENDIF<a name='1234'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1235'></font>
<font color=#447700>! FINALLY "PLANE PARALLEL" SNOWPACK EFFECT FOLLOWING <a name='1236'></font>
<font color=#447700>! V.J. LINARDINI REFERENCE CITED ABOVE. NOTE THAT DTOT IS<a name='1237'></font>
<font color=#447700>! COMBINED DEPTH OF SNOWDEPTH AND THICKNESS OF FIRST SOIL LAYER<a name='1238'></font>
<font color=#447700>!<a name='1239'></font>
      DSOIL = -(0.5 * ZSOIL(1))<a name='1240'>
<a name='1241'>
      IF (SNEQV .EQ. 0.) THEN<a name='1242'>
        S = DF1 * (T1 - STC(1) ) / DSOIL<a name='1243'>
      ELSE<a name='1244'>
        DTOT = SNOWH + DSOIL<a name='1245'>
        EXPSNO = SNOWH/DTOT<a name='1246'>
        EXPSOI = DSOIL/DTOT<a name='1247'>
<font color=#447700>! 1. harmonic mean (series flow)<a name='1248'></font>
<font color=#447700>!     DF1 = (SNCOND*DF1)/(EXPSOI*SNCOND+EXPSNO*DF1)<a name='1249'></font>
<font color=#447700>! 2. arithmetic mean (parallel flow)<a name='1250'></font>
<font color=#447700>!     DF1 = EXPSNO*SNCOND + EXPSOI*DF1<a name='1251'></font>
      DF1P = EXPSNO*SNCOND + EXPSOI*DF1<a name='1252'>
<font color=#447700>! 3. geometric mean (intermediate between <a name='1253'></font>
<font color=#447700>!                     harmonic and arithmetic mean)<a name='1254'></font>
<font color=#447700>!        DF1 = (SNCOND**EXPSNO)*(DF1**EXPSOI)<a name='1255'></font>
<font color=#447700>! MBEK, 16 Jan 2002<a name='1256'></font>
<font color=#447700>! weigh DF by snow fraction, use parallel flow<a name='1257'></font>
        DF1 = DF1P*SNOFAC + DF1*(1.0-SNOFAC)<a name='1258'>
<a name='1259'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1260'></font>
<font color=#447700>! CALCULATE SUBSURFACE HEAT FLUX, S, FROM FINAL THERMAL DIFFUSIVITY<a name='1261'></font>
<font color=#447700>! OF SURFACE MEDIUMS, DF1 ABOVE, AND SKIN TEMPERATURE AND TOP <a name='1262'></font>
<font color=#447700>! MID-LAYER SOIL TEMPERATURE<a name='1263'></font>
        S = DF1 * (T1 - STC(1) ) / DTOT<a name='1264'>
      ENDIF<a name='1265'>
<a name='1266'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1267'></font>
<font color=#447700>!  CALCULATE TOTAL DOWNWARD RADIATION (SOLAR PLUS LONGWAVE)<a name='1268'></font>
<font color=#447700>!  NEEDED IN PENMAN EP SUBROUTINE THAT FOLLOWS<a name='1269'></font>
          <a name='1270'>
          F = SOLNET + LWDN<a name='1271'>
<a name='1272'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1273'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1274'></font>
<font color=#447700>!     CALL PENMAN SUBROUTINE TO CALCULATE POTENTIAL EVAPORATION (ETP)<a name='1275'></font>
<font color=#447700>!     (AND OTHER PARTIAL PRODUCTS AND SUMS SAVE IN COMMON/RITE FOR <a name='1276'></font>
<font color=#447700>!       LATER CALCULATIONS)<a name='1277'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1278'></font>
<a name='1279'>
       CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#PENMAN'>PENMAN</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PENMAN_1"> ( SFCTMP,SFCPRS,CH,T2V,TH2,PRCP,F,T24,S,Q2,     &amp;<a name='1280'>
                    Q2SAT,ETP,RCH,EPSCA,RR,SNOWNG,FRZGRA,DQSDT2)<a name='1281'>
<font color=#447700>!<a name='1282'></font>
<font color=#447700>! following old constraint is disabled<a name='1283'></font>
<font color=#447700>!.....IF(SATURATED) ETP = 0.0<a name='1284'></font>
<a name='1285'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1286'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1287'></font>
<font color=#447700>!     CALL CANRES TO CALCULATE THE CANOPY RESISTANCE AND CONVERT IT <a name='1288'></font>
<font color=#447700>!     INTO PC IF MORE THAN TRACE AMOUNT OF CANOPY GREENNESS FRACTION<a name='1289'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1290'></font>
<a name='1291'>
<font color=#447700>!      IF(SHDFAC .GT. 1.E-6) THEN<a name='1292'></font>
<font color=#447700>! make this threshold consistent with the one in SMFLX for TRANSP<a name='1293'></font>
<font color=#447700>! and EC(anopy)<a name='1294'></font>
      IF(SHDFAC .GT. 0.) THEN<a name='1295'>
      <a name='1296'>
<font color=#447700>!  FROZEN GROUND EXTENSION: TOTAL SOIL WATER "SMC" WAS REPLACED <a name='1297'></font>
<font color=#447700>!  BY UNFROZEN SOIL WATER "SH2O" IN CALL TO CANRES BELOW<a name='1298'></font>
<font color=#447700>!      <a name='1299'></font>
        CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#CANRES'>CANRES</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CANRES_1">(SOLDN,CH,SFCTMP,Q2,SFCPRS,SH2O,ZSOIL,NSOIL,      &amp;<a name='1300'>
                  SMCWLT,SMCREF,RCMIN,RC,PC,NROOT,Q2SAT,DQSDT2,      &amp;<a name='1301'>
                  TOPT,RSMAX,RGL,HS,XLAI)<a name='1302'>
<a name='1303'>
      ENDIF<a name='1304'>
<a name='1305'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1306'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1307'></font>
<font color=#447700>!      NOW DECIDE MAJOR PATHWAY BRANCH TO TAKE DEPENDING ON WHETHER<a name='1308'></font>
<font color=#447700>!      SNOWPACK EXISTS OR NOT<a name='1309'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1310'></font>
<a name='1311'>
        IF ( SNEQV .EQ. 0.0 ) THEN<a name='1312'>
<a name='1313'>
          CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC'>NOPAC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOPAC_1"> ( ETP, ETA, PRCP, SMC, SMCMAX, SMCWLT,           &amp;<a name='1314'>
                       SMCREF,SMCDRY, CMC, CMCMAX, NSOIL, DT, SHDFAC, &amp;<a name='1315'>
                       SBETA,Q1,Q2,T1,SFCTMP,T24,TH2,F,F1,S,STC,      &amp;<a name='1316'>
                       EPSCA, B, PC, RCH, RR,  CFACTR,                &amp;<a name='1317'>
                       SH2O, SLOPE, KDT, FRZX, PSISAT, ZSOIL,         &amp;<a name='1318'>
                       DKSAT, DWSAT, TBOT, ZBOT, RUNOFF1,RUNOFF2,     &amp;<a name='1319'>
                       RUNOFF3, EDIR1, EC1, ETT1,NROOT,ICE,RTDIS,     &amp;<a name='1320'>
                       QUARTZ, FXEXP,CSOIL)<a name='1321'>
<a name='1322'>
        ELSE<a name='1323'>
<a name='1324'>
	if (SH2O(1) .lt. 0) then<a name='1325'>
	write(errmess,*) 'calling SNOPAC with negative SH2O: ', SH2O(1)<a name='1326'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_56">(errmess)<a name='1327'>
	endif<a name='1328'>
<a name='1329'>
          CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOPAC'>SNOPAC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOPAC_1"> ( ETP,ETA,PRCP,PRCP1,SNOWNG,SMC,SMCMAX,SMCWLT,  &amp;<a name='1330'>
                      SMCREF, SMCDRY, CMC, CMCMAX, NSOIL, DT,         &amp;<a name='1331'>
                      SBETA,Q1,DF1,                                   &amp;<a name='1332'>
                      Q2,T1,SFCTMP,T24,TH2,F,F1,S,STC,EPSCA,SFCPRS,   &amp;<a name='1333'>
<font color=#447700>!                      B, PC, RCH, RR, CFACTR, SALP, SNEQV,           &amp;<a name='1334'></font>
                      B, PC, RCH, RR, CFACTR, SNOFAC, SNEQV,SNDENS,   &amp;<a name='1335'>
                      SNOWH, SH2O, SLOPE, KDT, FRZX, PSISAT, SNUP,    &amp;<a name='1336'>
                      ZSOIL, DWSAT, DKSAT, TBOT, ZBOT, SHDFAC,RUNOFF1,&amp;<a name='1337'>
                      RUNOFF2,RUNOFF3,EDIR1,EC1,ETT1,NROOT,SNMAX,ICE, &amp;<a name='1338'>
                      RTDIS,QUARTZ, FXEXP,CSOIL)<a name='1339'>
        <a name='1340'>
        ENDIF<a name='1341'>
<a name='1342'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1343'></font>
<font color=#447700>!   PREPARE SENSIBLE HEAT (H) FOR RETURN TO PARENT MODEL<a name='1344'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1345'></font>
<a name='1346'>
          H = -(CH * CP * SFCPRS)/(R * T2V) * ( TH2 - T1 )<a name='1347'>
          <a name='1348'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1349'></font>
<font color=#447700>!  CONVERT UNITS AND/OR SIGN OF TOTAL EVAP (ETA), POTENTIAL EVAP (ETP),<a name='1350'></font>
<font color=#447700>!  SUBSURFACE HEAT FLUX (S), AND RUNOFFS FOR WHAT PARENT MODEL EXPECTS<a name='1351'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1352'></font>
<font color=#447700>!<a name='1353'></font>
<font color=#447700>!  CONVERT ETA FROM KG M-2 S-1 TO W M-2<a name='1354'></font>
<font color=#447700>!<a name='1355'></font>
      ETA = ETA*LVH2O<a name='1356'>
      ETP = ETP*LVH2O<a name='1357'>
<a name='1358'>
<font color=#447700>! CONVERT THE SIGN OF SOIL HEAT FLUX SO THAT:<a name='1359'></font>
<font color=#447700>!         S&gt;0: WARM THE SURFACE  (NIGHT TIME)<a name='1360'></font>
<font color=#447700>!         S&lt;0: COOL THE SURFACE  (DAY TIME)<a name='1361'></font>
<font color=#447700>!      S=-1.0*S      <a name='1362'></font>
<a name='1363'>
<font color=#447700>!<a name='1364'></font>
<font color=#447700>!  CONVERT RUNOFF3 (INTERNAL LAYER RUNOFF FROM SUPERSAT) FROM M TO M S-1<a name='1365'></font>
<font color=#447700>!  AND ADD TO SUBSURFACE RUNOFF/DRAINAGE/BASEFLOW<a name='1366'></font>
<font color=#447700>!<a name='1367'></font>
      RUNOFF3 = RUNOFF3/DT<a name='1368'>
      RUNOFF2 = RUNOFF2+RUNOFF3<a name='1369'>
<font color=#447700>!<a name='1370'></font>
<font color=#447700>! TOTAL COLUMN SOIL MOISTURE IN METERS (SOILM) AND ROOT-ZONE <a name='1371'></font>
<font color=#447700>! SOIL MOISTURE AVAILABILITY (FRACTION) RELATIVE TO POROSITY/SATURATION<a name='1372'></font>
<a name='1373'>
      SOILM=-1.0*SMC(1)*ZSOIL(1)<a name='1374'>
      <a name='1375'>
      DO K = 2, NSOIL<a name='1376'>
        SOILM=SOILM+SMC(K)*(ZSOIL(K-1)-ZSOIL(K))<a name='1377'>
      END DO<a name='1378'>
      SOILWM=-1.0*(SMCMAX-SMCWLT)*ZSOIL(1)<a name='1379'>
      SOILWW=-1.0*(SMC(1)-SMCWLT)*ZSOIL(1)<a name='1380'>
      DO K = 2, NROOT<a name='1381'>
        SOILWM=SOILWM+(SMCMAX-SMCWLT)*(ZSOIL(K-1)-ZSOIL(K))<a name='1382'>
        SOILWW=SOILWW+(SMC(K)-SMCWLT)*(ZSOIL(K-1)-ZSOIL(K))<a name='1383'>
      END DO<a name='1384'>
      SOILW=SOILWW/SOILWM<a name='1385'>
<a name='1386'>
	if (SOILWM .eq. 0) then<a name='1387'>
	write(0,*) 'div zero in SFLX....SMCMAX, SMCWLT: ', SMCMAX, SMCWLT<a name='1388'>
	endif<a name='1389'>
	<a name='1390'>
	if (abs(SOILW) .lt. 3.5) then<a name='1391'>
	else<a name='1392'>
	write(0,*) 'bad SOILW in SFLX...SMCMAX, SMCWLT: ', SMCMAX, SMCWLT<a name='1393'>
	write(0,*) 'SMC: ', SMC<a name='1394'>
	endif<a name='1395'>
<font color=#447700>!<a name='1396'></font>
      END SUBROUTINE SFLX<a name='1397'>
<a name='1398'>
<A NAME='CANRES'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#CANRES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1399'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CANRES</font>(SOLAR,CH,SFCTMP,Q2,SFCPRS,SMC,ZSOIL,NSOIL,    &amp; <A href='../../call_to/CANRES.html' TARGET='index'>2</A><a name='1400'>
                        SMCWLT,SMCREF,RCMIN,RC,PC,NROOT,Q2SAT,DQSDT2, &amp;<a name='1401'>
                        TOPT,RSMAX,RGL,HS,XLAI)<a name='1402'>
<a name='1403'>
      IMPLICIT NONE<a name='1404'>
<a name='1405'>
<font color=#447700>! ######################################################################<a name='1406'></font>
<font color=#447700>!                        SUBROUTINE CANRES<a name='1407'></font>
<font color=#447700>!                        -----------------<a name='1408'></font>
<font color=#447700>!       THIS ROUTINE CALCULATES THE CANOPY RESISTANCE WHICH DEPENDS ON<a name='1409'></font>
<font color=#447700>!       INCOMING SOLAR RADIATION, AIR TEMPERATURE, ATMOSPHERIC WATER<a name='1410'></font>
<font color=#447700>!       VAPOR PRESSURE DEFICIT AT THE LOWEST MODEL LEVEL, AND SOIL<a name='1411'></font>
<font color=#447700>!       MOISTURE (PREFERABLY UNFROZEN SOIL MOISTURE RATHER THAN TOTAL)<a name='1412'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1413'></font>
<font color=#447700>!        SOURCE:  JARVIS (1976), JACQUEMIN AND NOILHAN (1990 BLM)<a name='1414'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1415'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1416'></font>
<font color=#447700>!        INPUT:  SOLAR: INCOMING SOLAR RADIATION<a name='1417'></font>
<font color=#447700>!                CH:     SURFACE EXCHANGE COEFFICIENT FOR HEAT AND MOISTURE<a name='1418'></font>
<font color=#447700>!                SFCTMP: AIR TEMPERATURE AT 1ST LEVEL ABOVE GROUND<a name='1419'></font>
<font color=#447700>!                Q2:     AIR HUMIDITY AT 1ST LEVEL ABOVE GROUND<a name='1420'></font>
<font color=#447700>!                Q2SAT:  SATURATION AIR HUMIDITY AT 1ST LEVEL ABOVE GROUND<a name='1421'></font>
<font color=#447700>!                DQSDT2: SLOPE OF SATURATION HUMIDITY FUNCTION WRT TEMP<a name='1422'></font>
<font color=#447700>!                SFCPRS: SURFACE PRESSURE<a name='1423'></font>
<font color=#447700>!                SMC:    VOLUMETRIC SOIL MOISTURE <a name='1424'></font>
<font color=#447700>!                ZSOIL:  SOIL DEPTH (NEGATIVE SIGN, AS IT IS BELOW GROUND)<a name='1425'></font>
<font color=#447700>!                NSOIL:  NO. OF SOIL LAYERS<a name='1426'></font>
<font color=#447700>!                NROOT:  NO. OF SOIL LAYERS IN ROOT ZONE (1.LE.NROOT.LE.NSOIL)<a name='1427'></font>
<font color=#447700>!                XLAI:   LEAF AREA INDEX<a name='1428'></font>
<font color=#447700>!                SMCWLT: WILTING POINT<a name='1429'></font>
<font color=#447700>!                SMCREF: REFERENCE SOIL MOISTURE<a name='1430'></font>
<font color=#447700>!                        (WHERE SOIL WATER DEFICIT STRESS SETS IN)<a name='1431'></font>
<font color=#447700>!<a name='1432'></font>
<font color=#447700>! RCMIN, RSMAX, TOPT, RGL, HS: CANOPY STRESS PARAMETERS SET IN SUBR REDPRM<a name='1433'></font>
<font color=#447700>!<a name='1434'></font>
<font color=#447700>!  (SEE EQNS 12-14 AND TABLE 2 OF SEC. 3.1.2 OF <a name='1435'></font>
<font color=#447700>!       CHEN ET AL., 1996, JGR, VOL 101(D3), 7251-7268)               <a name='1436'></font>
<font color=#447700>!<a name='1437'></font>
<font color=#447700>!        OUTPUT:  PC: PLANT COEFFICIENT<a name='1438'></font>
<font color=#447700>!                 RC: CANOPY RESISTANCE<a name='1439'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1440'></font>
<font color=#447700>! ######################################################################<a name='1441'></font>
<a name='1442'>
      INTEGER   NSOLD<a name='1443'>
      PARAMETER (NSOLD = 20)<a name='1444'>
<font color=#447700>!tst      PARAMETER (NSOLD = 4)<a name='1445'></font>
<a name='1446'>
      INTEGER K<a name='1447'>
      INTEGER NROOT<a name='1448'>
      INTEGER NSOIL<a name='1449'>
<a name='1450'>
      REAL SIGMA, RD, CP, SLV<a name='1451'>
      REAL SOLAR, CH, SFCTMP, Q2, SFCPRS <a name='1452'>
      REAL SMC(NSOIL), ZSOIL(NSOIL), PART(NSOLD) <a name='1453'>
      REAL SMCWLT, SMCREF, RCMIN, RC, PC, Q2SAT, DQSDT2<a name='1454'>
      REAL TOPT, RSMAX, RGL, HS, XLAI, RCS, RCT, RCQ, RCSOIL, FF<a name='1455'>
      REAL P, QS, GX, TAIR4, ST1, SLVCP, RR, DELTA<a name='1456'>
<a name='1457'>
      PARAMETER (SIGMA=5.67E-8, RD=287.04, CP=1004.5, SLV=2.501000E6)<a name='1458'>
<a name='1459'>
      RCS = 0.0<a name='1460'>
      RCT = 0.0<a name='1461'>
      RCQ = 0.0<a name='1462'>
      RCSOIL = 0.0<a name='1463'>
      RC = 0.0<a name='1464'>
<a name='1465'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1466'></font>
<font color=#447700>! CONTRIBUTION DUE TO INCOMING SOLAR RADIATION<a name='1467'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1468'></font>
<a name='1469'>
<font color=#447700>!C/98/01/05/..disgard old version assuming fixed LAI=1<a name='1470'></font>
<font color=#447700>!C...........FF = 0.55*2.0*SOLAR/RGL<a name='1471'></font>
<a name='1472'>
      FF = 0.55*2.0*SOLAR/(RGL*XLAI)<a name='1473'>
      RCS = (FF + RCMIN/RSMAX) / (1.0 + FF)<a name='1474'>
      RCS = MAX(RCS,0.0001)<a name='1475'>
<a name='1476'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1477'></font>
<font color=#447700>! CONTRIBUTION DUE TO AIR TEMPERATURE AT FIRST MODEL LEVEL ABOVE GROUND<a name='1478'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1479'></font>
<a name='1480'>
      RCT = 1.0 - 0.0016*((TOPT-SFCTMP)**2.0)<a name='1481'>
      RCT = MAX(RCT,0.0001)<a name='1482'>
<a name='1483'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1484'></font>
<font color=#447700>! CONTRIBUTION DUE TO VAPOR PRESSURE DEFICIT AT FIRST MODEL LEVEL.<a name='1485'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1486'></font>
<a name='1487'>
<font color=#447700>!      P = SFCPRS<a name='1488'></font>
      QS = Q2SAT<a name='1489'>
<font color=#447700>! RCQ EXPRESSION FROM SSIB <a name='1490'></font>
      RCQ = 1.0/(1.0+HS*(QS-Q2))<a name='1491'>
      RCQ = MAX(RCQ,0.01)<a name='1492'>
<a name='1493'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1494'></font>
<font color=#447700>! CONTRIBUTION DUE TO SOIL MOISTURE AVAILABILITY.<a name='1495'></font>
<font color=#447700>! DETERMINE CONTRIBUTION FROM EACH SOIL LAYER, THEN ADD THEM UP.<a name='1496'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1497'></font>
<a name='1498'>
      GX = (SMC(1) - SMCWLT) / (SMCREF - SMCWLT)<a name='1499'>
      IF (GX .GT. 1.) GX = 1.<a name='1500'>
      IF (GX .LT. 0.) GX = 0.<a name='1501'>
<a name='1502'>
<font color=#447700>!####   USING SOIL DEPTH AS WEIGHTING FACTOR<a name='1503'></font>
      PART(1) = (ZSOIL(1)/ZSOIL(NROOT)) * GX<a name='1504'>
<a name='1505'>
<font color=#447700>!#### USING ROOT DISTRIBUTION AS WEIGHTING FACTOR<a name='1506'></font>
<font color=#447700>!C      PART(1) = RTDIS(1) * GX<a name='1507'></font>
      <a name='1508'>
      DO K = 2, NROOT<a name='1509'>
        GX = (SMC(K) - SMCWLT) / (SMCREF - SMCWLT)<a name='1510'>
        IF (GX .GT. 1.) GX = 1.<a name='1511'>
        IF (GX .LT. 0.) GX = 0.<a name='1512'>
<font color=#447700>!####   USING SOIL DEPTH AS WEIGHTING FACTOR        <a name='1513'></font>
        PART(K) = ((ZSOIL(K)-ZSOIL(K-1))/ZSOIL(NROOT)) * GX<a name='1514'>
<a name='1515'>
<font color=#447700>!#### USING ROOT DISTRIBUTION AS WEIGHTING FACTOR<a name='1516'></font>
<font color=#447700>!C         PART(K) = RTDIS(K) * GX <a name='1517'></font>
               <a name='1518'>
      END DO<a name='1519'>
<a name='1520'>
      DO K = 1, NROOT<a name='1521'>
        RCSOIL = RCSOIL+PART(K)<a name='1522'>
      END DO<a name='1523'>
<a name='1524'>
      RCSOIL = MAX(RCSOIL,0.0001)<a name='1525'>
<a name='1526'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1527'></font>
<font color=#447700>!         DETERMINE CANOPY RESISTANCE DUE TO ALL FACTORS.<a name='1528'></font>
<font color=#447700>!         CONVERT CANOPY RESISTANCE (RC) TO PLANT COEFFICIENT (PC).<a name='1529'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1530'></font>
<a name='1531'>
<font color=#447700>!C/98/01/05/........RC = RCMIN/(RCS*RCT*RCQ*RCSOIL)<a name='1532'></font>
      RC = RCMIN/(XLAI*RCS*RCT*RCQ*RCSOIL)<a name='1533'>
          <a name='1534'>
      TAIR4 = SFCTMP**4.<a name='1535'>
      ST1 = (4.*SIGMA*RD)/CP<a name='1536'>
      SLVCP = SLV/CP<a name='1537'>
      RR = ST1*TAIR4/(SFCPRS*CH) + 1.0<a name='1538'>
      DELTA = SLVCP*DQSDT2<a name='1539'>
      <a name='1540'>
      PC = (RR+DELTA)/(RR*(1.+RC*CH)+DELTA)<a name='1541'>
      <a name='1542'>
      END SUBROUTINE CANRES<a name='1543'>
<a name='1544'>
<A NAME='HRT'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#HRT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1545'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HRT</font> ( RHSTS,STC,SMC,SMCMAX,NSOIL,ZSOIL,YY,ZZ1,   &amp; <A href='../../call_to/HRT.html' TARGET='index'>2</A>,<A href='../../call_from/HRT.html' TARGET='index'>16</A><a name='1546'>
                       TBOT, ZBOT, PSISAT, SH2O, DT, B,           &amp;<a name='1547'>
                       F1, DF1, QUARTZ, CSOIL)<a name='1548'>
<a name='1549'>
      IMPLICIT NONE<a name='1550'>
<a name='1551'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1552'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY<a name='1553'></font>
<font color=#447700>!C    =======   TERM OF THE SOIL THERMAL DIFFUSION EQUATION.  ALSO TO<a name='1554'></font>
<font color=#447700>!C              COMPUTE ( PREPARE ) THE MATRIX COEFFICIENTS FOR THE<a name='1555'></font>
<font color=#447700>!C              TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.<a name='1556'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1557'></font>
<a name='1558'>
      INTEGER NSOLD<a name='1559'>
      PARAMETER ( NSOLD = 20 )<a name='1560'>
<font color=#447700>!tst      PARAMETER ( NSOLD = 4 )<a name='1561'></font>
<a name='1562'>
      INTEGER I<a name='1563'>
      INTEGER K<a name='1564'>
      INTEGER NSOIL<a name='1565'>
<a name='1566'>
<font color=#447700>! DECLARE WORK ARRAYS NEEDED IN TRI-DIAGONAL IMPLICIT SOLVER<a name='1567'></font>
<a name='1568'>
      REAL AI    ( NSOLD )<a name='1569'>
      REAL BI    ( NSOLD )<a name='1570'>
      REAL CI    ( NSOLD )<a name='1571'>
<a name='1572'>
<font color=#447700>! DECLARE SPECIFIC HEAT CAPACITIES<a name='1573'></font>
<a name='1574'>
      REAL CAIR<a name='1575'>
      REAL CH2O<a name='1576'>
      REAL CICE<a name='1577'>
      REAL CSOIL<a name='1578'>
<a name='1579'>
      REAL DDZ<a name='1580'>
      REAL DDZ2<a name='1581'>
      REAL DENOM<a name='1582'>
      REAL DF1<a name='1583'>
      REAL DF1N<a name='1584'>
      REAL DF1K<a name='1585'>
      REAL DTSDZ<a name='1586'>
      REAL DTSDZ2<a name='1587'>
      REAL F1<a name='1588'>
      REAL HCPCT<a name='1589'>
      REAL QUARTZ<a name='1590'>
      REAL QTOT<a name='1591'>
      REAL RHSTS ( NSOIL )<a name='1592'>
      REAL S<a name='1593'>
      REAL SMC   ( NSOIL )<a name='1594'>
<a name='1595'>
      REAL SH2O  ( NSOIL )<a name='1596'>
      REAL SMCMAX<a name='1597'>
            <a name='1598'>
      REAL STC   ( NSOIL )<a name='1599'>
      REAL TBOT<a name='1600'>
      REAL ZBOT<a name='1601'>
      REAL YY<a name='1602'>
      REAL ZSOIL ( NSOIL )<a name='1603'>
      REAL ZZ1<a name='1604'>
<a name='1605'>
      REAL T0, TSURF, PSISAT, DT, B, SICE, TBK, TSNSR, TBK1<a name='1606'>
<a name='1607'>
      COMMON /ABCI/ AI, BI, CI<a name='1608'>
<font color=#447700>!<a name='1609'></font>
      PARAMETER ( T0   = 273.15  )<a name='1610'>
<a name='1611'>
<font color=#447700>! SET SPECIFIC HEAT CAPACITIES OF AIR, WATER, ICE, SOIL MINERAL       <a name='1612'></font>
<a name='1613'>
      PARAMETER ( CAIR =1004.0   )<a name='1614'>
      PARAMETER ( CH2O = 4.2E6   )<a name='1615'>
      PARAMETER ( CICE = 2.106E6 )<a name='1616'>
<font color=#447700>!.....PARAMETER ( CSOIL=1.26E6   )<a name='1617'></font>
<font color=#447700>!.....<a name='1618'></font>
<font color=#447700>! NOTE: CSOIL NOW SET IN ROUTINE REDPRM AND PASSED IN<a name='1619'></font>
<a name='1620'>
<font color=#447700>!+++++++++++++ BEGIN SECTION FOR TOP SOIL LAYER +++++++++++++++++++++<a name='1621'></font>
<a name='1622'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1623'></font>
<font color=#447700>!     CALC THE HEAT CAPACITY OF THE TOP SOIL LAYER<a name='1624'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1625'></font>
<a name='1626'>
      HCPCT = SH2O(1)*CH2O + (1.0-SMCMAX)*CSOIL + (SMCMAX-SMC(1))*CAIR &amp;<a name='1627'>
              + ( SMC(1) - SH2O(1) )*CICE<a name='1628'>
<a name='1629'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1630'></font>
<font color=#447700>!     CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER<a name='1631'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1632'></font>
<a name='1633'>
      DDZ = 1.0 / ( -0.5 * ZSOIL(2) )<a name='1634'>
      AI(1) = 0.0<a name='1635'>
      CI(1) =  ( DF1 * DDZ ) / ( ZSOIL(1) * HCPCT )<a name='1636'>
      BI(1) = -CI(1) + DF1 / ( 0.5 * ZSOIL(1) * ZSOIL(1)*HCPCT*ZZ1)<a name='1637'>
<a name='1638'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1639'></font>
<font color=#447700>!     CALC THE VERTICAL SOIL TEMP GRADIENT BTWN THE 1ST AND 2ND SOIL<a name='1640'></font>
<font color=#447700>!     LAYERS.  THEN CALCULATE THE SUBSURFACE HEAT FLUX. USE THE TEMP<a name='1641'></font>
<font color=#447700>!     GRADIENT AND SUBSFC HEAT FLUX TO CALC "RIGHT-HAND SIDE TENDENCY<a name='1642'></font>
<font color=#447700>!     TERMS", OR "RHSTS", FOR TOP SOIL LAYER.<a name='1643'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1644'></font>
<font color=#447700>!<a name='1645'></font>
      DTSDZ = ( STC(1) - STC(2) ) / ( -0.5 * ZSOIL(2) )<a name='1646'>
      S = DF1 * ( STC(1) - YY ) / ( 0.5 * ZSOIL(1) * ZZ1 )<a name='1647'>
      RHSTS(1) = ( DF1 * DTSDZ - S ) / ( ZSOIL(1) * HCPCT )<a name='1648'>
<a name='1649'>
	if (DT*RHSTS(1) .lt. -100.) then<a name='1650'>
	write(0,*) 'DTSDZ, ZSOIL(1), DF1, S, RHSTS(1): ',  &amp;<a name='1651'>
             DTSDZ, ZSOIL(1), DF1, S, RHSTS(1)<a name='1652'>
        endif<a name='1653'>
<a name='1654'>
<font color=#447700>! NEXT, SET TEMP "TSURF" AT TOP OF SOIL COLUMN (FOR USE IN FREEZING<a name='1655'></font>
<font color=#447700>! SOIL PHYSICS LATER IN FUNCTION SUBROUTINE SNKSRC). IF SNOWPACK <a name='1656'></font>
<font color=#447700>! CONTENT IS ZERO, THEN EXPRESSION BELOW GIVES TSURF = SKIN TEMP.<a name='1657'></font>
<font color=#447700>! IF SNOWPACK IS NONZERO (HENCE ARGUMENT ZZ1=1), THEN EXPRESSION<a name='1658'></font>
<font color=#447700>! BELOW YIELDS SOIL COLUMN TOP TEMPERATURE UNDER SNOWPACK.<a name='1659'></font>
<font color=#447700>!<a name='1660'></font>
      TSURF = ( YY + ( ZZ1 - 1 ) * STC(1) ) / ZZ1<a name='1661'>
<a name='1662'>
<font color=#447700>!<a name='1663'></font>
<font color=#447700>! NEXT CAPTURE THE VERTICAL DIFFERENCE OF THE HEAT FLUX AT TOP <a name='1664'></font>
<font color=#447700>! AND BOTTOM OF FIRST SOIL LAYER FOR USE IN HEAT FLUX CONSTRAINT <a name='1665'></font>
<font color=#447700>! APPLIED TO POTENTIAL SOIL FREEZING/THAWING IN ROUTINE SNKSRC<a name='1666'></font>
<font color=#447700>!<a name='1667'></font>
      QTOT = S - DF1*DTSDZ<a name='1668'>
<a name='1669'>
<font color=#447700>!<a name='1670'></font>
<font color=#447700>! CALCULATE TEMPERATURE AT BOTTOM INTERFACE OF 1ST SOIL LAYER <a name='1671'></font>
<font color=#447700>! FOR USE LATER IN FCN SUBROUTINE SNKSRC<a name='1672'></font>
<font color=#447700>!<a name='1673'></font>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_1"> ( STC(1), STC(2), ZSOIL, ZBOT, 1, NSOIL,TBK)<a name='1674'>
<font color=#447700>!<a name='1675'></font>
<font color=#447700>! CALCULATE FROZEN WATER CONTENT IN 1ST SOIL LAYER. <a name='1676'></font>
<font color=#447700>!<a name='1677'></font>
      SICE = SMC(1) - SH2O(1)<a name='1678'>
<font color=#447700>!<a name='1679'></font>
<font color=#447700>! IF FROZEN WATER PRESENT OR ANY OF LAYER-1 MID-POINT OR BOUNDING<a name='1680'></font>
<font color=#447700>! INTERFACE TEMPERATURES BELOW FREEZING, THEN CALL SNKSRC TO<a name='1681'></font>
<font color=#447700>! COMPUTE HEAT SOURCE/SINK (AND CHANGE IN FROZEN WATER CONTENT)<a name='1682'></font>
<font color=#447700>! DUE TO POSSIBLE SOIL WATER PHASE CHANGE<a name='1683'></font>
<font color=#447700>!<a name='1684'></font>
      IF ( (SICE .GT. 0.) .OR. (TSURF .LT. T0) .OR.            &amp;<a name='1685'>
           (STC(1) .LT. T0) .OR. (TBK .LT. T0) ) THEN<a name='1686'>
<a name='1687'>
<font color=#447700>!	write(0,*) 'call SNKSRC... ', TSURF, STC(1),TBK,SMC(1),SH2O(1)<a name='1688'></font>
 <a name='1689'>
	if (SH2O(1) .lt. 0) then<a name='1690'>
	write(0,*) 'NEGATIVE SH2O:: ', SH2O(1)<a name='1691'>
	endif<a name='1692'>
<a name='1693'>
       TSNSR = SNKSRC ( TSURF, STC(1),TBK, SMC(1), SH2O(1),    &amp;<a name='1694'>
                 ZSOIL, NSOIL, SMCMAX, PSISAT, B, DT, 1, QTOT )<a name='1695'>
	<a name='1696'>
	if (SH2O(1) .lt. 0) then<a name='1697'>
	write(0,*) 'NEGATIVE SH2O(b):: ', SH2O(1)<a name='1698'>
	write(0,*) 'return TSNSR: ', TSNSR<a name='1699'>
	endif<a name='1700'>
<a name='1701'>
       RHSTS(1) = RHSTS(1) - TSNSR / ( ZSOIL(1) * HCPCT )<a name='1702'>
<a name='1703'>
	if (DT*RHSTS(1) .lt. -100.) then<a name='1704'>
	write(0,*) 'TBK, TSNSR,  RHSTS(1): ', TBK,  TSNSR, RHSTS(1)<a name='1705'>
        endif<a name='1706'>
<a name='1707'>
      ENDIF<a name='1708'>
 <a name='1709'>
<font color=#447700>! ++++++++++++++ THIS ENDS SECTION FOR TOP SOIL LAYER ++++++++++++++<a name='1710'></font>
            <a name='1711'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1712'></font>
<font color=#447700>!     INITIALIZE DDZ2<a name='1713'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1714'></font>
<a name='1715'>
      DDZ2 = 0.0<a name='1716'>
<a name='1717'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1718'></font>
<font color=#447700>!     LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABOVE PROCESS<a name='1719'></font>
<font color=#447700>!(EXCEPT SUBSFC OR "GROUND" HEAT FLUX NOT REPEATED IN LOWER LAYERS)<a name='1720'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1721'></font>
<a name='1722'>
      DF1K = DF1<a name='1723'>
      DO K = 2, NSOIL<a name='1724'>
<a name='1725'>
<font color=#447700>!       CALC THIS SOIL LAYER'S HEAT CAPACITY<a name='1726'></font>
<a name='1727'>
        HCPCT = SH2O(K)*CH2O +(1.0-SMCMAX)*CSOIL +(SMCMAX-SMC(K))*CAIR &amp;<a name='1728'>
              + ( SMC(K) - SH2O(K) )*CICE<a name='1729'>
<font color=#447700>!<a name='1730'></font>
        IF ( K .NE. NSOIL ) THEN<a name='1731'>
<a name='1732'>
<font color=#447700>!+++++++ THIS SECTION FOR LAYER 2 OR GREATER, BUT NOT LAST LAYER +++++<a name='1733'></font>
<a name='1734'>
<font color=#447700>! CALCULATE THERMAL DIFFUSIVITY FOR THIS LAYER<a name='1735'></font>
<a name='1736'>
           CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_2"> ( DF1N, SMC(K),QUARTZ,SMCMAX,SH2O(K))<a name='1737'>
<a name='1738'>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THIS LAYER<a name='1739'></font>
<a name='1740'>
           DENOM = 0.5 * ( ZSOIL(K-1) - ZSOIL(K+1) )<a name='1741'>
           DTSDZ2 = ( STC(K) - STC(K+1) ) / DENOM<a name='1742'>
<a name='1743'>
<font color=#447700>! CALC THE MATRIX COEF, CI, AFTER CALC'NG ITS PARTIAL PRODUCT<a name='1744'></font>
<a name='1745'>
           DDZ2 = 2. / (ZSOIL(K-1) - ZSOIL(K+1))<a name='1746'>
           CI(K) = -DF1N * DDZ2 / ((ZSOIL(K-1) - ZSOIL(K)) * HCPCT)<a name='1747'>
<a name='1748'>
<font color=#447700>! CALCULATE TEMP AT BOTTOM OF LAYER<a name='1749'></font>
<a name='1750'>
           CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_2"> ( STC(K),STC(K+1),ZSOIL,ZBOT,K,NSOIL,TBK1 )<a name='1751'>
<a name='1752'>
        ELSE<a name='1753'>
<font color=#447700>!+++++++++++++ SPECIAL CASE OF BOTTOM SOIL LAYER +++++++++++++++++++++<a name='1754'></font>
<a name='1755'>
<font color=#447700>! CALCULATE THERMAL DIFFUSIVITY FOR THIS LAYER<a name='1756'></font>
<a name='1757'>
           CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_3"> ( DF1N, SMC(K),QUARTZ,SMCMAX,SH2O(K))<a name='1758'>
<a name='1759'>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THIS LAYER<a name='1760'></font>
<a name='1761'>
           DENOM = .5 * (ZSOIL(K-1) + ZSOIL(K)) - ZBOT<a name='1762'>
           DTSDZ2 = (STC(K)-TBOT) / DENOM<a name='1763'>
<a name='1764'>
<font color=#447700>!....SET MATRIX COEF, CI TO ZERO IF BOTTOM LAYER <a name='1765'></font>
<a name='1766'>
           CI(K) = 0.<a name='1767'>
<a name='1768'>
<font color=#447700>! CALCULATE TEMP AT BOTTOM OF LAST LAYER<a name='1769'></font>
<a name='1770'>
           CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_3"> ( STC(K), TBOT, ZSOIL, ZBOT, K, NSOIL,TBK1 )<a name='1771'>
<a name='1772'>
        END IF<a name='1773'>
<font color=#447700>!+++++++++++++ THIS ENDS SPECIAL CODE FOR BOTTOM LAYER +++++++++<a name='1774'></font>
<a name='1775'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1776'></font>
<font color=#447700>!       CALC RHSTS FOR THIS LAYER AFTER CALC'NG A PARTIAL PRODUCT<a name='1777'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1778'></font>
<a name='1779'>
        DENOM = ( ZSOIL(K) - ZSOIL(K-1) ) * HCPCT<a name='1780'>
        RHSTS(K) = ( DF1N * DTSDZ2 - DF1K * DTSDZ ) / DENOM<a name='1781'>
<a name='1782'>
        QTOT = -1.0*DENOM*RHSTS(K)<a name='1783'>
<a name='1784'>
        SICE = SMC(K) - SH2O(K)<a name='1785'>
<a name='1786'>
      IF ( (SICE .GT. 0.) .OR. (TBK .LT. T0) .OR.               &amp;<a name='1787'>
           (STC(K) .LT. T0) .OR. (TBK1 .LT. T0) ) THEN<a name='1788'>
<a name='1789'>
       TSNSR = SNKSRC ( TBK, STC(K),TBK1, SMC(K), SH2O(K),      &amp;<a name='1790'>
                 ZSOIL, NSOIL, SMCMAX, PSISAT, B, DT, K, QTOT)<a name='1791'>
<a name='1792'>
       RHSTS(K) = RHSTS(K) - TSNSR / DENOM<a name='1793'>
<a name='1794'>
      ENDIF <a name='1795'>
<font color=#447700>! -------------------------------------------------------------------<a name='1796'></font>
      <a name='1797'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1798'></font>
<font color=#447700>!       CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER.<a name='1799'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1800'></font>
<a name='1801'>
        AI(K) = - DF1 * DDZ / ((ZSOIL(K-1) - ZSOIL(K)) * HCPCT)<a name='1802'>
        BI(K) = -(AI(K) + CI(K))<a name='1803'>
<a name='1804'>
<font color=#447700>! RESET VALUES OF DF1, DTSDZ, DDZ, AND TBK FOR LOOP TO NEXT SOIL LYR<a name='1805'></font>
<a name='1806'>
        TBK   = TBK1<a name='1807'>
        DF1K  = DF1N<a name='1808'>
        DTSDZ = DTSDZ2<a name='1809'>
        DDZ   = DDZ2<a name='1810'>
<font color=#447700>!   <a name='1811'></font>
      END DO<a name='1812'>
<a name='1813'>
      END SUBROUTINE HRT<a name='1814'>
<a name='1815'>
<A NAME='HRTICE'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#HRTICE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1816'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HRTICE</font> (RHSTS,STC,NSOIL,ZSOIL,YY,ZZ1,DF1) <A href='../../call_to/HRTICE.html' TARGET='index'>2</A><a name='1817'>
<a name='1818'>
      IMPLICIT NONE<a name='1819'>
<a name='1820'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1821'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY<a name='1822'></font>
<font color=#447700>!C    =======   TERM OF THE SOIL THERMAL DIFFUSION EQUATION IN THE CASE<a name='1823'></font>
<font color=#447700>!C              OF SEA-ICE PACK.  ALSO TO COMPUTE ( PREPARE ) THE<a name='1824'></font>
<font color=#447700>!C              MATRIX COEFFICIENTS FOR THE TRI-DIAGONAL MATRIX OF <a name='1825'></font>
<font color=#447700>!C              THE IMPLICIT TIME SCHEME.<a name='1826'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1827'></font>
<a name='1828'>
      INTEGER NSOLD<a name='1829'>
      PARAMETER ( NSOLD = 20 )<a name='1830'>
<font color=#447700>!tst      PARAMETER ( NSOLD = 4 )<a name='1831'></font>
<a name='1832'>
      INTEGER K<a name='1833'>
      INTEGER NSOIL<a name='1834'>
<a name='1835'>
      REAL AI    ( NSOLD )<a name='1836'>
      REAL BI    ( NSOLD )<a name='1837'>
      REAL CI    ( NSOLD )<a name='1838'>
<a name='1839'>
      REAL DDZ<a name='1840'>
      REAL DDZ2<a name='1841'>
      REAL DENOM<a name='1842'>
      REAL DF1<a name='1843'>
      REAL DTSDZ<a name='1844'>
      REAL DTSDZ2<a name='1845'>
      REAL HCPCT<a name='1846'>
      REAL RHSTS ( NSOIL )<a name='1847'>
      REAL S<a name='1848'>
      REAL STC   ( NSOIL )<a name='1849'>
      REAL TBOT<a name='1850'>
      REAL YY<a name='1851'>
      REAL ZBOT<a name='1852'>
      REAL ZSOIL ( NSOIL )<a name='1853'>
      REAL ZZ1<a name='1854'>
<font color=#447700>!<a name='1855'></font>
      COMMON /ABCI/ AI, BI, CI<a name='1856'>
<a name='1857'>
<font color=#447700>! THE INPUT ARGUMENT DF1 A UNIVERSALLY CONSTANT VALUE OF<a name='1858'></font>
<font color=#447700>! SEA-ICE THERMAL DIFFUSIVITY, SET IN ROUTINE SNOPAC AS<a name='1859'></font>
<font color=#447700>!  DF1 = 2.2<a name='1860'></font>
<a name='1861'>
<font color=#447700>! SET LOWER BOUNDARY DEPTH AND BOUNDARY TEMPERATURE OF <a name='1862'></font>
<font color=#447700>! UNFROZEN SEA WATER AT BOTTOM OF SEA ICE PACK.  ASSUME <a name='1863'></font>
<font color=#447700>! ICE PACK IS OF NSOIL LAYERS SPANNING A UNIFORM CONSTANT<a name='1864'></font>
<font color=#447700>! ICE PACK THICKNESS AS DEFINED IN ROUTINE SFLX<a name='1865'></font>
<a name='1866'>
      ZBOT = ZSOIL(NSOIL)<a name='1867'>
      TBOT = 271.16<a name='1868'>
<a name='1869'>
<font color=#447700>! SET A NOMINAL UNIVERSAL VALUE OF THE SEA-ICE SPECIFIC HEAT CAPACITY<a name='1870'></font>
      <a name='1871'>
      HCPCT=1880.0*917.0<a name='1872'>
<a name='1873'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1874'></font>
<font color=#447700>!     CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER<a name='1875'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1876'></font>
<a name='1877'>
      DDZ = 1.0 / ( -0.5 * ZSOIL(2) )<a name='1878'>
      AI(1) = 0.0<a name='1879'>
      CI(1) =  ( DF1 * DDZ ) / ( ZSOIL(1) * HCPCT )<a name='1880'>
      BI(1) = -CI(1) + DF1/( 0.5 * ZSOIL(1) * ZSOIL(1) * HCPCT * ZZ1)<a name='1881'>
<a name='1882'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1883'></font>
<font color=#447700>!     CALC THE VERTICAL SOIL TEMP GRADIENT BTWN THE TOP AND 2ND SOIL<a name='1884'></font>
<font color=#447700>!     LAYERS.  RECALC/ADJUST THE SOIL HEAT FLUX.  USE THE GRADIENT<a name='1885'></font>
<font color=#447700>!     AND FLUX TO CALC RHSTS FOR THE TOP SOIL LAYER.<a name='1886'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1887'></font>
<a name='1888'>
      DTSDZ = ( STC(1) - STC(2) ) / ( -0.5 * ZSOIL(2) )<a name='1889'>
      S = DF1 * ( STC(1) - YY ) / ( 0.5 * ZSOIL(1) * ZZ1 )<a name='1890'>
      RHSTS(1) = ( DF1 * DTSDZ - S ) / ( ZSOIL(1) * HCPCT )<a name='1891'>
<a name='1892'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1893'></font>
<font color=#447700>!     INITIALIZE DDZ2<a name='1894'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1895'></font>
<a name='1896'>
      DDZ2 = 0.0<a name='1897'>
<a name='1898'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1899'></font>
<font color=#447700>!     LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABOVE PROCESS<a name='1900'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1901'></font>
<a name='1902'>
      DO K = 2, NSOIL<a name='1903'>
<a name='1904'>
        IF ( K .NE. NSOIL ) THEN<a name='1905'>
<a name='1906'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1907'></font>
<font color=#447700>!         CALC THE VERTICAL SOIL TEMP GRADIENT THRU THIS LAYER.<a name='1908'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1909'></font>
<a name='1910'>
          DENOM = 0.5 * ( ZSOIL(K-1) - ZSOIL(K+1) )<a name='1911'>
          DTSDZ2 = ( STC(K) - STC(K+1) ) / DENOM<a name='1912'>
<a name='1913'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1914'></font>
<font color=#447700>!         CALC THE MATRIX COEF, CI, AFTER CALC'NG ITS PARTIAL PRODUCT<a name='1915'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1916'></font>
<a name='1917'>
          DDZ2 = 2. / (ZSOIL(K-1) - ZSOIL(K+1))<a name='1918'>
          CI(K) = -DF1 * DDZ2 / ((ZSOIL(K-1) - ZSOIL(K)) * HCPCT)<a name='1919'>
<a name='1920'>
        ELSE<a name='1921'>
<a name='1922'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1923'></font>
<font color=#447700>!         CALC THE VERTICAL SOIL TEMP GRADIENT THRU THE LOWEST LAYER<a name='1924'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1925'></font>
<a name='1926'>
          DTSDZ2 = (STC(K)-TBOT)/(.5 * (ZSOIL(K-1) + ZSOIL(K))-ZBOT)<a name='1927'>
<a name='1928'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1929'></font>
<font color=#447700>!         SET MATRIX COEF, CI TO ZERO<a name='1930'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1931'></font>
<a name='1932'>
          CI(K) = 0.<a name='1933'>
        END IF<a name='1934'>
<a name='1935'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1936'></font>
<font color=#447700>!       CALC RHSTS FOR THIS LAYER AFTER CALC'NG A PARTIAL PRODUCT<a name='1937'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1938'></font>
<a name='1939'>
        DENOM = ( ZSOIL(K) - ZSOIL(K-1) ) * HCPCT<a name='1940'>
        RHSTS(K) = ( DF1 * DTSDZ2 - DF1 * DTSDZ ) / DENOM<a name='1941'>
<a name='1942'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1943'></font>
<font color=#447700>!       CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER.<a name='1944'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1945'></font>
<a name='1946'>
        AI(K) = - DF1 * DDZ / ((ZSOIL(K-1) - ZSOIL(K)) * HCPCT)<a name='1947'>
        BI(K) = -(AI(K) + CI(K))<a name='1948'>
<a name='1949'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1950'></font>
<font color=#447700>!       RESET VALUES OF DTSDZ AND DDZ FOR LOOP TO NEXT SOIL LYR<a name='1951'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1952'></font>
<a name='1953'>
        DTSDZ = DTSDZ2<a name='1954'>
        DDZ   = DDZ2<a name='1955'>
<a name='1956'>
      END DO<a name='1957'>
<a name='1958'>
      END SUBROUTINE HRTICE<a name='1959'>
<a name='1960'>
<A NAME='HSTEP'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#HSTEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1961'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HSTEP</font> ( STCOUT, STCIN, RHSTS, DT, NSOIL) <A href='../../call_to/HSTEP.html' TARGET='index'>4</A>,<A href='../../call_from/HSTEP.html' TARGET='index'>2</A><a name='1962'>
<a name='1963'>
      IMPLICIT NONE<a name='1964'>
<a name='1965'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1966'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE/UPDATE THE SOIL TEMPERATURE FIELD.<a name='1967'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1968'></font>
<a name='1969'>
      INTEGER NSOLD<a name='1970'>
      PARAMETER ( NSOLD = 20 )<a name='1971'>
<font color=#447700>!tst      PARAMETER ( NSOLD = 4  )<a name='1972'></font>
<a name='1973'>
      INTEGER K<a name='1974'>
      INTEGER NSOIL<a name='1975'>
<a name='1976'>
      REAL AI    ( NSOLD )<a name='1977'>
      REAL BI    ( NSOLD )<a name='1978'>
      REAL CI    ( NSOLD )<a name='1979'>
      REAL CIin  ( NSOLD )<a name='1980'>
      REAL DT<a name='1981'>
      REAL RHSTS   ( NSOIL )<a name='1982'>
      REAL RHSTSin ( NSOIL )<a name='1983'>
      REAL STCOUT  ( NSOIL )<a name='1984'>
      REAL STCIN   ( NSOIL )<a name='1985'>
     <a name='1986'>
<font color=#447700>!<a name='1987'></font>
      COMMON /ABCI/ AI, BI, CI<a name='1988'>
<a name='1989'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1990'></font>
<font color=#447700>!     CREATE FINITE DIFFERENCE VALUES FOR USE IN ROSR12 ROUTINE<a name='1991'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1992'></font>
<a name='1993'>
      DO K = 1 , NSOIL<a name='1994'>
        RHSTS(K) = RHSTS(K) * DT<a name='1995'>
        AI(K) = AI(K) * DT<a name='1996'>
        BI(K) = 1. + BI(K) * DT<a name='1997'>
        CI(K) = CI(K) * DT<a name='1998'>
      END DO<a name='1999'>
<a name='2000'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2001'></font>
<font color=#447700>!     COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12<a name='2002'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2003'></font>
      DO K = 1 , NSOIL<a name='2004'>
         RHSTSin(K) = RHSTS(K)<a name='2005'>
      END DO<a name='2006'>
      DO K = 1 , NSOLD<a name='2007'>
         CIin(K) = CI(K)<a name='2008'>
      END DO<a name='2009'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2010'></font>
<font color=#447700>!     SOLVE THE TRI-DIAGONAL MATRIX EQUATION<a name='2011'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2012'></font>
<a name='2013'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#ROSR12'>ROSR12</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HSTEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_1"> ( CI,AI,BI,CIin,RHSTSin,RHSTS,NSOIL)<a name='2014'>
<a name='2015'>
	if (RHSTS(1) .lt. -100) then<a name='2016'>
	write(0,*) 'RHSTSin was: ', RHSTSin<a name='2017'>
	write(0,*) 'RHSTS after ROSR12: ', RHSTS<a name='2018'>
	endif<a name='2019'>
<a name='2020'>
	<a name='2021'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2022'></font>
<font color=#447700>!     CALC/UPDATE THE SOIL TEMPS USING MATRIX SOLUTION<a name='2023'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2024'></font>
<a name='2025'>
      DO K = 1 , NSOIL<a name='2026'>
         STCOUT(K) = STCIN(K) + CI(K)<a name='2027'>
<font color=#447700>!<a name='2028'></font>
	if (STCOUT(K) .lt. 100 .and. STCIN(K) .gt. 230) then<a name='2029'>
	write(0,*) 'STC dropped in HSTEP: ', STCIN(K),STCOUT(K)<a name='2030'>
	endif<a name='2031'>
<a name='2032'>
      END DO<a name='2033'>
<a name='2034'>
      END SUBROUTINE HSTEP<a name='2035'>
<a name='2036'>
<A NAME='NOPAC'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#NOPAC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2037'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>NOPAC</font> ( ETP, ETA, PRCP, SMC, SMCMAX, SMCWLT,         &amp; <A href='../../call_to/NOPAC.html' TARGET='index'>2</A>,<A href='../../call_from/NOPAC.html' TARGET='index'>10</A><a name='2038'>
                         SMCREF,SMCDRY,CMC,CMCMAX, NSOIL, DT, SHDFAC, &amp;<a name='2039'>
                         SBETA,                                       &amp;<a name='2040'>
                         Q1, Q2, T1, SFCTMP, T24, TH2, F, F1, S, STC, &amp;<a name='2041'>
                         EPSCA, B, PC, RCH, RR,  CFACTR,              &amp;<a name='2042'>
                         SH2O, SLOPE, KDT, FRZFACT, PSISAT, ZSOIL,    &amp;<a name='2043'>
                         DKSAT, DWSAT, TBOT, ZBOT, RUNOFF1, RUNOFF2,  &amp;<a name='2044'>
                         RUNOFF3, EDIR1, EC1, ETT1, NROOT, ICE,RTDIS, &amp;<a name='2045'>
                         QUARTZ, FXEXP,CSOIL)<a name='2046'>
<a name='2047'>
<a name='2048'>
      IMPLICIT NONE<a name='2049'>
<a name='2050'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2051'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE SOIL MOISTURE AND HEAT FLUX VALUES AND UPDATE<a name='2052'></font>
<font color=#447700>!C    =======   SOIL MOISTURE CONTENT AND SOIL HEAT CONTENT VALUES FOR<a name='2053'></font>
<font color=#447700>!C              THE CASE WHEN NO SNOW PACK IS PRESENT.<a name='2054'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2055'></font>
<a name='2056'>
      INTEGER ICE<a name='2057'>
      INTEGER NROOT<a name='2058'>
      INTEGER NSOIL<a name='2059'>
<a name='2060'>
      REAL B<a name='2061'>
      REAL BETA<a name='2062'>
      REAL CFACTR<a name='2063'>
      REAL CMC<a name='2064'>
      REAL CMCMAX<a name='2065'>
      REAL CP<a name='2066'>
      REAL CSOIL<a name='2067'>
      REAL DEW<a name='2068'>
      REAL DF1<a name='2069'>
      REAL DKSAT<a name='2070'>
      REAL DRIP<a name='2071'>
      REAL DT<a name='2072'>
      REAL DWSAT<a name='2073'>
      REAL EC<a name='2074'>
      REAL EDIR<a name='2075'>
      REAL EPSCA<a name='2076'>
      REAL ETA<a name='2077'>
      REAL ETA1<a name='2078'>
      REAL ETP<a name='2079'>
      REAL ETP1<a name='2080'>
      REAL ETT<a name='2081'>
      REAL F<a name='2082'>
      REAL F1<a name='2083'>
      REAL FXEXP<a name='2084'>
      REAL FLX1<a name='2085'>
      REAL FLX2<a name='2086'>
      REAL FLX3<a name='2087'>
      REAL KDT<a name='2088'>
      REAL PC<a name='2089'>
      REAL PRCP<a name='2090'>
      REAL PRCP1<a name='2091'>
      REAL Q2<a name='2092'>
      REAL RCH<a name='2093'>
      REAL RIB<a name='2094'>
      REAL RR<a name='2095'>
      REAL RTDIS (NSOIL)<a name='2096'>
      REAL RUNOFF,RUNOXX3<a name='2097'>
      REAL S<a name='2098'>
      REAL SBETA<a name='2099'>
      REAL SFCTMP<a name='2100'>
      REAL SHDFAC<a name='2101'>
      REAL SIGMA<a name='2102'>
      REAL SMC   ( NSOIL )<a name='2103'>
      REAL SH2O  ( NSOIL )<a name='2104'>
      REAL SMCDRY<a name='2105'>
      REAL SMCMAX<a name='2106'>
      REAL SMCREF<a name='2107'>
      REAL SMCWLT<a name='2108'>
      REAL STC   ( NSOIL )<a name='2109'>
      REAL T1<a name='2110'>
      REAL T24<a name='2111'>
      REAL TBOT<a name='2112'>
      REAL ZBOT<a name='2113'>
      REAL TH2<a name='2114'>
      REAL YY<a name='2115'>
      REAL YYNUM<a name='2116'>
      REAL ZSOIL ( NSOIL )<a name='2117'>
      REAL ZZ1<a name='2118'>
<a name='2119'>
      REAL Q1, SLOPE, FRZFACT, PSISAT, RUNOFF1, RUNOFF2, RUNOFF3<a name='2120'>
      REAL EDIR1, EC1, ETT1, QUARTZ<a name='2121'>
<a name='2122'>
      COMMON/RITE/ BETA,DRIP,EC,EDIR,ETT,FLX1,FLX2,FLX3,RUNOFF,    &amp;<a name='2123'>
                   DEW,RIB,RUNOXX3<a name='2124'>
<a name='2125'>
      PARAMETER(CP=1004.5, SIGMA=5.67E-8)<a name='2126'>
<a name='2127'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2128'></font>
<font color=#447700>!     EXECUTABLE CODE BEGINS HERE.....<a name='2129'></font>
<font color=#447700>!     CONVERT ETP FROM KG M-2 S-1 TO MS-1 AND INITIALIZE DEW.<a name='2130'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2131'></font>
<a name='2132'>
      PRCP1 = PRCP * 0.001<a name='2133'>
      ETP1 = ETP * 0.001<a name='2134'>
      DEW = 0.0<a name='2135'>
<a name='2136'>
      IF ( ETP .GT. 0.0 ) THEN<a name='2137'>
<a name='2138'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2139'></font>
<font color=#447700>!       CONVERT PRCP FROM  KG M-2 S-1  TO  M S-1<a name='2140'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2141'></font>
<a name='2142'>
           CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX'>SMFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMFLX_1"> ( ETA1,SMC,NSOIL,CMC,ETP1,DT,PRCP1,ZSOIL,     &amp;<a name='2143'>
                SH2O, SLOPE, KDT, FRZFACT,                          &amp;<a name='2144'>
                SMCMAX,B,PC,SMCWLT,DKSAT,DWSAT,SMCREF,SHDFAC,       &amp;<a name='2145'>
                CMCMAX,SMCDRY,CFACTR, RUNOFF1,RUNOFF2, RUNOFF3,     &amp;<a name='2146'>
                EDIR1,EC1,ETT1,SFCTMP,Q2,NROOT,RTDIS,FXEXP)<a name='2147'>
<a name='2148'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2149'></font>
<font color=#447700>!       CONVERT MODELED EVAPOTRANSPIRATION FM  M S-1  TO  KG M-2 S-1<a name='2150'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2151'></font>
<a name='2152'>
        ETA = ETA1 * 1000.0<a name='2153'>
<a name='2154'>
      ELSE<a name='2155'>
<a name='2156'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2157'></font>
<font color=#447700>!       IF ETP &lt; 0, ASSUME DEW FORMS (TRANSFORM ETP1 INTO DEW<a name='2158'></font>
<font color=#447700>!       AND REINITIALIZE ETP1 TO ZERO)<a name='2159'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2160'></font>
<a name='2161'>
        DEW = -ETP1<a name='2162'>
        ETP1 = 0.0<a name='2163'>
<a name='2164'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2165'></font>
<font color=#447700>!       CONVERT PRCP FROM  KG M-2 S-1  TO  M S-1  AND ADD DEW AMT<a name='2166'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2167'></font>
<a name='2168'>
        PRCP1 = PRCP1 + DEW<a name='2169'>
<font color=#447700>!<a name='2170'></font>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX'>SMFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMFLX_2"> ( ETA1,SMC,NSOIL,CMC,ETP1,DT,PRCP1,ZSOIL,          &amp;<a name='2171'>
                SH2O, SLOPE, KDT, FRZFACT,                          &amp;<a name='2172'>
                SMCMAX,B,PC,SMCWLT,DKSAT,DWSAT,SMCREF,SHDFAC,       &amp;<a name='2173'>
                CMCMAX,SMCDRY,CFACTR, RUNOFF1,RUNOFF2, RUNOFF3,     &amp;<a name='2174'>
                EDIR1,EC1,ETT1,SFCTMP,Q2,NROOT,RTDIS,FXEXP)<a name='2175'>
<a name='2176'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2177'></font>
<font color=#447700>!       CONVERT MODELED EVAPOTRANSPIRATION FM  M S-1  TO  KG M-2 S-1<a name='2178'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2179'></font>
<a name='2180'>
        ETA = ETA1 * 1000.0<a name='2181'>
<a name='2182'>
      ENDIF<a name='2183'>
<a name='2184'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2185'></font>
<font color=#447700>!     BASED ON ETP AND E VALUES, DETERMINE BETA<a name='2186'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2187'></font>
<a name='2188'>
      IF ( ETP .LE. 0.0 ) THEN<a name='2189'>
        BETA = 0.0<a name='2190'>
        IF ( ETP .LT. 0.0 ) THEN<a name='2191'>
          BETA = 1.0<a name='2192'>
          ETA = ETP<a name='2193'>
        ENDIF<a name='2194'>
      ELSE<a name='2195'>
        BETA = ETA / ETP<a name='2196'>
      ENDIF<a name='2197'>
<a name='2198'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2199'></font>
<font color=#447700>!    GET SOIL THERMAL DIFFUXIVITY/CONDUCTIVITY FOR TOP SOIL LYR,<a name='2200'></font>
<font color=#447700>!    CALC. ADJUSTED TOP LYR SOIL TEMP AND ADJUSTED SOIL FLUX, THEN<a name='2201'></font>
<font color=#447700>!    CALL SHFLX TO COMPUTE/UPDATE SOIL HEAT FLUX AND SOIL TEMPS.<a name='2202'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2203'></font>
<a name='2204'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_4"> ( DF1, SMC(1),QUARTZ,SMCMAX,SH2O(1))<a name='2205'>
<a name='2206'>
<font color=#447700>! VEGETATION GREENNESS FRACTION REDUCTION IN SUBSURFACE HEAT FLUX <a name='2207'></font>
<font color=#447700>! VIA REDUCTION FACTOR, WHICH IS CONVENIENT TO APPLY HERE TO THERMAL <a name='2208'></font>
<font color=#447700>! DIFFUSIVITY THAT IS LATER USED IN HRT TO COMPUTE SUB SFC HEAT FLUX<a name='2209'></font>
<font color=#447700>! (SEE ADDITIONAL COMMENTS ON VEG EFFECT SUB-SFC HEAT FLX IN <a name='2210'></font>
<font color=#447700>!  ROUTINE SFLX)<a name='2211'></font>
<a name='2212'>
      DF1 = DF1 * EXP(SBETA*SHDFAC)<a name='2213'>
<a name='2214'>
<font color=#447700>! COMPUTE INTERMEDIATE TERMS PASSED TO ROUTINE HRT (VIA ROUTINE <a name='2215'></font>
<font color=#447700>! SHFLX BELOW) FOR USE IN COMPUTING SUBSURFACE HEAT FLUX IN HRT<a name='2216'></font>
<a name='2217'>
      YYNUM = F - SIGMA * T24<a name='2218'>
      YY = SFCTMP + (YYNUM/RCH+TH2-SFCTMP-BETA*EPSCA) / RR<a name='2219'>
      ZZ1 = DF1 / ( -0.5 * ZSOIL(1) * RCH * RR ) + 1.0<a name='2220'>
<a name='2221'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX'>SHFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHFLX_1"> ( S,STC,SMC,SMCMAX,NSOIL,T1,DT,YY,ZZ1,ZSOIL,TBOT,  &amp;<a name='2222'>
                   ZBOT, SMCWLT, PSISAT, SH2O,                      &amp;<a name='2223'>
                   B,F1,DF1, ICE,                                   &amp;<a name='2224'>
                   QUARTZ,CSOIL)<a name='2225'>
<a name='2226'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2227'></font>
<font color=#447700>!     SET FLX1, AND FLX3 TO ZERO SINCE THEY ARE NOT USED.  FLX2<a name='2228'></font>
<font color=#447700>!     WAS SIMILARLY INITIALIZED IN THE PENMAN ROUTINE.<a name='2229'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2230'></font>
<a name='2231'>
      FLX1 = 0.0<a name='2232'>
      FLX3 = 0.0<a name='2233'>
<font color=#447700>!<a name='2234'></font>
      END SUBROUTINE NOPAC<a name='2235'>
<a name='2236'>
<A NAME='PENMAN'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#PENMAN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2237'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>PENMAN</font>(SFCTMP,SFCPRS,CH,T2V,TH2,PRCP,F,T24,S,Q2,    &amp; <A href='../../call_to/PENMAN.html' TARGET='index'>2</A><a name='2238'>
                        Q2SAT,ETP,RCH,EPSCA,RR,SNOWNG,FRZGRA,DQSDT2)<a name='2239'>
<a name='2240'>
      IMPLICIT NONE<a name='2241'>
<a name='2242'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2243'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE POTENTIAL EVAPORATION FOR THE CURRENT POINT.<a name='2244'></font>
<font color=#447700>!C    =======   VARIOUS PARTIAL SUMS/PRODUCTS ARE ALSO CALCULATED AND<a name='2245'></font>
<font color=#447700>!C              PASSED BACK TO THE CALLING ROUTINE FOR LATER USE.<a name='2246'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2247'></font>
<a name='2248'>
      LOGICAL SNOWNG<a name='2249'>
      LOGICAL FRZGRA<a name='2250'>
<a name='2251'>
      REAL A<a name='2252'>
      REAL BETA<a name='2253'>
      REAL CH<a name='2254'>
      REAL CP<a name='2255'>
      REAL CPH2O<a name='2256'>
      REAL CPICE<a name='2257'>
      REAL DELTA<a name='2258'>
      REAL DEW<a name='2259'>
      REAL DRIP<a name='2260'>
      REAL EC<a name='2261'>
      REAL EDIR<a name='2262'>
      REAL ELCP<a name='2263'>
      REAL EPSCA<a name='2264'>
      REAL ETP<a name='2265'>
      REAL ETT<a name='2266'>
      REAL F<a name='2267'>
      REAL FLX1<a name='2268'>
      REAL FLX2<a name='2269'>
      REAL FLX3<a name='2270'>
      REAL FNET<a name='2271'>
      REAL LSUBC<a name='2272'>
      REAL LSUBF<a name='2273'>
      REAL PRCP<a name='2274'>
      REAL Q2<a name='2275'>
      REAL Q2SAT<a name='2276'>
      REAL R<a name='2277'>
      REAL RAD<a name='2278'>
      REAL RCH<a name='2279'>
      REAL RHO<a name='2280'>
      REAL RIB<a name='2281'>
      REAL RR<a name='2282'>
      REAL RUNOFF,RUNOXX3<a name='2283'>
      REAL S<a name='2284'>
      REAL SFCPRS<a name='2285'>
      REAL SFCTMP<a name='2286'>
      REAL SIGMA<a name='2287'>
      REAL T24<a name='2288'>
      REAL T2V<a name='2289'>
      REAL TH2<a name='2290'>
      REAL DQSDT2<a name='2291'>
<a name='2292'>
      COMMON/RITE/ BETA,DRIP,EC,EDIR,ETT,FLX1,FLX2,FLX3,RUNOFF,      &amp;<a name='2293'>
                   DEW,RIB,RUNOXX3<a name='2294'>
<a name='2295'>
      PARAMETER(CP=1004.6,CPH2O=4.218E+3,CPICE=2.106E+3,R=287.04,    &amp;<a name='2296'>
         ELCP=2.4888E+3,LSUBF=3.335E+5,LSUBC=2.501000E+6,SIGMA=5.67E-8)<a name='2297'>
<a name='2298'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2299'></font>
<font color=#447700>!     EXECUTABLE CODE BEGINS HERE...<a name='2300'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2301'></font>
<a name='2302'>
      FLX2 = 0.0<a name='2303'>
<a name='2304'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2305'></font>
<font color=#447700>!     PREPARE PARTIAL QUANTITIES FOR PENMAN EQUATION.<a name='2306'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2307'></font>
<a name='2308'>
      DELTA = ELCP * DQSDT2<a name='2309'>
      T24 = SFCTMP * SFCTMP * SFCTMP * SFCTMP<a name='2310'>
      RR = T24 * 6.48E-8 / ( SFCPRS * CH ) + 1.0<a name='2311'>
      RHO = SFCPRS / ( R * T2V )<a name='2312'>
      RCH = RHO * CP * CH<a name='2313'>
<a name='2314'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2315'></font>
<font color=#447700>!     ADJUST THE PARTIAL SUMS / PRODUCTS WITH THE LATENT HEAT<a name='2316'></font>
<font color=#447700>!     EFFECTS CAUSED BY FALLING PRECIPITATION.<a name='2317'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2318'></font>
<a name='2319'>
      IF ( .NOT. SNOWNG ) THEN<a name='2320'>
        IF ( PRCP .GT. 0.0 ) RR = RR + CPH2O * PRCP / RCH<a name='2321'>
      ELSE<a name='2322'>
        RR = RR + CPICE * PRCP / RCH<a name='2323'>
      ENDIF<a name='2324'>
<a name='2325'>
      FNET = F - SIGMA * T24 - S<a name='2326'>
<a name='2327'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2328'></font>
<font color=#447700>!     INCLUDE THE LATENT HEAT EFFECTS OF FRZNG RAIN CONVERTING TO<a name='2329'></font>
<font color=#447700>!     ICE ON IMPACT IN THE CALCULATION OF FLX2 AND FNET.<a name='2330'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2331'></font>
<a name='2332'>
      IF ( FRZGRA ) THEN<a name='2333'>
        FLX2 = -LSUBF * PRCP<a name='2334'>
        FNET = FNET - FLX2<a name='2335'>
      ENDIF<a name='2336'>
<a name='2337'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2338'></font>
<font color=#447700>!     FINISH PENMAN EQUATION CALCULATIONS.<a name='2339'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2340'></font>
<a name='2341'>
      RAD = FNET / RCH + TH2 - SFCTMP<a name='2342'>
      A = ELCP * ( Q2SAT - Q2 )<a name='2343'>
      EPSCA = ( A * RR + RAD * DELTA ) / ( DELTA + RR )<a name='2344'>
      ETP = EPSCA * RCH / LSUBC<a name='2345'>
<a name='2346'>
      END SUBROUTINE PENMAN<a name='2347'>
<a name='2348'>
<A NAME='REDPRM'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#REDPRM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2349'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>REDPRM</font>(VEGTYP, SOILTYP, SLOPETYP,              &amp; <A href='../../call_to/REDPRM.html' TARGET='index'>2</A>,<A href='../../call_from/REDPRM.html' TARGET='index'>11</A><a name='2350'>
           CFACTR, CMCMAX, RSMAX, TOPT, REFKDT, KDT, SBETA,     &amp;<a name='2351'>
           SHDFAC, RCMIN, RGL, HS, ZBOT, FRZX, PSISAT, SLOPE,   &amp;<a name='2352'>
           SNUP, SALP, B, DKSAT, DWSAT, SMCMAX, SMCWLT, SMCREF, &amp;<a name='2353'>
           SMCDRY, F1, QUARTZ, FXEXP, RTDIS, SLDPTH, ZSOIL,     &amp;<a name='2354'>
           NROOT, NSOIL, Z0, CZIL, LAI, CSOIL, PTU)<a name='2355'>
<a name='2356'>
<a name='2357'>
      IMPLICIT NONE<a name='2358'>
<a name='2359'>
<font color=#447700>!  This subroutine internally sets (defaults), or optionally reads-in<a name='2360'></font>
<font color=#447700>!  via namelist I/O, all the soil and vegetation parameters<a name='2361'></font>
<font color=#447700>!  required for the execusion of the NOAH - LSM<a name='2362'></font>
<font color=#447700>! <a name='2363'></font>
<font color=#447700>! optional non-default parameters can be read in, accommodating up<a name='2364'></font>
<font color=#447700>!  to 30 soil, veg, or slope classes, if the default max number of <a name='2365'></font>
<font color=#447700>!  soil, veg, and/or slope types is reset.<a name='2366'></font>
<a name='2367'>
<font color=#447700>! future upgrades of routine REDPRM must expand to incorporate some<a name='2368'></font>
<font color=#447700>! of the empirical parameters of the frozen soil and snowpack physics<a name='2369'></font>
<font color=#447700>! (such as in routines FRH2O, SNOWPACK, and SNOW_NEW) not yet set in <a name='2370'></font>
<font color=#447700>!  this REDPRM routine, but rather set in lower level subroutines<a name='2371'></font>
<a name='2372'>
<font color=#447700>!  Set maximum number of soil-, veg-, and slopetyp in data statement<a name='2373'></font>
<a name='2374'>
      INTEGER MAX_SOILTYP<a name='2375'>
      INTEGER MAX_VEGTYP<a name='2376'>
      INTEGER MAX_SLOPETYP<a name='2377'>
      PARAMETER (MAX_SOILTYP  = 30)<a name='2378'>
      PARAMETER (MAX_VEGTYP   = 30)<a name='2379'>
      PARAMETER (MAX_SLOPETYP = 30)<a name='2380'>
<a name='2381'>
<font color=#447700>!  Number of defined soil-, veg-, and slopetyps used<a name='2382'></font>
<a name='2383'>
      INTEGER DEFINED_VEG<a name='2384'>
      INTEGER DEFINED_SOIL<a name='2385'>
      INTEGER DEFINED_SLOPE<a name='2386'>
      DATA DEFINED_VEG/13/<a name='2387'>
      DATA DEFINED_SOIL/9/<a name='2388'>
      DATA DEFINED_SLOPE/9/<a name='2389'>
<a name='2390'>
<font color=#447700>!  SET-UP SOIL PARAMETERS FOR GIVEN SOIL TYPE<a name='2391'></font>
<font color=#447700>!  INPUT: SOLTYP: SOIL TYPE (INTEGER INDEX)<a name='2392'></font>
<font color=#447700>!  OUTPUT: SOIL PARAMETERS:<a name='2393'></font>
<a name='2394'>
<font color=#447700>!    MAXSMC: MAX SOIL MOISTURE CONTENT (POROSITY)<a name='2395'></font>
<font color=#447700>!    REFSMC: REFERENCE SOIL MOISTURE (ONSET OF SOIL MOISTURE<a name='2396'></font>
<font color=#447700>!            STRESS IN TRANSPIRATION)<a name='2397'></font>
<font color=#447700>!    WLTSMC: WILTING PT SOIL MOISTURE CONTENTS<a name='2398'></font>
<font color=#447700>!    DRYSMC: AIR DRY SOIL MOIST CONTENT LIMITS<a name='2399'></font>
<font color=#447700>!    SATPSI: SATURATED SOIL POTENTIAL<a name='2400'></font>
<font color=#447700>!    SATDK:  SATURATED SOIL HYDRAULIC CONDUCTIVITY<a name='2401'></font>
<font color=#447700>!    BB:     THE 'B' PARAMETER<a name='2402'></font>
<font color=#447700>!    SATDW:  SATURATED SOIL DIFFUSIVITY<a name='2403'></font>
<font color=#447700>!    F11:    USED TO COMPUTE SOIL DIFFUSIVITY/CONDUCTIVITY<a name='2404'></font>
<font color=#447700>!    QUARTZ:  SOIL QUARTZ CONTENT<a name='2405'></font>
<font color=#447700>!<a name='2406'></font>
<font color=#447700>! SOIL TYPES   ZOBLER (1986)      COSBY ET AL (1984) (quartz cont.(1))<a name='2407'></font>
<font color=#447700>!  1        COARSE            LOAMY SAND         (0.82)<a name='2408'></font>
<font color=#447700>!  2        MEDIUM            SILTY CLAY LOAM    (0.10)<a name='2409'></font>
<font color=#447700>!  3        FINE              LIGHT CLAY         (0.25)<a name='2410'></font>
<font color=#447700>!  4        COARSE-MEDIUM     SANDY LOAM         (0.60)<a name='2411'></font>
<font color=#447700>!  5        COARSE-FINE       SANDY CLAY         (0.52)<a name='2412'></font>
<font color=#447700>!  6        MEDIUM-FINE       CLAY LOAM          (0.35)<a name='2413'></font>
<font color=#447700>!  7        COARSE-MED-FINE   SANDY CLAY LOAM    (0.60)<a name='2414'></font>
<font color=#447700>!  8        ORGANIC           LOAM               (0.40)<a name='2415'></font>
<font color=#447700>!  9        GLACIAL LAND ICE  LOAMY SAND         (NA using 0.82)<a name='2416'></font>
<a name='2417'>
      REAL BB(MAX_SOILTYP)<a name='2418'>
      REAL DRYSMC(MAX_SOILTYP)<a name='2419'>
      REAL F11(MAX_SOILTYP)<a name='2420'>
      REAL MAXSMC(MAX_SOILTYP)<a name='2421'>
      REAL REFSMC(MAX_SOILTYP)<a name='2422'>
      REAL SATPSI(MAX_SOILTYP)<a name='2423'>
      REAL SATDK(MAX_SOILTYP)<a name='2424'>
      REAL SATDW(MAX_SOILTYP)<a name='2425'>
      REAL WLTSMC(MAX_SOILTYP)<a name='2426'>
      REAL QTZ(MAX_SOILTYP)<a name='2427'>
<a name='2428'>
      REAL B<a name='2429'>
      REAL DKSAT<a name='2430'>
      REAL DWSAT<a name='2431'>
      REAL SMCMAX<a name='2432'>
      REAL SMCWLT<a name='2433'>
      REAL SMCREF<a name='2434'>
      REAL SMCDRY<a name='2435'>
      REAL PTU<a name='2436'>
      REAL F1<a name='2437'>
      REAL QUARTZ<a name='2438'>
      REAL REFSMC1<a name='2439'>
      REAL WLTSMC1<a name='2440'>
<a name='2441'>
      DATA MAXSMC/0.421, 0.464, 0.468, 0.434, 0.406, 0.465,  &amp;<a name='2442'>
                  0.404, 0.439, 0.421, 0.000, 0.000, 0.000,  &amp;<a name='2443'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,  &amp;<a name='2444'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,  &amp;<a name='2445'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='2446'>
      DATA SATPSI/0.04, 0.62, 0.47, 0.14, 0.10, 0.26,        &amp;<a name='2447'>
                  0.14, 0.36, 0.04, 0.00, 0.00, 0.00,        &amp;<a name='2448'>
                  0.00, 0.00, 0.00, 0.00, 0.00, 0.00,        &amp;<a name='2449'>
                  0.00, 0.00, 0.00, 0.00, 0.00, 0.00,        &amp;<a name='2450'>
                  0.00, 0.00, 0.00, 0.00, 0.00, 0.00/<a name='2451'>
      DATA SATDK /1.41E-5, 0.20E-5, 0.10E-5, 0.52E-5, 0.72E-5, &amp;<a name='2452'>
                  0.25E-5, 0.45E-5, 0.34E-5, 1.41E-5, 0.00,    &amp;<a name='2453'>
                  0.00   , 0.00   , 0.00   , 0.00   , 0.00,    &amp;<a name='2454'>
                  0.00   , 0.00   , 0.00   , 0.00   , 0.00,    &amp;<a name='2455'>
                  0.00   , 0.00   , 0.00   , 0.00   , 0.00,    &amp;<a name='2456'>
                  0.00   , 0.00   , 0.00   , 0.00   , 0.00/<a name='2457'>
      DATA BB    /4.26,  8.72, 11.55, 4.74, 10.73,  8.17,    &amp; <a name='2458'>
                  6.77,  5.25,  4.26, 0.00,  0.00,  0.00,    &amp;<a name='2459'>
                  0.00,  0.00,  0.00, 0.00,  0.00,  0.00,    &amp;<a name='2460'>
                  0.00,  0.00,  0.00, 0.00,  0.00,  0.00,    &amp;<a name='2461'>
                  0.00,  0.00,  0.00, 0.00,  0.00,  0.00/<a name='2462'>
      DATA QTZ   /0.82, 0.10, 0.25, 0.60, 0.52, 0.35,        &amp;<a name='2463'>
                  0.60, 0.40, 0.82, 0.00, 0.00, 0.00,        &amp;<a name='2464'>
                  0.00, 0.00, 0.00, 0.00, 0.00, 0.00,        &amp;<a name='2465'>
                  0.00, 0.00, 0.00, 0.00, 0.00, 0.00,        &amp;<a name='2466'>
                  0.00, 0.00, 0.00, 0.00, 0.00, 0.00/<a name='2467'>
<a name='2468'>
<font color=#447700>! The following 5 parameters are derived later in REDPRM.f <a name='2469'></font>
<font color=#447700>! from the soil data, and are just given here for reference <a name='2470'></font>
<font color=#447700>! and to force static storage allocation<a name='2471'></font>
<font color=#447700>! Dag Lohmann, Feb. 2001<a name='2472'></font>
<a name='2473'>
      DATA REFSMC/0.283, 0.387, 0.412, 0.312, 0.338, 0.382,     &amp;<a name='2474'>
                  0.315, 0.329, 0.283, 0.000, 0.000, 0.000,     &amp;<a name='2475'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,     &amp;<a name='2476'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,     &amp;<a name='2477'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000/   <a name='2478'>
      DATA WLTSMC/0.029, 0.119, 0.139, 0.047, 0.100, 0.103,     &amp;<a name='2479'>
                  0.069, 0.066, 0.029, 0.000, 0.000, 0.000,     &amp;<a name='2480'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,     &amp;<a name='2481'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,     &amp;<a name='2482'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='2483'>
      DATA DRYSMC/0.029, 0.119, 0.139, 0.047, 0.100, 0.103,     &amp;<a name='2484'>
                  0.069, 0.066, 0.029, 0.000, 0.000, 0.000,     &amp;<a name='2485'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,     &amp;<a name='2486'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,     &amp;<a name='2487'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='2488'>
      DATA SATDW /5.71E-6, 2.33E-5, 1.16E-5, 7.95E-6, 1.90E-5,  &amp;<a name='2489'>
                  1.14E-5, 1.06E-5, 1.46E-5, 5.71E-6, 0.00,     &amp;<a name='2490'>
                  0.00   , 0.00   , 0.00   , 0.00   , 0.00,     &amp;<a name='2491'>
                  0.00   , 0.00   , 0.00   , 0.00   , 0.00,     &amp;<a name='2492'>
                  0.00   , 0.00   , 0.00   , 0.00   , 0.00,     &amp;<a name='2493'>
                  0.00   , 0.00   , 0.00   , 0.00   , 0.00/<a name='2494'>
      DATA F11  /-0.999, -1.116, -2.137, -0.572, -3.201, -1.302, &amp;<a name='2495'>
                 -1.519, -0.329, -0.999,  0.000,  0.000,  0.000, &amp;<a name='2496'>
                  0.000,  0.000,  0.000,  0.000,  0.000,  0.000, &amp;<a name='2497'>
                  0.000,  0.000,  0.000,  0.000,  0.000,  0.000, &amp;<a name='2498'>
                  0.000,  0.000,  0.000,  0.000,  0.000,  0.000/<a name='2499'>
<a name='2500'>
<font color=#447700>!#######################################################################<a name='2501'></font>
<a name='2502'>
<font color=#447700>!  SET-UP VEGETATION PARAMETERS FOR A GIVEN VEGETAION TYPE<a name='2503'></font>
<font color=#447700>!<a name='2504'></font>
<font color=#447700>!  INPUT: VEGTYP = VEGETATION TYPE (INTEGER INDEX)<a name='2505'></font>
<font color=#447700>!  OUPUT: VEGETATION PARAMETERS<a name='2506'></font>
<font color=#447700>!         SHDFAC: VEGETATION GREENNESS FRACTION<a name='2507'></font>
<font color=#447700>!         RCMIN:  MIMIMUM STOMATAL RESISTANCE<a name='2508'></font>
<font color=#447700>!         RGL:    PARAMETER USED IN SOLAR RAD TERM OF<a name='2509'></font>
<font color=#447700>!                 CANOPY RESISTANCE FUNCTION<a name='2510'></font>
<font color=#447700>!         HS:     PARAMETER USED IN VAPOR PRESSURE DEFICIT TERM OF<a name='2511'></font>
<font color=#447700>!                 CANOPY RESISTANCE FUNCTION<a name='2512'></font>
<font color=#447700>!         SNUP:   THRESHOLD SNOW DEPTH (IN WATER EQUIVALENT M) THAT<a name='2513'></font>
<font color=#447700>!                 IMPLIES 100% SNOW COVER<a name='2514'></font>
<font color=#447700>!<a name='2515'></font>
<font color=#447700>!  SSIB VEGETATION TYPES (DORMAN AND SELLERS, 1989; JAM)<a name='2516'></font>
<font color=#447700>!<a name='2517'></font>
<font color=#447700>!   1:   BROADLEAF-EVERGREEN TREES  (TROPICAL FOREST)<a name='2518'></font>
<font color=#447700>!   2:   BROADLEAF-DECIDUOUS TREES<a name='2519'></font>
<font color=#447700>!   3:   BROADLEAF AND NEEDLELEAF TREES (MIXED FOREST)<a name='2520'></font>
<font color=#447700>!   4:   NEEDLELEAF-EVERGREEN TREES<a name='2521'></font>
<font color=#447700>!   5:   NEEDLELEAF-DECIDUOUS TREES (LARCH)<a name='2522'></font>
<font color=#447700>!   6:   BROADLEAF TREES WITH GROUNDCOVER (SAVANNA)<a name='2523'></font>
<font color=#447700>!   7:   GROUNDCOVER ONLY (PERENNIAL)<a name='2524'></font>
<font color=#447700>!   8:   BROADLEAF SHRUBS WITH PERENNIAL GROUNDCOVER<a name='2525'></font>
<font color=#447700>!   9:   BROADLEAF SHRUBS WITH BARE SOIL<a name='2526'></font>
<font color=#447700>!  10:   DWARF TREES AND SHRUBS WITH GROUNDCOVER (TUNDRA)<a name='2527'></font>
<font color=#447700>!  11:   BARE SOIL<a name='2528'></font>
<font color=#447700>!  12:   CULTIVATIONS (THE SAME PARAMETERS AS FOR TYPE 7)<a name='2529'></font>
<font color=#447700>!  13:   GLACIAL (THE SAME PARAMETERS AS FOR TYPE 11)<a name='2530'></font>
<a name='2531'>
      INTEGER NROOT_DATA(MAX_VEGTYP)<a name='2532'>
      REAL    RSMTBL(MAX_VEGTYP)<a name='2533'>
      REAL    RGLTBL(MAX_VEGTYP)<a name='2534'>
      REAL    HSTBL(MAX_VEGTYP)<a name='2535'>
      REAL    SNUPX(MAX_VEGTYP)<a name='2536'>
      REAL    Z0_DATA(MAX_VEGTYP)<a name='2537'>
      REAL    LAI_DATA(MAX_VEGTYP)<a name='2538'>
<a name='2539'>
      INTEGER NROOT<a name='2540'>
      REAL    SHDFAC<a name='2541'>
      REAL    RCMIN<a name='2542'>
      REAL    RGL<a name='2543'>
      REAL    HS<a name='2544'>
      REAL    FRZFACT<a name='2545'>
      REAL    PSISAT<a name='2546'>
      REAL    SNUP<a name='2547'>
      REAL    Z0<a name='2548'>
      REAL    LAI<a name='2549'>
<a name='2550'>
      DATA NROOT_DATA /4,4,4,4,4,4,3,3,3,2,3,3,2,0,0,       &amp;<a name='2551'>
                       0,0,0,0,0,0,0,0,0,0,0,0,0,0,0/<a name='2552'>
      DATA RSMTBL /150.0, 100.0, 125.0, 150.0, 100.0, 70.0, &amp;<a name='2553'>
                    40.0, 300.0, 400.0, 150.0, 400.0, 40.0, &amp;<a name='2554'>
                   150.0,   0.0,   0.0,   0.0,   0.0,  0.0, &amp;<a name='2555'>
                     0.0,   0.0,   0.0,   0.0,   0.0,  0.0, &amp;<a name='2556'>
                     0.0,   0.0,   0.0,   0.0,   0.0,  0.0/<a name='2557'>
      DATA RGLTBL /30.0,  30.0,  30.0,  30.0,  30.0,  65.0, &amp;<a name='2558'>
                  100.0, 100.0, 100.0, 100.0, 100.0, 100.0, &amp;<a name='2559'>
                  100.0,   0.0,   0.0,   0.0,   0.0,   0.0, &amp;<a name='2560'>
                    0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &amp;<a name='2561'>
                    0.0,   0.0,   0.0,   0.0,   0.0,   0.0/<a name='2562'>
      DATA HSTBL /41.69, 54.53, 51.93, 47.35,  47.35, 54.53, &amp;<a name='2563'>
                  36.35, 42.00, 42.00, 42.00,  42.00, 36.35, &amp;<a name='2564'>
                  42.00,  0.00,  0.00,  0.00,   0.00,  0.00, &amp;<a name='2565'>
                   0.00,  0.00,  0.00,  0.00,   0.00,  0.00, &amp;<a name='2566'>
                   0.00,  0.00,  0.00,  0.00,   0.00,  0.00/<a name='2567'>
      DATA SNUPX  /0.080, 0.080, 0.080, 0.080, 0.080, 0.080, &amp;<a name='2568'>
                   0.040, 0.040, 0.040, 0.040, 0.025, 0.040, &amp;<a name='2569'>
                   0.025, 0.000, 0.000, 0.000, 0.000, 0.000, &amp;<a name='2570'>
                   0.000, 0.000, 0.000, 0.000, 0.000, 0.000, &amp;<a name='2571'>
                   0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='2572'>
      DATA Z0_DATA /2.653, 0.826, 0.563, 1.089, 0.854, 0.856, &amp;<a name='2573'>
                    0.035, 0.238, 0.065, 0.076, 0.011, 0.035, &amp;<a name='2574'>
                    0.011, 0.000, 0.000, 0.000, 0.000, 0.000, &amp;<a name='2575'>
                    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, &amp;<a name='2576'>
                    0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='2577'>
<font color=#447700>!      DATA LAI_DATA /3.0, 3.0, 3.0, 3.0, 3.0, 3.0,<a name='2578'></font>
<font color=#447700>!     *               3.0, 3.0, 3.0, 3.0, 3.0, 3.0,<a name='2579'></font>
<font color=#447700>!     *               3.0, 0.0, 0.0, 0.0, 0.0, 0.0,<a name='2580'></font>
<font color=#447700>!     *               0.0, 0.0, 0.0, 0.0, 0.0, 0.0,<a name='2581'></font>
<font color=#447700>!     *               0.0, 0.0, 0.0, 0.0, 0.0, 0.0/<a name='2582'></font>
      DATA LAI_DATA /4.0, 4.0, 4.0, 4.0, 4.0, 4.0,  &amp;<a name='2583'>
                     4.0, 4.0, 4.0, 4.0, 4.0, 4.0,  &amp;<a name='2584'>
                     4.0, 0.0, 0.0, 0.0, 0.0, 0.0,  &amp;<a name='2585'>
                     0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  &amp;<a name='2586'>
                     0.0, 0.0, 0.0, 0.0, 0.0, 0.0/<a name='2587'>
<a name='2588'>
<font color=#447700>!#######################################################################<a name='2589'></font>
<a name='2590'>
<font color=#447700>!  CLASS PARAMETER 'SLOPETYP' WAS INCLUDED TO ESTIMATE<a name='2591'></font>
<font color=#447700>!  LINEAR RESERVOIR COEFFICIENT 'SLOPE' TO THE BASEFLOW RUNOFF<a name='2592'></font>
<font color=#447700>!  OUT OF THE BOTTOM LAYER. LOWEST CLASS (SLOPETYP=0)MEANS<a name='2593'></font>
<font color=#447700>!  HIGHEST SLOPE PARAMETER= 1<a name='2594'></font>
<font color=#447700>!  DEFINITION OF SLOPETYP FROM 'ZOBLER' SLOPE TYPE<a name='2595'></font>
<font color=#447700>!  SLOPE CLASS      PERCENT SLOPE<a name='2596'></font>
<font color=#447700>!  1                0-8<a name='2597'></font>
<font color=#447700>!  2                8-30<a name='2598'></font>
<font color=#447700>!  3                &gt; 30<a name='2599'></font>
<font color=#447700>!  4                0-30<a name='2600'></font>
<font color=#447700>!  5                0-8 &amp; &gt; 30<a name='2601'></font>
<font color=#447700>!  6                8-30 &amp; &gt; 30<a name='2602'></font>
<font color=#447700>!  7                0-8, 8-30, &gt; 30<a name='2603'></font>
<font color=#447700>!  9                GLACIAL ICE<a name='2604'></font>
<font color=#447700>!  BLANK            OCEAN/SEA<a name='2605'></font>
<font color=#447700>!  NOTE:  CLASS 9 FROM 'ZOBLER' FILE SHOULD BE REPLACED BY 8<a name='2606'></font>
<font color=#447700>!  AND 'BLANK'  9<a name='2607'></font>
<a name='2608'>
      REAL SLOPE<a name='2609'>
      REAL SLOPE_DATA(MAX_SLOPETYP)<a name='2610'>
      DATA SLOPE_DATA /0.1,  0.6, 1.0, 0.35, 0.55, 0.8,  &amp;<a name='2611'>
                       0.63, 0.0, 0.0, 0.0,  0.0,  0.0,  &amp;<a name='2612'>
                       0.0 , 0.0, 0.0, 0.0,  0.0,  0.0,  &amp;<a name='2613'>
                       0.0 , 0.0, 0.0, 0.0,  0.0,  0.0,  &amp;<a name='2614'>
                       0.0 , 0.0, 0.0, 0.0,  0.0,  0.0/<a name='2615'>
<a name='2616'>
<font color=#447700>!#######################################################################<a name='2617'></font>
<a name='2618'>
<font color=#447700>!  Set namelist file name<a name='2619'></font>
<a name='2620'>
      CHARACTER*50 NAMELIST_NAME<a name='2621'>
<a name='2622'>
<font color=#447700>!#######################################################################<a name='2623'></font>
<a name='2624'>
<font color=#447700>! SET UNIVERSAL PARAMETERS (NOT DEPENDENT ON SOIL, VEG, SLOPE TYPE)<a name='2625'></font>
<a name='2626'>
      INTEGER VEGTYP<a name='2627'>
      INTEGER SOILTYP<a name='2628'>
      INTEGER SLOPETYP<a name='2629'>
<a name='2630'>
      INTEGER NSOIL<a name='2631'>
      INTEGER I<a name='2632'>
<a name='2633'>
      INTEGER BARE<a name='2634'>
      DATA    BARE /11/<a name='2635'>
<a name='2636'>
      LOGICAL LPARAM<a name='2637'>
      DATA    LPARAM /.TRUE./<a name='2638'>
<a name='2639'>
      LOGICAL LFIRST<a name='2640'>
      DATA    LFIRST /.TRUE./<a name='2641'>
<a name='2642'>
<font color=#447700>!  Parameter used to calculate roughness length of heat<a name='2643'></font>
      REAL CZIL, CZIL_DATA<a name='2644'>
      DATA CZIL_DATA /0.2/<a name='2645'>
<a name='2646'>
<font color=#447700>!  Parameter used to caluculate vegetation effect on soil heat flux<a name='2647'></font>
      REAL SBETA, SBETA_DATA<a name='2648'>
      DATA SBETA_DATA /-2.0/<a name='2649'>
<a name='2650'>
<font color=#447700>! BARE SOIL EVAPORATION EXPONENT USED IN DEVAP<a name='2651'></font>
<a name='2652'>
      REAL FXEXP, FXEXP_DATA<a name='2653'>
      DATA FXEXP_DATA /2.0/<a name='2654'>
<a name='2655'>
<font color=#447700>! Soil heat capacity [J/m^3/K]<a name='2656'></font>
<a name='2657'>
      REAL CSOIL, CSOIL_DATA<a name='2658'>
      DATA CSOIL_DATA /2.00E+6/<a name='2659'>
<a name='2660'>
<font color=#447700>!  SPECIFY SNOW DISTRIBUTION SHAPE PARAMETER<a name='2661'></font>
<font color=#447700>!  SALP   - SHAPE PARAMETER OF DISTRIBUTION FUNCTION<a name='2662'></font>
<font color=#447700>!  OF SNOW COVER. FROM ANDERSON'S DATA (HYDRO-17)<a name='2663'></font>
<font color=#447700>!  BEST FIT IS WHEN SALP = 2.6<a name='2664'></font>
      REAL SALP, SALP_DATA<a name='2665'>
      DATA SALP_DATA /2.6/<a name='2666'>
<a name='2667'>
<font color=#447700>!  KDT IS DEFINED BY REFERENCE REFKDT AND DKSAT<a name='2668'></font>
<font color=#447700>!  REFDK=2.E-6 IS THE SAT. DK. VALUE FOR THE SOIL TYPE 2<a name='2669'></font>
      REAL REFDK, REFDK_DATA<a name='2670'>
      DATA REFDK_DATA /2.0E-6/<a name='2671'>
<a name='2672'>
      REAL REFKDT, REFKDT_DATA<a name='2673'>
      DATA REFKDT_DATA /3.0/<a name='2674'>
<a name='2675'>
      REAL KDT<a name='2676'>
      REAL FRZX<a name='2677'>
<a name='2678'>
<font color=#447700>!  FROZEN GROUND PARAMETER, FRZK, DEFINITION<a name='2679'></font>
<font color=#447700>!  FRZK IS ICE CONTENT THRESHOLD ABOVE WHICH FROZEN SOIL IS IMPERMEABLE<a name='2680'></font>
<font color=#447700>!  REFERENCE VALUE OF THIS PARAMETER FOR THE LIGHT CLAY SOIL (TYPE=3)<a name='2681'></font>
<font color=#447700>!  FRZK = 0.15 M<a name='2682'></font>
      REAL FRZK, FRZK_DATA<a name='2683'>
      DATA FRZK_DATA /0.15/<a name='2684'>
<a name='2685'>
      REAL RTDIS(NSOIL)<a name='2686'>
      REAL SLDPTH(NSOIL)<a name='2687'>
      REAL ZSOIL(NSOIL)<a name='2688'>
<a name='2689'>
<font color=#447700>!  Set two canopy water parameters<a name='2690'></font>
      REAL CFACTR, CFACTR_DATA<a name='2691'>
      REAL CMCMAX, CMCMAX_DATA<a name='2692'>
      DATA CFACTR_DATA /0.5/<a name='2693'>
      DATA CMCMAX_DATA /0.5E-3/<a name='2694'>
<a name='2695'>
<font color=#447700>!  Set max. stomatal resistance<a name='2696'></font>
      REAL RSMAX, RSMAX_DATA<a name='2697'>
      DATA RSMAX_DATA /5000.0/<a name='2698'>
<a name='2699'>
<font color=#447700>!  Set optimum transpiration air temperature<a name='2700'></font>
      REAL TOPT, TOPT_DATA<a name='2701'>
      DATA TOPT_DATA /298.0/<a name='2702'>
<a name='2703'>
<font color=#447700>!  Specify depth[m] of lower boundary soil temperature<a name='2704'></font>
      REAL ZBOT, ZBOT_DATA<a name='2705'>
      DATA ZBOT_DATA /-3.0/<a name='2706'>
<a name='2707'>
<font color=#447700>!#######################################################################<a name='2708'></font>
<a name='2709'>
<font color=#447700>!  Namelist definition<a name='2710'></font>
<a name='2711'>
      NAMELIST /SOIL_VEG/ SLOPE_DATA, RSMTBL, RGLTBL, HSTBL, SNUPX,     &amp;<a name='2712'>
           BB, DRYSMC, F11, MAXSMC, REFSMC, SATPSI, SATDK, SATDW,       &amp;<a name='2713'>
           WLTSMC, QTZ, LPARAM, ZBOT_DATA, SALP_DATA, CFACTR_DATA,      &amp;<a name='2714'>
           CMCMAX_DATA, SBETA_DATA, RSMAX_DATA, TOPT_DATA,              &amp;<a name='2715'>
           REFDK_DATA, FRZK_DATA, BARE, DEFINED_VEG, DEFINED_SOIL,      &amp;<a name='2716'>
           DEFINED_SLOPE, FXEXP_DATA, NROOT_DATA, REFKDT_DATA, Z0_DATA, &amp;<a name='2717'>
           CZIL_DATA, LAI_DATA, CSOIL_DATA<a name='2718'>
<a name='2719'>
<font color=#447700>!  Read namelist file to override default parameters<a name='2720'></font>
<font color=#447700>!  only once.<a name='2721'></font>
<font color=#447700>!<a name='2722'></font>
<font color=#447700>!  7/6/01 : E. Rogers commented out read of unit 58 since<a name='2723'></font>
<font color=#447700>!           NCO does not allow hardwired file names in the code.<a name='2724'></font>
<a name='2725'>
<font color=#447700>!     IF (LFIRST) THEN<a name='2726'></font>
<font color=#447700>!        OPEN(58, FILE = 'namelist_filename.txt')<a name='2727'></font>
<font color=#447700>! NAMELIST_NAME must be 50 characters or less.<a name='2728'></font>
<font color=#447700>!        READ(58,'(A)') NAMELIST_NAME<a name='2729'></font>
<font color=#447700>!        CLOSE(58)<a name='2730'></font>
<font color=#447700>!        WRITE(*,*) 'Namelist Filename is ', NAMELIST_NAME<a name='2731'></font>
<font color=#447700>!        OPEN(59, FILE = NAMELIST_NAME)<a name='2732'></font>
 50      CONTINUE<a name='2733'>
<font color=#447700>!           READ(59, SOIL_VEG, END=100)<a name='2734'></font>
<font color=#447700>!        IF (LPARAM) GOTO 50<a name='2735'></font>
 100     CONTINUE<a name='2736'>
<font color=#447700>!        CLOSE(59)<a name='2737'></font>
<font color=#447700>!        WRITE(*,NML=SOIL_VEG)<a name='2738'></font>
<font color=#447700>!        LFIRST = .FALSE.<a name='2739'></font>
         IF (DEFINED_SOIL .GT. MAX_SOILTYP) THEN<a name='2740'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_176">('Warning: DEFINED_SOIL too large in namelist') <a name='2741'>
         END IF<a name='2742'>
         IF (DEFINED_VEG .GT. MAX_VEGTYP) THEN<a name='2743'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_177">('Warning: DEFINED_VEG too large in namelist')<a name='2744'>
         END IF<a name='2745'>
         IF (DEFINED_SLOPE .GT. MAX_SLOPETYP) THEN<a name='2746'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_178">('Warning: DEFINED_SLOPE too large in namelist' )<a name='2747'>
         END IF<a name='2748'>
<a name='2749'>
         DO I = 1, DEFINED_SOIL<a name='2750'>
            SATDW(I)  = BB(I)*SATDK(I)*(SATPSI(I)/MAXSMC(I))<a name='2751'>
            F11(I)    = ALOG10(SATPSI(I)) + BB(I)*ALOG10(MAXSMC(I)) + 2.0<a name='2752'>
            REFSMC1   = MAXSMC(I)*(5.79E-9/SATDK(I))  &amp;<a name='2753'>
                                          **(1.0/(2.0*BB(I)+3.0))<a name='2754'>
            REFSMC(I) = REFSMC1 + (MAXSMC(I)-REFSMC1) / 3.0<a name='2755'>
            WLTSMC1   = MAXSMC(I) * (200.0/SATPSI(I))**(-1.0/BB(I))<a name='2756'>
            WLTSMC(I) = WLTSMC1 - 0.5 * WLTSMC1<a name='2757'>
<font color=#447700>! Current version DRYSMC values that equate to WLTSMC<a name='2758'></font>
<font color=#447700>! Future version could let DRYSMC be independently set via namelist <a name='2759'></font>
            DRYSMC(I) = WLTSMC(I)<a name='2760'>
         END DO<a name='2761'>
<a name='2762'>
<font color=#447700>!     END IF<a name='2763'></font>
<a name='2764'>
      IF (SOILTYP .GT. DEFINED_SOIL) THEN<a name='2765'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_179">(  'Warning: too many soil types' )<a name='2766'>
      END IF<a name='2767'>
      IF (VEGTYP .GT. DEFINED_VEG) THEN<a name='2768'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_180">(  'Warning: too many veg types' )<a name='2769'>
      END IF<a name='2770'>
      IF (SLOPETYP .GT. DEFINED_SLOPE) THEN<a name='2771'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_181">(  'Warning: too many slope types' )<a name='2772'>
      END IF<a name='2773'>
<a name='2774'>
<font color=#447700>!  SET-UP UNIVERSAL PARAMETERS <a name='2775'></font>
<font color=#447700>! (NOT DEPENDENT ON SOILTYP, VEGTYP OR SLOPETYP)<a name='2776'></font>
      ZBOT   = ZBOT_DATA<a name='2777'>
      SALP   = SALP_DATA<a name='2778'>
      CFACTR = CFACTR_DATA<a name='2779'>
      CMCMAX = CMCMAX_DATA<a name='2780'>
      SBETA  = SBETA_DATA<a name='2781'>
      RSMAX  = RSMAX_DATA<a name='2782'>
      TOPT   = TOPT_DATA<a name='2783'>
      REFDK  = REFDK_DATA<a name='2784'>
      FRZK   = FRZK_DATA<a name='2785'>
      FXEXP  = FXEXP_DATA<a name='2786'>
      REFKDT = REFKDT_DATA<a name='2787'>
      CZIL   = CZIL_DATA<a name='2788'>
      CSOIL  = CSOIL_DATA<a name='2789'>
<a name='2790'>
<font color=#447700>!  SET-UP SOIL PARAMETERS<a name='2791'></font>
      B       = BB(SOILTYP)<a name='2792'>
      SMCDRY  = DRYSMC(SOILTYP)<a name='2793'>
      F1      = F11(SOILTYP)<a name='2794'>
      SMCMAX  = MAXSMC(SOILTYP)<a name='2795'>
      SMCREF  = REFSMC(SOILTYP)<a name='2796'>
      PSISAT  = SATPSI(SOILTYP)<a name='2797'>
      DKSAT   = SATDK(SOILTYP)<a name='2798'>
      DWSAT   = SATDW(SOILTYP)<a name='2799'>
      SMCWLT  = WLTSMC(SOILTYP)<a name='2800'>
      QUARTZ  = QTZ(SOILTYP)<a name='2801'>
      FRZFACT = (SMCMAX / SMCREF) * (0.412 / 0.468)<a name='2802'>
      KDT     = REFKDT * DKSAT/REFDK<a name='2803'>
<a name='2804'>
<font color=#447700>!  TO ADJUST FRZK PARAMETER TO ACTUAL SOIL TYPE: FRZK * FRZFACT<a name='2805'></font>
<a name='2806'>
      FRZX = FRZK * FRZFACT<a name='2807'>
<a name='2808'>
<font color=#447700>!  SET-UP VEGETATION PARAMETERS<a name='2809'></font>
      NROOT = NROOT_DATA(VEGTYP)<a name='2810'>
      SNUP  = SNUPX(VEGTYP)<a name='2811'>
      RCMIN = RSMTBL(VEGTYP)<a name='2812'>
      RGL   = RGLTBL(VEGTYP)<a name='2813'>
      HS    = HSTBL(VEGTYP)<a name='2814'>
      Z0    = Z0_DATA(VEGTYP)<a name='2815'>
      LAI   = LAI_DATA(VEGTYP)<a name='2816'>
      IF(VEGTYP .EQ. BARE) SHDFAC = 0.0<a name='2817'>
<a name='2818'>
      IF (NROOT .GT. NSOIL) THEN<a name='2819'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_182"> ( 'Warning: too many root layers' )<a name='2820'>
      END IF<a name='2821'>
<a name='2822'>
<font color=#447700>!  CALCULATE ROOT DISTRIBUTION<a name='2823'></font>
<font color=#447700>!  PRESENT VERSION ASSUMES UNIFORM DISTRIBUTION BASED ON SOIL LAYERS<a name='2824'></font>
<a name='2825'>
      DO I=1,NROOT<a name='2826'>
         RTDIS(I) = -SLDPTH(I)/ZSOIL(NROOT)<a name='2827'>
      END DO<a name='2828'>
<a name='2829'>
<font color=#447700>!  SET-UP SLOPE PARAMETER<a name='2830'></font>
      SLOPE = SLOPE_DATA(SLOPETYP)<a name='2831'>
<font color=#447700>!<a name='2832'></font>
      END SUBROUTINE REDPRM<a name='2833'>
<a name='2834'>
<font color=#447700>! --------------------------------------------------------------<a name='2835'></font>
<a name='2836'>
<A NAME='REDPRM_USGS'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#REDPRM_USGS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2837'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>REDPRM_USGS</font>(VEGTYP, SOILTYP, SLOPETYP,              &amp; <A href='../../call_to/REDPRM_USGS.html' TARGET='index'>1</A>,<A href='../../call_from/REDPRM_USGS.html' TARGET='index'>7</A><a name='2838'>
           CFACTR, CMCMAX, RSMAX, TOPT, REFKDT, KDT, SBETA,     &amp;<a name='2839'>
           SHDFAC, RCMIN, RGL, HS, ZBOT, FRZX, PSISAT, SLOPE,   &amp;<a name='2840'>
           SNUP, SALP, B, DKSAT, DWSAT, SMCMAX, SMCWLT, SMCREF, &amp;<a name='2841'>
           SMCDRY, F1, QUARTZ, FXEXP, RTDIS, SLDPTH, ZSOIL,     &amp;<a name='2842'>
           NROOT, NSOIL, Z0, CZIL, LAI, CSOIL, PTU)<a name='2843'>
<a name='2844'>
<a name='2845'>
      IMPLICIT NONE<a name='2846'>
<a name='2847'>
<a name='2848'>
<font color=#447700>!  This subroutine internally sets (defaults), or optionally reads-in<a name='2849'></font>
<font color=#447700>!  via namelist I/O, all the soil and vegetation parameters<a name='2850'></font>
<font color=#447700>!  required for the execusion of the NOAH - LSM<a name='2851'></font>
<font color=#447700>!<a name='2852'></font>
<font color=#447700>! optional non-default parameters can be read in, accommodating up<a name='2853'></font>
<font color=#447700>!  to 30 soil, veg, or slope classes, if the default max number of<a name='2854'></font>
<font color=#447700>!  soil, veg, and/or slope types is reset.<a name='2855'></font>
<a name='2856'>
<font color=#447700>! future upgrades of routine REDPRM must expand to incorporate some<a name='2857'></font>
<font color=#447700>! of the empirical parameters of the frozen soil and snowpack physics<a name='2858'></font>
<font color=#447700>! (such as in routines FRH2O, SNOWPACK, and SNOW_NEW) not yet set in<a name='2859'></font>
<font color=#447700>!  this REDPRM routine, but rather set in lower level subroutines<a name='2860'></font>
<a name='2861'>
<font color=#447700>!  Set maximum number of soil-, veg-, and slopetyp in data statement<a name='2862'></font>
<a name='2863'>
      INTEGER MAX_SOILTYP<a name='2864'>
      INTEGER MAX_VEGTYP<a name='2865'>
      INTEGER MAX_SLOPETYP<a name='2866'>
      PARAMETER (MAX_SOILTYP  = 30)<a name='2867'>
      PARAMETER (MAX_VEGTYP   = 30)<a name='2868'>
      PARAMETER (MAX_SLOPETYP = 30)<a name='2869'>
<a name='2870'>
<font color=#447700>!  Number of defined soil-, veg-, and slopetyps used<a name='2871'></font>
<a name='2872'>
      INTEGER DEFINED_VEG<a name='2873'>
      INTEGER DEFINED_SOIL<a name='2874'>
      INTEGER DEFINED_SLOPE<a name='2875'>
      DATA DEFINED_VEG/24/<a name='2876'>
      DATA DEFINED_SOIL/16/<a name='2877'>
      DATA DEFINED_SLOPE/9/<a name='2878'>
<a name='2879'>
<font color=#447700>!  SET-UP SOIL PARAMETERS FOR GIVEN SOIL TYPE<a name='2880'></font>
<font color=#447700>!  INPUT: SOLTYP: SOIL TYPE (INTEGER INDEX)<a name='2881'></font>
<font color=#447700>!  OUTPUT: SOIL PARAMETERS:<a name='2882'></font>
<a name='2883'>
<font color=#447700>!    MAXSMC: MAX SOIL MOISTURE CONTENT (POROSITY)<a name='2884'></font>
<font color=#447700>!    REFSMC: REFERENCE SOIL MOISTURE (ONSET OF SOIL MOISTURE<a name='2885'></font>
<font color=#447700>!            STRESS IN TRANSPIRATION)<a name='2886'></font>
<font color=#447700>!    WLTSMC: WILTING PT SOIL MOISTURE CONTENTS<a name='2887'></font>
<font color=#447700>!    DRYSMC: AIR DRY SOIL MOIST CONTENT LIMITS<a name='2888'></font>
<font color=#447700>!    SATPSI: SATURATED SOIL POTENTIAL<a name='2889'></font>
<font color=#447700>!    SATDK:  SATURATED SOIL HYDRAULIC CONDUCTIVITY<a name='2890'></font>
<font color=#447700>!    BB:     THE 'B' PARAMETER<a name='2891'></font>
<font color=#447700>!    SATDW:  SATURATED SOIL DIFFUSIVITY<a name='2892'></font>
<font color=#447700>!    F11:    USED TO COMPUTE SOIL DIFFUSIVITY/CONDUCTIVITY<a name='2893'></font>
<font color=#447700>!    QUARTZ:  SOIL QUARTZ CONTENT<a name='2894'></font>
<font color=#447700>!<a name='2895'></font>
<font color=#447700>!C     SOIL TYPES    STATSGO (Miller ??, 199?)  Cosby et al (1984)<a name='2896'></font>
<font color=#447700>!C             1          SAND                  SAND<a name='2897'></font>
<font color=#447700>!C             2          LOAMY SAND            LOAMY SAND<a name='2898'></font>
<font color=#447700>!C             3          SANDY LOAM            SANDY LOAM<a name='2899'></font>
<font color=#447700>!C             4          SILT LOAM             SILTY LOAM<a name='2900'></font>
<font color=#447700>!C             5          SILT                  SILTY LOAM<a name='2901'></font>
<font color=#447700>!C             6          LOAM                  LOAM<a name='2902'></font>
<font color=#447700>!C             7          SANDY CLAY LOAM       SANDY CLAY LOAM<a name='2903'></font>
<font color=#447700>!C             8          SILTY CLAY LOAM       SILTY CLAY LOAM<a name='2904'></font>
<font color=#447700>!C             9          CLAY LOAM             CLAY LOAM<a name='2905'></font>
<font color=#447700>!C            10          SANDY CLAY            SANDY CLAY<a name='2906'></font>
<font color=#447700>!C            11          SILTY CLAY            SILTY CLAY<a name='2907'></font>
<font color=#447700>!C            12          CLAY                  LIGHT CLAY<a name='2908'></font>
<font color=#447700>!C            13          ORGANIC MATERIALS     LOAM<a name='2909'></font>
<font color=#447700>!C            14          WATER<a name='2910'></font>
<font color=#447700>!C            15          BEDROCK<a name='2911'></font>
<font color=#447700>!C                        Bedrock is reclassified as class 14<a name='2912'></font>
<font color=#447700>!C            16          OTHER (land-ice)<a name='2913'></font>
<font color=#447700>!C                        the value of this class is the same as in class<a name='2914'></font>
<a name='2915'>
<a name='2916'>
      REAL BB(MAX_SOILTYP)<a name='2917'>
      REAL DRYSMC(MAX_SOILTYP)<a name='2918'>
      REAL F11(MAX_SOILTYP)<a name='2919'>
      REAL MAXSMC(MAX_SOILTYP)<a name='2920'>
      REAL REFSMC(MAX_SOILTYP)<a name='2921'>
      REAL SATPSI(MAX_SOILTYP)<a name='2922'>
      REAL SATDK(MAX_SOILTYP)<a name='2923'>
      REAL SATDW(MAX_SOILTYP)<a name='2924'>
      REAL WLTSMC(MAX_SOILTYP)<a name='2925'>
      REAL QTZ(MAX_SOILTYP)<a name='2926'>
<a name='2927'>
      REAL B<a name='2928'>
      REAL DKSAT<a name='2929'>
      REAL DWSAT<a name='2930'>
      REAL SMCMAX<a name='2931'>
      REAL SMCWLT<a name='2932'>
      REAL SMCREF<a name='2933'>
      REAL SMCDRY<a name='2934'>
      REAL PTU<a name='2935'>
      REAL F1<a name='2936'>
      REAL QUARTZ<a name='2937'>
      REAL REFSMC1<a name='2938'>
      REAL WLTSMC1<a name='2939'>
<a name='2940'>
      DATA MAXSMC/0.339, 0.421, 0.434, 0.476, 0.476, 0.439,  &amp;<a name='2941'>
                  0.404, 0.464, 0.465, 0.406, 0.468, 0.468,  &amp;<a name='2942'>
                  0.439, 1.000, 0.200, 0.421, 0.000, 0.000,  &amp;<a name='2943'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,  &amp;<a name='2944'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='2945'>
      DATA SATPSI/0.069, 0.036, 0.141, 0.759, 0.759, 0.355,   &amp;<a name='2946'>
                  0.135, 0.617, 0.263, 0.098, 0.324, 0.468,   &amp;<a name='2947'>
                  0.355, 0.000, 0.069, 0.036, 0.000, 0.000,   &amp;<a name='2948'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,   &amp;<a name='2949'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='2950'>
      DATA SATDK /1.07E-6, 1.41E-5, 5.23E-6, 2.81E-6, 2.81E-6, &amp;<a name='2951'>
                  3.38E-6, 4.45E-6, 2.04E-6, 2.45E-6, 7.22E-6, &amp;<a name='2952'>
                  1.34E-6, 9.74E-7, 3.38E-6, 0.00000, 1.41E-4, &amp;<a name='2953'>
                  1.41E-5, 0.00   , 0.00   , 0.00   , 0.00,    &amp;<a name='2954'>
                  0.00   , 0.00   , 0.00   , 0.00   , 0.00,    &amp;<a name='2955'>
                  0.00   , 0.00   , 0.00   , 0.00   , 0.00/<a name='2956'>
      DATA BB    /2.79,  4.26,  4.74,  5.33,  5.33,  5.25,    &amp;<a name='2957'>
                  6.66,  8.72,  8.17, 10.73, 10.39, 11.55,    &amp;<a name='2958'>
                  5.25,  0.00,  2.79,  4.26,  0.00,  0.00,    &amp;<a name='2959'>
                  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,    &amp;<a name='2960'>
                  0.00,  0.00,  0.00,  0.00,  0.00,  0.00/<a name='2961'>
<a name='2962'>
      DATA QTZ   /0.92, 0.82, 0.60, 0.25, 0.10, 0.40,        &amp;<a name='2963'>
                  0.60, 0.10, 0.35, 0.52, 0.10, 0.25,        &amp;<a name='2964'>
                  0.05, 0.60, 0.07, 0.25, 0.00, 0.00,        &amp;<a name='2965'>
                  0.00, 0.00, 0.00, 0.00, 0.00, 0.00,        &amp;<a name='2966'>
                  0.00, 0.00, 0.00, 0.00, 0.00, 0.00/<a name='2967'>
<a name='2968'>
<font color=#447700>! The following 5 parameters are derived later in REDPRM.f<a name='2969'></font>
<font color=#447700>! from the soil data, and are just given here for reference<a name='2970'></font>
<font color=#447700>! and to force static storage allocation<a name='2971'></font>
<font color=#447700>! Dag Lohmann, Feb. 2001<a name='2972'></font>
<a name='2973'>
      DATA REFSMC/0.236, 0.283, 0.312, 0.360, 0.360, 0.329,     &amp;<a name='2974'>
                  0.314, 0.387, 0.382, 0.338, 0.404, 0.412,     &amp;<a name='2975'>
                  0.329, 0.000, 0.108, 0.283, 0.000, 0.000,     &amp;<a name='2976'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,     &amp;<a name='2977'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='2978'>
      DATA WLTSMC/0.010, 0.028, 0.047, 0.084, 0.084, 0.066,     &amp;<a name='2979'>
                  0.067, 0.120, 0.103, 0.100, 0.126, 0.138,     &amp;<a name='2980'>
                  0.066, 0.000, 0.006, 0.028, 0.000, 0.000,     &amp;<a name='2981'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,     &amp;<a name='2982'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='2983'>
      DATA DRYSMC/0.010, 0.028, 0.047, 0.084, 0.084, 0.066,     &amp;<a name='2984'>
                  0.067, 0.120, 0.103, 0.100, 0.126, 0.138,     &amp;<a name='2985'>
                  0.066, 0.000, 0.006, 0.028, 0.000, 0.000,     &amp;<a name='2986'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000,     &amp;<a name='2987'>
                  0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='2988'>
      DATA SATDW /0.608E-6, 0.514E-5, 0.805E-5, 0.239E-4, 0.239E-4,  &amp;<a name='2989'>
                  0.143E-4, 0.990E-5, 0.237E-4, 0.113E-4, 0.187E-4,  &amp;<a name='2990'>
                  0.964E-5, 0.112E-4, 0.143E-4, 0.000000, 0.136E-3,  &amp;<a name='2991'>
                  0.514E-5, 0.00   , 0.00   , 0.00   , 0.00,     &amp;<a name='2992'>
                  0.00    , 0.00   , 0.00   , 0.00   , 0.00,     &amp;<a name='2993'>
                  0.00    , 0.00   , 0.00   , 0.00   , 0.00/<a name='2994'>
      DATA F11  /-0.472, -1.044, -0.569, 0.162, 0.162, -0.327, &amp;<a name='2995'>
                  -1.491, -1.118, -1.297, -3.209, -1.916, -2.138, &amp;<a name='2996'>
                  -0.327,  0.000, -1.111, -1.044,  0.000,  0.000, &amp;<a name='2997'>
                  0.000,  0.000,  0.000,  0.000,  0.000,  0.000, &amp;<a name='2998'>
                  0.000,  0.000,  0.000,  0.000,  0.000,  0.000/<a name='2999'>
<a name='3000'>
<font color=#447700>!#######################################################################<a name='3001'></font>
<a name='3002'>
<font color=#447700>!  SET-UP VEGETATION PARAMETERS FOR A GIVEN VEGETAION TYPE<a name='3003'></font>
<font color=#447700>!<a name='3004'></font>
<font color=#447700>!  INPUT: VEGTYP = VEGETATION TYPE (INTEGER INDEX)<a name='3005'></font>
<font color=#447700>!  OUPUT: VEGETATION PARAMETERS<a name='3006'></font>
<font color=#447700>!         SHDFAC: VEGETATION GREENNESS FRACTION<a name='3007'></font>
<font color=#447700>!         RCMIN:  MIMIMUM STOMATAL RESISTANCE<a name='3008'></font>
<font color=#447700>!         RGL:    PARAMETER USED IN SOLAR RAD TERM OF<a name='3009'></font>
<font color=#447700>!                 CANOPY RESISTANCE FUNCTION<a name='3010'></font>
<font color=#447700>!         HS:     PARAMETER USED IN VAPOR PRESSURE DEFICIT TERM OF<a name='3011'></font>
<font color=#447700>!                 CANOPY RESISTANCE FUNCTION<a name='3012'></font>
<font color=#447700>!         SNUP:   THRESHOLD SNOW DEPTH (IN WATER EQUIVALENT M) THAT<a name='3013'></font>
<font color=#447700>!                 IMPLIES 100% SNOW COVER<a name='3014'></font>
<font color=#447700>!<a name='3015'></font>
<font color=#447700>!     USGS Vegetation Types<a name='3016'></font>
<font color=#447700>!C<a name='3017'></font>
<font color=#447700>!C    1:   Urban and Built-Up Land<a name='3018'></font>
<font color=#447700>!C    2:   Dryland Cropland and Pasture<a name='3019'></font>
<font color=#447700>!     3:   Irrigated Cropland and Pasture<a name='3020'></font>
<font color=#447700>!     4:   Mixed Dryland/Irrigated Cropland and Pasture<a name='3021'></font>
<font color=#447700>!     5:   Cropland/Grassland Mosaic<a name='3022'></font>
<font color=#447700>!C    6:   Cropland/Woodland Mosaic<a name='3023'></font>
<font color=#447700>!C    7:   Grassland<a name='3024'></font>
<font color=#447700>!C    8:   Shrubland<a name='3025'></font>
<font color=#447700>!C    9:   Mixed Shrubland/Grassland<a name='3026'></font>
<font color=#447700>!C   10:   Savanna<a name='3027'></font>
<font color=#447700>!C   11:   Deciduous Broadleaf Forest<a name='3028'></font>
<font color=#447700>!C   12:   Deciduous Needleleaf Forest<a name='3029'></font>
<font color=#447700>!C   13:   Evergreen Broadleaf Forest<a name='3030'></font>
<font color=#447700>!C   14:   Evergreen Needleleaf Forest<a name='3031'></font>
<font color=#447700>!C   15:   Mixed Forest<a name='3032'></font>
<font color=#447700>!C   16:   Water Bodies<a name='3033'></font>
<font color=#447700>!C   17:   Herbaceous Wetland<a name='3034'></font>
<font color=#447700>!C   18:   Wooded Wetland<a name='3035'></font>
<font color=#447700>!C   19:   Barren or Sparsely Vegetated<a name='3036'></font>
<font color=#447700>!C   20:   Herbaceous Tundra<a name='3037'></font>
<font color=#447700>!C   21:   Wooded Tundra<a name='3038'></font>
<font color=#447700>!C   22:   Mixed Tundra<a name='3039'></font>
<font color=#447700>!C   23:   Bare Ground Tundra<a name='3040'></font>
<font color=#447700>!C   24:   Snow or Ice<a name='3041'></font>
<a name='3042'>
<a name='3043'>
      INTEGER NROOT_DATA(MAX_VEGTYP)<a name='3044'>
      REAL    RSMTBL(MAX_VEGTYP)<a name='3045'>
      REAL    RGLTBL(MAX_VEGTYP)<a name='3046'>
      REAL    HSTBL(MAX_VEGTYP)<a name='3047'>
      REAL    SNUPX(MAX_VEGTYP)<a name='3048'>
      REAL    Z0_DATA(MAX_VEGTYP)<a name='3049'>
      REAL    LAI_DATA(MAX_VEGTYP)<a name='3050'>
<a name='3051'>
      INTEGER NROOT<a name='3052'>
      REAL    SHDFAC<a name='3053'>
      REAL    RCMIN<a name='3054'>
      REAL    RGL<a name='3055'>
      REAL    HS<a name='3056'>
      REAL    FRZFACT<a name='3057'>
      REAL    PSISAT<a name='3058'>
      REAL    SNUP<a name='3059'>
      REAL    Z0<a name='3060'>
      REAL    LAI<a name='3061'>
<a name='3062'>
<a name='3063'>
      DATA NROOT_DATA /1,3,3,3,3,3,3,3,3,3,4,4,4,4,4,       &amp;<a name='3064'>
                       0,2,2,1,3,3,3,2,1,0,0,0,0,0,0/<a name='3065'>
<a name='3066'>
      DATA RSMTBL /200.0,  40.0,  40.0,  40.0,  40.0, 70.0, &amp;<a name='3067'>
                    40.0, 300.0, 170.0,  70.0, 100.0, 150.0, &amp;<a name='3068'>
                   150.0, 125.0, 125.0, 100.0,  40.0, 100.0, &amp;<a name='3069'>
                   999.0, 150.0, 150.0, 150.0, 200.0, 999.0, &amp;<a name='3070'>
                     0.0,   0.0,   0.0,   0.0,   0.0,  0.0/<a name='3071'>
      DATA RGLTBL / 999., 100., 100., 100., 100.,  65., 100., 100., &amp;<a name='3072'>
                    100.,  65.,  30.,  30.,  30.,  30.,  30.,  30., &amp;<a name='3073'>
                    100.,  30., 999., 100., 100., 100., 100., 999., &amp;<a name='3074'>
                    0.0,  0.0,  0.0,   0.0,  0.0,  0.0/<a name='3075'>
      DATA HSTBL/999.0, 36.25, 36.25, 36.25, 36.25, 44.14, 36.35, &amp;<a name='3076'>
                 42.00, 39.18, 54.53, 54.53, 47.35, 41.69, 47.35, &amp;<a name='3077'>
                 51.93, 51.75, 60.00, 51.93, 999.0, 42.00, 42.00, &amp;<a name='3078'>
                 42.00, 42.00, 999.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0/<a name='3079'>
<a name='3080'>
      DATA SNUPX  /0.040, 0.040, 0.040, 0.040, 0.040, 0.040, &amp;<a name='3081'>
                   0.040, 0.030, 0.035, 0.040, 0.080, 0.080, &amp;<a name='3082'>
                   0.080, 0.080, 0.080, 0.010, 0.010, 0.020, &amp;<a name='3083'>
                   0.020, 0.025, 0.025, 0.025, 0.020, 0.020, &amp;<a name='3084'>
                   0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='3085'>
      DATA Z0_DATA /1.00,  0.07,  0.07,  0.07,  0.07,  0.15, &amp;<a name='3086'>
                    0.08,  0.03,  0.05,  0.86,  0.80,  0.85, &amp;<a name='3087'>
                    2.65,  1.09,  0.80,  0.001,  0.04,  0.05, &amp;<a name='3088'>
                    0.01,  0.04,  0.06,  0.05,  0.03,  0.001, &amp;<a name='3089'>
                    0.000, 0.000, 0.000, 0.000, 0.000, 0.000/<a name='3090'>
<a name='3091'>
      DATA LAI_DATA /4.0, 4.0, 4.0, 4.0, 4.0, 4.0,  &amp;<a name='3092'>
                     4.0, 4.0, 4.0, 4.0, 4.0, 4.0,  &amp;<a name='3093'>
                     4.0, 4.0, 4.0, 0.0, 4.0, 4.0,  &amp;<a name='3094'>
                     4.0, 4.0, 4.0, 4.0, 4.0, 4.0,  &amp;<a name='3095'>
                     0.0, 0.0, 0.0, 0.0, 0.0, 0.0/<a name='3096'>
<a name='3097'>
<font color=#447700>!#######################################################################<a name='3098'></font>
<a name='3099'>
<font color=#447700>!  CLASS PARAMETER 'SLOPETYP' WAS INCLUDED TO ESTIMATE<a name='3100'></font>
<font color=#447700>!  LINEAR RESERVOIR COEFFICIENT 'SLOPE' TO THE BASEFLOW RUNOFF<a name='3101'></font>
<font color=#447700>!  OUT OF THE BOTTOM LAYER. LOWEST CLASS (SLOPETYP=0)MEANS<a name='3102'></font>
<font color=#447700>!  HIGHEST SLOPE PARAMETER= 1<a name='3103'></font>
<font color=#447700>!  DEFINITION OF SLOPETYP FROM 'ZOBLER' SLOPE TYPE<a name='3104'></font>
<font color=#447700>!  SLOPE CLASS      PERCENT SLOPE<a name='3105'></font>
<font color=#447700>!  1                0-8<a name='3106'></font>
<font color=#447700>!  2                8-30<a name='3107'></font>
<font color=#447700>!  3                &gt; 30<a name='3108'></font>
<font color=#447700>!  4                0-30<a name='3109'></font>
<font color=#447700>!  5                0-8 &amp; &gt; 30<a name='3110'></font>
<font color=#447700>!  6                8-30 &amp; &gt; 30<a name='3111'></font>
<font color=#447700>!  7                0-8, 8-30, &gt; 30<a name='3112'></font>
<font color=#447700>!  9                GLACIAL ICE<a name='3113'></font>
<font color=#447700>!  BLANK            OCEAN/SEA<a name='3114'></font>
<font color=#447700>!  NOTE:  CLASS 9 FROM 'ZOBLER' FILE SHOULD BE REPLACED BY 8<a name='3115'></font>
<font color=#447700>!  AND 'BLANK'  9<a name='3116'></font>
<a name='3117'>
      REAL SLOPE<a name='3118'>
      REAL SLOPE_DATA(MAX_SLOPETYP)<a name='3119'>
      DATA SLOPE_DATA /0.1,  0.6, 1.0, 0.35, 0.55, 0.8,  &amp;<a name='3120'>
                       0.63, 0.0, 0.0, 0.0,  0.0,  0.0,  &amp;<a name='3121'>
                       0.0 , 0.0, 0.0, 0.0,  0.0,  0.0,  &amp;<a name='3122'>
                       0.0 , 0.0, 0.0, 0.0,  0.0,  0.0,  &amp;<a name='3123'>
                       0.0 , 0.0, 0.0, 0.0,  0.0,  0.0/<a name='3124'>
<a name='3125'>
<font color=#447700>!#######################################################################<a name='3126'></font>
<a name='3127'>
<font color=#447700>!  Set namelist file name<a name='3128'></font>
<a name='3129'>
      CHARACTER*50 NAMELIST_NAME<a name='3130'>
<a name='3131'>
<font color=#447700>!#######################################################################<a name='3132'></font>
<a name='3133'>
<font color=#447700>! SET UNIVERSAL PARAMETERS (NOT DEPENDENT ON SOIL, VEG, SLOPE TYPE)<a name='3134'></font>
<a name='3135'>
      INTEGER VEGTYP<a name='3136'>
      INTEGER SOILTYP<a name='3137'>
      INTEGER SLOPETYP<a name='3138'>
<a name='3139'>
      INTEGER NSOIL<a name='3140'>
      INTEGER I<a name='3141'>
<a name='3142'>
      INTEGER BARE<a name='3143'>
      DATA    BARE /11/<a name='3144'>
<a name='3145'>
      LOGICAL LPARAM<a name='3146'>
      DATA    LPARAM /.TRUE./<a name='3147'>
<a name='3148'>
      LOGICAL LFIRST<a name='3149'>
      DATA    LFIRST /.TRUE./<a name='3150'>
<a name='3151'>
<font color=#447700>!  Parameter used to calculate roughness length of heat<a name='3152'></font>
      REAL CZIL, CZIL_DATA<a name='3153'>
      DATA CZIL_DATA /0.2/<a name='3154'>
<a name='3155'>
<font color=#447700>!  Parameter used to caluculate vegetation effect on soil heat flux<a name='3156'></font>
      REAL SBETA, SBETA_DATA<a name='3157'>
      DATA SBETA_DATA /-2.0/<a name='3158'>
<a name='3159'>
<font color=#447700>! BARE SOIL EVAPORATION EXPONENT USED IN DEVAP<a name='3160'></font>
<a name='3161'>
      REAL FXEXP, FXEXP_DATA<a name='3162'>
      DATA FXEXP_DATA /2.0/<a name='3163'>
<a name='3164'>
<font color=#447700>! Soil heat capacity [J/m^3/K]<a name='3165'></font>
<a name='3166'>
      REAL CSOIL, CSOIL_DATA<a name='3167'>
      DATA CSOIL_DATA /1.26E+6/<a name='3168'>
<a name='3169'>
<font color=#447700>!  SPECIFY SNOW DISTRIBUTION SHAPE PARAMETER<a name='3170'></font>
<font color=#447700>!  SALP   - SHAPE PARAMETER OF DISTRIBUTION FUNCTION<a name='3171'></font>
<font color=#447700>!  OF SNOW COVER. FROM ANDERSON'S DATA (HYDRO-17)<a name='3172'></font>
<font color=#447700>!  BEST FIT IS WHEN SALP = 2.6<a name='3173'></font>
      REAL SALP, SALP_DATA<a name='3174'>
      DATA SALP_DATA /2.6/<a name='3175'>
<a name='3176'>
<font color=#447700>!  KDT IS DEFINED BY REFERENCE REFKDT AND DKSAT<a name='3177'></font>
<font color=#447700>!  REFDK=2.E-6 IS THE SAT. DK. VALUE FOR THE SOIL TYPE 2<a name='3178'></font>
      REAL REFDK, REFDK_DATA<a name='3179'>
      DATA REFDK_DATA /2.0E-6/<a name='3180'>
<a name='3181'>
      REAL REFKDT, REFKDT_DATA<a name='3182'>
      DATA REFKDT_DATA /3.0/<a name='3183'>
<a name='3184'>
      REAL KDT<a name='3185'>
      REAL FRZX<a name='3186'>
<a name='3187'>
<font color=#447700>!  FROZEN GROUND PARAMETER, FRZK, DEFINITION<a name='3188'></font>
<font color=#447700>!  FRZK IS ICE CONTENT THRESHOLD ABOVE WHICH FROZEN SOIL IS IMPERMEABLE<a name='3189'></font>
<font color=#447700>!  REFERENCE VALUE OF THIS PARAMETER FOR THE LIGHT CLAY SOIL (TYPE=3)<a name='3190'></font>
<font color=#447700>!  FRZK = 0.15 M<a name='3191'></font>
      REAL FRZK, FRZK_DATA<a name='3192'>
      DATA FRZK_DATA /0.15/<a name='3193'>
<a name='3194'>
      REAL RTDIS(NSOIL)<a name='3195'>
      REAL SLDPTH(NSOIL)<a name='3196'>
      REAL ZSOIL(NSOIL)<a name='3197'>
<a name='3198'>
<font color=#447700>!  Set two canopy water parameters<a name='3199'></font>
      REAL CFACTR, CFACTR_DATA<a name='3200'>
      REAL CMCMAX, CMCMAX_DATA<a name='3201'>
      DATA CFACTR_DATA /0.5/<a name='3202'>
      DATA CMCMAX_DATA /0.5E-3/<a name='3203'>
<a name='3204'>
<font color=#447700>!  Set max. stomatal resistance<a name='3205'></font>
      REAL RSMAX, RSMAX_DATA<a name='3206'>
      DATA RSMAX_DATA /5000.0/<a name='3207'>
<a name='3208'>
<font color=#447700>!  Set optimum transpiration air temperature<a name='3209'></font>
      REAL TOPT, TOPT_DATA<a name='3210'>
      DATA TOPT_DATA /298.0/<a name='3211'>
<a name='3212'>
<font color=#447700>!  Specify depth[m] of lower boundary soil temperature<a name='3213'></font>
      REAL ZBOT, ZBOT_DATA<a name='3214'>
      DATA ZBOT_DATA /-3.0/<a name='3215'>
<a name='3216'>
<font color=#447700>!#######################################################################<a name='3217'></font>
<a name='3218'>
<font color=#447700>!  Namelist definition<a name='3219'></font>
<a name='3220'>
      NAMELIST /SOIL_VEG/ SLOPE_DATA, RSMTBL, RGLTBL, HSTBL, SNUPX,     &amp;<a name='3221'>
           BB, DRYSMC, F11, MAXSMC, REFSMC, SATPSI, SATDK, SATDW,       &amp;<a name='3222'>
           WLTSMC, QTZ, LPARAM, ZBOT_DATA, SALP_DATA, CFACTR_DATA,      &amp;<a name='3223'>
           CMCMAX_DATA, SBETA_DATA, RSMAX_DATA, TOPT_DATA,              &amp;<a name='3224'>
           REFDK_DATA, FRZK_DATA, BARE, DEFINED_VEG, DEFINED_SOIL,      &amp;<a name='3225'>
           DEFINED_SLOPE, FXEXP_DATA, NROOT_DATA, REFKDT_DATA, Z0_DATA, &amp;<a name='3226'>
           CZIL_DATA, LAI_DATA, CSOIL_DATA<a name='3227'>
<a name='3228'>
<font color=#447700>!  Read namelist file to override default parameters<a name='3229'></font>
<font color=#447700>!  only once.<a name='3230'></font>
<font color=#447700>!<a name='3231'></font>
<font color=#447700>!  7/6/01 : E. Rogers commented out read of unit 58 since<a name='3232'></font>
<font color=#447700>!           NCO does not allow hardwired file names in the code.<a name='3233'></font>
<a name='3234'>
<font color=#447700>!     IF (LFIRST) THEN<a name='3235'></font>
<font color=#447700>!        OPEN(58, FILE = 'namelist_filename.txt')<a name='3236'></font>
<font color=#447700>! NAMELIST_NAME must be 50 characters or less.<a name='3237'></font>
<font color=#447700>!        READ(58,'(A)') NAMELIST_NAME<a name='3238'></font>
<font color=#447700>!        CLOSE(58)<a name='3239'></font>
<font color=#447700>!        WRITE(*,*) 'Namelist Filename is ', NAMELIST_NAME<a name='3240'></font>
<font color=#447700>!        OPEN(59, FILE = NAMELIST_NAME)<a name='3241'></font>
 50      CONTINUE<a name='3242'>
<font color=#447700>!           READ(59, SOIL_VEG, END=100)<a name='3243'></font>
<font color=#447700>!        IF (LPARAM) GOTO 50<a name='3244'></font>
 100     CONTINUE<a name='3245'>
<font color=#447700>!        CLOSE(59)<a name='3246'></font>
<font color=#447700>!        WRITE(*,NML=SOIL_VEG)<a name='3247'></font>
<font color=#447700>!        LFIRST = .FALSE.<a name='3248'></font>
         IF (DEFINED_SOIL .GT. MAX_SOILTYP) THEN<a name='3249'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#REDPRM_USGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_183">( 'Warning: DEFINED_SOIL too large in namelist' )<a name='3250'>
         END IF<a name='3251'>
         IF (DEFINED_VEG .GT. MAX_VEGTYP) THEN<a name='3252'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#REDPRM_USGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_184">( 'Warning: DEFINED_VEG too large in namelist')<a name='3253'>
         END IF<a name='3254'>
         IF (DEFINED_SLOPE .GT. MAX_SLOPETYP) THEN<a name='3255'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#REDPRM_USGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_185">( 'Warning: DEFINED_SLOPE too large in namelist')<a name='3256'>
         END IF<a name='3257'>
<a name='3258'>
         DO I = 1, DEFINED_SOIL<a name='3259'>
<font color=#447700>!           if(abs(satdk(i))&lt;=1.e-7.or.abs(satpsi(i))&lt;=1.e-7)cycle<a name='3260'></font>
<font color=#447700>!           SATDW(I)  = BB(I)*SATDK(I)*(SATPSI(I)/MAXSMC(I))<a name='3261'></font>
<font color=#447700>!           F11(I)    = ALOG10(SATPSI(I)) + BB(I)*ALOG10(MAXSMC(I)) + 2.0<a name='3262'></font>
<font color=#447700>!           REFSMC1   = MAXSMC(I)*(5.79E-9/SATDK(I))  &amp;<a name='3263'></font>
<font color=#447700>!                                         **(1.0/(2.0*BB(I)+3.0))<a name='3264'></font>
<font color=#447700>!           REFSMC(I) = REFSMC1 + (MAXSMC(I)-REFSMC1) / 3.0<a name='3265'></font>
<font color=#447700>!           WLTSMC1   = MAXSMC(I) * (200.0/SATPSI(I))**(-1.0/BB(I))<a name='3266'></font>
<font color=#447700>!           WLTSMC(I) = WLTSMC1 - 0.5 * WLTSMC1<a name='3267'></font>
<font color=#447700>! Current version DRYSMC values that equate to WLTSMC<a name='3268'></font>
<font color=#447700>! Future version could let DRYSMC be independently set via namelist<a name='3269'></font>
<font color=#447700>!           DRYSMC(I) = WLTSMC(I)<a name='3270'></font>
         END DO<a name='3271'>
<a name='3272'>
<font color=#447700>!     END IF<a name='3273'></font>
<a name='3274'>
      IF (SOILTYP .GT. DEFINED_SOIL) THEN<a name='3275'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#REDPRM_USGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_186">( 'Warning: to many soil types' )<a name='3276'>
      END IF<a name='3277'>
      IF (VEGTYP .GT. DEFINED_VEG) THEN<a name='3278'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#REDPRM_USGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_187">( 'Warning: to many veg types' )<a name='3279'>
      END IF<a name='3280'>
      IF (SLOPETYP .GT. DEFINED_SLOPE) THEN<a name='3281'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#REDPRM_USGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_188">( 'Warning: to many slope types' )<a name='3282'>
      END IF<a name='3283'>
<a name='3284'>
<font color=#447700>!  SET-UP UNIVERSAL PARAMETERS<a name='3285'></font>
<font color=#447700>! (NOT DEPENDENT ON SOILTYP, VEGTYP OR SLOPETYP)<a name='3286'></font>
      ZBOT   = ZBOT_DATA<a name='3287'>
      SALP   = SALP_DATA<a name='3288'>
      CFACTR = CFACTR_DATA<a name='3289'>
      CMCMAX = CMCMAX_DATA<a name='3290'>
      SBETA  = SBETA_DATA<a name='3291'>
      RSMAX  = RSMAX_DATA<a name='3292'>
      TOPT   = TOPT_DATA<a name='3293'>
      REFDK  = REFDK_DATA<a name='3294'>
      FRZK   = FRZK_DATA<a name='3295'>
      FXEXP  = FXEXP_DATA<a name='3296'>
      REFKDT = REFKDT_DATA<a name='3297'>
      CZIL   = CZIL_DATA<a name='3298'>
      CSOIL  = CSOIL_DATA<a name='3299'>
<a name='3300'>
<font color=#447700>!  SET-UP SOIL PARAMETERS<a name='3301'></font>
      B       = BB(SOILTYP)<a name='3302'>
      SMCDRY  = DRYSMC(SOILTYP)<a name='3303'>
      F1      = F11(SOILTYP)<a name='3304'>
      SMCMAX  = MAXSMC(SOILTYP)<a name='3305'>
      SMCREF  = REFSMC(SOILTYP)<a name='3306'>
      PSISAT  = SATPSI(SOILTYP)<a name='3307'>
      DKSAT   = SATDK(SOILTYP)<a name='3308'>
      DWSAT   = SATDW(SOILTYP)<a name='3309'>
      SMCWLT  = WLTSMC(SOILTYP)<a name='3310'>
      QUARTZ  = QTZ(SOILTYP)<a name='3311'>
      FRZFACT = (SMCMAX / SMCREF) * (0.412 / 0.468)<a name='3312'>
      KDT     = REFKDT * DKSAT/REFDK<a name='3313'>
<a name='3314'>
<font color=#447700>!  TO ADJUST FRZK PARAMETER TO ACTUAL SOIL TYPE: FRZK * FRZFACT<a name='3315'></font>
<a name='3316'>
      FRZX = FRZK * FRZFACT<a name='3317'>
<a name='3318'>
<font color=#447700>!  SET-UP VEGETATION PARAMETERS<a name='3319'></font>
      NROOT = NROOT_DATA(VEGTYP)<a name='3320'>
      SNUP  = SNUPX(VEGTYP)<a name='3321'>
      RCMIN = RSMTBL(VEGTYP)<a name='3322'>
      RGL   = RGLTBL(VEGTYP)<a name='3323'>
      HS    = HSTBL(VEGTYP)<a name='3324'>
      Z0    = Z0_DATA(VEGTYP)<a name='3325'>
      LAI   = LAI_DATA(VEGTYP)<a name='3326'>
      IF(VEGTYP .EQ. BARE) SHDFAC = 0.0<a name='3327'>
<a name='3328'>
      IF (NROOT .GT. NSOIL) THEN<a name='3329'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#REDPRM_USGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_189">( 'Warning: too many root layers') <a name='3330'>
      END IF<a name='3331'>
<a name='3332'>
<font color=#447700>!  CALCULATE ROOT DISTRIBUTION<a name='3333'></font>
<font color=#447700>!  PRESENT VERSION ASSUMES UNIFORM DISTRIBUTION BASED ON SOIL LAYERS<a name='3334'></font>
<a name='3335'>
      DO I=1,NROOT<a name='3336'>
         RTDIS(I) = -SLDPTH(I)/ZSOIL(NROOT)<a name='3337'>
      END DO<a name='3338'>
<a name='3339'>
<font color=#447700>!  SET-UP SLOPE PARAMETER<a name='3340'></font>
      SLOPE = SLOPE_DATA(SLOPETYP)<a name='3341'>
<font color=#447700>!<a name='3342'></font>
      END SUBROUTINE REDPRM_USGS<a name='3343'>
<a name='3344'>
<font color=#447700>!--------------------------------------------------------------------!<a name='3345'></font>
<a name='3346'>
<a name='3347'>
<A NAME='ROSR12'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#ROSR12' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3348'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>ROSR12</font> ( P, A, B, C, D, DELTA, NSOIL) <A href='../../call_to/ROSR12.html' TARGET='index'>4</A><a name='3349'>
<a name='3350'>
      IMPLICIT NONE<a name='3351'>
<a name='3352'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3353'></font>
<font color=#447700>!C    PURPOSE:  TO INVERT (SOLVE) THE TRI-DIAGONAL MATRIX PROBLEM SHOWN<a name='3354'></font>
<font color=#447700>!C    =======   BELOW:<a name='3355'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3356'></font>
<a name='3357'>
      INTEGER K<a name='3358'>
      INTEGER KK<a name='3359'>
      INTEGER NSOIL<a name='3360'>
      <a name='3361'>
      REAL P     (NSOIL)<a name='3362'>
      REAL A     (NSOIL)<a name='3363'>
      REAL B     (NSOIL)<a name='3364'>
      REAL C     (NSOIL)<a name='3365'>
      REAL D     (NSOIL)<a name='3366'>
      REAL DELTA (NSOIL)<a name='3367'>
      <a name='3368'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3369'></font>
<font color=#447700>!     INITIALIZE EQN COEF C FOR THE LOWEST SOIL LAYER.<a name='3370'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3371'></font>
<a name='3372'>
      C(NSOIL) = 0.0<a name='3373'>
<a name='3374'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3375'></font>
<font color=#447700>!     SOLVE THE COEFS FOR THE 1ST SOIL LAYER<a name='3376'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3377'></font>
<a name='3378'>
      P(1) = -C(1) / B(1)<a name='3379'>
      DELTA(1) = D(1) / B(1)<a name='3380'>
<a name='3381'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3382'></font>
<font color=#447700>!     SOLVE THE COEFS FOR SOIL LAYERS 2 THRU NSOIL<a name='3383'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3384'></font>
<a name='3385'>
      DO K = 2 , NSOIL<a name='3386'>
        P(K) = -C(K) * ( 1.0 / (B(K) + A (K) * P(K-1)) )<a name='3387'>
        DELTA(K) = (D(K)-A(K)*DELTA(K-1))*(1.0/(B(K)+A(K)*P(K-1)))<a name='3388'>
      END Do<a name='3389'>
<a name='3390'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3391'></font>
<font color=#447700>!     SET P TO DELTA FOR LOWEST SOIL LAYER.<a name='3392'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3393'></font>
<a name='3394'>
      P(NSOIL) = DELTA(NSOIL)<a name='3395'>
<a name='3396'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3397'></font>
<font color=#447700>!     ADJUST P FOR SOIL LAYERS 2 THRU NSOIL<a name='3398'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3399'></font>
<a name='3400'>
      DO K = 2 , NSOIL<a name='3401'>
         KK = NSOIL - K + 1<a name='3402'>
         P(KK) = P(KK) * P(KK+1) + DELTA(KK)<a name='3403'>
      END DO<a name='3404'>
<a name='3405'>
      END SUBROUTINE ROSR12<a name='3406'>
<a name='3407'>
<A NAME='SHFLX'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SHFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3408'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SHFLX</font>(S,STC,SMC,SMCMAX,NSOIL,T1,DT,YY,ZZ1,ZSOIL,TBOT, &amp; <A href='../../call_to/SHFLX.html' TARGET='index'>4</A>,<A href='../../call_from/SHFLX.html' TARGET='index'>8</A><a name='3409'>
           ZBOT, SMCWLT, PSISAT, SH2O, B,F1,DF1,ICE,QUARTZ,CSOIL)<a name='3410'>
      <a name='3411'>
      IMPLICIT NONE<a name='3412'>
      <a name='3413'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3414'></font>
<font color=#447700>!C    PURPOSE:  UPDATE THE TEMPERATURE STATE OF THE SOIL COLUMN BASED ON<a name='3415'></font>
<font color=#447700>!C              THE THERMAL DIFFUSION EQUATION AND UPDATE THE FROZEN SOIL<a name='3416'></font>
<font color=#447700>!C              MOISTURE CONTENT BASED ON THE TEMPERATURE.<a name='3417'></font>
<font color=#447700>!C      <a name='3418'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3419'></font>
<a name='3420'>
      INTEGER NSOLD<a name='3421'>
      PARAMETER ( NSOLD = 20 )<a name='3422'>
<font color=#447700>!tst      PARAMETER ( NSOLD = 4 )<a name='3423'></font>
<a name='3424'>
      INTEGER I<a name='3425'>
      INTEGER ICE<a name='3426'>
      INTEGER IFRZ<a name='3427'>
      INTEGER NSOIL<a name='3428'>
<a name='3429'>
      REAL B<a name='3430'>
      REAL DF1<a name='3431'>
      REAL CSOIL<a name='3432'>
      REAL DT<a name='3433'>
      REAL F1<a name='3434'>
      REAL PSISAT<a name='3435'>
      REAL QUARTZ<a name='3436'>
<font color=#447700>!believewrong      REAL RHSTS ( NSOLD )<a name='3437'></font>
      REAL RHSTS ( NSOIL )<a name='3438'>
      REAL S<a name='3439'>
      REAL SMC   ( NSOIL )<a name='3440'>
      REAL SH2O  ( NSOIL )<a name='3441'>
      REAL SMCMAX<a name='3442'>
      REAL SMCWLT<a name='3443'>
      REAL STC	(NSOIL)<a name='3444'>
      REAL STCF	(NSOLD)<a name='3445'>
      REAL T0<a name='3446'>
      REAL T1<a name='3447'>
      REAL TBOT<a name='3448'>
      REAL ZBOT<a name='3449'>
      REAL YY<a name='3450'>
      REAL ZSOIL ( NSOIL )<a name='3451'>
      REAL ZZ1<a name='3452'>
<a name='3453'>
<font color=#447700>!tmp<a name='3454'></font>
	REAL STCWAS<a name='3455'>
<font color=#447700>!tmp<a name='3456'></font>
<a name='3457'>
      PARAMETER ( T0 = 273.15)<a name='3458'>
<a name='3459'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3460'></font>
<font color=#447700>!     HRT ROUTINE CALCS THE RIGHT HAND SIDE OF THE SOIL TEMP DIF EQN<a name='3461'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3462'></font>
<a name='3463'>
<font color=#447700>!<a name='3464'></font>
	STCWAS=STC(1)<a name='3465'>
<font color=#447700>!<a name='3466'></font>
<a name='3467'>
      IF(ICE.EQ.1) THEN<a name='3468'>
<a name='3469'>
<font color=#447700>!..SEA-ICE CASE<a name='3470'></font>
<a name='3471'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#HRTICE'>HRTICE</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HRTICE_1">(RHSTS,STC,NSOIL,ZSOIL,YY,ZZ1,DF1)<a name='3472'>
<a name='3473'>
	if (minval(RHSTS) .lt. -100.) then<a name='3474'>
	write(0,*) 'small RHSTS in seaice branch: ', RHSTS(1)<a name='3475'>
	endif<a name='3476'>
<a name='3477'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#HSTEP'>HSTEP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HSTEP_1"> (STCF,STC,RHSTS,DT,NSOIL)<a name='3478'>
         <a name='3479'>
      ELSE<a name='3480'>
<a name='3481'>
<font color=#447700>!..LAND-MASS CASE<a name='3482'></font>
<a name='3483'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT'>HRT</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HRT_1">(RHSTS,STC,SMC,SMCMAX,NSOIL,ZSOIL,YY,ZZ1,TBOT, &amp;<a name='3484'>
              ZBOT, PSISAT, SH2O, DT,                           &amp;<a name='3485'>
              B,F1,DF1,QUARTZ,CSOIL)<a name='3486'>
<a name='3487'>
	if (DT*RHSTS(1) .lt. -100.) then<a name='3488'>
	write(0,*) 'crazy RHSTS returned from HRT: ', RHSTS<a name='3489'>
	endif<a name='3490'>
<a name='3491'>
         <a name='3492'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#HSTEP'>HSTEP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HSTEP_2">(STCF,STC,RHSTS,DT,NSOIL)<a name='3493'>
<a name='3494'>
	if (RHSTS(1) .lt. -100.) then<a name='3495'>
<font color=#447700>!	write(0,*) 'crazy RHSTS returned from HSTEP: ', RHSTS<a name='3496'></font>
	endif<a name='3497'>
<a name='3498'>
      ENDIF<a name='3499'>
<a name='3500'>
      DO I = 1,NSOIL<a name='3501'>
         STC(I)  = STCF(I)<a name='3502'>
      END DO<a name='3503'>
      <a name='3504'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3505'></font>
<font color=#447700>!     IN THE NO SNOWPACK CASE (VIA ROUTINE NOPAC BRANCH,) UPDATE THE<a name='3506'></font>
<font color=#447700>!     GRND (SKIN) TEMPERATURE HERE IN RESPONSE TO THE UPDATED SOIL <a name='3507'></font>
<font color=#447700>!     TEMPERATURE PROFILE ABOVE.<a name='3508'></font>
<font color=#447700>! (NOTE: INSPECTION OF ROUTINE SNOPAC SHOWS THAT T1 BELOW IS A DUMMY<a name='3509'></font>
<font color=#447700>!     VARIABLE ONLY, AS SKIN TEMPERATURE IS UPDATED DIFFERENTLY<a name='3510'></font>
<font color=#447700>!     IN ROUTINE SNOPAC) <a name='3511'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3512'></font>
      <a name='3513'>
      T1 = (YY + (ZZ1 - 1.0) * STC(1)) / ZZ1<a name='3514'>
<a name='3515'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3516'></font>
<font color=#447700>!     CALC THE SFC SOIL HEAT FLUX<a name='3517'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3518'></font>
<a name='3519'>
<font color=#447700>!      S = DF1 * (STC(1) - T1) / (0.5 * ZSOIL(1))<a name='3520'></font>
<a name='3521'>
	if (STC(1) .lt. 230 .and. STCWAS .gt. 230) then<a name='3522'>
<font color=#447700>!	write(0,*) 'ICE, STC(1) was, is: ',ICE, STCWAS, STC(1)<a name='3523'></font>
<font color=#447700>!	write(0,*) 'RHSTS in SHFLX: ', RHSTS<a name='3524'></font>
	endif<a name='3525'>
<a name='3526'>
      END SUBROUTINE SHFLX<a name='3527'>
<a name='3528'>
<A NAME='SMFLX'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SMFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3529'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SMFLX</font> ( ETA1,SMC,NSOIL,CMC,ETP1,DT,PRCP1,ZSOIL,  &amp; <A href='../../call_to/SMFLX.html' TARGET='index'>6</A>,<A href='../../call_from/SMFLX.html' TARGET='index'>13</A><a name='3530'>
           SH2O, SLOPE, KDT, FRZFACT,                             &amp;<a name='3531'>
           SMCMAX,B,PC,SMCWLT,DKSAT,DWSAT,SMCREF,SHDFAC,CMCMAX,   &amp;<a name='3532'>
           SMCDRY,CFACTR, RUNOFF1,RUNOFF2, RUNOFF3, EDIR1, EC1,   &amp;<a name='3533'>
           ETT1, SFCTMP,Q2,NROOT,RTDIS, FXEXP)<a name='3534'>
<a name='3535'>
<a name='3536'>
      IMPLICIT NONE<a name='3537'>
<a name='3538'>
<font color=#447700>! ------------    FROZEN GROUND VERSION    --------------------------<a name='3539'></font>
<font color=#447700>!   NEW STATES ADDED: SH2O, AND FROZEN GROUD CORRECTION FACTOR, FRZFACT<a name='3540'></font>
<font color=#447700>!   AND PARAMETER SLOPE <a name='3541'></font>
<font color=#447700>!<a name='3542'></font>
<a name='3543'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3544'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE SOIL MOISTURE FLUX.  THE SOIL MOISTURE<a name='3545'></font>
<font color=#447700>!C    =======   CONTENT (SMC - A PER UNIT VOLUME MEASUREMENT) IS A<a name='3546'></font>
<font color=#447700>!C              DEPENDENT VARIABLE THAT IS UPDATED WITH PROGNOSTIC EQNS.<a name='3547'></font>
<font color=#447700>!C              THE CANOPY MOISTURE CONTENT (CMC) IS ALSO UPDATED.<a name='3548'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3549'></font>
 <a name='3550'>
      INTEGER NSOLD<a name='3551'>
      PARAMETER ( NSOLD = 20 )<a name='3552'>
<font color=#447700>!tst      PARAMETER ( NSOLD = 4 )<a name='3553'></font>
      INTEGER K<a name='3554'>
      INTEGER NSOIL<a name='3555'>
      REAL B<a name='3556'>
      REAL BETA<a name='3557'>
      REAL CFACTR<a name='3558'>
      REAL CMC<a name='3559'>
      REAL CMCMAX<a name='3560'>
      REAL DEW<a name='3561'>
      REAL DKSAT<a name='3562'>
      REAL DRIP<a name='3563'>
      REAL DT<a name='3564'>
      REAL DWSAT<a name='3565'>
      REAL EC<a name='3566'>
      REAL EDIR<a name='3567'>
      REAL ET     ( NSOLD )<a name='3568'>
      REAL ETA1<a name='3569'>
      REAL ETP1<a name='3570'>
      REAL ETT<a name='3571'>
      REAL EXCESS<a name='3572'>
      REAL FXEXP<a name='3573'>
      REAL FLX1<a name='3574'>
      REAL FLX2<a name='3575'>
      REAL FLX3<a name='3576'>
      REAL KDT<a name='3577'>
      REAL PC<a name='3578'>
      REAL PCPDRP<a name='3579'>
      REAL PRCP1<a name='3580'>
      REAL RHSCT<a name='3581'>
      REAL RHSTT  ( NSOLD )<a name='3582'>
      REAL RIB<a name='3583'>
      REAL RTDIS (NSOIL)<a name='3584'>
      REAL RUNOF<a name='3585'>
      REAL RUNOFF,RUNOXX3<a name='3586'>
      REAL SHDFAC<a name='3587'>
      REAL SMC    ( NSOIL )<a name='3588'>
<a name='3589'>
<font color=#447700>! ---------------    FROZEN GROUND VERSION     ---------------------<a name='3590'></font>
      <a name='3591'>
      REAL SH2O   ( NSOIL )<a name='3592'>
      REAL SICE   ( NSOLD )<a name='3593'>
      REAL SH2OA  ( NSOLD )<a name='3594'>
      REAL SH2OFG ( NSOLD )<a name='3595'>
<a name='3596'>
<font color=#447700>!tst<a name='3597'></font>
	REAL SH2Oold,SICEold<a name='3598'>
<font color=#447700>!tst<a name='3599'></font>
<font color=#447700>! -------------------------------------------------------------------<a name='3600'></font>
           <a name='3601'>
      REAL SMCDRY<a name='3602'>
      REAL SMCMAX<a name='3603'>
      REAL SMCREF<a name='3604'>
      REAL SMCWLT<a name='3605'>
      REAL TRHSCT<a name='3606'>
      REAL ZSOIL  ( NSOIL )<a name='3607'>
<a name='3608'>
<font color=#447700>! Temperature criteria for snowfall TFREEZ should have <a name='3609'></font>
<font color=#447700>! same value as in SFLX.f<a name='3610'></font>
      REAL TFREEZ<a name='3611'>
      PARAMETER (TFREEZ = 273.15)<a name='3612'>
<a name='3613'>
      REAL SLOPE, FRZFACT, RUNOFF1, RUNOFF2, RUNOFF3, EDIR1, EC1<a name='3614'>
      REAL ETT1, SFCTMP, Q2, DUMMY, CMC2MS<a name='3615'>
<a name='3616'>
      INTEGER NROOT, I<a name='3617'>
      real ai,bi,ci<a name='3618'>
<a name='3619'>
      COMMON/RITE/ BETA,DRIP,EC,EDIR,ETT,FLX1,FLX2,FLX3,RUNOF,  &amp;<a name='3620'>
           DEW,RIB,RUNOXX3<a name='3621'>
      COMMON /ABCI/ AI(NSOLD), BI(NSOLD), CI(NSOLD)<a name='3622'>
<a name='3623'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3624'></font>
<font color=#447700>!     EXECUTABLE CODE BEGINS HERE....IF THE POTENTIAL EVAPOTRANS-<a name='3625'></font>
<font color=#447700>!     PIRATION IS GREATER THAN ZERO...<a name='3626'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3627'></font>
      DUMMY=0.<a name='3628'>
      EDIR = 0.<a name='3629'>
      EC = 0.<a name='3630'>
      ETT = 0.<a name='3631'>
      DO K = 1, NSOIL<a name='3632'>
         ET ( K ) = 0.<a name='3633'>
      END DO<a name='3634'>
      <a name='3635'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3636'></font>
      IF ( ETP1 .GT. 0.0 ) THEN<a name='3637'>
<a name='3638'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3639'></font>
<font color=#447700>!       RETRIEVE DIRECT EVAPORATION FROM SOIL SURFACE<a name='3640'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3641'></font>
<a name='3642'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3643'></font>
<font color=#447700>! call this function only if veg cover not complete<a name='3644'></font>
<font color=#447700>! --------------     FROZEN GROUND VERSION     ---------------------<a name='3645'></font>
<font color=#447700>!   SMC STATES WERE REPLACED BY SH2O STATES<a name='3646'></font>
<font color=#447700>!<a name='3647'></font>
        IF (SHDFAC .LT. 1.) THEN<a name='3648'>
          EDIR = DEVAP ( ETP1, SH2O(1), ZSOIL(1), SHDFAC, SMCMAX,  &amp;<a name='3649'>
            B, DKSAT, DWSAT, SMCDRY,SMCREF, SMCWLT, FXEXP)<a name='3650'>
        ENDIF<a name='3651'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3652'></font>
<font color=#447700>!       INITIALIZE PLANT TOTAL TRANSPIRATION, RETRIEVE PLANT<a name='3653'></font>
<font color=#447700>!       TRANSPIRATION, AND ACCUMULATE IT FOR ALL SOIL LAYERS.<a name='3654'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3655'></font>
<a name='3656'>
<font color=#447700>!        ETT = 0.<a name='3657'></font>
         <a name='3658'>
        IF(SHDFAC.GT.0.0) THEN<a name='3659'>
        <a name='3660'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3661'></font>
<font color=#447700>! --------------     FROZEN GROUND VERSION     ---------------------<a name='3662'></font>
<font color=#447700>!   SMC STATES WERE REPLACED BY SH2O STATES<a name='3663'></font>
<font color=#447700>!<a name='3664'></font>
          CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TRANSP'>TRANSP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRANSP_1"> ( ET,NSOIL,ETP1,SH2O,CMC,ZSOIL,SHDFAC,SMCWLT,  &amp;<a name='3665'>
            CMCMAX,PC,CFACTR,SMCREF,SFCTMP,Q2,NROOT,RTDIS)<a name='3666'>
          <a name='3667'>
          DO K = 1 , NSOIL<a name='3668'>
            ETT = ETT + ET ( K )<a name='3669'>
          END DO<a name='3670'>
<font color=#447700>! move this ENDIF after canopy evap calcs since CMC=0 for SHDFAC=0<a name='3671'></font>
<font color=#447700>!        ENDIF<a name='3672'></font>
<a name='3673'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3674'></font>
<font color=#447700>!       CALCULATE CANOPY EVAPORATION<a name='3675'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3676'></font>
<font color=#447700>!cc If statements to avoid TANGENT LINEAR problems near CMC=zero<a name='3677'></font>
          IF (CMC .GT. 0.0) THEN<a name='3678'>
            EC = SHDFAC * ( ( CMC / CMCMAX ) ** CFACTR ) * ETP1<a name='3679'>
          ELSE<a name='3680'>
            EC = 0.0<a name='3681'>
          ENDIF<a name='3682'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3683'></font>
<font color=#447700>!########  EC SHOULD BE LIMITED BY THE TOTAL AMOUNT OF AVAILABLE<a name='3684'></font>
<font color=#447700>!          WATER ON THE CANOPY. MODIFIED BY F.CHEN ON 10/18/94<a name='3685'></font>
<font color=#447700>!########<a name='3686'></font>
          CMC2MS = CMC / DT<a name='3687'>
          EC = MIN ( CMC2MS, EC )<a name='3688'>
        ENDIF<a name='3689'>
      ENDIF<a name='3690'>
<a name='3691'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3692'></font>
<font color=#447700>!     TOTAL UP EVAP AND TRANSP TYPES TO OBTAIN ACTUAL EVAPOTRANSP<a name='3693'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3694'></font>
      EDIR1=EDIR<a name='3695'>
      EC1=EC<a name='3696'>
      ETT1=ETT<a name='3697'>
      <a name='3698'>
      ETA1 = EDIR + ETT + EC<a name='3699'>
      <a name='3700'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3701'></font>
<font color=#447700>!     COMPUTE THE RIGHT HAND SIDE OF THE CANOPY EQN TERM ( RHSCT )<a name='3702'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3703'></font>
<a name='3704'>
      RHSCT = SHDFAC * PRCP1 - EC<a name='3705'>
<a name='3706'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3707'></font>
<font color=#447700>!     CONVERT RHSCT (A RATE) TO TRHSCT (AN AMT) AND ADD IT TO EXISTING<a name='3708'></font>
<font color=#447700>!     CMC. IF RESULTING AMT EXCEEDS MAX CAPACITY, IT BECOMES DRIP<a name='3709'></font>
<font color=#447700>!     AND WILL FALL TO THE GRND.<a name='3710'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3711'></font>
<a name='3712'>
      DRIP = 0.<a name='3713'>
      TRHSCT = DT * RHSCT<a name='3714'>
      EXCESS =  CMC + TRHSCT<a name='3715'>
      IF ( EXCESS .GT. CMCMAX ) DRIP = EXCESS - CMCMAX<a name='3716'>
<a name='3717'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3718'></font>
<font color=#447700>!     PCPDRP IS THE COMBINED PRCP1 AND DRIP (FROM CMC) THAT<a name='3719'></font>
<font color=#447700>!     GOES INTO THE SOIL<a name='3720'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3721'></font>
<a name='3722'>
      PCPDRP = (1. - SHDFAC) * PRCP1 + DRIP / DT<a name='3723'>
<a name='3724'>
<font color=#447700>!      PRINT*,' ################ SMLX ##################'<a name='3725'></font>
<font color=#447700>!      PRINT*,' PCPDRP=', PCPDRP, ' EDIR=', EDIR,' ET=', ET,<a name='3726'></font>
<font color=#447700>!     *      'SMC(1)=', SMC(1), 'SMC(2)=', SMC(2), ' PRCP1=', PRCP1,<a name='3727'></font>
<font color=#447700>!     *      'DRIP = ', DRIP / DT<a name='3728'></font>
<a name='3729'>
<font color=#447700>! ---------------     FROZEN GROUND VERSION     --------------------<a name='3730'></font>
<font color=#447700>!    STORE ICE CONTENT AT EACH SOIL LAYER BEFORE CALLING SRT &amp; SSTEP<a name='3731'></font>
<font color=#447700>!<a name='3732'></font>
      DO I = 1,NSOIL<a name='3733'>
	if (SH2O(I) .lt. 0) then<a name='3734'>
	write(0,*) 'neg SH2O in SICE calc: ', SH2O(I)<a name='3735'>
	endif<a name='3736'>
         SICE(I) = SMC(I) - SH2O(I)<a name='3737'>
      END DO<a name='3738'>
<font color=#447700>! ------------------------------------------------------------------<a name='3739'></font>
            <a name='3740'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3741'></font>
<font color=#447700>!     CALL SUBROUTINES SRT AND SSTEP TO SOLVE THE SOIL MOISTURE<a name='3742'></font>
<font color=#447700>!     TENDENCY EQUATIONS. <a name='3743'></font>
<font color=#447700>!<a name='3744'></font>
<font color=#447700>!  IF THE INFILTRATING PRECIP RATE IS NONTRIVIAL,<a name='3745'></font>
<font color=#447700>!<a name='3746'></font>
<font color=#447700>!    (WE CONSIDER NONTRIVIAL TO BE A PRECIP TOTAL OVER THE TIME STEP <a name='3747'></font>
<font color=#447700>!     EXCEEDING ONE ONE-THOUSANDTH OF THE WATER HOLDING CAPACITY OF <a name='3748'></font>
<font color=#447700>!     THE FIRST SOIL LAYER)<a name='3749'></font>
<font color=#447700>! <a name='3750'></font>
<font color=#447700>!  THEN CALL THE SRT/SSTEP SUBROUTINE PAIR TWICE IN THE MANNER OF <a name='3751'></font>
<font color=#447700>!    TIME SCHEME "F" (IMPLICIT STATE, AVERAGED COEFFICIENT)<a name='3752'></font>
<font color=#447700>!    OF SECTION 2 OF KALNAY AND KANAMITSU (1988, MWR, VOL 116, <a name='3753'></font>
<font color=#447700>!    PAGES 1945-1958)TO MINIMIZE 2-DELTA-T OSCILLATIONS IN THE <a name='3754'></font>
<font color=#447700>!    SOIL MOISTURE VALUE OF THE TOP SOIL LAYER THAT CAN ARISE BECAUSE<a name='3755'></font>
<font color=#447700>!    OF THE EXTREME NONLINEAR DEPENDENCE OF THE SOIL HYDRAULIC <a name='3756'></font>
<font color=#447700>!    DIFFUSIVITY COEFFICIENT AND THE HYDRAULIC CONDUCTIVITY ON THE<a name='3757'></font>
<font color=#447700>!    SOIL MOISTURE STATE<a name='3758'></font>
<font color=#447700>!<a name='3759'></font>
<font color=#447700>!  OTHERWISE CALL THE SRT/SSTEP SUBROUTINE PAIR ONCE IN THE MANNER OF<a name='3760'></font>
<font color=#447700>!    TIME SCHEME "D" (IMPLICIT STATE, EXPLICIT COEFFICIENT) <a name='3761'></font>
<font color=#447700>!    OF SECTION 2 OF KALNAY AND KANAMITSU<a name='3762'></font>
<font color=#447700>!<a name='3763'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3764'></font>
<font color=#447700>!<a name='3765'></font>
<font color=#447700>! PCPDRP IS UNITS OF KG/M**2/S OR MM/S, ZSOIL IS NEGATIVE DEPTH IN M <a name='3766'></font>
<font color=#447700>!......IF ( PCPDRP .GT. 0.0 ) THEN<a name='3767'></font>
<a name='3768'>
      IF ( (PCPDRP*DT) .GT. (0.001*1000.0*(-ZSOIL(1))*SMCMAX) ) THEN<a name='3769'>
<a name='3770'>
<font color=#447700>! ---------------    FROZEN GROUND VERSION       ---------------------<a name='3771'></font>
<font color=#447700>!    SMC STATES REPLACED BY SH2O STATES IN SRT SUBR.<a name='3772'></font>
<font color=#447700>!    SH2O &amp; SICE STATES INCLUDED IN SSTEP SUBR.<a name='3773'></font>
<font color=#447700>!    FROZEN GROUND CORRECTION FACTOR, FRZFACT, ADDED<a name='3774'></font>
<font color=#447700>!    ALL WATER BALANCE CALCULATIONS USING UNFROZEN WATER<a name='3775'></font>
<font color=#447700>!<a name='3776'></font>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT'>SRT</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SRT_1"> ( RHSTT,RUNOFF,EDIR,ET,SH2O,SH2O,NSOIL,PCPDRP,ZSOIL, &amp;<a name='3777'>
              DWSAT,DKSAT,SMCMAX, B, RUNOFF1,                          &amp;<a name='3778'>
              RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZFACT, SICE)<a name='3779'>
         <a name='3780'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SSTEP'>SSTEP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSTEP_1"> ( SH2OFG,SH2O,DUMMY,RHSTT,RHSCT,DT,NSOIL,SMCMAX, &amp;<a name='3781'>
              CMCMAX, RUNOFF3, ZSOIL, SMC, SICE)<a name='3782'>
         <a name='3783'>
         DO K = 1, NSOIL<a name='3784'>
            SH2OA(K) = ( SH2O(K) + SH2OFG(K) ) * 0.5<a name='3785'>
         END DO<a name='3786'>
        <a name='3787'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT'>SRT</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SRT_2"> ( RHSTT,RUNOFF,EDIR,ET,SH2O,SH2OA,NSOIL,PCPDRP,ZSOIL, &amp;<a name='3788'>
              DWSAT,DKSAT,SMCMAX, B, RUNOFF1,                           &amp;<a name='3789'>
              RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZFACT, SICE)<a name='3790'>
         <a name='3791'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SSTEP'>SSTEP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSTEP_2"> ( SH2O,SH2O,CMC,RHSTT,RHSCT,DT,NSOIL,SMCMAX,        &amp;<a name='3792'>
              CMCMAX, RUNOFF3, ZSOIL,SMC,SICE)<a name='3793'>
         <a name='3794'>
      ELSE<a name='3795'>
<a name='3796'>
<a name='3797'>
	SH2Oold=SH2O(1)<a name='3798'>
        SICEold=SICE(1)<a name='3799'>
         <a name='3800'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT'>SRT</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SRT_3"> ( RHSTT,RUNOFF,EDIR,ET,SH2O,SH2O,NSOIL,PCPDRP,ZSOIL, &amp;<a name='3801'>
              DWSAT,DKSAT,SMCMAX, B, RUNOFF1,                          &amp;<a name='3802'>
              RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZFACT, SICE)<a name='3803'>
         <a name='3804'>
         <a name='3805'>
	if (SICE(1) + SH2O(1) .gt. 1.0) then<a name='3806'>
	write(0,*) 'bonus moisture into SSTEP'<a name='3807'>
	write(0,*) 'SH2Oold, SICEold: ', SH2Oold, SICEold<a name='3808'>
	write(0,*) 'SH2O(1), SICE(1): ', SH2O(1), SICE(1)<a name='3809'>
	endif<a name='3810'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SSTEP'>SSTEP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSTEP_3"> ( SH2O,SH2O,CMC,RHSTT,RHSCT,DT,NSOIL,SMCMAX,       &amp;<a name='3811'>
              CMCMAX, RUNOFF3, ZSOIL,SMC,SICE)<a name='3812'>
<a name='3813'>
	if (SH2O(1) .lt. 0) then<a name='3814'>
	write(0,*) 'neg SH2O AFTER SRT, SSTEP calls: ', SH2O(1)<a name='3815'>
	write(0,*) 'SH2O was: ', SH2Oold<a name='3816'>
	write(0,*) 'SMCMAX, SMCWLT, DWSAT, DKSAT:: ', SMCMAX, SMCWLT, DWSAT, DKSAT<a name='3817'>
	endif<a name='3818'>
         <a name='3819'>
      ENDIF<a name='3820'>
      <a name='3821'>
      RUNOF = RUNOFF<a name='3822'>
      END SUBROUTINE SMFLX<a name='3823'>
<a name='3824'>
<A NAME='SNOPAC'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SNOPAC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3825'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOPAC</font> (ETP,ETA,PRCP,PRCP1,SNOWNG,SMC,SMCMAX,SMCWLT, &amp; <A href='../../call_to/SNOPAC.html' TARGET='index'>2</A>,<A href='../../call_from/SNOPAC.html' TARGET='index'>7</A><a name='3826'>
        SMCREF, SMCDRY, CMC, CMCMAX, NSOIL, DT, SBETA, Q1, DF1,       &amp;<a name='3827'>
        Q2,T1,SFCTMP,T24,TH2,F,F1,S,STC,EPSCA,SFCPRS,                 &amp;<a name='3828'>
<font color=#447700>!        B, PC, RCH, RR, CFACTR, SALP, ESD,                           &amp;<a name='3829'></font>
        B, PC, RCH, RR, CFACTR, SNCOVER, ESD, SNDENS,                 &amp;<a name='3830'>
        SNOWH, SH2O, SLOPE, KDT, FRZFACT, PSISAT,SNUP,                &amp;<a name='3831'>
        ZSOIL, DWSAT, DKSAT, TBOT, ZBOT, SHDFAC, RUNOFF1,             &amp;<a name='3832'>
        RUNOFF2,RUNOFF3,EDIR1,EC1,ETT1,NROOT,SNMAX,ICE,               &amp;<a name='3833'>
        RTDIS,QUARTZ, FXEXP,CSOIL)<a name='3834'>
<a name='3835'>
      IMPLICIT NONE<a name='3836'>
<a name='3837'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3838'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE SOIL MOISTURE AND HEAT FLUX VALUES &amp; UPDATE<a name='3839'></font>
<font color=#447700>!C    =======   SOIL MOISTURE CONTENT AND SOIL HEAT CONTENT VALUES FOR<a name='3840'></font>
<font color=#447700>!C              THE CASE WHEN A SNOW PACK IS PRESENT.<a name='3841'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3842'></font>
<a name='3843'>
      INTEGER ICE<a name='3844'>
      INTEGER NROOT<a name='3845'>
      INTEGER NSOIL<a name='3846'>
<a name='3847'>
      LOGICAL SNOWNG<a name='3848'>
<a name='3849'>
      REAL B<a name='3850'>
      REAL BETA<a name='3851'>
      REAL CFACTR<a name='3852'>
      REAL CMC<a name='3853'>
      REAL CMCMAX<a name='3854'>
      REAL CP<a name='3855'>
      REAL CPH2O<a name='3856'>
      REAL CPICE<a name='3857'>
      REAL CSOIL<a name='3858'>
      REAL DENOM<a name='3859'>
      REAL DEW<a name='3860'>
      REAL DF1<a name='3861'>
      REAL DKSAT<a name='3862'>
      REAL DRIP<a name='3863'>
      REAL DSOIL<a name='3864'>
      REAL DTOT<a name='3865'>
      REAL DT<a name='3866'>
      REAL DWSAT<a name='3867'>
      REAL EC<a name='3868'>
      REAL EDIR<a name='3869'>
      REAL EPSCA<a name='3870'>
      REAL ESD<a name='3871'>
      REAL EXPSNO<a name='3872'>
      REAL EXPSOI<a name='3873'>
      REAL ETA<a name='3874'>
      REAL ETA1<a name='3875'>
      REAL ETP<a name='3876'>
      REAL ETP1<a name='3877'>
      REAL ETP2<a name='3878'>
      REAL ETT<a name='3879'>
      REAL EX<a name='3880'>
      REAL EXPFAC<a name='3881'>
      REAL F<a name='3882'>
      REAL FXEXP<a name='3883'>
      REAL FLX1<a name='3884'>
      REAL FLX2<a name='3885'>
      REAL FLX3<a name='3886'>
      REAL F1<a name='3887'>
      REAL KDT<a name='3888'>
      REAL LSUBF<a name='3889'>
      REAL LSUBC<a name='3890'>
      REAL LSUBS<a name='3891'>
      REAL PC<a name='3892'>
      REAL PRCP<a name='3893'>
      REAL PRCP1<a name='3894'>
      REAL Q1<a name='3895'>
      REAL Q2<a name='3896'>
      REAL RCH<a name='3897'>
      REAL RIB<a name='3898'>
      REAL RR<a name='3899'>
      REAL RTDIS   ( NSOIL )<a name='3900'>
      REAL RUNOFF<a name='3901'>
      REAL S<a name='3902'>
      REAL SBETA<a name='3903'>
      REAL S1<a name='3904'>
      REAL SFCTMP<a name='3905'>
      REAL SHDFAC<a name='3906'>
      REAL SIGMA<a name='3907'>
      REAL SMC     ( NSOIL )<a name='3908'>
      REAL SH2O    ( NSOIL )<a name='3909'>
      REAL SMCDRY<a name='3910'>
      REAL SMCMAX<a name='3911'>
      REAL SMCREF<a name='3912'>
      REAL SMCWLT<a name='3913'>
      REAL SNMAX<a name='3914'>
      REAL SNOWH<a name='3915'>
      REAL STC     ( NSOIL )<a name='3916'>
      REAL T1<a name='3917'>
      REAL T11<a name='3918'>
      REAL T12<a name='3919'>
      REAL T12A<a name='3920'>
      REAL T12B<a name='3921'>
      REAL T24<a name='3922'>
      REAL TBOT<a name='3923'>
      REAL ZBOT<a name='3924'>
      REAL TH2<a name='3925'>
      REAL YY<a name='3926'>
      REAL ZSOIL( NSOIL )<a name='3927'>
      REAL ZZ1<a name='3928'>
<a name='3929'>
<font color=#447700>!tst<a name='3930'></font>
	REAL STCWAS<a name='3931'>
<font color=#447700>!tst<a name='3932'></font>
<a name='3933'>
<font color=#447700>!<a name='3934'></font>
      REAL TFREEZ, SALP, SFCPRS, SLOPE, FRZFACT, PSISAT, SNUP<a name='3935'>
      REAL RUNOFF1, RUNOFF2, RUNOFF3,RUNOXX3<a name='3936'>
      REAL EDIR1, EC1, ETT1, QUARTZ<a name='3937'>
      REAL SNDENS, SNCOND, RSNOW, SNCOVER, QSAT, ETP3, SEH, T14<a name='3938'>
<a name='3939'>
      COMMON/RITE/ BETA,DRIP,EC,EDIR,ETT,FLX1,FLX2,FLX3,RUNOFF,  &amp;<a name='3940'>
        DEW,RIB,RUNOXX3<a name='3941'>
     <a name='3942'>
      PARAMETER(CP=1004.5,CPH2O=4.218E+3,CPICE=2.106E+3,         &amp;<a name='3943'>
        LSUBF=3.335E+5,LSUBC=2.501000E+6,LSUBS=2.83E+6,SIGMA=5.67E-8)<a name='3944'>
<a name='3945'>
      PARAMETER ( TFREEZ = 273.15)<a name='3946'>
<a name='3947'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3948'></font>
<font color=#447700>! EXECUTABLE CODE BEGINS HERE...<a name='3949'></font>
<font color=#447700>! CONVERT POTENTIAL EVAP (ETP) FROM KG M-2 S-1 TO M S-1 AND THEN TO AN<a name='3950'></font>
<font color=#447700>! AMOUNT (M) GIVEN TIMESTEP (DT) AND CALL IT AN EFFECTIVE SNOWPACK<a name='3951'></font>
<font color=#447700>! REDUCTION AMOUNT, ETP2 (M).  THIS IS THE AMOUNT THE SNOWPACK WOULD BE<a name='3952'></font>
<font color=#447700>! REDUCED DUE TO EVAPORATION FROM THE SNOW SFC DURING THE TIMESTEP.<a name='3953'></font>
<font color=#447700>! EVAPORATION WILL PROCEED AT THE POTENTIAL RATE UNLESS THE SNOW DEPTH<a name='3954'></font>
<font color=#447700>! IS LESS THAN THE EXPECTED SNOWPACK REDUCTION.<a name='3955'></font>
<font color=#447700>! IF SEAICE (ICE=1), BETA REMAINS=1.<a name='3956'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3957'></font>
      PRCP1 = PRCP1*0.001<a name='3958'>
<a name='3959'>
      ETP2 = ETP * 0.001 * DT<a name='3960'>
      BETA = 1.0<a name='3961'>
      IF(ICE .NE. 1) THEN<a name='3962'>
        IF (ESD .LT. ETP2) THEN<a name='3963'>
          BETA = ESD / ETP2<a name='3964'>
        ENDIF<a name='3965'>
      ENDIF<a name='3966'>
<a name='3967'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3968'></font>
<font color=#447700>! IF ETP&lt;0 (DOWNWARD) THEN DEWFALL (=FROSTFALL IN THIS CASE).<a name='3969'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3970'></font>
      DEW = 0.0<a name='3971'>
      IF (ETP .LT. 0.0) THEN<a name='3972'>
        DEW = -ETP * 0.001<a name='3973'>
      ENDIF<a name='3974'>
<a name='3975'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3976'></font>
<font color=#447700>! If precip is falling, calculate heat flux from snow sfc to newly<a name='3977'></font>
<font color=#447700>! accumulating precip.  Note that this reflects the flux appropriate for<a name='3978'></font>
<font color=#447700>! the not-yet-updated skin temperature (T1).  Assumes temperature of the<a name='3979'></font>
<font color=#447700>! snowfall striking the gound is =SFCTMP (lowest model level air temp).<a name='3980'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3981'></font>
      FLX1 = 0.0<a name='3982'>
      IF ( SNOWNG ) THEN<a name='3983'>
        FLX1 = CPICE * PRCP * ( T1 - SFCTMP )<a name='3984'>
      ELSE<a name='3985'>
        IF (PRCP .GT. 0.0) FLX1 = CPH2O * PRCP * (T1 - SFCTMP)<a name='3986'>
      ENDIF<a name='3987'>
      DSOIL = -(0.5 * ZSOIL(1))<a name='3988'>
      DTOT = SNOWH + DSOIL<a name='3989'>
<a name='3990'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3991'></font>
<font color=#447700>! Calculate an 'effective snow-grnd sfc temp' (T12) based on heat fluxes<a name='3992'></font>
<font color=#447700>! between the snow pack and the soil and on net radiation.<a name='3993'></font>
<font color=#447700>! Include FLX1 (precip-snow sfc) and FLX2 (freezing rain latent heat)<a name='3994'></font>
<font color=#447700>! fluxes.  FLX1 from above, FLX2 brought in via COMMOM block RITE.<a name='3995'></font>
<font color=#447700>! FLX2 reflects freezing rain latent heat flux using T1 calculated in<a name='3996'></font>
<font color=#447700>! PENMAN.<a name='3997'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3998'></font>
      DENOM = 1.0 + DF1 / ( DTOT * RR * RCH )<a name='3999'>
      T12A = ((F - FLX1 - FLX2 - SIGMA * T24) /                         &amp;<a name='4000'>
             RCH+TH2-SFCTMP-BETA*EPSCA) / RR<a name='4001'>
      T12B = DF1 * STC(1) / ( DTOT * RR * RCH )<a name='4002'>
      T12 = (SFCTMP + T12A + T12B ) / DENOM      <a name='4003'>
<a name='4004'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4005'></font>
<font color=#447700>! IF THE 'EFFECTIVE SNOW-GRND SFC TEMP' IS AT OR BELOW FREEZING, NO SNOW<a name='4006'></font>
<font color=#447700>! MELT WILL OCCUR.  SET THE SKIN TEMP TO THIS EFFECTIVE TEMP AND SET THE<a name='4007'></font>
<font color=#447700>! EFFECTIVE PRECIP TO ZERO.<a name='4008'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4009'></font>
      IF (T12 .LE. TFREEZ) THEN<a name='4010'>
        ESD = MAX(0.0, ESD-ETP2)<a name='4011'>
<a name='4012'>
<font color=#447700>!ggg    update snow depth.<a name='4013'></font>
        snowh = esd / sndens<a name='4014'>
<font color=#447700>!ggg<a name='4015'></font>
<a name='4016'>
        T1 = T12<a name='4017'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4018'></font>
<font color=#447700>! Update soil heat flux (S) using new skin temperature (T1)<a name='4019'></font>
        S = DF1 * ( T1 - STC(1) ) / ( DTOT )<a name='4020'>
        FLX3 = 0.0<a name='4021'>
        EX = 0.0<a name='4022'>
        SNMAX = 0.0<a name='4023'>
<a name='4024'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4025'></font>
<font color=#447700>! IF THE 'EFFECTIVE SNOW-GRND SFC TEMP' IS ABOVE FREEZING, SNOW MELT<a name='4026'></font>
<font color=#447700>! WILL OCCUR.  CALL THE SNOW MELT RATE,EX AND AMT, SNMAX.  REVISE THE<a name='4027'></font>
<font color=#447700>! EFFECTIVE SNOW DEPTH.  REVISE THE SKIN TEMP BECAUSE IT WOULD HAVE CHGD<a name='4028'></font>
<font color=#447700>! DUE TO THE LATENT HEAT RELEASED BY THE MELTING. CALC THE LATENT HEAT<a name='4029'></font>
<font color=#447700>! RELEASED, FLX3. SET THE EFFECTIVE PRECIP, PRCP1 TO THE SNOW MELT RATE,<a name='4030'></font>
<font color=#447700>! EX FOR USE IN SMFLX.  ADJUSTMENT TO T1 TO ACCOUNT FOR SNOW PATCHES.<a name='4031'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4032'></font>
      ELSE<a name='4033'>
<font color=#447700>!        IF ( (SNUP .GT. 0.0) .AND. (ESD .LT. SNUP) ) THEN<a name='4034'></font>
<font color=#447700>! turn off this block below since SNCOVER is calculated (as SNOFAC) in<a name='4035'></font>
<font color=#447700>! SFLX and now passed to SNOPAC<a name='4036'></font>
<font color=#447700>!        IF (ESD .LT. SNUP) THEN<a name='4037'></font>
<font color=#447700>!          RSNOW = ESD / SNUP<a name='4038'></font>
<font color=#447700>!          SNCOVER = 1.- (EXP(-SALP*RSNOW)-RSNOW*EXP(-SALP))<a name='4039'></font>
<font color=#447700>!        ELSE<a name='4040'></font>
<font color=#447700>!          SNCOVER = 1.<a name='4041'></font>
<font color=#447700>!        ENDIF  <a name='4042'></font>
        T1 = TFREEZ * SNCOVER + T12 * ( 1.0 - SNCOVER )<a name='4043'>
        QSAT = (0.622*6.11E2)/(SFCPRS-0.378*6.11E2)<a name='4044'>
        ETP = RCH*(QSAT-Q2)/CP<a name='4045'>
        ETP2 = ETP*0.001*DT<a name='4046'>
        BETA = 1.0<a name='4047'>
	<a name='4048'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4049'></font>
<font color=#447700>! IF POTENTIAL EVAP (SUBLIMATION) GREATER THAN DEPTH OF SNOWPACK.<a name='4050'></font>
<font color=#447700>! BETA&lt;1<a name='4051'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4052'></font>
        IF ( ESD .LE. ETP2 ) THEN<a name='4053'>
          BETA = ESD / ETP2<a name='4054'>
          ESD = 0.0<a name='4055'>
<a name='4056'>
<font color=#447700>!ggg      snow pack has sublimated, set depth to zero<a name='4057'></font>
          snowh = 0.0<a name='4058'>
<font color=#447700>!ggg<a name='4059'></font>
<a name='4060'>
          SNMAX = 0.0<a name='4061'>
          EX = 0.0<a name='4062'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4063'></font>
<font color=#447700>! Update soil heat flux (S) using new skin temperature (T1)<a name='4064'></font>
          S = DF1 * ( T1 - STC(1) ) / ( DTOT )<a name='4065'>
	  <a name='4066'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4067'></font>
<font color=#447700>! POTENTIAL EVAP (SUBLIMATION) LESS THAN DEPTH OF SNOWPACK, BETA=1.<a name='4068'></font>
<font color=#447700>! SNOWPACK (ESD) REDUCED BY POT EVAP RATE<a name='4069'></font>
<font color=#447700>! ETP3 (CONVERT TO FLUX)<a name='4070'></font>
<font color=#447700>! UPDATE SOIL HEAT FLUX BECAUSE T1 PREVIOUSLY CHANGED.<a name='4071'></font>
<font color=#447700>! SNOWMELT REDUCTION DEPENDING ON SNOW COVER<a name='4072'></font>
<font color=#447700>! IF SNOW COVER LESS THAN 5% NO SNOWMELT REDUCTION<a name='4073'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4074'></font>
        ELSE<a name='4075'>
<font color=#447700>!          ESD = MAX(0.0, ESD-ETP2)<a name='4076'></font>
          ESD = ESD-ETP2<a name='4077'>
<a name='4078'>
<font color=#447700>!ggg      snow pack reduced by sublimation, reduce snow depth<a name='4079'></font>
          snowh = esd / sndens<a name='4080'>
<font color=#447700>!ggg<a name='4081'></font>
<a name='4082'>
          ETP3 = ETP*LSUBC<a name='4083'>
          S = DF1 * ( T1 - STC(1) ) / ( DTOT )<a name='4084'>
          SEH = RCH*(T1-TH2)<a name='4085'>
          T14 = T1*T1<a name='4086'>
          T14 = T14*T14<a name='4087'>
          FLX3 = F - FLX1 - FLX2 - SIGMA*T14 - S - SEH - ETP3<a name='4088'>
          IF(FLX3.LE.0.0) FLX3=0.0<a name='4089'>
          EX = FLX3*0.001/LSUBF<a name='4090'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4091'></font>
<font color=#447700>! Does below fail to match the melt water with the melt energy?<a name='4092'></font>
          IF ( SNCOVER .GT. 0.05) EX = EX * SNCOVER<a name='4093'>
          SNMAX = EX * DT<a name='4094'>
        ENDIF<a name='4095'>
        <a name='4096'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4097'></font>
<font color=#447700>! SNMAX.LT.ESD<a name='4098'></font>
<font color=#447700>! ELSE<a name='4099'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4100'></font>
<font color=#447700>!        IF(SNMAX.LT.ESD) THEN<a name='4101'></font>
<font color=#447700>! The 1.E-6 value represents a snowpack depth threshold value (0.1 mm)<a name='4102'></font>
<font color=#447700>! below which we choose not to retain any snowpack, and instead include<a name='4103'></font>
<font color=#447700>! it in snowmelt.<a name='4104'></font>
        IF(SNMAX.LT.ESD-1.E-6) THEN<a name='4105'>
          ESD = ESD - SNMAX<a name='4106'>
<a name='4107'>
<font color=#447700>!ggg      snow melt reduced snow pack, reduce snow depth<a name='4108'></font>
          snowh = esd / sndens<a name='4109'>
<font color=#447700>!ggg<a name='4110'></font>
<a name='4111'>
        ELSE<a name='4112'>
          EX = ESD/DT<a name='4113'>
          SNMAX = ESD<a name='4114'>
          ESD = 0.0<a name='4115'>
<a name='4116'>
<font color=#447700>!ggg      snow melt exceeds snow depth<a name='4117'></font>
          snowh = 0.0<a name='4118'>
<font color=#447700>!ggg<a name='4119'></font>
<a name='4120'>
          FLX3 = EX*1000.0*LSUBF<a name='4121'>
        ENDIF<a name='4122'>
        PRCP1 = PRCP1 + EX<a name='4123'>
<a name='4124'>
      ENDIF<a name='4125'>
         <a name='4126'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4127'></font>
<font color=#447700>! SET THE EFFECTIVE POTNL EVAPOTRANSP (ETP1) TO ZERO SINCE SNOW CASE SO<a name='4128'></font>
<font color=#447700>! SURFACE EVAP NOT CALCULATED FROM EDIR, EC, OR ETT IN SMFLX (BELOW).<a name='4129'></font>
<font color=#447700>! IF SEAICE (ICE=1) SKIP CALL TO SMFLX.<a name='4130'></font>
<font color=#447700>! SMFLX RETURNS SOIL MOISTURE VALUES AND PRELIMINARY VALUES OF<a name='4131'></font>
<font color=#447700>! EVAPOTRANSPIRATION.  IN THIS, THE SNOW PACK CASE, THE PRELIM VALUES<a name='4132'></font>
<font color=#447700>! (ETA1) ARE NOT USED IN SUBSEQUENT CALCULATION OF EVAP.<a name='4133'></font>
<font color=#447700>! NEW STATES ADDED: SH2O, AND FROZEN GROUND CORRECTION FACTOR<a name='4134'></font>
<font color=#447700>! EVAP EQUALS POTENTIAL EVAP UNLESS BETA&lt;1.<a name='4135'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4136'></font>
      ETP1 = 0.0<a name='4137'>
      IF (ICE .NE. 1) THEN<a name='4138'>
	if (SH2O(1) .lt. 0) then<a name='4139'>
	write(0,*) 'call SMFLX with neg SH2O:: ', SH2O(1)<a name='4140'>
	endif<a name='4141'>
        CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX'>SMFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMFLX_3"> ( ETA1,SMC,NSOIL,CMC,ETP1,DT,PRCP1,ZSOIL,            &amp;<a name='4142'>
          SH2O, SLOPE, KDT, FRZFACT,                                    &amp;<a name='4143'>
          SMCMAX,B,PC,SMCWLT,DKSAT,DWSAT,                               &amp;<a name='4144'>
          SMCREF,SHDFAC,CMCMAX,SMCDRY,CFACTR,RUNOFF1,RUNOFF2,           &amp;<a name='4145'>
          RUNOFF3, EDIR1, EC1, ETT1,SFCTMP,Q2,NROOT,RTDIS,              &amp;<a name='4146'>
          FXEXP)<a name='4147'>
	if (SH2O(1) .lt. 0) then<a name='4148'>
	write(0,*) 'return SMFLX with neg SH2O:: ', SH2O(1)<a name='4149'>
	endif<a name='4150'>
<a name='4151'>
      ENDIF<a name='4152'>
      ETA = BETA*ETP<a name='4153'>
<a name='4154'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4155'></font>
<font color=#447700>! THE 'ADJUSTED TOP SOIL LYR TEMP' (YY) AND THE 'ADJUSTED SOIL HEAT<a name='4156'></font>
<font color=#447700>! FLUX' (ZZ1) ARE SET TO THE TOP SOIL LYR TEMP, AND 1, RESPECTIVELY.<a name='4157'></font>
<font color=#447700>! THESE ARE CLOSE-ENOUGH APPROXIMATIONS BECAUSE THE SFC HEAT FLUX TO BE<a name='4158'></font>
<font color=#447700>! COMPUTED IN SHFLX WILL EFFECTIVELY BE THE FLUX AT THE SNOW TOP<a name='4159'></font>
<font color=#447700>! SURFACE.  T11 IS A DUMMY ARGUEMENT SINCE WE WILL NOT USE ITS VALUE AS<a name='4160'></font>
<font color=#447700>! REVISED BY SHFLX.<a name='4161'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4162'></font>
      ZZ1 = 1.0<a name='4163'>
      YY = STC(1)-0.5*S*ZSOIL(1)*ZZ1/DF1<a name='4164'>
<a name='4165'>
	if (YY .lt. 200) then<a name='4166'>
<font color=#447700>!	write(0,*) 'computed YY= ', YY<a name='4167'></font>
<font color=#447700>!	write(0,*) 'STC(1),S,ZSOIL(1),DF1: ', STC(1),S,ZSOIL(1),DF1<a name='4168'></font>
	endif<a name='4169'>
<a name='4170'>
<a name='4171'>
<font color=#447700>!<a name='4172'></font>
      T11 = T1<a name='4173'>
<a name='4174'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4175'></font>
<font color=#447700>! SHFLX WILL CALC/UPDATE THE SOIL TEMPS.  NOTE:  THE SUB-SFC HEAT FLUX <a name='4176'></font>
<font color=#447700>! (S1) AND THE SKIN TEMP (T11) OUTPUT FROM THIS SHFLX CALL ARE NOT USED <a name='4177'></font>
<font color=#447700>! IN ANY SUBSEQUENT CALCULATIONS. RATHER, THEY ARE DUMMY VARIABLES HERE <a name='4178'></font>
<font color=#447700>! IN THE SNOPAC CASE, SINCE THE SKIN TEMP AND SUB-SFC HEAT FLUX ARE <a name='4179'></font>
<font color=#447700>! UPDATED INSTEAD NEAR THE BEGINNING OF THE CALL TO SNOPAC.<a name='4180'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4181'></font>
<a name='4182'>
	STCWAS=STC(1)<a name='4183'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX'>SHFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHFLX_2">(S1,STC,SMC,SMCMAX,NSOIL,T11,DT,YY,ZZ1,ZSOIL,TBOT,      &amp;<a name='4184'>
        ZBOT, SMCWLT, PSISAT, SH2O,                                     &amp;<a name='4185'>
        B,F1,DF1,ICE,                                                   &amp;<a name='4186'>
        QUARTZ,CSOIL)<a name='4187'>
<a name='4188'>
<font color=#447700>!	write(0,*) 'SNOWH, STC(1), STCWAS: ', SNOWH, STC(1), STCWAS<a name='4189'></font>
	<a name='4190'>
	if (STC(1) .lt. 230 .and. STCWAS .gt. 230) then<a name='4191'>
	write(0,*) 'in SNOPAC, SHFLX changed from: ', STCWAS, 'to : ', STC(1)<a name='4192'>
	write(0,*) 'YY,S,DF1,STC(1): ', YY, S,  &amp;<a name='4193'>
                                              DF1,STC(1)<a name='4194'>
	write(0,*) ' '<a name='4195'>
	endif<a name='4196'>
      <a name='4197'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4198'></font>
<font color=#447700>! SNOW DEPTH AND DENSITY ADJUSTMENT BASED ON SNOW COMPACTION.<a name='4199'></font>
<font color=#447700>! YY is assumed to be the soil temperture at the top of the soil column.<a name='4200'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4201'></font>
      IF (ESD .GT. 0.) THEN<a name='4202'>
<font color=#447700>! --- debug ------------------------------------------------------------<a name='4203'></font>
<font color=#447700>!     write(6,*) 'SNOPAC1:ESD,SNOWH,SNDENS=',ESD,SNOWH,SNDENS<a name='4204'></font>
<font color=#447700>! --- debug ------------------------------------------------------------<a name='4205'></font>
        CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOWPACK'>SNOWPACK</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWPACK_1">(ESD,DT,SNOWH,SNDENS,T1,YY)<a name='4206'>
<font color=#447700>! --- debug ------------------------------------------------------------<a name='4207'></font>
<font color=#447700>!        SNDENS = 0.2<a name='4208'></font>
<font color=#447700>!        SNOWH = ESD/SNDENS<a name='4209'></font>
<font color=#447700>! --- debug ------------------------------------------------------------<a name='4210'></font>
<font color=#447700>! --- debug ------------------------------------------------------------<a name='4211'></font>
<font color=#447700>!     write(6,*) 'SNOPAC2:ESD,SNOWH,SNDENS=',ESD,SNOWH,SNDENS<a name='4212'></font>
<font color=#447700>! --- debug ------------------------------------------------------------<a name='4213'></font>
      ELSE<a name='4214'>
        ESD = 0.<a name='4215'>
        SNOWH = 0.<a name='4216'>
        SNDENS = 0.<a name='4217'>
        SNCOND = 1.<a name='4218'>
      ENDIF<a name='4219'>
<a name='4220'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4221'></font>
      END SUBROUTINE SNOPAC<a name='4222'>
<a name='4223'>
<A NAME='SNOWPACK'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SNOWPACK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4224'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWPACK</font> ( W,DTS,HC,DS,TSNOW,TSOIL ) <A href='../../call_to/SNOWPACK.html' TARGET='index'>2</A><a name='4225'>
<a name='4226'>
      IMPLICIT NONE<a name='4227'>
<a name='4228'>
<font color=#447700>! ##############################################################<a name='4229'></font>
<font color=#447700>! ##  SUBROUTINE TO CALCULATE COMPACTION OF SNOWPACK  UNDER  ###<a name='4230'></font>
<font color=#447700>! ##  CONDITIONS OF INCREASING SNOW DENSITY, AS OBTAINED     ###<a name='4231'></font>
<font color=#447700>! FROM AN APPROXIMATE SOLUTION OF E. ANDERSON'S DIFFERENTIAL ###<a name='4232'></font>
<font color=#447700>!     EQUATION (3.29), NOAA TECHNICAL REPORT NWS 19,         ###<a name='4233'></font>
<font color=#447700>!                 BY   VICTOR KOREN   03/25/95               ###<a name='4234'></font>
<font color=#447700>! ##############################################################<a name='4235'></font>
<a name='4236'>
<font color=#447700>! ##############################################################<a name='4237'></font>
<font color=#447700>!  W      IS A WATER EQUIVALENT OF SNOW, IN M                ###<a name='4238'></font>
<font color=#447700>!  DTS    IS A TIME STEP, IN SEC                             ###<a name='4239'></font>
<font color=#447700>!  HC     IS A SNOW DEPTH, IN M                              ###<a name='4240'></font>
<font color=#447700>!  DS     IS A SNOW DENSITY, IN G/CM3                        ###<a name='4241'></font>
<font color=#447700>!  TSNOW  IS A SNOW SURFACE TEMPERATURE, K                   ###<a name='4242'></font>
<font color=#447700>!  TSOIL  IS A SOIL SURFACE TEMPERATURE, K                   ###<a name='4243'></font>
<font color=#447700>!      SUBROUTINE WILL RETURN NEW VALUES OF H AND DS         ###<a name='4244'></font>
<font color=#447700>! ##############################################################<a name='4245'></font>
<a name='4246'>
      INTEGER IPOL<a name='4247'>
      INTEGER J<a name='4248'>
<a name='4249'>
      REAL C1, C2, HC, W, DTS, DS, TSNOW, TSOIL, H, WX<a name='4250'>
      REAL DT, TSNOWX, TSOILX, TAVG, B, DSX, DW<a name='4251'>
      REAL PEXP<a name='4252'>
      REAL WXX<a name='4253'>
<a name='4254'>
      PARAMETER (C1=0.01, C2=21.0)<a name='4255'>
<a name='4256'>
<font color=#447700>! ##  CONVERSION INTO SIMULATION UNITS   ######################### <a name='4257'></font>
<a name='4258'>
      H=HC*100.<a name='4259'>
      WX=W*100.<a name='4260'>
      DT=DTS/3600.<a name='4261'>
      TSNOWX=TSNOW-273.15<a name='4262'>
      TSOILX=TSOIL-273.15<a name='4263'>
<a name='4264'>
<font color=#447700>! ##  CALCULATING OF AVERAGE TEMPERATURE OF SNOW PACK              ###<a name='4265'></font>
<a name='4266'>
      TAVG=0.5*(TSNOWX+TSOILX)                                    <a name='4267'>
<a name='4268'>
<font color=#447700>! ##  CALCULATING OF SNOW DEPTH AND DENSITY AS A RESULT OF COMPACTION<a name='4269'></font>
<font color=#447700>!              DS=DS0*(EXP(B*W)-1.)/(B*W)<a name='4270'></font>
<font color=#447700>!              B=DT*C1*EXP(0.08*TAVG-C2*DS0)<a name='4271'></font>
<font color=#447700>! NOTE: B*W IN DS EQN ABOVE HAS TO BE CAREFULLY TREATED <a name='4272'></font>
<font color=#447700>! NUMERICALLY BELOW<a name='4273'></font>
<font color=#447700>! ##  C1 IS THE FRACTIONAL INCREASE IN DENSITY (1/(CM*HR)) <a name='4274'></font>
<font color=#447700>! ##  C2 IS A CONSTANT (CM3/G) KOJIMA ESTIMATED AS 21 CMS/G<a name='4275'></font>
<a name='4276'>
      IF(WX .GT. 1.E-2) THEN<a name='4277'>
        WXX = WX<a name='4278'>
      ELSE<a name='4279'>
        WXX = 1.E-2<a name='4280'>
      ENDIF<a name='4281'>
      B=DT*C1*EXP(0.08*TAVG-C2*DS)<a name='4282'>
<a name='4283'>
<font color=#447700>!.........DSX=DS*((DEXP(B*WX)-1.)/(B*WX))<a name='4284'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='4285'></font>
<font color=#447700>!  The function of the form (e**x-1)/x imbedded in above expression<a name='4286'></font>
<font color=#447700>!  for DSX was causing numerical difficulties when the denominator "x"<a name='4287'></font>
<font color=#447700>!  (i.e. B*WX) became zero or approached zero (despite the fact that<a name='4288'></font>
<font color=#447700>!  the analytical function (e**x-1)/x has a well defined limit as <a name='4289'></font>
<font color=#447700>!  "x" approaches zero), hence below we replace the (e**x-1)/x <a name='4290'></font>
<font color=#447700>!  expression with an equivalent, numerically well-behaved <a name='4291'></font>
<font color=#447700>!  polynomial expansion.<a name='4292'></font>
<font color=#447700>! <a name='4293'></font>
<font color=#447700>!  Number of terms of polynomial expansion, and hence its accuracy, <a name='4294'></font>
<font color=#447700>!  is governed by iteration limit "ipol".<a name='4295'></font>
<font color=#447700>!       ipol greater than 9 only makes a difference on double<a name='4296'></font>
<font color=#447700>!             precision (relative errors given in percent %).<a name='4297'></font>
<font color=#447700>!        ipol=9, for rel.error &lt;~ 1.6 e-6 % (8 significant digits)<a name='4298'></font>
<font color=#447700>!        ipol=8, for rel.error &lt;~ 1.8 e-5 % (7 significant digits)<a name='4299'></font>
<font color=#447700>!        ipol=7, for rel.error &lt;~ 1.8 e-4 % ...<a name='4300'></font>
<a name='4301'>
      ipol = 4<a name='4302'>
      PEXP = 0.<a name='4303'>
      do j = ipol,1,-1<a name='4304'>
<font color=#447700>!        PEXP = (1. + PEXP)*B*WX/real(j+1) <a name='4305'></font>
        PEXP = (1. + PEXP)*B*WXX/real(j+1) <a name='4306'>
      end do <a name='4307'>
      PEXP = PEXP + 1.<a name='4308'>
<font color=#447700>!<a name='4309'></font>
      DSX=DS*(PEXP)<a name='4310'>
<font color=#447700>!                     above line ends polynomial substitution<a name='4311'></font>
<a name='4312'>
      IF(DSX .GT. 0.40) DSX=0.40<a name='4313'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4314'></font>
<font color=#447700>! mbek - April 2001<a name='4315'></font>
<font color=#447700>! Set lower limit on snow density, rather than just previous value.<a name='4316'></font>
<font color=#447700>!         IF(DSX .LT. 0.05) DSX=DS<a name='4317'></font>
      IF(DSX .LT. 0.05) DSX=0.05<a name='4318'>
<a name='4319'>
      DS=DSX<a name='4320'>
<a name='4321'>
<font color=#447700>! ##  UPDATE OF SNOW DEPTH AND DENSITY DEPENDING ON LIQUID WATER<a name='4322'></font>
<font color=#447700>! ##  DURING SNOWMELT. ASSUMED THAT 13% OF LIQUID WATER CAN BE STORED<a name='4323'></font>
<font color=#447700>! ##  IN SNOW PER DAY DURING SNOWMELT TILL SNOW DENSITY 0.40<a name='4324'></font>
<a name='4325'>
<font color=#447700>!         IF((TSNOWX .GE. 0.) .AND. (H .NE. 0.)) THEN<a name='4326'></font>
      IF (TSNOWX .GE. 0.) THEN<a name='4327'>
        DW=0.13*DT/24.<a name='4328'>
        DS=DS*(1.-DW)+DW<a name='4329'>
        IF(DS .GT. 0.40) DS=0.40<a name='4330'>
      ENDIF<a name='4331'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4332'></font>
<font color=#447700>! Calculate snow depth (cm) from snow water equivalent and snow density.<a name='4333'></font>
      H=WX/DS<a name='4334'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4335'></font>
<font color=#447700>! Change snow depth units to meters<a name='4336'></font>
      HC=H*0.01<a name='4337'>
<a name='4338'>
      END SUBROUTINE SNOWPACK<a name='4339'>
<a name='4340'>
<A NAME='SNOW_NEW'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SNOW_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4341'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOW_NEW</font> ( T,P,HC,DS ) <A href='../../call_to/SNOW_NEW.html' TARGET='index'>2</A><a name='4342'>
<a name='4343'>
      IMPLICIT NONE<a name='4344'>
      <a name='4345'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4346'></font>
<font color=#447700>! CALCULATING SNOW DEPTH AND DENSITITY TO ACCOUNT FOR THE NEW SNOWFALL<a name='4347'></font>
<font color=#447700>! T - AIR TEMPERATURE, K<a name='4348'></font>
<font color=#447700>! P - NEW SNOWFALL, M<a name='4349'></font>
<font color=#447700>! HC - SNOW DEPTH, M<a name='4350'></font>
<font color=#447700>! DS - SNOW DENSITY<a name='4351'></font>
<font color=#447700>! NEW VALUES OF SNOW DEPTH &amp; DENSITY WILL BE RETURNED<a name='4352'></font>
      REAL HC<a name='4353'>
      REAL T <a name='4354'>
      REAL P<a name='4355'>
      REAL DS<a name='4356'>
      REAL H<a name='4357'>
      REAL PX<a name='4358'>
      REAL TX<a name='4359'>
      REAL DS0<a name='4360'>
      REAL HNEW<a name='4361'>
<font color=#447700>!<a name='4362'></font>
      REAL ESD<a name='4363'>
      <a name='4364'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4365'></font>
<font color=#447700>! CONVERSION INTO SIMULATION UNITS      <a name='4366'></font>
      H=HC*100.<a name='4367'>
      PX=P*100.<a name='4368'>
      TX=T-273.15<a name='4369'>
      <a name='4370'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4371'></font>
<font color=#447700>! CALCULATING NEW SNOWFALL DENSITY DEPENDING ON TEMPERATURE<a name='4372'></font>
<font color=#447700>! EQUATION FROM GOTTLIB L. 'A GENERAL RUNOFF MODEL FOR SNOWCOVERED<a name='4373'></font>
<font color=#447700>! AND GLACIERIZED BASIN', 6TH NORDIC HYDROLOGICAL CONFERENCE,<a name='4374'></font>
<font color=#447700>! VEMADOLEN, SWEDEN, 1980, 172-177PP.<a name='4375'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4376'></font>
      IF(TX .LE. -15.) THEN<a name='4377'>
        DS0=0.05<a name='4378'>
      ELSE                                                      <a name='4379'>
        DS0=0.05+0.0017*(TX+15.)**1.5<a name='4380'>
      ENDIF<a name='4381'>
      <a name='4382'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4383'></font>
<font color=#447700>! ADJUSTMENT OF SNOW DENSITY DEPENDING ON NEW SNOWFALL      <a name='4384'></font>
      HNEW=PX/DS0<a name='4385'>
      DS=(H*DS+HNEW*DS0)/(H+HNEW)<a name='4386'>
      H=H+HNEW<a name='4387'>
      HC=H*0.01<a name='4388'>
      <a name='4389'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4390'></font>
      END SUBROUTINE SNOW_NEW<a name='4391'>
<a name='4392'>
<A NAME='SRT'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SRT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4393'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SRT</font> (RHSTT,RUNOFF,EDIR,ET,SH2O,SH2OA,NSOIL,PCPDRP,     &amp; <A href='../../call_to/SRT.html' TARGET='index'>6</A>,<A href='../../call_from/SRT.html' TARGET='index'>8</A><a name='4394'>
                       ZSOIL,DWSAT,DKSAT,SMCMAX,B, RUNOFF1,             &amp;<a name='4395'>
                       RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZX,SICE)<a name='4396'>
<a name='4397'>
<a name='4398'>
      IMPLICIT NONE<a name='4399'>
<a name='4400'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4401'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY<a name='4402'></font>
<font color=#447700>!C    =======   TERM OF THE SOIL WATER DIFFUSION EQUATION.  ALSO TO<a name='4403'></font>
<font color=#447700>!C              COMPUTE ( PREPARE ) THE MATRIX COEFFICIENTS FOR THE<a name='4404'></font>
<font color=#447700>!C              TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.<a name='4405'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4406'></font>
      <a name='4407'>
      INTEGER NSOLD<a name='4408'>
      PARAMETER ( NSOLD = 20 )<a name='4409'>
<font color=#447700>!tst      PARAMETER ( NSOLD = 4 )<a name='4410'></font>
<a name='4411'>
      INTEGER CVFRZ      <a name='4412'>
      INTEGER IALP1<a name='4413'>
      INTEGER IOHINF<a name='4414'>
      INTEGER J<a name='4415'>
      INTEGER JJ      <a name='4416'>
      INTEGER K<a name='4417'>
      INTEGER KS<a name='4418'>
      INTEGER NSOIL<a name='4419'>
<a name='4420'>
	REAL AI     ( NSOLD )<a name='4421'>
      REAL B<a name='4422'>
      REAL BI     ( NSOLD )<a name='4423'>
      REAL CI     ( NSOLD )<a name='4424'>
      REAL DMAX   ( NSOLD )<a name='4425'>
      REAL DDZ<a name='4426'>
      REAL DDZ2<a name='4427'>
      REAL DENOM<a name='4428'>
      REAL DENOM2<a name='4429'>
      REAL DKSAT<a name='4430'>
      REAL DSMDZ<a name='4431'>
      REAL DSMDZ2<a name='4432'>
      REAL DWSAT<a name='4433'>
      REAL EDIR<a name='4434'>
      REAL ET     ( NSOIL )<a name='4435'>
      REAL INFMAX<a name='4436'>
      REAL KDT<a name='4437'>
      REAL MXSMC<a name='4438'>
      REAL MXSMC2<a name='4439'>
      REAL NUMER<a name='4440'>
      REAL PCPDRP<a name='4441'>
      REAL PDDUM<a name='4442'>
      REAL RHSTT  ( NSOIL )<a name='4443'>
      REAL RUNOFF<a name='4444'>
      <a name='4445'>
      REAL SH2O   ( NSOIL )<a name='4446'>
      REAL SH2OA  ( NSOIL )<a name='4447'>
      REAL SICE   ( NSOIL )<a name='4448'>
      REAL SICEMAX<a name='4449'>
      <a name='4450'>
      REAL SMCMAX<a name='4451'>
      REAL WCND<a name='4452'>
      REAL WCND2<a name='4453'>
      REAL WDF<a name='4454'>
      REAL WDF2<a name='4455'>
      REAL ZSOIL  ( NSOIL )<a name='4456'>
<a name='4457'>
      REAL RUNOFF1, RUNOFF2, DT, SMCWLT, SLOPE, FRZX, DT1<a name='4458'>
      REAL SMCAV, DICE, DD, VAL, DDT, PX, FCR, ACRT, SUM<a name='4459'>
      REAL SSTT, SLOPX<a name='4460'>
<a name='4461'>
<font color=#447700>!<a name='4462'></font>
      COMMON /ABCI/ AI, BI, CI<a name='4463'>
<a name='4464'>
<font color=#447700>! -----------     FROZEN GROUND VERSION    -------------------------<a name='4465'></font>
<font color=#447700>!   REFERENCE FROZEN GROUND PARAMETER, CVFRZ, IS A SHAPE PARAMETER OF<a name='4466'></font>
<font color=#447700>!   AREAL DISTRIBUTION FUNCTION OF SOIL ICE CONTENT WHICH EQUALS 1/CV.<a name='4467'></font>
<font color=#447700>!   CV IS A COEFFICIENT OF SPATIAL VARIATION OF SOIL ICE CONTENT. <a name='4468'></font>
<font color=#447700>!   BASED ON FIELD DATA CV DEPENDS ON AREAL MEAN OF FROZEN DEPTH, AND IT<a name='4469'></font>
<font color=#447700>!   CLOSE TO CONSTANT = 0.6 IF AREAL MEAN FROZEN DEPTH IS ABOVE 20 CM.<a name='4470'></font>
<font color=#447700>!   THAT IS WHY PARAMETER CVFRZ = 3 (INT{1/0.6*0.6})  <a name='4471'></font>
<font color=#447700>!<a name='4472'></font>
<font color=#447700>!   Current logic doesn't allow CVFRZ be bigger than 3<a name='4473'></font>
        PARAMETER ( CVFRZ = 3 )<a name='4474'>
<font color=#447700>! ------------------------------------------------------------------<a name='4475'></font>
     <a name='4476'>
<font color=#447700>!      PRINT*,'in SRT, Declaration -----------------------'<a name='4477'></font>
<font color=#447700>!      PRINT*,'NSOIL=' , NSOIL<a name='4478'></font>
<font color=#447700>!      PRINT*,'NSOLD=' , NSOLD<a name='4479'></font>
        <a name='4480'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4481'></font>
<font color=#447700>!     DETERMINE RAINFALL INFILTRATION RATE AND RUNOFF<a name='4482'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4483'></font>
<a name='4484'>
<font color=#447700>!<a name='4485'></font>
<font color=#447700>! ##INCLUDE THE INFILTRATION FORMULE FROM SCHAAKE AND KOREN MODEL<a name='4486'></font>
<font color=#447700>!<a name='4487'></font>
<font color=#447700>!C    MODIFIED BY Q DUAN<a name='4488'></font>
<font color=#447700>!C      <a name='4489'></font>
      IOHINF=1<a name='4490'>
<a name='4491'>
<font color=#447700>! Let SICEMAX be the greatest, if any, frozen water content within <a name='4492'></font>
<font color=#447700>! soil layers.<a name='4493'></font>
      SICEMAX = 0.0<a name='4494'>
      DO KS=1,NSOIL<a name='4495'>
       IF (SICE(KS) .GT. SICEMAX) SICEMAX = SICE(KS)<a name='4496'>
      END DO<a name='4497'>
<a name='4498'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4499'></font>
<font color=#447700>!     DETERMINE RAINFALL INFILTRATION RATE AND RUNOFF<a name='4500'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4501'></font>
<a name='4502'>
      PDDUM = PCPDRP<a name='4503'>
      RUNOFF1 = 0.0<a name='4504'>
      IF ( PCPDRP .NE. 0.0 ) THEN<a name='4505'>
<a name='4506'>
<font color=#447700>!C++  MODIFIED BY Q. DUAN, 5/16/94<a name='4507'></font>
<a name='4508'>
<font color=#447700>!        IF (IOHINF .EQ. 1) THEN<a name='4509'></font>
  <a name='4510'>
          DT1 = DT/86400.<a name='4511'>
          SMCAV = SMCMAX - SMCWLT<a name='4512'>
          DMAX(1)=-ZSOIL(1)*SMCAV<a name='4513'>
<a name='4514'>
<font color=#447700>! -----------     FROZEN GROUND VERSION    ------------------------<a name='4515'></font>
<font color=#447700>!<a name='4516'></font>
          DICE = -ZSOIL(1) * SICE(1)<a name='4517'>
<font color=#447700>!-------------------------------------------------------------------<a name='4518'></font>
          <a name='4519'>
          DMAX(1)=DMAX(1)*(1.0 - (SH2OA(1)+SICE(1)-SMCWLT)/SMCAV)<a name='4520'>
          DD=DMAX(1)<a name='4521'>
      DO KS=2,NSOIL<a name='4522'>
          <a name='4523'>
<font color=#447700>! -----------     FROZEN GROUND VERSION    ------------------------<a name='4524'></font>
<font color=#447700>!<a name='4525'></font>
           DICE = DICE + ( ZSOIL(KS-1) - ZSOIL(KS) ) * SICE(KS)<a name='4526'>
<font color=#447700>!------------------------------------------------------------------- <a name='4527'></font>
         <a name='4528'>
           DMAX(KS)=(ZSOIL(KS-1)-ZSOIL(KS))*SMCAV<a name='4529'>
           DMAX(KS)=DMAX(KS)*(1.0 - (SH2OA(KS)+SICE(KS)-SMCWLT)/SMCAV)<a name='4530'>
           DD=DD+DMAX(KS)<a name='4531'>
      END DO<a name='4532'>
<font color=#447700>!C .....VAL = (1.-EXP(-KDT*SQRT(DT1)))<a name='4533'></font>
<font color=#447700>! IN BELOW, REMOVE THE SQRT IN ABOVE<a name='4534'></font>
          VAL = (1.-EXP(-KDT*DT1))<a name='4535'>
          DDT = DD*VAL<a name='4536'>
          PX = PCPDRP*DT  <a name='4537'>
          IF(PX.LT.0.0) PX = 0.0<a name='4538'>
          INFMAX = (PX*(DDT/(PX+DDT)))/DT<a name='4539'>
          <a name='4540'>
<font color=#447700>! -----------     FROZEN GROUND VERSION    --------------------------<a name='4541'></font>
<font color=#447700>!    REDUCTION OF INFILTRATION BASED ON FROZEN GROUND PARAMETERS<a name='4542'></font>
<font color=#447700>!<a name='4543'></font>
         FCR = 1. <a name='4544'>
         IF ( DICE .GT. 1.E-2) THEN <a name='4545'>
           ACRT = CVFRZ * FRZX / DICE <a name='4546'>
           SUM = 1.<a name='4547'>
           IALP1 = CVFRZ - 1 <a name='4548'>
           DO J = 1,IALP1<a name='4549'>
              K = 1<a name='4550'>
              DO JJ = J+1, IALP1<a name='4551'>
                K = K * JJ<a name='4552'>
              END DO   <a name='4553'>
              SUM = SUM + (ACRT ** ( CVFRZ-J)) / FLOAT (K) <a name='4554'>
           END DO <a name='4555'>
           FCR = 1. - EXP(-ACRT) * SUM <a name='4556'>
         END IF <a name='4557'>
         INFMAX = INFMAX * FCR<a name='4558'>
<font color=#447700>! -------------------------------------------------------------------<a name='4559'></font>
<a name='4560'>
<font color=#447700>! ############    CORRECTION OF INFILTRATION LIMITATION    ##########<a name='4561'></font>
<font color=#447700>!     IF INFMAX .LE. HYDROLIC CONDUCTIVITY ASSIGN INFMAX THE <a name='4562'></font>
<font color=#447700>!     VALUE OF HYDROLIC CONDUCTIVITY<a name='4563'></font>
<font color=#447700>!<a name='4564'></font>
<font color=#447700>!         MXSMC = MAX ( SH2OA(1), SH2OA(2) ) <a name='4565'></font>
        MXSMC = SH2OA(1)<a name='4566'>
<a name='4567'>
<font color=#447700>!      PRINT*,'SRT, BEFORE WDFCND - 1 ------------------------------'<a name='4568'></font>
<font color=#447700>!      PRINT*,'MXSMC,SMCMAX=' , MXSMC,SMCMAX<a name='4569'></font>
<font color=#447700>!      PRINT*,'B,DKSAT,DWSAT=' , B,DKSAT,DWSAT<a name='4570'></font>
<a name='4571'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_1"> ( WDF,WCND,MXSMC,SMCMAX,B,DKSAT,DWSAT,            &amp;<a name='4572'>
                     SICEMAX )<a name='4573'>
<a name='4574'>
            INFMAX = MAX(INFMAX, WCND)<a name='4575'>
            INFMAX= MIN(INFMAX,PX)<a name='4576'>
<a name='4577'>
<font color=#447700>!      PRINT*,'SRT, AFTER WDFCND - 1 ------------------------------'<a name='4578'></font>
<font color=#447700>!      PRINT*,'WDF,WCND=' , WDF,WCND<a name='4579'></font>
<font color=#447700>!      PRINT*,'MXSMC,SMCMAX=' , MXSMC,SMCMAX<a name='4580'></font>
<font color=#447700>!      PRINT*,'B,DKSAT,DWSAT=' , B,DKSAT,DWSAT<a name='4581'></font>
 <a name='4582'>
<font color=#447700>!<a name='4583'></font>
          IF ( PCPDRP .GT. INFMAX ) THEN<a name='4584'>
            RUNOFF1 = PCPDRP - INFMAX<a name='4585'>
            PDDUM = INFMAX<a name='4586'>
          END IF<a name='4587'>
<a name='4588'>
      END IF<a name='4589'>
<font color=#447700>!<a name='4590'></font>
<font color=#447700>! TO AVOID SPURIOUS DRAINAGE BEHAVIOR IDENTIFIED BY P. GRUNMANN,<a name='4591'></font>
<font color=#447700>! FORMER APPROACH IN LINE BELOW REPLACED WITH NEW APPROACH IN 2ND LINE<a name='4592'></font>
<font color=#447700>!...MXSMC = MAX( SH2OA(1), SH2OA(2) )<a name='4593'></font>
        MXSMC =  SH2OA(1)<a name='4594'>
<a name='4595'>
<font color=#447700>!      PRINT*,'SRT, BEFORE WDFCND - 2'<a name='4596'></font>
<font color=#447700>!      PRINT*,'MXSMC,SMCMAX=' , MXSMC,SMCMAX<a name='4597'></font>
<font color=#447700>!      PRINT*,'B,DKSAT,DWSAT=' , B,DKSAT,DWSAT<a name='4598'></font>
<a name='4599'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_2"> ( WDF,WCND,MXSMC,SMCMAX,B,DKSAT,DWSAT,          &amp;<a name='4600'>
      SICEMAX )<a name='4601'>
<a name='4602'>
<font color=#447700>!      PRINT*,'SRT, AFTER WDFCND - 2'<a name='4603'></font>
<font color=#447700>!      PRINT*,'WDF,WCND=' , WDF,WCND<a name='4604'></font>
<font color=#447700>!      PRINT*,'MXSMC,SMCMAX=' , MXSMC,SMCMAX<a name='4605'></font>
<font color=#447700>!      PRINT*,'B,DKSAT,DWSAT=' , B,DKSAT,DWSAT<a name='4606'></font>
 <a name='4607'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4608'></font>
<font color=#447700>!     CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER<a name='4609'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4610'></font>
<a name='4611'>
      DDZ = 1. / ( -.5 * ZSOIL(2) )<a name='4612'>
      AI(1) = 0.0<a name='4613'>
      BI(1) = WDF * DDZ / ( -ZSOIL(1) )<a name='4614'>
      CI(1) = -BI(1)<a name='4615'>
<a name='4616'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4617'></font>
<font color=#447700>!     CALC RHSTT FOR THE TOP LAYER AFTER CALC'NG THE VERTICAL SOIL<a name='4618'></font>
<font color=#447700>!     MOISTURE GRADIENT BTWN THE TOP AND NEXT TO TOP LAYERS.<a name='4619'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4620'></font>
<a name='4621'>
      DSMDZ = ( SH2O(1) - SH2O(2) ) / ( -.5 * ZSOIL(2) )<a name='4622'>
      RHSTT(1) = (WDF * DSMDZ + WCND - PDDUM + EDIR + ET(1))/ZSOIL(1)<a name='4623'>
      SSTT = WDF * DSMDZ + WCND + EDIR + ET(1)<a name='4624'>
<a name='4625'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4626'></font>
<font color=#447700>!     INITIALIZE DDZ2<a name='4627'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4628'></font>
<a name='4629'>
      DDZ2 = 0.0<a name='4630'>
<a name='4631'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4632'></font>
<font color=#447700>!     LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABV PROCESS<a name='4633'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4634'></font>
<a name='4635'>
      DO K = 2 , NSOIL<a name='4636'>
         DENOM2 = ( ZSOIL(K-1) - ZSOIL(K) )<a name='4637'>
         IF ( K .NE. NSOIL ) THEN<a name='4638'>
            SLOPX = 1.<a name='4639'>
<font color=#447700>!<a name='4640'></font>
<font color=#447700>! AGAIN, TO AVOID SPURIOUS DRAINAGE BEHAVIOR IDENTIFIED BY P. GRUNMANN,<a name='4641'></font>
<font color=#447700>! FORMER APPROACH IN LINE BELOW REPLACED WITH NEW APPROACH IN 2ND LINE<a name='4642'></font>
<font color=#447700>!....MXSMC2 = MAX ( SH2OA(K), SH2OA(K+1) )<a name='4643'></font>
            MXSMC2 =  SH2OA(K)<a name='4644'>
<a name='4645'>
<font color=#447700>!      PRINT*,'SRT, BEFORE WDFCND - 3'<a name='4646'></font>
<font color=#447700>!      PRINT*,'MXSMC2,SMCMAX=' , MXSMC2,SMCMAX<a name='4647'></font>
<font color=#447700>!      PRINT*,'B,DKSAT,DWSAT=' , B,DKSAT,DWSAT<a name='4648'></font>
<font color=#447700>!      PRINT*,'K=' , K<a name='4649'></font>
<a name='4650'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_3"> ( WDF2,WCND2,MXSMC2,SMCMAX,B,DKSAT,DWSAT,   &amp;<a name='4651'>
                 SICEMAX )<a name='4652'>
<a name='4653'>
<font color=#447700>!      PRINT*,'SRT, AFTER WDFCND - 3'<a name='4654'></font>
<font color=#447700>!      PRINT*,'WDF2,WCND2=' , WDF2,WCND2<a name='4655'></font>
<font color=#447700>!      PRINT*,'MXSMC2,SMCMAX=' , MXSMC2,SMCMAX<a name='4656'></font>
<font color=#447700>!      PRINT*,'B,DKSAT,DWSAT=' , B,DKSAT,DWSAT<a name='4657'></font>
 <a name='4658'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4659'></font>
<font color=#447700>!       CALC SOME PARTIAL PRODUCTS FOR LATER USE IN CALC'NG RHSTT<a name='4660'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4661'></font>
<a name='4662'>
            DENOM = ( ZSOIL(K-1) - ZSOIL(K+1) )<a name='4663'>
            DSMDZ2 = ( SH2O(K) - SH2O(K+1) ) / ( DENOM * 0.5 )<a name='4664'>
<a name='4665'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4666'></font>
<font color=#447700>!         CALC THE MATRIX COEF, CI, AFTER CALC'NG ITS PARTIAL PRODUCT<a name='4667'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4668'></font>
<a name='4669'>
            DDZ2 = 2.0 / DENOM<a name='4670'>
            CI(K) = -WDF2 * DDZ2 / DENOM2<a name='4671'>
         ELSE<a name='4672'>
<a name='4673'>
<font color=#447700>!   SLOPE OF BOTTOM LAYER IS INTRODUCED     ############<a name='4674'></font>
<font color=#447700>!<a name='4675'></font>
            SLOPX = SLOPE<a name='4676'>
<font color=#447700>!--------------------------------------------------------<a name='4677'></font>
          <a name='4678'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4679'></font>
<font color=#447700>!         RETRIEVE THE SOIL WATER DIFFUSIVITY AND HYDRAULIC<a name='4680'></font>
<font color=#447700>!         CONDUCTIVITY FOR THIS LAYER<a name='4681'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4682'></font>
<a name='4683'>
<a name='4684'>
<font color=#447700>!      PRINT*,'SRT, BEFORE WDFCND - 4'<a name='4685'></font>
<font color=#447700>!      PRINT*,'SH2OA(NSOIL),SMCMAX=' , SH2OA(NSOIL),SMCMAX<a name='4686'></font>
<font color=#447700>!      PRINT*,'B,DKSAT,DWSAT=' , B,DKSAT,DWSAT<a name='4687'></font>
<font color=#447700>!      PRINT*,'K=' , K<a name='4688'></font>
 <a name='4689'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_4"> ( WDF2,WCND2,SH2OA(NSOIL),SMCMAX,           &amp;<a name='4690'>
                 B,DKSAT,DWSAT,SICEMAX )<a name='4691'>
<a name='4692'>
<font color=#447700>!      PRINT*,'SRT, AFTER WDFCND - 4'<a name='4693'></font>
<font color=#447700>!      PRINT*,'WDF2,WCND2=' , WDF2,WCND2<a name='4694'></font>
<font color=#447700>!      PRINT*,'SH2OA(NSOIL),SMCMAX=' , SH2OA(NSOIL),SMCMAX<a name='4695'></font>
<font color=#447700>!      PRINT*,'B,DKSAT,DWSAT=' , B,DKSAT,DWSAT<a name='4696'></font>
 <a name='4697'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4698'></font>
<font color=#447700>!         CALC A PARTIAL PRODUCT FOR LATER USE IN CALC'NG RHSTT <a name='4699'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4700'></font>
<a name='4701'>
            DSMDZ2 = 0.0<a name='4702'>
<a name='4703'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4704'></font>
<font color=#447700>!         SET MATRIX COEF CI TO ZERO<a name='4705'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4706'></font>
<a name='4707'>
            CI(K) = 0.0<a name='4708'>
         END IF<a name='4709'>
<a name='4710'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4711'></font>
<font color=#447700>!       CALC RHSTT FOR THIS LAYER AFTER CALC'NG ITS NUMERATOR<a name='4712'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4713'></font>
<a name='4714'>
         NUMER = (WDF2 * DSMDZ2) + SLOPX * WCND2 - (WDF * DSMDZ)    &amp;<a name='4715'>
              - WCND + ET(K)<a name='4716'>
         RHSTT(K) = NUMER / (-DENOM2)<a name='4717'>
<a name='4718'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4719'></font>
<font color=#447700>!       CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER<a name='4720'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4721'></font>
<a name='4722'>
         AI(K) = -WDF * DDZ / DENOM2<a name='4723'>
         BI(K) = -( AI(K) + CI(K) )<a name='4724'>
<a name='4725'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4726'></font>
<font color=#447700>!       RESET VALUES OF WDF, WCND, DSMDZ, AND DDZ FOR LOOP TO NEXT LYR<a name='4727'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4728'></font>
<a name='4729'>
         IF(K.EQ.NSOIL) THEN<a name='4730'>
<font color=#447700>!############### RUNOFF2: GROUND WATER RUNOFF ###########<a name='4731'></font>
            RUNOFF2 = SLOPX * WCND2<a name='4732'>
         ENDIF<a name='4733'>
<a name='4734'>
         IF ( K .NE. NSOIL ) THEN<a name='4735'>
            WDF = WDF2<a name='4736'>
            WCND = WCND2<a name='4737'>
            DSMDZ = DSMDZ2<a name='4738'>
            DDZ = DDZ2<a name='4739'>
         END IF<a name='4740'>
      END DO<a name='4741'>
<a name='4742'>
<font color=#447700>!      PRINT*,'SRT, final Runoff'<a name='4743'></font>
<font color=#447700>!      PRINT*,'RUNOFF1=' , RUNOFF1<a name='4744'></font>
<font color=#447700>!      PRINT*,'RUNOFF2=' , RUNOFF2<a name='4745'></font>
 <a name='4746'>
      END SUBROUTINE SRT<a name='4747'>
<a name='4748'>
<A NAME='SSTEP'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SSTEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4749'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SSTEP</font> ( SH2OOUT, SH2OIN, CMC, RHSTT, RHSCT, DT,    &amp; <A href='../../call_to/SSTEP.html' TARGET='index'>6</A>,<A href='../../call_from/SSTEP.html' TARGET='index'>2</A><a name='4750'>
           NSOIL, SMCMAX, CMCMAX, RUNOFF3, ZSOIL,SMC,SICE)<a name='4751'>
<a name='4752'>
      IMPLICIT NONE<a name='4753'>
<a name='4754'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4755'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE/UPDATE THE SOIL MOISTURE CONTENT VALUES<a name='4756'></font>
<font color=#447700>!C    =======   AND THE CANOPY MOISTURE CONTENT VALUES.<a name='4757'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4758'></font>
<a name='4759'>
      INTEGER NSOLD<a name='4760'>
      PARAMETER ( NSOLD = 20 )<a name='4761'>
<font color=#447700>!tst      PARAMETER ( NSOLD = 4 )<a name='4762'></font>
<font color=#447700>!<a name='4763'></font>
      INTEGER I<a name='4764'>
      INTEGER K <a name='4765'>
      INTEGER KK11<a name='4766'>
      INTEGER NSOIL<a name='4767'>
<a name='4768'>
      REAL AI     ( NSOLD )<a name='4769'>
      REAL BI     ( NSOLD )<a name='4770'>
      REAL CI     ( NSOLD )<a name='4771'>
      REAL CIin   ( NSOLD )<a name='4772'>
      REAL CMC<a name='4773'>
      REAL CMCMAX<a name='4774'>
      REAL DT<a name='4775'>
      REAL RHSCT<a name='4776'>
      REAL RHSTT   ( NSOIL )<a name='4777'>
      REAL RHSTTin ( NSOIL )<a name='4778'>
      REAL SH2OIN  ( NSOIL )<a name='4779'>
      REAL SH2OOUT ( NSOIL )<a name='4780'>
      REAL SICE    ( NSOIL )<a name='4781'>
      REAL SMC     ( NSOIL )<a name='4782'>
      REAL SMCMAX<a name='4783'>
      REAL ZSOIL(NSOIL)<a name='4784'>
<a name='4785'>
      REAL RUNOFF3, RUNOFS, WPLUS, DDZ, STOT, WFREE, DPLUS<a name='4786'>
<font color=#447700>!<a name='4787'></font>
      COMMON /ABCI/ AI, BI, CI<a name='4788'>
<a name='4789'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4790'></font>
<font color=#447700>!     CREATE 'AMOUNT' VALUES OF VARIABLES TO BE INPUT TO THE<a name='4791'></font>
<font color=#447700>!     TRI-DIAGONAL MATRIX ROUTINE.<a name='4792'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4793'></font>
<a name='4794'>
      DO K = 1 , NSOIL<a name='4795'>
        RHSTT(K) = RHSTT(K) * DT<a name='4796'>
        AI(K) = AI(K) * DT<a name='4797'>
        BI(K) = 1. + BI(K) * DT<a name='4798'>
        CI(K) = CI(K) * DT<a name='4799'>
      END DO<a name='4800'>
<a name='4801'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4802'></font>
<font color=#447700>!     COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12<a name='4803'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4804'></font>
      DO K = 1 , NSOIL<a name='4805'>
         RHSTTin(K) = RHSTT(K)<a name='4806'>
      END DO<a name='4807'>
      DO K = 1 , NSOLD<a name='4808'>
         CIin(K) = CI(K)<a name='4809'>
      END DO<a name='4810'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4811'></font>
<font color=#447700>!     CALL ROSR12 TO SOLVE THE TRI-DIAGONAL MATRIX<a name='4812'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4813'></font>
<a name='4814'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#ROSR12'>ROSR12</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SSTEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_2"> ( CI, AI, BI, CIin, RHSTTin, RHSTT, NSOIL)<a name='4815'>
<a name='4816'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4817'></font>
<font color=#447700>!     SUM THE PREVIOUS SMC VALUE AND THE MATRIX SOLUTION TO GET A<a name='4818'></font>
<font color=#447700>!     NEW VALUE.  MIN ALLOWABLE VALUE OF SMC WILL BE 0.02.<a name='4819'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4820'></font>
<a name='4821'>
<font color=#447700>!   ################## RUNOFF3: Runoff within soil layers #######<a name='4822'></font>
<a name='4823'>
      RUNOFS = 0.0<a name='4824'>
      WPLUS = 0.0<a name='4825'>
      RUNOFF3 = 0.<a name='4826'>
      DDZ = - ZSOIL(1)<a name='4827'>
<a name='4828'>
      DO K = 1 , NSOIL<a name='4829'>
         IF ( K .NE. 1 ) DDZ = ZSOIL(K - 1) - ZSOIL(K)<a name='4830'>
         SH2OOUT(K) = SH2OIN(K) + CI(K) + WPLUS / DDZ<a name='4831'>
<a name='4832'>
	if (SH2OOUT(K) .lt. 0) then<a name='4833'>
	write(0,*) 'prelim val SH2OIN(K), SH2OOUT(K), CI(K), WPLUS: ', SH2OIN(K), &amp;<a name='4834'>
                       SH2OOUT(K), CI(K), WPLUS<a name='4835'>
	endif<a name='4836'>
        <a name='4837'>
<font color=#447700>!      PRINT*,'IN sstep'<a name='4838'></font>
<font color=#447700>!      PRINT*,'SH2OOUT=', SH2OOUT<a name='4839'></font>
        <a name='4840'>
         STOT = SH2OOUT(K) + SICE(K)<a name='4841'>
         IF ( STOT .GT. SMCMAX ) THEN<a name='4842'>
            IF ( K .EQ. 1 ) THEN<a name='4843'>
               DDZ = -ZSOIL(1)<a name='4844'>
            ELSE<a name='4845'>
               KK11 = K - 1<a name='4846'>
               DDZ = -ZSOIL(K) + ZSOIL(KK11)<a name='4847'>
            END IF<a name='4848'>
            WPLUS = ( STOT - SMCMAX ) * DDZ<a name='4849'>
         ELSE<a name='4850'>
            WPLUS = 0.<a name='4851'>
         END IF<a name='4852'>
         SMC(K) = MAX ( MIN( STOT, SMCMAX ), 0.02 )<a name='4853'>
         SH2OOUT(K) = MAX ( (SMC(K) - SICE(K)), 0.0 )<a name='4854'>
      END DO<a name='4855'>
<a name='4856'>
<font color=#447700>!  ###  V. KOREN   9/01/98    ######<a name='4857'></font>
<font color=#447700>!     WATER BALANCE CHECKING UPWARD<a name='4858'></font>
<a name='4859'>
      IF(WPLUS .GT. 0.) THEN<a name='4860'>
       DO I=NSOIL-1,1,-1<a name='4861'>
        IF(I .EQ. 1) THEN<a name='4862'>
         DDZ=-ZSOIL(1)<a name='4863'>
        ELSE<a name='4864'>
         DDZ=-ZSOIL(I)+ZSOIL(I-1)<a name='4865'>
        ENDIF<a name='4866'>
        WFREE=(SMCMAX-SH2OOUT(I)-SICE(I))*DDZ<a name='4867'>
        DPLUS=WFREE-WPLUS<a name='4868'>
        IF(DPLUS .GE. 0.) THEN<a name='4869'>
         SH2OOUT(I)=SH2OOUT(I)+WPLUS/DDZ<a name='4870'>
	if (SH2OOUT(I) .lt. 0) then<a name='4871'>
	write(0,*) 'SH2OOUT(I) made neg down here(b): ', SH2OOUT(I)<a name='4872'>
	endif<a name='4873'>
         SMC(I)=SH2OOUT(I)+SICE(I)<a name='4874'>
         WPLUS=0.<a name='4875'>
           <a name='4876'>
        ELSE<a name='4877'>
         SH2OOUT(I)=SH2OOUT(I)+WFREE/DDZ<a name='4878'>
	if (SH2OOUT(I) .lt. 0) then<a name='4879'>
	write(0,*) 'SH2OOUT(I) made neg down here(c): ',I,WFREE,DDZ,SH2OOUT(I)<a name='4880'>
	write(0,*) 'SMCMAX, SICE, STOT: ', SMCMAX, SICE(I), STOT<a name='4881'>
	endif<a name='4882'>
         SMC(I)=SH2OOUT(I)+SICE(I)<a name='4883'>
         WPLUS=-DPLUS<a name='4884'>
        ENDIF<a name='4885'>
       END DO<a name='4886'>
30     RUNOFF3=WPLUS<a name='4887'>
      ENDIF<a name='4888'>
<a name='4889'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4890'></font>
<font color=#447700>!  UPDATE CANOPY WATER CONTENT/INTERCEPTION (CMC).  CONVERT RHSCT TO <a name='4891'></font>
<font color=#447700>!  AN 'AMOUNT' VALUE AND ADD TO PREVIOUS CMC VALUE TO GET NEW CMC.<a name='4892'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4893'></font>
<a name='4894'>
      CMC = CMC + DT * RHSCT<a name='4895'>
      IF (CMC .LT. 1.E-20) CMC=0.0<a name='4896'>
      CMC = MIN(CMC,CMCMAX)<a name='4897'>
<a name='4898'>
      END SUBROUTINE SSTEP<a name='4899'>
<a name='4900'>
<A NAME='TBND'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#TBND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4901'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TBND</font> (TU, TB, ZSOIL, ZBOT, K, NSOIL, TBND1) <A href='../../call_to/TBND.html' TARGET='index'>6</A><a name='4902'>
<a name='4903'>
      IMPLICIT NONE<a name='4904'>
<a name='4905'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4906'></font>
<font color=#447700>!C   PURPOSE:   CALCULATE TEMPERATURE ON THE BOUNDARY OF THE LAYER<a name='4907'></font>
<font color=#447700>!C   =======    BY INTERPOLATION OF THE MIDDLE LAYER TEMPERATURES<a name='4908'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4909'></font>
<a name='4910'>
      INTEGER NSOIL<a name='4911'>
      INTEGER K<a name='4912'>
<a name='4913'>
      REAL TBND1<a name='4914'>
      REAL T0<a name='4915'>
      REAL TU<a name='4916'>
      REAL TB<a name='4917'>
      REAL ZB<a name='4918'>
      REAL ZBOT<a name='4919'>
      REAL ZUP<a name='4920'>
      REAL ZSOIL (NSOIL)<a name='4921'>
<a name='4922'>
      PARAMETER (T0=273.15)<a name='4923'>
<a name='4924'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4925'></font>
<font color=#447700>!C   USE SURFACE TEMPERATURE ON THE TOP OF THE FIRST LAYER<a name='4926'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4927'></font>
      <a name='4928'>
      IF(K .EQ. 1) THEN<a name='4929'>
        ZUP=0.<a name='4930'>
      ELSE<a name='4931'>
        ZUP=ZSOIL(K-1)<a name='4932'>
      ENDIF<a name='4933'>
<a name='4934'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4935'></font>
<font color=#447700>!C   USE DEPTH OF THE CONSTANT BOTTOM TEMPERATURE WHEN INTERPOLATE<a name='4936'></font>
<font color=#447700>!C   TEMPERATURE INTO THE LAST LAYER BOUNDARY<a name='4937'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4938'></font>
      <a name='4939'>
      IF(K .EQ. NSOIL) THEN<a name='4940'>
        ZB=2.*ZBOT-ZSOIL(K)<a name='4941'>
      ELSE<a name='4942'>
        ZB=ZSOIL(K+1)<a name='4943'>
      ENDIF<a name='4944'>
<a name='4945'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4946'></font>
<font color=#447700>!C   LINEAR INTERPOLATION BETWEEN THE AVERAGE LAYER TEMPERATURES<a name='4947'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4948'></font>
      <a name='4949'>
      TBND1 = TU+(TB-TU)*(ZUP-ZSOIL(K))/(ZUP-ZB)<a name='4950'>
      <a name='4951'>
      END SUBROUTINE TBND<a name='4952'>
<a name='4953'>
<A NAME='TDFCND'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#TDFCND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4954'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TDFCND</font> ( DF, SMC, Q,  SMCMAX, SH2O) <A href='../../call_to/TDFCND.html' TARGET='index'>8</A><a name='4955'>
<a name='4956'>
      IMPLICIT NONE<a name='4957'>
<a name='4958'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4959'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE THERMAL DIFFUSIVITY AND CONDUCTIVITY OF<a name='4960'></font>
<font color=#447700>!C    =======   THE SOIL FOR A GIVEN POINT AND TIME.<a name='4961'></font>
<font color=#447700>!C<a name='4962'></font>
<font color=#447700>!C    VERSION:  PETERS-LIDARD APPROACH (PETERS-LIDARD et al., 1998)<a name='4963'></font>
<font color=#447700>!C    =======<a name='4964'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4965'></font>
<a name='4966'>
       REAL DF<a name='4967'>
       REAL GAMMD<a name='4968'>
       REAL THKDRY<a name='4969'>
       REAL AKE<a name='4970'>
       REAL THKICE<a name='4971'>
       REAL THKO<a name='4972'>
       REAL THKQTZ<a name='4973'>
       REAL THKSAT<a name='4974'>
       REAL THKS<a name='4975'>
       REAL THKW<a name='4976'>
       REAL Q<a name='4977'>
       REAL SATRATIO<a name='4978'>
       REAL SH2O<a name='4979'>
       REAL SMC<a name='4980'>
       REAL SMCMAX<a name='4981'>
       REAL XU<a name='4982'>
       REAL XUNFROZ<a name='4983'>
<a name='4984'>
       SAVE<a name='4985'>
<a name='4986'>
<font color=#447700>! WE NOW GET QUARTZ AS AN INPUT ARGUMENT (SET IN ROUTINE REDPRM):<a name='4987'></font>
<font color=#447700>!        DATA QUARTZ /0.82, 0.10, 0.25, 0.60, 0.52, <a name='4988'></font>
<font color=#447700>!     &amp;              0.35, 0.60, 0.40, 0.82/<a name='4989'></font>
<a name='4990'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4991'></font>
<font color=#447700>!     IF THE SOIL HAS ANY MOISTURE CONTENT COMPUTE A PARTIAL SUM/PRODUCT<a name='4992'></font>
<font color=#447700>!     OTHERWISE USE A CONSTANT VALUE WHICH WORKS WELL WITH MOST SOILS<a name='4993'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4994'></font>
<font color=#447700>!  <a name='4995'></font>
<font color=#447700>!<a name='4996'></font>
<font color=#447700>!  THKW ......WATER THERMAL CONDUCTIVITY<a name='4997'></font>
<font color=#447700>!  THKQTZ ....THERMAL CONDUCTIVITY FOR QUARTZ<a name='4998'></font>
<font color=#447700>!  THKO ......THERMAL CONDUCTIVITY FOR OTHER SOIL COMPONENTS<a name='4999'></font>
<font color=#447700>!  THKS ......THERMAL CONDUCTIVITY FOR THE SOLIDS COMBINED(QUARTZ+OTHER)<a name='5000'></font>
<font color=#447700>!  THKICE ....ICE THERMAL CONDUCTIVITY<a name='5001'></font>
<font color=#447700>!  SMCMAX ....POROSITY (= SMCMAX)<a name='5002'></font>
<font color=#447700>!  Q .........QUARTZ CONTENT (SOIL TYPE DEPENDENT)<a name='5003'></font>
<font color=#447700>!<a name='5004'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5005'></font>
<font color=#447700>! USE AS IN PETERS-LIDARD, 1998 (MODIF. FROM JOHANSEN, 1975).<a name='5006'></font>
<font color=#447700>!<a name='5007'></font>
<font color=#447700>!                                  PABLO GRUNMANN, 08/17/98<a name='5008'></font>
<font color=#447700>! REFS.:<a name='5009'></font>
<font color=#447700>!      FAROUKI, O.T.,1986: THERMAL PROPERTIES OF SOILS. SERIES ON ROCK <a name='5010'></font>
<font color=#447700>!              AND SOIL MECHANICS, VOL. 11, TRANS TECH, 136 PP.<a name='5011'></font>
<font color=#447700>!      JOHANSEN, O., 1975: THERMAL CONDUCTIVITY OF SOILS. PH.D. THESIS,<a name='5012'></font>
<font color=#447700>!              UNIVERSITY OF TRONDHEIM,<a name='5013'></font>
<font color=#447700>!      PETERS-LIDARD, C. D., ET AL., 1998: THE EFFECT OF SOIL THERMAL <a name='5014'></font>
<font color=#447700>!              CONDUCTIVITY PARAMETERIZATION ON SURFACE ENERGY FLUXES<a name='5015'></font>
<font color=#447700>!              AND TEMPERATURES. JOURNAL OF THE ATMOSPHERIC SCIENCES,<a name='5016'></font>
<font color=#447700>!              VOL. 55, PP. 1209-1224.<a name='5017'></font>
<font color=#447700>! <a name='5018'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5019'></font>
<a name='5020'>
<font color=#447700>!  NEEDS PARAMETERS<a name='5021'></font>
<font color=#447700>! POROSITY(SOIL TYPE):<a name='5022'></font>
<font color=#447700>!      POROS = SMCMAX<a name='5023'></font>
<font color=#447700>! SATURATION RATIO:<a name='5024'></font>
      SATRATIO = SMC/SMCMAX<a name='5025'>
<font color=#447700>!      print *, 'SATRATIO=',SATRATIO<a name='5026'></font>
<font color=#447700>!     PARAMETERS  W/(M.K)<a name='5027'></font>
      THKICE = 2.2<a name='5028'>
      THKW = 0.57<a name='5029'>
      THKO = 2.0<a name='5030'>
<font color=#447700>!      IF (Q .LE. 0.2) THKO = 3.0<a name='5031'></font>
      THKQTZ = 7.7<a name='5032'>
<font color=#447700>!  SOLIDS' CONDUCTIVITY      <a name='5033'></font>
      THKS = (THKQTZ**Q)*(THKO**(1.- Q))<a name='5034'>
<font color=#447700>!  UNFROZEN FRACTION (FROM 1.0, I.E., 100%LIQUID, TO 0.0 (100% FROZEN))<a name='5035'></font>
      XUNFROZ=(SH2O + 1.E-9)/(SMC + 1.E-9)<a name='5036'>
<font color=#447700>!  UNFROZEN VOLUME FOR SATURATION (POROSITY*XUNFROZ)<a name='5037'></font>
      XU=XUNFROZ*SMCMAX <a name='5038'>
<font color=#447700>!  SATURATED THERMAL CONDUCTIVITY<a name='5039'></font>
      THKSAT = THKS**(1.-SMCMAX)*THKICE**(SMCMAX-XU)*THKW**(XU)<a name='5040'>
<font color=#447700>!  DRY DENSITY IN KG/M3<a name='5041'></font>
      GAMMD = (1. - SMCMAX)*2700.<a name='5042'>
<font color=#447700>!  DRY THERMAL CONDUCTIVITY IN W.M-1.K-1<a name='5043'></font>
      THKDRY = (0.135*GAMMD + 64.7)/(2700. - 0.947*GAMMD)<a name='5044'>
<font color=#447700>! RANGE OF VALIDITY FOR THE KERSTEN NUMBER<a name='5045'></font>
      IF ( SATRATIO .GT. 0.1 ) THEN<a name='5046'>
<a name='5047'>
<font color=#447700>!    KERSTEN NUMBER (FINE FORMULA, AT LEAST 5% OF PARTICLES&lt;(2.E-6)M)<a name='5048'></font>
           IF ( (XUNFROZ + 0.0005) .LT. SMC ) THEN<a name='5049'>
<font color=#447700>!    FROZEN<a name='5050'></font>
              AKE = SATRATIO<a name='5051'>
           ELSE<a name='5052'>
<font color=#447700>!    UNFROZEN<a name='5053'></font>
              AKE = LOG10(SATRATIO) + 1.0<a name='5054'>
           ENDIF<a name='5055'>
<a name='5056'>
      ELSE<a name='5057'>
        <a name='5058'>
<font color=#447700>! USE K = KDRY<a name='5059'></font>
        AKE = 0.0<a name='5060'>
<font color=#447700>!        print *, 'AKE (ELSE) = ',AKE<a name='5061'></font>
      ENDIF<a name='5062'>
<font color=#447700>!  THERMAL CONDUCTIVITY<a name='5063'></font>
<a name='5064'>
       DF = AKE*(THKSAT - THKDRY) + THKDRY<a name='5065'>
<a name='5066'>
      END SUBROUTINE TDFCND<a name='5067'>
<a name='5068'>
<A NAME='TRANSP'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#TRANSP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5069'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TRANSP</font> (ET,NSOIL,ETP1,SMC,CMC,ZSOIL,SHDFAC,SMCWLT,    &amp; <A href='../../call_to/TRANSP.html' TARGET='index'>2</A><a name='5070'>
            CMCMAX,PC,CFACTR,SMCREF,SFCTMP,Q2,NROOT,RTDIS)<a name='5071'>
<a name='5072'>
      IMPLICIT NONE<a name='5073'>
<a name='5074'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5075'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE TRANSPIRATION FROM THE VEGTYP FOR THIS PT.<a name='5076'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5077'></font>
<a name='5078'>
      INTEGER I<a name='5079'>
      INTEGER K<a name='5080'>
      INTEGER NSOIL<a name='5081'>
      INTEGER NROOT<a name='5082'>
<a name='5083'>
      REAL CFACTR<a name='5084'>
      REAL CMC<a name='5085'>
      REAL CMCMAX<a name='5086'>
      REAL ET    ( NSOIL )<a name='5087'>
      REAL ETP1<a name='5088'>
      REAL ETP1A<a name='5089'>
      REAL GX (7)<a name='5090'>
<font color=#447700>!.....REAL PART ( NSOIL )<a name='5091'></font>
      REAL PC<a name='5092'>
      REAL RTDIS ( NSOIL )<a name='5093'>
      REAL SHDFAC<a name='5094'>
      REAL SMC   ( NSOIL )<a name='5095'>
      REAL SMCREF<a name='5096'>
      REAL SMCWLT<a name='5097'>
      REAL ZSOIL ( NSOIL )<a name='5098'>
<a name='5099'>
      REAL SFCTMP, Q2, SGX, DENOM, RTX<a name='5100'>
<a name='5101'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5102'></font>
<font color=#447700>!       INITIALIZE  PLANT TRANSP TO ZERO FOR ALL SOIL LAYERS.<a name='5103'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5104'></font>
<a name='5105'>
      DO K = 1, NSOIL<a name='5106'>
         ET(K) = 0.<a name='5107'>
      END DO<a name='5108'>
<a name='5109'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5110'></font>
<font color=#447700>!       CALC AN 'ADJUSTED' POTNTL TRANSPIRATION<a name='5111'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5112'></font>
<a name='5113'>
<font color=#447700>!cc If statements to avoid TANGENT LINEAR problems near zero<a name='5114'></font>
      IF (CMC .NE. 0.0) THEN<a name='5115'>
      ETP1A = SHDFAC * PC * ETP1 * (1.0 - (CMC /CMCMAX) ** CFACTR)<a name='5116'>
      ELSE<a name='5117'>
      ETP1A = SHDFAC * PC * ETP1<a name='5118'>
      ENDIF<a name='5119'>
      <a name='5120'>
      SGX = 0.0<a name='5121'>
      DO I = 1, NROOT<a name='5122'>
         GX(I) = ( SMC(I) - SMCWLT ) / ( SMCREF - SMCWLT )<a name='5123'>
         GX(I) = MAX ( MIN ( GX(I), 1. ), 0. )<a name='5124'>
         SGX = SGX + GX (I)<a name='5125'>
      END DO<a name='5126'>
      SGX = SGX / NROOT<a name='5127'>
      <a name='5128'>
      DENOM = 0.<a name='5129'>
      DO I = 1,NROOT<a name='5130'>
         RTX = RTDIS(I) + GX(I) - SGX<a name='5131'>
         GX(I) = GX(I) * MAX ( RTX, 0. )<a name='5132'>
         DENOM = DENOM + GX(I)<a name='5133'>
      END DO   <a name='5134'>
      IF ( DENOM .LE. 0.0) DENOM = 1.<a name='5135'>
      <a name='5136'>
      DO I = 1, NROOT<a name='5137'>
         ET(I) = ETP1A * GX(I) / DENOM<a name='5138'>
      END DO <a name='5139'>
<a name='5140'>
<font color=#447700>! ABOVE CODE ASSUMES A VERTICALLY UNIFORM ROOT DISTRIBUTION<a name='5141'></font>
<font color=#447700>!<a name='5142'></font>
<font color=#447700>! CODE BELOW TESTS A VARIABLE ROOT DISTRIBUTION<a name='5143'></font>
<font color=#447700>!<a name='5144'></font>
<font color=#447700>!     ET(1) = ( ZSOIL(1) / ZSOIL(NROOT) ) * GX * ETP1A<a name='5145'></font>
<font color=#447700>!        ET(1) = ( ZSOIL(1) / ZSOIL(NROOT) ) * ETP1A<a name='5146'></font>
<font color=#447700>!<a name='5147'></font>
<font color=#447700>! ###  USING ROOT DISTRIBUTION AS WEIGHTING FACTOR<a name='5148'></font>
<font color=#447700>!     ET(1) = RTDIS(1) * ETP1A<a name='5149'></font>
<font color=#447700>!         ET(1) =  ETP1A*PART(1)<a name='5150'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5151'></font>
<font color=#447700>!     LOOP DOWN THRU THE SOIL LAYERS REPEATING THE OPERATION ABOVE,<a name='5152'></font>
<font color=#447700>!     BUT USING THE THICKNESS OF THE SOIL LAYER (RATHER THAN THE<a name='5153'></font>
<font color=#447700>!     ABSOLUTE DEPTH OF EACH LAYER) IN THE FINAL CALCULATION.<a name='5154'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5155'></font>
      <a name='5156'>
<font color=#447700>!     DO 10 K = 2, NROOT<a name='5157'></font>
<font color=#447700>!     GX = ( SMC(K) - SMCWLT ) / ( SMCREF - SMCWLT )<a name='5158'></font>
<font color=#447700>!     GX = MAX ( MIN ( GX, 1. ), 0. )<a name='5159'></font>
<font color=#447700>!     TEST CANOPY RESISTANCE<a name='5160'></font>
<font color=#447700>!     GX = 1.0<a name='5161'></font>
<font color=#447700>!     ET(K) = ((ZSOIL(K)-ZSOIL(K-1))/ZSOIL(NROOT))*GX*ETP1A<a name='5162'></font>
<font color=#447700>!       ET(K) = ((ZSOIL(K)-ZSOIL(K-1))/ZSOIL(NROOT))*ETP1A<a name='5163'></font>
<font color=#447700>!###  USING ROOT DISTRIBUTION AS WEIGHTING FACTOR<a name='5164'></font>
<font color=#447700>!       ET(K) = RTDIS(K) * ETP1A<a name='5165'></font>
<font color=#447700>!         ET(K) = ETP1A*PART(K)<a name='5166'></font>
<font color=#447700>!     10    CONTINUE<a name='5167'></font>
      <a name='5168'>
      END SUBROUTINE TRANSP<a name='5169'>
<a name='5170'>
<A NAME='WDFCND'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#WDFCND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5171'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>WDFCND</font> ( WDF,WCND,SMC,SMCMAX,B,DKSAT,DWSAT,         &amp; <A href='../../call_to/WDFCND.html' TARGET='index'>8</A><a name='5172'>
                               SICEMAX )<a name='5173'>
<a name='5174'>
      IMPLICIT NONE<a name='5175'>
<a name='5176'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5177'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE SOIL WATER DIFFUSIVITY AND SOIL<a name='5178'></font>
<font color=#447700>!C    =======   HYDRAULIC CONDUCTIVITY.<a name='5179'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5180'></font>
<a name='5181'>
      REAL B<a name='5182'>
      REAL DKSAT<a name='5183'>
      REAL DWSAT<a name='5184'>
      REAL EXPON<a name='5185'>
      REAL FACTR1<a name='5186'>
      REAL FACTR2<a name='5187'>
      REAL SICEMAX<a name='5188'>
      REAL SMC<a name='5189'>
      REAL SMCMAX<a name='5190'>
      REAL VKwgt<a name='5191'>
      REAL WCND<a name='5192'>
      REAL WDF<a name='5193'>
<a name='5194'>
<font color=#447700>!      PRINT*,'------------ in WDFCND -------------------------------'<a name='5195'></font>
<font color=#447700>!      PRINT*,'BEFORE WDFCND'<a name='5196'></font>
<font color=#447700>!      PRINT*,'B=',B<a name='5197'></font>
<font color=#447700>!      PRINT*,'DKSAT=',DKSAT<a name='5198'></font>
<font color=#447700>!      PRINT*,'DWSAT=',DWSAT<a name='5199'></font>
<font color=#447700>!      PRINT*,'EXPON=',EXPON<a name='5200'></font>
<font color=#447700>!      PRINT*,'FACTR2=',FACTR2<a name='5201'></font>
<font color=#447700>!      PRINT*,'SMC=',SMC<a name='5202'></font>
<font color=#447700>!      PRINT*,'SMCMAX=',SMCMAX<a name='5203'></font>
<font color=#447700>!      PRINT*,'WCND=',WCND<a name='5204'></font>
<font color=#447700>!      PRINT*,'WDF=',WDF<a name='5205'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5206'></font>
<font color=#447700>!     CALC THE RATIO OF THE ACTUAL TO THE MAX PSBL SOIL H2O CONTENT<a name='5207'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5208'></font>
<a name='5209'>
      SMC = SMC<a name='5210'>
      SMCMAX = SMCMAX<a name='5211'>
      FACTR1 = 0.2 / SMCMAX<a name='5212'>
      FACTR2 = SMC / SMCMAX<a name='5213'>
<a name='5214'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5215'></font>
<font color=#447700>!     PREP AN EXPNTL COEF AND CALC THE SOIL WATER DIFFUSIVITY<a name='5216'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5217'></font>
<a name='5218'>
      EXPON = B + 2.0<a name='5219'>
      WDF = DWSAT * FACTR2 ** EXPON<a name='5220'>
<a name='5221'>
<font color=#447700>! FROZEN SOIL HYDRAULIC DIFFUSIVITY.  VERY SENSITIVE TO THE VERTICAL<a name='5222'></font>
<font color=#447700>! GRADIENT OF UNFROZEN WATER. THE LATTER GRADIENT CAN BECOME VERY<a name='5223'></font>
<font color=#447700>! EXTREME IN FREEZING/THAWING SITUATIONS, AND GIVEN THE RELATIVELY <a name='5224'></font>
<font color=#447700>! FEW AND THICK SOIL LAYERS, THIS GRADIENT SUFFERES SERIOUS <a name='5225'></font>
<font color=#447700>! TRUNCTION ERRORS YIELDING ERRONEOUSLY HIGH VERTICAL TRANSPORTS OF<a name='5226'></font>
<font color=#447700>! UNFROZEN WATER IN BOTH DIRECTIONS FROM HUGE HYDRAULIC DIFFUSIVITY.  <a name='5227'></font>
<font color=#447700>! THEREFORE, WE FOUND WE HAD TO ARBITRARILY CONSTRAIN WDF <a name='5228'></font>
<font color=#447700>!<a name='5229'></font>
<font color=#447700>! version D_10cm: ........  FACTR1 = 0.2/SMCMAX<a name='5230'></font>
<font color=#447700>! Weighted approach...................... Pablo Grunmann, 09/28/99.<a name='5231'></font>
      IF (SICEMAX .GT. 0.0)  THEN<a name='5232'>
      VKwgt=1./(1.+(500.*SICEMAX)**3.)<a name='5233'>
      WDF = VKwgt*WDF + (1.- VKwgt)*DWSAT*FACTR1**EXPON<a name='5234'>
<font color=#447700>!      PRINT*,'______________________________________________'<a name='5235'></font>
<font color=#447700>!      PRINT*,'Weighted approach:'<a name='5236'></font>
<font color=#447700>!      PRINT*,'  SICEMAX       VKwgt              Dwgt'<a name='5237'></font>
<font color=#447700>!      PRINT*,SICEMAX,  VKwgt, 1.-VKwgt<a name='5238'></font>
<font color=#447700>!      PRINT*,'______________________________________________'<a name='5239'></font>
      ENDIF<a name='5240'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC <a name='5241'></font>
<font color=#447700>!     RESET THE EXPNTL COEF AND CALC THE HYDRAULIC CONDUCTIVITY<a name='5242'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5243'></font>
<a name='5244'>
      EXPON = ( 2.0 * B ) + 3.0<a name='5245'>
      WCND = DKSAT * FACTR2 ** EXPON<a name='5246'>
<a name='5247'>
<font color=#447700>!      PRINT*,' WDFCND Results --------------------------------'<a name='5248'></font>
<font color=#447700>!      PRINT*,'B=',B<a name='5249'></font>
<font color=#447700>!      PRINT*,'DKSAT=',DKSAT<a name='5250'></font>
<font color=#447700>!      PRINT*,'DWSAT=',DWSAT<a name='5251'></font>
<font color=#447700>!      PRINT*,'EXPON=',EXPON<a name='5252'></font>
<font color=#447700>!      PRINT*,'FACTR2=',FACTR2<a name='5253'></font>
<font color=#447700>!      PRINT*,'SMC=',SMC<a name='5254'></font>
<font color=#447700>!      PRINT*,'SMCMAX=',SMCMAX<a name='5255'></font>
<font color=#447700>!      PRINT*,'WCND=',WCND<a name='5256'></font>
<font color=#447700>!      PRINT*,'WDF=',WDF<a name='5257'></font>
<font color=#447700>!      PRINT*,' SMC         WDF           WCND             B'<a name='5258'></font>
<font color=#447700>!      PRINT*,SMC,WDF,WCND,B<a name='5259'></font>
<a name='5260'>
      END SUBROUTINE WDFCND<a name='5261'>
<a name='5262'>
<A NAME='NMMLSMINIT'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#NMMLSMINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5263'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>nmmlsminit</font>(isn,XICE,VEGFRA,SNOW,SNOWC,CANWAT,SMSTAV,       &amp; <A href='../../call_to/NMMLSMINIT.html' TARGET='index'>1</A><a name='5264'>
                        SMSTOT, SFCRUNOFF,UDRUNOFF,GRDFLX,ACSNOW,       &amp;<a name='5265'>
                        ACSNOM,IVGTYP,ISLTYP,TSLB,SMOIS,DZS,SFCEVP,     &amp; <font color=#447700>!  STEMP<a name='5266'></font>
                        TMN,                                            &amp;<a name='5267'>
                        num_soil_layers,                                &amp;<a name='5268'>
                        allowed_to_read,                                &amp;<a name='5269'>
                        ids,ide, jds,jde, kds,kde,                      &amp;<a name='5270'>
                        ims,ime, jms,jme, kms,kme,                      &amp;<a name='5271'>
                        its,ite, jts,jte, kts,kte                     )<a name='5272'>
<a name='5273'>
   IMPLICIT NONE <a name='5274'>
<a name='5275'>
<font color=#447700>! Arguments<a name='5276'></font>
   INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='5277'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='5278'>
                                    its,ite, jts,jte, kts,kte<a name='5279'>
<a name='5280'>
   INTEGER, INTENT(IN)       ::     num_soil_layers<a name='5281'>
<a name='5282'>
   REAL,    DIMENSION( num_soil_layers), INTENT(IN) :: DZS<a name='5283'>
<a name='5284'>
   REAL,    DIMENSION( ims:ime, num_soil_layers, jms:jme )    , &amp;<a name='5285'>
            INTENT(INOUT)    ::                          SMOIS, &amp; <a name='5286'>
                                                         TSLB      <font color=#447700>!STEMP<a name='5287'></font>
<a name='5288'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='5289'>
            INTENT(INOUT)    ::                           SNOW, &amp; <a name='5290'>
                                                         SNOWC, &amp; <a name='5291'>
                                                        CANWAT, &amp;<a name='5292'>
                                                        SMSTAV, &amp;<a name='5293'>
                                                        SMSTOT, &amp;<a name='5294'>
                                                     SFCRUNOFF, &amp;<a name='5295'>
                                                      UDRUNOFF, &amp;<a name='5296'>
                                                        SFCEVP, &amp;<a name='5297'>
                                                        GRDFLX, &amp;<a name='5298'>
                                                        ACSNOW, &amp;<a name='5299'>
                                                          XICE, &amp;<a name='5300'>
                                                        VEGFRA, &amp;<a name='5301'>
                                                        TMN, &amp;<a name='5302'>
                                                        ACSNOM<a name='5303'>
<a name='5304'>
   INTEGER, DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='5305'>
            INTENT(INOUT)    ::                         IVGTYP, &amp;<a name='5306'>
                                                        ISLTYP<a name='5307'>
<a name='5308'>
<font color=#447700>!<a name='5309'></font>
<a name='5310'>
  INTEGER, INTENT(IN) :: isn<a name='5311'>
  LOGICAL, INTENT(IN) :: allowed_to_read<a name='5312'>
<font color=#447700>! Local<a name='5313'></font>
  INTEGER             :: iseason<a name='5314'>
  INTEGER :: icm,jcm,itf,jtf<a name='5315'>
  INTEGER ::  I,J,L<a name='5316'>
<a name='5317'>
<a name='5318'>
   itf=min0(ite,ide-1)<a name='5319'>
   jtf=min0(jte,jde-1)<a name='5320'>
<a name='5321'>
   icm = ide/2<a name='5322'>
   jcm = jde/2<a name='5323'>
<a name='5324'>
   iseason=isn<a name='5325'>
<a name='5326'>
   DO J=jts,jtf<a name='5327'>
       DO I=its,itf<a name='5328'>
<font color=#447700>!      SNOW(i,j)=0.<a name='5329'></font>
       SNOWC(i,j)=0.<a name='5330'>
<font color=#447700>!      SMSTAV(i,j)=<a name='5331'></font>
<font color=#447700>!      SMSTOT(i,j)=<a name='5332'></font>
<font color=#447700>!      SFCRUNOFF(i,j)=<a name='5333'></font>
<font color=#447700>!      UDRUNOFF(i,j)=<a name='5334'></font>
<font color=#447700>!      GRDFLX(i,j)=<a name='5335'></font>
<font color=#447700>!      ACSNOW(i,j)=<a name='5336'></font>
<font color=#447700>!      ACSNOM(i,j)=<a name='5337'></font>
    ENDDO<a name='5338'>
   ENDDO<a name='5339'>
<a name='5340'>
<a name='5341'>
  END SUBROUTINE nmmlsminit<a name='5342'>
<a name='5343'>
<A NAME='CSNOW'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#CSNOW' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5344'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>CSNOW</font> ( DSNOW ) <A href='../../call_to/CSNOW.html' TARGET='index'>2</A><a name='5345'>
<a name='5346'>
      IMPLICIT NONE<a name='5347'>
<a name='5348'>
      REAL C<a name='5349'>
      REAL DSNOW<a name='5350'>
      REAL CSNOW<a name='5351'>
      REAL UNIT<a name='5352'>
<a name='5353'>
      PARAMETER ( UNIT=0.11631 ) <a name='5354'>
                                         <a name='5355'>
<font color=#447700>!   ####  SIMULATION OF TERMAL SNOW CONDUCTIVITY                   <a name='5356'></font>
<font color=#447700>!   ####  SIMULATION UNITS OF CSNOW IS CAL/(CM*HR* C) <a name='5357'></font>
<font color=#447700>!   ####  AND IT WILL BE RETURND IN W/(M* C)<a name='5358'></font>
<font color=#447700>!   ####  BASIC VERSION IS DYACHKOVA EQUATION                                <a name='5359'></font>
<a name='5360'>
<font color=#447700>! #####   DYACHKOVA EQUATION (1960), FOR RANGE 0.1-0.4<a name='5361'></font>
<a name='5362'>
      C=0.328*10**(2.25*DSNOW)<a name='5363'>
      CSNOW=UNIT*C<a name='5364'>
<a name='5365'>
<font color=#447700>! #####    DE VAUX EQUATION (1933), IN RANGE 0.1-0.6<a name='5366'></font>
<font color=#447700>!       CSNOW=0.0293*(1.+100.*DSNOW**2)<a name='5367'></font>
      <a name='5368'>
<font color=#447700>!     #####   E. ANDERSEN FROM FLERCHINGER<a name='5369'></font>
<font color=#447700>!     CSNOW=0.021+2.51*DSNOW**2        <a name='5370'></font>
      <a name='5371'>
      END FUNCTION CSNOW<a name='5372'>
<a name='5373'>
<A NAME='DEVAP'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#DEVAP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5374'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>DEVAP</font> ( ETP1, SMC, ZSOIL, SHDFAC, SMCMAX, B,        &amp; <A href='../../call_to/DEVAP.html' TARGET='index'>1</A><a name='5375'>
                       DKSAT, DWSAT, SMCDRY, SMCREF, SMCWLT, FXEXP)<a name='5376'>
<a name='5377'>
      IMPLICIT NONE<a name='5378'>
<a name='5379'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5380'></font>
<font color=#447700>!C    NAME:  DIRECT EVAPORATION (DEVAP) FUNCTION  VERSION: N/A<a name='5381'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5382'></font>
<a name='5383'>
      REAL B<a name='5384'>
      REAL DEVAP<a name='5385'>
      REAL DKSAT<a name='5386'>
      REAL DWSAT<a name='5387'>
      REAL ETP1<a name='5388'>
      REAL FX<a name='5389'>
      REAL FXEXP<a name='5390'>
      REAL SHDFAC<a name='5391'>
      REAL SMC<a name='5392'>
      REAL SMCDRY<a name='5393'>
      REAL SMCMAX<a name='5394'>
      REAL ZSOIL<a name='5395'>
      REAL SMCREF<a name='5396'>
      REAL SMCWLT<a name='5397'>
      REAL SRATIO<a name='5398'>
<a name='5399'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5400'></font>
<font color=#447700>! DIRECT EVAP A FUNCTION OF RELATIVE SOIL MOISTURE AVAILABILITY, LINEAR<a name='5401'></font>
<font color=#447700>! WHEN FXEXP=1.<a name='5402'></font>
<font color=#447700>! FX &gt; 1 REPRESENTS DEMAND CONTROL<a name='5403'></font>
<font color=#447700>! FX &lt; 1 REPRESENTS FLUX CONTROL<a name='5404'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5405'></font>
      SRATIO = (SMC - SMCDRY) / (SMCMAX - SMCDRY)<a name='5406'>
      IF (SRATIO .GT. 0.) THEN<a name='5407'>
        FX = SRATIO**FXEXP<a name='5408'>
        FX = MAX ( MIN ( FX, 1. ) ,0. )<a name='5409'>
      ELSE<a name='5410'>
        FX = 0.<a name='5411'>
      ENDIF<a name='5412'>
<a name='5413'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5414'></font>
<font color=#447700>!     ALLOW FOR THE DIRECT-EVAP-REDUCING EFFECT OF SHADE<a name='5415'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5416'></font>
<a name='5417'>
      DEVAP = FX * ( 1.0 - SHDFAC ) * ETP1<a name='5418'>
<a name='5419'>
      END FUNCTION DEVAP<a name='5420'>
<a name='5421'>
<A NAME='FRH2O'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#FRH2O' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5422'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>FRH2O</font>(TKELV,SMC,SH2O,SMCMAX,B,PSIS) <A href='../../call_to/FRH2O.html' TARGET='index'>3</A><a name='5423'>
<a name='5424'>
      IMPLICIT NONE<a name='5425'>
<a name='5426'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5427'></font>
<font color=#447700>!C  PURPOSE:  CALCULATE AMOUNT OF SUPERCOOLED LIQUID SOIL WATER CONTENT<a name='5428'></font>
<font color=#447700>!C  IF TEMPERATURE IS BELOW 273.15K (T0).  REQUIRES NEWTON-TYPE ITERATION<a name='5429'></font>
<font color=#447700>!C  TO SOLVE THE NONLINEAR IMPLICIT EQUATION GIVEN IN EQN 17 OF<a name='5430'></font>
<font color=#447700>!C  KOREN ET AL. (1999, JGR, VOL 104(D16), 19569-19585).<a name='5431'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5432'></font>
<font color=#447700>!<a name='5433'></font>
<font color=#447700>! New version (JUNE 2001): much faster and more accurate newton iteration<a name='5434'></font>
<font color=#447700>! achieved by first taking log of eqn cited above -- less than 4<a name='5435'></font>
<font color=#447700>! (typically 1 or 2) iterations achieves convergence.  Also, explicit<a name='5436'></font>
<font color=#447700>! 1-step solution option for special case of parameter !k=0, which reduces<a name='5437'></font>
<font color=#447700>! the original implicit equation to a simpler explicit form, known as the<a name='5438'></font>
<font color=#447700>! ""Flerchinger Eqn". Improved handling of solution in the limit of<a name='5439'></font>
<font color=#447700>! freezing point temperature T0.<a name='5440'></font>
<font color=#447700>!<a name='5441'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5442'></font>
<font color=#447700>!<a name='5443'></font>
<font color=#447700>! INPUT:<a name='5444'></font>
<font color=#447700>!<a name='5445'></font>
<font color=#447700>!   TKELV.........Temperature (Kelvin)<a name='5446'></font>
<font color=#447700>!   SMC...........Total soil moisture content (volumetric)<a name='5447'></font>
<font color=#447700>!   SH2O..........Liquid soil moisture content (volumetric)<a name='5448'></font>
<font color=#447700>!   SMCMAX........Saturation soil moisture content (from REDPRM)<a name='5449'></font>
<font color=#447700>!   B.............Soil type "B" parameter (from REDPRM)<a name='5450'></font>
<font color=#447700>!   PSIS..........Saturated soil matric potential (from REDPRM)<a name='5451'></font>
<font color=#447700>!<a name='5452'></font>
<font color=#447700>! OUTPUT:<a name='5453'></font>
<font color=#447700>!   FRH2O.........supercooled liquid water content.<a name='5454'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5455'></font>
<a name='5456'>
      REAL,INTENT(IN) :: TKELV,SMC,SH2O,SMCMAX,B,PSIS<a name='5457'>
<a name='5458'>
      REAL,PARAMETER :: CK=8.0,BLIM=5.5,ERROR=0.005,HLICE=3.335E5,      &amp;<a name='5459'>
                        GS=9.81,DICE=920.0,DH2O=1000.0,T0=273.15<a name='5460'>
<a name='5461'>
      REAL :: BX,DENOM,DF,DSWL,FK,FRH2O,SWL,SWLK<a name='5462'>
<a name='5463'>
      INTEGER :: KCOUNT,NLOG<a name='5464'>
<a name='5465'>
<font color=#447700>!  ###   LIMITS ON PARAMETER B: B &lt; 5.5  (use parameter BLIM)  ####<a name='5466'></font>
<font color=#447700>!  ###   SIMULATIONS SHOWED IF B &gt; 5.5 UNFROZEN WATER CONTENT  ####<a name='5467'></font>
<font color=#447700>!  ###   IS NON-REALISTICALLY HIGH AT VERY LOW TEMPERATURES    ####<a name='5468'></font>
<font color=#447700>!##################################################################<a name='5469'></font>
<font color=#447700>!<a name='5470'></font>
      BX = B<a name='5471'>
      IF ( B .GT. BLIM ) BX = BLIM<a name='5472'>
<font color=#447700>!------------------------------------------------------------------<a name='5473'></font>
<a name='5474'>
<font color=#447700>! INITIALIZING ITERATIONS COUNTER AND ITERATIVE SOLUTION FLAG.<a name='5475'></font>
      NLOG=0<a name='5476'>
      KCOUNT=0<a name='5477'>
<a name='5478'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5479'></font>
<font color=#447700>!  IF TEMPERATURE NOT SIGNIFICANTLY BELOW FREEZING (T0), SH2O = SMC<a name='5480'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5481'></font>
<a name='5482'>
      IF (TKELV .GT. (T0 - 1.E-3)) THEN<a name='5483'>
<a name='5484'>
        FRH2O=SMC<a name='5485'>
<a name='5486'>
      ELSE<a name='5487'>
<a name='5488'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5489'></font>
       IF (CK .NE. 0.0) THEN<a name='5490'>
<a name='5491'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5492'></font>
<font color=#447700>!CCCCCCCC OPTION 1: ITERATED SOLUTION FOR NONZERO CK CCCCCCCCCCC<a name='5493'></font>
<font color=#447700>!CCCCCCCCCCC IN KOREN ET AL, JGR, 1999, EQN 17 CCCCCCCCCCCCCCCCC<a name='5494'></font>
<font color=#447700>!<a name='5495'></font>
<font color=#447700>! INITIAL GUESS FOR SWL (frozen content)<a name='5496'></font>
        SWL = SMC-SH2O<a name='5497'>
<font color=#447700>! KEEP WITHIN BOUNDS.<a name='5498'></font>
         IF (SWL .GT. (SMC-0.02)) SWL=SMC-0.02<a name='5499'>
         IF(SWL .LT. 0.) SWL=0.<a name='5500'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5501'></font>
<font color=#447700>!  START OF ITERATIONS<a name='5502'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5503'></font>
        DO WHILE (NLOG .LT. 10 .AND. KCOUNT .EQ. 0)<a name='5504'>
         NLOG = NLOG+1<a name='5505'>
         DF = ALOG(( PSIS*GS/HLICE ) * ( ( 1.+CK*SWL )**2. ) *   &amp;<a name='5506'>
              ( SMCMAX/(SMC-SWL) )**BX) - ALOG(-(TKELV-T0)/TKELV)<a name='5507'>
         DENOM = 2. * CK / ( 1.+CK*SWL ) + BX / ( SMC - SWL )<a name='5508'>
         SWLK = SWL - DF/DENOM<a name='5509'>
<font color=#447700>! BOUNDS USEFUL FOR MATHEMATICAL SOLUTION.<a name='5510'></font>
         IF (SWLK .GT. (SMC-0.02)) SWLK = SMC - 0.02<a name='5511'>
         IF(SWLK .LT. 0.) SWLK = 0.<a name='5512'>
<font color=#447700>! MATHEMATICAL SOLUTION BOUNDS APPLIED.<a name='5513'></font>
         DSWL=ABS(SWLK-SWL)<a name='5514'>
         SWL=SWLK<a name='5515'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5516'></font>
<font color=#447700>!C IF MORE THAN 10 ITERATIONS, USE EXPLICIT METHOD (CK=0 APPROX.)<a name='5517'></font>
<font color=#447700>!C WHEN DSWL LESS OR EQ. ERROR, NO MORE ITERATIONS REQUIRED.<a name='5518'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5519'></font>
         IF ( DSWL .LE. ERROR )  THEN<a name='5520'>
           KCOUNT=KCOUNT+1<a name='5521'>
         END IF<a name='5522'>
        END DO<a name='5523'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5524'></font>
<font color=#447700>!  END OF ITERATIONS<a name='5525'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5526'></font>
<font color=#447700>! BOUNDS APPLIED WITHIN DO-BLOCK ARE VALID FOR PHYSICAL SOLUTION.<a name='5527'></font>
        FRH2O = SMC - SWL<a name='5528'>
<font color=#447700>!<a name='5529'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCC END OPTION 1 CCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5530'></font>
<a name='5531'>
       ENDIF<a name='5532'>
<a name='5533'>
       IF (KCOUNT .EQ. 0) THEN<a name='5534'>
<a name='5535'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5536'></font>
<font color=#447700>!CCCC OPTION 2: EXPLICIT SOLUTION FOR FLERCHINGER EQ. i.e. CK=0 CCCCCCCC<a name='5537'></font>
<font color=#447700>!CCCCCCCCCCCC IN KOREN ET AL., JGR, 1999, EQN 17  CCCCCCCCCCCCCCC<a name='5538'></font>
<font color=#447700>!<a name='5539'></font>
        FK=(((HLICE/(GS*(-PSIS)))*((TKELV-T0)/TKELV))**(-1/BX))*SMCMAX<a name='5540'>
<font color=#447700>! APPLY PHYSICAL BOUNDS TO FLERCHINGER SOLUTION<a name='5541'></font>
        IF (FK .LT. 0.02) FK = 0.02<a name='5542'>
        FRH2O = MIN ( FK, SMC )<a name='5543'>
<font color=#447700>!<a name='5544'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCC END OPTION 2 CCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5545'></font>
<a name='5546'>
       ENDIF<a name='5547'>
<a name='5548'>
      ENDIF<a name='5549'>
<a name='5550'>
      END FUNCTION FRH2O<a name='5551'>
<a name='5552'>
<A NAME='SNKSRC'><A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SNKSRC' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5553'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>SNKSRC</font> ( TUP,TM,TDN, SMC, SH2O, ZSOIL,NSOIL,  &amp; <A href='../../call_to/SNKSRC.html' TARGET='index'>4</A>,<A href='../../call_from/SNKSRC.html' TARGET='index'>2</A><a name='5554'>
           SMCMAX, PSISAT, B, DT, K, QTOT) <a name='5555'>
      <a name='5556'>
      IMPLICIT NONE<a name='5557'>
      <a name='5558'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5559'></font>
<font color=#447700>!C    PURPOSE:  TO CALCULATE SINK/SOURCE TERM OF THE TERMAL DIFFUSION<a name='5560'></font>
<font color=#447700>!C    =======   EQUATION. (SH2O) IS AVAILABLE LIQUED WATER.<a name='5561'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5562'></font>
<a name='5563'>
      INTEGER  K<a name='5564'>
      INTEGER  NSOIL<a name='5565'>
      <a name='5566'>
      REAL B<a name='5567'>
      REAL DF<a name='5568'>
      REAL DFH2O<a name='5569'>
      REAL DFICE<a name='5570'>
      REAL DH2O<a name='5571'>
      REAL DT<a name='5572'>
      REAL DZ<a name='5573'>
      REAL DZH<a name='5574'>
      REAL FREE<a name='5575'>
      REAL HLICE<a name='5576'>
      REAL PSISAT<a name='5577'>
      REAL QTOT<a name='5578'>
      REAL SH2O<a name='5579'>
      REAL SMC<a name='5580'>
      REAL SMCMAX<a name='5581'>
      REAL SNKSRC<a name='5582'>
      REAL T0<a name='5583'>
      REAL TAVG<a name='5584'>
      REAL TDN<a name='5585'>
      REAL TM<a name='5586'>
      REAL TUP<a name='5587'>
      REAL TZ<a name='5588'>
      REAL X0<a name='5589'>
      REAL XDN<a name='5590'>
      REAL XH2O<a name='5591'>
      REAL XUP<a name='5592'>
      REAL ZSOIL (NSOIL)<a name='5593'>
<a name='5594'>
      PARAMETER (HLICE=3.3350E5)<a name='5595'>
      PARAMETER (DH2O =1.0000E3)<a name='5596'>
      PARAMETER (  T0 =2.7315E2)<a name='5597'>
      <a name='5598'>
      IF(K.EQ.1) THEN<a name='5599'>
        DZ=-ZSOIL(1)<a name='5600'>
      ELSE<a name='5601'>
        DZ=ZSOIL(K-1)-ZSOIL(K)<a name='5602'>
      ENDIF<a name='5603'>
<a name='5604'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5605'></font>
<font color=#447700>!     CALCULATE POTENTIAL REDUCTION OF LIQUED WATER CONTENT<a name='5606'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5607'></font>
      <a name='5608'>
      XH2O=QTOT*DT/(DH2O*HLICE*DZ) + SH2O<a name='5609'>
      <a name='5610'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5611'></font>
<font color=#447700>!     ESTIMATE UNFROZEN WATER AT TEMPERATURE TAVG,<a name='5612'></font>
<font color=#447700>!     AND CHECK IF CALCULATED WATER CONTENT IS REASONABLE <a name='5613'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC <a name='5614'></font>
        <a name='5615'>
<font color=#447700>!  ####   NEW CALCULATION OF AVERAGE TEMPERATURE (TAVG)   ##########<a name='5616'></font>
<font color=#447700>!  ####   IN FREEZING/THAWING LAYER USING UP, DOWN, AND MIDDLE   ###<a name='5617'></font>
<font color=#447700>!  ####   LAYER TEMPERATURES (TUP, TDN, TM)               ##########<a name='5618'></font>
   <a name='5619'>
      DZH=DZ*0.5<a name='5620'>
<a name='5621'>
      IF (TUP .LT. T0) THEN<a name='5622'>
<a name='5623'>
        IF (TM .LT. T0) THEN<a name='5624'>
<a name='5625'>
          IF (TDN .LT. T0) THEN<a name='5626'>
<a name='5627'>
<font color=#447700>!           *** TUP, TM, TDN &lt; T0 ***<a name='5628'></font>
<a name='5629'>
            TAVG = (TUP + 2.0*TM + TDN)/ 4.0<a name='5630'>
            <a name='5631'>
          ELSE<a name='5632'>
<a name='5633'>
<font color=#447700>!           *** TUP &amp; TM &lt; T0,  TDN &gt;= T0 ***<a name='5634'></font>
<a name='5635'>
            X0 = (T0 - TM) * DZH / (TDN - TM)<a name='5636'>
            TAVG = 0.5 * (TUP*DZH+TM*(DZH+X0)+T0*(2.*DZH-X0)) / DZ<a name='5637'>
                       <a name='5638'>
          ENDIF      <a name='5639'>
<a name='5640'>
        ELSE<a name='5641'>
        <a name='5642'>
          IF (TDN .LT. T0) THEN<a name='5643'>
<a name='5644'>
<font color=#447700>!           *** TUP &lt; T0, TM &gt;= T0, TDN &lt; T0 ***<a name='5645'></font>
<a name='5646'>
            XUP  = (T0-TUP) * DZH / (TM-TUP)<a name='5647'>
            XDN  = DZH - (T0-TM) * DZH / (TDN-TM)<a name='5648'>
            TAVG = 0.5 * (TUP*XUP+T0*(2.*DZ-XUP-XDN)+TDN*XDN) / DZ<a name='5649'>
<a name='5650'>
          ELSE<a name='5651'>
<a name='5652'>
<font color=#447700>!           *** TUP &lt; T0, TM &gt;= T0, TDN &gt;= T0 ***<a name='5653'></font>
<a name='5654'>
            XUP  = (T0-TUP) * DZH / (TM-TUP)<a name='5655'>
            TAVG = 0.5 * (TUP*XUP+T0*(2.*DZ-XUP)) / DZ<a name='5656'>
                      <a name='5657'>
          ENDIF   <a name='5658'>
        <a name='5659'>
        ENDIF<a name='5660'>
<a name='5661'>
      ELSE<a name='5662'>
<a name='5663'>
        IF (TM .LT. T0) THEN<a name='5664'>
<a name='5665'>
          IF (TDN .LT. T0) THEN<a name='5666'>
<a name='5667'>
<font color=#447700>!           *** TUP &gt;= T0, TM &lt; T0, TDN &lt; T0 ***<a name='5668'></font>
<a name='5669'>
            XUP  = DZH - (T0-TUP) * DZH / (TM-TUP)<a name='5670'>
            TAVG = 0.5 * (T0*(DZ-XUP)+TM*(DZH+XUP)+TDN*DZH) / DZ<a name='5671'>
                      <a name='5672'>
          ELSE<a name='5673'>
<a name='5674'>
<font color=#447700>!           *** TUP &gt;= T0, TM &lt; T0, TDN &gt;= T0 ***<a name='5675'></font>
<a name='5676'>
            XUP  = DZH - (T0-TUP) * DZH / (TM-TUP)<a name='5677'>
            XDN  = (T0-TM) * DZH / (TDN-TM)<a name='5678'>
            TAVG = 0.5 * (T0*(2.*DZ-XUP-XDN)+TM*(XUP+XDN)) / DZ<a name='5679'>
                                   <a name='5680'>
          ENDIF   <a name='5681'>
<a name='5682'>
        ELSE<a name='5683'>
<a name='5684'>
          IF (TDN .LT. T0) THEN<a name='5685'>
<a name='5686'>
<font color=#447700>!           *** TUP &gt;= T0, TM &gt;= T0, TDN &lt; T0 ***<a name='5687'></font>
<a name='5688'>
            XDN  = DZH - (T0-TM) * DZH / (TDN-TM)<a name='5689'>
            TAVG = (T0*(DZ-XDN)+0.5*(T0+TDN)*XDN) / DZ<a name='5690'>
                 <a name='5691'>
          ELSE<a name='5692'>
<a name='5693'>
<font color=#447700>!           *** TUP &gt;= T0, TM &gt;= T0, TDN &gt;= T0 ***<a name='5694'></font>
<a name='5695'>
            TAVG = (TUP + 2.0*TM + TDN) / 4.0<a name='5696'>
                      <a name='5697'>
          ENDIF           <a name='5698'>
<a name='5699'>
        ENDIF<a name='5700'>
<a name='5701'>
      ENDIF                      <a name='5702'>
<a name='5703'>
      FREE=<A href='../../html_code/phys/module_sf_lsm_nmm.F.html#FRH2O'>FRH2O</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNKSRC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FRH2O_1">(TAVG, SMC, SH2O, SMCMAX, B, PSISAT )<a name='5704'>
<a name='5705'>
      IF ( XH2O .LT. SH2O .AND. XH2O .LT. FREE) THEN <a name='5706'>
         IF ( FREE .GT. SH2O ) THEN<a name='5707'>
              XH2O = SH2O<a name='5708'>
          ELSE<a name='5709'>
              XH2O = FREE<a name='5710'>
          ENDIF<a name='5711'>
      ENDIF<a name='5712'>
              <a name='5713'>
      IF ( XH2O .GT. SH2O .AND. XH2O .GT. FREE )  THEN<a name='5714'>
         IF ( FREE .LT. SH2O ) THEN<a name='5715'>
              XH2O = SH2O<a name='5716'>
          ELSE<a name='5717'>
              XH2O = FREE<a name='5718'>
          ENDIF<a name='5719'>
      ENDIF <a name='5720'>
<a name='5721'>
      IF(XH2O .LT. 0. ) XH2O=0.<a name='5722'>
      IF(XH2O .GT. SMC) XH2O=SMC<a name='5723'>
<a name='5724'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5725'></font>
<font color=#447700>!     CALCULATE SINK/SOURCE TERM AND REPLACE PREVIOUS WATER CONTENT <a name='5726'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='5727'></font>
     <a name='5728'>
      SNKSRC=-DH2O*HLICE*DZ*(XH2O-SH2O)/DT<a name='5729'>
<a name='5730'>
      SH2O=XH2O<a name='5731'>
      <a name='5732'>
      END FUNCTION SNKSRC<a name='5733'>
<a name='5734'>
END MODULE module_sf_lsm_nmm<a name='5735'>
<a name='5736'>
</pre></body></html>