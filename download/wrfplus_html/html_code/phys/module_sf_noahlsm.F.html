<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_SF_NOAHLSM'><A href='../../html_code/phys/module_sf_noahlsm.F.html#MODULE_SF_NOAHLSM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_noahlsm</font> <A href='../../call_to/MODULE_SF_NOAHLSM.html' TARGET='index'>2</A><a name='3'>
 <a name='4'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#module_sf_noahlsm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_43"><a name='5'>
<a name='6'>
  INTEGER, PARAMETER   :: NSOLD=20<a name='7'>
<font color=#447700>!   REAL, PARAMETER    :: CP = 1004.5<a name='8'></font>
  REAL, PARAMETER      :: RD = 287.04, SIGMA = 5.67E-8,                 &amp;<a name='9'>
                          CPH2O = 4.218E+3,CPICE = 2.106E+3,            &amp;<a name='10'>
                          LSUBF = 3.335E+5<a name='11'>
 <a name='12'>
<font color=#447700>! VEGETATION PARAMETERS<a name='13'></font>
        INTEGER :: LUCATS , BARE<a name='14'>
        integer, PARAMETER :: NLUS=50<a name='15'>
        CHARACTER*4 LUTYPE<a name='16'>
        INTEGER, DIMENSION(1:NLUS) :: NROTBL<a name='17'>
        real, dimension(1:NLUS) ::  SNUPTBL, RSTBL, RGLTBL, HSTBL, LAITBL,        &amp;<a name='18'>
                                    ALBTBL, Z0TBL, SHDTBL, MAXALB<a name='19'>
        REAL ::   TOPT_DATA,CMCMAX_DATA,CFACTR_DATA,RSMAX_DATA <a name='20'>
<a name='21'>
<font color=#447700>! SOIL PARAMETERS<a name='22'></font>
        INTEGER :: SLCATS<a name='23'>
        INTEGER, PARAMETER :: NSLTYPE=30<a name='24'>
        CHARACTER*4 SLTYPE<a name='25'>
        REAL, DIMENSION (1:NSLTYPE) :: BB,DRYSMC,F11,                           &amp;<a name='26'>
        MAXSMC, REFSMC,SATPSI,SATDK,SATDW, WLTSMC,QTZ<a name='27'>
<a name='28'>
<font color=#447700>! LSM GENERAL PARAMETERS<a name='29'></font>
        INTEGER :: SLPCATS<a name='30'>
        INTEGER, PARAMETER :: NSLOPE=30<a name='31'>
        REAL, DIMENSION (1:NSLOPE) :: SLOPE_DATA <a name='32'>
        REAL ::  SBETA_DATA,FXEXP_DATA,CSOIL_DATA,SALP_DATA,REFDK_DATA,           &amp;<a name='33'>
                 REFKDT_DATA,FRZK_DATA,ZBOT_DATA,  SMLOW_DATA,SMHIGH_DATA,        &amp;<a name='34'>
                        CZIL_DATA<a name='35'>
<a name='36'>
<font color=#447700>!<a name='37'></font>
CONTAINS<a name='38'>
<font color=#447700>!<a name='39'></font>
<a name='40'>
<font color=#447700>!----------------------------------------------------------------<a name='41'></font>
<A NAME='LSM'><A href='../../html_code/phys/module_sf_noahlsm.F.html#LSM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='42'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>lsm</font>(DZ8W,QV3D,P8W3D,T3D,TSK,                      &amp; <A href='../../call_to/LSM.html' TARGET='index'>1</A>,<A href='../../call_from/LSM.html' TARGET='index'>1</A><a name='43'>
                  HFX,QFX,LH,GRDFLX, QGH,GSW,GLW,SMSTAV,SMSTOT, &amp;<a name='44'>
                  SFCRUNOFF, UDRUNOFF,IVGTYP,ISLTYP,VEGFRA,     &amp;          <a name='45'>
                  ALBEDO,ALBBCK,ZNT,Z0,TMN,XLAND,XICE, EMISS,   &amp; <a name='46'>
                  SNOWC,QSFC,RAINBL,                            &amp;<a name='47'>
                  num_soil_layers,DT,DZS,ITIMESTEP,             &amp;<a name='48'>
                  SMOIS,TSLB,SNOW,CANWAT,CHS,CPM,ROVCP,         &amp; <font color=#447700>!H   <a name='49'></font>
                  SH2O,SNOWH,                                   &amp; <font color=#447700>!H <a name='50'></font>
                  SNOALB,SHDMIN,SHDMAX,                         &amp; <font color=#447700>!I<a name='51'></font>
                  ACSNOM,ACSNOW,                                &amp; <font color=#447700>!O  <a name='52'></font>
                  ids,ide, jds,jde, kds,kde,                    &amp;<a name='53'>
                  ims,ime, jms,jme, kms,kme,                    &amp;<a name='54'>
                  its,ite, jts,jte, kts,kte                     )<a name='55'>
<font color=#447700>!----------------------------------------------------------------<a name='56'></font>
    IMPLICIT NONE<a name='57'>
<font color=#447700>!----------------------------------------------------------------              <a name='58'></font>
<font color=#447700>!----------------------------------------------------------------<a name='59'></font>
<font color=#447700>! --- atmospheric (WRF generic) variables<a name='60'></font>
<font color=#447700>!-- DT          time step (seconds)<a name='61'></font>
<font color=#447700>!-- DZ8W        thickness of layers (m)<a name='62'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='63'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='64'></font>
<font color=#447700>!-- P3D         3D pressure (Pa)<a name='65'></font>
<font color=#447700>!-- FLHC        exchange coefficient for heat (m/s)<a name='66'></font>
<font color=#447700>!-- FLQC        exchange coefficient for moisture (m/s)<a name='67'></font>
<font color=#447700>!-- PSFC        surface pressure (Pa)<a name='68'></font>
<font color=#447700>!-- XLAND       land mask (1 for land, 2 for water)<a name='69'></font>
<font color=#447700>!-- QGH         saturated mixing ratio at 2 meter<a name='70'></font>
<font color=#447700>!-- GSW         downward short wave flux at ground surface (W/m^2)<a name='71'></font>
<font color=#447700>!-- GLW         downward long wave flux at ground surface (W/m^2)<a name='72'></font>
<font color=#447700>!-- History variables <a name='73'></font>
<font color=#447700>!-- CANWAT      canopy moisture content (mm)<a name='74'></font>
<font color=#447700>!-- TSK         surface temperature (K)<a name='75'></font>
<font color=#447700>!-- TSLB        soil temp (k)<a name='76'></font>
<font color=#447700>!-- SMOIS       total soil moisture content (volumetric fraction)<a name='77'></font>
<font color=#447700>!-- SH2O        unfrozen soil moisture content (volumetric fraction)<a name='78'></font>
<font color=#447700>!                note: frozen soil moisture (i.e., soil ice) = SMOIS - SH2O<a name='79'></font>
<font color=#447700>!-- SNOWH       actual snow depth (m)<a name='80'></font>
<font color=#447700>!-- SNOW        liquid water-equivalent snow depth (m)<a name='81'></font>
<font color=#447700>!-- ALBEDO      time-varying surface albedo including snow effect (unitless fraction)<a name='82'></font>
<font color=#447700>!-- ALBBCK      background surface albedo (unitless fraction)<a name='83'></font>
<font color=#447700>!-- CHS          surface exchange coefficient for heat and moisture (m s-1);<a name='84'></font>
<font color=#447700>! --- soil variables<a name='85'></font>
<font color=#447700>!-- num_soil_layers   the number of soil layers<a name='86'></font>
<font color=#447700>!-- ZS          depths of centers of soil layers   (m)<a name='87'></font>
<font color=#447700>!-- DZS         thicknesses of soil layers (m)<a name='88'></font>
<font color=#447700>!-- SLDPTH      thickness of each soil layer (m, same as DZS)<a name='89'></font>
<font color=#447700>!-- TMN         soil temperature at lower boundary (K)<a name='90'></font>
<font color=#447700>!-- SMCWLT      wilting point (volumetric)<a name='91'></font>
<font color=#447700>!-- SMCDRY      dry soil moisture threshold where direct evap from <a name='92'></font>
<font color=#447700>!               top soil layer ends (volumetric)<a name='93'></font>
<font color=#447700>!-- SMCREF      soil moisture threshold below which transpiration begins to<a name='94'></font>
<font color=#447700>!                   stress (volumetric)<a name='95'></font>
<font color=#447700>!-- SMCMAX      porosity, i.e. saturated value of soil moisture (volumetric)<a name='96'></font>
<font color=#447700>!-- NROOT       number of root layers, a function of veg type, determined<a name='97'></font>
<font color=#447700>!               in subroutine redprm.<a name='98'></font>
<font color=#447700>!-- SMSTAV      Soil moisture availability for evapotranspiration ( <a name='99'></font>
<font color=#447700>!                   fraction between SMCWLT and SMCMXA)<a name='100'></font>
<font color=#447700>!-- SMSTOT      Total soil moisture content frozen+unfrozen) in the soil column (mm)<a name='101'></font>
<font color=#447700>! --- snow variables<a name='102'></font>
<font color=#447700>!-- SNOWC       fraction snow coverage (0-1.0)<a name='103'></font>
<font color=#447700>! --- vegetation variables<a name='104'></font>
<font color=#447700>!-- SNOALB      upper bound on maximum albedo over deep snow <a name='105'></font>
<font color=#447700>!-- SHDMIN      minimum areal fractional coverage of annual green vegetation<a name='106'></font>
<font color=#447700>!-- SHDMAX      maximum areal fractional coverage of annual green vegetation<a name='107'></font>
<font color=#447700>!-- XLAI        leaf area index (dimensionless)<a name='108'></font>
<font color=#447700>!-- Z0BRD       Background fixed roughness length (M)<a name='109'></font>
<font color=#447700>!-- Z0          Background vroughness length (M) as function<a name='110'></font>
<font color=#447700>!-- ZNT         Time varying roughness length (M) as function<a name='111'></font>
<font color=#447700>!-- ALBD(IVGTPK,ISN) background albedo reading from a table<a name='112'></font>
<font color=#447700>! --- LSM output<a name='113'></font>
<font color=#447700>!-- HFX         upward heat flux at the surface (W/m^2)<a name='114'></font>
<font color=#447700>!-- QFX         upward moisture flux at the surface (kg/m^2/s)<a name='115'></font>
<font color=#447700>!-- LH          upward moisture flux at the surface (W m-2)<a name='116'></font>
<font color=#447700>!-- GRDFLX(I,J) ground heat flux (W m-2)<a name='117'></font>
<font color=#447700>!-- FDOWN       radiation forcing at the surface (W m-2) = SOLDN*(1-alb)+LWDN<a name='118'></font>
<font color=#447700>!----------------------------------------------------------------------------<a name='119'></font>
<font color=#447700>!-- EC          canopy water evaporation ((W m-2)<a name='120'></font>
<font color=#447700>!-- EDIR        direct soil evaporation (W m-2)<a name='121'></font>
<font color=#447700>!-- ET          plant transpiration from a particular root layer (W m-2)<a name='122'></font>
<font color=#447700>!-- ETT         total plant transpiration (W m-2)<a name='123'></font>
<font color=#447700>!-- ESNOW       sublimation from (or deposition to if &lt;0) snowpack (W m-2)<a name='124'></font>
<font color=#447700>!-- DRIP        through-fall of precip and/or dew in excess of canopy<a name='125'></font>
<font color=#447700>!                 water-holding capacity (m)<a name='126'></font>
<font color=#447700>!-- DEW         dewfall (or frostfall for t&lt;273.15) (M)<a name='127'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='128'></font>
<font color=#447700>!-- BETA        ratio of actual/potential evap (dimensionless)<a name='129'></font>
<font color=#447700>!-- ETP         potential evaporation (W m-2)<a name='130'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='131'></font>
<font color=#447700>!-- FLX1        precip-snow sfc (W m-2)<a name='132'></font>
<font color=#447700>!-- FLX2        freezing rain latent heat flux (W m-2)<a name='133'></font>
<font color=#447700>!-- FLX3        phase-change heat flux from snowmelt (W m-2)<a name='134'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='135'></font>
<font color=#447700>!-- ACSNOM      snow melt (mm) (water equivalent)<a name='136'></font>
<font color=#447700>!-- ACSNOW      accumulated snow fall (mm) (water equivalent)<a name='137'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='138'></font>
<font color=#447700>!-- RUNOFF1     surface runoff (m s-1), not infiltrating the surface<a name='139'></font>
<font color=#447700>!-- RUNOFF2     subsurface runoff (m s-1), drainage out bottom of last<a name='140'></font>
<font color=#447700>!                  soil layer (baseflow)<a name='141'></font>
<font color=#447700>!  important note: here RUNOFF2 is actually the sum of RUNOFF2 and RUNOFF3<a name='142'></font>
<font color=#447700>!-- RUNOFF3     numerical trunctation in excess of porosity (smcmax)<a name='143'></font>
<font color=#447700>!                  for a given soil layer at the end of a time step (m s-1).<a name='144'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='145'></font>
<font color=#447700>!-- RC          canopy resistance (s m-1)<a name='146'></font>
<font color=#447700>!-- PC          plant coefficient (unitless fraction, 0-1) where PC*ETP = actual transp<a name='147'></font>
<font color=#447700>!-- RSMIN       minimum canopy resistance (s m-1)<a name='148'></font>
<font color=#447700>!-- RCS         incoming solar rc factor (dimensionless)<a name='149'></font>
<font color=#447700>!-- RCT         air temperature rc factor (dimensionless)<a name='150'></font>
<font color=#447700>!-- RCQ         atmos vapor pressure deficit rc factor (dimensionless)<a name='151'></font>
<font color=#447700>!-- RCSOIL      soil moisture rc factor (dimensionless)<a name='152'></font>
<a name='153'>
<font color=#447700>!-- EMISS       surface emissivity (between 0 and 1)<a name='154'></font>
<a name='155'>
<font color=#447700>!-- ROVCP       R/CP<a name='156'></font>
<font color=#447700>!               (R_d/R_v) (dimensionless)<a name='157'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='158'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='159'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='160'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='161'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='162'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='163'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='164'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='165'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='166'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='167'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='168'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='169'></font>
<font color=#447700>!-- its         start index for i in tile<a name='170'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='171'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='172'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='173'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='174'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='175'></font>
<font color=#447700>!----------------------------------------------------------------<a name='176'></font>
<a name='177'>
<font color=#447700>! IN only<a name='178'></font>
<a name='179'>
   INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='180'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='181'>
                                    its,ite, jts,jte, kts,kte<a name='182'>
<a name='183'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='184'>
            INTENT(IN   )    ::                            TMN, &amp;<a name='185'>
                                                         XLAND, &amp;<a name='186'>
                                                          XICE, &amp;<a name='187'>
                                                        VEGFRA, &amp;<a name='188'>
                                                        SHDMIN, &amp;<a name='189'>
                                                        SHDMAX, &amp;<a name='190'>
                                                        SNOALB, &amp;<a name='191'>
                                                           GSW, &amp;<a name='192'>
                                                           GLW, &amp;<a name='193'>
                                                            Z0, &amp;<a name='194'>
                                                        ALBBCK, &amp;<a name='195'>
                                                        RAINBL, &amp;<a name='196'>
                                                        EMISS    <a name='197'>
<a name='198'>
   REAL,    DIMENSION( ims:ime, kms:kme, jms:jme )            , &amp;<a name='199'>
            INTENT(IN   )    ::                           QV3D, &amp;<a name='200'>
                                                         p8w3D, &amp;<a name='201'>
                                                          DZ8W, &amp;<a name='202'>
                                                          T3D<a name='203'>
   REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='204'>
             INTENT(IN   )               ::               QGH,  &amp;<a name='205'>
                                                          CHS,   &amp;<a name='206'>
                                                          CPM<a name='207'>
<a name='208'>
   INTEGER, DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='209'>
            INTENT(IN   )    ::                         IVGTYP, &amp;<a name='210'>
                                                        ISLTYP<a name='211'>
<a name='212'>
   INTEGER, INTENT(IN)       ::     num_soil_layers,ITIMESTEP<a name='213'>
<a name='214'>
   REAL,     INTENT(IN   )   ::     DT,ROVCP<a name='215'>
<a name='216'>
   REAL,     DIMENSION(1:num_soil_layers), INTENT(IN)::DZS<a name='217'>
<a name='218'>
<font color=#447700>! IN and OUT<a name='219'></font>
<a name='220'>
   REAL,     DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), &amp;<a name='221'>
             INTENT(INOUT)   ::                          SMOIS, &amp; <font color=#447700>! total soil moisture<a name='222'></font>
                                                         SH2O,  &amp; <font color=#447700>! new soil liquid<a name='223'></font>
                                                         TSLB     <font color=#447700>! TSLB     STEMP<a name='224'></font>
<a name='225'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='226'>
            INTENT(INOUT)    ::                            TSK, &amp; <font color=#447700>!was TGB (temperature)<a name='227'></font>
                                                           HFX, &amp;     <a name='228'>
                                                           QFX, &amp;     <a name='229'>
                                                            LH, &amp;<a name='230'>
                                                        GRDFLX, &amp;<a name='231'>
                                                          QSFC,&amp;     <a name='232'>
                                                          SNOW, &amp; <a name='233'>
                                                         SNOWC, &amp; <a name='234'>
                                                         SNOWH, &amp; <font color=#447700>!new<a name='235'></font>
                                                        CANWAT, &amp; <a name='236'>
                                                        SMSTAV, &amp;<a name='237'>
                                                        SMSTOT, &amp;<a name='238'>
                                                     SFCRUNOFF, &amp;<a name='239'>
                                                      UDRUNOFF, &amp;<a name='240'>
                                                        ACSNOM, &amp;<a name='241'>
                                                        ACSNOW, &amp;<a name='242'>
                                                        ALBEDO, &amp;<a name='243'>
                                                           ZNT<a name='244'>
<a name='245'>
<a name='246'>
<font color=#447700>! Local variables (moved here from driver to make routine thread safe, 20031007 jm)<a name='247'></font>
<a name='248'>
      REAL, DIMENSION(1:num_soil_layers) ::  ET<a name='249'>
<a name='250'>
      REAL  ::  BETA, ETP, SSOIL,EC, EDIR, ESNOW, ETT,        &amp;<a name='251'>
                FLX1,FLX2,FLX3, DRIP,DEW,FDOWN,RC,PC,RSMIN,XLAI,  &amp;<a name='252'>
                RCS,RCT,RCQ,RCSOIL<a name='253'>
                                                                           <a name='254'>
 <a name='255'>
<font color=#447700>! DECLARATIONS - LOGICAL<a name='256'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='257'></font>
      LOGICAL, PARAMETER :: LOCAL=.false.<a name='258'>
      LOGICAL :: FRZGRA, SNOWNG<a name='259'>
<a name='260'>
      LOGICAL :: IPRINT<a name='261'>
 <a name='262'>
<font color=#447700>! ----------------------------------------------------------------------<a name='263'></font>
<font color=#447700>! DECLARATIONS - INTEGER<a name='264'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='265'></font>
      INTEGER :: I,J, ICE,NSOIL,SLOPETYP,SOILTYP,VEGTYP<a name='266'>
      INTEGER :: NROOT<a name='267'>
      INTEGER :: KZ ,K<a name='268'>
      INTEGER :: NS <a name='269'>
      INTEGER, PARAMETER :: NSOLD = 30<a name='270'>
<font color=#447700>! ----------------------------------------------------------------------<a name='271'></font>
<font color=#447700>! DECLARATIONS - REAL<a name='272'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='273'></font>
<a name='274'>
      REAL  :: SHMIN,SHMAX,DQSDT2,LWDN,PRCP,PRCPRAIN,           &amp;<a name='275'>
               Q2SAT,SFCPRS,SFCSPD,SFCTMP,SHDFAC,SNOALB1,             &amp;<a name='276'>
               SOLDN,TBOT,ZLVL, Q2K,ALBBRD, ALBEDOK, ETA, ETA_KINEMATIC,      &amp;<a name='277'>
               Z0K,RUNOFF1,RUNOFF2,RUNOFF3,SHEAT       <a name='278'>
<a name='279'>
      REAL  :: EMISSI<a name='280'>
<a name='281'>
      REAL  :: SNCOVR,SNEQV,SNOWHK,CMC, CHK,TH2<a name='282'>
<a name='283'>
      REAL  :: SMCDRY,SMCMAX,SMCREF,SMCWLT,SNOMLT,SOILM,SOILW,Q1,T1 <a name='284'>
<a name='285'>
      REAL  :: DUMMY,Z0BRD<a name='286'>
<font color=#447700>!<a name='287'></font>
      REAL  :: COSZ, SOLARDIRECT<a name='288'>
<font color=#447700>!<a name='289'></font>
      REAL, DIMENSION(1:num_soil_layers)::  SLDPTH, STC,SMC,SWC<a name='290'>
<font color=#447700>!<a name='291'></font>
      REAL, DIMENSION(1:NSOLD) ::     ZSOIL, RTDIS   <a name='292'>
      REAL, PARAMETER  :: TRESH=.95E0, A2=17.67,A3=273.15,A4=29.65,   &amp;<a name='293'>
                          T0=273.16E0, ELWV=2.50E6,  A23M4=A2*(A3-A4)<a name='294'>
<a name='295'>
<a name='296'>
<font color=#447700>! debug printout<a name='297'></font>
         IPRINT=.false.<a name='298'>
<font color=#447700>!FEI: temporaray arrays below need to be changed later by using SI<a name='299'></font>
<a name='300'>
      SLOPETYP=2<a name='301'>
<font color=#447700>!      SHDMIN=0.00           <a name='302'></font>
<a name='303'>
<a name='304'>
      NSOIL=num_soil_layers<a name='305'>
<a name='306'>
     DO NS=1,NSOIL<a name='307'>
     SLDPTH(NS)=DZS(NS)<a name='308'>
     ENDDO<a name='309'>
<a name='310'>
   DO J=jts,jte<a name='311'>
<a name='312'>
      IF(ITIMESTEP.EQ.1)THEN                                                 <a name='313'>
        DO 50 I=its,ite<a name='314'>
<font color=#447700>!*** initialize soil conditions for IHOP 31 May case<a name='315'></font>
<font color=#447700>!         IF((XLAND(I,J)-1.5) &lt; 0.)THEN                                <a name='316'></font>
<font color=#447700>!            if (I==108.and.j==85) then<a name='317'></font>
<font color=#447700>!                  DO NS=1,NSOIL<a name='318'></font>
<font color=#447700>!                      SMOIS(I,NS,J)=0.10<a name='319'></font>
<font color=#447700>!                      SH2O(I,NS,J)=0.10<a name='320'></font>
<font color=#447700>!                  enddo<a name='321'></font>
<font color=#447700>!             endif<a name='322'></font>
<font color=#447700>!         ENDIF<a name='323'></font>
<a name='324'>
<font color=#447700>!*** SET ZERO-VALUE FOR SOME OUTPUT DIAGNOSTIC ARRAYS                   <a name='325'></font>
          IF((XLAND(I,J)-1.5).GE.0.)THEN                                <a name='326'>
<font color=#447700>! check sea-ice point                                                   <a name='327'></font>
            IF(XICE(I,J).EQ.1..and.IPRINT)PRINT*,' sea-ice at water point, I=',I,  &amp;<a name='328'>
              'J=',J<a name='329'>
<font color=#447700>!***   Open Water Case                                                  <a name='330'></font>
            SMSTAV(I,J)=1.0                                             <a name='331'>
            SMSTOT(I,J)=1.0                                             <a name='332'>
            DO NS=1,NSOIL                                               <a name='333'>
              SMOIS(I,NS,J)=1.0                                          <a name='334'>
              TSLB(I,NS,J)=273.16                                          <font color=#447700>!STEMP<a name='335'></font>
            ENDDO                                                       <a name='336'>
          ELSE                                                          <a name='337'>
            IF(XICE(I,J).EQ.1.)THEN                                     <a name='338'>
<font color=#447700>!***        SEA-ICE CASE                                                <a name='339'></font>
              SMSTAV(I,J)=1.0                                           <a name='340'>
              SMSTOT(I,J)=1.0                                           <a name='341'>
              DO NS=1,NSOIL                                             <a name='342'>
                SMOIS(I,NS,J)=1.0                                        <a name='343'>
              ENDDO                                                     <a name='344'>
            ENDIF                                                       <a name='345'>
          ENDIF                                                         <a name='346'>
<font color=#447700>!                                                                       <a name='347'></font>
   50   CONTINUE                                                        <a name='348'>
      ENDIF                                                               <font color=#447700>! end of initialization over ocean<a name='349'></font>
<a name='350'>
<font color=#447700>!-----------------------------------------------------------------------<a name='351'></font>
      DO 100 I=its,ite                                                    <a name='352'>
        SFCPRS=P8w3D(i,1,j)<a name='353'>
        Q2K=QV3D(i,1,j)<a name='354'>
        Q2SAT=QGH(I,j)                                                  <a name='355'>
        SFCTMP=T3D(i,1,j)<a name='356'>
        ZLVL=0.5*DZ8W(i,1,j)<a name='357'>
        TH2=SFCTMP+(0.0097545*ZLVL)<a name='358'>
        LWDN=GLW(I,J)<a name='359'>
        EMISSI = EMISS(I,J)<a name='360'>
        SOLDN=GSW(I,J)/(1.0-albedo(i,j))<a name='361'>
        PRCP=RAINBL(i,j)/DT <a name='362'>
        VEGTYP=IVGTYP(I,J)                                            <a name='363'>
        SOILTYP=ISLTYP(I,J)                                            <a name='364'>
        SHDFAC=VEGFRA(I,J)/100.                                       <a name='365'>
        T1=TSK(I,J)<a name='366'>
        CHK=CHS(I,J) <a name='367'>
        SHMIN=SHDMIN(I,J)/100. <font color=#447700>!NEW <a name='368'></font>
        SHMAX=SHDMAX(I,J)/100. <font color=#447700>!NEW<a name='369'></font>
        SNOALB1=SNOALB(I,J)     <font color=#447700>!NEW<a name='370'></font>
<font color=#447700>! convert snow depth from mm to meter<a name='371'></font>
        SNEQV=SNOW(I,J)*0.001<a name='372'>
<font color=#447700>!        SNOWHK=SNOWH(I,J)*0.001     ! check the unit of snowh which is assumed to be mm for now<a name='373'></font>
        SNOWHK=SNOWH(I,J)     <font color=#447700>! check the unit of snowh which is assumed to be m for now<a name='374'></font>
        <a name='375'>
<a name='376'>
<font color=#447700>!***                                                                    <a name='377'></font>
        IF((XLAND(I,J)-1.5).GE.0.)THEN                 <a name='378'>
<font color=#447700>! Open water points<a name='379'></font>
<font color=#447700>!CC     Q2SAT=PQ0/SFCPRS*EXP(A2*(TGDSA(I)-A3)/(TGDSA(I)-A4))<a name='380'></font>
<font color=#447700>!          HFX(I,J)=CHFF*(TGDSA(I)-TH(I))<a name='381'></font>
<font color=#447700>!          QFX(I,J)=RHO(I)*CHS(I)*(Q2SAT-QV(I))<a name='382'></font>
<font color=#447700>!          SFCEVP(I,J)=SFCEVP(I,J)+QFX(I,J)*DT<a name='383'></font>
<a name='384'>
        ELSE<a name='385'>
<font color=#447700>! Land or sea-ice case<a name='386'></font>
<a name='387'>
          IF (XICE(I,J) .GT. 0.5) THEN                                  <a name='388'>
             ICE=1                                                      <a name='389'>
          ELSE                                                          <a name='390'>
             ICE=0                                                      <a name='391'>
          ENDIF                                                         <a name='392'>
          DQSDT2=Q2SAT*A23M4/(SFCTMP-A4)**2                             <a name='393'>
<a name='394'>
          IF(ICE.EQ.0)THEN                                              <a name='395'>
            TBOT=TMN(I,J)                                              <a name='396'>
          ELSE                                                          <a name='397'>
            TBOT=271.16                                                <a name='398'>
          ENDIF                                                         <a name='399'>
          IF(VEGTYP.EQ.25) SHDFAC=0.0001<a name='400'>
          IF(SOILTYP.EQ.14.AND.XICE(I,J).EQ.0.)THEN                      <a name='401'>
         IF(IPRINT)PRINT*,' SOIL TYPE FOUND TO BE WATER AT A LAND-POINT'          <a name='402'>
         IF(IPRINT)PRINT*,i,j,'RESET SOIL in surfce.F'                      <a name='403'>
            SOILTYP=7                                                    <a name='404'>
          ENDIF                                                         <a name='405'>
          CMC=CANWAT(I,J)                                                <a name='406'>
<a name='407'>
<font color=#447700>!-------------------------------------------<a name='408'></font>
<font color=#447700>!*** convert snow depth from mm to meter                                <a name='409'></font>
<font color=#447700>!                                                                       <a name='410'></font>
<font color=#447700>!          IF(RDMAXALB) THEN<a name='411'></font>
<font color=#447700>!           SNOALB=ALBMAX(I,J)*0.01<a name='412'></font>
<font color=#447700>!         ELSE<a name='413'></font>
<font color=#447700>!           SNOALB=MAXALB(IVGTPK)*0.01<a name='414'></font>
<font color=#447700>!         ENDIF<a name='415'></font>
<font color=#447700>!         IF(RDBRDALB) THEN<a name='416'></font>
<font color=#447700>!           ALBBRD=ALBEDO(I,J)*0.01<a name='417'></font>
<font color=#447700>!         ELSE<a name='418'></font>
<font color=#447700>!           ALBBRD=ALBD(IVGTPK,ISN)*0.01<a name='419'></font>
<font color=#447700>!         ENDIF<a name='420'></font>
<a name='421'>
<font color=#447700>!        SNOALB1=0.80<a name='422'></font>
<font color=#447700>!        SHMIN=0.00<a name='423'></font>
        ALBBRD=ALBBCK(I,J)                  <a name='424'>
        Z0BRD=Z0(I,J)<a name='425'>
<font color=#447700>!FEI: temporaray arrays above need to be changed later by using SI<a name='426'></font>
      <a name='427'>
          DO 70 NS=1,NSOIL                                              <a name='428'>
            SMC(NS)=SMOIS(I,NS,J)                                       <a name='429'>
            STC(NS)=TSLB(I,NS,J)                                          <font color=#447700>!STEMP<a name='430'></font>
            SWC(NS)=SH2O(I,NS,J)<a name='431'>
   70     CONTINUE                                                      <a name='432'>
<font color=#447700>!<a name='433'></font>
          if ( (SNEQV.ne.0..AND.SNOWHK.eq.0.).or.(SNOWHK.le.SNEQV) )THEN<a name='434'>
            SNOWHK= 5.*SNEQV<a name='435'>
          endif<a name='436'>
<font color=#447700>!           print *, 'BEFORE SFLX, in Noahlsm_driver'<a name='437'></font>
<font color=#447700>!           print*, 'EMISSI', EMISSI<a name='438'></font>
<font color=#447700>!<a name='439'></font>
          IF(IPRINT) THEN <a name='440'>
<font color=#447700>!                                                                       <a name='441'></font>
       print*, 'BEFORE SFLX, in Noahlsm_driver'<a name='442'>
       print*, 'ICE', ICE, 'DT',DT, 'ZLVL',ZLVL, 'NSOIL', NSOIL,   &amp;<a name='443'>
       'SLDPTH', SLDPTH, 'LOCAL',LOCAL, 'LUTYPE',&amp;<a name='444'>
        LUTYPE, 'SLTYPE',SLTYPE, 'LWDN',LWDN, 'SOLDN',SOLDN,      &amp;<a name='445'>
        'SFCPRS',SFCPRS, 'PRCP',PRCP,'SFCTMP',SFCTMP,'Q2K',Q2K,   &amp;<a name='446'>
         'TH2',TH2,'Q2SAT',Q2SAT,'DQSDT2',DQSDT2,'VEGTYP', VEGTYP,&amp;<a name='447'>
         'SOILTYP',SOILTYP, 'SLOPETYP',SLOPETYP, 'SHDFAC',SHDFAC,&amp;<a name='448'>
         'SHMIN',SHMIN, 'ALBBRD',ALBBRD,'SNOALB1',SNOALB1,'TBOT',&amp;<a name='449'>
          TBOT, 'Z0BRD',Z0BRD, 'Z0K',Z0K, 'CMC',CMC, 'T1',T1,'STC',&amp;<a name='450'>
          STC, 'SMC',SMC, 'SWC',SWC,'SNOWHK',SNOWHK,'SNEQV',SNEQV,&amp;<a name='451'>
          'ALBEDO',ALBEDO,'CHK',CHK,'ETA',ETA,'SHEAT',SHEAT,      &amp;<a name='452'>
          'ETA_KINEMATIC',ETA_KINEMATIC, 'FDOWN',FDOWN,'EC',EC,   &amp;<a name='453'>
          'EDIR',EDIR,'ET',ET,'ETT',ETT,'ESNOW',ESNOW,'DRIP',DRIP,&amp;<a name='454'>
          'DEW',DEW,'BETA',BETA,'ETP',ETP,'SSOIL',SSOIL,'FLX1',FLX1,&amp;<a name='455'>
          'FLX2',FLX2,'FLX3',FLX3,'SNOMLT',SNOMLT,'SNCOVR',SNCOVR,&amp;<a name='456'>
          'RUNOFF1',RUNOFF1,'RUNOFF2',RUNOFF2,'RUNOFF3',RUNOFF3, &amp;<a name='457'>
          'RC',RC, 'PC',PC,'RSMIN',RSMIN,'XLAI',XLAI,'RCS',RCS,  &amp;<a name='458'>
          'RCT',RCT,'RCQ',RCQ,'RCSOIL',RCSOIL,'SOILW',SOILW,     &amp;<a name='459'>
          'SOILM',SOILM,'Q1',Q1,'SMCWLT',SMCWLT,'SMCDRY',SMCDRY,&amp;<a name='460'>
          'SMCREF',SMCREF,'SMCMAX',SMCMAX,'NROOT',NROOT<a name='461'>
           endif<a name='462'>
<a name='463'>
       CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX'>SFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#LSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFLX_2"> (ICE,DT,ZLVL,NSOIL,SLDPTH,                       &amp;    <font color=#447700>!C<a name='464'></font>
                 LOCAL,                                           &amp;    <font color=#447700>!L<a name='465'></font>
                 LUTYPE, SLTYPE,                                  &amp;    <font color=#447700>!CL<a name='466'></font>
                 LWDN,SOLDN,SFCPRS,PRCP,SFCTMP,Q2K,DUMMY,         &amp;    <font color=#447700>!F<a name='467'></font>
                 DUMMY,DUMMY, DUMMY,                              &amp;    <font color=#447700>!F PRCPRAIN not used<a name='468'></font>
                 TH2,Q2SAT,DQSDT2,                                &amp;    <font color=#447700>!I<a name='469'></font>
                 VEGTYP,SOILTYP,SLOPETYP,SHDFAC,SHMIN,DUMMY,      &amp;    <font color=#447700>!I   <a name='470'></font>
                 ALBBRD, SNOALB1,TBOT, Z0BRD, Z0K, EMISSI,        &amp;    <font color=#447700>!S <a name='471'></font>
                 CMC,T1,STC,SMC,SWC,SNOWHK,SNEQV,ALBEDOK,CHK,dummy,&amp;    <font color=#447700>!H<a name='472'></font>
                 ETA,SHEAT, ETA_KINEMATIC,FDOWN,                  &amp;    <font color=#447700>!O<a name='473'></font>
                 EC,EDIR,ET,ETT,ESNOW,DRIP,DEW,                   &amp;    <font color=#447700>!O<a name='474'></font>
                 BETA,ETP,SSOIL,                                  &amp;    <font color=#447700>!O<a name='475'></font>
                 FLX1,FLX2,FLX3,                                  &amp;    <font color=#447700>!O<a name='476'></font>
                 SNOMLT,SNCOVR,                                   &amp;    <font color=#447700>!O<a name='477'></font>
                 RUNOFF1,RUNOFF2,RUNOFF3,                         &amp;    <font color=#447700>!O<a name='478'></font>
                 RC,PC,RSMIN,XLAI,RCS,RCT,RCQ,RCSOIL,             &amp;    <font color=#447700>!O<a name='479'></font>
                 SOILW,SOILM,Q1,                                  &amp;    <font color=#447700>!D<a name='480'></font>
                 SMCWLT,SMCDRY,SMCREF,SMCMAX,NROOT)<a name='481'>
<a name='482'>
<a name='483'>
<font color=#447700>!           print *, 'AFTER SFLX, in Noahlsm_driver'<a name='484'></font>
<font color=#447700>!           print*, 'EMISSI', EMISSI<a name='485'></font>
<a name='486'>
          IF(IPRINT) THEN <a name='487'>
       print*, 'AFTER SFLX, in Noahlsm_driver'<a name='488'>
       print*, 'ICE', ICE, 'DT',DT, 'ZLVL',ZLVL, 'NSOIL', NSOIL,   &amp;<a name='489'>
       'SLDPTH', SLDPTH, 'LOCAL',LOCAL, 'LUTYPE',&amp;<a name='490'>
        LUTYPE, 'SLTYPE',SLTYPE, 'LWDN',LWDN, 'SOLDN',SOLDN,      &amp;<a name='491'>
        'SFCPRS',SFCPRS, 'PRCP',PRCP,'SFCTMP',SFCTMP,'Q2K',Q2K,   &amp;<a name='492'>
         'TH2',TH2,'Q2SAT',Q2SAT,'DQSDT2',DQSDT2,'VEGTYP', VEGTYP,&amp;<a name='493'>
          'SOILTYP',SOILTYP, 'SLOPETYP',SLOPETYP, 'SHDFAC',SHDFAC,&amp;<a name='494'>
         'SHDMIN',SHMIN, 'ALBBRD',ALBBRD,'SNOALB',SNOALB1,'TBOT',&amp;<a name='495'>
          TBOT, 'Z0BRD',Z0BRD, 'Z0K',Z0K, 'CMC',CMC, 'T1',T1,'STC',&amp;<a name='496'>
          STC, 'SMC',SMC, 'SWc',SWC,'SNOWHK',SNOWHK,'SNEQV',SNEQV,&amp;<a name='497'>
          'ALBEDO',ALBEDOK,'CHK',CHK,'ETA',ETA,'SHEAT',SHEAT,      &amp;<a name='498'>
          'ETA_KINEMATIC',ETA_KINEMATIC, 'FDOWN',FDOWN,'EC',EC,   &amp;<a name='499'>
          'EDIR',EDIR,'ET',ET,'ETT',ETT,'ESNOW',ESNOW,'DRIP',DRIP,&amp;<a name='500'>
          'DEW',DEW,'BETA',BETA,'ETP',ETP,'SSOIL',SSOIL,'FLX1',FLX1,&amp;<a name='501'>
          'FLX2',FLX2,'FLX3',FLX3,'SNOMLT',SNOMLT,'SNCOVR',SNCOVR,&amp;<a name='502'>
          'RUNOFF1',RUNOFF1,'RUNOFF2',RUNOFF2,'RUNOFF3',RUNOFF3, &amp;<a name='503'>
          'RC',RC, 'PC',PC,'RSMIN',RSMIN,'XLAI',XLAI,'RCS',RCS,  &amp;<a name='504'>
          'RCT',RCT,'RCQ',RCQ,'RCSOIL',RCSOIL,'SOILW',SOILW,     &amp;<a name='505'>
          'SOILM',SOILM,'Q1',Q1,'SMCWLT',SMCWLT,'SMCDRY',SMCDRY,&amp;<a name='506'>
          'SMCREF',SMCREF,'SMCMAX',SMCMAX,'NROOT',NROOT<a name='507'>
           endif<a name='508'>
 <a name='509'>
<font color=#447700>!***  UPDATE STATE VARIABLES <a name='510'></font>
          CANWAT(I,J)=CMC                                                <a name='511'>
          SNOW(I,J)=SNEQV*1000.<a name='512'>
<font color=#447700>!          SNOWH(I,J)=SNOWHK*1000.<a name='513'></font>
          SNOWH(I,J)=SNOWHK                   <font color=#447700>! SNOWHK is assumed in meters<a name='514'></font>
          ALBEDO(I,J)=ALBEDOK<a name='515'>
          ZNT(I,J)=Z0K<a name='516'>
          TSK(I,J)=T1<a name='517'>
          HFX(I,J)=SHEAT <a name='518'>
          QFX(I,J)=ETA_KINEMATIC<a name='519'>
          LH(I,J)=ETA<a name='520'>
          GRDFLX(I,J)=SSOIL<a name='521'>
          SNOWC(I,J)=SNCOVR<a name='522'>
          QSFC(I,J)=Q1<a name='523'>
<font color=#447700>!                                                                       <a name='524'></font>
          DO 80 NS=1,NSOIL                                              <a name='525'>
           SMOIS(I,NS,J)=SMC(NS)                                       <a name='526'>
           TSLB(I,NS,J)=STC(NS)                                        <font color=#447700>!  STEMP<a name='527'></font>
           SH2O(I,NS,J)=SWC(NS)<a name='528'>
   80     CONTINUE                                                      <a name='529'>
<font color=#447700>!       ENDIF                                                           <a name='530'></font>
<a name='531'>
<font color=#447700>!***  DIAGNOSTICS                                                       <a name='532'></font>
          SMSTAV(I,J)=SOILW                                            <a name='533'>
          SMSTOT(I,J)=SOILM*1000.                                      <a name='534'>
<font color=#447700>!         Convert the water unit into mm<a name='535'></font>
          SFCRUNOFF(I,J)=SFCRUNOFF(I,J)+RUNOFF1*DT*1000.0<a name='536'>
          UDRUNOFF(I,J)=UDRUNOFF(I,J)+(RUNOFF2+RUNOFF3)*DT*1000.0<a name='537'>
          IF(SFCTMP&lt;=T0)THEN<a name='538'>
<font color=#447700>!            ACSNOW(I,J)=ACSNOW(I,J)+PREC(I)*DT<a name='539'></font>
            ACSNOW(I,J)=ACSNOW(I,J)+PRCP*DT<a name='540'>
          ENDIF<a name='541'>
          IF(SNOW(I,J).GT.0.)THEN<a name='542'>
            ACSNOM(I,J)=ACSNOM(I,J)+SNOMLT*1000.<a name='543'>
          ENDIF<a name='544'>
<a name='545'>
        ENDIF                                                           <font color=#447700>! endif of land-sea test <a name='546'></font>
<a name='547'>
  100 CONTINUE                                                          <font color=#447700>! of I loop<a name='548'></font>
<a name='549'>
   ENDDO                                                                <font color=#447700>! of J loop<a name='550'></font>
<font color=#447700>!------------------------------------------------------<a name='551'></font>
   END SUBROUTINE lsm<a name='552'>
<font color=#447700>!------------------------------------------------------<a name='553'></font>
 <a name='554'>
<A NAME='LSMINIT'><A href='../../html_code/phys/module_sf_noahlsm.F.html#LSMINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='555'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>LSMINIT</font>(VEGFRA,SNOW,SNOWC,SNOWH,CANWAT,SMSTAV,    &amp; <A href='../../call_to/LSMINIT.html' TARGET='index'>1</A>,<A href='../../call_from/LSMINIT.html' TARGET='index'>5</A><a name='556'>
                     SMSTOT, SFCRUNOFF,UDRUNOFF,ACSNOW,        &amp;<a name='557'>
                     ACSNOM,IVGTYP,ISLTYP,TSLB,SMOIS,SH2O,ZS,DZS, &amp; <a name='558'>
                     FNDSOILW, FNDSNOWH,                       &amp;<a name='559'>
                     num_soil_layers, restart,                 &amp;<a name='560'>
                     allowed_to_read ,                         &amp;<a name='561'>
                     ids,ide, jds,jde, kds,kde,                &amp;<a name='562'>
                     ims,ime, jms,jme, kms,kme,                &amp;<a name='563'>
                     its,ite, jts,jte, kts,kte                 )<a name='564'>
<a name='565'>
   INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='566'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='567'>
                                    its,ite, jts,jte, kts,kte<a name='568'>
<a name='569'>
   INTEGER, INTENT(IN)       ::     num_soil_layers<a name='570'>
<a name='571'>
   LOGICAL , INTENT(IN) :: restart , allowed_to_read<a name='572'>
<a name='573'>
   REAL,    DIMENSION( num_soil_layers), INTENT(INOUT) :: ZS, DZS<a name='574'>
<a name='575'>
   REAL,    DIMENSION( ims:ime, num_soil_layers, jms:jme )    , &amp;<a name='576'>
            INTENT(INOUT)    ::                          SMOIS, &amp;  <font color=#447700>!Total soil moisture<a name='577'></font>
                                                         SH2O,  &amp;  <font color=#447700>!liquid soil moisture<a name='578'></font>
                                                         TSLB      <font color=#447700>!STEMP<a name='579'></font>
<a name='580'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='581'>
            INTENT(INOUT)    ::                           SNOW, &amp; <a name='582'>
                                                         SNOWH, &amp;<a name='583'>
                                                         SNOWC, &amp; <a name='584'>
                                                        CANWAT, &amp;<a name='585'>
                                                        SMSTAV, &amp;<a name='586'>
                                                        SMSTOT, &amp;<a name='587'>
                                                     SFCRUNOFF, &amp;<a name='588'>
                                                      UDRUNOFF, &amp;<a name='589'>
                                                        ACSNOW, &amp;<a name='590'>
                                                        VEGFRA, &amp;<a name='591'>
                                                        ACSNOM<a name='592'>
<a name='593'>
   INTEGER, DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='594'>
            INTENT(IN)       ::                         IVGTYP, &amp;<a name='595'>
                                                        ISLTYP<a name='596'>
<a name='597'>
   LOGICAL, INTENT(IN)       ::                      FNDSOILW , &amp;<a name='598'>
                                                     FNDSNOWH<a name='599'>
<a name='600'>
   INTEGER                   :: L<a name='601'>
   REAL                      :: BX, SMCMAX, PSISAT, FREE<a name='602'>
   REAL, PARAMETER           :: BLIM = 5.5, HLICE = 3.335E5,    &amp;<a name='603'>
                                GRAV = 9.81, T0 = 273.15<a name='604'>
<a name='605'>
<font color=#447700>!<a name='606'></font>
<a name='607'>
<a name='608'>
<font color=#447700>! initialize three Noah LSM related tables<a name='609'></font>
   IF ( allowed_to_read ) THEN<a name='610'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_57">( 'INITIALIZE THREE Noah LSM RELATED TABLES' )<a name='611'>
     CALL  <A href='../../html_code/phys/module_sf_noahlsm.F.html#LSM_PARM_INIT'>LSM_PARM_INIT</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LSM_PARM_INIT_1"><a name='612'>
   ENDIF<a name='613'>
   <a name='614'>
   IF(.not.restart)THEN<a name='615'>
<a name='616'>
   itf=min0(ite,ide-1)<a name='617'>
   jtf=min0(jte,jde-1)<a name='618'>
<a name='619'>
   IF ( MINVAL ( ISLTYP( its:itf, jts:jtf ) ) .LT. 1 ) THEN<a name='620'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_190">( "module_sf_noahlsm.F: lsminit: out of range value of ISLTYP. Is this field in the input?" )<a name='621'>
   ENDIF<a name='622'>
<a name='623'>
<font color=#447700>! initialize soil liquid water content SH2O<a name='624'></font>
<a name='625'>
<font color=#447700>!  IF(.NOT.FNDSOILW) THEN<a name='626'></font>
<a name='627'>
<font color=#447700>! If no SWC, do the following<a name='628'></font>
<font color=#447700>!         PRINT *,'SOIL WATER NOT FOUND - VALUE SET IN LSMINIT'<a name='629'></font>
        DO J = jts,jtf<a name='630'>
        DO I = its,itf<a name='631'>
          BX = BB(ISLTYP(I,J))<a name='632'>
          SMCMAX = MAXSMC(ISLTYP(I,J))<a name='633'>
          PSISAT = SATPSI(ISLTYP(I,J))<a name='634'>
         if ((bx &gt; 0.0).and.(smcmax &gt; 0.0).and.(psisat &gt; 0.0)) then<a name='635'>
          DO NS=1, num_soil_layers<a name='636'>
<font color=#447700>! ----------------------------------------------------------------------<a name='637'></font>
<font color=#447700>!SH2O  &lt;= SMOIS for T &lt; 273.149K (-0.001C)<a name='638'></font>
             IF (TSLB(I,NS,J) &lt; 273.149) THEN<a name='639'>
<font color=#447700>! ----------------------------------------------------------------------<a name='640'></font>
<font color=#447700>! first guess following explicit solution for Flerchinger Eqn from Koren<a name='641'></font>
<font color=#447700>! et al, JGR, 1999, Eqn 17 (KCOUNT=0 in FUNCTION FRH2O).<a name='642'></font>
<font color=#447700>! ISLTPK is soil type<a name='643'></font>
              BX = BB(ISLTYP(I,J))<a name='644'>
              SMCMAX = MAXSMC(ISLTYP(I,J))<a name='645'>
              PSISAT = SATPSI(ISLTYP(I,J))<a name='646'>
              IF ( BX &gt;  BLIM ) BX = BLIM<a name='647'>
              FK=(( (HLICE/(GRAV*(-PSISAT))) *                              &amp;<a name='648'>
                 ((TSLB(I,NS,J)-T0)/TSLB(I,NS,J)) )**(-1/BX) )*SMCMAX<a name='649'>
              IF (FK &lt; 0.02) FK = 0.02<a name='650'>
              SH2O(I,NS,J) = MIN( FK, SMOIS(I,NS,J) )<a name='651'>
<font color=#447700>! ----------------------------------------------------------------------<a name='652'></font>
<font color=#447700>! now use iterative solution for liquid soil water content using<a name='653'></font>
<font color=#447700>! FUNCTION FRH2O with the initial guess for SH2O from above explicit<a name='654'></font>
<font color=#447700>! first guess.<a name='655'></font>
              CALL <A href='../../html_code/phys/module_sf_lsm_nmm.F.html#FRH2O'>FRH2O</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FRH2O_2"> (FREE,TSLB(I,NS,J),SMOIS(I,NS,J),SH2O(I,NS,J),    &amp;<a name='656'>
                 SMCMAX,BX,PSISAT)<a name='657'>
              SH2O(I,NS,J) = FREE<a name='658'>
             ELSE             <font color=#447700>! of IF (TSLB(I,NS,J) <a name='659'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='660'></font>
<font color=#447700>! SH2O = SMOIS ( for T =&gt; 273.149K (-0.001C)<a name='661'></font>
              SH2O(I,NS,J)=SMOIS(I,NS,J)<a name='662'>
<font color=#447700>! ----------------------------------------------------------------------<a name='663'></font>
             ENDIF            <font color=#447700>! of IF (TSLB(I,NS,J)<a name='664'></font>
          END DO              <font color=#447700>! of DO NS=1, num_soil_layers <a name='665'></font>
         else                 <font color=#447700>! of if ((bx &gt; 0.0)<a name='666'></font>
          DO NS=1, num_soil_layers<a name='667'>
           SH2O(I,NS,J)=SMOIS(I,NS,J)<a name='668'>
          END DO<a name='669'>
         endif                <font color=#447700>! of if ((bx &gt; 0.0) <a name='670'></font>
        ENDDO                 <font color=#447700>! DO I = its,itf<a name='671'></font>
        ENDDO                 <font color=#447700>! DO J = jts,jtf<a name='672'></font>
<font color=#447700>!  ENDIF                       ! of IF(.NOT.FNDSOILW)THEN <a name='673'></font>
<a name='674'>
<font color=#447700>! initialize physical snow height SNOWH<a name='675'></font>
<a name='676'>
        IF(.NOT.FNDSNOWH)THEN<a name='677'>
<font color=#447700>! If no SNOWH do the following<a name='678'></font>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_58">( 'SNOW HEIGHT NOT FOUND - VALUE DEFINED IN LSMINIT' ) <a name='679'>
          DO J = jts,jtf<a name='680'>
          DO I = its,itf<a name='681'>
            SNOWH(I,J)=SNOW(I,J)*0.005               <font color=#447700>! SNOW in mm and SNOWH in m<a name='682'></font>
          ENDDO<a name='683'>
          ENDDO<a name='684'>
        ENDIF<a name='685'>
<a name='686'>
<font color=#447700>! initialize canopy water to ZERO<a name='687'></font>
<a name='688'>
<font color=#447700>!          GO TO 110<a name='689'></font>
<font color=#447700>!         print*,'Note that canopy water content (CANWAT) is set to ZERO in LSMINIT' <a name='690'></font>
          DO J = jts,jtf<a name='691'>
          DO I = its,itf<a name='692'>
            CANWAT(I,J)=0.0<a name='693'>
          ENDDO<a name='694'>
          ENDDO<a name='695'>
 110      CONTINUE<a name='696'>
   <a name='697'>
   ENDIF<a name='698'>
<font color=#447700>!------------------------------------------------------------------------------<a name='699'></font>
  END SUBROUTINE lsminit<a name='700'>
<font color=#447700>!------------------------------------------------------------------------------<a name='701'></font>
<a name='702'>
<a name='703'>
<a name='704'>
<font color=#447700>!<a name='705'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='706'></font>
<A NAME='LSM_PARM_INIT'><A href='../../html_code/phys/module_sf_noahlsm.F.html#LSM_PARM_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='707'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>LSM_PARM_INIT</font> <A href='../../call_to/LSM_PARM_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/LSM_PARM_INIT.html' TARGET='index'>1</A><a name='708'>
<font color=#447700>!-----------------------------------------------------------------<a name='709'></font>
<a name='710'>
        character*4 :: MMINLU, MMINSL <a name='711'>
<a name='712'>
        MMINLU='USGS'<a name='713'>
        MMINSL='STAS'<a name='714'>
        call <A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM'>SOIL_VEG_GEN_PARM</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#LSM_PARM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_VEG_GEN_PARM_1">( MMINLU, MMINSL)<a name='715'>
<a name='716'>
<font color=#447700>!-----------------------------------------------------------------<a name='717'></font>
        END SUBROUTINE LSM_PARM_INIT <a name='718'>
<font color=#447700>!-----------------------------------------------------------------<a name='719'></font>
<a name='720'>
<font color=#447700>!-----------------------------------------------------------------<a name='721'></font>
<A NAME='SOIL_VEG_GEN_PARM'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='722'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOIL_VEG_GEN_PARM</font>( MMINLU, MMINSL) <A href='../../call_to/SOIL_VEG_GEN_PARM.html' TARGET='index'>1</A>,<A href='../../call_from/SOIL_VEG_GEN_PARM.html' TARGET='index'>58</A><a name='723'>
<font color=#447700>!-----------------------------------------------------------------<a name='724'></font>
<a name='725'>
        IMPLICIT NONE                                                        <a name='726'>
<a name='727'>
        integer :: LUMATCH, IINDEX, LC, NUM_SLOPE <a name='728'>
        integer :: ierr<a name='729'>
        INTEGER , PARAMETER :: OPEN_OK = 0<a name='730'>
<a name='731'>
        character*4 :: MMINLU, MMINSL<a name='732'>
        character*128 :: mess , message<a name='733'>
        logical, external :: wrf_dm_on_monitor<a name='734'>
 <a name='735'>
<a name='736'>
<font color=#447700>!-----SPECIFY VEGETATION RELATED CHARACTERISTICS :<a name='737'></font>
<font color=#447700>!             ALBBCK: SFC albedo (in percentage)<a name='738'></font>
<font color=#447700>!                 Z0: Roughness length (m)<a name='739'></font>
<font color=#447700>!             SHDFAC: Green vegetation fraction (in percentage)<a name='740'></font>
<font color=#447700>!  Note: The ALBEDO, Z0, and SHDFAC values read from the following table<a name='741'></font>
<font color=#447700>!          ALBEDO, amd Z0 are specified in LAND-USE TABLE; and SHDFAC is<a name='742'></font>
<font color=#447700>!          the monthly green vegetation data<a name='743'></font>
<font color=#447700>!             CMXTBL: MAX CNPY Capacity (m)<a name='744'></font>
<font color=#447700>!             NROTBL: Rooting depth (layer)<a name='745'></font>
<font color=#447700>!              RSMIN: Mimimum stomatal resistance (s m-1)<a name='746'></font>
<font color=#447700>!              RSMAX: Max. stomatal resistance (s m-1)<a name='747'></font>
<font color=#447700>!                RGL: Parameters used in radiation stress function<a name='748'></font>
<font color=#447700>!                 HS: Parameter used in vapor pressure deficit functio<a name='749'></font>
<font color=#447700>!               TOPT: Optimum transpiration air temperature. (K)<a name='750'></font>
<font color=#447700>!             CMCMAX: Maximum canopy water capacity<a name='751'></font>
<font color=#447700>!             CFACTR: Parameter used in the canopy inteception calculati<a name='752'></font>
<font color=#447700>!               SNUP: Threshold snow depth (in water equivalent m) that<a name='753'></font>
<font color=#447700>!                     implies 100% snow cover<a name='754'></font>
<font color=#447700>!                LAI: Leaf area index (dimensionless)<a name='755'></font>
<font color=#447700>!             MAXALB: Upper bound on maximum albedo over deep snow<a name='756'></font>
<font color=#447700>!<a name='757'></font>
<font color=#447700>!-----READ IN VEGETAION PROPERTIES FROM VEGPARM.TBL <a name='758'></font>
<font color=#447700>!                                                                       <a name='759'></font>
<a name='760'>
       IF ( wrf_dm_on_monitor() ) THEN<a name='761'>
<a name='762'>
        OPEN(19, FILE='VEGPARM.TBL',FORM='FORMATTED',STATUS='OLD',IOSTAT=ierr)  <a name='763'>
        IF(ierr .NE. OPEN_OK ) THEN<a name='764'>
          WRITE(message,FMT='(A)') &amp;<a name='765'>
          'module_sf_noahlsm.F: soil_veg_gen_parm: failure opening VEGPARM.TBL'<a name='766'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_191"> ( message ) <a name='767'>
        END IF<a name='768'>
<a name='769'>
        WRITE ( mess, * ) 'INPUT LANDUSE = ',MMINLU                                 <a name='770'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_59">( mess )<a name='771'>
<a name='772'>
        LUMATCH=0                                                       <a name='773'>
<a name='774'>
        READ (19,*)<a name='775'>
        READ (19,2000,END=2002)LUTYPE                                   <a name='776'>
        READ (19,*)LUCATS,IINDEX                                        <a name='777'>
 2000   FORMAT (A4) <a name='778'>
<a name='779'>
        IF(LUTYPE.EQ.MMINLU)THEN                                        <a name='780'>
          WRITE( mess , * ) 'LANDUSE TYPE = ',LUTYPE,' FOUND',           &amp;                 <a name='781'>
                  LUCATS,' CATEGORIES'<a name='782'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_60">( mess )<a name='783'>
          LUMATCH=1                                                     <a name='784'>
        ENDIF                                                           <a name='785'>
<a name='786'>
            IF(LUTYPE.EQ.MMINLU)THEN                                    <a name='787'>
          DO LC=1,LUCATS                                                <a name='788'>
              READ (19,*)IINDEX,ALBTBL(LC),Z0TBL(LC),SHDTBL(LC),   &amp;  <a name='789'>
                        NROTBL(LC),RSTBL(LC),RGLTBL(LC),HSTBL(LC), &amp; <a name='790'>
                        SNUPTBL(LC),LAITBL(LC),MAXALB(LC)<a name='791'>
          ENDDO<a name='792'>
<font color=#447700>!<a name='793'></font>
          READ (19,*)<a name='794'>
          READ (19,*)TOPT_DATA<a name='795'>
          READ (19,*)<a name='796'>
          READ (19,*)CMCMAX_DATA<a name='797'>
          READ (19,*)<a name='798'>
          READ (19,*)CFACTR_DATA<a name='799'>
          READ (19,*)<a name='800'>
          READ (19,*)RSMAX_DATA<a name='801'>
          READ (19,*)<a name='802'>
          READ (19,*)BARE<a name='803'>
           ENDIF<a name='804'>
<font color=#447700>!<a name='805'></font>
 2002   CONTINUE                                                        <a name='806'>
<a name='807'>
        CLOSE (19)                                                        <a name='808'>
      ENDIF<a name='809'>
<a name='810'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_STRING'>wrf_dm_bcast_string</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_STRING_7">  ( LUTYPE  , 4 )<a name='811'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_3"> ( LUCATS  , 1 )<a name='812'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_4"> ( IINDEX  , 1 )<a name='813'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_5"> ( LUMATCH , 1 )<a name='814'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_19">    ( ALBTBL  , NLUS )<a name='815'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_20">    ( Z0TBL   , NLUS )<a name='816'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_21">    ( SHDTBL  , NLUS )<a name='817'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_22">    ( NROTBL  , NLUS )<a name='818'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_23">    ( RSTBL   , NLUS )<a name='819'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_24">    ( RGLTBL  , NLUS )<a name='820'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_25">    ( HSTBL   , NLUS )<a name='821'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_26">    ( SNUPTBL , NLUS )<a name='822'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_27">    ( LAITBL  , NLUS )<a name='823'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_28">    ( MAXALB  , NLUS )<a name='824'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_29">    ( TOPT_DATA    , 1 )<a name='825'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_30">    ( CMCMAX_DATA  , 1 )<a name='826'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_31">    ( CFACTR_DATA  , 1 )<a name='827'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_32">    ( RSMAX_DATA  , 1 )<a name='828'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_6"> ( BARE    , 1 )<a name='829'>
<a name='830'>
<font color=#447700>!                                                                       <a name='831'></font>
<font color=#447700>!-----READ IN SOIL PROPERTIES FROM SOILPARM.TBL<a name='832'></font>
<font color=#447700>!                                                                       <a name='833'></font>
      IF ( wrf_dm_on_monitor() ) THEN<a name='834'>
        OPEN(19, FILE='SOILPARM.TBL',FORM='FORMATTED',STATUS='OLD',IOSTAT=ierr) <a name='835'>
        IF(ierr .NE. OPEN_OK ) THEN<a name='836'>
          WRITE(message,FMT='(A)') &amp;<a name='837'>
          'module_sf_noahlsm.F: soil_veg_gen_parm: failure opening SOILPARM.TBL'<a name='838'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_192"> ( message ) <a name='839'>
        END IF<a name='840'>
<a name='841'>
        MMINSL='STAS'                       <font color=#447700>!oct2<a name='842'></font>
        WRITE(mess,*) 'INPUT SOIL TEXTURE CLASSIFICAION = ',MMINSL<a name='843'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_61">( mess )<a name='844'>
<a name='845'>
        LUMATCH=0                                                       <a name='846'>
<a name='847'>
        READ (19,*)<a name='848'>
        READ (19,2000,END=2003)SLTYPE<a name='849'>
        READ (19,*)SLCATS,IINDEX                                        <a name='850'>
        IF(SLTYPE.EQ.MMINSL)THEN                                        <a name='851'>
            WRITE( mess , * ) 'SOIL TEXTURE CLASSIFICATION = ',SLTYPE,' FOUND', &amp;                 <a name='852'>
                  SLCATS,' CATEGORIES'<a name='853'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_62"> ( mess )<a name='854'>
          LUMATCH=1                                                     <a name='855'>
        ENDIF                                                           <a name='856'>
            IF(SLTYPE.EQ.MMINSL)THEN                                    <a name='857'>
          DO LC=1,SLCATS                                                <a name='858'>
              READ (19,*) IINDEX,BB(LC),DRYSMC(LC),F11(LC),MAXSMC(LC),&amp;<a name='859'>
                        REFSMC(LC),SATPSI(LC),SATDK(LC), SATDW(LC),   &amp;<a name='860'>
                        WLTSMC(LC), QTZ(LC)<a name='861'>
          ENDDO<a name='862'>
           ENDIF<a name='863'>
<a name='864'>
 2003   CONTINUE                                                        <a name='865'>
<a name='866'>
        CLOSE (19)                                                        <a name='867'>
      ENDIF<a name='868'>
<a name='869'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_7"> ( LUMATCH , 1 )<a name='870'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_STRING'>wrf_dm_bcast_string</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_STRING_8">  ( SLTYPE  , 4 )<a name='871'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_STRING'>wrf_dm_bcast_string</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_STRING_9">  ( MMINSL  , 4 )  <font color=#447700>! since this is reset above, see oct2 ^<a name='872'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_8"> ( SLCATS  , 1 )<a name='873'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_9"> ( IINDEX  , 1 )<a name='874'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_33">    ( BB      , NSLTYPE )<a name='875'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_34">    ( DRYSMC  , NSLTYPE )<a name='876'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_35">    ( F11     , NSLTYPE )<a name='877'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_36">    ( MAXSMC  , NSLTYPE )<a name='878'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_37">    ( REFSMC  , NSLTYPE )<a name='879'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_38">    ( SATPSI  , NSLTYPE )<a name='880'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_39">    ( SATDK   , NSLTYPE )<a name='881'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_40">    ( SATDW   , NSLTYPE )<a name='882'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_41">    ( WLTSMC  , NSLTYPE )<a name='883'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_42">    ( QTZ     , NSLTYPE )<a name='884'>
<a name='885'>
      IF(LUMATCH.EQ.0)THEN                                            <a name='886'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_63">( 'SOIl TEXTURE IN INPUT FILE DOES NOT ' )<a name='887'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_64">( 'MATCH SOILPARM TABLE'                 )<a name='888'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_193"> ( 'INCONSISTENT OR MISSING SOILPARM FILE' )<a name='889'>
      ENDIF                                                           <a name='890'>
<a name='891'>
<font color=#447700>!<a name='892'></font>
<font color=#447700>!-----READ IN GENERAL PARAMETERS FROM GENPARM.TBL <a name='893'></font>
<font color=#447700>!                                                                       <a name='894'></font>
      IF ( wrf_dm_on_monitor() ) THEN<a name='895'>
        OPEN(19, FILE='GENPARM.TBL',FORM='FORMATTED',STATUS='OLD',IOSTAT=ierr) <a name='896'>
        IF(ierr .NE. OPEN_OK ) THEN<a name='897'>
          WRITE(message,FMT='(A)') &amp;<a name='898'>
          'module_sf_noahlsm.F: soil_veg_gen_parm: failure opening GENPARM.TBL'<a name='899'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_194"> ( message ) <a name='900'>
        END IF<a name='901'>
<a name='902'>
        READ (19,*)<a name='903'>
        READ (19,*)<a name='904'>
        READ (19,*) NUM_SLOPE<a name='905'>
<a name='906'>
          SLPCATS=NUM_SLOPE<a name='907'>
<a name='908'>
          DO LC=1,SLPCATS                                                <a name='909'>
              READ (19,*)SLOPE_DATA(LC)<a name='910'>
          ENDDO<a name='911'>
<a name='912'>
          READ (19,*)<a name='913'>
          READ (19,*)SBETA_DATA<a name='914'>
          READ (19,*)<a name='915'>
          READ (19,*)FXEXP_DATA<a name='916'>
          READ (19,*)<a name='917'>
          READ (19,*)CSOIL_DATA<a name='918'>
          READ (19,*)<a name='919'>
          READ (19,*)SALP_DATA<a name='920'>
          READ (19,*)<a name='921'>
          READ (19,*)REFDK_DATA<a name='922'>
          READ (19,*)<a name='923'>
          READ (19,*)REFKDT_DATA<a name='924'>
          READ (19,*)<a name='925'>
          READ (19,*)FRZK_DATA<a name='926'>
          READ (19,*)<a name='927'>
          READ (19,*)ZBOT_DATA<a name='928'>
          READ (19,*)<a name='929'>
          READ (19,*)CZIL_DATA<a name='930'>
          READ (19,*)<a name='931'>
          READ (19,*)SMLOW_DATA<a name='932'>
          READ (19,*)<a name='933'>
          READ (19,*)SMHIGH_DATA<a name='934'>
        CLOSE (19)                                                        <a name='935'>
      ENDIF<a name='936'>
      <a name='937'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_10"> ( NUM_SLOPE    ,  1 )<a name='938'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_11"> ( SLPCATS      ,  1 )<a name='939'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_43">    ( SLOPE_DATA   ,  NSLOPE )<a name='940'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_44">    ( SBETA_DATA   ,  1 )<a name='941'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_45">    ( FXEXP_DATA   ,  1 )<a name='942'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_46">    ( CSOIL_DATA   ,  1 )<a name='943'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_47">    ( SALP_DATA    ,  1 )<a name='944'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_48">    ( REFDK_DATA   ,  1 )<a name='945'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_49">    ( REFKDT_DATA  ,  1 )<a name='946'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_50">    ( FRZK_DATA    ,  1 )<a name='947'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_51">    ( ZBOT_DATA    ,  1 )<a name='948'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_52">    ( CZIL_DATA    ,  1 )<a name='949'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_53">    ( SMLOW_DATA   ,  1 )<a name='950'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_54">    ( SMHIGH_DATA  ,  1 )<a name='951'>
<a name='952'>
<a name='953'>
<font color=#447700>!-----------------------------------------------------------------<a name='954'></font>
      END SUBROUTINE SOIL_VEG_GEN_PARM<a name='955'>
<font color=#447700>!-----------------------------------------------------------------<a name='956'></font>
<a name='957'>
<A NAME='SFLX'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='958'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFLX</font> (ICE,DT,ZLVL,NSOIL,SLDPTH,                        &amp;    <font color=#447700>!C   <A href='../../call_to/SFLX.html' TARGET='index'>2</A>,<A href='../../call_from/SFLX.html' TARGET='index'>26</A><a name='959'></font>
                       LOCAL,                                           &amp;    <font color=#447700>!L  <a name='960'></font>
                       LLANDUSE, LSOIL,                                 &amp;    <font color=#447700>!CL <a name='961'></font>
                       LWDN,SOLDN,SFCPRS,PRCP,SFCTMP,Q2,SFCSPD,         &amp;    <font color=#447700>!F  <a name='962'></font>
                       COSZ,PRCPRAIN, SOLARDIRECT,                      &amp;    <font color=#447700>!F  <a name='963'></font>
                       TH2,Q2SAT,DQSDT2,                                &amp;    <font color=#447700>!I  <a name='964'></font>
                       VEGTYP,SOILTYP,SLOPETYP,SHDFAC,SHDMIN,SHDMAX,    &amp;    <font color=#447700>!I  <a name='965'></font>
                       ALB, SNOALB,TBOT, Z0BRD, Z0, EMISSI,             &amp;    <font color=#447700>!S   <a name='966'></font>
                       CMC,T1,STC,SMC,SH2O,SNOWH,SNEQV,ALBEDO,CH,CM,    &amp;    <font color=#447700>!H  <a name='967'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='968'></font>
<font color=#447700>! OUTPUTS, DIAGNOSTICS, PARAMETERS BELOW GENERALLY NOT NECESSARY WHEN            <a name='969'></font>
<font color=#447700>! COUPLED WITH E.G. A NWP MODEL (SUCH AS THE NOAA/NWS/NCEP MESOSCALE ETA         <a name='970'></font>
<font color=#447700>! MODEL).  OTHER APPLICATIONS MAY REQUIRE DIFFERENT OUTPUT VARIABLES.            <a name='971'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='972'></font>
                       ETA,SHEAT, ETA_KINEMATIC,FDOWN,                  &amp;    <font color=#447700>!O  <a name='973'></font>
                       EC,EDIR,ET,ETT,ESNOW,DRIP,DEW,                   &amp;    <font color=#447700>!O  <a name='974'></font>
                       BETA,ETP,SSOIL,                                  &amp;    <font color=#447700>!O  <a name='975'></font>
                       FLX1,FLX2,FLX3,                                  &amp;    <font color=#447700>!O  <a name='976'></font>
                       SNOMLT,SNCOVR,                                   &amp;    <font color=#447700>!O  <a name='977'></font>
                       RUNOFF1,RUNOFF2,RUNOFF3,                         &amp;    <font color=#447700>!O  <a name='978'></font>
                       RC,PC,RSMIN,XLAI,RCS,RCT,RCQ,RCSOIL,             &amp;    <font color=#447700>!O  <a name='979'></font>
                       SOILW,SOILM,Q1,                                  &amp;    <font color=#447700>!D  <a name='980'></font>
                       SMCWLT,SMCDRY,SMCREF,SMCMAX,NROOT)                    <font color=#447700>!P  <a name='981'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='982'></font>
<font color=#447700>! SUBROUTINE SFLX - VERSION 3.X - October 2002                                   <a name='983'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='984'></font>
<font color=#447700>! SUB-DRIVER FOR "Noah LSM" FAMILY OF PHYSICS SUBROUTINES FOR A                  <a name='985'></font>
<font color=#447700>! SOIL/VEG/SNOWPACK LAND-SURFACE MODEL TO UPDATE SOIL MOISTURE, SOIL             <a name='986'></font>
<font color=#447700>! ICE, SOIL TEMPERATURE, SKIN TEMPERATURE, SNOWPACK WATER CONTENT,               <a name='987'></font>
<font color=#447700>! SNOWDEPTH, AND ALL TERMS OF THE SURFACE ENERGY BALANCE AND SURFACE             <a name='988'></font>
<font color=#447700>! WATER BALANCE (EXCLUDING INPUT ATMOSPHERIC FORCINGS OF DOWNWARD                <a name='989'></font>
<font color=#447700>! RADIATION AND PRECIP)                                                          <a name='990'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='991'></font>
<font color=#447700>! SFLX ARGUMENT LIST KEY:                                                        <a name='992'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='993'></font>
<font color=#447700>!  C  CONFIGURATION INFORMATION                                                  <a name='994'></font>
<font color=#447700>!  L  LOGICAL                                                                    <a name='995'></font>
<font color=#447700>! CL  4-string character bearing logical meaning                                 <a name='996'></font>
<font color=#447700>!  F  FORCING DATA                                                               <a name='997'></font>
<font color=#447700>!  I  OTHER (INPUT) FORCING DATA                                                 <a name='998'></font>
<font color=#447700>!  S  SURFACE CHARACTERISTICS                                                    <a name='999'></font>
<font color=#447700>!  H  HISTORY (STATE) VARIABLES                                                  <a name='1000'></font>
<font color=#447700>!  O  OUTPUT VARIABLES                                                           <a name='1001'></font>
<font color=#447700>!  D  DIAGNOSTIC OUTPUT                                                          <a name='1002'></font>
<font color=#447700>!  P  Parameters                                                                 <a name='1003'></font>
<font color=#447700>!  Msic Miscellaneous terms passed from gridded driver<a name='1004'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1005'></font>
<font color=#447700>! 1. CONFIGURATION INFORMATION (C):                                              <a name='1006'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1007'></font>
<font color=#447700>!   ICE        SEA-ICE FLAG  (=1: SEA-ICE, =0: LAND)                             <a name='1008'></font>
<font color=#447700>!   DT         TIMESTEP (SEC) (DT SHOULD NOT EXCEED 3600 SECS, RECOMMEND         <a name='1009'></font>
<font color=#447700>!                1800 SECS OR LESS)                                              <a name='1010'></font>
<font color=#447700>!   ZLVL       HEIGHT (M) ABOVE GROUND OF ATMOSPHERIC FORCING VARIABLES          <a name='1011'></font>
<font color=#447700>!   NSOIL      NUMBER OF SOIL LAYERS (AT LEAST 2, AND NOT GREATER THAN           <a name='1012'></font>
<font color=#447700>!                PARAMETER NSOLD SET BELOW)                                      <a name='1013'></font>
<font color=#447700>!   SLDPTH     THE THICKNESS OF EACH SOIL LAYER (M)                              <a name='1014'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1015'></font>
<font color=#447700>! 2. LOGICAL:                                                                    <a name='1016'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1017'></font>
<font color=#447700>!   LCH       Exchange coefficient (Ch) calculation flag (false: using           <a name='1018'></font>
<font color=#447700>!                ch-routine SFCDIF; true: Ch is brought in)                      <a name='1019'></font>
<font color=#447700>!   LOCAL      Flag for local-site simulation (where there is no<a name='1020'></font>
<font color=#447700>!              maps for albedo, veg fraction, and roughness <a name='1021'></font>
<font color=#447700>!             true:  all LSM parameters (inluding albedo, veg fraction and <a name='1022'></font>
<font color=#447700>!                    roughness length) will be defined by three tables          <a name='1023'></font>
<font color=#447700>!   LLANDUSE  (=USGS, using USGS landuse classification)                         <a name='1024'></font>
<font color=#447700>!   LSOIL     (=STAS, using FAO/STATSGO soil texture classification)             <a name='1025'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1026'></font>
<font color=#447700>! 3. FORCING DATA (F):                                                           <a name='1027'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1028'></font>
<font color=#447700>!   LWDN       LW DOWNWARD RADIATION (W M-2; POSITIVE, NOT NET LONGWAVE)         <a name='1029'></font>
<font color=#447700>!   SOLDN      SOLAR DOWNWARD RADIATION (W M-2; POSITIVE, NOT NET SOLAR)         <a name='1030'></font>
<font color=#447700>!   SFCPRS     PRESSURE AT HEIGHT ZLVL ABOVE GROUND (PASCALS)                    <a name='1031'></font>
<font color=#447700>!   PRCP       PRECIP RATE (KG M-2 S-1) (NOTE, THIS IS A RATE)                   <a name='1032'></font>
<font color=#447700>!   SFCTMP     AIR TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND                   <a name='1033'></font>
<font color=#447700>!   TH2        AIR POTENTIAL TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND         <a name='1034'></font>
<font color=#447700>!   Q2         MIXING RATIO AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)                <a name='1035'></font>
<font color=#447700>!   COSZ       Solar zenith angle (not used for now)                             <a name='1036'></font>
<font color=#447700>!   PRCPRAIN   Liquid-precipitation rate (KG M-2 S-1) (not used)                 <a name='1037'></font>
<font color=#447700>! SOLARDIRECT  Direct component of downward solar radiation (W M-2) (not used)   <a name='1038'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1039'></font>
<font color=#447700>! 4. OTHER FORCING (INPUT) DATA (I):                                             <a name='1040'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1041'></font>
<font color=#447700>!   SFCSPD     WIND SPEED (M S-1) AT HEIGHT ZLVL ABOVE GROUND                    <a name='1042'></font>
<font color=#447700>!   Q2SAT      SAT MIXING RATIO AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)            <a name='1043'></font>
<font color=#447700>!   DQSDT2     SLOPE OF SAT SPECIFIC HUMIDITY CURVE AT T=SFCTMP                  <a name='1044'></font>
<font color=#447700>!                (KG KG-1 K-1)                                                   <a name='1045'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1046'></font>
<font color=#447700>! 5. CANOPY/SOIL CHARACTERISTICS (S):                                            <a name='1047'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1048'></font>
<font color=#447700>!   VEGTYP     VEGETATION TYPE (INTEGER INDEX)                                   <a name='1049'></font>
<font color=#447700>!   SOILTYP    SOIL TYPE (INTEGER INDEX)                                         <a name='1050'></font>
<font color=#447700>!   SLOPETYP   CLASS OF SFC SLOPE (INTEGER INDEX)                                <a name='1051'></font>
<font color=#447700>!   SHDFAC     AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION                     <a name='1052'></font>
<font color=#447700>!                (FRACTION= 0.0-1.0)                                             <a name='1053'></font>
<font color=#447700>!   SHDMIN     MINIMUM AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION             <a name='1054'></font>
<font color=#447700>!                (FRACTION= 0.0-1.0) &lt;= SHDFAC                                   <a name='1055'></font>
<font color=#447700>!   PTU        PHOTO THERMAL UNIT (PLANT PHENOLOGY FOR ANNUALS/CROPS)            <a name='1056'></font>
<font color=#447700>!                (NOT YET USED, BUT PASSED TO REDPRM FOR FUTURE USE IN           <a name='1057'></font>
<font color=#447700>!                VEG PARMS)                                                      <a name='1058'></font>
<font color=#447700>!   ALB        BACKROUND SNOW-FREE SURFACE ALBEDO (FRACTION), FOR JULIAN         <a name='1059'></font>
<font color=#447700>!                DAY OF YEAR (USUALLY FROM TEMPORAL INTERPOLATION OF             <a name='1060'></font>
<font color=#447700>!                MONTHLY MEAN VALUES' CALLING PROG MAY OR MAY NOT                <a name='1061'></font>
<font color=#447700>!                INCLUDE DIURNAL SUN ANGLE EFFECT)                               <a name='1062'></font>
<font color=#447700>!   SNOALB     UPPER BOUND ON MAXIMUM ALBEDO OVER DEEP SNOW (E.G. FROM           <a name='1063'></font>
<font color=#447700>!                ROBINSON AND KUKLA, 1985, J. CLIM. &amp; APPL. METEOR.)             <a name='1064'></font>
<font color=#447700>!   TBOT       BOTTOM SOIL TEMPERATURE (LOCAL YEARLY-MEAN SFC AIR                <a name='1065'></font>
<font color=#447700>!                TEMPERATURE)                                                    <a name='1066'></font>
<font color=#447700>!   Z0BRD      Background fixed roughness length (M)                             <a name='1067'></font>
<font color=#447700>!   Z0         Time varying roughness length (M) as function of snow depth       <a name='1068'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1069'></font>
<font color=#447700>! 6. HISTORY (STATE) VARIABLES (H):                                              <a name='1070'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1071'></font>
<font color=#447700>!  CMC         CANOPY MOISTURE CONTENT (M)                                       <a name='1072'></font>
<font color=#447700>!  T1          GROUND/CANOPY/SNOWPACK) EFFECTIVE SKIN TEMPERATURE (K)            <a name='1073'></font>
<font color=#447700>!  STC(NSOIL)  SOIL TEMP (K)                                                     <a name='1074'></font>
<font color=#447700>!  SMC(NSOIL)  TOTAL SOIL MOISTURE CONTENT (VOLUMETRIC FRACTION)                 <a name='1075'></font>
<font color=#447700>!  SH2O(NSOIL) UNFROZEN SOIL MOISTURE CONTENT (VOLUMETRIC FRACTION)              <a name='1076'></font>
<font color=#447700>!                NOTE: FROZEN SOIL MOISTURE = SMC - SH2O                         <a name='1077'></font>
<font color=#447700>!  SNOWH       ACTUAL SNOW DEPTH (M)                                             <a name='1078'></font>
<font color=#447700>!  SNEQV       LIQUID WATER-EQUIVALENT SNOW DEPTH (M)                            <a name='1079'></font>
<font color=#447700>!                NOTE: SNOW DENSITY = SNEQV/SNOWH                                <a name='1080'></font>
<font color=#447700>!  ALBEDO      SURFACE ALBEDO INCLUDING SNOW EFFECT (UNITLESS FRACTION)          <a name='1081'></font>
<font color=#447700>!                =SNOW-FREE ALBEDO (ALB) WHEN SNEQV=0, OR                        <a name='1082'></font>
<font color=#447700>!                =FCT(MSNOALB,ALB,VEGTYP,SHDFAC,SHDMIN) WHEN SNEQV&gt;0             <a name='1083'></font>
<font color=#447700>!  CH          SURFACE EXCHANGE COEFFICIENT FOR HEAT AND MOISTURE                <a name='1084'></font>
<font color=#447700>!                (M S-1); NOTE: CH IS TECHNICALLY A CONDUCTANCE SINCE            <a name='1085'></font>
<font color=#447700>!                IT HAS BEEN MULTIPLIED BY WIND SPEED.                           <a name='1086'></font>
<font color=#447700>!  CM          SURFACE EXCHANGE COEFFICIENT FOR MOMENTUM (M S-1); NOTE:          <a name='1087'></font>
<font color=#447700>!                CM IS TECHNICALLY A CONDUCTANCE SINCE IT HAS BEEN               <a name='1088'></font>
<font color=#447700>!                MULTIPLIED BY WIND SPEED.                                       <a name='1089'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1090'></font>
<font color=#447700>! 7. OUTPUT (O):                                                                 <a name='1091'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1092'></font>
<font color=#447700>! OUTPUT VARIABLES NECESSARY FOR A COUPLED NUMERICAL WEATHER PREDICTION          <a name='1093'></font>
<font color=#447700>! MODEL, E.G. NOAA/NWS/NCEP MESOSCALE ETA MODEL.  FOR THIS APPLICATION,          <a name='1094'></font>
<font color=#447700>! THE REMAINING OUTPUT/DIAGNOSTIC/PARAMETER BLOCKS BELOW ARE NOT                 <a name='1095'></font>
<font color=#447700>! NECESSARY.  OTHER APPLICATIONS MAY REQUIRE DIFFERENT OUTPUT VARIABLES.         <a name='1096'></font>
<font color=#447700>!   ETA        ACTUAL LATENT HEAT FLUX (W m-2: NEGATIVE, IF UP FROM              <a name='1097'></font>
<font color=#447700>!              SURFACE)                                                          <a name='1098'></font>
<font color=#447700>!  ETA_KINEMATIC atctual latent heat flux in Kg m s-1                            <a name='1099'></font>
<font color=#447700>!   SHEAT      SENSIBLE HEAT FLUX (W M-2: NEGATIVE, IF UPWARD FROM               <a name='1100'></font>
<font color=#447700>!              SURFACE)                                                          <a name='1101'></font>
<font color=#447700>!   FDOWN      Radiation forcing at the surface (W m-2) = SOLDN*(1-alb)+LWDN     <a name='1102'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1103'></font>
<font color=#447700>!   EC         CANOPY WATER EVAPORATION (W m-2)                                  <a name='1104'></font>
<font color=#447700>!   EDIR       DIRECT SOIL EVAPORATION (W m-2)                                   <a name='1105'></font>
<font color=#447700>!   ET(NSOIL)  PLANT TRANSPIRATION FROM A PARTICULAR ROOT (SOIL) LAYER           <a name='1106'></font>
<font color=#447700>!                 (W m-2)                                                        <a name='1107'></font>
<font color=#447700>!   ETT        TOTAL PLANT TRANSPIRATION (W m-2)                                 <a name='1108'></font>
<font color=#447700>!   ESNOW      SUBLIMATION FROM (OR DEPOSITION TO IF &lt;0) SNOWPACK                <a name='1109'></font>
<font color=#447700>!                (W m-2)                                                         <a name='1110'></font>
<font color=#447700>!   DRIP       THROUGH-FALL OF PRECIP AND/OR DEW IN EXCESS OF CANOPY             <a name='1111'></font>
<font color=#447700>!                WATER-HOLDING CAPACITY (M)                                      <a name='1112'></font>
<font color=#447700>!   DEW        DEWFALL (OR FROSTFALL FOR T&lt;273.15) (M)                           <a name='1113'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1114'></font>
<font color=#447700>!   BETA       RATIO OF ACTUAL/POTENTIAL EVAP (DIMENSIONLESS)                    <a name='1115'></font>
<font color=#447700>!   ETP        POTENTIAL EVAPORATION (W m-2)<a name='1116'></font>
<font color=#447700>!   SSOIL      SOIL HEAT FLUX (W M-2: NEGATIVE IF DOWNWARD FROM SURFACE)         <a name='1117'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1118'></font>
<font color=#447700>!   FLX1       PRECIP-SNOW SFC (W M-2)                                           <a name='1119'></font>
<font color=#447700>!   FLX2       FREEZING RAIN LATENT HEAT FLUX (W M-2)                            <a name='1120'></font>
<font color=#447700>!   FLX3       PHASE-CHANGE HEAT FLUX FROM SNOWMELT (W M-2)                      <a name='1121'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1122'></font>
<font color=#447700>!   SNOMLT     SNOW MELT (M) (WATER EQUIVALENT)                                  <a name='1123'></font>
<font color=#447700>!   SNCOVR     FRACTIONAL SNOW COVER (UNITLESS FRACTION, 0-1)                    <a name='1124'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1125'></font>
<font color=#447700>!   RUNOFF1    SURFACE RUNOFF (M S-1), NOT INFILTRATING THE SURFACE              <a name='1126'></font>
<font color=#447700>!   RUNOFF2    SUBSURFACE RUNOFF (M S-1), DRAINAGE OUT BOTTOM OF LAST            <a name='1127'></font>
<font color=#447700>!                SOIL LAYER (BASEFLOW)                                           <a name='1128'></font>
<font color=#447700>!   RUNOFF3    NUMERICAL TRUNCTATION IN EXCESS OF POROSITY (SMCMAX)              <a name='1129'></font>
<font color=#447700>!                FOR A GIVEN SOIL LAYER AT THE END OF A TIME STEP (M S-1).       <a name='1130'></font>
<font color=#447700>! Note: the above RUNOFF2 is actually the sum of RUNOFF2 and RUNOFF3             <a name='1131'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1132'></font>
<font color=#447700>!   RC         CANOPY RESISTANCE (S M-1)                                         <a name='1133'></font>
<font color=#447700>!   PC         PLANT COEFFICIENT (UNITLESS FRACTION, 0-1) WHERE PC*ETP           <a name='1134'></font>
<font color=#447700>!                = ACTUAL TRANSP                                                 <a name='1135'></font>
<font color=#447700>!   XLAI       LEAF AREA INDEX (DIMENSIONLESS)                                   <a name='1136'></font>
<font color=#447700>!   RSMIN      MINIMUM CANOPY RESISTANCE (S M-1)                                 <a name='1137'></font>
<font color=#447700>!   RCS        INCOMING SOLAR RC FACTOR (DIMENSIONLESS)                          <a name='1138'></font>
<font color=#447700>!   RCT        AIR TEMPERATURE RC FACTOR (DIMENSIONLESS)                         <a name='1139'></font>
<font color=#447700>!   RCQ        ATMOS VAPOR PRESSURE DEFICIT RC FACTOR (DIMENSIONLESS)            <a name='1140'></font>
<font color=#447700>!   RCSOIL     SOIL MOISTURE RC FACTOR (DIMENSIONLESS)                           <a name='1141'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1142'></font>
<font color=#447700>! 8. DIAGNOSTIC OUTPUT (D):                                                      <a name='1143'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1144'></font>
<font color=#447700>!   SOILW      AVAILABLE SOIL MOISTURE IN ROOT ZONE (UNITLESS FRACTION           <a name='1145'></font>
<font color=#447700>!              BETWEEN SMCWLT AND SMCMAX)                                        <a name='1146'></font>
<font color=#447700>!   SOILM      TOTAL SOIL COLUMN MOISTURE CONTENT (FROZEN+UNFROZEN) (M)          <a name='1147'></font>
<font color=#447700>!   Q1         Effective mixing ratio at surface (kg kg-1), used for             <a name='1148'></font>
<font color=#447700>!              diagnosing the mixing ratio at 2 meter for coupled model          <a name='1149'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1150'></font>
<font color=#447700>! 9. PARAMETERS (P):                                                             <a name='1151'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1152'></font>
<font color=#447700>!   SMCWLT     WILTING POINT (VOLUMETRIC)                                        <a name='1153'></font>
<font color=#447700>!   SMCDRY     DRY SOIL MOISTURE THRESHOLD WHERE DIRECT EVAP FRM TOP             <a name='1154'></font>
<font color=#447700>!                LAYER ENDS (VOLUMETRIC)                                         <a name='1155'></font>
<font color=#447700>!   SMCREF     SOIL MOISTURE THRESHOLD WHERE TRANSPIRATION BEGINS TO             <a name='1156'></font>
<font color=#447700>!                STRESS (VOLUMETRIC)                                             <a name='1157'></font>
<font color=#447700>!   SMCMAX     POROSITY, I.E. SATURATED VALUE OF SOIL MOISTURE                   <a name='1158'></font>
<font color=#447700>!                (VOLUMETRIC)                                                    <a name='1159'></font>
<font color=#447700>!   NROOT      NUMBER OF ROOT LAYERS, A FUNCTION OF VEG TYPE, DETERMINED         <a name='1160'></font>
<font color=#447700>!              IN SUBROUTINE REDPRM. <a name='1161'></font>
<font color=#447700>! ----------------------------------------------------------------------           <a name='1162'></font>
<a name='1163'>
<a name='1164'>
      IMPLICIT NONE                                                              <a name='1165'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1166'></font>
<a name='1167'>
<font color=#447700>! DECLARATIONS - LOGICAL AND CHARACTERS                                                        <a name='1168'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1169'></font>
      LOGICAL, INTENT(IN)::  LOCAL                                              <a name='1170'>
      LOGICAL            ::  FRZGRA, SNOWNG                                                    <a name='1171'>
      CHARACTER (LEN=4), INTENT(IN)::  LLANDUSE, LSOIL<a name='1172'>
                                                                                 <a name='1173'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1174'></font>
<font color=#447700>! DECLARATIONS - INTEGER                                                         <a name='1175'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1176'></font>
      INTEGER,INTENT(IN) ::  ICE,NSOIL,SLOPETYP,SOILTYP,VEGTYP                                 <a name='1177'>
      INTEGER,INTENT(OUT)::  NROOT                                                             <a name='1178'>
      INTEGER  KZ, K, iout                                                             <a name='1179'>
                                                                                 <a name='1180'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1181'></font>
<font color=#447700>! DECLARATIONS - REAL                                                            <a name='1182'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1183'></font>
      REAL, INTENT(IN)   :: SHDMIN,SHDMAX,DT,DQSDT2,LWDN,PRCP,PRCPRAIN,     &amp; <a name='1184'>
                            Q2,Q2SAT,SFCPRS,SFCSPD,SFCTMP, SNOALB,          &amp; <a name='1185'>
                            SOLDN,TBOT,TH2,ZLVL,                            &amp;<a name='1186'>
                            EMISSI                                         <a name='1187'>
      REAL, INTENT(INOUT):: COSZ, SOLARDIRECT,ALBEDO,CH,CM,                 &amp;  <a name='1188'>
                            CMC,SNEQV,SNCOVR,SNOWH,T1,XLAI,SHDFAC,Z0BRD,ALB<a name='1189'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN) :: SLDPTH      <a name='1190'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT):: ET          <a name='1191'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) ::  SH2O, SMC, STC<a name='1192'>
      REAL,DIMENSION(1:NSOLD)::   RTDIS, ZSOIL                                     <a name='1193'>
<a name='1194'>
      REAL,INTENT(OUT)   :: ETA_KINEMATIC,BETA,DEW,DRIP,EC,EDIR,ESNOW,ETA,  &amp; <a name='1195'>
                            ETP,FLX1,FLX2,FLX3,SHEAT,PC,RUNOFF1,RUNOFF2,    &amp; <a name='1196'>
                            RUNOFF3,RC,RSMIN,RCQ,RCS,RCSOIL,RCT,SSOIL,      &amp; <a name='1197'>
                            SMCDRY,SMCMAX,SMCREF,SMCWLT,SNOMLT, SOILM,      &amp; <a name='1198'>
                            SOILW,FDOWN,Q1                                       <a name='1199'>
      REAL :: BEXP,CFACTR,CMCMAX,CSOIL,CZIL,DF1,DF1H,DF1A,DKSAT,DWSAT,      &amp; <a name='1200'>
              DSOIL,DTOT,ETT,FRCSNO,FRCSOI,EPSCA,F1,FXEXP,FRZX,HS,          &amp; <a name='1201'>
              KDT,LVH2O,PRCP1,PSISAT,QUARTZ,R,RCH,REFKDT,RR,RGL,            &amp; <a name='1202'>
              RSMAX,                                                        &amp; <a name='1203'>
              RSNOW,SNDENS,SNCOND,SBETA,SN_NEW,SLOPE,SNUP,SALP,SOILWM,      &amp; <a name='1204'>
              SOILWW,T1V,T24,T2V,TH2V,TOPT,TFREEZ,TSNOW,ZBOT,Z0,PRCPF,      &amp; <a name='1205'>
              ETNS,PTU,LSUBS               <a name='1206'>
<a name='1207'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1208'></font>
<font color=#447700>! DECLARATIONS - PARAMETERS                                                      <a name='1209'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1210'></font>
      PARAMETER (TFREEZ = 273.15)                                                <a name='1211'>
      PARAMETER (LVH2O = 2.501E+6)                                               <a name='1212'>
      PARAMETER (LSUBS = 2.83E+6)                                                <a name='1213'>
      PARAMETER (R = 287.04)                                                     <a name='1214'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1215'></font>
<font color=#447700>!   INITIALIZATION                                                               <a name='1216'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1217'></font>
         RUNOFF1 = 0.0                                                           <a name='1218'>
         RUNOFF2 = 0.0                                                           <a name='1219'>
         RUNOFF3 = 0.0                                                           <a name='1220'>
         SNOMLT = 0.0                                                            <a name='1221'>
                                                                                 <a name='1222'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1223'></font>
<font color=#447700>!  THE VARIABLE "ICE" IS A FLAG DENOTING SEA-ICE CASE                            <a name='1224'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1225'></font>
<font color=#447700>! SEA-ICE LAYERS ARE EQUAL THICKNESS AND SUM TO 3 METERS                         <a name='1226'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1227'></font>
         IF (ICE == 1) THEN                                                    <a name='1228'>
            DO KZ = 1,NSOIL                                                      <a name='1229'>
               ZSOIL (KZ) = -3.* FLOAT (KZ)/ FLOAT (NSOIL)                       <a name='1230'>
            END DO                                                               <a name='1231'>
                                                                                 <a name='1232'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1233'></font>
<font color=#447700>! CALCULATE DEPTH (NEGATIVE) BELOW GROUND FROM TOP SKIN SFC TO BOTTOM OF         <a name='1234'></font>
<font color=#447700>!   EACH SOIL LAYER.  NOTE:  SIGN OF ZSOIL IS NEGATIVE (DENOTING BELOW           <a name='1235'></font>
<font color=#447700>!   GROUND)                                                                      <a name='1236'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1237'></font>
         ELSE                                                                    <a name='1238'>
            ZSOIL (1) = - SLDPTH (1)                                             <a name='1239'>
            DO KZ = 2,NSOIL                                                      <a name='1240'>
               ZSOIL (KZ) = - SLDPTH (KZ) + ZSOIL (KZ -1)                        <a name='1241'>
            END DO                                                               <a name='1242'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1243'></font>
<font color=#447700>! NEXT IS CRUCIAL CALL TO SET THE LAND-SURFACE PARAMETERS, INCLUDING             <a name='1244'></font>
<font color=#447700>! SOIL-TYPE AND VEG-TYPE DEPENDENT PARAMETERS.                                   <a name='1245'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1246'></font>
          CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM'>REDPRM</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REDPRM_2"> (VEGTYP,SOILTYP,SLOPETYP,CFACTR,CMCMAX,RSMAX,TOPT,   &amp;     <a name='1247'>
                       REFKDT,KDT,SBETA, SHDFAC,RSMIN,RGL,HS,ZBOT,FRZX,    &amp;     <a name='1248'>
                         PSISAT,SLOPE,SNUP,SALP,BEXP,DKSAT,DWSAT,          &amp;     <a name='1249'>
                         SMCMAX,SMCWLT,SMCREF,SMCDRY,F1,QUARTZ,FXEXP,      &amp;     <a name='1250'>
                         RTDIS,SLDPTH,ZSOIL,NROOT,NSOIL,Z0BRD,CZIL,XLAI,   &amp;     <a name='1251'>
                         CSOIL,ALB,PTU,LLANDUSE,LSOIL,LOCAL)                   <a name='1252'>
         END IF                                                                  <a name='1253'>
<a name='1254'>
<font color=#447700>!urban change<a name='1255'></font>
         IF(VEGTYP==1)THEN<a name='1256'>
              SHDFAC=0.05<a name='1257'>
              RSMIN=400.0<a name='1258'>
              SMCMAX = 0.45<a name='1259'>
              SMCREF = 0.42<a name='1260'>
              SMCWLT = 0.40<a name='1261'>
         ENDIF<a name='1262'>
                                                                                 <a name='1263'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1264'></font>
<font color=#447700>!  INITIALIZE PRECIPITATION LOGICALS.                                            <a name='1265'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1266'></font>
         SNOWNG = .FALSE.                                                        <a name='1267'>
         FRZGRA = .FALSE.                                                        <a name='1268'>
                                                                                 <a name='1269'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1270'></font>
<font color=#447700>! IF SEA-ICE CASE, ASSIGN DEFAULT WATER-EQUIV SNOW ON TOP                        <a name='1271'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1272'></font>
         IF (ICE == 1) THEN                                                    <a name='1273'>
            SNEQV = 0.01                                                         <a name='1274'>
            SNOWH = 0.05                                                         <a name='1275'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1276'></font>
<font color=#447700>! IF INPUT SNOWPACK IS NONZERO, THEN COMPUTE SNOW DENSITY "SNDENS" AND           <a name='1277'></font>
<font color=#447700>!   SNOW THERMAL CONDUCTIVITY "SNCOND" (NOTE THAT CSNOW IS A FUNCTION            <a name='1278'></font>
<font color=#447700>!   SUBROUTINE)                                                                  <a name='1279'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1280'></font>
         END IF                                                                  <a name='1281'>
         IF (SNEQV == 0.0) THEN                                                <a name='1282'>
            SNDENS = 0.0                                                         <a name='1283'>
            SNOWH = 0.0                                                          <a name='1284'>
            SNCOND = 1.0                                                         <a name='1285'>
         ELSE                                                                    <a name='1286'>
            SNDENS = SNEQV / SNOWH                                               <a name='1287'>
            IF(SNDENS &gt; 1.0) THEN                                               <a name='1288'>
             write(*,*)'Physical snow depth is less than snow water equiv.'           <a name='1289'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_195"> ( 'Physical snow depth is less than snow water equiv.' )<a name='1290'>
            ENDIF                                                                <a name='1291'>
            CALL <A href='../../html_code/phys/module_sf_lsm_nmm.F.html#CSNOW'>CSNOW</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CSNOW_1"> (SNCOND,SNDENS)                                           <a name='1292'>
         END IF                                                                  <a name='1293'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1294'></font>
<font color=#447700>! DETERMINE IF IT'S PRECIPITATING AND WHAT KIND OF PRECIP IT IS.                 <a name='1295'></font>
<font color=#447700>! IF IT'S PRCPING AND THE AIR TEMP IS COLDER THAN 0 C, IT'S SNOWING!             <a name='1296'></font>
<font color=#447700>! IF IT'S PRCPING AND THE AIR TEMP IS WARMER THAN 0 C, BUT THE GRND              <a name='1297'></font>
<font color=#447700>! TEMP IS COLDER THAN 0 C, FREEZING RAIN IS PRESUMED TO BE FALLING.              <a name='1298'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1299'></font>
         IF (PRCP &gt; 0.0) THEN                                                 <a name='1300'>
            IF (SFCTMP &lt;=  TFREEZ) THEN                                         <a name='1301'>
               SNOWNG = .TRUE.                                                   <a name='1302'>
            ELSE                                                                 <a name='1303'>
               IF (T1 &lt;= TFREEZ) FRZGRA = .TRUE.                               <a name='1304'>
            END IF                                                               <a name='1305'>
         END IF                                                                  <a name='1306'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1307'></font>
<font color=#447700>! IF EITHER PRCP FLAG IS SET, DETERMINE NEW SNOWFALL (CONVERTING PRCP            <a name='1308'></font>
<font color=#447700>! RATE FROM KG M-2 S-1 TO A LIQUID EQUIV SNOW DEPTH IN METERS) AND ADD           <a name='1309'></font>
<font color=#447700>! IT TO THE EXISTING SNOWPACK.                                                   <a name='1310'></font>
<font color=#447700>! NOTE THAT SINCE ALL PRECIP IS ADDED TO SNOWPACK, NO PRECIP INFILTRATES         <a name='1311'></font>
<font color=#447700>! INTO THE SOIL SO THAT PRCP1 IS SET TO ZERO.                                    <a name='1312'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1313'></font>
         IF ( (SNOWNG) .OR. (FRZGRA) ) THEN                                      <a name='1314'>
            SN_NEW = PRCP * DT * 0.001                                           <a name='1315'>
<font color=#447700>!        PRCP1 = 0.0                                                             <a name='1316'></font>
<font color=#447700>! change name of PRCP1 to PRCPF                                                  <a name='1317'></font>
            SNEQV = SNEQV + SN_NEW                                               <a name='1318'>
            PRCPF = 0.0                                                          <a name='1319'>
                                                                                 <a name='1320'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1321'></font>
<font color=#447700>! UPDATE SNOW DENSITY BASED ON NEW SNOWFALL, USING OLD AND NEW SNOW.             <a name='1322'></font>
<font color=#447700>! UPDATE SNOW THERMAL CONDUCTIVITY                                               <a name='1323'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1324'></font>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOW_NEW'>SNOW_NEW</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOW_NEW_2"> (SFCTMP,SN_NEW,SNOWH,SNDENS)                           <a name='1325'>
            CALL <A href='../../html_code/phys/module_sf_lsm_nmm.F.html#CSNOW'>CSNOW</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CSNOW_2"> (SNCOND,SNDENS)                                           <a name='1326'>
                                                                                 <a name='1327'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1328'></font>
<font color=#447700>! PRECIP IS LIQUID (RAIN), HENCE SAVE IN THE PRECIP VARIABLE THAT                <a name='1329'></font>
<font color=#447700>! LATER CAN WHOLELY OR PARTIALLY INFILTRATE THE SOIL (ALONG WITH                 <a name='1330'></font>
<font color=#447700>! ANY CANOPY "DRIP" ADDED TO THIS LATER)                                         <a name='1331'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1332'></font>
<font color=#447700>!        PRCP1 = PRCP                                                            <a name='1333'></font>
         ELSE                                                                    <a name='1334'>
<font color=#447700>! change name of PRCP1 to PRCPF                                                  <a name='1335'></font>
                                                                                 <a name='1336'>
            PRCPF = PRCP                                                         <a name='1337'>
         END IF                                                                  <a name='1338'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1339'></font>
<font color=#447700>! DETERMINE SNOWCOVER AND ALBEDO OVER LAND.                                      <a name='1340'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1341'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1342'></font>
<font color=#447700>! IF SNOW DEPTH=0, SET SNOW FRACTION=0, ALBEDO=SNOW FREE ALBEDO.                 <a name='1343'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1344'></font>
         IF (ICE == 0) THEN                                                    <a name='1345'>
            IF (SNEQV  == 0.0) THEN                                             <a name='1346'>
               SNCOVR = 0.0                                                      <a name='1347'>
               ALBEDO = ALB                                                      <a name='1348'>
            ELSE                                                                 <a name='1349'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1350'></font>
<font color=#447700>! DETERMINE SNOW FRACTIONAL COVERAGE.                                            <a name='1351'></font>
<font color=#447700>! DETERMINE SURFACE ALBEDO MODIFICATION DUE TO SNOWDEPTH STATE.                  <a name='1352'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1353'></font>
              CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNFRAC'>SNFRAC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNFRAC_1"> (SNEQV,SNUP,SALP,SNOWH,SNCOVR)                         <a name='1354'>
              CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#ALCALC'>ALCALC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALCALC_1"> (ALB,SNOALB,SHDFAC,SHDMIN,SNCOVR,TSNOW,ALBEDO)         <a name='1355'>
            END IF                                                               <a name='1356'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1357'></font>
<font color=#447700>! SNOW COVER, ALBEDO OVER SEA-ICE                                                <a name='1358'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1359'></font>
         ELSE                                                                    <a name='1360'>
            SNCOVR = 1.0                                                         <a name='1361'>
            ALBEDO = 0.60                                                        <a name='1362'>
         END IF                                                                  <a name='1363'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1364'></font>
<font color=#447700>! THERMAL CONDUCTIVITY FOR SEA-ICE CASE                                          <a name='1365'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1366'></font>
         IF (ICE == 1) THEN                                                    <a name='1367'>
            DF1 = 2.2                                                            <a name='1368'>
         ELSE                                                                    <a name='1369'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1370'></font>
<font color=#447700>! NEXT CALCULATE THE SUBSURFACE HEAT FLUX, WHICH FIRST REQUIRES                  <a name='1371'></font>
<font color=#447700>! CALCULATION OF THE THERMAL DIFFUSIVITY.  TREATMENT OF THE                      <a name='1372'></font>
<font color=#447700>! LATTER FOLLOWS THAT ON PAGES 148-149 FROM "HEAT TRANSFER IN                    <a name='1373'></font>
<font color=#447700>! COLD CLIMATES", BY V. J. LUNARDINI (PUBLISHED IN 1981                          <a name='1374'></font>
<font color=#447700>! BY VAN NOSTRAND REINHOLD CO.) I.E. TREATMENT OF TWO CONTIGUOUS                 <a name='1375'></font>
<font color=#447700>! "PLANE PARALLEL" MEDIUMS (NAMELY HERE THE FIRST SOIL LAYER                     <a name='1376'></font>
<font color=#447700>! AND THE SNOWPACK LAYER, IF ANY). THIS DIFFUSIVITY TREATMENT                    <a name='1377'></font>
<font color=#447700>! BEHAVES WELL FOR BOTH ZERO AND NONZERO SNOWPACK, INCLUDING THE                 <a name='1378'></font>
<font color=#447700>! LIMIT OF VERY THIN SNOWPACK.  THIS TREATMENT ALSO ELIMINATES                   <a name='1379'></font>
<font color=#447700>! THE NEED TO IMPOSE AN ARBITRARY UPPER BOUND ON SUBSURFACE                      <a name='1380'></font>
<font color=#447700>! HEAT FLUX WHEN THE SNOWPACK BECOMES EXTREMELY THIN.                            <a name='1381'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1382'></font>
<font color=#447700>! FIRST CALCULATE THERMAL DIFFUSIVITY OF TOP SOIL LAYER, USING                   <a name='1383'></font>
<font color=#447700>! BOTH THE FROZEN AND LIQUID SOIL MOISTURE, FOLLOWING THE                        <a name='1384'></font>
<font color=#447700>! SOIL THERMAL DIFFUSIVITY FUNCTION OF PETERS-LIDARD ET AL.                      <a name='1385'></font>
<font color=#447700>! (1998,JAS, VOL 55, 1209-1224), WHICH REQUIRES THE SPECIFYING                   <a name='1386'></font>
<font color=#447700>! THE QUARTZ CONTENT OF THE GIVEN SOIL CLASS (SEE ROUTINE REDPRM)                <a name='1387'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1388'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1389'></font>
<font color=#447700>! NEXT ADD SUBSURFACE HEAT FLUX REDUCTION EFFECT FROM THE                        <a name='1390'></font>
<font color=#447700>! OVERLYING GREEN CANOPY, ADAPTED FROM SECTION 2.1.2 OF                          <a name='1391'></font>
<font color=#447700>! PETERS-LIDARD ET AL. (1997, JGR, VOL 102(D4))                                  <a name='1392'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1393'></font>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_5"> (DF1,SMC (1),QUARTZ,SMCMAX,SH2O (1))                     <a name='1394'>
<a name='1395'>
<font color=#447700>!urban change<a name='1396'></font>
            IF (VEGTYP==1) DF1=3.24<a name='1397'>
<a name='1398'>
            DF1 = DF1 * EXP (SBETA * SHDFAC)                                     <a name='1399'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1400'></font>
<font color=#447700>! FINALLY "PLANE PARALLEL" SNOWPACK EFFECT FOLLOWING                             <a name='1401'></font>
<font color=#447700>! V.J. LINARDINI REFERENCE CITED ABOVE. NOTE THAT DTOT IS                        <a name='1402'></font>
<font color=#447700>! COMBINED DEPTH OF SNOWDEPTH AND THICKNESS OF FIRST SOIL LAYER                  <a name='1403'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1404'></font>
         END IF                                                                  <a name='1405'>
                                                                                 <a name='1406'>
         DSOIL = - (0.5 * ZSOIL (1))                                             <a name='1407'>
         IF (SNEQV == 0.) THEN                                                 <a name='1408'>
            SSOIL = DF1 * (T1- STC (1) ) / DSOIL                                 <a name='1409'>
         ELSE                                                                    <a name='1410'>
            DTOT = SNOWH + DSOIL                                                 <a name='1411'>
            FRCSNO = SNOWH / DTOT                                                <a name='1412'>
                                                                                 <a name='1413'>
<font color=#447700>! 1. HARMONIC MEAN (SERIES FLOW)                                                 <a name='1414'></font>
<font color=#447700>!        DF1 = (SNCOND*DF1)/(FRCSOI*SNCOND+FRCSNO*DF1)                           <a name='1415'></font>
            FRCSOI = DSOIL / DTOT                                                <a name='1416'>
<font color=#447700>! 2. ARITHMETIC MEAN (PARALLEL FLOW)                                             <a name='1417'></font>
<font color=#447700>!        DF1 = FRCSNO*SNCOND + FRCSOI*DF1                                        <a name='1418'></font>
            DF1H = (SNCOND * DF1)/ (FRCSOI * SNCOND+ FRCSNO * DF1)               <a name='1419'>
                                                                                 <a name='1420'>
<font color=#447700>! 3. GEOMETRIC MEAN (INTERMEDIATE BETWEEN HARMONIC AND ARITHMETIC MEAN)          <a name='1421'></font>
<font color=#447700>!        DF1 = (SNCOND**FRCSNO)*(DF1**FRCSOI)                                    <a name='1422'></font>
<font color=#447700>! TEST - MBEK, 10 Jan 2002                                                       <a name='1423'></font>
<font color=#447700>! weigh DF by snow fraction                                                      <a name='1424'></font>
<font color=#447700>!        DF1 = DF1H*SNCOVR + DF1A*(1.0-SNCOVR)                                   <a name='1425'></font>
<font color=#447700>!        DF1 = DF1H*SNCOVR + DF1*(1.0-SNCOVR)                                    <a name='1426'></font>
            DF1A = FRCSNO * SNCOND+ FRCSOI * DF1                                 <a name='1427'>
                                                                                 <a name='1428'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1429'></font>
<font color=#447700>! CALCULATE SUBSURFACE HEAT FLUX, SSOIL, FROM FINAL THERMAL DIFFUSIVITY          <a name='1430'></font>
<font color=#447700>! OF SURFACE MEDIUMS, DF1 ABOVE, AND SKIN TEMPERATURE AND TOP                    <a name='1431'></font>
<font color=#447700>! MID-LAYER SOIL TEMPERATURE                                                     <a name='1432'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1433'></font>
            DF1 = DF1A * SNCOVR + DF1* (1.0- SNCOVR)                             <a name='1434'>
            SSOIL = DF1 * (T1- STC (1) ) / DTOT                                  <a name='1435'>
         END IF                                                                  <a name='1436'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1437'></font>
<font color=#447700>! DETERMINE SURFACE ROUGHNESS OVER SNOWPACK USING SNOW CONDITION FROM            <a name='1438'></font>
<font color=#447700>! THE PREVIOUS TIMESTEP.                                                         <a name='1439'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1440'></font>
         IF (SNCOVR  &gt; 0. ) THEN                                               <a name='1441'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOWZ0'>SNOWZ0</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWZ0_1"> (SNCOVR,Z0,Z0BRD)                                        <a name='1442'>
         ELSE<a name='1443'>
            Z0=Z0BRD<a name='1444'>
         END IF                                                                  <a name='1445'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1446'></font>
<font color=#447700>! NEXT CALL ROUTINE SFCDIF TO CALCULATE THE SFC EXCHANGE COEF (CH) FOR           <a name='1447'></font>
<font color=#447700>! HEAT AND MOISTURE.                                                             <a name='1448'></font>
                                                                                 <a name='1449'>
<font color=#447700>! NOTE !!!                                                                       <a name='1450'></font>
<font color=#447700>! DO NOT CALL SFCDIF UNTIL AFTER ABOVE CALL TO REDPRM, IN CASE                   <a name='1451'></font>
<font color=#447700>! ALTERNATIVE VALUES OF ROUGHNESS LENGTH (Z0) AND ZILINTINKEVICH COEF            <a name='1452'></font>
<font color=#447700>! (CZIL) ARE SET THERE VIA NAMELIST I/O.                                         <a name='1453'></font>
                                                                                 <a name='1454'>
<font color=#447700>! NOTE !!!                                                                       <a name='1455'></font>
<font color=#447700>! ROUTINE SFCDIF RETURNS A CH THAT REPRESENTS THE WIND SPD TIMES THE             <a name='1456'></font>
<font color=#447700>! "ORIGINAL" NONDIMENSIONAL "Ch" TYPICAL IN LITERATURE.  HENCE THE CH            <a name='1457'></font>
<font color=#447700>! RETURNED FROM SFCDIF HAS UNITS OF M/S.  THE IMPORTANT COMPANION                <a name='1458'></font>
<font color=#447700>! COEFFICIENT OF CH, CARRIED HERE AS "RCH", IS THE CH FROM SFCDIF TIMES          <a name='1459'></font>
<font color=#447700>! AIR DENSITY AND PARAMETER "CP".  "RCH" IS COMPUTED IN "CALL PENMAN".           <a name='1460'></font>
<font color=#447700>! RCH RATHER THAN CH IS THE COEFF USUALLY INVOKED LATER IN EQNS.                 <a name='1461'></font>
                                                                                 <a name='1462'>
<font color=#447700>! NOTE !!!                                                                       <a name='1463'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1464'></font>
<font color=#447700>! SFCDIF ALSO RETURNS THE SURFACE EXCHANGE COEFFICIENT FOR MOMENTUM, CM,         <a name='1465'></font>
<font color=#447700>! ALSO KNOWN AS THE SURFACE DRAGE COEFFICIENT. Needed as a state variable        <a name='1466'></font>
<font color=#447700>! for iterative/implicit solution of CH in SFCDIF                                <a name='1467'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1468'></font>
<font color=#447700>!        IF(.NOT.LCH) THEN                                                       <a name='1469'></font>
<font color=#447700>!          T1V = T1 * (1.0+ 0.61 * Q2)                                           <a name='1470'></font>
<font color=#447700>!          TH2V = TH2 * (1.0+ 0.61 * Q2)                                         <a name='1471'></font>
<font color=#447700>!          CALL SFCDIF_off (ZLVL,Z0,T1V,TH2V,SFCSPD,CZIL,CM,CH)                  <a name='1472'></font>
<font color=#447700>!        ENDIF                                                                   <a name='1473'></font>
                                                                                 <a name='1474'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1475'></font>
<font color=#447700>! CALL PENMAN SUBROUTINE TO CALCULATE POTENTIAL EVAPORATION (ETP), AND           <a name='1476'></font>
<font color=#447700>! OTHER PARTIAL PRODUCTS AND SUMS SAVE IN COMMON/RITE FOR LATER                  <a name='1477'></font>
<font color=#447700>! CALCULATIONS.                                                                  <a name='1478'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1479'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1480'></font>
<font color=#447700>! CALCULATE TOTAL DOWNWARD RADIATION (SOLAR PLUS LONGWAVE) NEEDED IN             <a name='1481'></font>
<font color=#447700>! PENMAN EP SUBROUTINE THAT FOLLOWS                                              <a name='1482'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1483'></font>
         FDOWN = SOLDN * (1.0- ALBEDO) + LWDN                                    <a name='1484'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1485'></font>
<font color=#447700>! CALC VIRTUAL TEMPS AND VIRTUAL POTENTIAL TEMPS NEEDED BY SUBROUTINES           <a name='1486'></font>
<font color=#447700>! PENMAN.                                                                        <a name='1487'></font>
         T2V = SFCTMP * (1.0+ 0.61 * Q2 )                                        <a name='1488'>
                                                                                 <a name='1489'>
         iout=0                                                                  <a name='1490'>
         if(iout.eq.1) then                                                      <a name='1491'>
         print*,'before penman'                                                  <a name='1492'>
         print*,' SFCTMP',SFCTMP,'SFCPRS',SFCPRS,'CH',CH,'T2V',T2V,      &amp; <a name='1493'>
       'TH2',TH2,'PRCP',PRCP,'FDOWN',FDOWN,'T24',T24,'SSOIL',SSOIL,      &amp;         <a name='1494'>
        'Q2',Q2,'Q2SAT',Q2SAT,'ETP',ETP,'RCH',RCH,                       &amp;        <a name='1495'>
        'EPSCA',EPSCA,'RR',RR  ,'SNOWNG',SNOWNG,'FRZGRA',FRZGRA,           &amp;       <a name='1496'>
        'DQSDT2',DQSDT2,'FLX2',FLX2,'SNOWH',SNOWH,'SNEQV',SNEQV,         &amp;      <a name='1497'>
        ' DSOIL',DSOIL,' FRCSNO',FRCSNO,' SNCOVR',SNCOVR,' DTOT',DTOT,   &amp;     <a name='1498'>
       ' ZSOIL (1)',ZSOIL(1),' DF1',DF1,'T1',T1,' STC1',STC(1),          &amp;       <a name='1499'>
        'ALBEDO',ALBEDO,'SMC',SMC,'STC',STC,'SH2O',SH2O                          <a name='1500'>
         endif                                                                   <a name='1501'>
                                                                                 <a name='1502'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#PENMAN'>PENMAN</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PENMAN_2"> (SFCTMP,SFCPRS,CH,T2V,TH2,PRCP,FDOWN,T24,SSOIL,     &amp;        <a name='1503'>
                       Q2,Q2SAT,ETP,RCH,EPSCA,RR,SNOWNG,FRZGRA,          &amp;<a name='1504'>
                         DQSDT2,FLX2,EMISSI)                                            <a name='1505'>
                                                                                 <a name='1506'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1507'></font>
<font color=#447700>! CALL CANRES TO CALCULATE THE CANOPY RESISTANCE AND CONVERT IT INTO PC          <a name='1508'></font>
<font color=#447700>! IF NONZERO GREENNESS FRACTION                                                  <a name='1509'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1510'></font>
                                                                                 <a name='1511'>
<font color=#447700>!       print*,'after penman ETP',ETP                                            <a name='1512'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1513'></font>
<font color=#447700>!  FROZEN GROUND EXTENSION: TOTAL SOIL WATER "SMC" WAS REPLACED                  <a name='1514'></font>
<font color=#447700>!  BY UNFROZEN SOIL WATER "SH2O" IN CALL TO CANRES BELOW                         <a name='1515'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1516'></font>
         IF (SHDFAC &gt; 0.) THEN                                                <a name='1517'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#CANRES'>CANRES</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CANRES_2"> (SOLDN,CH,SFCTMP,Q2,SFCPRS,SH2O,ZSOIL,NSOIL,     &amp;        <a name='1518'>
                          SMCWLT,SMCREF,RSMIN,RC,PC,NROOT,Q2SAT,DQSDT2,  &amp;<a name='1519'>
                          TOPT,RSMAX,RGL,HS,XLAI,                        &amp;<a name='1520'>
                          RCS,RCT,RCQ,RCSOIL,EMISSI)                      <a name='1521'>
         END IF                                                                  <a name='1522'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1523'></font>
<font color=#447700>! NOW DECIDE MAJOR PATHWAY BRANCH TO TAKE DEPENDING ON WHETHER SNOWPACK          <a name='1524'></font>
<font color=#447700>! EXISTS OR NOT:                                                                 <a name='1525'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1526'></font>
         ESNOW = 0.0                                                             <a name='1527'>
         IF (SNEQV  == 0.0) THEN                                                <a name='1528'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC'>NOPAC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOPAC_2"> (ETP,ETA,PRCP,SMC,SMCMAX,SMCWLT,                  &amp;  <a name='1529'>
                            SMCREF,SMCDRY,CMC,CMCMAX,NSOIL,DT,           &amp;  <a name='1530'>
                            SHDFAC,                                      &amp;  <a name='1531'>
                            SBETA,Q2,T1,SFCTMP,T24,TH2,FDOWN,F1,EMISSI,  &amp;<a name='1532'>
                            SSOIL,                                       &amp;  <a name='1533'>
                            STC,EPSCA,BEXP,PC,RCH,RR,CFACTR,             &amp;  <a name='1534'>
                            SH2O,SLOPE,KDT,FRZX,PSISAT,ZSOIL,            &amp;  <a name='1535'>
                            DKSAT,DWSAT,TBOT,ZBOT,RUNOFF1,RUNOFF2,       &amp;  <a name='1536'>
                            RUNOFF3,EDIR,EC,ET,ETT,NROOT,ICE,RTDIS,      &amp;  <a name='1537'>
                            QUARTZ,FXEXP,CSOIL,                          &amp;  <a name='1538'>
                            BETA,DRIP,DEW,FLX1,FLX3,VEGTYP)                  <a name='1539'>
            ETA_KINEMATIC = ETA                                                  <a name='1540'>
            ETA = ETA * LVH2O                                                    <a name='1541'>
            ETP = ETP*LVH2O                                                      <a name='1542'>
<font color=#447700>!            BETA = ETA/ETP                                                      <a name='1543'></font>
         ELSE                                                                    <a name='1544'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOPAC'>SNOPAC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOPAC_2"> (ETP,ETA,PRCP,PRCPF,SNOWNG,SMC,SMCMAX,SMCWLT,    &amp; <a name='1545'>
                         SMCREF,SMCDRY,CMC,CMCMAX,NSOIL,DT,              &amp; <a name='1546'>
                         SBETA,DF1,                                      &amp; <a name='1547'>
                         Q2,T1,SFCTMP,T24,TH2,FDOWN,F1,SSOIL,STC,EPSCA,  &amp; <a name='1548'>
                         SFCPRS,BEXP,PC,RCH,RR,CFACTR,SNCOVR,SNEQV,SNDENS,&amp; <a name='1549'>
                         SNOWH,SH2O,SLOPE,KDT,FRZX,PSISAT,               &amp; <a name='1550'>
                         ZSOIL,DWSAT,DKSAT,TBOT,ZBOT,SHDFAC,RUNOFF1,     &amp; <a name='1551'>
                         RUNOFF2,RUNOFF3,EDIR,EC,ET,ETT,NROOT,SNOMLT,    &amp; <a name='1552'>
                         ICE,RTDIS,QUARTZ,FXEXP,CSOIL,                   &amp; <a name='1553'>
                         BETA,DRIP,DEW,FLX1,FLX2,FLX3,ESNOW,ETNS,EMISSI, &amp;               <a name='1554'>
                         VEGTYP)                                          <a name='1555'>
            ETA_KINEMATIC =  ESNOW + ETNS                                        <a name='1556'>
            ESNOW = ESNOW * LSUBS                                                <a name='1557'>
<font color=#447700>!           ETA = ESNOW * LSUBS + ETNS * LVH2O                                   <a name='1558'></font>
            ETA = ESNOW + ETNS * LVH2O                                           <a name='1559'>
            ETP = ETP*LSUBS                                                      <a name='1560'>
<font color=#447700>!           ETP = ETP* ( (SNCOVR*LSUBS+(1.-SNCOVR)*LVH2O ) <a name='1561'></font>
<font color=#447700>!           BETA = ETA/ETP                                                       <a name='1562'></font>
         END IF                                                                  <a name='1563'>
                                                                                 <a name='1564'>
<font color=#447700>!     Calculate effective mixing ratio at grnd level (skin)                      <a name='1565'></font>
<font color=#447700>!                                                                                <a name='1566'></font>
<font color=#447700>!     Q1=Q2+ETA*CP/RCH                                                           <a name='1567'></font>
     Q1=Q2+ETA_KINEMATIC*CP/RCH                                                 <a name='1568'>
<font color=#447700>!                                                                                <a name='1569'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1570'></font>
<font color=#447700>!   PREPARE SENSIBLE HEAT (H) FOR RETURN TO PARENT MODEL                         <a name='1571'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1572'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1573'></font>
<font color=#447700>!  CONVERT UNITS AND/OR SIGN OF TOTAL EVAP (ETA), POTENTIAL EVAP (ETP),          <a name='1574'></font>
<font color=#447700>!  SUBSURFACE HEAT FLUX (S), AND RUNOFFS FOR WHAT PARENT MODEL EXPECTS           <a name='1575'></font>
<font color=#447700>!  CONVERT ETA FROM KG M-2 S-1 TO W M-2                                          <a name='1576'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1577'></font>
<font color=#447700>!ek      ETA = ETA*LVH2O                                                         <a name='1578'></font>
         SHEAT = - (CH * CP * SFCPRS)/ (R * T2V) * ( TH2- T1 )                   <a name='1579'>
                                                                                 <a name='1580'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1581'></font>
<font color=#447700>! CONVERT OTHER EVAP TERMS FROM M S-1 TO KG M-2 S-1, THEN TO W M-2               <a name='1582'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1583'></font>
<font color=#447700>!      EDIR = EDIR*1000.                                                         <a name='1584'></font>
<font color=#447700>!      EC = EC*1000.                                                             <a name='1585'></font>
<font color=#447700>!      DO K = 1,NSOIL                                                            <a name='1586'></font>
<font color=#447700>!       ET(K) = ET(K)*1000.                                                      <a name='1587'></font>
<font color=#447700>!      END DO                                                                    <a name='1588'></font>
<font color=#447700>!      ETT = ETT*1000.                                                           <a name='1589'></font>
                                                                                 <a name='1590'>
<font color=#447700>!        ETP = ETP * LVH2O                                                       <a name='1591'></font>
         EC = EC * LVH2O                                                         <a name='1592'>
         EDIR = EDIR * LVH2O                                                     <a name='1593'>
         DO K = 1,NSOIL                                                          <a name='1594'>
            ET (K) = ET (K)* LVH2O                                               <a name='1595'>
         END DO                                                                  <a name='1596'>
         ETT = ETT * LVH2O                                                       <a name='1597'>
                                                                                 <a name='1598'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1599'></font>
<font color=#447700>! CONVERT THE SIGN OF SOIL HEAT FLUX SO THAT:                                    <a name='1600'></font>
<font color=#447700>!   SSOIL&gt;0: WARM THE SURFACE  (NIGHT TIME)                                      <a name='1601'></font>
<font color=#447700>!   SSOIL&lt;0: COOL THE SURFACE  (DAY TIME)                                        <a name='1602'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1603'></font>
<font color=#447700>!        ESNOW = ESNOW * LVH2O                                                   <a name='1604'></font>
                                                                                 <a name='1605'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1606'></font>
<font color=#447700>!  CONVERT RUNOFF3 (INTERNAL LAYER RUNOFF FROM SUPERSAT) FROM M TO M S-1         <a name='1607'></font>
<font color=#447700>!  AND ADD TO SUBSURFACE RUNOFF/DRAINAGE/BASEFLOW                                <a name='1608'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1609'></font>
         SSOIL = -1.0* SSOIL                                                     <a name='1610'>
         RUNOFF3 = RUNOFF3/ DT                                                   <a name='1611'>
                                                                                 <a name='1612'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1613'></font>
<font color=#447700>! TOTAL COLUMN SOIL MOISTURE IN METERS (SOILM) AND ROOT-ZONE                     <a name='1614'></font>
<font color=#447700>! SOIL MOISTURE AVAILABILITY (FRACTION) RELATIVE TO POROSITY/SATURATION          <a name='1615'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1616'></font>
         RUNOFF2 = RUNOFF2+ RUNOFF3                                              <a name='1617'>
         IF (ICE == 0) THEN                                                    <a name='1618'>
            SOILM = -1.0* SMC (1)* ZSOIL (1)                                        <a name='1619'>
            DO K = 2,NSOIL                                                          <a name='1620'>
              SOILM = SOILM + SMC (K)* (ZSOIL (K -1) - ZSOIL (K))                  <a name='1621'>
            END DO                                                                  <a name='1622'>
            SOILWM = -1.0* (SMCMAX - SMCWLT)* ZSOIL (1)                             <a name='1623'>
            SOILWW = -1.0* (SMC (1) - SMCWLT)* ZSOIL (1)                            <a name='1624'>
                                                                                 <a name='1625'>
            IF (NROOT &gt;= 2) THEN                                                  <a name='1626'>
              DO K = 2,NROOT                                                        <a name='1627'>
               SOILWM = SOILWM + (SMCMAX - SMCWLT)* (ZSOIL (K -1) - ZSOIL (K))          <a name='1628'>
               SOILWW = SOILWW + (SMC(K) - SMCWLT)* (ZSOIL (K -1) - ZSOIL (K))          <a name='1629'>
              END DO                                                                <a name='1630'>
            END IF                                                                  <a name='1631'>
            IF (SOILWM .LT. 1.E-6) THEN                                             <a name='1632'>
              SOILWM = 0.0                                                          <a name='1633'>
              SOILW  = 0.0                                                          <a name='1634'>
              SOILM  = 0.0                                                          <a name='1635'>
            ELSE                                                                    <a name='1636'>
              SOILW = SOILWW / SOILWM                                               <a name='1637'>
            END IF                                                                  <a name='1638'>
         ELSE                                                                    <a name='1639'>
           SOILWM = 0.0                                                          <a name='1640'>
           SOILW  = 0.0                                                          <a name='1641'>
           SOILM  = 0.0                                                          <a name='1642'>
         END IF                                                                  <a name='1643'>
                                                                                 <a name='1644'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1645'></font>
  END SUBROUTINE SFLX                                                            <a name='1646'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1647'></font>
                                                                                 <a name='1648'>
<A NAME='ALCALC'><A href='../../html_code/phys/module_sf_noahlsm.F.html#ALCALC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1649'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>ALCALC</font> (ALB,SNOALB,SHDFAC,SHDMIN,SNCOVR,TSNOW,ALBEDO)            <A href='../../call_to/ALCALC.html' TARGET='index'>1</A><a name='1650'>
                                                                                 <a name='1651'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1652'></font>
<font color=#447700>! CALCULATE ALBEDO INCLUDING SNOW EFFECT (0 -&gt; 1)                                <a name='1653'></font>
<font color=#447700>!   ALB     SNOWFREE ALBEDO                                                      <a name='1654'></font>
<font color=#447700>!   SNOALB  MAXIMUM (DEEP) SNOW ALBEDO                                           <a name='1655'></font>
<font color=#447700>!   SHDFAC    AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION                      <a name='1656'></font>
<font color=#447700>!   SHDMIN    MINIMUM AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION              <a name='1657'></font>
<font color=#447700>!   SNCOVR  FRACTIONAL SNOW COVER                                                <a name='1658'></font>
<font color=#447700>!   ALBEDO  SURFACE ALBEDO INCLUDING SNOW EFFECT                                 <a name='1659'></font>
<font color=#447700>!   TSNOW   SNOW SURFACE TEMPERATURE (K)                                         <a name='1660'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1661'></font>
      IMPLICIT NONE                                                              <a name='1662'>
                                                                                 <a name='1663'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1664'></font>
<font color=#447700>! SNOALB IS ARGUMENT REPRESENTING MAXIMUM ALBEDO OVER DEEP SNOW,                 <a name='1665'></font>
<font color=#447700>! AS PASSED INTO SFLX, AND ADAPTED FROM THE SATELLITE-BASED MAXIMUM              <a name='1666'></font>
<font color=#447700>! SNOW ALBEDO FIELDS PROVIDED BY D. ROBINSON AND G. KUKLA                        <a name='1667'></font>
<font color=#447700>! (1985, JCAM, VOL 24, 402-411)                                                  <a name='1668'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1669'></font>
      REAL, INTENT(IN)  ::  ALB, SNOALB, SHDFAC, SHDMIN, SNCOVR, TSNOW                <a name='1670'>
      REAL, INTENT(OUT) ::  ALBEDO<a name='1671'>
      ALBEDO = ALB + (1.0- (SHDFAC - SHDMIN))* SNCOVR * (SNOALB - ALB)           <a name='1672'>
                                                                                 <a name='1673'>
<font color=#447700>!     BASE FORMULATION (DICKINSON ET AL., 1986, COGLEY ET AL., 1990)             <a name='1674'></font>
<font color=#447700>!          IF (TSNOW.LE.263.16) THEN                                             <a name='1675'></font>
<font color=#447700>!            ALBEDO=SNOALB                                                       <a name='1676'></font>
<font color=#447700>!          ELSE                                                                  <a name='1677'></font>
<font color=#447700>!            IF (TSNOW.LT.273.16) THEN                                           <a name='1678'></font>
<font color=#447700>!              TM=0.1*(TSNOW-263.16)                                             <a name='1679'></font>
<font color=#447700>!              ALBEDO=0.5*((0.9-0.2*(TM**3))+(0.8-0.16*(TM**3)))                 <a name='1680'></font>
<font color=#447700>!            ELSE                                                                <a name='1681'></font>
<font color=#447700>!              ALBEDO=0.67                                                       <a name='1682'></font>
<font color=#447700>!            ENDIF                                                               <a name='1683'></font>
<font color=#447700>!          ENDIF                                                                 <a name='1684'></font>
                                                                                 <a name='1685'>
<font color=#447700>!     ISBA FORMULATION (VERSEGHY, 1991; BAKER ET AL., 1990)                      <a name='1686'></font>
<font color=#447700>!          IF (TSNOW.LT.273.16) THEN                                             <a name='1687'></font>
<font color=#447700>!            ALBEDO=SNOALB-0.008*DT/86400                                        <a name='1688'></font>
<font color=#447700>!          ELSE                                                                  <a name='1689'></font>
<font color=#447700>!            ALBEDO=(SNOALB-0.5)*EXP(-0.24*DT/86400)+0.5                         <a name='1690'></font>
<font color=#447700>!          ENDIF                                                                 <a name='1691'></font>
<a name='1692'>
      IF (ALBEDO &gt; SNOALB) ALBEDO = SNOALB                                     <a name='1693'>
                                                                                 <a name='1694'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1695'></font>
  END SUBROUTINE ALCALC                                                          <a name='1696'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1697'></font>
                                                                                 <a name='1698'>
<A NAME='CANRES'><A href='../../html_code/phys/module_sf_noahlsm.F.html#CANRES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1699'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CANRES</font> (SOLAR,CH,SFCTMP,Q2,SFCPRS,SMC,ZSOIL,NSOIL,       &amp;      <A href='../../call_to/CANRES.html' TARGET='index'>2</A><a name='1700'>
                         SMCWLT,SMCREF,RSMIN,RC,PC,NROOT,Q2SAT,DQSDT2,    &amp;     <a name='1701'>
                         TOPT,RSMAX,RGL,HS,XLAI,                          &amp;     <a name='1702'>
                         RCS,RCT,RCQ,RCSOIL,EMISSI)                                    <a name='1703'>
                                                                                 <a name='1704'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1705'></font>
<font color=#447700>! SUBROUTINE CANRES                                                              <a name='1706'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1707'></font>
<font color=#447700>! CALCULATE CANOPY RESISTANCE WHICH DEPENDS ON INCOMING SOLAR RADIATION,         <a name='1708'></font>
<font color=#447700>! AIR TEMPERATURE, ATMOSPHERIC WATER VAPOR PRESSURE DEFICIT AT THE               <a name='1709'></font>
<font color=#447700>! LOWEST MODEL LEVEL, AND SOIL MOISTURE (PREFERABLY UNFROZEN SOIL                <a name='1710'></font>
<font color=#447700>! MOISTURE RATHER THAN TOTAL)                                                    <a name='1711'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1712'></font>
<font color=#447700>! SOURCE:  JARVIS (1976), NOILHAN AND PLANTON (1989, MWR), JACQUEMIN AND         <a name='1713'></font>
<font color=#447700>! NOILHAN (1990, BLM)                                                            <a name='1714'></font>
<font color=#447700>! SEE ALSO:  CHEN ET AL (1996, JGR, VOL 101(D3), 7251-7268), EQNS 12-14          <a name='1715'></font>
<font color=#447700>! AND TABLE 2 OF SEC. 3.1.2                                                      <a name='1716'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1717'></font>
<font color=#447700>! INPUT:                                                                         <a name='1718'></font>
<font color=#447700>!   SOLAR   INCOMING SOLAR RADIATION                                             <a name='1719'></font>
<font color=#447700>!   CH      SURFACE EXCHANGE COEFFICIENT FOR HEAT AND MOISTURE                   <a name='1720'></font>
<font color=#447700>!   SFCTMP  AIR TEMPERATURE AT 1ST LEVEL ABOVE GROUND                            <a name='1721'></font>
<font color=#447700>!   Q2      AIR HUMIDITY AT 1ST LEVEL ABOVE GROUND                               <a name='1722'></font>
<font color=#447700>!   Q2SAT   SATURATION AIR HUMIDITY AT 1ST LEVEL ABOVE GROUND                    <a name='1723'></font>
<font color=#447700>!   DQSDT2  SLOPE OF SATURATION HUMIDITY FUNCTION WRT TEMP                       <a name='1724'></font>
<font color=#447700>!   SFCPRS  SURFACE PRESSURE                                                     <a name='1725'></font>
<font color=#447700>!   SMC     VOLUMETRIC SOIL MOISTURE                                             <a name='1726'></font>
<font color=#447700>!   ZSOIL   SOIL DEPTH (NEGATIVE SIGN, AS IT IS BELOW GROUND)                    <a name='1727'></font>
<font color=#447700>!   NSOIL   NO. OF SOIL LAYERS                                                   <a name='1728'></font>
<font color=#447700>!   NROOT   NO. OF SOIL LAYERS IN ROOT ZONE (1.LE.NROOT.LE.NSOIL)                <a name='1729'></font>
<font color=#447700>!   XLAI    LEAF AREA INDEX                                                      <a name='1730'></font>
<font color=#447700>!   SMCWLT  WILTING POINT                                                        <a name='1731'></font>
<font color=#447700>!   SMCREF  REFERENCE SOIL MOISTURE (WHERE SOIL WATER DEFICIT STRESS             <a name='1732'></font>
<font color=#447700>!             SETS IN)                                                           <a name='1733'></font>
<font color=#447700>! RSMIN, RSMAX, TOPT, RGL, HS ARE CANOPY STRESS PARAMETERS SET IN                <a name='1734'></font>
<font color=#447700>!   SURBOUTINE REDPRM                                                            <a name='1735'></font>
<font color=#447700>! OUTPUT:                                                                        <a name='1736'></font>
<font color=#447700>!   PC  PLANT COEFFICIENT                                                        <a name='1737'></font>
<font color=#447700>!   RC  CANOPY RESISTANCE                                                        <a name='1738'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1739'></font>
<a name='1740'>
      IMPLICIT NONE                                                              <a name='1741'>
      INTEGER, INTENT(IN) :: NROOT,NSOIL<a name='1742'>
      INTEGER  K                                                                 <a name='1743'>
      REAL,    INTENT(IN) :: CH,DQSDT2,HS,Q2,Q2SAT,RSMIN,RGL,RSMAX,        &amp;<a name='1744'>
                             SFCPRS,SFCTMP,SMCREF,SMCWLT, SOLAR,TOPT,XLAI, &amp;<a name='1745'>
                             EMISSI                                        <a name='1746'>
      REAL,DIMENSION(1:NSOIL), INTENT(IN) :: SMC,ZSOIL<a name='1747'>
      REAL,    INTENT(OUT):: PC,RC,RCQ,RCS,RCSOIL,RCT<a name='1748'>
      REAL                :: DELTA,FF,GX,P,RR<a name='1749'>
      REAL, DIMENSION(1:NSOLD) ::  PART<a name='1750'>
      REAL, PARAMETER     :: SLV = 2.501000E6<a name='1751'>
<a name='1752'>
                                                                                 <a name='1753'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1754'></font>
<font color=#447700>! INITIALIZE CANOPY RESISTANCE MULTIPLIER TERMS.                                 <a name='1755'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1756'></font>
      RCS = 0.0                                                                  <a name='1757'>
      RCT = 0.0                                                                  <a name='1758'>
      RCQ = 0.0                                                                  <a name='1759'>
      RCSOIL = 0.0                                                               <a name='1760'>
                                                                                 <a name='1761'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1762'></font>
<font color=#447700>! CONTRIBUTION DUE TO INCOMING SOLAR RADIATION                                   <a name='1763'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1764'></font>
      RC = 0.0                                                                   <a name='1765'>
      FF = 0.55*2.0* SOLAR / (RGL * XLAI)                                        <a name='1766'>
      RCS = (FF + RSMIN / RSMAX) / (1.0+ FF)                                     <a name='1767'>
                                                                                 <a name='1768'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1769'></font>
<font color=#447700>! CONTRIBUTION DUE TO AIR TEMPERATURE AT FIRST MODEL LEVEL ABOVE GROUND          <a name='1770'></font>
<font color=#447700>! RCT EXPRESSION FROM NOILHAN AND PLANTON (1989, MWR).                           <a name='1771'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1772'></font>
      RCS = MAX (RCS,0.0001)                                                     <a name='1773'>
      RCT = 1.0- 0.0016* ( (TOPT - SFCTMP)**2.0)                                 <a name='1774'>
                                                                                 <a name='1775'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1776'></font>
<font color=#447700>! CONTRIBUTION DUE TO VAPOR PRESSURE DEFICIT AT FIRST MODEL LEVEL.               <a name='1777'></font>
<font color=#447700>! RCQ EXPRESSION FROM SSIB                                                       <a name='1778'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1779'></font>
      RCT = MAX (RCT,0.0001)                                                     <a name='1780'>
      RCQ = 1.0/ (1.0+ HS * (Q2SAT - Q2))                                        <a name='1781'>
                                                                                 <a name='1782'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1783'></font>
<font color=#447700>! CONTRIBUTION DUE TO SOIL MOISTURE AVAILABILITY.                                <a name='1784'></font>
<font color=#447700>! DETERMINE CONTRIBUTION FROM EACH SOIL LAYER, THEN ADD THEM UP.                 <a name='1785'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1786'></font>
      RCQ = MAX (RCQ,0.01)                                                       <a name='1787'>
      GX = (SMC (1) - SMCWLT) / (SMCREF - SMCWLT)                                <a name='1788'>
      IF (GX  &gt;  1.) GX = 1.                                                    <a name='1789'>
      IF (GX  &lt;  0.) GX = 0.                                                    <a name='1790'>
                                                                                 <a name='1791'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1792'></font>
<font color=#447700>! USE SOIL DEPTH AS WEIGHTING FACTOR                                             <a name='1793'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1794'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1795'></font>
<font color=#447700>! USE ROOT DISTRIBUTION AS WEIGHTING FACTOR                                      <a name='1796'></font>
<font color=#447700>!      PART(1) = RTDIS(1) * GX                                                   <a name='1797'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1798'></font>
      PART (1) = (ZSOIL (1)/ ZSOIL (NROOT)) * GX                                 <a name='1799'>
      DO K = 2,NROOT                                                             <a name='1800'>
         GX = (SMC (K) - SMCWLT) / (SMCREF - SMCWLT)                             <a name='1801'>
         IF (GX &gt;  1.) GX = 1.                                                 <a name='1802'>
         IF (GX &lt;  0.) GX = 0.                                                 <a name='1803'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1804'></font>
<font color=#447700>! USE SOIL DEPTH AS WEIGHTING FACTOR                                             <a name='1805'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1806'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1807'></font>
<font color=#447700>! USE ROOT DISTRIBUTION AS WEIGHTING FACTOR                                      <a name='1808'></font>
<font color=#447700>!        PART(K) = RTDIS(K) * GX                                                 <a name='1809'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1810'></font>
         PART (K) = ( (ZSOIL (K) - ZSOIL (K -1))/ ZSOIL (NROOT)) * GX            <a name='1811'>
      END DO                                                                     <a name='1812'>
      DO K = 1,NROOT                                                             <a name='1813'>
         RCSOIL = RCSOIL + PART (K)                                              <a name='1814'>
      END DO                                                                     <a name='1815'>
                                                                                 <a name='1816'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1817'></font>
<font color=#447700>! DETERMINE CANOPY RESISTANCE DUE TO ALL FACTORS.  CONVERT CANOPY                <a name='1818'></font>
<font color=#447700>! RESISTANCE (RC) TO PLANT COEFFICIENT (PC) TO BE USED WITH POTENTIAL            <a name='1819'></font>
<font color=#447700>! EVAP IN DETERMINING ACTUAL EVAP.  PC IS DETERMINED BY:                         <a name='1820'></font>
<font color=#447700>!   PC * LINERIZED PENMAN POTENTIAL EVAP =                                       <a name='1821'></font>
<font color=#447700>!   PENMAN-MONTEITH ACTUAL EVAPORATION (CONTAINING RC TERM).                     <a name='1822'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1823'></font>
      RCSOIL = MAX (RCSOIL,0.0001)                                               <a name='1824'>
                                                                                 <a name='1825'>
      RC = RSMIN / (XLAI * RCS * RCT * RCQ * RCSOIL)                             <a name='1826'>
<font color=#447700>!      RR = (4.* SIGMA * RD / CP)* (SFCTMP **4.)/ (SFCPRS * CH) + 1.0<a name='1827'></font>
      RR = (4.* EMISSI *SIGMA * RD / CP)* (SFCTMP **4.)/ (SFCPRS * CH) &amp;<a name='1828'>
             + 1.0             <a name='1829'>
                                                                                 <a name='1830'>
      DELTA = (SLV / CP)* DQSDT2                                                 <a name='1831'>
                                                                                 <a name='1832'>
      PC = (RR + DELTA)/ (RR * (1. + RC * CH) + DELTA)                           <a name='1833'>
<a name='1834'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1835'></font>
  END SUBROUTINE CANRES                                                          <a name='1836'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1837'></font>
                                                                                 <a name='1838'>
<A NAME='CSNOW'><A href='../../html_code/phys/module_sf_noahlsm.F.html#CSNOW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1839'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CSNOW</font> (SNCOND,DSNOW)                                             <A href='../../call_to/CSNOW.html' TARGET='index'>2</A><a name='1840'>
                                                                                 <a name='1841'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1842'></font>
<font color=#447700>! SUBROUTINE CSNOW                                                               <a name='1843'></font>
<font color=#447700>! FUNCTION CSNOW                                                                 <a name='1844'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1845'></font>
<font color=#447700>! CALCULATE SNOW TERMAL CONDUCTIVITY                                             <a name='1846'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1847'></font>
      IMPLICIT NONE                                                              <a name='1848'>
      REAL, INTENT(IN) :: DSNOW<a name='1849'>
      REAL, INTENT(OUT):: SNCOND<a name='1850'>
      REAL             :: C                                                                 <a name='1851'>
      REAL, PARAMETER  :: UNIT = 0.11631<a name='1852'>
                                                                                 <a name='1853'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1854'></font>
<font color=#447700>! SNCOND IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)                          <a name='1855'></font>
<font color=#447700>! CSNOW IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)                           <a name='1856'></font>
<font color=#447700>! BASIC VERSION IS DYACHKOVA EQUATION (1960), FOR RANGE 0.1-0.4                  <a name='1857'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1858'></font>
      C = 0.328*10** (2.25* DSNOW)                                               <a name='1859'>
<font color=#447700>!      CSNOW=UNIT*C                                                              <a name='1860'></font>
                                                                                 <a name='1861'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1862'></font>
<font color=#447700>! DE VAUX EQUATION (1933), IN RANGE 0.1-0.6                                      <a name='1863'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1864'></font>
<font color=#447700>!      SNCOND=0.0293*(1.+100.*DSNOW**2)                                          <a name='1865'></font>
<font color=#447700>!      CSNOW=0.0293*(1.+100.*DSNOW**2)                                           <a name='1866'></font>
                                                                                 <a name='1867'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1868'></font>
<font color=#447700>! E. ANDERSEN FROM FLERCHINGER                                                   <a name='1869'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1870'></font>
<font color=#447700>!      SNCOND=0.021+2.51*DSNOW**2                                                <a name='1871'></font>
<font color=#447700>!      CSNOW=0.021+2.51*DSNOW**2                                                 <a name='1872'></font>
                                                                                 <a name='1873'>
      SNCOND = UNIT * C                                                          <a name='1874'>
<a name='1875'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1876'></font>
  END SUBROUTINE CSNOW                                                           <a name='1877'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1878'></font>
                                                                                 <a name='1879'>
<A NAME='DEVAP'><A href='../../html_code/phys/module_sf_noahlsm.F.html#DEVAP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1880'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>DEVAP</font> (EDIR,ETP1,SMC,ZSOIL,SHDFAC,SMCMAX,BEXP,         &amp;         <A href='../../call_to/DEVAP.html' TARGET='index'>1</A><a name='1881'>
                        DKSAT,DWSAT,SMCDRY,SMCREF,SMCWLT,FXEXP)               <a name='1882'>
                                                                                 <a name='1883'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1884'></font>
<font color=#447700>! SUBROUTINE DEVAP                                                               <a name='1885'></font>
<font color=#447700>! FUNCTION DEVAP                                                                 <a name='1886'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1887'></font>
<font color=#447700>! CALCULATE DIRECT SOIL EVAPORATION                                              <a name='1888'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1889'></font>
      IMPLICIT NONE                                                              <a name='1890'>
      REAL, INTENT(IN) :: ETP1,SMC,BEXP,DKSAT,DWSAT,FXEXP,              &amp;<a name='1891'>
                          SHDFAC,SMCDRY,SMCMAX,ZSOIL,SMCREF,SMCWLT<a name='1892'>
      REAL, INTENT(OUT):: EDIR<a name='1893'>
      REAL             :: FX, SRATIO<a name='1894'>
<a name='1895'>
                                                                                 <a name='1896'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1897'></font>
<font color=#447700>! DIRECT EVAP A FUNCTION OF RELATIVE SOIL MOISTURE AVAILABILITY, LINEAR          <a name='1898'></font>
<font color=#447700>! WHEN FXEXP=1.                                                                  <a name='1899'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1900'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1901'></font>
<font color=#447700>! FX &gt; 1 REPRESENTS DEMAND CONTROL                                               <a name='1902'></font>
<font color=#447700>! FX &lt; 1 REPRESENTS FLUX CONTROL                                                 <a name='1903'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1904'></font>
<a name='1905'>
      SRATIO = (SMC - SMCDRY) / (SMCMAX - SMCDRY)                                <a name='1906'>
      IF (SRATIO &gt; 0.) THEN                                                   <a name='1907'>
        FX = SRATIO**FXEXP                                                       <a name='1908'>
        FX = MAX ( MIN ( FX, 1. ) ,0. )                                          <a name='1909'>
      ELSE                                                                       <a name='1910'>
        FX = 0.                                                                  <a name='1911'>
      ENDIF                                                                      <a name='1912'>
                                                                                 <a name='1913'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1914'></font>
<font color=#447700>! ALLOW FOR THE DIRECT-EVAP-REDUCING EFFECT OF SHADE                             <a name='1915'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1916'></font>
      EDIR = FX * ( 1.0- SHDFAC ) * ETP1                                         <a name='1917'>
                                                                                 <a name='1918'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1919'></font>
  END SUBROUTINE DEVAP                                                           <a name='1920'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1921'></font>
                                                                                 <a name='1922'>
<A NAME='EVAPO'><A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1923'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>EVAPO</font> (ETA1,SMC,NSOIL,CMC,ETP1,DT,ZSOIL,               &amp;         <A href='../../call_to/EVAPO.html' TARGET='index'>3</A>,<A href='../../call_from/EVAPO.html' TARGET='index'>2</A><a name='1924'>
                         SH2O,                                          &amp;        <a name='1925'>
                         SMCMAX,BEXP,PC,SMCWLT,DKSAT,DWSAT,             &amp;        <a name='1926'>
                         SMCREF,SHDFAC,CMCMAX,                          &amp;        <a name='1927'>
                         SMCDRY,CFACTR,                                 &amp;        <a name='1928'>
                         EDIR,EC,ET,ETT,SFCTMP,Q2,NROOT,RTDIS,FXEXP)             <a name='1929'>
                                                                                 <a name='1930'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1931'></font>
<font color=#447700>! SUBROUTINE EVAPO                                                               <a name='1932'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1933'></font>
<font color=#447700>! CALCULATE SOIL MOISTURE FLUX.  THE SOIL MOISTURE CONTENT (SMC - A PER          <a name='1934'></font>
<font color=#447700>! UNIT VOLUME MEASUREMENT) IS A DEPENDENT VARIABLE THAT IS UPDATED WITH          <a name='1935'></font>
<font color=#447700>! PROGNOSTIC EQNS. THE CANOPY MOISTURE CONTENT (CMC) IS ALSO UPDATED.            <a name='1936'></font>
<font color=#447700>! FROZEN GROUND VERSION:  NEW STATES ADDED: SH2O, AND FROZEN GROUND              <a name='1937'></font>
<font color=#447700>! CORRECTION FACTOR, FRZFACT AND PARAMETER SLOPE.                                <a name='1938'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1939'></font>
      IMPLICIT NONE                                                              <a name='1940'>
      INTEGER, INTENT(IN)   :: NSOIL, NROOT<a name='1941'>
      INTEGER               :: I,K<a name='1942'>
      REAL,    INTENT(IN)   :: BEXP, CFACTR,CMC,CMCMAX,DKSAT,           &amp;<a name='1943'>
                                 DT,DWSAT,ETP1,FXEXP,PC,Q2,SFCTMP,      &amp;<a name='1944'>
                                 SHDFAC,SMCDRY,SMCMAX,SMCREF,SMCWLT<a name='1945'>
      REAL,    INTENT(OUT)  :: EC,EDIR,ETA1,ETT<a name='1946'>
      REAL                  :: CMC2MS<a name='1947'>
      REAL,DIMENSION(1:NSOIL), INTENT(IN) :: RTDIS, SMC, SH2O, ZSOIL<a name='1948'>
      REAL,DIMENSION(1:NSOIL), INTENT(OUT) :: ET<a name='1949'>
                                                                                <a name='1950'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1951'></font>
<font color=#447700>! EXECUTABLE CODE BEGINS HERE IF THE POTENTIAL EVAPOTRANSPIRATION IS             <a name='1952'></font>
<font color=#447700>! GREATER THAN ZERO.                                                             <a name='1953'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1954'></font>
      EDIR = 0.                                                                  <a name='1955'>
      EC = 0.                                                                    <a name='1956'>
      ETT = 0.                                                                   <a name='1957'>
      DO K = 1,NSOIL                                                             <a name='1958'>
         ET (K) = 0.                                                             <a name='1959'>
      END DO                                                                     <a name='1960'>
                                                                                 <a name='1961'>
<font color=#447700>!      print*,'SHDFAC',SHDFAC,'SMCMAX', SMCMAX,'BEXP',BEXP,                      <a name='1962'></font>
<font color=#447700>!    &amp; 'DKSAT',DKSAT,'DWSAT',DWSAT,'DRY',SMCDRY,'REF',SMCREF,                    <a name='1963'></font>
<font color=#447700>!    &amp; 'WLT',SMCWLT,'FXEX',FXEXP,'SMC',SMC                                       <a name='1964'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1965'></font>
<font color=#447700>! RETRIEVE DIRECT EVAPORATION FROM SOIL SURFACE.  CALL THIS FUNCTION             <a name='1966'></font>
<font color=#447700>! ONLY IF VEG COVER NOT COMPLETE.                                                <a name='1967'></font>
<font color=#447700>! FROZEN GROUND VERSION:  SH2O STATES REPLACE SMC STATES.                        <a name='1968'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1969'></font>
      IF (ETP1 &gt; 0.0) THEN                                                    <a name='1970'>
         IF (SHDFAC &lt;  1.) THEN                                                <a name='1971'>
<font color=#447700>!            CALL DEVAP (EDIR,ETP1,SH2O (1),ZSOIL (1),SHDFAC,SMCMAX,             <a name='1972'></font>
             CALL <A href='../../html_code/phys/module_sf_lsm_nmm.F.html#DEVAP'>DEVAP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEVAP_1"> (EDIR,ETP1,SMC (1),ZSOIL (1),SHDFAC,SMCMAX,      &amp;       <a name='1973'>
                         BEXP,DKSAT,DWSAT,SMCDRY,SMCREF,SMCWLT,FXEXP)            <a name='1974'>
         END IF                                                                  <a name='1975'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1976'></font>
<font color=#447700>! INITIALIZE PLANT TOTAL TRANSPIRATION, RETRIEVE PLANT TRANSPIRATION,            <a name='1977'></font>
<font color=#447700>! AND ACCUMULATE IT FOR ALL SOIL LAYERS.                                         <a name='1978'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1979'></font>
                                                                                 <a name='1980'>
         IF (SHDFAC &gt; 0.0) THEN                                               <a name='1981'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TRANSP'>TRANSP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRANSP_2"> (ET,NSOIL,ETP1,SH2O,CMC,ZSOIL,SHDFAC,SMCWLT,     &amp;       <a name='1982'>
                          CMCMAX,PC,CFACTR,SMCREF,SFCTMP,Q2,NROOT,RTDIS)         <a name='1983'>
            DO K = 1,NSOIL                                                       <a name='1984'>
               ETT = ETT + ET ( K )                                              <a name='1985'>
            END DO                                                               <a name='1986'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1987'></font>
<font color=#447700>! CALCULATE CANOPY EVAPORATION.                                                  <a name='1988'></font>
<font color=#447700>! IF STATEMENTS TO AVOID TANGENT LINEAR PROBLEMS NEAR CMC=0.0.                   <a name='1989'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1990'></font>
            IF (CMC &gt; 0.0) THEN                                               <a name='1991'>
               EC = SHDFAC * ( ( CMC / CMCMAX ) ** CFACTR ) * ETP1               <a name='1992'>
            ELSE                                                                 <a name='1993'>
               EC = 0.0                                                          <a name='1994'>
            END IF                                                               <a name='1995'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1996'></font>
<font color=#447700>! EC SHOULD BE LIMITED BY THE TOTAL AMOUNT OF AVAILABLE WATER ON THE             <a name='1997'></font>
<font color=#447700>! CANOPY.  -F.CHEN, 18-OCT-1994                                                  <a name='1998'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='1999'></font>
            CMC2MS = CMC / DT                                                    <a name='2000'>
            EC = MIN ( CMC2MS, EC )                                              <a name='2001'>
         END IF                                                                  <a name='2002'>
      END IF                                                                     <a name='2003'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2004'></font>
<font color=#447700>! TOTAL UP EVAP AND TRANSP TYPES TO OBTAIN ACTUAL EVAPOTRANSP                    <a name='2005'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2006'></font>
      ETA1 = EDIR + ETT + EC                                                     <a name='2007'>
                                                                                 <a name='2008'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2009'></font>
  END SUBROUTINE EVAPO                                                           <a name='2010'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2011'></font>
                                                                                 <a name='2012'>
<A NAME='FRH2O'><A href='../../html_code/phys/module_sf_noahlsm.F.html#FRH2O' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2013'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>FRH2O</font> (FREE,TKELV,SMC,SH2O,SMCMAX,BEXP,PSIS)                     <A href='../../call_to/FRH2O.html' TARGET='index'>3</A><a name='2014'>
                                                                                 <a name='2015'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2016'></font>
<font color=#447700>! SUBROUTINE FRH2O                                                               <a name='2017'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2018'></font>
<font color=#447700>! CALCULATE AMOUNT OF SUPERCOOLED LIQUID SOIL WATER CONTENT IF                   <a name='2019'></font>
<font color=#447700>! TEMPERATURE IS BELOW 273.15K (T0).  REQUIRES NEWTON-TYPE ITERATION TO          <a name='2020'></font>
<font color=#447700>! SOLVE THE NONLINEAR IMPLICIT EQUATION GIVEN IN EQN 17 OF KOREN ET AL           <a name='2021'></font>
<font color=#447700>! (1999, JGR, VOL 104(D16), 19569-19585).                                        <a name='2022'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2023'></font>
<font color=#447700>! NEW VERSION (JUNE 2001): MUCH FASTER AND MORE ACCURATE NEWTON                  <a name='2024'></font>
<font color=#447700>! ITERATION ACHIEVED BY FIRST TAKING LOG OF EQN CITED ABOVE -- LESS THAN         <a name='2025'></font>
<font color=#447700>! 4 (TYPICALLY 1 OR 2) ITERATIONS ACHIEVES CONVERGENCE.  ALSO, EXPLICIT          <a name='2026'></font>
<font color=#447700>! 1-STEP SOLUTION OPTION FOR SPECIAL CASE OF PARAMETER CK=0, WHICH               <a name='2027'></font>
<font color=#447700>! REDUCES THE ORIGINAL IMPLICIT EQUATION TO A SIMPLER EXPLICIT FORM,             <a name='2028'></font>
<font color=#447700>! KNOWN AS THE "FLERCHINGER EQN". IMPROVED HANDLING OF SOLUTION IN THE           <a name='2029'></font>
<font color=#447700>! LIMIT OF FREEZING POINT TEMPERATURE T0.                                        <a name='2030'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2031'></font>
<font color=#447700>! INPUT:                                                                         <a name='2032'></font>
                                                                                 <a name='2033'>
<font color=#447700>!   TKELV.........TEMPERATURE (Kelvin)                                           <a name='2034'></font>
<font color=#447700>!   SMC...........TOTAL SOIL MOISTURE CONTENT (VOLUMETRIC)                       <a name='2035'></font>
<font color=#447700>!   SH2O..........LIQUID SOIL MOISTURE CONTENT (VOLUMETRIC)                      <a name='2036'></font>
<font color=#447700>!   SMCMAX........SATURATION SOIL MOISTURE CONTENT (FROM REDPRM)                 <a name='2037'></font>
<font color=#447700>!   B.............SOIL TYPE "B" PARAMETER (FROM REDPRM)                          <a name='2038'></font>
<font color=#447700>!   PSIS..........SATURATED SOIL MATRIC POTENTIAL (FROM REDPRM)                  <a name='2039'></font>
                                                                                 <a name='2040'>
<font color=#447700>! OUTPUT:                                                                        <a name='2041'></font>
<font color=#447700>!   FRH2O.........SUPERCOOLED LIQUID WATER CONTENT                               <a name='2042'></font>
<font color=#447700>!   FREE..........SUPERCOOLED LIQUID WATER CONTENT                               <a name='2043'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2044'></font>
      IMPLICIT NONE                                                              <a name='2045'>
      REAL, INTENT(IN)     :: BEXP,PSIS,SH2O,SMC,SMCMAX,TKELV<a name='2046'>
      REAL, INTENT(OUT)    :: FREE<a name='2047'>
      REAL                 :: BX,DENOM,DF,DSWL,FK,SWL,SWLK<a name='2048'>
      INTEGER              :: NLOG,KCOUNT<a name='2049'>
<font color=#447700>!      PARAMETER(CK = 0.0)                                                       <a name='2050'></font>
      REAL, PARAMETER      :: CK = 8.0, BLIM = 5.5, ERROR = 0.005,       &amp;<a name='2051'>
                              HLICE = 3.335E5, GS = 9.81,DICE = 920.0,   &amp;<a name='2052'>
                              DH2O = 1000.0, T0 = 273.15<a name='2053'>
                                                                                 <a name='2054'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2055'></font>
<font color=#447700>! LIMITS ON PARAMETER B: B &lt; 5.5  (use parameter BLIM)                           <a name='2056'></font>
<font color=#447700>! SIMULATIONS SHOWED IF B &gt; 5.5 UNFROZEN WATER CONTENT IS                        <a name='2057'></font>
<font color=#447700>! NON-REALISTICALLY HIGH AT VERY LOW TEMPERATURES.                               <a name='2058'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2059'></font>
      BX = BEXP                                                                  <a name='2060'>
                                                                                 <a name='2061'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2062'></font>
<font color=#447700>! INITIALIZING ITERATIONS COUNTER AND ITERATIVE SOLUTION FLAG.                   <a name='2063'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2064'></font>
      IF (BEXP &gt;  BLIM) BX = BLIM                                              <a name='2065'>
      NLOG = 0                                                                   <a name='2066'>
                                                                                 <a name='2067'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2068'></font>
<font color=#447700>!  IF TEMPERATURE NOT SIGNIFICANTLY BELOW FREEZING (T0), SH2O = SMC              <a name='2069'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2070'></font>
      KCOUNT = 0                                                                 <a name='2071'>
<font color=#447700>!      FRH2O = SMC                                                               <a name='2072'></font>
      IF (TKELV &gt; (T0- 1.E-3)) THEN                                           <a name='2073'>
          FREE = SMC                                                             <a name='2074'>
      ELSE                                                                       <a name='2075'>
                                                                                 <a name='2076'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2077'></font>
<font color=#447700>! OPTION 1: ITERATED SOLUTION FOR NONZERO CK                                     <a name='2078'></font>
<font color=#447700>! IN KOREN ET AL, JGR, 1999, EQN 17                                              <a name='2079'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2080'></font>
<font color=#447700>! INITIAL GUESS FOR SWL (frozen content)                                         <a name='2081'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2082'></font>
         IF (CK /= 0.0) THEN                                                   <a name='2083'>
            SWL = SMC - SH2O                                                     <a name='2084'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2085'></font>
<font color=#447700>! KEEP WITHIN BOUNDS.                                                            <a name='2086'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2087'></font>
            IF (SWL &gt; (SMC -0.02)) SWL = SMC -0.02                            <a name='2088'>
                                                                                 <a name='2089'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2090'></font>
<font color=#447700>!  START OF ITERATIONS                                                           <a name='2091'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2092'></font>
            IF (SWL &lt; 0.) SWL = 0.                                            <a name='2093'>
 1001       Continue                                                             <a name='2094'>
              IF (.NOT.( (NLOG &lt; 10) .AND. (KCOUNT == 0)))   goto 1002<a name='2095'>
              NLOG = NLOG +1                                                    <a name='2096'>
              DF = ALOG ( ( PSIS * GS / HLICE ) * ( ( 1. + CK * SWL )**2.) * &amp;        <a name='2097'>
                   ( SMCMAX / (SMC - SWL) )** BX) - ALOG ( - (               &amp;        <a name='2098'>
                   TKELV - T0)/ TKELV)                                         <a name='2099'>
              DENOM = 2. * CK / ( 1. + CK * SWL ) + BX / ( SMC - SWL )          <a name='2100'>
              SWLK = SWL - DF / DENOM                                           <a name='2101'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2102'></font>
<font color=#447700>! BOUNDS USEFUL FOR MATHEMATICAL SOLUTION.                                       <a name='2103'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2104'></font>
              IF (SWLK &gt; (SMC -0.02)) SWLK = SMC - 0.02                      <a name='2105'>
              IF (SWLK &lt; 0.) SWLK = 0.                                       <a name='2106'>
                                                                                 <a name='2107'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2108'></font>
<font color=#447700>! MATHEMATICAL SOLUTION BOUNDS APPLIED.                                          <a name='2109'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2110'></font>
              DSWL = ABS (SWLK - SWL)                                           <a name='2111'>
                                                                                 <a name='2112'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2113'></font>
<font color=#447700>! IF MORE THAN 10 ITERATIONS, USE EXPLICIT METHOD (CK=0 APPROX.)                 <a name='2114'></font>
<font color=#447700>! WHEN DSWL LESS OR EQ. ERROR, NO MORE ITERATIONS REQUIRED.                      <a name='2115'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2116'></font>
              SWL = SWLK                                                        <a name='2117'>
              IF ( DSWL &lt;= ERROR ) THEN                                       <a name='2118'>
                    KCOUNT = KCOUNT +1                                           <a name='2119'>
              END IF                                                            <a name='2120'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2121'></font>
<font color=#447700>!  END OF ITERATIONS                                                             <a name='2122'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2123'></font>
<font color=#447700>! BOUNDS APPLIED WITHIN DO-BLOCK ARE VALID FOR PHYSICAL SOLUTION.                <a name='2124'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2125'></font>
<font color=#447700>!          FRH2O = SMC - SWL                                                     <a name='2126'></font>
           goto 1001                                                                <a name='2127'>
 1002   continue                                                                 <a name='2128'>
           FREE = SMC - SWL                                                     <a name='2129'>
         END IF                                                                  <a name='2130'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2131'></font>
<font color=#447700>! END OPTION 1                                                                   <a name='2132'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2133'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2134'></font>
<font color=#447700>! OPTION 2: EXPLICIT SOLUTION FOR FLERCHINGER EQ. i.e. CK=0                      <a name='2135'></font>
<font color=#447700>! IN KOREN ET AL., JGR, 1999, EQN 17                                             <a name='2136'></font>
<font color=#447700>! APPLY PHYSICAL BOUNDS TO FLERCHINGER SOLUTION                                  <a name='2137'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2138'></font>
         IF (KCOUNT == 0) THEN                                                 <a name='2139'>
             PRINT *,'Flerchinger USEd in NEW version. Iterations=',NLOG         <a name='2140'>
                  FK = ( ( (HLICE / (GS * ( - PSIS)))*                    &amp;       <a name='2141'>
                       ( (TKELV - T0)/ TKELV))** ( -1/ BX))* SMCMAX              <a name='2142'>
<font color=#447700>!            FRH2O = MIN (FK, SMC)                                               <a name='2143'></font>
             IF (FK &lt; 0.02) FK = 0.02                                         <a name='2144'>
             FREE = MIN (FK, SMC)                                                <a name='2145'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2146'></font>
<font color=#447700>! END OPTION 2                                                                   <a name='2147'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2148'></font>
         END IF                                                                  <a name='2149'>
      END IF                                                                     <a name='2150'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2151'></font>
  END SUBROUTINE FRH2O                                                           <a name='2152'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2153'></font>
                                                                                 <a name='2154'>
<A NAME='HRT'><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2155'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HRT</font> (RHSTS,STC,SMC,SMCMAX,NSOIL,ZSOIL,YY,ZZ1,          &amp;         <A href='../../call_to/HRT.html' TARGET='index'>2</A>,<A href='../../call_from/HRT.html' TARGET='index'>16</A><a name='2156'>
                       TBOT,ZBOT,PSISAT,SH2O,DT,BEXP,                   &amp;        <a name='2157'>
                       F1,DF1,QUARTZ,CSOIL,AI,BI,CI,VEGTYP)                             <a name='2158'>
                                                                                 <a name='2159'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2160'></font>
<font color=#447700>! SUBROUTINE HRT                                                                 <a name='2161'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2162'></font>
<font color=#447700>! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL            <a name='2163'></font>
<font color=#447700>! THERMAL DIFFUSION EQUATION.  ALSO TO COMPUTE ( PREPARE ) THE MATRIX            <a name='2164'></font>
<font color=#447700>! COEFFICIENTS FOR THE TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.          <a name='2165'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2166'></font>
      IMPLICIT NONE                                                              <a name='2167'>
      LOGICAL              :: ITAVG <a name='2168'>
      INTEGER, INTENT(IN)  :: NSOIL, VEGTYP                              <a name='2169'>
      INTEGER              :: I, K<a name='2170'>
<a name='2171'>
      REAL, INTENT(IN)     :: BEXP, CSOIL, DF1, DT,F1,PSISAT,QUARTZ,     &amp;<a name='2172'>
                              SMCMAX ,TBOT,YY,ZZ1, ZBOT<a name='2173'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: SMC,STC,ZSOIL<a name='2174'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT):: SH2O<a name='2175'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)  :: RHSTS<a name='2176'>
      REAL, DIMENSION(1:NSOLD), INTENT(OUT)  :: AI, BI,CI<a name='2177'>
      REAL                 :: DDZ, DDZ2, DENOM, DF1N, DF1K, DTSDZ,       &amp;<a name='2178'>
                              DTSDZ2,HCPCT,QTOT,SSOIL,SICE,TAVG,TBK,     &amp;<a name='2179'>
                              TBK1,TSNSR,TSURF,CSOIL_LOC<a name='2180'>
      REAL, PARAMETER      :: T0 = 273.15, CAIR = 1004.0, CICE = 2.106E6,&amp;<a name='2181'>
                              CH2O = 4.2E6<a name='2182'>
                                                                                 <a name='2183'>
<a name='2184'>
<font color=#447700>!urban<a name='2185'></font>
        IF(VEGTYP==1) then<a name='2186'>
            CSOIL_LOC=3.0E6<a name='2187'>
        ELSE<a name='2188'>
            CSOIL_LOC=CSOIL<a name='2189'>
        ENDIF<a name='2190'>
<a name='2191'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2192'></font>
<font color=#447700>! INITIALIZE LOGICAL FOR SOIL LAYER TEMPERATURE AVERAGING.                       <a name='2193'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2194'></font>
       ITAVG = .TRUE.                                                            <a name='2195'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2196'></font>
<font color=#447700>! BEGIN SECTION FOR TOP SOIL LAYER                                               <a name='2197'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2198'></font>
<font color=#447700>! CALC THE HEAT CAPACITY OF THE TOP SOIL LAYER                                   <a name='2199'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2200'></font>
      HCPCT = SH2O (1)* CH2O + (1.0- SMCMAX)* CSOIL_LOC + (SMCMAX - SMC (1))&amp;        <a name='2201'>
       * CAIR                                                           &amp;        <a name='2202'>
              + ( SMC (1) - SH2O (1) )* CICE                                     <a name='2203'>
                                                                                 <a name='2204'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2205'></font>
<font color=#447700>! CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER                  <a name='2206'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2207'></font>
      DDZ = 1.0 / ( -0.5 * ZSOIL (2) )                                           <a name='2208'>
      AI (1) = 0.0                                                               <a name='2209'>
      CI (1) = (DF1 * DDZ) / (ZSOIL (1) * HCPCT)                                 <a name='2210'>
                                                                                 <a name='2211'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2212'></font>
<font color=#447700>! CALCULATE THE VERTICAL SOIL TEMP GRADIENT BTWN THE 1ST AND 2ND SOIL            <a name='2213'></font>
<font color=#447700>! LAYERS.  THEN CALCULATE THE SUBSURFACE HEAT FLUX. USE THE TEMP                 <a name='2214'></font>
<font color=#447700>! GRADIENT AND SUBSFC HEAT FLUX TO CALC "RIGHT-HAND SIDE TENDENCY                <a name='2215'></font>
<font color=#447700>! TERMS", OR "RHSTS", FOR TOP SOIL LAYER.                                        <a name='2216'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2217'></font>
      BI (1) = - CI (1) + DF1 / (0.5 * ZSOIL (1) * ZSOIL (1)* HCPCT *    &amp;       <a name='2218'>
       ZZ1)                                                                      <a name='2219'>
      DTSDZ = (STC (1) - STC (2)) / ( -0.5 * ZSOIL (2))                          <a name='2220'>
      SSOIL = DF1 * (STC (1) - YY) / (0.5 * ZSOIL (1) * ZZ1)                     <a name='2221'>
<font color=#447700>!      RHSTS(1) = (DF1 * DTSDZ - SSOIL) / (ZSOIL(1) * HCPCT)                     <a name='2222'></font>
      DENOM = (ZSOIL (1) * HCPCT)                                                <a name='2223'>
                                                                                 <a name='2224'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2225'></font>
<font color=#447700>! NEXT CAPTURE THE VERTICAL DIFFERENCE OF THE HEAT FLUX AT TOP AND               <a name='2226'></font>
<font color=#447700>! BOTTOM OF FIRST SOIL LAYER FOR USE IN HEAT FLUX CONSTRAINT APPLIED TO          <a name='2227'></font>
<font color=#447700>! POTENTIAL SOIL FREEZING/THAWING IN ROUTINE SNKSRC.                             <a name='2228'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2229'></font>
<font color=#447700>!      QTOT = SSOIL - DF1*DTSDZ                                                  <a name='2230'></font>
      RHSTS (1) = (DF1 * DTSDZ - SSOIL) / DENOM                                  <a name='2231'>
                                                                                 <a name='2232'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2233'></font>
<font color=#447700>! CALCULATE FROZEN WATER CONTENT IN 1ST SOIL LAYER.                              <a name='2234'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2235'></font>
      QTOT = -1.0* RHSTS (1)* DENOM                                              <a name='2236'>
                                                                                 <a name='2237'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2238'></font>
<font color=#447700>! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):                      <a name='2239'></font>
<font color=#447700>! SET TEMP "TSURF" AT TOP OF SOIL COLUMN (FOR USE IN FREEZING SOIL               <a name='2240'></font>
<font color=#447700>! PHYSICS LATER IN FUNCTION SUBROUTINE SNKSRC).  IF SNOWPACK CONTENT IS          <a name='2241'></font>
<font color=#447700>! ZERO, THEN TSURF EXPRESSION BELOW GIVES TSURF = SKIN TEMP.  IF                 <a name='2242'></font>
<font color=#447700>! SNOWPACK IS NONZERO (HENCE ARGUMENT ZZ1=1), THEN TSURF EXPRESSION              <a name='2243'></font>
<font color=#447700>! BELOW YIELDS SOIL COLUMN TOP TEMPERATURE UNDER SNOWPACK.  THEN                 <a name='2244'></font>
<font color=#447700>! CALCULATE TEMPERATURE AT BOTTOM INTERFACE OF 1ST SOIL LAYER FOR USE            <a name='2245'></font>
<font color=#447700>! LATER IN FUNCTION SUBROUTINE SNKSRC                                            <a name='2246'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2247'></font>
      SICE = SMC (1) - SH2O (1)                                                  <a name='2248'>
      IF (ITAVG) THEN                                                            <a name='2249'>
         TSURF = (YY + (ZZ1-1) * STC (1)) / ZZ1                                  <a name='2250'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2251'></font>
<font color=#447700>! IF FROZEN WATER PRESENT OR ANY OF LAYER-1 MID-POINT OR BOUNDING                <a name='2252'></font>
<font color=#447700>! INTERFACE TEMPERATURES BELOW FREEZING, THEN CALL SNKSRC TO                     <a name='2253'></font>
<font color=#447700>! COMPUTE HEAT SOURCE/SINK (AND CHANGE IN FROZEN WATER CONTENT)                  <a name='2254'></font>
<font color=#447700>! DUE TO POSSIBLE SOIL WATER PHASE CHANGE                                        <a name='2255'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2256'></font>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_4"> (STC (1),STC (2),ZSOIL,ZBOT,1,NSOIL,TBK)                      <a name='2257'>
         IF ( (SICE &gt; 0.) .OR. (STC (1) &lt; T0) .OR.                         &amp;  <a name='2258'>
            (TSURF &lt; T0) .OR. (TBK &lt; T0) ) THEN                            <a name='2259'>
<font color=#447700>!          TSNSR = SNKSRC (TAVG,SMC(1),SH2O(1),                                  <a name='2260'></font>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TMPAVG'>TMPAVG</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TMPAVG_1"> (TAVG,TSURF,STC (1),TBK,ZSOIL,NSOIL,1)                   <a name='2261'>
            CALL <A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SNKSRC'>SNKSRC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNKSRC_1"> (TSNSR,TAVG,SMC (1),SH2O (1),                      &amp;  <a name='2262'>
                          ZSOIL,NSOIL,SMCMAX,PSISAT,BEXP,DT,1,QTOT)              <a name='2263'>
<font color=#447700>!          RHSTS(1) = RHSTS(1) - TSNSR / ( ZSOIL(1) * HCPCT )                    <a name='2264'></font>
            RHSTS (1) = RHSTS (1) - TSNSR / DENOM                                <a name='2265'>
         END IF                                                                  <a name='2266'>
      ELSE                                                                       <a name='2267'>
<font color=#447700>!          TSNSR = SNKSRC (STC(1),SMC(1),SH2O(1),                                <a name='2268'></font>
         IF ( (SICE &gt; 0.) .OR. (STC (1) &lt; T0) ) THEN                       <a name='2269'>
            CALL <A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SNKSRC'>SNKSRC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNKSRC_2"> (TSNSR,STC (1),SMC (1),SH2O (1),                   &amp;  <a name='2270'>
                          ZSOIL,NSOIL,SMCMAX,PSISAT,BEXP,DT,1,QTOT)              <a name='2271'>
<font color=#447700>!          RHSTS(1) = RHSTS(1) - TSNSR / ( ZSOIL(1) * HCPCT )                    <a name='2272'></font>
            RHSTS (1) = RHSTS (1) - TSNSR / DENOM                                <a name='2273'>
         END IF                                                                  <a name='2274'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2275'></font>
<font color=#447700>! THIS ENDS SECTION FOR TOP SOIL LAYER.                                          <a name='2276'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2277'></font>
      END IF                                                                     <a name='2278'>
<a name='2279'>
<font color=#447700>! INITIALIZE DDZ2                                                                <a name='2280'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2281'></font>
                                                                                 <a name='2282'>
      DDZ2 = 0.0                                                                 <a name='2283'>
      DF1K = DF1                                                                 <a name='2284'>
                                                                                 <a name='2285'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2286'></font>
<font color=#447700>! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABOVE PROCESS               <a name='2287'></font>
<font color=#447700>! (EXCEPT SUBSFC OR "GROUND" HEAT FLUX NOT REPEATED IN LOWER LAYERS)             <a name='2288'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2289'></font>
<font color=#447700>! CALCULATE HEAT CAPACITY FOR THIS SOIL LAYER.                                   <a name='2290'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2291'></font>
      DO K = 2,NSOIL                                                             <a name='2292'>
         HCPCT = SH2O (K)* CH2O + (1.0- SMCMAX)* CSOIL_LOC + (SMCMAX - SMC (  &amp;        <a name='2293'>
                K))* CAIR + ( SMC (K) - SH2O (K) )* CICE                                <a name='2294'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2295'></font>
<font color=#447700>! THIS SECTION FOR LAYER 2 OR GREATER, BUT NOT LAST LAYER.                       <a name='2296'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2297'></font>
<font color=#447700>! CALCULATE THERMAL DIFFUSIVITY FOR THIS LAYER.                                  <a name='2298'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2299'></font>
         IF (K /= NSOIL) THEN                                                  <a name='2300'>
                                                                                 <a name='2301'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2302'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THIS LAYER                           <a name='2303'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2304'></font>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_6"> (DF1N,SMC (K),QUARTZ,SMCMAX,SH2O (K))                    <a name='2305'>
<a name='2306'>
<font color=#447700>!urban<a name='2307'></font>
       IF(VEGTYP==1) DF1N = 3.24<a name='2308'>
<a name='2309'>
            DENOM = 0.5 * ( ZSOIL (K -1) - ZSOIL (K +1) )                        <a name='2310'>
                                                                                 <a name='2311'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2312'></font>
<font color=#447700>! CALC THE MATRIX COEF, CI, AFTER CALC'NG ITS PARTIAL PRODUCT                    <a name='2313'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2314'></font>
            DTSDZ2 = ( STC (K) - STC (K +1) ) / DENOM                            <a name='2315'>
            DDZ2 = 2. / (ZSOIL (K -1) - ZSOIL (K +1))                            <a name='2316'>
                                                                                 <a name='2317'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2318'></font>
<font color=#447700>! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):  CALCULATE           <a name='2319'></font>
<font color=#447700>! TEMP AT BOTTOM OF LAYER.                                                       <a name='2320'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2321'></font>
            CI (K) = - DF1N * DDZ2 / ( (ZSOIL (K -1) - ZSOIL (K)) *      &amp;       <a name='2322'>
       HCPCT)                                                                    <a name='2323'>
            IF (ITAVG) THEN                                                      <a name='2324'>
               CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_5"> (STC (K),STC (K +1),ZSOIL,ZBOT,K,NSOIL,TBK1)            <a name='2325'>
            END IF                                                               <a name='2326'>
<a name='2327'>
         ELSE                                                                    <a name='2328'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2329'></font>
<font color=#447700>! SPECIAL CASE OF BOTTOM SOIL LAYER:  CALCULATE THERMAL DIFFUSIVITY FOR          <a name='2330'></font>
<font color=#447700>! BOTTOM LAYER.                                                                  <a name='2331'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2332'></font>
                                                                                 <a name='2333'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2334'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU BOTTOM LAYER.                        <a name='2335'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2336'></font>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_7"> (DF1N,SMC (K),QUARTZ,SMCMAX,SH2O (K))                    <a name='2337'>
<a name='2338'>
<a name='2339'>
<font color=#447700>!urban<a name='2340'></font>
       IF(VEGTYP==1) DF1N = 3.24<a name='2341'>
<a name='2342'>
            DENOM = .5 * (ZSOIL (K -1) + ZSOIL (K)) - ZBOT                       <a name='2343'>
                                                                                 <a name='2344'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2345'></font>
<font color=#447700>! SET MATRIX COEF, CI TO ZERO IF BOTTOM LAYER.                                   <a name='2346'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2347'></font>
            DTSDZ2 = (STC (K) - TBOT) / DENOM                                    <a name='2348'>
                                                                                 <a name='2349'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2350'></font>
<font color=#447700>! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):  CALCULATE           <a name='2351'></font>
<font color=#447700>! TEMP AT BOTTOM OF LAST LAYER.                                                  <a name='2352'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2353'></font>
            CI (K) = 0.                                                          <a name='2354'>
            IF (ITAVG) THEN                                                      <a name='2355'>
               CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_6"> (STC (K),TBOT,ZSOIL,ZBOT,K,NSOIL,TBK1)                  <a name='2356'>
            END IF                                                               <a name='2357'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2358'></font>
<font color=#447700>! THIS ENDS SPECIAL LOOP FOR BOTTOM LAYER.                                       <a name='2359'></font>
         END IF                                                                  <a name='2360'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2361'></font>
<font color=#447700>! CALCULATE RHSTS FOR THIS LAYER AFTER CALC'NG A PARTIAL PRODUCT.                <a name='2362'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2363'></font>
         DENOM = ( ZSOIL (K) - ZSOIL (K -1) ) * HCPCT                            <a name='2364'>
         RHSTS (K) = ( DF1N * DTSDZ2- DF1K * DTSDZ ) / DENOM                     <a name='2365'>
         QTOT = -1.0* DENOM * RHSTS (K)                                          <a name='2366'>
                                                                                 <a name='2367'>
         SICE = SMC (K) - SH2O (K)                                               <a name='2368'>
         IF (ITAVG) THEN                                                         <a name='2369'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TMPAVG'>TMPAVG</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TMPAVG_2"> (TAVG,TBK,STC (K),TBK1,ZSOIL,NSOIL,K)                    <a name='2370'>
<font color=#447700>!            TSNSR = SNKSRC(TAVG,SMC(K),SH2O(K),ZSOIL,NSOIL,                     <a name='2371'></font>
            IF ( (SICE &gt; 0.) .OR. (STC (K) &lt; T0) .OR.                   &amp;  <a name='2372'>
               (TBK .lt. T0) .OR. (TBK1 .lt. T0) ) THEN                          <a name='2373'>
               CALL <A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SNKSRC'>SNKSRC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNKSRC_3"> (TSNSR,TAVG,SMC (K),SH2O (K),ZSOIL,NSOIL,    &amp;        <a name='2374'>
                             SMCMAX,PSISAT,BEXP,DT,K,QTOT)                       <a name='2375'>
               RHSTS (K) = RHSTS (K) - TSNSR / DENOM                             <a name='2376'>
            END IF                                                               <a name='2377'>
         ELSE                                                                    <a name='2378'>
<font color=#447700>!            TSNSR = SNKSRC(STC(K),SMC(K),SH2O(K),ZSOIL,NSOIL,                   <a name='2379'></font>
            IF ( (SICE &gt; 0.) .OR. (STC (K) &lt; T0) ) THEN                    <a name='2380'>
               CALL <A href='../../html_code/phys/module_sf_lsm_nmm.F.html#SNKSRC'>SNKSRC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNKSRC_4"> (TSNSR,STC (K),SMC (K),SH2O (K),ZSOIL,NSOIL, &amp;        <a name='2381'>
                             SMCMAX,PSISAT,BEXP,DT,K,QTOT)                       <a name='2382'>
               RHSTS (K) = RHSTS (K) - TSNSR / DENOM                             <a name='2383'>
            END IF                                                               <a name='2384'>
         END IF                                                                  <a name='2385'>
<a name='2386'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2387'></font>
<font color=#447700>! CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER.                                  <a name='2388'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2389'></font>
         AI (K) = - DF1 * DDZ / ( (ZSOIL (K -1) - ZSOIL (K)) * HCPCT)            <a name='2390'>
                                                                                 <a name='2391'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2392'></font>
<font color=#447700>! RESET VALUES OF DF1, DTSDZ, DDZ, AND TBK FOR LOOP TO NEXT SOIL LAYER.          <a name='2393'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2394'></font>
         BI (K) = - (AI (K) + CI (K))                                            <a name='2395'>
         TBK = TBK1                                                              <a name='2396'>
         DF1K = DF1N                                                             <a name='2397'>
         DTSDZ = DTSDZ2                                                          <a name='2398'>
         DDZ = DDZ2                                                              <a name='2399'>
      END DO                                                                     <a name='2400'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2401'></font>
  END SUBROUTINE HRT                                                             <a name='2402'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2403'></font>
                                                                                 <a name='2404'>
<A NAME='HRTICE'><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRTICE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2405'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HRTICE</font> (RHSTS,STC,NSOIL,ZSOIL,YY,ZZ1,DF1,AI,BI,CI)               <A href='../../call_to/HRTICE.html' TARGET='index'>2</A><a name='2406'>
                                                                                 <a name='2407'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2408'></font>
<font color=#447700>! SUBROUTINE HRTICE                                                              <a name='2409'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2410'></font>
<font color=#447700>! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL            <a name='2411'></font>
<font color=#447700>! THERMAL DIFFUSION EQUATION IN THE CASE OF SEA-ICE PACK.  ALSO TO               <a name='2412'></font>
<font color=#447700>! COMPUTE (PREPARE) THE MATRIX COEFFICIENTS FOR THE TRI-DIAGONAL MATRIX          <a name='2413'></font>
<font color=#447700>! OF THE IMPLICIT TIME SCHEME.                                                   <a name='2414'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2415'></font>
      IMPLICIT NONE                                                              <a name='2416'>
<a name='2417'>
<a name='2418'>
      INTEGER, INTENT(IN)    :: NSOIL<a name='2419'>
      INTEGER                :: K<a name='2420'>
<a name='2421'>
      REAL,    INTENT(IN)    :: DF1,YY,ZZ1<a name='2422'>
      REAL, DIMENSION(1:NSOLD), INTENT(OUT):: AI, BI,CI<a name='2423'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN) :: STC, ZSOIL<a name='2424'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT):: RHSTS<a name='2425'>
      REAL                   :: DDZ,DDZ2,DENOM,DTSDZ,DTSDZ2,SSOIL,       &amp;<a name='2426'>
                                ZBOT,TBOT<a name='2427'>
      REAL, PARAMETER        :: HCPCT = 1.72396E+6<a name='2428'>
                                                                                 <a name='2429'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2430'></font>
<font color=#447700>! SET A NOMINAL UNIVERSAL VALUE OF THE SEA-ICE SPECIFIC HEAT CAPACITY,           <a name='2431'></font>
<font color=#447700>! HCPCT = 1880.0*917.0.                                                          <a name='2432'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2433'></font>
      DATA TBOT /271.16/                                                         <a name='2434'>
                                                                                 <a name='2435'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2436'></font>
<font color=#447700>! THE INPUT ARGUMENT DF1 IS A UNIVERSALLY CONSTANT VALUE OF SEA-ICE              <a name='2437'></font>
<font color=#447700>! THERMAL DIFFUSIVITY, SET IN ROUTINE SNOPAC AS DF1 = 2.2.                       <a name='2438'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2439'></font>
<font color=#447700>! SET ICE PACK DEPTH.  USE TBOT AS ICE PACK LOWER BOUNDARY TEMPERATURE           <a name='2440'></font>
<font color=#447700>! (THAT OF UNFROZEN SEA WATER AT BOTTOM OF SEA ICE PACK).  ASSUME ICE            <a name='2441'></font>
<font color=#447700>! PACK IS OF N=NSOIL LAYERS SPANNING A UNIFORM CONSTANT ICE PACK                 <a name='2442'></font>
<font color=#447700>! THICKNESS AS DEFINED BY ZSOIL(NSOIL) IN ROUTINE SFLX.                          <a name='2443'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2444'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2445'></font>
<font color=#447700>! CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER                  <a name='2446'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2447'></font>
      ZBOT = ZSOIL (NSOIL)                                                       <a name='2448'>
      DDZ = 1.0 / ( -0.5 * ZSOIL (2) )                                           <a name='2449'>
      AI (1) = 0.0                                                               <a name='2450'>
      CI (1) = (DF1 * DDZ) / (ZSOIL (1) * HCPCT)                                 <a name='2451'>
                                                                                 <a name='2452'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2453'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT BTWN THE TOP AND 2ND SOIL LAYERS.         <a name='2454'></font>
<font color=#447700>! RECALC/ADJUST THE SOIL HEAT FLUX.  USE THE GRADIENT AND FLUX TO CALC           <a name='2455'></font>
<font color=#447700>! RHSTS FOR THE TOP SOIL LAYER.                                                  <a name='2456'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2457'></font>
      BI (1) = - CI (1) + DF1/ (0.5 * ZSOIL (1) * ZSOIL (1) * HCPCT *    &amp;       <a name='2458'>
       ZZ1)                                                                      <a name='2459'>
      DTSDZ = ( STC (1) - STC (2) ) / ( -0.5 * ZSOIL (2) )                       <a name='2460'>
      SSOIL = DF1 * ( STC (1) - YY ) / ( 0.5 * ZSOIL (1) * ZZ1 )                 <a name='2461'>
                                                                                 <a name='2462'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2463'></font>
<font color=#447700>! INITIALIZE DDZ2                                                                <a name='2464'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2465'></font>
      RHSTS (1) = ( DF1 * DTSDZ - SSOIL ) / ( ZSOIL (1) * HCPCT )                <a name='2466'>
                                                                                 <a name='2467'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2468'></font>
<font color=#447700>! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABOVE PROCESS               <a name='2469'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2470'></font>
      DDZ2 = 0.0                                                                 <a name='2471'>
      DO K = 2,NSOIL                                                             <a name='2472'>
                                                                                 <a name='2473'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2474'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THIS LAYER.                          <a name='2475'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2476'></font>
         IF (K /= NSOIL) THEN                                                  <a name='2477'>
            DENOM = 0.5 * ( ZSOIL (K -1) - ZSOIL (K +1) )                        <a name='2478'>
                                                                                 <a name='2479'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2480'></font>
<font color=#447700>! CALC THE MATRIX COEF, CI, AFTER CALC'NG ITS PARTIAL PRODUCT.                   <a name='2481'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2482'></font>
            DTSDZ2 = ( STC (K) - STC (K +1) ) / DENOM                            <a name='2483'>
            DDZ2 = 2. / (ZSOIL (K -1) - ZSOIL (K +1))                            <a name='2484'>
            CI (K) = - DF1 * DDZ2 / ( (ZSOIL (K -1) - ZSOIL (K))*HCPCT)          <a name='2485'>
                                                                                 <a name='2486'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2487'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THE LOWEST LAYER.                    <a name='2488'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2489'></font>
         ELSE                                                                    <a name='2490'>
                                                                                 <a name='2491'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2492'></font>
<font color=#447700>! SET MATRIX COEF, CI TO ZERO.                                                   <a name='2493'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2494'></font>
            DTSDZ2 = (STC (K) - TBOT)/ (.5 * (ZSOIL (K -1) + ZSOIL (K)) &amp;        <a name='2495'>
                     - ZBOT)                                                     <a name='2496'>
            CI (K) = 0.                                                          <a name='2497'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2498'></font>
<font color=#447700>! CALC RHSTS FOR THIS LAYER AFTER CALC'NG A PARTIAL PRODUCT.                     <a name='2499'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2500'></font>
         END IF                                                                  <a name='2501'>
         DENOM = ( ZSOIL (K) - ZSOIL (K -1) ) * HCPCT                            <a name='2502'>
                                                                                 <a name='2503'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2504'></font>
<font color=#447700>! CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER.                                  <a name='2505'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2506'></font>
         RHSTS (K) = ( DF1 * DTSDZ2- DF1 * DTSDZ ) / DENOM                       <a name='2507'>
         AI (K) = - DF1 * DDZ / ( (ZSOIL (K -1) - ZSOIL (K)) * HCPCT)            <a name='2508'>
                                                                                 <a name='2509'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2510'></font>
<font color=#447700>! RESET VALUES OF DTSDZ AND DDZ FOR LOOP TO NEXT SOIL LYR.                       <a name='2511'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2512'></font>
         BI (K) = - (AI (K) + CI (K))                                            <a name='2513'>
         DTSDZ = DTSDZ2                                                          <a name='2514'>
         DDZ = DDZ2                                                              <a name='2515'>
      END DO                                                                     <a name='2516'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2517'></font>
  END SUBROUTINE HRTICE                                                          <a name='2518'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2519'></font>
                                                                                 <a name='2520'>
<A NAME='HSTEP'><A href='../../html_code/phys/module_sf_noahlsm.F.html#HSTEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2521'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HSTEP</font> (STCOUT,STCIN,RHSTS,DT,NSOIL,AI,BI,CI)                     <A href='../../call_to/HSTEP.html' TARGET='index'>4</A>,<A href='../../call_from/HSTEP.html' TARGET='index'>2</A><a name='2522'>
                                                                                 <a name='2523'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2524'></font>
<font color=#447700>! SUBROUTINE HSTEP                                                               <a name='2525'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2526'></font>
<font color=#447700>! CALCULATE/UPDATE THE SOIL TEMPERATURE FIELD.                                   <a name='2527'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2528'></font>
      IMPLICIT NONE                                                              <a name='2529'>
      INTEGER, INTENT(IN)  :: NSOIL<a name='2530'>
      INTEGER              :: K<a name='2531'>
                                                                                 <a name='2532'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN):: STCIN<a name='2533'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT):: STCOUT<a name='2534'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT):: RHSTS<a name='2535'>
      REAL, DIMENSION(1:NSOLD), INTENT(INOUT):: AI,BI,CI<a name='2536'>
      REAL, DIMENSION(1:NSOIL) :: RHSTSin<a name='2537'>
      REAL, DIMENSION(1:NSOLD) :: CIin<a name='2538'>
      REAL                 :: DT<a name='2539'>
                                                                                 <a name='2540'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2541'></font>
<font color=#447700>! CREATE FINITE DIFFERENCE VALUES FOR USE IN ROSR12 ROUTINE                      <a name='2542'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2543'></font>
      DO K = 1,NSOIL                                                             <a name='2544'>
         RHSTS (K) = RHSTS (K) * DT                                              <a name='2545'>
         AI (K) = AI (K) * DT                                                    <a name='2546'>
         BI (K) = 1. + BI (K) * DT                                               <a name='2547'>
         CI (K) = CI (K) * DT                                                    <a name='2548'>
      END DO                                                                     <a name='2549'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2550'></font>
<font color=#447700>! COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12                          <a name='2551'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2552'></font>
      DO K = 1,NSOIL                                                             <a name='2553'>
         RHSTSin (K) = RHSTS (K)                                                 <a name='2554'>
      END DO                                                                     <a name='2555'>
      DO K = 1,NSOLD                                                             <a name='2556'>
         CIin (K) = CI (K)                                                       <a name='2557'>
      END DO                                                                     <a name='2558'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2559'></font>
<font color=#447700>! SOLVE THE TRI-DIAGONAL MATRIX EQUATION                                         <a name='2560'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2561'></font>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#ROSR12'>ROSR12</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#HSTEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_3"> (CI,AI,BI,CIin,RHSTSin,RHSTS,NSOIL)                            <a name='2562'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2563'></font>
<font color=#447700>! CALC/UPDATE THE SOIL TEMPS USING MATRIX SOLUTION                               <a name='2564'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2565'></font>
      DO K = 1,NSOIL                                                             <a name='2566'>
         STCOUT (K) = STCIN (K) + CI (K)                                         <a name='2567'>
      END DO                                                                     <a name='2568'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2569'></font>
  END SUBROUTINE HSTEP                                                           <a name='2570'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2571'></font>
                                                                                 <a name='2572'>
<A NAME='NOPAC'><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2573'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>NOPAC</font> (ETP,ETA,PRCP,SMC,SMCMAX,SMCWLT,                 &amp;         <A href='../../call_to/NOPAC.html' TARGET='index'>2</A>,<A href='../../call_from/NOPAC.html' TARGET='index'>10</A><a name='2574'>
                         SMCREF,SMCDRY,CMC,CMCMAX,NSOIL,DT,SHDFAC,      &amp;<a name='2575'>
                         SBETA,Q2,T1,SFCTMP,T24,TH2,FDOWN,F1,EMISSI,    &amp; <a name='2576'>
                         SSOIL,                                         &amp;                    <a name='2577'>
                         STC,EPSCA,BEXP,PC,RCH,RR,CFACTR,               &amp;        <a name='2578'>
                         SH2O,SLOPE,KDT,FRZFACT,PSISAT,ZSOIL,           &amp;        <a name='2579'>
                         DKSAT,DWSAT,TBOT,ZBOT,RUNOFF1,RUNOFF2,         &amp;        <a name='2580'>
                         RUNOFF3,EDIR,EC,ET,ETT,NROOT,ICE,RTDIS,        &amp;        <a name='2581'>
                         QUARTZ,FXEXP,CSOIL,                            &amp;        <a name='2582'>
                         BETA,DRIP,DEW,FLX1,FLX3,VEGTYP)                          <a name='2583'>
                                                                                 <a name='2584'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2585'></font>
<font color=#447700>! SUBROUTINE NOPAC                                                               <a name='2586'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2587'></font>
<font color=#447700>! CALCULATE SOIL MOISTURE AND HEAT FLUX VALUES AND UPDATE SOIL MOISTURE          <a name='2588'></font>
<font color=#447700>! CONTENT AND SOIL HEAT CONTENT VALUES FOR THE CASE WHEN NO SNOW PACK IS         <a name='2589'></font>
<font color=#447700>! PRESENT.                                                                       <a name='2590'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2591'></font>
      IMPLICIT NONE                                                              <a name='2592'>
<a name='2593'>
      INTEGER, INTENT(IN)  :: ICE, NROOT,NSOIL,VEGTYP                   <a name='2594'>
      INTEGER              :: K<a name='2595'>
<a name='2596'>
      REAL, INTENT(IN)     :: BEXP,CFACTR, CMCMAX,CSOIL,DKSAT,DT,DWSAT, &amp;<a name='2597'>
                              EPSCA,ETP,FDOWN,F1,FXEXP,FRZFACT,KDT,PC,  &amp;<a name='2598'>
                              PRCP,PSISAT,Q2,QUARTZ,RCH,RR,SBETA,SFCTMP,&amp;<a name='2599'>
                              SHDFAC,SLOPE,SMCDRY,SMCMAX,SMCREF,SMCWLT, &amp;<a name='2600'>
                              T24,TBOT,TH2,ZBOT,EMISSI                  <a name='2601'>
      REAL, INTENT(INOUT)  :: CMC,BETA,T1<a name='2602'>
      REAL, INTENT(OUT)    :: DEW,DRIP,EC,EDIR,ETA,ETT,FLX1,FLX3,       &amp;<a name='2603'>
                              RUNOFF1,RUNOFF2,RUNOFF3,SSOIL<a name='2604'>
      REAL, DIMENSION(1:NSOIL),INTENT(IN)     :: RTDIS,ZSOIL<a name='2605'>
      REAL, DIMENSION(1:NSOIL),INTENT(OUT)    :: ET<a name='2606'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: SMC,SH2O,STC<a name='2607'>
      REAL, DIMENSION(1:NSOIL) :: ET1<a name='2608'>
      REAL                 :: EC1,EDIR1,ETT1,DF1,ETA1,ETP1,PRCP1,YY,    &amp;<a name='2609'>
                              YYNUM,ZZ1<a name='2610'>
                                                                                 <a name='2611'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2612'></font>
<font color=#447700>! EXECUTABLE CODE BEGINS HERE:                                                   <a name='2613'></font>
<font color=#447700>! CONVERT ETP Fnd PRCP FROM KG M-2 S-1 TO M S-1 AND INITIALIZE DEW.              <a name='2614'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2615'></font>
      PRCP1 = PRCP * 0.001                                                       <a name='2616'>
      ETP1 = ETP * 0.001                                                         <a name='2617'>
      DEW = 0.0                                                                  <a name='2618'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2619'></font>
<font color=#447700>! INITIALIZE EVAP TERMS.                                                         <a name='2620'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2621'></font>
      EDIR = 0.                                                                  <a name='2622'>
      EDIR1 = 0.                                                                 <a name='2623'>
      EC1 = 0.                                                                   <a name='2624'>
      EC = 0.                                                                    <a name='2625'>
      DO K = 1,NSOIL                                                             <a name='2626'>
        ET(K) = 0.                                                               <a name='2627'>
        ET1(K) = 0.                                                              <a name='2628'>
      END DO                                                                     <a name='2629'>
      ETT = 0.                                                                   <a name='2630'>
      ETT1 = 0.                                                                  <a name='2631'>
                                                                                 <a name='2632'>
      IF (ETP &gt; 0.0) THEN                                                     <a name='2633'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO'>EVAPO</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EVAPO_1"> (ETA1,SMC,NSOIL,CMC,ETP1,DT,ZSOIL,                  &amp;        <a name='2634'>
                      SH2O,                                             &amp;        <a name='2635'>
                      SMCMAX,BEXP,PC,SMCWLT,DKSAT,DWSAT,                &amp;        <a name='2636'>
                      SMCREF,SHDFAC,CMCMAX,                             &amp;        <a name='2637'>
                      SMCDRY,CFACTR,                                    &amp;        <a name='2638'>
                       EDIR1,EC1,ET1,ETT1,SFCTMP,Q2,NROOT,RTDIS,FXEXP)           <a name='2639'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX'>SMFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMFLX_4"> (SMC,NSOIL,CMC,DT,PRCP1,ZSOIL,                      &amp;        <a name='2640'>
                      SH2O,SLOPE,KDT,FRZFACT,                           &amp;        <a name='2641'>
                      SMCMAX,BEXP,SMCWLT,DKSAT,DWSAT,                   &amp;        <a name='2642'>
                      SHDFAC,CMCMAX,                                    &amp;        <a name='2643'>
                      RUNOFF1,RUNOFF2,RUNOFF3,                          &amp;        <a name='2644'>
                      EDIR1,EC1,ET1,                                    &amp;        <a name='2645'>
                      DRIP)                                                      <a name='2646'>
                                                                                 <a name='2647'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2648'></font>
<font color=#447700>! CONVERT MODELED EVAPOTRANSPIRATION FROM  M S-1  TO  KG M-2 S-1.                <a name='2649'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2650'></font>
                                                                                 <a name='2651'>
         ETA = ETA1 * 1000.0                                                     <a name='2652'>
                                                                                 <a name='2653'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2654'></font>
<font color=#447700>! IF ETP &lt; 0, ASSUME DEW FORMS (TRANSFORM ETP1 INTO DEW AND REINITIALIZE         <a name='2655'></font>
<font color=#447700>! ETP1 TO ZERO).                                                                 <a name='2656'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2657'></font>
      ELSE                                                                       <a name='2658'>
         DEW = - ETP1                                                            <a name='2659'>
                                                                                 <a name='2660'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2661'></font>
<font color=#447700>! CONVERT PRCP FROM 'KG M-2 S-1' TO 'M S-1' AND ADD DEW AMOUNT.                  <a name='2662'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2663'></font>
         ETP1 = 0.0                                                              <a name='2664'>
                                                                                 <a name='2665'>
         PRCP1 = PRCP1+ DEW                                                      <a name='2666'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO'>EVAPO</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EVAPO_2"> (ETA1,SMC,NSOIL,CMC,ETP1,DT,ZSOIL,                  &amp;        <a name='2667'>
                      SH2O,                                             &amp;        <a name='2668'>
                      SMCMAX,BEXP,PC,SMCWLT,DKSAT,DWSAT,                &amp;        <a name='2669'>
                      SMCREF,SHDFAC,CMCMAX,                             &amp;        <a name='2670'>
                      SMCDRY,CFACTR,                                    &amp;        <a name='2671'>
                      EDIR1,EC1,ET1,ETT1,SFCTMP,Q2,NROOT,RTDIS,FXEXP)            <a name='2672'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX'>SMFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMFLX_5"> (SMC,NSOIL,CMC,DT,PRCP1,ZSOIL,                      &amp;        <a name='2673'>
                      SH2O,SLOPE,KDT,FRZFACT,                           &amp;        <a name='2674'>
                      SMCMAX,BEXP,SMCWLT,DKSAT,DWSAT,                   &amp;        <a name='2675'>
                      SHDFAC,CMCMAX,                                    &amp;        <a name='2676'>
                      RUNOFF1,RUNOFF2,RUNOFF3,                          &amp;        <a name='2677'>
                      EDIR1,EC1,ET1,                                    &amp;        <a name='2678'>
                      DRIP)                                                      <a name='2679'>
                                                                                 <a name='2680'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2681'></font>
<font color=#447700>! CONVERT MODELED EVAPOTRANSPIRATION FROM 'M S-1' TO 'KG M-2 S-1'.               <a name='2682'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2683'></font>
         ETA = ETA1 * 1000.0                                                     <a name='2684'>
      END IF                                                                     <a name='2685'>
                                                                                 <a name='2686'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2687'></font>
<font color=#447700>! BASED ON ETP AND E VALUES, DETERMINE BETA                                      <a name='2688'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2689'></font>
                                                                                 <a name='2690'>
      IF ( ETP &lt;= 0.0 ) THEN                                                   <a name='2691'>
         BETA = 0.0                                                              <a name='2692'>
         IF ( ETP &lt; 0.0 ) THEN                                                <a name='2693'>
            BETA = 1.0                                                           <a name='2694'>
            ETA = ETP                                                            <a name='2695'>
         END IF                                                                  <a name='2696'>
      ELSE                                                                       <a name='2697'>
         BETA = ETA / ETP                                                        <a name='2698'>
      END IF                                                                     <a name='2699'>
                                                                                 <a name='2700'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2701'></font>
<font color=#447700>! CONVERT MODELED EVAPOTRANSPIRATION COMPONENTS 'M S-1' TO 'KG M-2 S-1'.         <a name='2702'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2703'></font>
      EDIR = EDIR1*1000.                                                         <a name='2704'>
      EC = EC1*1000.                                                             <a name='2705'>
      DO K = 1,NSOIL                                                             <a name='2706'>
        ET(K) = ET1(K)*1000.                                                     <a name='2707'>
      END DO                                                                     <a name='2708'>
      ETT = ETT1*1000.                                                           <a name='2709'>
                                                                                 <a name='2710'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2711'></font>
<font color=#447700>! GET SOIL THERMAL DIFFUXIVITY/CONDUCTIVITY FOR TOP SOIL LYR,                    <a name='2712'></font>
<font color=#447700>! CALC. ADJUSTED TOP LYR SOIL TEMP AND ADJUSTED SOIL FLUX, THEN                  <a name='2713'></font>
<font color=#447700>! CALL SHFLX TO COMPUTE/UPDATE SOIL HEAT FLUX AND SOIL TEMPS.                    <a name='2714'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2715'></font>
                                                                                 <a name='2716'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_8"> (DF1,SMC (1),QUARTZ,SMCMAX,SH2O (1))                           <a name='2717'>
<a name='2718'>
<font color=#447700>!urban<a name='2719'></font>
      IF (VEGTYP==1) DF1=3.24<a name='2720'>
<font color=#447700>!<a name='2721'></font>
                                                                                 <a name='2722'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2723'></font>
<font color=#447700>! VEGETATION GREENNESS FRACTION REDUCTION IN SUBSURFACE HEAT FLUX                <a name='2724'></font>
<font color=#447700>! VIA REDUCTION FACTOR, WHICH IS CONVENIENT TO APPLY HERE TO THERMAL             <a name='2725'></font>
<font color=#447700>! DIFFUSIVITY THAT IS LATER USED IN HRT TO COMPUTE SUB SFC HEAT FLUX             <a name='2726'></font>
<font color=#447700>! (SEE ADDITIONAL COMMENTS ON VEG EFFECT SUB-SFC HEAT FLX IN                     <a name='2727'></font>
<font color=#447700>! ROUTINE SFLX)                                                                  <a name='2728'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2729'></font>
      DF1 = DF1 * EXP (SBETA * SHDFAC)                                           <a name='2730'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2731'></font>
<font color=#447700>! COMPUTE INTERMEDIATE TERMS PASSED TO ROUTINE HRT (VIA ROUTINE                  <a name='2732'></font>
<font color=#447700>! SHFLX BELOW) FOR USE IN COMPUTING SUBSURFACE HEAT FLUX IN HRT                  <a name='2733'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2734'></font>
<font color=#447700>!      YYNUM = FDOWN - SIGMA * T24                                                <a name='2735'></font>
      YYNUM = FDOWN - EMISSI*SIGMA * T1**4<a name='2736'>
      YY = SFCTMP + (YYNUM / RCH + TH2- SFCTMP - BETA * EPSCA) / RR              <a name='2737'>
                                                                                 <a name='2738'>
      ZZ1 = DF1 / ( -0.5 * ZSOIL (1) * RCH * RR ) + 1.0                          <a name='2739'>
<a name='2740'>
<font color=#447700>!urban<a name='2741'></font>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX'>SHFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHFLX_3"> (SSOIL,STC,SMC,SMCMAX,NSOIL,T1,DT,YY,ZZ1,ZSOIL,        &amp;<a name='2742'>
                  TBOT,ZBOT,SMCWLT,PSISAT,SH2O,BEXP,F1,DF1,ICE,         &amp;<a name='2743'>
                  QUARTZ,CSOIL,VEGTYP)                                 <a name='2744'>
                                                                                 <a name='2745'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2746'></font>
<font color=#447700>! SET FLX1 AND FLX3 (SNOPACK PHASE CHANGE HEAT FLUXES) TO ZERO SINCE             <a name='2747'></font>
<font color=#447700>! THEY ARE NOT USED HERE IN SNOPAC.  FLX2 (FREEZING RAIN HEAT FLUX) WAS          <a name='2748'></font>
<font color=#447700>! SIMILARLY INITIALIZED IN THE PENMAN ROUTINE.                                   <a name='2749'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2750'></font>
      FLX1 = 0.0                                                                 <a name='2751'>
      FLX3 = 0.0                                                                 <a name='2752'>
                                                                                 <a name='2753'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2754'></font>
  END SUBROUTINE NOPAC                                                           <a name='2755'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2756'></font>
                                                                                 <a name='2757'>
<A NAME='PENMAN'><A href='../../html_code/phys/module_sf_noahlsm.F.html#PENMAN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2758'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>PENMAN</font> (SFCTMP,SFCPRS,CH,T2V,TH2,PRCP,FDOWN,T24,SSOIL, &amp;         <A href='../../call_to/PENMAN.html' TARGET='index'>2</A><a name='2759'>
     &amp;                   Q2,Q2SAT,ETP,RCH,EPSCA,RR,SNOWNG,FRZGRA,       &amp;        <a name='2760'>
     &amp;                   DQSDT2,FLX2,EMISSI)                                                             <a name='2761'>
                                                                                 <a name='2762'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2763'></font>
<font color=#447700>! SUBROUTINE PENMAN                                                              <a name='2764'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2765'></font>
<font color=#447700>! CALCULATE POTENTIAL EVAPORATION FOR THE CURRENT POINT.  VARIOUS                <a name='2766'></font>
<font color=#447700>! PARTIAL SUMS/PRODUCTS ARE ALSO CALCULATED AND PASSED BACK TO THE               <a name='2767'></font>
<font color=#447700>! CALLING ROUTINE FOR LATER USE.                                                 <a name='2768'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2769'></font>
      IMPLICIT NONE                                                              <a name='2770'>
      LOGICAL, INTENT(IN)     :: SNOWNG, FRZGRA<a name='2771'>
      REAL, INTENT(IN)        :: CH, DQSDT2,FDOWN,PRCP,                 &amp;<a name='2772'>
                                 Q2, Q2SAT,SSOIL, SFCPRS, SFCTMP,       &amp;<a name='2773'>
                                 T2V, TH2,EMISSI                        <a name='2774'>
      REAL, INTENT(OUT)       :: EPSCA,ETP,FLX2,RCH,RR,T24<a name='2775'>
      REAL                    :: A, DELTA, FNET,RAD,RHO<a name='2776'>
<a name='2777'>
      REAL, PARAMETER      :: ELCP = 2.4888E+3, LSUBC = 2.501000E+6,CP = 1004.6<a name='2778'>
                                                                                 <a name='2779'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2780'></font>
<font color=#447700>! EXECUTABLE CODE BEGINS HERE:                                                   <a name='2781'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2782'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2783'></font>
<font color=#447700>! PREPARE PARTIAL QUANTITIES FOR PENMAN EQUATION.                                <a name='2784'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2785'></font>
      FLX2 = 0.0                                                                 <a name='2786'>
      DELTA = ELCP * DQSDT2                                                      <a name='2787'>
      T24 = SFCTMP * SFCTMP * SFCTMP * SFCTMP                                    <a name='2788'>
<font color=#447700>!      RR = T24 * 6.48E-8 / (SFCPRS * CH) + 1.0                                   <a name='2789'></font>
      RR = EMISSI*T24 * 6.48E-8 / (SFCPRS * CH) + 1.0<a name='2790'>
      RHO = SFCPRS / (RD * T2V)                                                   <a name='2791'>
                                                                                 <a name='2792'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2793'></font>
<font color=#447700>! ADJUST THE PARTIAL SUMS / PRODUCTS WITH THE LATENT HEAT                        <a name='2794'></font>
<font color=#447700>! EFFECTS CAUSED BY FALLING PRECIPITATION.                                       <a name='2795'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2796'></font>
      RCH = RHO * CP * CH                                                        <a name='2797'>
      IF (.NOT. SNOWNG) THEN                                                     <a name='2798'>
         IF (PRCP &gt;  0.0) RR = RR + CPH2O * PRCP / RCH                         <a name='2799'>
      ELSE                                                                       <a name='2800'>
         RR = RR + CPICE * PRCP / RCH                                            <a name='2801'>
      END IF                                                                     <a name='2802'>
                                                                                 <a name='2803'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2804'></font>
<font color=#447700>! INCLUDE THE LATENT HEAT EFFECTS OF FRZNG RAIN CONVERTING TO ICE ON             <a name='2805'></font>
<font color=#447700>! IMPACT IN THE CALCULATION OF FLX2 AND FNET.                                    <a name='2806'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2807'></font>
<font color=#447700>!      FNET = FDOWN - SIGMA * T24- SSOIL                                          <a name='2808'></font>
      FNET = FDOWN -  EMISSI*SIGMA * T24- SSOIL<a name='2809'>
      IF (FRZGRA) THEN                                                           <a name='2810'>
         FLX2 = - LSUBF * PRCP                                                   <a name='2811'>
         FNET = FNET - FLX2                                                      <a name='2812'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2813'></font>
<font color=#447700>! FINISH PENMAN EQUATION CALCULATIONS.                                           <a name='2814'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2815'></font>
      END IF                                                                     <a name='2816'>
      RAD = FNET / RCH + TH2- SFCTMP                                             <a name='2817'>
      A = ELCP * (Q2SAT - Q2)                                                    <a name='2818'>
      EPSCA = (A * RR + RAD * DELTA) / (DELTA + RR)                              <a name='2819'>
      ETP = EPSCA * RCH / LSUBC                                                  <a name='2820'>
                                                                                 <a name='2821'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2822'></font>
  END SUBROUTINE PENMAN                                                          <a name='2823'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2824'></font>
                                                                                 <a name='2825'>
<A NAME='REDPRM'><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2826'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>REDPRM</font> (VEGTYP,SOILTYP,SLOPETYP,CFACTR,CMCMAX,RSMAX,      &amp;      <A href='../../call_to/REDPRM.html' TARGET='index'>2</A>,<A href='../../call_from/REDPRM.html' TARGET='index'>11</A><a name='2827'>
                         TOPT,                                             &amp;     <a name='2828'>
                         REFKDT,KDT,SBETA, SHDFAC,RSMIN,RGL,HS,ZBOT,FRZX,  &amp;     <a name='2829'>
                         PSISAT,SLOPE,SNUP,SALP,BEXP,DKSAT,DWSAT,          &amp;     <a name='2830'>
                         SMCMAX,SMCWLT,SMCREF,SMCDRY,F1,QUARTZ,FXEXP,      &amp;     <a name='2831'>
                         RTDIS,SLDPTH,ZSOIL, NROOT,NSOIL,Z0BRD,CZIL,LAI,   &amp;     <a name='2832'>
                         CSOIL,ALBBRD,PTU,LLANDUSE,LSOIL,LOCAL)                <a name='2833'>
                                                                                 <a name='2834'>
      IMPLICIT NONE                                                              <a name='2835'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2836'></font>
<font color=#447700>! Internally set (default valuess)                                               <a name='2837'></font>
<font color=#447700>! all soil and vegetation parameters required for the execusion oF               <a name='2838'></font>
<font color=#447700>! the Noah lsm are defined in VEGPARM.TBL, SOILPARM.TB, and GENPARM.TBL.         <a name='2839'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2840'></font>
<font color=#447700>!     Vegetation parameters:                                                     <a name='2841'></font>
<font color=#447700>!             ALBBRD: SFC background snow-free albedo                            <a name='2842'></font>
<font color=#447700>!             CMXTBL: MAX CNPY Capacity                                          <a name='2843'></font>
<font color=#447700>!              Z0BRD: Background roughness length                                <a name='2844'></font>
<font color=#447700>!             SHDFAC: Green vegetation fraction                                  <a name='2845'></font>
<font color=#447700>!              NROOT: Rooting depth                                              <a name='2846'></font>
<font color=#447700>!              RSMIN: Mimimum stomatal resistance                                <a name='2847'></font>
<font color=#447700>!              RSMAX: Max. stomatal resistance                                   <a name='2848'></font>
<font color=#447700>!                RGL: Parameters used in radiation stress function               <a name='2849'></font>
<font color=#447700>!                 HS: Parameter used in vapor pressure deficit functio           <a name='2850'></font>
<font color=#447700>!               TOPT: Optimum transpiration air temperature.                     <a name='2851'></font>
<font color=#447700>!             CMCMAX: Maximum canopy water capacity                              <a name='2852'></font>
<font color=#447700>!             CFACTR: Parameter used in the canopy inteception calculation       <a name='2853'></font>
<font color=#447700>!               SNUP: Threshold snow depth (in water equivalent m) that          <a name='2854'></font>
<font color=#447700>!                     implies 100 percent snow cover                             <a name='2855'></font>
<font color=#447700>!                LAI: Leaf area index                                            <a name='2856'></font>
<font color=#447700>!                                                                                <a name='2857'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2858'></font>
<font color=#447700>!      Soil parameters:                                                          <a name='2859'></font>
<font color=#447700>!        SMCMAX: MAX soil moisture content (porosity)                            <a name='2860'></font>
<font color=#447700>!        SMCREF: Reference soil moisture  (field capacity)                       <a name='2861'></font>
<font color=#447700>!        SMCWLT: Wilting point soil moisture                                     <a name='2862'></font>
<font color=#447700>!        SMCWLT: Air dry soil moist content limits                               <a name='2863'></font>
<font color=#447700>!       SSATPSI: SAT (saturation) soil potential                                 <a name='2864'></font>
<font color=#447700>!         DKSAT: SAT soil conductivity                                           <a name='2865'></font>
<font color=#447700>!          BEXP: B parameter                                                     <a name='2866'></font>
<font color=#447700>!        SSATDW: SAT soil diffusivity                                            <a name='2867'></font>
<font color=#447700>!           F1: Soil thermal diffusivity/conductivity coef.                      <a name='2868'></font>
<font color=#447700>!        QUARTZ: Soil quartz content                                             <a name='2869'></font>
<font color=#447700>!  Modified by F. Chen (12/22/97)  to use the STATSGO soil map                   <a name='2870'></font>
<font color=#447700>!  Modified By F. Chen (01/22/00)  to include PLaya, Lava, and White San         <a name='2871'></font>
<font color=#447700>!  Modified By F. Chen (08/05/02)  to include additional parameters for the Noah <a name='2872'></font>
<font color=#447700>! NOTE: SATDW = BB*SATDK*(SATPSI/MAXSMC)                                         <a name='2873'></font>
<font color=#447700>!         F11 = ALOG10(SATPSI) + BB*ALOG10(MAXSMC) + 2.0                         <a name='2874'></font>
<font color=#447700>!       REFSMC1=MAXSMC*(5.79E-9/SATDK)**(1/(2*BB+3)) 5.79E-9 m/s= 0.5 mm         <a name='2875'></font>
<font color=#447700>!       REFSMC=REFSMC1+1./3.(MAXSMC-REFSMC1)                                     <a name='2876'></font>
<font color=#447700>!       WLTSMC1=MAXSMC*(200./SATPSI)**(-1./BB)    (Wetzel and Chang, 198         <a name='2877'></font>
<font color=#447700>!       WLTSMC=WLTSMC1-0.5*WLTSMC1                                               <a name='2878'></font>
<font color=#447700>! Note: the values for playa is set for it to have a thermal conductivit         <a name='2879'></font>
<font color=#447700>! as sand and to have a hydrulic conductivity as clay                            <a name='2880'></font>
<font color=#447700>!                                                                                <a name='2881'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2882'></font>
<font color=#447700>! Class parameter 'SLOPETYP' was included to estimate linear reservoir           <a name='2883'></font>
<font color=#447700>! coefficient 'SLOPE' to the baseflow runoff out of the bottom layer.            <a name='2884'></font>
<font color=#447700>! lowest class (slopetyp=0) means highest slope parameter = 1.                   <a name='2885'></font>
<font color=#447700>! definition of slopetyp from 'zobler' slope type:                               <a name='2886'></font>
<font color=#447700>! slope class  percent slope                                                     <a name='2887'></font>
<font color=#447700>! 1            0-8                                                               <a name='2888'></font>
<font color=#447700>! 2            8-30                                                              <a name='2889'></font>
<font color=#447700>! 3            &gt; 30                                                              <a name='2890'></font>
<font color=#447700>! 4            0-30                                                              <a name='2891'></font>
<font color=#447700>! 5            0-8 &amp; &gt; 30                                                        <a name='2892'></font>
<font color=#447700>! 6            8-30 &amp; &gt; 30                                                       <a name='2893'></font>
<font color=#447700>! 7            0-8, 8-30, &gt; 30                                                   <a name='2894'></font>
<font color=#447700>! 9            GLACIAL ICE                                                       <a name='2895'></font>
<font color=#447700>! BLANK        OCEAN/SEA                                                         <a name='2896'></font>
<font color=#447700>!       SLOPE_DATA: linear reservoir coefficient                                 <a name='2897'></font>
<font color=#447700>!       SBETA_DATA: parameter used to caluculate vegetation effect on soil heat  <a name='2898'></font>
<font color=#447700>!       FXEXP_DAT:  soil evaporation exponent used in DEVAP                      <a name='2899'></font>
<font color=#447700>!       CSOIL_DATA: soil heat capacity [J M-3 K-1]                               <a name='2900'></font>
<font color=#447700>!       SALP_DATA: shape parameter of  distribution function of snow cover       <a name='2901'></font>
<font color=#447700>!       REFDK_DATA and REFKDT_DATA: parameters in the surface runoff parameteriz <a name='2902'></font>
<font color=#447700>!       FRZK_DATA: frozen ground parameter                                       <a name='2903'></font>
<font color=#447700>!       ZBOT_DATA: depth[M] of lower boundary soil temperature                   <a name='2904'></font>
<font color=#447700>!       CZIL_DATA: calculate roughness length of heat                            <a name='2905'></font>
<font color=#447700>!       SMLOW_DATA and MHIGH_DATA: two soil moisture wilt, soil moisture referen <a name='2906'></font>
<font color=#447700>!                 parameters                                                     <a name='2907'></font>
<font color=#447700>! Set maximum number of soil-, veg-, and slopetyp in data statement.             <a name='2908'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2909'></font>
      INTEGER, PARAMETER     :: MAX_SLOPETYP=30,MAX_SOILTYP=30,MAX_VEGTYP=30<a name='2910'>
      LOGICAL                :: LOCAL<a name='2911'>
      CHARACTER (LEN=4), INTENT(IN)::  LLANDUSE, LSOIL<a name='2912'>
<a name='2913'>
<font color=#447700>! Veg parameters                                                                 <a name='2914'></font>
      INTEGER, INTENT(IN)    :: VEGTYP<a name='2915'>
      INTEGER, INTENT(OUT)   :: NROOT<a name='2916'>
      REAL, INTENT(OUT)      :: HS,LAI,RSMIN,RGL,SHDFAC,SNUP,Z0BRD,         &amp;<a name='2917'>
                                CMCMAX,RSMAX,TOPT,ALBBRD<a name='2918'>
<font color=#447700>! Soil parameters                                                                <a name='2919'></font>
      INTEGER, INTENT(IN)    :: SOILTYP                                                           <a name='2920'>
      REAL, INTENT(OUT)      :: BEXP,DKSAT,DWSAT,F1,QUARTZ,SMCDRY,          &amp;<a name='2921'>
                                SMCMAX,SMCREF,SMCWLT,PSISAT<a name='2922'>
<font color=#447700>! General parameters                                                             <a name='2923'></font>
      INTEGER, INTENT(IN)    :: SLOPETYP,NSOIL<a name='2924'>
      INTEGER                :: I                                                  <a name='2925'>
      <a name='2926'>
      REAL,    INTENT(OUT)   :: SLOPE,CZIL,SBETA,FXEXP,                     &amp;<a name='2927'>
                                CSOIL,SALP,FRZX,KDT,CFACTR,      &amp;<a name='2928'>
                                ZBOT,REFKDT,PTU<a name='2929'>
      REAL,DIMENSION(1:NSOIL),INTENT(IN) :: SLDPTH,ZSOIL<a name='2930'>
      REAL,DIMENSION(1:NSOIL),INTENT(OUT):: RTDIS                           <a name='2931'>
      REAL                   :: FRZFACT,FRZK,REFDK<a name='2932'>
                                                                                 <a name='2933'>
<font color=#447700>!      SAVE                                                                       <a name='2934'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2935'></font>
<font color=#447700>!                                                                                <a name='2936'></font>
               IF (SOILTYP .gt. SLCATS) THEN                                     <a name='2937'>
                        WRITE (*,*) 'Warning: too many input soil types'         <a name='2938'>
                        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_196"> ( 'Warning: too many input soil types' )<a name='2939'>
               END IF                                                            <a name='2940'>
               IF (VEGTYP .gt. LUCATS) THEN                                      <a name='2941'>
                     WRITE (*,*) 'Warning: too many input landuse types'         <a name='2942'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_197"> ( 'Warning: too many input landuse types' )<a name='2943'>
               END IF                                                            <a name='2944'>
               IF (SLOPETYP .gt. SLPCATS) THEN                                   <a name='2945'>
                     WRITE (*,*) 'Warning: too many input slope types'           <a name='2946'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_198"> ( 'Warning: too many input slope types' )<a name='2947'>
               END IF                                                            <a name='2948'>
                                                                                 <a name='2949'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2950'></font>
<font color=#447700>!  SET-UP SOIL PARAMETERS                                                        <a name='2951'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2952'></font>
      CSOIL = CSOIL_DATA                                                         <a name='2953'>
      BEXP = BB (SOILTYP)                                                        <a name='2954'>
      DKSAT = SATDK (SOILTYP)                                                    <a name='2955'>
      DWSAT = SATDW (SOILTYP)                                                    <a name='2956'>
      F1 = F11 (SOILTYP)                                                         <a name='2957'>
      PSISAT = SATPSI (SOILTYP)                                                  <a name='2958'>
      QUARTZ = QTZ (SOILTYP)                                                     <a name='2959'>
      SMCDRY = DRYSMC (SOILTYP)                                                  <a name='2960'>
      SMCMAX = MAXSMC (SOILTYP)                                                  <a name='2961'>
      SMCREF = REFSMC (SOILTYP)                                                  <a name='2962'>
      SMCWLT = WLTSMC (SOILTYP)                                                  <a name='2963'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2964'></font>
<font color=#447700>! Set-up universal parameters (not dependent on SOILTYP, VEGTYP or               <a name='2965'></font>
<font color=#447700>! SLOPETYP)                                                                      <a name='2966'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2967'></font>
      ZBOT = ZBOT_DATA                                                           <a name='2968'>
      SALP = SALP_DATA                                                           <a name='2969'>
      SBETA = SBETA_DATA                                                         <a name='2970'>
      REFDK = REFDK_DATA                                                         <a name='2971'>
      FRZK = FRZK_DATA                                                           <a name='2972'>
      FXEXP = FXEXP_DATA                                                         <a name='2973'>
      REFKDT = REFKDT_DATA                                                       <a name='2974'>
      PTU = 0.    <font color=#447700>! (not used yet) to satisify intent(out)<a name='2975'></font>
      KDT = REFKDT * DKSAT / REFDK                                               <a name='2976'>
      CZIL = CZIL_DATA                                                           <a name='2977'>
      SLOPE = SLOPE_DATA (SLOPETYP)                                              <a name='2978'>
                                                                                 <a name='2979'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2980'></font>
<font color=#447700>! TO ADJUST FRZK PARAMETER TO ACTUAL SOIL TYPE: FRZK * FRZFACT                   <a name='2981'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2982'></font>
      FRZFACT = (SMCMAX / SMCREF) * (0.412 / 0.468)                              <a name='2983'>
      FRZX = FRZK * FRZFACT                                                      <a name='2984'>
                                                                                 <a name='2985'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2986'></font>
<font color=#447700>! SET-UP VEGETATION PARAMETERS                                                   <a name='2987'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='2988'></font>
      TOPT = TOPT_DATA                                                           <a name='2989'>
      CMCMAX = CMCMAX_DATA                                                       <a name='2990'>
      CFACTR = CFACTR_DATA                                                       <a name='2991'>
      RSMAX = RSMAX_DATA                                                         <a name='2992'>
      NROOT = NROTBL (VEGTYP)                                                    <a name='2993'>
      SNUP = SNUPTBL (VEGTYP)                                                    <a name='2994'>
      RSMIN = RSTBL (VEGTYP)                                                     <a name='2995'>
      RGL = RGLTBL (VEGTYP)                                                      <a name='2996'>
      HS = HSTBL (VEGTYP)                                                        <a name='2997'>
      LAI = LAITBL (VEGTYP)                                                      <a name='2998'>
               IF(LOCAL) THEN                                                  <a name='2999'>
                 ALBBRD = ALBTBL(VEGTYP)                                         <a name='3000'>
                 Z0BRD = Z0TBL(VEGTYP)                                           <a name='3001'>
                 SHDFAC = SHDTBL(VEGTYP)                                         <a name='3002'>
               ENDIF                                                             <a name='3003'>
                                                                                 <a name='3004'>
               IF (VEGTYP .eq. BARE) SHDFAC = 0.0                                <a name='3005'>
               IF (NROOT .gt. NSOIL) THEN                                        <a name='3006'>
                  WRITE (*,*) 'Warning: too many root layers'                    <a name='3007'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_199"> ( 'Warning: too many root layers' )<a name='3008'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3009'></font>
<font color=#447700>! CALCULATE ROOT DISTRIBUTION.  PRESENT VERSION ASSUMES UNIFORM                  <a name='3010'></font>
<font color=#447700>! DISTRIBUTION BASED ON SOIL LAYER DEPTHS.                                       <a name='3011'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3012'></font>
               END IF                                                            <a name='3013'>
               DO I = 1,NROOT                                                    <a name='3014'>
                  RTDIS (I) = - SLDPTH (I)/ ZSOIL (NROOT)                        <a name='3015'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3016'></font>
<font color=#447700>!  SET-UP SLOPE PARAMETER                                                        <a name='3017'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3018'></font>
               END DO                                                            <a name='3019'>
                                                                                 <a name='3020'>
<font color=#447700>!        print*,'end of PRMRED'                                                  <a name='3021'></font>
<font color=#447700>!       print*,'VEGTYP',VEGTYP,'SOILTYP',SOILTYP,'SLOPETYP',SLOPETYP,    &amp;       <a name='3022'></font>
<font color=#447700>!    &amp; 'CFACTR',CFACTR,'CMCMAX',CMCMAX,'RSMAX',RSMAX,'TOPT',TOPT,        &amp;       <a name='3023'></font>
<font color=#447700>!    &amp; 'REFKDT',REFKDT,'KDT',KDT,'SBETA',SBETA, 'SHDFAC',SHDFAC,         &amp;       <a name='3024'></font>
<font color=#447700>!    &amp;  'RSMIN',RSMIN,'RGL',RGL,'HS',HS,'ZBOT',ZBOT,'FRZX',FRZX,         &amp;       <a name='3025'></font>
<font color=#447700>!    &amp;  'PSISAT',PSISAT,'SLOPE',SLOPE,'SNUP',SNUP,'SALP',SALP,'BEXP',    &amp;       <a name='3026'></font>
<font color=#447700>!    &amp;   BEXP,                                                           &amp;       <a name='3027'></font>
<font color=#447700>!    &amp;  'DKSAT',DKSAT,'DWSAT',DWSAT,                                     &amp;       <a name='3028'></font>
<font color=#447700>!    &amp;  'SMCMAX',SMCMAX,'SMCWLT',SMCWLT,'SMCREF',SMCREF,'SMCDRY',SMCDRY, &amp;       <a name='3029'></font>
<font color=#447700>!    &amp;  'F1',F1,'QUARTZ',QUARTZ,'FXEXP',FXEXP,                           &amp;       <a name='3030'></font>
<font color=#447700>!    &amp;  'RTDIS',RTDIS,'SLDPTH',SLDPTH,'ZSOIL',ZSOIL, 'NROOT',NROOT,      &amp;       <a name='3031'></font>
<font color=#447700>!    &amp;  'NSOIL',NSOIL,'Z0',Z0,'CZIL',CZIL,'LAI',LAI,                     &amp;       <a name='3032'></font>
<font color=#447700>!    &amp;  'CSOIL',CSOIL,'PTU',PTU,                                         &amp;       <a name='3033'></font>
<font color=#447700>!    &amp;  'LOCAL', LOCAL                                                       <a name='3034'></font>
                                                                                 <a name='3035'>
      END  SUBROUTINE REDPRM<a name='3036'>
                                                                                 <a name='3037'>
<A NAME='ROSR12'><A href='../../html_code/phys/module_sf_noahlsm.F.html#ROSR12' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3038'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>ROSR12</font> (P,A,B,C,D,DELTA,NSOIL)                                   <A href='../../call_to/ROSR12.html' TARGET='index'>4</A><a name='3039'>
                                                                                 <a name='3040'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3041'></font>
<font color=#447700>! SUBROUTINE ROSR12                                                              <a name='3042'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3043'></font>
<font color=#447700>! INVERT (SOLVE) THE TRI-DIAGONAL MATRIX PROBLEM SHOWN BELOW:                    <a name='3044'></font>
<font color=#447700>! ###                                            ### ###  ###   ###  ###         <a name='3045'></font>
<font color=#447700>! #B(1), C(1),  0  ,  0  ,  0  ,   . . .  ,    0   # #      #   #      #         <a name='3046'></font>
<font color=#447700>! #A(2), B(2), C(2),  0  ,  0  ,   . . .  ,    0   # #      #   #      #         <a name='3047'></font>
<font color=#447700>! # 0  , A(3), B(3), C(3),  0  ,   . . .  ,    0   # #      #   # D(3) #         <a name='3048'></font>
<font color=#447700>! # 0  ,  0  , A(4), B(4), C(4),   . . .  ,    0   # # P(4) #   # D(4) #         <a name='3049'></font>
<font color=#447700>! # 0  ,  0  ,  0  , A(5), B(5),   . . .  ,    0   # # P(5) #   # D(5) #         <a name='3050'></font>
<font color=#447700>! # .                                          .   # #  .   # = #   .  #         <a name='3051'></font>
<font color=#447700>! # .                                          .   # #  .   #   #   .  #         <a name='3052'></font>
<font color=#447700>! # .                                          .   # #  .   #   #   .  #         <a name='3053'></font>
<font color=#447700>! # 0  , . . . , 0 , A(M-2), B(M-2), C(M-2),   0   # #P(M-2)#   #D(M-2)#         <a name='3054'></font>
<font color=#447700>! # 0  , . . . , 0 ,   0   , A(M-1), B(M-1), C(M-1)# #P(M-1)#   #D(M-1)#         <a name='3055'></font>
<font color=#447700>! # 0  , . . . , 0 ,   0   ,   0   ,  A(M) ,  B(M) # # P(M) #   # D(M) #         <a name='3056'></font>
<font color=#447700>! ###                                            ### ###  ###   ###  ###         <a name='3057'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3058'></font>
      IMPLICIT NONE                                                              <a name='3059'>
<a name='3060'>
      INTEGER, INTENT(IN)   :: NSOIL<a name='3061'>
      INTEGER               :: K, KK<a name='3062'>
<a name='3063'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN):: A, B, D <a name='3064'>
      REAL, DIMENSION(1:NSOIL),INTENT(INOUT):: C,P,DELTA<a name='3065'>
                                                                                 <a name='3066'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3067'></font>
<font color=#447700>! INITIALIZE EQN COEF C FOR THE LOWEST SOIL LAYER                                <a name='3068'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3069'></font>
      C (NSOIL) = 0.0                                                            <a name='3070'>
      P (1) = - C (1) / B (1)                                                    <a name='3071'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3072'></font>
<font color=#447700>! SOLVE THE COEFS FOR THE 1ST SOIL LAYER                                         <a name='3073'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3074'></font>
                                                                                 <a name='3075'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3076'></font>
<font color=#447700>! SOLVE THE COEFS FOR SOIL LAYERS 2 THRU NSOIL                                   <a name='3077'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3078'></font>
      DELTA (1) = D (1) / B (1)                                                  <a name='3079'>
      DO K = 2,NSOIL                                                             <a name='3080'>
         P (K) = - C (K) * ( 1.0 / (B (K) + A (K) * P (K -1)) )                  <a name='3081'>
         DELTA (K) = (D (K) - A (K)* DELTA (K -1))* (1.0/ (B (K) + A (K)&amp;        <a name='3082'>
                    * P (K -1)))                                                 <a name='3083'>
      END DO                                                                     <a name='3084'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3085'></font>
<font color=#447700>! SET P TO DELTA FOR LOWEST SOIL LAYER                                           <a name='3086'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3087'></font>
      P (NSOIL) = DELTA (NSOIL)                                                  <a name='3088'>
                                                                                 <a name='3089'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3090'></font>
<font color=#447700>! ADJUST P FOR SOIL LAYERS 2 THRU NSOIL                                          <a name='3091'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3092'></font>
      DO K = 2,NSOIL                                                             <a name='3093'>
         KK = NSOIL - K + 1                                                      <a name='3094'>
         P (KK) = P (KK) * P (KK +1) + DELTA (KK)                                <a name='3095'>
      END DO                                                                     <a name='3096'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3097'></font>
  END SUBROUTINE ROSR12                                                          <a name='3098'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3099'></font>
<a name='3100'>
                                                                                 <a name='3101'>
<A NAME='SHFLX'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3102'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SHFLX</font> (SSOIL,STC,SMC,SMCMAX,NSOIL,T1,DT,YY,ZZ1,ZSOIL,  &amp;         <A href='../../call_to/SHFLX.html' TARGET='index'>4</A>,<A href='../../call_from/SHFLX.html' TARGET='index'>8</A><a name='3103'>
                         TBOT,ZBOT,SMCWLT,PSISAT,SH2O,BEXP,F1,DF1,ICE,  &amp;        <a name='3104'>
                         QUARTZ,CSOIL,VEGTYP)                                           <a name='3105'>
                                                                                 <a name='3106'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3107'></font>
<font color=#447700>! SUBROUTINE SHFLX                                                               <a name='3108'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3109'></font>
<font color=#447700>! UPDATE THE TEMPERATURE STATE OF THE SOIL COLUMN BASED ON THE THERMAL           <a name='3110'></font>
<font color=#447700>! DIFFUSION EQUATION AND UPDATE THE FROZEN SOIL MOISTURE CONTENT BASED           <a name='3111'></font>
<font color=#447700>! ON THE TEMPERATURE.                                                            <a name='3112'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3113'></font>
      IMPLICIT NONE                                                              <a name='3114'>
<a name='3115'>
      INTEGER, INTENT(IN)   :: ICE, NSOIL, VEGTYP                      <a name='3116'>
      INTEGER               :: I<a name='3117'>
<a name='3118'>
      REAL, INTENT(IN)      :: BEXP,CSOIL,DF1,DT,F1,PSISAT,QUARTZ,     &amp; <a name='3119'>
                               SMCMAX, SMCWLT, TBOT,YY, ZBOT,ZZ1<a name='3120'>
      REAL, INTENT(INOUT)   :: T1 <a name='3121'>
      REAL, INTENT(OUT)     :: SSOIL<a name='3122'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)    :: SMC,ZSOIL <a name='3123'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: SH2O <a name='3124'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: STC <a name='3125'>
      REAL, DIMENSION(1:NSOLD)             :: AI, BI, CI, STCF,RHSTS<a name='3126'>
      REAL, PARAMETER       :: T0 = 273.15<a name='3127'>
                                                                                 <a name='3128'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3129'></font>
<font color=#447700>! HRT ROUTINE CALCS THE RIGHT HAND SIDE OF THE SOIL TEMP DIF EQN                 <a name='3130'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3131'></font>
                                                                                 <a name='3132'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3133'></font>
<font color=#447700>! SEA-ICE CASE                                                                   <a name='3134'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3135'></font>
      IF (ICE == 1) THEN                                                       <a name='3136'>
                                                                                 <a name='3137'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#HRTICE'>HRTICE</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HRTICE_2"> (RHSTS,STC,NSOIL,ZSOIL,YY,ZZ1,DF1,AI,BI,CI)                 <a name='3138'>
                                                                                 <a name='3139'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#HSTEP'>HSTEP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HSTEP_3"> (STCF,STC,RHSTS,DT,NSOIL,AI,BI,CI)                           <a name='3140'>
                                                                                 <a name='3141'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3142'></font>
<font color=#447700>! LAND-MASS CASE                                                                 <a name='3143'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3144'></font>
      ELSE                                                                       <a name='3145'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT'>HRT</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HRT_2"> (RHSTS,STC,SMC,SMCMAX,NSOIL,ZSOIL,YY,ZZ1,TBOT,        &amp;        <a name='3146'>
                    ZBOT,PSISAT,SH2O,DT,                                &amp;        <a name='3147'>
                    BEXP,F1,DF1,QUARTZ,CSOIL,AI,BI,CI,VEGTYP)                           <a name='3148'>
                                                                                 <a name='3149'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#HSTEP'>HSTEP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HSTEP_4"> (STCF,STC,RHSTS,DT,NSOIL,AI,BI,CI)                           <a name='3150'>
      END IF                                                                     <a name='3151'>
      DO I = 1,NSOIL                                                             <a name='3152'>
         STC (I) = STCF (I)                                                      <a name='3153'>
      END DO                                                                     <a name='3154'>
<a name='3155'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3156'></font>
<font color=#447700>! IN THE NO SNOWPACK CASE (VIA ROUTINE NOPAC BRANCH,) UPDATE THE GRND            <a name='3157'></font>
<font color=#447700>! (SKIN) TEMPERATURE HERE IN RESPONSE TO THE UPDATED SOIL TEMPERATURE            <a name='3158'></font>
<font color=#447700>! PROFILE ABOVE.  (NOTE: INSPECTION OF ROUTINE SNOPAC SHOWS THAT T1              <a name='3159'></font>
<font color=#447700>! BELOW IS A DUMMY VARIABLE ONLY, AS SKIN TEMPERATURE IS UPDATED                 <a name='3160'></font>
<font color=#447700>! DIFFERENTLY IN ROUTINE SNOPAC)                                                 <a name='3161'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3162'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3163'></font>
<font color=#447700>! CALCULATE SURFACE SOIL HEAT FLUX                                               <a name='3164'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3165'></font>
      T1 = (YY + (ZZ1- 1.0) * STC (1)) / ZZ1                                     <a name='3166'>
      SSOIL = DF1 * (STC (1) - T1) / (0.5 * ZSOIL (1))                           <a name='3167'>
<a name='3168'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3169'></font>
  END SUBROUTINE SHFLX                                                           <a name='3170'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3171'></font>
                                                                                 <a name='3172'>
<A NAME='SMFLX'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3173'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SMFLX</font> (SMC,NSOIL,CMC,DT,PRCP1,ZSOIL,                   &amp;         <A href='../../call_to/SMFLX.html' TARGET='index'>6</A>,<A href='../../call_from/SMFLX.html' TARGET='index'>13</A><a name='3174'>
     &amp;                   SH2O,SLOPE,KDT,FRZFACT,                        &amp;        <a name='3175'>
     &amp;                   SMCMAX,BEXP,SMCWLT,DKSAT,DWSAT,                &amp;        <a name='3176'>
     &amp;                   SHDFAC,CMCMAX,                                 &amp;        <a name='3177'>
     &amp;                   RUNOFF1,RUNOFF2,RUNOFF3,                       &amp;        <a name='3178'>
     &amp;                   EDIR,EC,ET,                                    &amp;        <a name='3179'>
     &amp;                   DRIP)                                                   <a name='3180'>
                                                                                 <a name='3181'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3182'></font>
<font color=#447700>! SUBROUTINE SMFLX                                                               <a name='3183'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3184'></font>
<font color=#447700>! CALCULATE SOIL MOISTURE FLUX.  THE SOIL MOISTURE CONTENT (SMC - A PER          <a name='3185'></font>
<font color=#447700>! UNIT VOLUME MEASUREMENT) IS A DEPENDENT VARIABLE THAT IS UPDATED WITH          <a name='3186'></font>
<font color=#447700>! PROGNOSTIC EQNS. THE CANOPY MOISTURE CONTENT (CMC) IS ALSO UPDATED.            <a name='3187'></font>
<font color=#447700>! FROZEN GROUND VERSION:  NEW STATES ADDED: SH2O, AND FROZEN GROUND              <a name='3188'></font>
<font color=#447700>! CORRECTION FACTOR, FRZFACT AND PARAMETER SLOPE.                                <a name='3189'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3190'></font>
      IMPLICIT NONE                                                              <a name='3191'>
 <a name='3192'>
      INTEGER, INTENT(IN)   :: NSOIL<a name='3193'>
      INTEGER               :: I,K <a name='3194'>
     <a name='3195'>
      REAL, INTENT(IN)      :: BEXP, CMCMAX, DKSAT,DWSAT, DT, EC, EDIR,  &amp;<a name='3196'>
                               KDT, PRCP1, SHDFAC, SLOPE, SMCMAX, SMCWLT  <a name='3197'>
      REAL, INTENT(OUT)                      :: DRIP, RUNOFF1, RUNOFF2, RUNOFF3<a name='3198'>
      REAL, INTENT(INOUT)   :: CMC<a name='3199'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: ET,ZSOIL<a name='3200'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT):: SMC, SH2O<a name='3201'>
      REAL, DIMENSION(1:NSOLD)             :: AI, BI, CI, STCF,RHSTS, RHSTT, &amp;<a name='3202'>
                                              SICE, SH2OA, SH2OFG<a name='3203'>
      REAL                  :: DUMMY, EXCESS,FRZFACT,PCPDRP,RHSCT,TRHSCT<a name='3204'>
                                                                                 <a name='3205'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3206'></font>
<font color=#447700>! EXECUTABLE CODE BEGINS HERE.                                                   <a name='3207'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3208'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3209'></font>
<font color=#447700>! COMPUTE THE RIGHT HAND SIDE OF THE CANOPY EQN TERM ( RHSCT )                   <a name='3210'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3211'></font>
      DUMMY = 0.                                                                 <a name='3212'>
                                                                                 <a name='3213'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3214'></font>
<font color=#447700>! CONVERT RHSCT (A RATE) TO TRHSCT (AN AMOUNT) AND ADD IT TO EXISTING            <a name='3215'></font>
<font color=#447700>! CMC.  IF RESULTING AMT EXCEEDS MAX CAPACITY, IT BECOMES DRIP AND WILL          <a name='3216'></font>
<font color=#447700>! FALL TO THE GRND.                                                              <a name='3217'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3218'></font>
      RHSCT = SHDFAC * PRCP1- EC                                                 <a name='3219'>
      DRIP = 0.                                                                  <a name='3220'>
      TRHSCT = DT * RHSCT                                                        <a name='3221'>
      EXCESS = CMC + TRHSCT                                                      <a name='3222'>
                                                                                 <a name='3223'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3224'></font>
<font color=#447700>! PCPDRP IS THE COMBINED PRCP1 AND DRIP (FROM CMC) THAT GOES INTO THE            <a name='3225'></font>
<font color=#447700>! SOIL                                                                           <a name='3226'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3227'></font>
      IF (EXCESS &gt; CMCMAX) DRIP = EXCESS - CMCMAX                             <a name='3228'>
      PCPDRP = (1. - SHDFAC) * PRCP1+ DRIP / DT                                  <a name='3229'>
                                                                                 <a name='3230'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3231'></font>
<font color=#447700>! STORE ICE CONTENT AT EACH SOIL LAYER BEFORE CALLING SRT and SSTEP                <a name='3232'></font>
<font color=#447700>!<a name='3233'></font>
      DO I = 1,NSOIL                                                             <a name='3234'>
         SICE (I) = SMC (I) - SH2O (I)                                           <a name='3235'>
      END DO                                                                     <a name='3236'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3237'></font>
<font color=#447700>! CALL SUBROUTINES SRT AND SSTEP TO SOLVE THE SOIL MOISTURE                      <a name='3238'></font>
<font color=#447700>! TENDENCY EQUATIONS.                                                            <a name='3239'></font>
<font color=#447700>! IF THE INFILTRATING PRECIP RATE IS NONTRIVIAL,                                 <a name='3240'></font>
<font color=#447700>!   (WE CONSIDER NONTRIVIAL TO BE A PRECIP TOTAL OVER THE TIME STEP              <a name='3241'></font>
<font color=#447700>!    EXCEEDING ONE ONE-THOUSANDTH OF THE WATER HOLDING CAPACITY OF               <a name='3242'></font>
<font color=#447700>!    THE FIRST SOIL LAYER)                                                       <a name='3243'></font>
<font color=#447700>! THEN CALL THE SRT/SSTEP SUBROUTINE PAIR TWICE IN THE MANNER OF                 <a name='3244'></font>
<font color=#447700>!   TIME SCHEME "F" (IMPLICIT STATE, AVERAGED COEFFICIENT)                       <a name='3245'></font>
<font color=#447700>!   OF SECTION 2 OF KALNAY AND KANAMITSU (1988, MWR, VOL 116,                    <a name='3246'></font>
<font color=#447700>!   PAGES 1945-1958)TO MINIMIZE 2-DELTA-T OSCILLATIONS IN THE                    <a name='3247'></font>
<font color=#447700>!   SOIL MOISTURE VALUE OF THE TOP SOIL LAYER THAT CAN ARISE BECAUSE             <a name='3248'></font>
<font color=#447700>!   OF THE EXTREME NONLINEAR DEPENDENCE OF THE SOIL HYDRAULIC                    <a name='3249'></font>
<font color=#447700>!   DIFFUSIVITY COEFFICIENT AND THE HYDRAULIC CONDUCTIVITY ON THE                <a name='3250'></font>
<font color=#447700>!   SOIL MOISTURE STATE                                                          <a name='3251'></font>
<font color=#447700>! OTHERWISE CALL THE SRT/SSTEP SUBROUTINE PAIR ONCE IN THE MANNER OF             <a name='3252'></font>
<font color=#447700>!   TIME SCHEME "D" (IMPLICIT STATE, EXPLICIT COEFFICIENT)                       <a name='3253'></font>
<font color=#447700>!   OF SECTION 2 OF KALNAY AND KANAMITSU                                         <a name='3254'></font>
<font color=#447700>! PCPDRP IS UNITS OF KG/M**2/S OR MM/S, ZSOIL IS NEGATIVE DEPTH IN M             <a name='3255'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3256'></font>
<font color=#447700>!      IF ( PCPDRP .GT. 0.0 ) THEN                                               <a name='3257'></font>
                                                                                 <a name='3258'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3259'></font>
<font color=#447700>! FROZEN GROUND VERSION:                                                         <a name='3260'></font>
<font color=#447700>! SMC STATES REPLACED BY SH2O STATES IN SRT SUBR.  SH2O &amp; SICE STATES            <a name='3261'></font>
<font color=#447700>! INC&amp;UDED IN SSTEP SUBR.  FROZEN GROUND CORRECTION FACTOR, FRZFACT              <a name='3262'></font>
<font color=#447700>! ADDED.  ALL WATER BALANCE CALCULATIONS USING UNFROZEN WATER                    <a name='3263'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3264'></font>
      IF ( (PCPDRP * DT) &gt; (0.001*1000.0* (- ZSOIL (1))* SMCMAX) ) THEN<a name='3265'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT'>SRT</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SRT_4"> (RHSTT,EDIR,ET,SH2O,SH2O,NSOIL,PCPDRP,ZSOIL,          &amp;        <a name='3266'>
                    DWSAT,DKSAT,SMCMAX,BEXP,RUNOFF1,                    &amp;        <a name='3267'>
                    RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZFACT,SICE,AI,BI,CI)           <a name='3268'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SSTEP'>SSTEP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSTEP_4"> (SH2OFG,SH2O,DUMMY,RHSTT,RHSCT,DT,NSOIL,SMCMAX,     &amp;        <a name='3269'>
                        CMCMAX,RUNOFF3,ZSOIL,SMC,SICE,AI,BI,CI)                  <a name='3270'>
         DO K = 1,NSOIL                                                          <a name='3271'>
            SH2OA (K) = (SH2O (K) + SH2OFG (K)) * 0.5                            <a name='3272'>
         END DO                                                                  <a name='3273'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT'>SRT</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SRT_5"> (RHSTT,EDIR,ET,SH2O,SH2OA,NSOIL,PCPDRP,ZSOIL,         &amp;        <a name='3274'>
                    DWSAT,DKSAT,SMCMAX,BEXP,RUNOFF1,                    &amp;        <a name='3275'>
                    RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZFACT,SICE,AI,BI,CI)           <a name='3276'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SSTEP'>SSTEP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSTEP_5"> (SH2O,SH2O,CMC,RHSTT,RHSCT,DT,NSOIL,SMCMAX,         &amp;        <a name='3277'>
                        CMCMAX,RUNOFF3,ZSOIL,SMC,SICE,AI,BI,CI)                  <a name='3278'>
                                                                                 <a name='3279'>
      ELSE                                                                       <a name='3280'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT'>SRT</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SRT_6"> (RHSTT,EDIR,ET,SH2O,SH2O,NSOIL,PCPDRP,ZSOIL,          &amp;        <a name='3281'>
                    DWSAT,DKSAT,SMCMAX,BEXP,RUNOFF1,                    &amp;        <a name='3282'>
                      RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZFACT,SICE,AI,BI,CI)         <a name='3283'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SSTEP'>SSTEP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSTEP_6"> (SH2O,SH2O,CMC,RHSTT,RHSCT,DT,NSOIL,SMCMAX,         &amp;        <a name='3284'>
                        CMCMAX,RUNOFF3,ZSOIL,SMC,SICE,AI,BI,CI)                  <a name='3285'>
<font color=#447700>!      RUNOF = RUNOFF                                                            <a name='3286'></font>
                                                                                 <a name='3287'>
      END IF                                                                     <a name='3288'>
<a name='3289'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3290'></font>
  END SUBROUTINE SMFLX                                                           <a name='3291'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3292'></font>
                                                                                 <a name='3293'>
                                                                                 <a name='3294'>
<A NAME='SNFRAC'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNFRAC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3295'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNFRAC</font> (SNEQV,SNUP,SALP,SNOWH,SNCOVR)                            <A href='../../call_to/SNFRAC.html' TARGET='index'>1</A><a name='3296'>
                                                                                 <a name='3297'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3298'></font>
<font color=#447700>! SUBROUTINE SNFRAC                                                              <a name='3299'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3300'></font>
<font color=#447700>! CALCULATE SNOW FRACTION (0 -&gt; 1)                                               <a name='3301'></font>
<font color=#447700>! SNEQV   SNOW WATER EQUIVALENT (M)                                              <a name='3302'></font>
<font color=#447700>! SNUP    THRESHOLD SNEQV DEPTH ABOVE WHICH SNCOVR=1                             <a name='3303'></font>
<font color=#447700>! SALP    TUNING PARAMETER                                                       <a name='3304'></font>
<font color=#447700>! SNCOVR  FRACTIONAL SNOW COVER                                                  <a name='3305'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3306'></font>
      IMPLICIT NONE                                                              <a name='3307'>
<a name='3308'>
      REAL, INTENT(IN)     :: SNEQV,SNUP,SALP,SNOWH<a name='3309'>
      REAL, INTENT(OUT)    :: SNCOVR<a name='3310'>
      REAL                 :: RSNOW, Z0N<a name='3311'>
                                                                                 <a name='3312'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3313'></font>
<font color=#447700>! SNUP IS VEG-CLASS DEPENDENT SNOWDEPTH THRESHHOLD (SET IN ROUTINE               <a name='3314'></font>
<font color=#447700>! REDPRM) ABOVE WHICH SNOCVR=1.                                                  <a name='3315'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3316'></font>
      IF (SNEQV &lt; SNUP) THEN                                                  <a name='3317'>
         RSNOW = SNEQV / SNUP                                                    <a name='3318'>
         SNCOVR = 1. - ( EXP ( - SALP * RSNOW) - RSNOW * EXP ( - SALP))          <a name='3319'>
      ELSE                                                                       <a name='3320'>
         SNCOVR = 1.0                                                            <a name='3321'>
      END IF                                                                     <a name='3322'>
<a name='3323'>
<font color=#447700>!     FORMULATION OF DICKINSON ET AL. 1986                                       <a name='3324'></font>
<font color=#447700>!     Z0N = 0.035                                                                <a name='3325'></font>
                                                                                 <a name='3326'>
<font color=#447700>!        SNCOVR=SNOWH/(SNOWH + 5*Z0N)                                            <a name='3327'></font>
                                                                                 <a name='3328'>
<font color=#447700>!     FORMULATION OF MARSHALL ET AL. 1994                                        <a name='3329'></font>
<font color=#447700>!        SNCOVR=SNEQV/(SNEQV + 2*Z0N)                                            <a name='3330'></font>
                                                                                 <a name='3331'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3332'></font>
  END SUBROUTINE SNFRAC                                                          <a name='3333'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3334'></font>
                                                                                 <a name='3335'>
<A NAME='SNKSRC'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNKSRC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3336'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNKSRC</font> (TSNSR,TAVG,SMC,SH2O,ZSOIL,NSOIL,               &amp;         <A href='../../call_to/SNKSRC.html' TARGET='index'>4</A>,<A href='../../call_from/SNKSRC.html' TARGET='index'>2</A><a name='3337'>
     &amp;                      SMCMAX,PSISAT,BEXP,DT,K,QTOT)                        <a name='3338'>
                                                                                 <a name='3339'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3340'></font>
<font color=#447700>! SUBROUTINE SNKSRC                                                              <a name='3341'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3342'></font>
<font color=#447700>! CALCULATE SINK/SOURCE TERM OF THE TERMAL DIFFUSION EQUATION. (SH2O) IS         <a name='3343'></font>
<font color=#447700>! AVAILABLE LIQUED WATER.                                                        <a name='3344'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3345'></font>
      IMPLICIT NONE                                                              <a name='3346'>
<a name='3347'>
      INTEGER, INTENT(IN)   :: K,NSOIL<a name='3348'>
                                                                                <a name='3349'>
      REAL, INTENT(IN)      :: BEXP, DT, PSISAT, QTOT, SMC, SMCMAX,    &amp;<a name='3350'>
                               TAVG<a name='3351'>
      REAL, INTENT(INOUT)   :: SH2O<a name='3352'>
<a name='3353'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN):: ZSOIL<a name='3354'>
<a name='3355'>
      REAL                  :: DF, DZ, DZH, FREE, TSNSR,               &amp;<a name='3356'>
                               TDN, TM, TUP, TZ, X0, XDN, XH2O, XUP <a name='3357'>
                                                                                 <a name='3358'>
      REAL, PARAMETER       :: DH2O = 1.0000E3, HLICE = 3.3350E5,      &amp;<a name='3359'>
                               T0 = 2.7315E2<a name='3360'>
<a name='3361'>
      IF (K == 1) THEN                                                         <a name='3362'>
         DZ = - ZSOIL (1)                                                        <a name='3363'>
      ELSE                                                                       <a name='3364'>
         DZ = ZSOIL (K -1) - ZSOIL (K)                                           <a name='3365'>
      END IF                                                                     <a name='3366'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3367'></font>
<font color=#447700>! VIA FUNCTION FRH2O, COMPUTE POTENTIAL OR 'EQUILIBRIUM' UNFROZEN                <a name='3368'></font>
<font color=#447700>! SUPERCOOLED FREE WATER FOR GIVEN SOIL TYPE AND SOIL LAYER TEMPERATURE.         <a name='3369'></font>
<font color=#447700>! FUNCTION FRH20 INVOKES EQN (17) FROM V. KOREN ET AL (1999, JGR, VOL.           <a name='3370'></font>
<font color=#447700>! 104, PG 19573).  (ASIDE:  LATTER EQN IN JOURNAL IN CENTIGRADE UNITS.           <a name='3371'></font>
<font color=#447700>! ROUTINE FRH2O USE FORM OF EQN IN KELVIN UNITS.)                                <a name='3372'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3373'></font>
<font color=#447700>!      FREE = FRH2O(TAVG,SMC,SH2O,SMCMAX,BEXP,PSISAT)                            <a name='3374'></font>
                                                                                 <a name='3375'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3376'></font>
<font color=#447700>! IN NEXT BLOCK OF CODE, INVOKE EQN 18 OF V. KOREN ET AL (1999, JGR,             <a name='3377'></font>
<font color=#447700>! VOL. 104, PG 19573.)  THAT IS, FIRST ESTIMATE THE NEW AMOUNTOF LIQUID          <a name='3378'></font>
<font color=#447700>! WATER, 'XH2O', IMPLIED BY THE SUM OF (1) THE LIQUID WATER AT THE BEGIN         <a name='3379'></font>
<font color=#447700>! OF CURRENT TIME STEP, AND (2) THE FREEZE OF THAW CHANGE IN LIQUID              <a name='3380'></font>
<font color=#447700>! WATER IMPLIED BY THE HEAT FLUX 'QTOT' PASSED IN FROM ROUTINE HRT.              <a name='3381'></font>
<font color=#447700>! SECOND, DETERMINE IF XH2O NEEDS TO BE BOUNDED BY 'FREE' (EQUIL AMT) OR         <a name='3382'></font>
<font color=#447700>! IF 'FREE' NEEDS TO BE BOUNDED BY XH2O.                                         <a name='3383'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3384'></font>
      CALL <A href='../../html_code/phys/module_sf_lsm_nmm.F.html#FRH2O'>FRH2O</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNKSRC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FRH2O_3"> (FREE,TAVG,SMC,SH2O,SMCMAX,BEXP,PSISAT)                         <a name='3385'>
                                                                                 <a name='3386'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3387'></font>
<font color=#447700>! FIRST, IF FREEZING AND REMAINING LIQUID LESS THAN LOWER BOUND, THEN            <a name='3388'></font>
<font color=#447700>! REDUCE EXTENT OF FREEZING, THEREBY LETTING SOME OR ALL OF HEAT FLUX            <a name='3389'></font>
<font color=#447700>! QTOT COOL THE SOIL TEMP LATER IN ROUTINE HRT.                                  <a name='3390'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3391'></font>
      XH2O = SH2O + QTOT * DT / (DH2O * HLICE * DZ)                              <a name='3392'>
      IF ( XH2O &lt; SH2O .AND. XH2O &lt; FREE) THEN                             <a name='3393'>
         IF ( FREE &gt; SH2O ) THEN                                              <a name='3394'>
            XH2O = SH2O                                                          <a name='3395'>
         ELSE                                                                    <a name='3396'>
            XH2O = FREE                                                          <a name='3397'>
         END IF                                                                  <a name='3398'>
      END IF                                                                     <a name='3399'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3400'></font>
<font color=#447700>! SECOND, IF THAWING AND THE INCREASE IN LIQUID WATER GREATER THAN UPPER         <a name='3401'></font>
<font color=#447700>! BOUND, THEN REDUCE EXTENT OF THAW, THEREBY LETTING SOME OR ALL OF HEAT         <a name='3402'></font>
<font color=#447700>! FLUX QTOT WARM THE SOIL TEMP LATER IN ROUTINE HRT.                             <a name='3403'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3404'></font>
      IF ( XH2O &gt; SH2O .AND. XH2O &gt; FREE ) THEN                            <a name='3405'>
         IF ( FREE &lt; SH2O ) THEN                                              <a name='3406'>
            XH2O = SH2O                                                          <a name='3407'>
         ELSE                                                                    <a name='3408'>
            XH2O = FREE                                                          <a name='3409'>
         END IF                                                                  <a name='3410'>
      END IF                                                                     <a name='3411'>
                                                                                 <a name='3412'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3413'></font>
<font color=#447700>! CALCULATE PHASE-CHANGE HEAT SOURCE/SINK TERM FOR USE IN ROUTINE HRT            <a name='3414'></font>
<font color=#447700>! AND UPDATE LIQUID WATER TO REFLCET FINAL FREEZE/THAW INCREMENT.                <a name='3415'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3416'></font>
<font color=#447700>!      SNKSRC = -DH2O*HLICE*DZ*(XH2O-SH2O)/DT                                    <a name='3417'></font>
      IF (XH2O &lt; 0.) XH2O = 0.                                                <a name='3418'>
      IF (XH2O &gt; SMC) XH2O = SMC                                              <a name='3419'>
      TSNSR = - DH2O * HLICE * DZ * (XH2O - SH2O)/ DT                            <a name='3420'>
      SH2O = XH2O                                                                <a name='3421'>
                                                                                 <a name='3422'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3423'></font>
  END SUBROUTINE SNKSRC                                                          <a name='3424'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3425'></font>
                                                                                 <a name='3426'>
<A NAME='SNOPAC'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOPAC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3427'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOPAC</font> (ETP,ETA,PRCP,PRCPF,SNOWNG,SMC,SMCMAX,SMCWLT,   &amp;         <A href='../../call_to/SNOPAC.html' TARGET='index'>2</A>,<A href='../../call_from/SNOPAC.html' TARGET='index'>7</A><a name='3428'>
                          SMCREF,SMCDRY,CMC,CMCMAX,NSOIL,DT,            &amp;        <a name='3429'>
                          SBETA,DF1,                                    &amp;        <a name='3430'>
                          Q2,T1,SFCTMP,T24,TH2,FDOWN,F1,SSOIL,STC,EPSCA,&amp;        <a name='3431'>
                         SFCPRS,BEXP,PC,RCH,RR,CFACTR,SNCOVR,ESD,SNDENS,&amp;        <a name='3432'>
                          SNOWH,SH2O,SLOPE,KDT,FRZFACT,PSISAT,          &amp;        <a name='3433'>
                          ZSOIL,DWSAT,DKSAT,TBOT,ZBOT,SHDFAC,RUNOFF1,   &amp;        <a name='3434'>
                          RUNOFF2,RUNOFF3,EDIR,EC,ET,ETT,NROOT,SNOMLT,  &amp;        <a name='3435'>
                          ICE,RTDIS,QUARTZ,FXEXP,CSOIL,                 &amp;        <a name='3436'>
                          BETA,DRIP,DEW,FLX1,FLX2,FLX3,ESNOW,ETNS,EMISSI,&amp;             <a name='3437'>
                          VEGTYP)                                       <a name='3438'>
                                                                                 <a name='3439'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3440'></font>
<font color=#447700>! SUBROUTINE SNOPAC                                                              <a name='3441'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3442'></font>
<font color=#447700>! CALCULATE SOIL MOISTURE AND HEAT FLUX VALUES &amp; UPDATE SOIL MOISTURE            <a name='3443'></font>
<font color=#447700>! CONTENT AND SOIL HEAT CONTENT VALUES FOR THE CASE WHEN A SNOW PACK IS          <a name='3444'></font>
<font color=#447700>! PRESENT.                                                                       <a name='3445'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3446'></font>
      IMPLICIT NONE                                                              <a name='3447'>
<a name='3448'>
      INTEGER, INTENT(IN)   :: ICE, NROOT, NSOIL,VEGTYP                 <a name='3449'>
      INTEGER               :: K<a name='3450'>
      LOGICAL, INTENT(IN)   :: SNOWNG<a name='3451'>
      REAL, INTENT(IN)      :: BEXP,CFACTR, CMCMAX,CSOIL,DF1,DKSAT,     &amp;<a name='3452'>
                               DT,DWSAT, EPSCA,ETP,FDOWN,F1,FXEXP,      &amp;<a name='3453'>
                               FRZFACT,KDT,PC, PRCP,PSISAT,Q2,QUARTZ,   &amp;<a name='3454'>
                               RCH,RR,SBETA,SFCPRS, SFCTMP, SHDFAC,     &amp;<a name='3455'>
                               SLOPE,SMCDRY,SMCMAX,SMCREF,SMCWLT, T24,  &amp;<a name='3456'>
                               TBOT,TH2,ZBOT,EMISSI                      <a name='3457'>
      REAL, INTENT(INOUT)   :: CMC, BETA, ESD,FLX2,PRCPF,SNOWH,SNCOVR,  &amp;<a name='3458'>
                               SNDENS, T1  <a name='3459'>
      REAL, INTENT(OUT)     :: DEW,DRIP,EC,EDIR, ETNS, ESNOW,ETT,       &amp;<a name='3460'>
                               FLX1,FLX3, RUNOFF1,RUNOFF2,RUNOFF3,      &amp;<a name='3461'>
                               SSOIL,SNOMLT<a name='3462'>
      REAL, DIMENSION(1:NSOIL),INTENT(IN)     :: RTDIS,ZSOIL<a name='3463'>
      REAL, DIMENSION(1:NSOIL),INTENT(OUT)    :: ET<a name='3464'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: SMC,SH2O,STC<a name='3465'>
      REAL, DIMENSION(1:NSOIL) :: ET1<a name='3466'>
      REAL                  :: DENOM,DSOIL,DTOT,EC1,EDIR1,ESDFLX,ETA,   &amp;<a name='3467'>
                               ETT1, ESNOW1, ESNOW2, ETA1,ETP1,ETP2,    &amp;<a name='3468'>
                               ETP3, ETNS1, ETANRG, ETAX, EX, FLX3X,    &amp;<a name='3469'>
                               FRCSNO,FRCSOI, PRCP1, QSAT,RSNOW, SEH,   &amp;<a name='3470'>
                               SNCOND,SSOIL1, T11,T12, T12A, T12AX,     &amp;<a name='3471'>
                               T12B, T14, YY, ZZ1, EMISSI_S<a name='3472'>
                                                                                <a name='3473'>
      REAL, PARAMETER       :: ESDMIN = 1.E-6, LSUBC = 2.501000E+6,     &amp;<a name='3474'>
                               LSUBS = 2.83E+6, TFREEZ = 273.15,        &amp;<a name='3475'>
                               SNOEXP = 1.0 <a name='3476'>
                                                                                 <a name='3477'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3478'></font>
<font color=#447700>! EXECUTABLE CODE BEGINS HERE:                                                   <a name='3479'></font>
<font color=#447700>! INITIALIZE EVAP TERMS.                                                         <a name='3480'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3481'></font>
<font color=#447700>! conversions:                                                                   <a name='3482'></font>
<font color=#447700>! ESNOW [KG M-2 S-1]                                                             <a name='3483'></font>
<font color=#447700>! ESDFLX [KG M-2 S-1] .le. ESNOW                                                 <a name='3484'></font>
<font color=#447700>! ESNOW1 [M S-1]                                                                 <a name='3485'></font>
<font color=#447700>! ESNOW2 [M]                                                                     <a name='3486'></font>
<font color=#447700>! ETP [KG M-2 S-1]                                                               <a name='3487'></font>
<font color=#447700>! ETP1 [M S-1]                                                                   <a name='3488'></font>
<font color=#447700>! ETP2 [M]                                                                       <a name='3489'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3490'></font>
      EDIR = 0.                                                                  <a name='3491'>
      EDIR1 = 0.                                                                 <a name='3492'>
      EC1 = 0.                                                                   <a name='3493'>
      EC = 0.                                                                    <a name='3494'>
      EMISSI_S=0.9     <font color=#447700>! For snow<a name='3495'></font>
      DO K = 1,NSOIL                                                             <a name='3496'>
         ET (K) = 0.                                                             <a name='3497'>
         ET1 (K) = 0.                                                            <a name='3498'>
      END DO                                                                     <a name='3499'>
      ETT = 0.                                                                   <a name='3500'>
      ETT1 = 0.                                                                  <a name='3501'>
      ETNS = 0.                                                                  <a name='3502'>
      ETNS1 = 0.                                                                 <a name='3503'>
      ESNOW = 0.                                                                 <a name='3504'>
      ESNOW1 = 0.                                                                <a name='3505'>
      ESNOW2 = 0.                                                                <a name='3506'>
                                                                                 <a name='3507'>
<font color=#447700>! CONVERT POTENTIAL EVAP (ETP) FROM KG M-2 S-1 TO M S-1 AND THEN TO AN           <a name='3508'></font>
<font color=#447700>! AMOUNT (M) GIVEN TIMESTEP (DT) AND CALL IT AN EFFECTIVE SNOWPACK               <a name='3509'></font>
<font color=#447700>! REDUCTION AMOUNT, ETP2 (M).  THIS IS THE AMOUNT THE SNOWPACK WOULD BE          <a name='3510'></font>
<font color=#447700>! REDUCED DUE TO EVAPORATION FROM THE SNOW SFC DURING THE TIMESTEP.              <a name='3511'></font>
<font color=#447700>! EVAPORATION WILL PROCEED AT THE POTENTIAL RATE UNLESS THE SNOW DEPTH           <a name='3512'></font>
<font color=#447700>! IS LESS THAN THE EXPECTED SNOWPACK REDUCTION.                                  <a name='3513'></font>
<font color=#447700>! IF SEAICE (ICE=1), BETA REMAINS=1.                                             <a name='3514'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3515'></font>
<font color=#447700>!      PRCP1 = PRCP1*0.001                                                       <a name='3516'></font>
<font color=#447700>! change name of PRCP1 to PRCPF                                                  <a name='3517'></font>
      DEW = 0.                                                                   <a name='3518'>
                                                                                 <a name='3519'>
      PRCP1 = PRCPF *0.001                                                       <a name='3520'>
      ETP1 = ETP * 0.001                                                         <a name='3521'>
      ESNOW = ETP * SNCOVR                                                       <a name='3522'>
<font color=#447700>!      write(*,*) 'ESNOW,ESDFLX=',ESNOW,ESDFLX                                   <a name='3523'></font>
<font color=#447700>!     ESDFLX = ESD *1000./ DT                                                    <a name='3524'></font>
<font color=#447700>!     IF (ESDFLX .lt. ESNOW) THEN                                                <a name='3525'></font>
<font color=#447700>!ek        ESD = 0.                                                              <a name='3526'></font>
<font color=#447700>!        ESNOW = ESDFLX                                                          <a name='3527'></font>
<font color=#447700>!        ESD = 0.                                                                <a name='3528'></font>
<font color=#447700>!     ELSE                                                                       <a name='3529'></font>
         ESNOW1 = ESNOW * 0.001                                                  <a name='3530'>
<font color=#447700>!ek        ESD = ESD - ESNOW2                                                    <a name='3531'></font>
         ESNOW2 = ESNOW1 * DT                                                    <a name='3532'>
<font color=#447700>!        ESD = ESD- ESNOW2                                                       <a name='3533'></font>
<font color=#447700>!     END IF                                                                     <a name='3534'></font>
<font color=#447700>!     ETP2 = ETP * 0.001 * DT                                                    <a name='3535'></font>
<font color=#447700>!      IF (ICE .NE. 1) THEN                                                      <a name='3536'></font>
<font color=#447700>!        IF (ESD .LT. ETP2) THEN                                                 <a name='3537'></font>
<font color=#447700>!          BETA = ESD / ETP2                                                     <a name='3538'></font>
<font color=#447700>!        ENDIF                                                                   <a name='3539'></font>
<font color=#447700>!      ENDIF                                                                     <a name='3540'></font>
                                                                                 <a name='3541'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3542'></font>
<font color=#447700>! IF ETP&lt;0 (DOWNWARD) THEN DEWFALL (=FROSTFALL IN THIS CASE).                    <a name='3543'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3544'></font>
      BETA = 1.0                                                                 <a name='3545'>
      IF (ETP &lt;= 0.0) THEN                                                     <a name='3546'>
        IF(ETP == 0.) BETA = 0.0                                                 <a name='3547'>
         DEW = - ETP * 0.001                                                     <a name='3548'>
<font color=#447700>!        ETP1 = 0.0                                                              <a name='3549'></font>
      ELSE                                                                       <a name='3550'>
         IF (ICE /=  1) THEN                                                    <a name='3551'>
<font color=#447700>!            write(*,*) 'ETP1=',ETP1                                             <a name='3552'></font>
             IF (SNCOVR &lt;  1.) THEN                                            <a name='3553'>
               CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO'>EVAPO</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EVAPO_3"> (ETA1,SMC,NSOIL,CMC,ETP1,DT,ZSOIL,            &amp;        <a name='3554'>
                            SH2O,                                       &amp;        <a name='3555'>
                            SMCMAX,BEXP,PC,SMCWLT,DKSAT,DWSAT,          &amp;        <a name='3556'>
                            SMCREF,SHDFAC,CMCMAX,                       &amp;        <a name='3557'>
                            SMCDRY,CFACTR,                              &amp;        <a name='3558'>
                            EDIR1,EC1,ET1,ETT1,SFCTMP,Q2,NROOT,RTDIS,   &amp;        <a name='3559'>
                            FXEXP)                                               <a name='3560'>
               EDIR1 = EDIR1* (1. - SNCOVR)                                      <a name='3561'>
               EC1 = EC1* (1. - SNCOVR)                                          <a name='3562'>
               DO K = 1,NSOIL                                                    <a name='3563'>
                  ET1 (K) = ET1 (K)* (1. - SNCOVR)                               <a name='3564'>
               END DO                                                            <a name='3565'>
               ETT1 = ETT1*(1.-SNCOVR)                                           <a name='3566'>
               ETNS1 = EDIR1+ EC1+ ETT1                                          <a name='3567'>
               EDIR = EDIR1*1000.                                                <a name='3568'>
               EC = EC1*1000.                                                    <a name='3569'>
               DO K = 1,NSOIL                                                    <a name='3570'>
                  ET (K) = ET1 (K)*1000.                                         <a name='3571'>
               END DO                                                            <a name='3572'>
               ETT = ETT1*1000.                                                  <a name='3573'>
               ETNS = ETNS1*1000.                                                <a name='3574'>
<font color=#447700>!            write(*,*) EDIR*2.5E+9,                                             <a name='3575'></font>
<font color=#447700>!     &amp;                 EC*2.5E+9,                                               <a name='3576'></font>
<font color=#447700>!     &amp;                 ET(1)*2.5E+9,                                            <a name='3577'></font>
<font color=#447700>!     &amp;                 ET(2)*2.5E+9,                                            <a name='3578'></font>
<font color=#447700>!     &amp;                 ET(3)*2.5E+9,                                            <a name='3579'></font>
<font color=#447700>!     &amp;                 ET(4)*2.5E+9,                                            <a name='3580'></font>
<font color=#447700>!     &amp;                 ETT*2.5E+9                                               <a name='3581'></font>
<font color=#447700>!            write(*,*) 'SNCOVR=',SNCOVR                                         <a name='3582'></font>
               ETNS = ETNS1*1000.                                                <a name='3583'>
<font color=#447700>!            write(*,*) 'ESNOW[W/M2],ETNS[W/M2]=',                               <a name='3584'></font>
<font color=#447700>!     &amp;                  ESNOW*LSUBS,ETNS*LSUBC                                  <a name='3585'></font>
<font color=#447700>!            write(*,*) 'ETP[W/M2],ETANRG=',                                     <a name='3586'></font>
<font color=#447700>!     &amp;                  ETP*LSUBS,ETANRG                                        <a name='3587'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3588'></font>
                                                                                 <a name='3589'>
<font color=#447700>!   end IF (SNCOVR .lt. 1.)                                                      <a name='3590'></font>
            END IF                                                               <a name='3591'>
                                                                                 <a name='3592'>
<font color=#447700>!   end IF (ICE .ne. 1)                                                          <a name='3593'></font>
         END IF                                                                  <a name='3594'>
                                                                                 <a name='3595'>
<font color=#447700>!   end IF (ETP .le. 0.0)                                                        <a name='3596'></font>
      END IF                                                                     <a name='3597'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3598'></font>
<font color=#447700>! COMPUTE TOTAL EVAPORATION, SNOW AND NON-SNOW                                   <a name='3599'></font>
<font color=#447700>! also compute energy units (ETANRG) needed later below                          <a name='3600'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3601'></font>
                                                                                 <a name='3602'>
<font color=#447700>!      write(*,*)'ESNOW*LSUBS,ETNS*LSUBC,ETANRG=',                               <a name='3603'></font>
<font color=#447700>!     &amp;           ESNOW*LSUBS,ETNS*LSUBC,ETANRG                                  <a name='3604'></font>
      ETANRG = ESNOW * LSUBS + ETNS * LSUBC                                      <a name='3605'>
                                                                                 <a name='3606'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3607'></font>
<font color=#447700>! IF PRECIP IS FALLING, CALCULATE HEAT FLUX FROM SNOW SFC TO NEWLY               <a name='3608'></font>
<font color=#447700>! ACCUMULATING PRECIP.  NOTE THAT THIS REFLECTS THE FLUX APPROPRIATE FOR         <a name='3609'></font>
<font color=#447700>! THE NOT-YET-UPDATED SKIN TEMPERATURE (T1).  ASSUMES TEMPERATURE OF THE         <a name='3610'></font>
<font color=#447700>! SNOWFALL STRIKING THE GROUND IS =SFCTMP (LOWEST MODEL LEVEL AIR TEMP).         <a name='3611'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3612'></font>
      FLX1 = 0.0                                                                 <a name='3613'>
      IF (SNOWNG) THEN                                                           <a name='3614'>
         FLX1 = CPICE * PRCP * (T1- SFCTMP)                                      <a name='3615'>
      ELSE                                                                       <a name='3616'>
         IF (PRCP &gt;  0.0) FLX1 = CPH2O * PRCP * (T1- SFCTMP)                   <a name='3617'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3618'></font>
<font color=#447700>! CALCULATE AN 'EFFECTIVE SNOW-GRND SFC TEMP' (T12) BASED ON HEAT FLUXES         <a name='3619'></font>
<font color=#447700>! BETWEEN THE SNOW PACK AND THE SOIL AND ON NET RADIATION.                       <a name='3620'></font>
<font color=#447700>! INCLUDE FLX1 (PRECIP-SNOW SFC) AND FLX2 (FREEZING RAIN LATENT HEAT)            <a name='3621'></font>
<font color=#447700>! FLUXES.  FLX1 FROM ABOVE, FLX2 BROUGHT IN VIA COMMOM BLOCK RITE.               <a name='3622'></font>
<font color=#447700>! FLX2 REFLECTS FREEZING RAIN LATENT HEAT FLUX USING T1 CALCULATED IN            <a name='3623'></font>
<font color=#447700>! PENMAN.                                                                        <a name='3624'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3625'></font>
      END IF                                                                     <a name='3626'>
      DSOIL = - (0.5 * ZSOIL (1))                                                <a name='3627'>
      DTOT = SNOWH + DSOIL                                                       <a name='3628'>
<font color=#447700>!ek      T12A = ( (FDOWN-FLX1-FLX2-SIGMA*T24)/RCH                                <a name='3629'></font>
<font color=#447700>!ek     &amp;       + TH2 - SFCTMP - BETA*EPSCA ) / RR                               <a name='3630'></font>
<font color=#447700>!ek      T12AX = ( (FDOWN-FLX1-FLX2-SIGMA*T24)/RCH                               <a name='3631'></font>
<font color=#447700>!ek     &amp;       + TH2 - SFCTMP - ETANRG/RCH ) / RR                               <a name='3632'></font>
      DENOM = 1.0+ DF1 / (DTOT * RR * RCH)                                       <a name='3633'>
<font color=#447700>!      write(*,*) 'T12A,T12AX=',T12A,T12AX                                       <a name='3634'></font>
<font color=#447700>!Place for emiss, snow emiss=0.90<a name='3635'></font>
<font color=#447700>!      T12A = ( (FDOWN - FLX1- FLX2- SIGMA * T24)/ RCH                   &amp;        <a name='3636'></font>
      T12A = ( (FDOWN - FLX1- FLX2- EMISSI_S*SIGMA * T1**4)/ RCH            &amp;<a name='3637'>
     &amp;       + TH2- SFCTMP - ETANRG / RCH ) / RR                                 <a name='3638'>
      T12B = DF1 * STC (1) / (DTOT * RR * RCH)                                   <a name='3639'>
                                                                                 <a name='3640'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3641'></font>
<font color=#447700>! IF THE 'EFFECTIVE SNOW-GRND SFC TEMP' IS AT OR BELOW FREEZING, NO SNOW         <a name='3642'></font>
<font color=#447700>! MELT WILL OCCUR.  SET THE SKIN TEMP TO THIS EFFECTIVE TEMP.  REDUCE            <a name='3643'></font>
<font color=#447700>! (BY SUBLIMINATION ) OR INCREASE (BY FROST) THE DEPTH OF THE SNOWPACK,          <a name='3644'></font>
<font color=#447700>! DEPENDING ON SIGN OF ETP.                                                      <a name='3645'></font>
<font color=#447700>! UPDATE SOIL HEAT FLUX (SSOIL) USING NEW SKIN TEMPERATURE (T1)                  <a name='3646'></font>
<font color=#447700>! SINCE NO SNOWMELT, SET ACCUMULATED SNOWMELT TO ZERO, SET 'EFFECTIVE'           <a name='3647'></font>
<font color=#447700>! PRECIP FROM SNOWMELT TO ZERO, SET PHASE-CHANGE HEAT FLUX FROM SNOWMELT         <a name='3648'></font>
<font color=#447700>! TO ZERO.                                                                       <a name='3649'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3650'></font>
<font color=#447700>! SUB-FREEZING BLOCK                                                             <a name='3651'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3652'></font>
      T12 = (SFCTMP + T12A + T12B) / DENOM                                       <a name='3653'>
      IF (T12 &lt;=  TFREEZ) THEN                                                  <a name='3654'>
         T1 = T12                                                                <a name='3655'>
         SSOIL = DF1 * (T1- STC (1)) / DTOT                                      <a name='3656'>
<font color=#447700>!        ESD = MAX (0.0, ESD- ETP2)                                              <a name='3657'></font>
         ESD = MAX(0.0, ESD-ESNOW2)                                              <a name='3658'>
         FLX3 = 0.0                                                              <a name='3659'>
         EX = 0.0                                                                <a name='3660'>
                                                                                 <a name='3661'>
         SNOMLT = 0.0                                                            <a name='3662'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3663'></font>
<font color=#447700>! IF THE 'EFFECTIVE SNOW-GRND SFC TEMP' IS ABOVE FREEZING, SNOW MELT             <a name='3664'></font>
<font color=#447700>! WILL OCCUR.  CALL THE SNOW MELT RATE,EX AND AMT, SNOMLT.  REVISE THE           <a name='3665'></font>
<font color=#447700>! EFFECTIVE SNOW DEPTH.  REVISE THE SKIN TEMP BECAUSE IT WOULD HAVE CHGD         <a name='3666'></font>
<font color=#447700>! DUE TO THE LATENT HEAT RELEASED BY THE MELTING. CALC THE LATENT HEAT           <a name='3667'></font>
<font color=#447700>! RELEASED, FLX3. SET THE EFFECTIVE PRECIP, PRCP1 TO THE SNOW MELT RATE,         <a name='3668'></font>
<font color=#447700>! EX FOR USE IN SMFLX.  ADJUSTMENT TO T1 TO ACCOUNT FOR SNOW PATCHES.            <a name='3669'></font>
<font color=#447700>! CALCULATE QSAT VALID AT FREEZING POINT.  NOTE THAT ESAT (SATURATION            <a name='3670'></font>
<font color=#447700>! VAPOR PRESSURE) VALUE OF 6.11E+2 USED HERE IS THAT VALID AT FRZZING            <a name='3671'></font>
<font color=#447700>! POINT.  NOTE THAT ETP FROM CALL PENMAN IN SFLX IS IGNORED HERE IN              <a name='3672'></font>
<font color=#447700>! FAVOR OF BULK ETP OVER 'OPEN WATER' AT FREEZING TEMP.                          <a name='3673'></font>
<font color=#447700>! UPDATE SOIL HEAT FLUX (S) USING NEW SKIN TEMPERATURE (T1)                      <a name='3674'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3675'></font>
<font color=#447700>! ABOVE FREEZING BLOCK                                                           <a name='3676'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3677'></font>
<font color=#447700>!ek2        T1 = TFREEZ * SNCOVR + T12 * (1.0 - SNCOVR)                          <a name='3678'></font>
      ELSE                                                                       <a name='3679'>
<font color=#447700>!ek        QSAT = (0.622*6.11E2)/(SFCPRS-0.378*6.11E2)                           <a name='3680'></font>
<font color=#447700>!ek        ETP = RCH*(QSAT-Q2)/CP                                                <a name='3681'></font>
<font color=#447700>!ek        ETP2 = ETP*0.001*DT                                                   <a name='3682'></font>
         T1 = TFREEZ * SNCOVR ** SNOEXP + T12 * (1.0- SNCOVR ** SNOEXP)          <a name='3683'>
         BETA = 1.0                                                              <a name='3684'>
                                                                                 <a name='3685'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3686'></font>
<font color=#447700>! IF POTENTIAL EVAP (SUBLIMATION) GREATER THAN DEPTH OF SNOWPACK.                <a name='3687'></font>
<font color=#447700>! BETA&lt;1                                                                         <a name='3688'></font>
<font color=#447700>! SNOWPACK HAS SUBLIMATED AWAY, SET DEPTH TO ZERO.                               <a name='3689'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3690'></font>
         SSOIL = DF1 * (T1- STC (1)) / DTOT                                      <a name='3691'>
<font color=#447700>!        IF (ESD .le. ETP2) THEN                                                 <a name='3692'></font>
<font color=#447700>!           BETA = ESD / ETP2                                                    <a name='3693'></font>
         IF (ESD &lt;=  ESNOW2) THEN                                               <a name='3694'>
            ESD = 0.0                                                            <a name='3695'>
            EX = 0.0                                                             <a name='3696'>
            SNOMLT = 0.0                                                         <a name='3697'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3698'></font>
<font color=#447700>! POTENTIAL EVAP (SUBLIMATION) LESS THAN DEPTH OF SNOWPACK, RETAIN               <a name='3699'></font>
<font color=#447700>!   BETA=1.                                                                      <a name='3700'></font>
<font color=#447700>! SNOWPACK (ESD) REDUCED BY POTENTIAL EVAP RATE                                  <a name='3701'></font>
<font color=#447700>! ETP3 (CONVERT TO FLUX)                                                         <a name='3702'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3703'></font>
         ELSE                                                                    <a name='3704'>
<font color=#447700>!           ESD = ESD- ETP2                                                      <a name='3705'></font>
            ESD = ESD-ESNOW2                                                     <a name='3706'>
            ETP3 = ETP * LSUBC                                                   <a name='3707'>
<font color=#447700>!         WRITE (*,*) 'SNCOVR=',SNCOVR                                           <a name='3708'></font>
<font color=#447700>!         WRITE (*,*) 'ETP3,ETANRG=',ETP3,ETANRG,'ETP',ETP,'LSUBC',LSUBC         <a name='3709'></font>
            SEH = RCH * (T1- TH2)                                                <a name='3710'>
            T14 = T1* T1                                                         <a name='3711'>
<font color=#447700>!ek          FLX3 = FDOWN - FLX1 - FLX2 - SIGMA*T14 - SSOIL - SEH - ETP3         <a name='3712'></font>
<font color=#447700>!ek          FLX3X = FDOWN - FLX1 - FLX2 - SIGMA*T14 - SSOIL - SEH - ETANRG      <a name='3713'></font>
            T14 = T14* T14                                                       <a name='3714'>
<font color=#447700>!            FLX3 = FDOWN - FLX1- FLX2- SIGMA * T14- SSOIL - SEH - ETANRG         <a name='3715'></font>
           FLX3 = FDOWN - FLX1- FLX2- EMISSI_S*SIGMA * T14- SSOIL- SEH-     &amp;<a name='3716'>
     &amp;            ETANRG<a name='3717'>
<font color=#447700>!            WRITE (*,*) 'FLX3,FLX3X=',FLX3,FLX3X                                <a name='3718'></font>
            IF (FLX3 &lt;= 0.0) FLX3 = 0.0                                         <a name='3719'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3720'></font>
<font color=#447700>! SNOWMELT REDUCTION DEPENDING ON SNOW COVER                                     <a name='3721'></font>
<font color=#447700>! IF SNOW COVER LESS THAN 5% NO SNOWMELT REDUCTION                               <a name='3722'></font>
<font color=#447700>! ***NOTE:  DOES 'IF' BELOW FAIL TO MATCH THE MELT WATER WITH THE MELT           <a name='3723'></font>
<font color=#447700>!           ENERGY?                                                              <a name='3724'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3725'></font>
            EX = FLX3*0.001/ LSUBF                                               <a name='3726'>
<font color=#447700>!           IF (SNCOVR .gt. 0.05) EX = EX * SNCOVR                               <a name='3727'></font>
                                                                                 <a name='3728'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3729'></font>
<font color=#447700>! ESDMIN REPRESENTS A SNOWPACK DEPTH THRESHOLD VALUE BELOW WHICH WE              <a name='3730'></font>
<font color=#447700>! CHOOSE NOT TO RETAIN ANY SNOWPACK, AND INSTEAD INCLUDE IT IN SNOWMELT.         <a name='3731'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3732'></font>
            SNOMLT = EX * DT                                                     <a name='3733'>
            IF (ESD- SNOMLT &gt;=  ESDMIN) THEN                                    <a name='3734'>
               ESD = ESD- SNOMLT                                                 <a name='3735'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3736'></font>
<font color=#447700>! SNOWMELT EXCEEDS SNOW DEPTH                                                    <a name='3737'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3738'></font>
            ELSE                                                                 <a name='3739'>
               EX = ESD / DT                                                     <a name='3740'>
               FLX3 = EX *1000.0* LSUBF                                          <a name='3741'>
               SNOMLT = ESD                                                      <a name='3742'>
                                                                                 <a name='3743'>
               ESD = 0.0                                                         <a name='3744'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3745'></font>
<font color=#447700>! END OF 'ESD .LE. ETP2' IF-BLOCK                                                <a name='3746'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3747'></font>
            END IF                                                               <a name='3748'>
         END IF                                                                  <a name='3749'>
                                                                                 <a name='3750'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3751'></font>
<font color=#447700>! END OF 'T12 .LE. TFREEZ' IF-BLOCK                                              <a name='3752'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3753'></font>
         PRCP1 = PRCP1+ EX                                                       <a name='3754'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3755'></font>
<font color=#447700>! FINAL BETA NOW IN HAND, SO COMPUTE EVAPORATION.  EVAP EQUALS ETP               <a name='3756'></font>
<font color=#447700>! UNLESS BETA&lt;1.                                                                 <a name='3757'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3758'></font>
<font color=#447700>!ek      ETA = BETA*ETP                                                          <a name='3759'></font>
<font color=#447700>!      write(*,*) 'ETA,ETAX,ETAX/ETA=',ETA,ETAX,ETAX/ETA                         <a name='3760'></font>
<font color=#447700>!      IF (ETAX/ETA .GE. 1.0) THEN                                               <a name='3761'></font>
<font color=#447700>!        write(*,*) '*********************'                                      <a name='3762'></font>
<font color=#447700>!        write(*,*) '*********************'                                      <a name='3763'></font>
<font color=#447700>!        write(*,*) '*********************'                                      <a name='3764'></font>
<font color=#447700>!        write(*,*) 'ETAX/ETA .GE. 1.0 !!!'                                      <a name='3765'></font>
<font color=#447700>!        write(*,*) '*********************'                                      <a name='3766'></font>
<font color=#447700>!        write(*,*) '*********************'                                      <a name='3767'></font>
<font color=#447700>!        write(*,*) '*********************'                                      <a name='3768'></font>
<font color=#447700>!      ENDIF                                                                     <a name='3769'></font>
                                                                                 <a name='3770'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3771'></font>
<font color=#447700>! SET THE EFFECTIVE POTNL EVAPOTRANSP (ETP1) TO ZERO SINCE THIS IS SNOW          <a name='3772'></font>
<font color=#447700>! CASE, SO SURFACE EVAP NOT CALCULATED FROM EDIR, EC, OR ETT IN SMFLX            <a name='3773'></font>
<font color=#447700>! (BELOW).                                                                       <a name='3774'></font>
<font color=#447700>! IF SEAICE (ICE=1) SKIP CALL TO SMFLX.                                          <a name='3775'></font>
<font color=#447700>! SMFLX RETURNS UPDATED SOIL MOISTURE VALUES.  IN THIS, THE SNOW PACK            <a name='3776'></font>
<font color=#447700>! CASE, ETA1 IS NOT USED IN CALCULATION OF EVAP.                                 <a name='3777'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3778'></font>
<font color=#447700>!      ETP1 = 0.0                                                                <a name='3779'></font>
      END IF                                                                     <a name='3780'>
      IF (ICE /=  1) THEN                                                       <a name='3781'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX'>SMFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMFLX_6"> (SMC,NSOIL,CMC,DT,PRCP1,ZSOIL,                      &amp;        <a name='3782'>
                      SH2O,SLOPE,KDT,FRZFACT,                           &amp;        <a name='3783'>
                      SMCMAX,BEXP,SMCWLT,DKSAT,DWSAT,                   &amp;        <a name='3784'>
                      SHDFAC,CMCMAX,                                    &amp;        <a name='3785'>
                      RUNOFF1,RUNOFF2,RUNOFF3,                          &amp;        <a name='3786'>
                      EDIR1,EC1,ET1,                                    &amp;        <a name='3787'>
                      DRIP)                                                      <a name='3788'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3789'></font>
<font color=#447700>! BEFORE CALL SHFLX IN THIS SNOWPACK CASE, SET ZZ1 AND YY ARGUMENTS TO           <a name='3790'></font>
<font color=#447700>! SPECIAL VALUES THAT ENSURE THAT GROUND HEAT FLUX CALCULATED IN SHFLX           <a name='3791'></font>
<font color=#447700>! MATCHES THAT ALREADY COMPUTER FOR BELOW THE SNOWPACK, THUS THE SFC             <a name='3792'></font>
<font color=#447700>! HEAT FLUX TO BE COMPUTED IN SHFLX WILL EFFECTIVELY BE THE FLUX AT THE          <a name='3793'></font>
<font color=#447700>! SNOW TOP SURFACE.  T11 IS A DUMMY ARGUEMENT SO WE WILL NOT USE THE             <a name='3794'></font>
<font color=#447700>! SKIN TEMP VALUE AS REVISED BY SHFLX.                                           <a name='3795'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3796'></font>
      END IF                                                                     <a name='3797'>
      ZZ1 = 1.0                                                                  <a name='3798'>
      YY = STC (1) -0.5* SSOIL * ZSOIL (1)* ZZ1/ DF1                             <a name='3799'>
                                                                                 <a name='3800'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3801'></font>
<font color=#447700>! SHFLX WILL CALC/UPDATE THE SOIL TEMPS.  NOTE:  THE SUB-SFC HEAT FLUX           <a name='3802'></font>
<font color=#447700>! (SSOIL1) AND THE SKIN TEMP (T11) OUTPUT FROM THIS SHFLX CALL ARE NOT           <a name='3803'></font>
<font color=#447700>! USED  IN ANY SUBSEQUENT CALCULATIONS. RATHER, THEY ARE DUMMY VARIABLES         <a name='3804'></font>
<font color=#447700>! HERE IN THE SNOPAC CASE, SINCE THE SKIN TEMP AND SUB-SFC HEAT FLUX ARE         <a name='3805'></font>
<font color=#447700>! UPDATED INSTEAD NEAR THE BEGINNING OF THE CALL TO SNOPAC.                      <a name='3806'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3807'></font>
      T11 = T1                                                                   <a name='3808'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX'>SHFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHFLX_4"> (SSOIL1,STC,SMC,SMCMAX,NSOIL,T11,DT,YY,ZZ1,ZSOIL,      &amp;        <a name='3809'>
                   TBOT,ZBOT,SMCWLT,PSISAT,SH2O,BEXP,F1,DF1,ICE,        &amp;        <a name='3810'>
                   QUARTZ,CSOIL,VEGTYP)                                                 <a name='3811'>
                                                                                 <a name='3812'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3813'></font>
<font color=#447700>! SNOW DEPTH AND DENSITY ADJUSTMENT BASED ON SNOW COMPACTION.  YY IS             <a name='3814'></font>
<font color=#447700>! ASSUMED TO BE THE SOIL TEMPERTURE AT THE TOP OF THE SOIL COLUMN.               <a name='3815'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3816'></font>
      IF (ESD &gt;  0.) THEN                                                      <a name='3817'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOWPACK'>SNOWPACK</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWPACK_2"> (ESD,DT,SNOWH,SNDENS,T1,YY)                               <a name='3818'>
      ELSE                                                                       <a name='3819'>
         ESD = 0.                                                                <a name='3820'>
         SNOWH = 0.                                                              <a name='3821'>
         SNDENS = 0.                                                             <a name='3822'>
         SNCOND = 1.                                                             <a name='3823'>
      END IF                                                                     <a name='3824'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3825'></font>
  END SUBROUTINE SNOPAC                                                          <a name='3826'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3827'></font>
                                                                                 <a name='3828'>
                                                                                 <a name='3829'>
<A NAME='SNOWPACK'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOWPACK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3830'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWPACK</font> (ESD,DTSEC,SNOWH,SNDENS,TSNOW,TSOIL)                    <A href='../../call_to/SNOWPACK.html' TARGET='index'>2</A><a name='3831'>
                                                                                 <a name='3832'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3833'></font>
<font color=#447700>! SUBROUTINE SNOWPACK                                                            <a name='3834'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3835'></font>
<font color=#447700>! CALCULATE COMPACTION OF SNOWPACK UNDER CONDITIONS OF INCREASING SNOW           <a name='3836'></font>
<font color=#447700>! DENSITY, AS OBTAINED FROM AN APPROXIMATE SOLUTION OF E. ANDERSON'S             <a name='3837'></font>
<font color=#447700>! DIFFERENTIAL EQUATION (3.29), NOAA TECHNICAL REPORT NWS 19, BY VICTOR          <a name='3838'></font>
<font color=#447700>! KOREN, 03/25/95.                                                               <a name='3839'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3840'></font>
<font color=#447700>! ESD     WATER EQUIVALENT OF SNOW (M)                                           <a name='3841'></font>
<font color=#447700>! DTSEC   TIME STEP (SEC)                                                        <a name='3842'></font>
<font color=#447700>! SNOWH   SNOW DEPTH (M)                                                         <a name='3843'></font>
<font color=#447700>! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)             <a name='3844'></font>
<font color=#447700>! TSNOW   SNOW SURFACE TEMPERATURE (K)                                           <a name='3845'></font>
<font color=#447700>! TSOIL   SOIL SURFACE TEMPERATURE (K)                                           <a name='3846'></font>
                                                                                 <a name='3847'>
<font color=#447700>! SUBROUTINE WILL RETURN NEW VALUES OF SNOWH AND SNDENS                          <a name='3848'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3849'></font>
      IMPLICIT NONE                                                              <a name='3850'>
                                                                                 <a name='3851'>
      INTEGER                :: IPOL, J                                                           <a name='3852'>
      REAL, INTENT(IN)       :: ESD, DTSEC,TSNOW,TSOIL<a name='3853'>
      REAL, INTENT(INOUT)    :: SNOWH, SNDENS<a name='3854'>
      REAL                   :: BFAC,DSX,DTHR,DW,SNOWHC,PEXP,           &amp;      <a name='3855'>
                                TAVGC,TSNOWC,TSOILC,ESDC,ESDCX                 <a name='3856'>
      REAL, PARAMETER        :: C1 = 0.01, C2 = 21.0, G = 9.81,         &amp;<a name='3857'>
                                KN = 4000.0                    <a name='3858'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3859'></font>
<font color=#447700>! CONVERSION INTO SIMULATION UNITS                                               <a name='3860'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3861'></font>
      SNOWHC = SNOWH *100.                                                       <a name='3862'>
      ESDC = ESD *100.                                                           <a name='3863'>
      DTHR = DTSEC /3600.                                                        <a name='3864'>
      TSNOWC = TSNOW -273.15                                                     <a name='3865'>
      TSOILC = TSOIL -273.15                                                     <a name='3866'>
                                                                                 <a name='3867'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3868'></font>
<font color=#447700>! CALCULATING OF AVERAGE TEMPERATURE OF SNOW PACK                                <a name='3869'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3870'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3871'></font>
<font color=#447700>! CALCULATING OF SNOW DEPTH AND DENSITY AS A RESULT OF COMPACTION                <a name='3872'></font>
<font color=#447700>!  SNDENS=DS0*(EXP(BFAC*ESD)-1.)/(BFAC*ESD)                                      <a name='3873'></font>
<font color=#447700>!  BFAC=DTHR*C1*EXP(0.08*TAVGC-C2*DS0)                                           <a name='3874'></font>
<font color=#447700>! NOTE: BFAC*ESD IN SNDENS EQN ABOVE HAS TO BE CAREFULLY TREATED                 <a name='3875'></font>
<font color=#447700>! NUMERICALLY BELOW:                                                             <a name='3876'></font>
<font color=#447700>!   C1 IS THE FRACTIONAL INCREASE IN DENSITY (1/(CM*HR))                         <a name='3877'></font>
<font color=#447700>!   C2 IS A CONSTANT (CM3/G) KOJIMA ESTIMATED AS 21 CMS/G                        <a name='3878'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3879'></font>
      TAVGC = 0.5* (TSNOWC + TSOILC)                                             <a name='3880'>
      IF (ESDC &gt;  1.E-2) THEN                                                  <a name='3881'>
         ESDCX = ESDC                                                            <a name='3882'>
      ELSE                                                                       <a name='3883'>
         ESDCX = 1.E-2                                                           <a name='3884'>
      END IF                                                                     <a name='3885'>
                                                                                 <a name='3886'>
<font color=#447700>!      DSX = SNDENS*((DEXP(BFAC*ESDC)-1.)/(BFAC*ESDC))                           <a name='3887'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3888'></font>
<font color=#447700>! THE FUNCTION OF THE FORM (e**x-1)/x IMBEDDED IN ABOVE EXPRESSION               <a name='3889'></font>
<font color=#447700>! FOR DSX WAS CAUSING NUMERICAL DIFFICULTIES WHEN THE DENOMINATOR "x"            <a name='3890'></font>
<font color=#447700>! (I.E. BFAC*ESDC) BECAME ZERO OR APPROACHED ZERO (DESPITE THE FACT THAT         <a name='3891'></font>
<font color=#447700>! THE ANALYTICAL FUNCTION (e**x-1)/x HAS A WELL DEFINED LIMIT AS                 <a name='3892'></font>
<font color=#447700>! "x" APPROACHES ZERO), HENCE BELOW WE REPLACE THE (e**x-1)/x                    <a name='3893'></font>
<font color=#447700>! EXPRESSION WITH AN EQUIVALENT, NUMERICALLY WELL-BEHAVED                        <a name='3894'></font>
<font color=#447700>! POLYNOMIAL EXPANSION.                                                          <a name='3895'></font>
                                                                                 <a name='3896'>
<font color=#447700>! NUMBER OF TERMS OF POLYNOMIAL EXPANSION, AND HENCE ITS ACCURACY,               <a name='3897'></font>
<font color=#447700>! IS GOVERNED BY ITERATION LIMIT "IPOL".                                         <a name='3898'></font>
<font color=#447700>!      IPOL GREATER THAN 9 ONLY MAKES A DIFFERENCE ON DOUBLE                     <a name='3899'></font>
<font color=#447700>!            PRECISION (RELATIVE ERRORS GIVEN IN PERCENT %).                     <a name='3900'></font>
<font color=#447700>!       IPOL=9, FOR REL.ERROR &lt;~ 1.6 E-6 % (8 SIGNIFICANT DIGITS)                <a name='3901'></font>
<font color=#447700>!       IPOL=8, FOR REL.ERROR &lt;~ 1.8 E-5 % (7 SIGNIFICANT DIGITS)                <a name='3902'></font>
<font color=#447700>!       IPOL=7, FOR REL.ERROR &lt;~ 1.8 E-4 % ...                                   <a name='3903'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3904'></font>
      BFAC = DTHR * C1* EXP (0.08* TAVGC - C2* SNDENS)                           <a name='3905'>
      IPOL = 4                                                                   <a name='3906'>
      PEXP = 0.                                                                  <a name='3907'>
<font color=#447700>!        PEXP = (1. + PEXP)*BFAC*ESDC/REAL(J+1)                                  <a name='3908'></font>
      DO J = IPOL,1, -1                                                          <a name='3909'>
         PEXP = (1. + PEXP)* BFAC * ESDCX / REAL (J +1)                          <a name='3910'>
      END DO                                                                     <a name='3911'>
                                                                                 <a name='3912'>
      PEXP = PEXP + 1.                                                           <a name='3913'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3914'></font>
<font color=#447700>! ABOVE LINE ENDS POLYNOMIAL SUBSTITUTION                                        <a name='3915'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3916'></font>
<font color=#447700>!     END OF KOREAN FORMULATION                                                  <a name='3917'></font>
                                                                                 <a name='3918'>
<font color=#447700>!     BASE FORMULATION (COGLEY ET AL., 1990)                                     <a name='3919'></font>
<font color=#447700>!     CONVERT DENSITY FROM G/CM3 TO KG/M3                                        <a name='3920'></font>
<font color=#447700>!       DSM=SNDENS*1000.0                                                        <a name='3921'></font>
                                                                                 <a name='3922'>
<font color=#447700>!       DSX=DSM+DTSEC*0.5*DSM*G*ESD/                                             <a name='3923'></font>
<font color=#447700>!    &amp;      (1E7*EXP(-0.02*DSM+KN/(TAVGC+273.16)-14.643))                        <a name='3924'></font>
                                                                                 <a name='3925'>
<font color=#447700>!  &amp;   CONVERT DENSITY FROM KG/M3 TO G/CM3                                       <a name='3926'></font>
<font color=#447700>!       DSX=DSX/1000.0                                                           <a name='3927'></font>
                                                                                 <a name='3928'>
<font color=#447700>!     END OF COGLEY ET AL. FORMULATION                                           <a name='3929'></font>
                                                                                 <a name='3930'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3931'></font>
<font color=#447700>! SET UPPER/LOWER LIMIT ON SNOW DENSITY                                          <a name='3932'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3933'></font>
      DSX = SNDENS * (PEXP)                                                      <a name='3934'>
      IF (DSX &gt; 0.40) DSX = 0.40                                              <a name='3935'>
      IF (DSX &lt; 0.05) DSX = 0.05                                              <a name='3936'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3937'></font>
<font color=#447700>! UPDATE OF SNOW DEPTH AND DENSITY DEPENDING ON LIQUID WATER DURING              <a name='3938'></font>
<font color=#447700>! SNOWMELT.  ASSUMED THAT 13% OF LIQUID WATER CAN BE STORED IN SNOW PER          <a name='3939'></font>
<font color=#447700>! DAY DURING SNOWMELT TILL SNOW DENSITY 0.40.                                    <a name='3940'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3941'></font>
      SNDENS = DSX                                                               <a name='3942'>
      IF (TSNOWC &gt;=  0.) THEN                                                   <a name='3943'>
         DW = 0.13* DTHR /24.                                                    <a name='3944'>
         SNDENS = SNDENS * (1. - DW) + DW                                        <a name='3945'>
         IF (SNDENS &gt;=  0.40) SNDENS = 0.40                                     <a name='3946'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3947'></font>
<font color=#447700>! CALCULATE SNOW DEPTH (CM) FROM SNOW WATER EQUIVALENT AND SNOW DENSITY.         <a name='3948'></font>
<font color=#447700>! CHANGE SNOW DEPTH UNITS TO METERS                                              <a name='3949'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3950'></font>
      END IF                                                                     <a name='3951'>
      SNOWHC = ESDC / SNDENS                                                     <a name='3952'>
      SNOWH = SNOWHC *0.01                                                       <a name='3953'>
<a name='3954'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3955'></font>
  END SUBROUTINE SNOWPACK                                                        <a name='3956'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3957'></font>
                                                                                 <a name='3958'>
<A NAME='SNOWZ0'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOWZ0' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3959'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWZ0</font> (SNCOVR,Z0, Z0BRD)                                        <A href='../../call_to/SNOWZ0.html' TARGET='index'>1</A><a name='3960'>
                                                                                 <a name='3961'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3962'></font>
<font color=#447700>! SUBROUTINE SNOWZ0                                                              <a name='3963'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3964'></font>
<font color=#447700>! CALCULATE TOTAL ROUGHNESS LENGTH OVER SNOW                                     <a name='3965'></font>
<font color=#447700>! SNCOVR  FRACTIONAL SNOW COVER                                                  <a name='3966'></font>
<font color=#447700>! Z0      ROUGHNESS LENGTH (m)                                                   <a name='3967'></font>
<font color=#447700>! Z0S     SNOW ROUGHNESS LENGTH:=0.001 (m)                                       <a name='3968'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3969'></font>
      IMPLICIT NONE                                                              <a name='3970'>
      REAL, INTENT(IN)        :: SNCOVR, Z0BRD                                              <a name='3971'>
      REAL, INTENT(OUT)       :: Z0                                              <a name='3972'>
      REAL, PARAMETER         :: Z0S=0.001                                                      <a name='3973'>
                                                                                 <a name='3974'>
<font color=#447700>! CURRENT NOAH LSM CONDITION - MBEK, 09-OCT-2001                                 <a name='3975'></font>
<font color=#447700>!     Z0S = Z0BRD                                                                <a name='3976'></font>
      Z0 = (1.- SNCOVR)* Z0BRD + SNCOVR * Z0S                                    <a name='3977'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3978'></font>
  END SUBROUTINE SNOWZ0                                                          <a name='3979'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3980'></font>
                                                                                 <a name='3981'>
                                                                                 <a name='3982'>
<A NAME='SNOW_NEW'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOW_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3983'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOW_NEW</font> (TEMP,NEWSN,SNOWH,SNDENS)                               <A href='../../call_to/SNOW_NEW.html' TARGET='index'>2</A><a name='3984'>
                                                                                 <a name='3985'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3986'></font>
<font color=#447700>! SUBROUTINE SNOW_NEW                                                            <a name='3987'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3988'></font>
<font color=#447700>! CALCULATE SNOW DEPTH AND DENSITITY TO ACCOUNT FOR THE NEW SNOWFALL.            <a name='3989'></font>
<font color=#447700>! NEW VALUES OF SNOW DEPTH &amp; DENSITY RETURNED.                                   <a name='3990'></font>
                                                                                 <a name='3991'>
<font color=#447700>! TEMP    AIR TEMPERATURE (K)                                                    <a name='3992'></font>
<font color=#447700>! NEWSN   NEW SNOWFALL (M)                                                       <a name='3993'></font>
<font color=#447700>! SNOWH   SNOW DEPTH (M)                                                         <a name='3994'></font>
<font color=#447700>! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)             <a name='3995'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='3996'></font>
      IMPLICIT NONE                                                              <a name='3997'>
      REAL, INTENT(IN)        :: NEWSN, TEMP <a name='3998'>
      REAL, INTENT(INOUT)     :: SNDENS, SNOWH<a name='3999'>
      REAL                    :: DSNEW, HNEWC, SNOWHC,NEWSNC,TEMPC<a name='4000'>
                                                                                <a name='4001'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4002'></font>
<font color=#447700>! CONVERSION INTO SIMULATION UNITS                                               <a name='4003'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4004'></font>
      SNOWHC = SNOWH *100.                                                       <a name='4005'>
      NEWSNC = NEWSN *100.                                                       <a name='4006'>
                                                                                 <a name='4007'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4008'></font>
<font color=#447700>! CALCULATING NEW SNOWFALL DENSITY DEPENDING ON TEMPERATURE                      <a name='4009'></font>
<font color=#447700>! EQUATION FROM GOTTLIB L. 'A GENERAL RUNOFF MODEL FOR SNOWCOVERED               <a name='4010'></font>
<font color=#447700>! AND GLACIERIZED BASIN', 6TH NORDIC HYDROLOGICAL CONFERENCE,                    <a name='4011'></font>
<font color=#447700>! VEMADOLEN, SWEDEN, 1980, 172-177PP.                                            <a name='4012'></font>
<font color=#447700>!-----------------------------------------------------------------------         <a name='4013'></font>
      TEMPC = TEMP -273.15                                                       <a name='4014'>
      IF (TEMPC &lt;=  -15.) THEN                                                  <a name='4015'>
         DSNEW = 0.05                                                            <a name='4016'>
      ELSE                                                                       <a name='4017'>
         DSNEW = 0.05+0.0017* (TEMPC +15.)**1.5                                  <a name='4018'>
      END IF                                                                     <a name='4019'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4020'></font>
<font color=#447700>! ADJUSTMENT OF SNOW DENSITY DEPENDING ON NEW SNOWFALL                           <a name='4021'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4022'></font>
      HNEWC = NEWSNC / DSNEW                                                     <a name='4023'>
      SNDENS = (SNOWHC * SNDENS + HNEWC * DSNEW)/ (SNOWHC + HNEWC)               <a name='4024'>
      SNOWHC = SNOWHC + HNEWC                                                    <a name='4025'>
      SNOWH = SNOWHC *0.01                                                       <a name='4026'>
                                                                                 <a name='4027'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4028'></font>
  END SUBROUTINE SNOW_NEW                                                        <a name='4029'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4030'></font>
                                                                                 <a name='4031'>
<A NAME='SRT'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4032'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SRT</font> (RHSTT,EDIR,ET,SH2O,SH2OA,NSOIL,PCPDRP,            &amp;         <A href='../../call_to/SRT.html' TARGET='index'>6</A>,<A href='../../call_from/SRT.html' TARGET='index'>8</A><a name='4033'>
                       ZSOIL,DWSAT,DKSAT,SMCMAX,BEXP,RUNOFF1,           &amp;        <a name='4034'>
                       RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZX,SICE,AI,BI,CI)           <a name='4035'>
                                                                                 <a name='4036'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4037'></font>
<font color=#447700>! SUBROUTINE SRT                                                                 <a name='4038'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4039'></font>
<font color=#447700>! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL            <a name='4040'></font>
<font color=#447700>! WATER DIFFUSION EQUATION.  ALSO TO COMPUTE ( PREPARE ) THE MATRIX              <a name='4041'></font>
<font color=#447700>! COEFFICIENTS FOR THE TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.          <a name='4042'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4043'></font>
      IMPLICIT NONE                                                              <a name='4044'>
      INTEGER, INTENT(IN)       :: NSOIL<a name='4045'>
      INTEGER                   :: IALP1, IOHINF, J, JJ,  K, KS<a name='4046'>
      REAL, INTENT(IN)          :: BEXP, DKSAT, DT, DWSAT, EDIR, FRZX,  &amp;<a name='4047'>
                                   KDT, PCPDRP, SLOPE, SMCMAX, SMCWLT<a name='4048'>
      REAL, INTENT(OUT)         :: RUNOFF1, RUNOFF2<a name='4049'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: ET, SH2O, SH2OA, SICE,  &amp;<a name='4050'>
                                                ZSOIL<a name='4051'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)  :: RHSTT<a name='4052'>
      REAL, DIMENSION(1:NSOLD), INTENT(OUT)  :: AI, BI, CI<a name='4053'>
      REAL, DIMENSION(1:NSOLD)  :: DMAX<a name='4054'>
      REAL                      :: ACRT, DD, DDT, DDZ, DDZ2, DENOM,     &amp;<a name='4055'>
                                   DENOM2,DICE, DSMDZ, DSMDZ2, DT1,     &amp;<a name='4056'>
                                   FCR,INFMAX,MXSMC,MXSMC2,NUMER,PDDUM, &amp;<a name='4057'>
                                   PX, SICEMAX,SLOPX, SMCAV, SSTT,      &amp;<a name='4058'>
                                   SUM, VAL, WCND, WCND2, WDF, WDF2<a name='4059'>
      INTEGER, PARAMETER        :: CVFRZ = 3 <a name='4060'>
<a name='4061'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4062'></font>
<font color=#447700>! FROZEN GROUND VERSION:                                                         <a name='4063'></font>
<font color=#447700>! REFERENCE FROZEN GROUND PARAMETER, CVFRZ, IS A SHAPE PARAMETER OF              <a name='4064'></font>
<font color=#447700>! AREAL DISTRIBUTION FUNCTION OF SOIL ICE CONTENT WHICH EQUALS 1/CV.             <a name='4065'></font>
<font color=#447700>! CV IS A COEFFICIENT OF SPATIAL VARIATION OF SOIL ICE CONTENT.  BASED           <a name='4066'></font>
<font color=#447700>! ON FIELD DATA CV DEPENDS ON AREAL MEAN OF FROZEN DEPTH, AND IT CLOSE           <a name='4067'></font>
<font color=#447700>! TO CONSTANT = 0.6 IF AREAL MEAN FROZEN DEPTH IS ABOVE 20 CM.  THAT IS          <a name='4068'></font>
<font color=#447700>! WHY PARAMETER CVFRZ = 3 (INT{1/0.6*0.6}).                                      <a name='4069'></font>
<font color=#447700>! CURRENT LOGIC DOESN'T ALLOW CVFRZ BE BIGGER THAN 3                             <a name='4070'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4071'></font>
                                                                                 <a name='4072'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4073'></font>
<font color=#447700>! DETERMINE RAINFALL INFILTRATION RATE AND RUNOFF.  INCLUDE THE                  <a name='4074'></font>
<font color=#447700>! INFILTRATION FORMULE FROM SCHAAKE AND KOREN MODEL.                             <a name='4075'></font>
<font color=#447700>! MODIFIED BY Q DUAN                                                             <a name='4076'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4077'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4078'></font>
<font color=#447700>! LET SICEMAX BE THE GREATEST, IF ANY, FROZEN WATER CONTENT WITHIN SOIL          <a name='4079'></font>
<font color=#447700>! LAYERS.                                                                        <a name='4080'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4081'></font>
      IOHINF = 1                                                                 <a name='4082'>
      SICEMAX = 0.0                                                              <a name='4083'>
      DO KS = 1,NSOIL                                                            <a name='4084'>
         IF (SICE (KS) &gt;  SICEMAX) SICEMAX = SICE (KS)                         <a name='4085'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4086'></font>
<font color=#447700>! DETERMINE RAINFALL INFILTRATION RATE AND RUNOFF                                <a name='4087'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4088'></font>
      END DO                                                                     <a name='4089'>
      PDDUM = PCPDRP                                                             <a name='4090'>
      RUNOFF1 = 0.0                                                              <a name='4091'>
                                                                                 <a name='4092'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4093'></font>
<font color=#447700>! MODIFIED BY Q. DUAN, 5/16/94                                                   <a name='4094'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4095'></font>
<font color=#447700>!        IF (IOHINF == 1) THEN                                                 <a name='4096'></font>
                                                                                 <a name='4097'>
      IF (PCPDRP /=  0.0) THEN                                                  <a name='4098'>
         DT1 = DT /86400.                                                        <a name='4099'>
         SMCAV = SMCMAX - SMCWLT                                                 <a name='4100'>
                                                                                 <a name='4101'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4102'></font>
<font color=#447700>! FROZEN GROUND VERSION:                                                         <a name='4103'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4104'></font>
         DMAX (1)= - ZSOIL (1)* SMCAV                                            <a name='4105'>
                                                                                 <a name='4106'>
         DICE = - ZSOIL (1) * SICE (1)                                           <a name='4107'>
         DMAX (1)= DMAX (1)* (1.0- (SH2OA (1) + SICE (1) - SMCWLT)/      &amp;       <a name='4108'>
                    SMCAV)                                                       <a name='4109'>
                                                                                 <a name='4110'>
         DD = DMAX (1)                                                           <a name='4111'>
                                                                                 <a name='4112'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4113'></font>
<font color=#447700>! FROZEN GROUND VERSION:                                                         <a name='4114'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4115'></font>
         DO KS = 2,NSOIL                                                         <a name='4116'>
                                                                                 <a name='4117'>
            DICE = DICE+ ( ZSOIL (KS -1) - ZSOIL (KS) ) * SICE (KS)              <a name='4118'>
            DMAX (KS) = (ZSOIL (KS -1) - ZSOIL (KS))* SMCAV                      <a name='4119'>
            DMAX (KS) = DMAX (KS)* (1.0- (SH2OA (KS) + SICE (KS)        &amp;        <a name='4120'>
                        - SMCWLT)/ SMCAV)                                        <a name='4121'>
            DD = DD+ DMAX (KS)                                                   <a name='4122'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4123'></font>
<font color=#447700>! VAL = (1.-EXP(-KDT*SQRT(DT1)))                                                 <a name='4124'></font>
<font color=#447700>! IN BELOW, REMOVE THE SQRT IN ABOVE                                             <a name='4125'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4126'></font>
         END DO                                                                  <a name='4127'>
         VAL = (1. - EXP ( - KDT * DT1))                                         <a name='4128'>
         DDT = DD * VAL                                                          <a name='4129'>
         PX = PCPDRP * DT                                                        <a name='4130'>
         IF (PX &lt;  0.0) PX = 0.0                                               <a name='4131'>
                                                                                 <a name='4132'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4133'></font>
<font color=#447700>! FROZEN GROUND VERSION:                                                         <a name='4134'></font>
<font color=#447700>! REDUCTION OF INFILTRATION BASED ON FROZEN GROUND PARAMETERS                    <a name='4135'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4136'></font>
         INFMAX = (PX * (DDT / (PX + DDT)))/ DT                                  <a name='4137'>
         FCR = 1.                                                                <a name='4138'>
         IF (DICE &gt;  1.E-2) THEN                                               <a name='4139'>
            ACRT = CVFRZ * FRZX / DICE                                           <a name='4140'>
            SUM = 1.                                                             <a name='4141'>
            IALP1 = CVFRZ - 1                                                    <a name='4142'>
            DO J = 1,IALP1                                                       <a name='4143'>
               K = 1                                                             <a name='4144'>
               DO JJ = J +1,IALP1                                                <a name='4145'>
                  K = K * JJ                                                     <a name='4146'>
               END DO                                                            <a name='4147'>
               SUM = SUM + (ACRT ** ( CVFRZ - J)) / FLOAT (K)                    <a name='4148'>
            END DO                                                               <a name='4149'>
            FCR = 1. - EXP ( - ACRT) * SUM                                       <a name='4150'>
         END IF                                                                  <a name='4151'>
                                                                                 <a name='4152'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4153'></font>
<font color=#447700>! CORRECTION OF INFILTRATION LIMITATION:                                         <a name='4154'></font>
<font color=#447700>! IF INFMAX .LE. HYDROLIC CONDUCTIVITY ASSIGN INFMAX THE VALUE OF                <a name='4155'></font>
<font color=#447700>! HYDROLIC CONDUCTIVITY                                                          <a name='4156'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4157'></font>
<font color=#447700>!         MXSMC = MAX ( SH2OA(1), SH2OA(2) )                                     <a name='4158'></font>
         INFMAX = INFMAX * FCR                                                   <a name='4159'>
                                                                                 <a name='4160'>
         MXSMC = SH2OA (1)                                                       <a name='4161'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_5"> (WDF,WCND,MXSMC,SMCMAX,BEXP,DKSAT,DWSAT,           &amp;        <a name='4162'>
                         SICEMAX)                                                <a name='4163'>
         INFMAX = MAX (INFMAX,WCND)                                              <a name='4164'>
                                                                                 <a name='4165'>
         INFMAX = MIN (INFMAX,PX)                                                <a name='4166'>
         IF (PCPDRP &gt;  INFMAX) THEN                                            <a name='4167'>
            RUNOFF1 = PCPDRP - INFMAX                                            <a name='4168'>
            PDDUM = INFMAX                                                       <a name='4169'>
         END IF                                                                  <a name='4170'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4171'></font>
<font color=#447700>! TO AVOID SPURIOUS DRAINAGE BEHAVIOR, 'UPSTREAM DIFFERENCING' IN LINE           <a name='4172'></font>
<font color=#447700>! BELOW REPLACED WITH NEW APPROACH IN 2ND LINE:                                  <a name='4173'></font>
<font color=#447700>! 'MXSMC = MAX(SH2OA(1), SH2OA(2))'                                              <a name='4174'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4175'></font>
      END IF                                                                     <a name='4176'>
                                                                                 <a name='4177'>
      MXSMC = SH2OA (1)                                                          <a name='4178'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_6"> (WDF,WCND,MXSMC,SMCMAX,BEXP,DKSAT,DWSAT,              &amp;        <a name='4179'>
                    SICEMAX)                                                     <a name='4180'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4181'></font>
<font color=#447700>! CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER                  <a name='4182'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4183'></font>
      DDZ = 1. / ( - .5 * ZSOIL (2) )                                            <a name='4184'>
      AI (1) = 0.0                                                               <a name='4185'>
      BI (1) = WDF * DDZ / ( - ZSOIL (1) )                                       <a name='4186'>
                                                                                 <a name='4187'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4188'></font>
<font color=#447700>! CALC RHSTT FOR THE TOP LAYER AFTER CALC'NG THE VERTICAL SOIL MOISTURE          <a name='4189'></font>
<font color=#447700>! GRADIENT BTWN THE TOP AND NEXT TO TOP LAYERS.                                  <a name='4190'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4191'></font>
      CI (1) = - BI (1)                                                          <a name='4192'>
      DSMDZ = ( SH2O (1) - SH2O (2) ) / ( - .5 * ZSOIL (2) )                     <a name='4193'>
      RHSTT (1) = (WDF * DSMDZ + WCND- PDDUM + EDIR + ET (1))/ ZSOIL (1)         <a name='4194'>
                                                                                 <a name='4195'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4196'></font>
<font color=#447700>! INITIALIZE DDZ2                                                                <a name='4197'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4198'></font>
      SSTT = WDF * DSMDZ + WCND+ EDIR + ET (1)                                   <a name='4199'>
                                                                                 <a name='4200'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4201'></font>
<font color=#447700>! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABV PROCESS                 <a name='4202'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4203'></font>
      DDZ2 = 0.0                                                                 <a name='4204'>
      DO K = 2,NSOIL                                                             <a name='4205'>
         DENOM2 = (ZSOIL (K -1) - ZSOIL (K))                                     <a name='4206'>
         IF (K /= NSOIL) THEN                                                  <a name='4207'>
                                                                                 <a name='4208'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4209'></font>
<font color=#447700>! AGAIN, TO AVOID SPURIOUS DRAINAGE BEHAVIOR, 'UPSTREAM DIFFERENCING' IN         <a name='4210'></font>
<font color=#447700>! LINE BELOW REPLACED WITH NEW APPROACH IN 2ND LINE:                             <a name='4211'></font>
<font color=#447700>! 'MXSMC2 = MAX (SH2OA(K), SH2OA(K+1))'                                          <a name='4212'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4213'></font>
            SLOPX = 1.                                                           <a name='4214'>
                                                                                 <a name='4215'>
            MXSMC2 = SH2OA (K)                                                   <a name='4216'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_7"> (WDF2,WCND2,MXSMC2,SMCMAX,BEXP,DKSAT,DWSAT,     &amp;        <a name='4217'>
                          SICEMAX)                                               <a name='4218'>
<font color=#447700>! -----------------------------------------------------------------------        <a name='4219'></font>
<font color=#447700>! CALC SOME PARTIAL PRODUCTS FOR LATER USE IN CALC'NG RHSTT                      <a name='4220'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4221'></font>
            DENOM = (ZSOIL (K -1) - ZSOIL (K +1))                                <a name='4222'>
                                                                                 <a name='4223'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4224'></font>
<font color=#447700>! CALC THE MATRIX COEF, CI, AFTER CALC'NG ITS PARTIAL PRODUCT                    <a name='4225'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4226'></font>
            DSMDZ2 = (SH2O (K) - SH2O (K +1)) / (DENOM * 0.5)                    <a name='4227'>
            DDZ2 = 2.0 / DENOM                                                   <a name='4228'>
            CI (K) = - WDF2 * DDZ2 / DENOM2                                      <a name='4229'>
                                                                                 <a name='4230'>
         ELSE                                                                    <a name='4231'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4232'></font>
<font color=#447700>! SLOPE OF BOTTOM LAYER IS INTRODUCED                                            <a name='4233'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4234'></font>
                                                                                 <a name='4235'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4236'></font>
<font color=#447700>! RETRIEVE THE SOIL WATER DIFFUSIVITY AND HYDRAULIC CONDUCTIVITY FOR             <a name='4237'></font>
<font color=#447700>! THIS LAYER                                                                     <a name='4238'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4239'></font>
            SLOPX = SLOPE                                                        <a name='4240'>
          CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_8"> (WDF2,WCND2,SH2OA (NSOIL),SMCMAX,BEXP,DKSAT,DWSAT,     &amp;   <a name='4241'>
                            SICEMAX)                                             <a name='4242'>
                                                                                 <a name='4243'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4244'></font>
<font color=#447700>! CALC A PARTIAL PRODUCT FOR LATER USE IN CALC'NG RHSTT                          <a name='4245'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4246'></font>
                                                                                 <a name='4247'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4248'></font>
<font color=#447700>! SET MATRIX COEF CI TO ZERO                                                     <a name='4249'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4250'></font>
            DSMDZ2 = 0.0                                                         <a name='4251'>
            CI (K) = 0.0                                                         <a name='4252'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4253'></font>
<font color=#447700>! CALC RHSTT FOR THIS LAYER AFTER CALC'NG ITS NUMERATOR                          <a name='4254'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4255'></font>
         END IF                                                                  <a name='4256'>
         NUMER = (WDF2 * DSMDZ2) + SLOPX * WCND2- (WDF * DSMDZ)         &amp;        <a name='4257'>
                 - WCND+ ET (K)                                                  <a name='4258'>
                                                                                 <a name='4259'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4260'></font>
<font color=#447700>! CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER                                   <a name='4261'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4262'></font>
         RHSTT (K) = NUMER / ( - DENOM2)                                         <a name='4263'>
         AI (K) = - WDF * DDZ / DENOM2                                           <a name='4264'>
                                                                                 <a name='4265'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4266'></font>
<font color=#447700>! RESET VALUES OF WDF, WCND, DSMDZ, AND DDZ FOR LOOP TO NEXT LYR                 <a name='4267'></font>
<font color=#447700>! RUNOFF2:  SUB-SURFACE OR BASEFLOW RUNOFF                                       <a name='4268'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4269'></font>
         BI (K) = - ( AI (K) + CI (K) )                                          <a name='4270'>
         IF (K .eq. NSOIL) THEN                                                  <a name='4271'>
            RUNOFF2 = SLOPX * WCND2                                              <a name='4272'>
         END IF                                                                  <a name='4273'>
         IF (K .ne. NSOIL) THEN                                                  <a name='4274'>
            WDF = WDF2                                                           <a name='4275'>
            WCND = WCND2                                                         <a name='4276'>
            DSMDZ = DSMDZ2                                                       <a name='4277'>
            DDZ = DDZ2                                                           <a name='4278'>
         END IF                                                                  <a name='4279'>
      END DO                                                                     <a name='4280'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4281'></font>
  END SUBROUTINE SRT                                                             <a name='4282'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4283'></font>
                                                                                 <a name='4284'>
<A NAME='SSTEP'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SSTEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4285'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SSTEP</font> (SH2OOUT,SH2OIN,CMC,RHSTT,RHSCT,DT,              &amp;         <A href='../../call_to/SSTEP.html' TARGET='index'>6</A>,<A href='../../call_from/SSTEP.html' TARGET='index'>2</A><a name='4286'>
                        NSOIL,SMCMAX,CMCMAX,RUNOFF3,ZSOIL,SMC,SICE,     &amp;        <a name='4287'>
                        AI,BI,CI)                                             <a name='4288'>
                                                                                 <a name='4289'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4290'></font>
<font color=#447700>! SUBROUTINE SSTEP                                                               <a name='4291'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4292'></font>
<font color=#447700>! CALCULATE/UPDATE SOIL MOISTURE CONTENT VALUES AND CANOPY MOISTURE              <a name='4293'></font>
<font color=#447700>! CONTENT VALUES.                                                                <a name='4294'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4295'></font>
      IMPLICIT NONE                                                              <a name='4296'>
      INTEGER, INTENT(IN)       :: NSOIL<a name='4297'>
      INTEGER                   :: I, K, KK11<a name='4298'>
                                                                                 <a name='4299'>
      REAL, INTENT(IN)          :: CMCMAX, DT, SMCMAX<a name='4300'>
      REAL, INTENT(OUT)         :: RUNOFF3<a name='4301'>
      REAL, INTENT(INOUT)       :: CMC<a name='4302'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)     :: SH2OIN, SICE, ZSOIL<a name='4303'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)    :: SH2OOUT<a name='4304'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT)  :: RHSTT, SMC<a name='4305'>
      REAL, DIMENSION(1:NSOLD), INTENT(INOUT)  :: AI, BI, CI<a name='4306'>
      REAL, DIMENSION(1:NSOIL)  :: RHSTTin<a name='4307'>
      REAL, DIMENSION(1:NSOLD)  :: CIin<a name='4308'>
      REAL                      :: DDZ, RHSCT, STOT, WPLUS<a name='4309'>
<a name='4310'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4311'></font>
<font color=#447700>! CREATE 'AMOUNT' VALUES OF VARIABLES TO BE INPUT TO THE                         <a name='4312'></font>
<font color=#447700>! TRI-DIAGONAL MATRIX ROUTINE.                                                   <a name='4313'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4314'></font>
      DO K = 1,NSOIL                                                             <a name='4315'>
         RHSTT (K) = RHSTT (K) * DT                                              <a name='4316'>
         AI (K) = AI (K) * DT                                                    <a name='4317'>
         BI (K) = 1. + BI (K) * DT                                               <a name='4318'>
         CI (K) = CI (K) * DT                                                    <a name='4319'>
      END DO                                                                     <a name='4320'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4321'></font>
<font color=#447700>! COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12                          <a name='4322'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4323'></font>
      DO K = 1,NSOIL                                                             <a name='4324'>
         RHSTTin (K) = RHSTT (K)                                                 <a name='4325'>
      END DO                                                                     <a name='4326'>
      DO K = 1,NSOLD                                                             <a name='4327'>
         CIin (K) = CI (K)                                                       <a name='4328'>
      END DO                                                                     <a name='4329'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4330'></font>
<font color=#447700>! CALL ROSR12 TO SOLVE THE TRI-DIAGONAL MATRIX                                   <a name='4331'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4332'></font>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#ROSR12'>ROSR12</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SSTEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_4"> (CI,AI,BI,CIin,RHSTTin,RHSTT,NSOIL)                            <a name='4333'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4334'></font>
<font color=#447700>! SUM THE PREVIOUS SMC VALUE AND THE MATRIX SOLUTION TO GET A                    <a name='4335'></font>
<font color=#447700>! NEW VALUE.  MIN ALLOWABLE VALUE OF SMC WILL BE 0.02.                           <a name='4336'></font>
<font color=#447700>! RUNOFF3: RUNOFF WITHIN SOIL LAYERS                                             <a name='4337'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4338'></font>
      WPLUS = 0.0                                                                <a name='4339'>
      RUNOFF3 = 0.                                                               <a name='4340'>
                                                                                 <a name='4341'>
      DDZ = - ZSOIL (1)                                                          <a name='4342'>
      DO K = 1,NSOIL                                                             <a name='4343'>
         IF (K /= 1) DDZ = ZSOIL (K - 1) - ZSOIL (K) <a name='4344'>
         SH2OOUT (K) = SH2OIN (K) + CI (K) + WPLUS / DDZ<a name='4345'>
         STOT = SH2OOUT (K) + SICE (K)                                           <a name='4346'>
         IF (STOT &gt; SMCMAX) THEN                                              <a name='4347'>
            IF (K .eq. 1) THEN                                                   <a name='4348'>
               DDZ = - ZSOIL (1)                                                 <a name='4349'>
            ELSE                                                                 <a name='4350'>
               KK11 = K - 1                                                      <a name='4351'>
               DDZ = - ZSOIL (K) + ZSOIL (KK11)                                  <a name='4352'>
            END IF                                                               <a name='4353'>
            WPLUS = (STOT - SMCMAX) * DDZ                                        <a name='4354'>
         ELSE                                                                    <a name='4355'>
            WPLUS = 0.                                                           <a name='4356'>
         END IF                                                                  <a name='4357'>
         SMC (K) = MAX ( MIN (STOT,SMCMAX),0.02 )                                <a name='4358'>
         SH2OOUT (K) = MAX ( (SMC (K) - SICE (K)),0.0)                           <a name='4359'>
      END DO                                                                     <a name='4360'>
                                                                                 <a name='4361'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4362'></font>
<font color=#447700>! UPDATE CANOPY WATER CONTENT/INTERCEPTION (CMC).  CONVERT RHSCT TO              <a name='4363'></font>
<font color=#447700>! AN 'AMOUNT' VALUE AND ADD TO PREVIOUS CMC VALUE TO GET NEW CMC.                <a name='4364'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4365'></font>
      RUNOFF3 = WPLUS                                                            <a name='4366'>
      CMC = CMC + DT * RHSCT                                                     <a name='4367'>
      IF (CMC &lt; 1.E-20) CMC = 0.0                                             <a name='4368'>
      CMC = MIN (CMC,CMCMAX)                                                     <a name='4369'>
<a name='4370'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4371'></font>
  END SUBROUTINE SSTEP                                                           <a name='4372'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4373'></font>
                                                                                 <a name='4374'>
<A NAME='TBND'><A href='../../html_code/phys/module_sf_noahlsm.F.html#TBND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4375'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TBND</font> (TU,TB,ZSOIL,ZBOT,K,NSOIL,TBND1)                            <A href='../../call_to/TBND.html' TARGET='index'>6</A><a name='4376'>
                                                                                 <a name='4377'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4378'></font>
<font color=#447700>! SUBROUTINE TBND                                                                <a name='4379'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4380'></font>
<font color=#447700>! CALCULATE TEMPERATURE ON THE BOUNDARY OF THE LAYER BY INTERPOLATION OF         <a name='4381'></font>
<font color=#447700>! THE MIDDLE LAYER TEMPERATURES                                                  <a name='4382'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4383'></font>
      IMPLICIT NONE                                                              <a name='4384'>
      INTEGER, INTENT(IN)       :: NSOIL<a name='4385'>
      INTEGER                   :: K<a name='4386'>
      REAL, INTENT(IN)          :: TB, TU, ZBOT<a name='4387'>
      REAL, INTENT(OUT)         :: TBND1<a name='4388'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: ZSOIL<a name='4389'>
      REAL                      :: ZB, ZUP<a name='4390'>
      REAL, PARAMETER           :: T0 = 273.15                                                    <a name='4391'>
                                                                                 <a name='4392'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4393'></font>
<font color=#447700>! USE SURFACE TEMPERATURE ON THE TOP OF THE FIRST LAYER                          <a name='4394'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4395'></font>
     IF (K == 1) THEN                                                         <a name='4396'>
         ZUP = 0.                                                                <a name='4397'>
      ELSE                                                                       <a name='4398'>
         ZUP = ZSOIL (K -1)                                                      <a name='4399'>
      END IF                                                                     <a name='4400'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4401'></font>
<font color=#447700>! USE DEPTH OF THE CONSTANT BOTTOM TEMPERATURE WHEN INTERPOLATE                  <a name='4402'></font>
<font color=#447700>! TEMPERATURE INTO THE LAST LAYER BOUNDARY                                       <a name='4403'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4404'></font>
      IF (K ==  NSOIL) THEN                                                     <a name='4405'>
         ZB = 2.* ZBOT - ZSOIL (K)                                               <a name='4406'>
      ELSE                                                                       <a name='4407'>
         ZB = ZSOIL (K +1)                                                       <a name='4408'>
      END IF                                                                     <a name='4409'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4410'></font>
<font color=#447700>! LINEAR INTERPOLATION BETWEEN THE AVERAGE LAYER TEMPERATURES                    <a name='4411'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4412'></font>
                                                                                 <a name='4413'>
      TBND1 = TU + (TB - TU)* (ZUP - ZSOIL (K))/ (ZUP - ZB)                      <a name='4414'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4415'></font>
  END SUBROUTINE TBND                                                            <a name='4416'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4417'></font>
                                                                                 <a name='4418'>
                                                                                 <a name='4419'>
<A NAME='TDFCND'><A href='../../html_code/phys/module_sf_noahlsm.F.html#TDFCND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4420'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TDFCND</font> ( DF, SMC, QZ, SMCMAX, SH2O)                              <A href='../../call_to/TDFCND.html' TARGET='index'>8</A><a name='4421'>
                                                                                 <a name='4422'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4423'></font>
<font color=#447700>! SUBROUTINE TDFCND                                                              <a name='4424'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4425'></font>
<font color=#447700>! CALCULATE THERMAL DIFFUSIVITY AND CONDUCTIVITY OF THE SOIL FOR A GIVEN         <a name='4426'></font>
<font color=#447700>! POINT AND TIME.                                                                <a name='4427'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4428'></font>
<font color=#447700>! PETERS-LIDARD APPROACH (PETERS-LIDARD et al., 1998)                            <a name='4429'></font>
<font color=#447700>! June 2001 CHANGES: FROZEN SOIL CONDITION.                                      <a name='4430'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4431'></font>
      IMPLICIT NONE                                                              <a name='4432'>
      REAL, INTENT(IN)          :: QZ,  SMC, SMCMAX, SH2O<a name='4433'>
      REAL, INTENT(OUT)         :: DF<a name='4434'>
      REAL                      :: AKE, GAMMD, THKDRY, THKICE, THKO,    &amp;<a name='4435'>
                                   THKQTZ,THKSAT,THKS,THKW,SATRATIO,XU, &amp;<a name='4436'>
                                   XUNFROZ<a name='4437'>
                                    <a name='4438'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4439'></font>
<font color=#447700>! WE NOW GET QUARTZ AS AN INPUT ARGUMENT (SET IN ROUTINE REDPRM):                <a name='4440'></font>
<font color=#447700>!      DATA QUARTZ /0.82, 0.10, 0.25, 0.60, 0.52,                                <a name='4441'></font>
<font color=#447700>!     &amp;             0.35, 0.60, 0.40, 0.82/                                      <a name='4442'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4443'></font>
<font color=#447700>! IF THE SOIL HAS ANY MOISTURE CONTENT COMPUTE A PARTIAL SUM/PRODUCT             <a name='4444'></font>
<font color=#447700>! OTHERWISE USE A CONSTANT VALUE WHICH WORKS WELL WITH MOST SOILS                <a name='4445'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4446'></font>
<font color=#447700>!  THKW ......WATER THERMAL CONDUCTIVITY                                         <a name='4447'></font>
<font color=#447700>!  THKQTZ ....THERMAL CONDUCTIVITY FOR QUARTZ                                    <a name='4448'></font>
<font color=#447700>!  THKO ......THERMAL CONDUCTIVITY FOR OTHER SOIL COMPONENTS                     <a name='4449'></font>
<font color=#447700>!  THKS ......THERMAL CONDUCTIVITY FOR THE SOLIDS COMBINED(QUARTZ+OTHER)         <a name='4450'></font>
<font color=#447700>!  THKICE ....ICE THERMAL CONDUCTIVITY                                           <a name='4451'></font>
<font color=#447700>!  SMCMAX ....POROSITY (= SMCMAX)                                                <a name='4452'></font>
<font color=#447700>!  QZ .........QUARTZ CONTENT (SOIL TYPE DEPENDENT)                              <a name='4453'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4454'></font>
<font color=#447700>! USE AS IN PETERS-LIDARD, 1998 (MODIF. FROM JOHANSEN, 1975).                    <a name='4455'></font>
                                                                                 <a name='4456'>
<font color=#447700>!                                  PABLO GRUNMANN, 08/17/98                      <a name='4457'></font>
<font color=#447700>! REFS.:                                                                         <a name='4458'></font>
<font color=#447700>!      FAROUKI, O.T.,1986: THERMAL PROPERTIES OF SOILS. SERIES ON ROCK           <a name='4459'></font>
<font color=#447700>!              AND SOIL MECHANICS, VOL. 11, TRANS TECH, 136 PP.                  <a name='4460'></font>
<font color=#447700>!      JOHANSEN, O., 1975: THERMAL CONDUCTIVITY OF SOILS. PH.D. THESIS,          <a name='4461'></font>
<font color=#447700>!              UNIVERSITY OF TRONDHEIM,                                          <a name='4462'></font>
<font color=#447700>!      PETERS-LIDARD, C. D., ET AL., 1998: THE EFFECT OF SOIL THERMAL            <a name='4463'></font>
<font color=#447700>!              CONDUCTIVITY PARAMETERIZATION ON SURFACE ENERGY FLUXES            <a name='4464'></font>
<font color=#447700>!              AND TEMPERATURES. JOURNAL OF THE ATMOSPHERIC SCIENCES,            <a name='4465'></font>
<font color=#447700>!              VOL. 55, PP. 1209-1224.                                           <a name='4466'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4467'></font>
<font color=#447700>! NEEDS PARAMETERS                                                               <a name='4468'></font>
<font color=#447700>! POROSITY(SOIL TYPE):                                                           <a name='4469'></font>
<font color=#447700>!      POROS = SMCMAX                                                            <a name='4470'></font>
<font color=#447700>! SATURATION RATIO:                                                              <a name='4471'></font>
<font color=#447700>! PARAMETERS  W/(M.K)                                                            <a name='4472'></font>
      SATRATIO = SMC / SMCMAX                                                    <a name='4473'>
      THKICE = 2.2                                                               <a name='4474'>
      THKW = 0.57                                                                <a name='4475'>
<font color=#447700>!      IF (QZ .LE. 0.2) THKO = 3.0                                               <a name='4476'></font>
      THKO = 2.0                                                                 <a name='4477'>
<font color=#447700>! SOLIDS' CONDUCTIVITY                                                           <a name='4478'></font>
<font color=#447700>! QUARTZ' CONDUCTIVITY                                                           <a name='4479'></font>
      THKQTZ = 7.7                                                               <a name='4480'>
                                                                                 <a name='4481'>
<font color=#447700>! UNFROZEN FRACTION (FROM 1., i.e., 100%LIQUID, TO 0. (100% FROZEN))             <a name='4482'></font>
      THKS = (THKQTZ ** QZ)* (THKO ** (1. - QZ))                                 <a name='4483'>
                                                                                 <a name='4484'>
<font color=#447700>! UNFROZEN VOLUME FOR SATURATION (POROSITY*XUNFROZ)                              <a name='4485'></font>
      XUNFROZ = SH2O / SMC                                                       <a name='4486'>
<font color=#447700>! SATURATED THERMAL CONDUCTIVITY                                                 <a name='4487'></font>
      XU = XUNFROZ * SMCMAX                                                      <a name='4488'>
                                                                                 <a name='4489'>
<font color=#447700>! DRY DENSITY IN KG/M3                                                           <a name='4490'></font>
      THKSAT = THKS ** (1. - SMCMAX)* THKICE ** (SMCMAX - XU)* THKW **   &amp;       <a name='4491'>
         (XU)                                                                    <a name='4492'>
                                                                                 <a name='4493'>
<font color=#447700>! DRY THERMAL CONDUCTIVITY IN W.M-1.K-1                                          <a name='4494'></font>
      GAMMD = (1. - SMCMAX)*2700.                                                <a name='4495'>
                                                                                 <a name='4496'>
      THKDRY = (0.135* GAMMD+ 64.7)/ (2700. - 0.947* GAMMD)                      <a name='4497'>
<font color=#447700>! FROZEN                                                                         <a name='4498'></font>
      IF ( (SH2O + 0.0005) &lt;  SMC ) THEN                                       <a name='4499'>
         AKE = SATRATIO                                                          <a name='4500'>
<font color=#447700>! UNFROZEN                                                                       <a name='4501'></font>
<font color=#447700>! RANGE OF VALIDITY FOR THE KERSTEN NUMBER (AKE)                                 <a name='4502'></font>
      ELSE                                                                       <a name='4503'>
                                                                                 <a name='4504'>
<font color=#447700>! KERSTEN NUMBER (USING "FINE" FORMULA, VALID FOR SOILS CONTAINING AT            <a name='4505'></font>
<font color=#447700>! LEAST 5% OF PARTICLES WITH DIAMETER LESS THAN 2.E-6 METERS.)                   <a name='4506'></font>
<font color=#447700>! (FOR "COARSE" FORMULA, SEE PETERS-LIDARD ET AL., 1998).                        <a name='4507'></font>
                                                                                 <a name='4508'>
         IF ( SATRATIO &gt;  0.1 ) THEN                                           <a name='4509'>
                                                                                 <a name='4510'>
            AKE = LOG10 (SATRATIO) + 1.0                                         <a name='4511'>
                                                                                 <a name='4512'>
<font color=#447700>! USE K = KDRY                                                                   <a name='4513'></font>
         ELSE                                                                    <a name='4514'>
                                                                                 <a name='4515'>
            AKE = 0.0                                                            <a name='4516'>
         END IF                                                                  <a name='4517'>
<font color=#447700>!  THERMAL CONDUCTIVITY                                                          <a name='4518'></font>
                                                                                 <a name='4519'>
      END IF                                                                     <a name='4520'>
                                                                                 <a name='4521'>
      DF = AKE * (THKSAT - THKDRY) + THKDRY                                      <a name='4522'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4523'></font>
  END SUBROUTINE TDFCND                                                          <a name='4524'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4525'></font>
                                                                                 <a name='4526'>
<A NAME='TMPAVG'><A href='../../html_code/phys/module_sf_noahlsm.F.html#TMPAVG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4527'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TMPAVG</font> (TAVG,TUP,TM,TDN,ZSOIL,NSOIL,K)                           <A href='../../call_to/TMPAVG.html' TARGET='index'>2</A><a name='4528'>
                                                                                 <a name='4529'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4530'></font>
<font color=#447700>! SUBROUTINE TMPAVG                                                              <a name='4531'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4532'></font>
<font color=#447700>! CALCULATE SOIL LAYER AVERAGE TEMPERATURE (TAVG) IN FREEZING/THAWING            <a name='4533'></font>
<font color=#447700>! LAYER USING UP, DOWN, AND MIDDLE LAYER TEMPERATURES (TUP, TDN, TM),            <a name='4534'></font>
<font color=#447700>! WHERE TUP IS AT TOP BOUNDARY OF LAYER, TDN IS AT BOTTOM BOUNDARY OF            <a name='4535'></font>
<font color=#447700>! LAYER.  TM IS LAYER PROGNOSTIC STATE TEMPERATURE.                              <a name='4536'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4537'></font>
      IMPLICIT NONE                                                              <a name='4538'>
      INTEGER  K                                                                 <a name='4539'>
                                                                                 <a name='4540'>
      INTEGER  NSOIL                                                             <a name='4541'>
      REAL     DZ                                                                <a name='4542'>
      REAL     DZH                                                               <a name='4543'>
      REAL     T0                                                                <a name='4544'>
      REAL     TAVG                                                              <a name='4545'>
      REAL     TDN                                                               <a name='4546'>
      REAL     TM                                                                <a name='4547'>
      REAL     TUP                                                               <a name='4548'>
      REAL     X0                                                                <a name='4549'>
      REAL     XDN                                                               <a name='4550'>
      REAL     XUP                                                               <a name='4551'>
                                                                                 <a name='4552'>
      REAL     ZSOIL (NSOIL)                                                     <a name='4553'>
                                                                                 <a name='4554'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4555'></font>
      PARAMETER (T0 = 2.7315E2)                                                  <a name='4556'>
      IF (K .eq. 1) THEN                                                         <a name='4557'>
         DZ = - ZSOIL (1)                                                        <a name='4558'>
      ELSE                                                                       <a name='4559'>
         DZ = ZSOIL (K -1) - ZSOIL (K)                                           <a name='4560'>
      END IF                                                                     <a name='4561'>
                                                                                 <a name='4562'>
      DZH = DZ *0.5                                                              <a name='4563'>
      IF (TUP .lt. T0) THEN                                                      <a name='4564'>
         IF (TM .lt. T0) THEN                                                    <a name='4565'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4566'></font>
<font color=#447700>! TUP, TM, TDN &lt; T0                                                              <a name='4567'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4568'></font>
            IF (TDN .lt. T0) THEN                                                <a name='4569'>
               TAVG = (TUP + 2.0* TM + TDN)/ 4.0                                 <a name='4570'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4571'></font>
<font color=#447700>! TUP &amp; TM &lt; T0,  TDN .ge. T0                                                    <a name='4572'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4573'></font>
            ELSE                                                                 <a name='4574'>
               X0 = (T0- TM) * DZH / (TDN - TM)                                  <a name='4575'>
               TAVG = 0.5 * (TUP * DZH + TM * (DZH + X0) + T0* (        &amp;        <a name='4576'>
     &amp;               2.* DZH - X0)) / DZ                                         <a name='4577'>
            END IF                                                               <a name='4578'>
         ELSE                                                                    <a name='4579'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4580'></font>
<font color=#447700>! TUP &lt; T0, TM .ge. T0, TDN &lt; T0                                                 <a name='4581'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4582'></font>
            IF (TDN .lt. T0) THEN                                                <a name='4583'>
               XUP = (T0- TUP) * DZH / (TM - TUP)                                <a name='4584'>
               XDN = DZH - (T0- TM) * DZH / (TDN - TM)                           <a name='4585'>
               TAVG = 0.5 * (TUP * XUP + T0* (2.* DZ - XUP - XDN)       &amp;        <a name='4586'>
     &amp;                + TDN * XDN) / DZ                                          <a name='4587'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4588'></font>
<font color=#447700>! TUP &lt; T0, TM .ge. T0, TDN .ge. T0                                              <a name='4589'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4590'></font>
            ELSE                                                                 <a name='4591'>
               XUP = (T0- TUP) * DZH / (TM - TUP)                                <a name='4592'>
               TAVG = 0.5 * (TUP * XUP + T0* (2.* DZ - XUP)) / DZ                <a name='4593'>
            END IF                                                               <a name='4594'>
         END IF                                                                  <a name='4595'>
      ELSE                                                                       <a name='4596'>
         IF (TM .lt. T0) THEN                                                    <a name='4597'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4598'></font>
<font color=#447700>! TUP .ge. T0, TM &lt; T0, TDN &lt; T0                                                 <a name='4599'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4600'></font>
            IF (TDN .lt. T0) THEN                                                <a name='4601'>
               XUP = DZH - (T0- TUP) * DZH / (TM - TUP)                          <a name='4602'>
               TAVG = 0.5 * (T0* (DZ - XUP) + TM * (DZH + XUP)          &amp;        <a name='4603'>
     &amp;                + TDN * DZH) / DZ                                          <a name='4604'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4605'></font>
<font color=#447700>! TUP .ge. T0, TM &lt; T0, TDN .ge. T0                                              <a name='4606'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4607'></font>
            ELSE                                                                 <a name='4608'>
               XUP = DZH - (T0- TUP) * DZH / (TM - TUP)                          <a name='4609'>
               XDN = (T0- TM) * DZH / (TDN - TM)                                 <a name='4610'>
               TAVG = 0.5 * (T0* (2.* DZ - XUP - XDN) + TM *            &amp;        <a name='4611'>
     &amp; (XUP + XDN)) / DZ                                                         <a name='4612'>
            END IF                                                               <a name='4613'>
         ELSE                                                                    <a name='4614'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4615'></font>
<font color=#447700>! TUP .ge. T0, TM .ge. T0, TDN &lt; T0                                              <a name='4616'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4617'></font>
            IF (TDN .lt. T0) THEN                                                <a name='4618'>
               XDN = DZH - (T0- TM) * DZH / (TDN - TM)                           <a name='4619'>
               TAVG = (T0* (DZ - XDN) +0.5* (T0+ TDN)* XDN) / DZ                 <a name='4620'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4621'></font>
<font color=#447700>! TUP .ge. T0, TM .ge. T0, TDN .ge. T0                                           <a name='4622'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4623'></font>
            ELSE                                                                 <a name='4624'>
               TAVG = (TUP + 2.0* TM + TDN) / 4.0                                <a name='4625'>
            END IF                                                               <a name='4626'>
         END IF                                                                  <a name='4627'>
      END IF                                                                     <a name='4628'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4629'></font>
  END SUBROUTINE TMPAVG                                                          <a name='4630'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4631'></font>
                                                                                 <a name='4632'>
<A NAME='TRANSP'><A href='../../html_code/phys/module_sf_noahlsm.F.html#TRANSP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4633'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TRANSP</font> (ET,NSOIL,ETP1,SMC,CMC,ZSOIL,SHDFAC,SMCWLT,     &amp;         <A href='../../call_to/TRANSP.html' TARGET='index'>2</A><a name='4634'>
     &amp;                      CMCMAX,PC,CFACTR,SMCREF,SFCTMP,Q2,NROOT,    &amp;        <a name='4635'>
     &amp;                      RTDIS)                                               <a name='4636'>
                                                                                 <a name='4637'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4638'></font>
<font color=#447700>! SUBROUTINE TRANSP                                                              <a name='4639'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4640'></font>
<font color=#447700>! CALCULATE TRANSPIRATION FOR THE VEG CLASS.                                     <a name='4641'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4642'></font>
      IMPLICIT NONE                                                              <a name='4643'>
      INTEGER  I                                                                 <a name='4644'>
      INTEGER  K                                                                 <a name='4645'>
      INTEGER  NSOIL                                                             <a name='4646'>
                                                                                 <a name='4647'>
      INTEGER  NROOT                                                             <a name='4648'>
      REAL     CFACTR                                                            <a name='4649'>
      REAL     CMC                                                               <a name='4650'>
      REAL     CMCMAX                                                            <a name='4651'>
      REAL     DENOM                                                             <a name='4652'>
      REAL     ET (NSOIL)                                                        <a name='4653'>
      REAL     ETP1                                                              <a name='4654'>
      REAL     ETP1A                                                             <a name='4655'>
<font color=#447700>!.....REAL PART(NSOIL)                                                           <a name='4656'></font>
      REAL     GX (7)                                                            <a name='4657'>
      REAL     PC                                                                <a name='4658'>
      REAL     Q2                                                                <a name='4659'>
      REAL     RTDIS (NSOIL)                                                     <a name='4660'>
      REAL     RTX                                                               <a name='4661'>
      REAL     SFCTMP                                                            <a name='4662'>
      REAL     SGX                                                               <a name='4663'>
      REAL     SHDFAC                                                            <a name='4664'>
      REAL     SMC (NSOIL)                                                       <a name='4665'>
      REAL     SMCREF                                                            <a name='4666'>
      REAL     SMCWLT                                                            <a name='4667'>
                                                                                 <a name='4668'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4669'></font>
<font color=#447700>! INITIALIZE PLANT TRANSP TO ZERO FOR ALL SOIL LAYERS.                           <a name='4670'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4671'></font>
      REAL     ZSOIL (NSOIL)                                                     <a name='4672'>
      DO K = 1,NSOIL                                                             <a name='4673'>
         ET (K) = 0.                                                             <a name='4674'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4675'></font>
<font color=#447700>! CALCULATE AN 'ADJUSTED' POTENTIAL TRANSPIRATION                                <a name='4676'></font>
<font color=#447700>! IF STATEMENT BELOW TO AVOID TANGENT LINEAR PROBLEMS NEAR ZERO                  <a name='4677'></font>
<font color=#447700>! NOTE: GX AND OTHER TERMS BELOW REDISTRIBUTE TRANSPIRATION BY LAYER,            <a name='4678'></font>
<font color=#447700>! ET(K), AS A FUNCTION OF SOIL MOISTURE AVAILABILITY, WHILE PRESERVING           <a name='4679'></font>
<font color=#447700>! TOTAL ETP1A.                                                                   <a name='4680'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4681'></font>
      END DO                                                                     <a name='4682'>
      IF (CMC .ne. 0.0) THEN                                                     <a name='4683'>
         ETP1A = SHDFAC * PC * ETP1 * (1.0- (CMC / CMCMAX) ** CFACTR)            <a name='4684'>
      ELSE                                                                       <a name='4685'>
         ETP1A = SHDFAC * PC * ETP1                                              <a name='4686'>
      END IF                                                                     <a name='4687'>
      SGX = 0.0                                                                  <a name='4688'>
      DO I = 1,NROOT                                                             <a name='4689'>
         GX (I) = ( SMC (I) - SMCWLT ) / ( SMCREF - SMCWLT )                     <a name='4690'>
         GX (I) = MAX ( MIN ( GX (I), 1. ), 0. )                                 <a name='4691'>
         SGX = SGX + GX (I)                                                      <a name='4692'>
      END DO                                                                     <a name='4693'>
                                                                                 <a name='4694'>
      SGX = SGX / NROOT                                                          <a name='4695'>
      DENOM = 0.                                                                 <a name='4696'>
      DO I = 1,NROOT                                                             <a name='4697'>
         RTX = RTDIS (I) + GX (I) - SGX                                          <a name='4698'>
         GX (I) = GX (I) * MAX ( RTX, 0. )                                       <a name='4699'>
         DENOM = DENOM + GX (I)                                                  <a name='4700'>
      END DO                                                                     <a name='4701'>
                                                                                 <a name='4702'>
      IF (DENOM .le. 0.0) DENOM = 1.                                             <a name='4703'>
      DO I = 1,NROOT                                                             <a name='4704'>
         ET (I) = ETP1A * GX (I) / DENOM                                         <a name='4705'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4706'></font>
<font color=#447700>! ABOVE CODE ASSUMES A VERTICALLY UNIFORM ROOT DISTRIBUTION                      <a name='4707'></font>
<font color=#447700>! CODE BELOW TESTS A VARIABLE ROOT DISTRIBUTION                                  <a name='4708'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4709'></font>
<font color=#447700>!      ET(1) = ( ZSOIL(1) / ZSOIL(NROOT) ) * GX * ETP1A                          <a name='4710'></font>
<font color=#447700>!      ET(1) = ( ZSOIL(1) / ZSOIL(NROOT) ) * ETP1A                               <a name='4711'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4712'></font>
<font color=#447700>! USING ROOT DISTRIBUTION AS WEIGHTING FACTOR                                    <a name='4713'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4714'></font>
<font color=#447700>!      ET(1) = RTDIS(1) * ETP1A                                                  <a name='4715'></font>
<font color=#447700>!      ET(1) = ETP1A * PART(1)                                                   <a name='4716'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4717'></font>
<font color=#447700>! LOOP DOWN THRU THE SOIL LAYERS REPEATING THE OPERATION ABOVE,                  <a name='4718'></font>
<font color=#447700>! BUT USING THE THICKNESS OF THE SOIL LAYER (RATHER THAN THE                     <a name='4719'></font>
<font color=#447700>! ABSOLUTE DEPTH OF EACH LAYER) IN THE FINAL CALCULATION.                        <a name='4720'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4721'></font>
<font color=#447700>!      DO K = 2,NROOT                                                            <a name='4722'></font>
<font color=#447700>!        GX = ( SMC(K) - SMCWLT ) / ( SMCREF - SMCWLT )                          <a name='4723'></font>
<font color=#447700>!        GX = MAX ( MIN ( GX, 1. ), 0. )                                         <a name='4724'></font>
<font color=#447700>! TEST CANOPY RESISTANCE                                                         <a name='4725'></font>
<font color=#447700>!        GX = 1.0                                                                <a name='4726'></font>
<font color=#447700>!        ET(K) = ((ZSOIL(K)-ZSOIL(K-1))/ZSOIL(NROOT))*GX*ETP1A                   <a name='4727'></font>
<font color=#447700>!        ET(K) = ((ZSOIL(K)-ZSOIL(K-1))/ZSOIL(NROOT))*ETP1A                      <a name='4728'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4729'></font>
<font color=#447700>! USING ROOT DISTRIBUTION AS WEIGHTING FACTOR                                    <a name='4730'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4731'></font>
<font color=#447700>!        ET(K) = RTDIS(K) * ETP1A                                                <a name='4732'></font>
<font color=#447700>!        ET(K) = ETP1A*PART(K)                                                   <a name='4733'></font>
<font color=#447700>!      END DO                                                                    <a name='4734'></font>
      END DO                                                                     <a name='4735'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4736'></font>
  END SUBROUTINE TRANSP                                                          <a name='4737'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4738'></font>
                                                                                 <a name='4739'>
<A NAME='WDFCND'><A href='../../html_code/phys/module_sf_noahlsm.F.html#WDFCND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4740'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>WDFCND</font> (WDF,WCND,SMC,SMCMAX,BEXP,DKSAT,DWSAT,          &amp;         <A href='../../call_to/WDFCND.html' TARGET='index'>8</A><a name='4741'>
     &amp;                      SICEMAX)                                             <a name='4742'>
                                                                                 <a name='4743'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4744'></font>
<font color=#447700>! SUBROUTINE WDFCND                                                              <a name='4745'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4746'></font>
<font color=#447700>! CALCULATE SOIL WATER DIFFUSIVITY AND SOIL HYDRAULIC CONDUCTIVITY.              <a name='4747'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4748'></font>
      IMPLICIT NONE                                                              <a name='4749'>
      REAL     BEXP                                                              <a name='4750'>
      REAL     DKSAT                                                             <a name='4751'>
      REAL     DWSAT                                                             <a name='4752'>
      REAL     EXPON                                                             <a name='4753'>
      REAL     FACTR1                                                            <a name='4754'>
      REAL     FACTR2                                                            <a name='4755'>
      REAL     SICEMAX                                                           <a name='4756'>
      REAL     SMC                                                               <a name='4757'>
      REAL     SMCMAX                                                            <a name='4758'>
      REAL     VKwgt                                                             <a name='4759'>
      REAL     WCND                                                              <a name='4760'>
                                                                                 <a name='4761'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4762'></font>
<font color=#447700>!     CALC THE RATIO OF THE ACTUAL TO THE MAX PSBL SOIL H2O CONTENT              <a name='4763'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4764'></font>
      REAL     WDF                                                               <a name='4765'>
      FACTR1 = 0.2 / SMCMAX                                                      <a name='4766'>
                                                                                 <a name='4767'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4768'></font>
<font color=#447700>! PREP AN EXPNTL COEF AND CALC THE SOIL WATER DIFFUSIVITY                        <a name='4769'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4770'></font>
      FACTR2 = SMC / SMCMAX                                                      <a name='4771'>
      EXPON = BEXP + 2.0                                                         <a name='4772'>
                                                                                 <a name='4773'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4774'></font>
<font color=#447700>! FROZEN SOIL HYDRAULIC DIFFUSIVITY.  VERY SENSITIVE TO THE VERTICAL             <a name='4775'></font>
<font color=#447700>! GRADIENT OF UNFROZEN WATER. THE LATTER GRADIENT CAN BECOME VERY                <a name='4776'></font>
<font color=#447700>! EXTREME IN FREEZING/THAWING SITUATIONS, AND GIVEN THE RELATIVELY               <a name='4777'></font>
<font color=#447700>! FEW AND THICK SOIL LAYERS, THIS GRADIENT SUFFERES SERIOUS                      <a name='4778'></font>
<font color=#447700>! TRUNCTION ERRORS YIELDING ERRONEOUSLY HIGH VERTICAL TRANSPORTS OF              <a name='4779'></font>
<font color=#447700>! UNFROZEN WATER IN BOTH DIRECTIONS FROM HUGE HYDRAULIC DIFFUSIVITY.             <a name='4780'></font>
<font color=#447700>! THEREFORE, WE FOUND WE HAD TO ARBITRARILY CONSTRAIN WDF                        <a name='4781'></font>
<font color=#447700>! --                                                                             <a name='4782'></font>
<font color=#447700>! VERSION D_10CM: ........  FACTR1 = 0.2/SMCMAX                                  <a name='4783'></font>
<font color=#447700>! WEIGHTED APPROACH...................... PABLO GRUNMANN, 28_SEP_1999.           <a name='4784'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4785'></font>
      WDF = DWSAT * FACTR2 ** EXPON                                              <a name='4786'>
      IF (SICEMAX .gt. 0.0) THEN                                                 <a name='4787'>
         VKWGT = 1./ (1. + (500.* SICEMAX)**3.)                                  <a name='4788'>
         WDF = VKWGT * WDF + (1. - VKWGT)* DWSAT * FACTR1** EXPON                <a name='4789'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4790'></font>
<font color=#447700>! RESET THE EXPNTL COEF AND CALC THE HYDRAULIC CONDUCTIVITY                      <a name='4791'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4792'></font>
      END IF                                                                     <a name='4793'>
      EXPON = (2.0 * BEXP) + 3.0                                                 <a name='4794'>
      WCND = DKSAT * FACTR2 ** EXPON                                             <a name='4795'>
                                                                                 <a name='4796'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4797'></font>
  END SUBROUTINE WDFCND                                                          <a name='4798'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4799'></font>
                                                                                 <a name='4800'>
<A NAME='SFCDIF_OFF'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFCDIF_OFF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4801'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCDIF_off</font> (ZLM,Z0,THZ0,THLM,SFCSPD,CZIL,AKMS,AKHS)             <a name='4802'>
                                                                                 <a name='4803'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4804'></font>
<font color=#447700>! SUBROUTINE SFCDIF (renamed SFCDIF_off to avoid clash with Eta PBL)             <a name='4805'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4806'></font>
<font color=#447700>! CALCULATE SURFACE LAYER EXCHANGE COEFFICIENTS VIA ITERATIVE PROCESS.           <a name='4807'></font>
<font color=#447700>! SEE CHEN ET AL (1997, BLM)                                                     <a name='4808'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4809'></font>
                                                                                 <a name='4810'>
      IMPLICIT NONE                                                              <a name='4811'>
      REAL     WWST, WWST2, G, VKRM, EXCM, BETA, BTG, ELFC, WOLD, WNEW           <a name='4812'>
      REAL     PIHF, EPSU2, EPSUST, EPSIT, EPSA, ZTMIN, ZTMAX, HPBL,     &amp;       <a name='4813'>
     &amp; SQVISC                                                                    <a name='4814'>
      REAL     RIC, RRIC, FHNEU, RFC, RFAC, ZZ, PSLMU, PSLMS, PSLHU,     &amp;       <a name='4815'>
     &amp; PSLHS                                                                     <a name='4816'>
      REAL     XX, PSPMU, YY, PSPMS, PSPHU, PSPHS, ZLM, Z0, THZ0, THLM           <a name='4817'>
      REAL     SFCSPD, CZIL, AKMS, AKHS, ZILFC, ZU, ZT, RDZ, CXCH                <a name='4818'>
      REAL     DTHV, DU2, BTGH, WSTAR2, USTAR, ZSLU, ZSLT, RLOGU, RLOGT          <a name='4819'>
      REAL     RLMO, ZETALT, ZETALU, ZETAU, ZETAT, XLU4, XLT4, XU4, XT4          <a name='4820'>
<font color=#447700>!CC   ......REAL ZTFC                                                            <a name='4821'></font>
                                                                                 <a name='4822'>
      REAL     XLU, XLT, XU, XT, PSMZ, SIMM, PSHZ, SIMH, USTARK, RLMN,  &amp;        <a name='4823'>
     &amp;         RLMA                                                              <a name='4824'>
                                                                                 <a name='4825'>
      INTEGER  ITRMX, ILECH, ITR                                                 <a name='4826'>
      PARAMETER                                                         &amp;        <a name='4827'>
     &amp;        (WWST = 1.2,WWST2 = WWST * WWST,G = 9.8,VKRM = 0.40,      &amp;        <a name='4828'>
     &amp;         EXCM = 0.001                                             &amp;        <a name='4829'>
     &amp;        ,BETA = 1./270.,BTG = BETA * G,ELFC = VKRM * BTG          &amp;        <a name='4830'>
     &amp;                  ,WOLD =.15,WNEW = 1. - WOLD,ITRMX = 05,         &amp;        <a name='4831'>
     &amp;                   PIHF = 3.14159265/2.)                                   <a name='4832'>
      PARAMETER                                                         &amp;        <a name='4833'>
     &amp;         (EPSU2 = 1.E-4,EPSUST = 0.07,EPSIT = 1.E-4,EPSA = 1.E-8  &amp;        <a name='4834'>
     &amp;         ,ZTMIN = -5.,ZTMAX = 1.,HPBL = 1000.0                    &amp;        <a name='4835'>
     &amp;          ,SQVISC = 258.2)                                                 <a name='4836'>
      PARAMETER                                                         &amp;        <a name='4837'>
     &amp;       (RIC = 0.183,RRIC = 1.0/ RIC,FHNEU = 0.8,RFC = 0.191       &amp;        <a name='4838'>
     &amp;        ,RFAC = RIC / (FHNEU * RFC * RFC))                                 <a name='4839'>
                                                                                 <a name='4840'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4841'></font>
<font color=#447700>! NOTE: THE TWO CODE BLOCKS BELOW DEFINE FUNCTIONS                               <a name='4842'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4843'></font>
<font color=#447700>! LECH'S SURFACE FUNCTIONS                                                       <a name='4844'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4845'></font>
      PSLMU (ZZ)= -0.96* log (1.0-4.5* ZZ)                                       <a name='4846'>
      PSLMS (ZZ)= ZZ * RRIC -2.076* (1. -1./ (ZZ +1.))                           <a name='4847'>
      PSLHU (ZZ)= -0.96* log (1.0-4.5* ZZ)                                       <a name='4848'>
                                                                                 <a name='4849'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4850'></font>
<font color=#447700>! PAULSON'S SURFACE FUNCTIONS                                                    <a name='4851'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4852'></font>
      PSLHS (ZZ)= ZZ * RFAC -2.076* (1. -1./ (ZZ +1.))                           <a name='4853'>
      PSPMU (XX)= -2.* log ( (XX +1.)*0.5) - log ( (XX * XX +1.)*0.5)   &amp;        <a name='4854'>
     &amp;        +2.* ATAN (XX)                                            &amp;        <a name='4855'>
     &amp;- PIHF                                                                     <a name='4856'>
      PSPMS (YY)= 5.* YY                                                         <a name='4857'>
      PSPHU (XX)= -2.* log ( (XX * XX +1.)*0.5)                                  <a name='4858'>
                                                                                 <a name='4859'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4860'></font>
<font color=#447700>! THIS ROUTINE SFCDIF CAN HANDLE BOTH OVER OPEN WATER (SEA, OCEAN) AND           <a name='4861'></font>
<font color=#447700>! OVER SOLID SURFACE (LAND, SEA-ICE).                                            <a name='4862'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4863'></font>
      PSPHS (YY)= 5.* YY                                                         <a name='4864'>
                                                                                 <a name='4865'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4866'></font>
<font color=#447700>!     ZTFC: RATIO OF ZOH/ZOM  LESS OR EQUAL THAN 1                               <a name='4867'></font>
<font color=#447700>!     C......ZTFC=0.1                                                            <a name='4868'></font>
<font color=#447700>!     CZIL: CONSTANT C IN Zilitinkevich, S. S.1995,:NOTE ABOUT ZT                <a name='4869'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4870'></font>
      ILECH = 0                                                                  <a name='4871'>
                                                                                 <a name='4872'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4873'></font>
      ZILFC = - CZIL * VKRM * SQVISC                                             <a name='4874'>
<font color=#447700>!     C.......ZT=Z0*ZTFC                                                         <a name='4875'></font>
      ZU = Z0                                                                    <a name='4876'>
      RDZ = 1./ ZLM                                                              <a name='4877'>
      CXCH = EXCM * RDZ                                                          <a name='4878'>
      DTHV = THLM - THZ0                                                         <a name='4879'>
                                                                                 <a name='4880'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4881'></font>
<font color=#447700>! BELJARS CORRECTION OF USTAR                                                    <a name='4882'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4883'></font>
      DU2 = MAX (SFCSPD * SFCSPD,EPSU2)                                          <a name='4884'>
<font color=#447700>!cc   If statements to avoid TANGENT LINEAR problems near zero                   <a name='4885'></font>
      BTGH = BTG * HPBL                                                          <a name='4886'>
      IF (BTGH * AKHS * DTHV .ne. 0.0) THEN                                      <a name='4887'>
         WSTAR2 = WWST2* ABS (BTGH * AKHS * DTHV)** (2./3.)                      <a name='4888'>
      ELSE                                                                       <a name='4889'>
         WSTAR2 = 0.0                                                            <a name='4890'>
      END IF                                                                     <a name='4891'>
                                                                                 <a name='4892'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4893'></font>
<font color=#447700>! ZILITINKEVITCH APPROACH FOR ZT                                                 <a name='4894'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4895'></font>
      USTAR = MAX (SQRT (AKMS * SQRT (DU2+ WSTAR2)),EPSUST)                      <a name='4896'>
                                                                                 <a name='4897'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4898'></font>
      ZT = EXP (ZILFC * SQRT (USTAR * Z0))* Z0                                   <a name='4899'>
      ZSLU = ZLM + ZU                                                            <a name='4900'>
<font color=#447700>!     PRINT*,'ZSLT=',ZSLT                                                        <a name='4901'></font>
<font color=#447700>!     PRINT*,'ZLM=',ZLM                                                          <a name='4902'></font>
<font color=#447700>!     PRINT*,'ZT=',ZT                                                            <a name='4903'></font>
                                                                                 <a name='4904'>
      ZSLT = ZLM + ZT                                                            <a name='4905'>
      RLOGU = log (ZSLU / ZU)                                                    <a name='4906'>
                                                                                 <a name='4907'>
      RLOGT = log (ZSLT / ZT)                                                    <a name='4908'>
<font color=#447700>!     PRINT*,'RLMO=',RLMO                                                        <a name='4909'></font>
<font color=#447700>!     PRINT*,'ELFC=',ELFC                                                        <a name='4910'></font>
<font color=#447700>!     PRINT*,'AKHS=',AKHS                                                        <a name='4911'></font>
<font color=#447700>!     PRINT*,'DTHV=',DTHV                                                        <a name='4912'></font>
<font color=#447700>!     PRINT*,'USTAR=',USTAR                                                      <a name='4913'></font>
                                                                                 <a name='4914'>
      RLMO = ELFC * AKHS * DTHV / USTAR **3                                      <a name='4915'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4916'></font>
<font color=#447700>! 1./MONIN-OBUKKHOV LENGTH-SCALE                                                 <a name='4917'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4918'></font>
      DO ITR = 1,ITRMX                                                           <a name='4919'>
         ZETALT = MAX (ZSLT * RLMO,ZTMIN)                                        <a name='4920'>
         RLMO = ZETALT / ZSLT                                                    <a name='4921'>
         ZETALU = ZSLU * RLMO                                                    <a name='4922'>
         ZETAU = ZU * RLMO                                                       <a name='4923'>
                                                                                 <a name='4924'>
         ZETAT = ZT * RLMO                                                       <a name='4925'>
         IF (ILECH .eq. 0) THEN                                                  <a name='4926'>
            IF (RLMO .lt. 0.)THEN                                                <a name='4927'>
               XLU4 = 1. -16.* ZETALU                                            <a name='4928'>
               XLT4 = 1. -16.* ZETALT                                            <a name='4929'>
               XU4 = 1. -16.* ZETAU                                              <a name='4930'>
                                                                                 <a name='4931'>
               XT4 = 1. -16.* ZETAT                                              <a name='4932'>
               XLU = SQRT (SQRT (XLU4))                                          <a name='4933'>
               XLT = SQRT (SQRT (XLT4))                                          <a name='4934'>
               XU = SQRT (SQRT (XU4))                                            <a name='4935'>
                                                                                 <a name='4936'>
               XT = SQRT (SQRT (XT4))                                            <a name='4937'>
<font color=#447700>!     PRINT*,'-----------1------------'                                          <a name='4938'></font>
<font color=#447700>!     PRINT*,'PSMZ=',PSMZ                                                        <a name='4939'></font>
<font color=#447700>!     PRINT*,'PSPMU(ZETAU)=',PSPMU(ZETAU)                                        <a name='4940'></font>
<font color=#447700>!     PRINT*,'XU=',XU                                                            <a name='4941'></font>
<font color=#447700>!     PRINT*,'------------------------'                                          <a name='4942'></font>
               PSMZ = PSPMU (XU)                                                 <a name='4943'>
               SIMM = PSPMU (XLU) - PSMZ + RLOGU                                 <a name='4944'>
               PSHZ = PSPHU (XT)                                                 <a name='4945'>
               SIMH = PSPHU (XLT) - PSHZ + RLOGT                                 <a name='4946'>
            ELSE                                                                 <a name='4947'>
               ZETALU = MIN (ZETALU,ZTMAX)                                       <a name='4948'>
               ZETALT = MIN (ZETALT,ZTMAX)                                       <a name='4949'>
<font color=#447700>!     PRINT*,'-----------2------------'                                          <a name='4950'></font>
<font color=#447700>!     PRINT*,'PSMZ=',PSMZ                                                        <a name='4951'></font>
<font color=#447700>!     PRINT*,'PSPMS(ZETAU)=',PSPMS(ZETAU)                                        <a name='4952'></font>
<font color=#447700>!     PRINT*,'ZETAU=',ZETAU                                                      <a name='4953'></font>
<font color=#447700>!     PRINT*,'------------------------'                                          <a name='4954'></font>
               PSMZ = PSPMS (ZETAU)                                              <a name='4955'>
               SIMM = PSPMS (ZETALU) - PSMZ + RLOGU                              <a name='4956'>
               PSHZ = PSPHS (ZETAT)                                              <a name='4957'>
               SIMH = PSPHS (ZETALT) - PSHZ + RLOGT                              <a name='4958'>
            END IF                                                               <a name='4959'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4960'></font>
<font color=#447700>! LECH'S FUNCTIONS                                                               <a name='4961'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4962'></font>
         ELSE                                                                    <a name='4963'>
            IF (RLMO .lt. 0.)THEN                                                <a name='4964'>
<font color=#447700>!     PRINT*,'-----------3------------'                                          <a name='4965'></font>
<font color=#447700>!     PRINT*,'PSMZ=',PSMZ                                                        <a name='4966'></font>
<font color=#447700>!     PRINT*,'PSLMU(ZETAU)=',PSLMU(ZETAU)                                        <a name='4967'></font>
<font color=#447700>!     PRINT*,'ZETAU=',ZETAU                                                      <a name='4968'></font>
<font color=#447700>!     PRINT*,'------------------------'                                          <a name='4969'></font>
               PSMZ = PSLMU (ZETAU)                                              <a name='4970'>
               SIMM = PSLMU (ZETALU) - PSMZ + RLOGU                              <a name='4971'>
               PSHZ = PSLHU (ZETAT)                                              <a name='4972'>
               SIMH = PSLHU (ZETALT) - PSHZ + RLOGT                              <a name='4973'>
            ELSE                                                                 <a name='4974'>
               ZETALU = MIN (ZETALU,ZTMAX)                                       <a name='4975'>
                                                                                 <a name='4976'>
               ZETALT = MIN (ZETALT,ZTMAX)                                       <a name='4977'>
<font color=#447700>!     PRINT*,'-----------4------------'                                          <a name='4978'></font>
<font color=#447700>!     PRINT*,'PSMZ=',PSMZ                                                        <a name='4979'></font>
<font color=#447700>!     PRINT*,'PSLMS(ZETAU)=',PSLMS(ZETAU)                                        <a name='4980'></font>
<font color=#447700>!     PRINT*,'ZETAU=',ZETAU                                                      <a name='4981'></font>
<font color=#447700>!     PRINT*,'------------------------'                                          <a name='4982'></font>
               PSMZ = PSLMS (ZETAU)                                              <a name='4983'>
               SIMM = PSLMS (ZETALU) - PSMZ + RLOGU                              <a name='4984'>
               PSHZ = PSLHS (ZETAT)                                              <a name='4985'>
               SIMH = PSLHS (ZETALT) - PSHZ + RLOGT                              <a name='4986'>
            END IF                                                               <a name='4987'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4988'></font>
<font color=#447700>! BELJAARS CORRECTION FOR USTAR                                                  <a name='4989'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4990'></font>
         END IF                                                                  <a name='4991'>
                                                                                 <a name='4992'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4993'></font>
<font color=#447700>! ZILITINKEVITCH FIX FOR ZT                                                      <a name='4994'></font>
<font color=#447700>! ----------------------------------------------------------------------         <a name='4995'></font>
         USTAR = MAX (SQRT (AKMS * SQRT (DU2+ WSTAR2)),EPSUST)                   <a name='4996'>
                                                                                 <a name='4997'>
         ZT = EXP (ZILFC * SQRT (USTAR * Z0))* Z0                                <a name='4998'>
         ZSLT = ZLM + ZT                                                         <a name='4999'>
<font color=#447700>!-----------------------------------------------------------------------         <a name='5000'></font>
         RLOGT = log (ZSLT / ZT)                                                 <a name='5001'>
         USTARK = USTAR * VKRM                                                   <a name='5002'>
         AKMS = MAX (USTARK / SIMM,CXCH)                                         <a name='5003'>
<font color=#447700>!-----------------------------------------------------------------------         <a name='5004'></font>
<font color=#447700>! IF STATEMENTS TO AVOID TANGENT LINEAR PROBLEMS NEAR ZERO                       <a name='5005'></font>
<font color=#447700>!-----------------------------------------------------------------------         <a name='5006'></font>
         AKHS = MAX (USTARK / SIMH,CXCH)                                         <a name='5007'>
         IF (BTGH * AKHS * DTHV .ne. 0.0) THEN                                   <a name='5008'>
            WSTAR2 = WWST2* ABS (BTGH * AKHS * DTHV)** (2./3.)                   <a name='5009'>
         ELSE                                                                    <a name='5010'>
            WSTAR2 = 0.0                                                         <a name='5011'>
         END IF                                                                  <a name='5012'>
<font color=#447700>!-----------------------------------------------------------------------         <a name='5013'></font>
         RLMN = ELFC * AKHS * DTHV / USTAR **3                                   <a name='5014'>
<font color=#447700>!-----------------------------------------------------------------------         <a name='5015'></font>
<font color=#447700>!     IF(ABS((RLMN-RLMO)/RLMA).LT.EPSIT)    GO TO 110                            <a name='5016'></font>
<font color=#447700>!-----------------------------------------------------------------------         <a name='5017'></font>
         RLMA = RLMO * WOLD+ RLMN * WNEW                                         <a name='5018'>
<font color=#447700>!-----------------------------------------------------------------------         <a name='5019'></font>
         RLMO = RLMA                                                             <a name='5020'>
<font color=#447700>!     PRINT*,'----------------------------'                                      <a name='5021'></font>
<font color=#447700>!     PRINT*,'SFCDIF OUTPUT !  ! ! ! ! ! ! ! !  !   !    !'                      <a name='5022'></font>
                                                                                 <a name='5023'>
<font color=#447700>!     PRINT*,'ZLM=',ZLM                                                          <a name='5024'></font>
<font color=#447700>!     PRINT*,'Z0=',Z0                                                            <a name='5025'></font>
<font color=#447700>!     PRINT*,'THZ0=',THZ0                                                        <a name='5026'></font>
<font color=#447700>!     PRINT*,'THLM=',THLM                                                        <a name='5027'></font>
<font color=#447700>!     PRINT*,'SFCSPD=',SFCSPD                                                    <a name='5028'></font>
<font color=#447700>!     PRINT*,'CZIL=',CZIL                                                        <a name='5029'></font>
<font color=#447700>!     PRINT*,'AKMS=',AKMS                                                        <a name='5030'></font>
<font color=#447700>!     PRINT*,'AKHS=',AKHS                                                        <a name='5031'></font>
<font color=#447700>!     PRINT*,'----------------------------'                                      <a name='5032'></font>
                                                                                 <a name='5033'>
      END DO                                                                     <a name='5034'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='5035'></font>
  END SUBROUTINE SFCDIF_off<a name='5036'>
<font color=#447700>! ----------------------------------------------------------------------         <a name='5037'></font>
<a name='5038'>
END MODULE module_sf_noahlsm<a name='5039'>
</pre></body></html>