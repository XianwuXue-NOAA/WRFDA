<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_SF_SLAB'><A href='../../html_code/phys/module_sf_slab.F.html#MODULE_SF_SLAB' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_slab</font> <A href='../../call_to/MODULE_SF_SLAB.html' TARGET='index'>2</A><a name='5'>
<a name='6'>
   <font color=#447700>!---SPECIFY CONSTANTS AND LAYERS FOR SOIL MODEL<a name='7'></font>
   <font color=#447700>!---SOIL DIFFUSION CONSTANT SET (M^2/S)<a name='8'></font>
<a name='9'>
   REAL, PARAMETER :: DIFSL=5.e-7<a name='10'>
<a name='11'>
   <font color=#447700>!---FACTOR TO MAKE SOIL STEP MORE CONSERVATIVE<a name='12'></font>
<a name='13'>
   REAL , PARAMETER :: SOILFAC=1.25<a name='14'>
<a name='15'>
CONTAINS<a name='16'>
<a name='17'>
<font color=#447700>!----------------------------------------------------------------<a name='18'></font>
<A NAME='SLAB'><A href='../../html_code/phys/module_sf_slab.F.html#SLAB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='19'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>SLAB</font>(T3D,QV3D,P3D,FLHC,FLQC,                      &amp; <A href='../../call_to/SLAB.html' TARGET='index'>1</A>,<A href='../../call_from/SLAB.html' TARGET='index'>1</A><a name='20'>
                   PSFC,XLAND,TMN,HFX,QFX,LH,TSK,QSFC,CHKLOWQ,  &amp;<a name='21'>
                   GSW,GLW,CAPG,THC,SNOWC,EMISS,MAVAIL,         &amp;<a name='22'>
                   DELTSM,ROVCP,XLV,DTMIN,IFSNOW,               &amp;<a name='23'>
                   SVP1,SVP2,SVP3,SVPT0,EP2,                    &amp;<a name='24'>
                   KARMAN,EOMEG,STBOLT,                         &amp;<a name='25'>
                   TSLB,ZS,DZS,num_soil_layers,radiation,       &amp;<a name='26'>
                   ids,ide, jds,jde, kds,kde,                   &amp;<a name='27'>
                   ims,ime, jms,jme, kms,kme,                   &amp;<a name='28'>
                   its,ite, jts,jte, kts,kte                    )<a name='29'>
<font color=#447700>!----------------------------------------------------------------<a name='30'></font>
    IMPLICIT NONE<a name='31'>
<font color=#447700>!----------------------------------------------------------------<a name='32'></font>
<font color=#447700>!                                                                        <a name='33'></font>
<font color=#447700>!     SUBROUTINE SLAB CALCULATES THE GROUND TEMPERATURE TENDENCY <a name='34'></font>
<font color=#447700>!     ACCORDING TO THE RESIDUAL OF THE SURFACE ENERGY BUDGET           <a name='35'></font>
<font color=#447700>!     (BLACKADAR, 1978B).                                              <a name='36'></font>
<font color=#447700>!                                                                      <a name='37'></font>
<font color=#447700>!     CHANGES:                                                         <a name='38'></font>
<font color=#447700>!          FOR SOIL SUB-TIMESTEPS UPDATE SURFACE HFX AND QFX AS TG     <a name='39'></font>
<font color=#447700>!          CHANGES TO PREVENT POSSIBLE INSTABILITY FOR LONG MODEL      <a name='40'></font>
<font color=#447700>!          STEPS (DT &gt; ~200 SEC).                                      <a name='41'></font>
<font color=#447700>!                                                                      <a name='42'></font>
<font color=#447700>!          PUT SNOW COVER CHECK ON SOIL SUB-TIMESTEPS                  <a name='43'></font>
<font color=#447700>!                                                                      <a name='44'></font>
<font color=#447700>!          MAKE UPPER LIMIT ON SOIL SUB-STEP LENGTH MORE CONSERVATIVE  <a name='45'></font>
<font color=#447700>!                                                                      <a name='46'></font>
<font color=#447700>!----------------------------------------------------------------          <a name='47'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='48'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='49'></font>
<font color=#447700>!-- P3D         3D pressure (Pa)<a name='50'></font>
<font color=#447700>!-- FLHC        exchange coefficient for heat (m/s)<a name='51'></font>
<font color=#447700>!-- FLQC        exchange coefficient for moisture (m/s)<a name='52'></font>
<font color=#447700>!-- PSFC        surface pressure (Pa)<a name='53'></font>
<font color=#447700>!-- XLAND       land mask (1 for land, 2 for water)<a name='54'></font>
<font color=#447700>!-- TMN         soil temperature at lower boundary (K)<a name='55'></font>
<font color=#447700>!-- HFX         upward heat flux at the surface (W/m^2)<a name='56'></font>
<font color=#447700>!-- QFX         upward moisture flux at the surface (kg/m^2/s)<a name='57'></font>
<font color=#447700>!-- LH          latent heat flux at the surface (W/m^2)<a name='58'></font>
<font color=#447700>!-- TSK         surface temperature (K)<a name='59'></font>
<font color=#447700>!-- GSW         downward short wave flux at ground surface (W/m^2)      <a name='60'></font>
<font color=#447700>!-- GLW         downward long wave flux at ground surface (W/m^2)<a name='61'></font>
<font color=#447700>!-- CAPG        heat capacity for soil (J/K/m^3)<a name='62'></font>
<font color=#447700>!-- THC         thermal inertia (Cal/cm/K/s^0.5)<a name='63'></font>
<font color=#447700>!-- SNOWC       flag indicating snow coverage (1 for snow cover)<a name='64'></font>
<font color=#447700>!-- EMISS       surface emissivity (between 0 and 1)<a name='65'></font>
<font color=#447700>!-- DELTSM      time step (second)<a name='66'></font>
<font color=#447700>!-- ROVCP       R/CP<a name='67'></font>
<font color=#447700>!-- XLV         latent heat of melting (J/kg)<a name='68'></font>
<font color=#447700>!-- DTMIN       time step (minute)<a name='69'></font>
<font color=#447700>!-- IFSNOW      ifsnow=1 for snow-cover effects<a name='70'></font>
<font color=#447700>!-- SVP1        constant for saturation vapor pressure (kPa)<a name='71'></font>
<font color=#447700>!-- SVP2        constant for saturation vapor pressure (dimensionless)<a name='72'></font>
<font color=#447700>!-- SVP3        constant for saturation vapor pressure (K)<a name='73'></font>
<font color=#447700>!-- SVPT0       constant for saturation vapor pressure (K)<a name='74'></font>
<font color=#447700>!-- EP1         constant for virtual temperature (R_v/R_d - 1) (dimensionless)<a name='75'></font>
<font color=#447700>!-- EP2         constant for specific humidity calculation <a name='76'></font>
<font color=#447700>!               (R_d/R_v) (dimensionless)<a name='77'></font>
<font color=#447700>!-- KARMAN      Von Karman constant<a name='78'></font>
<font color=#447700>!-- EOMEG       angular velocity of earth's rotation (rad/s)<a name='79'></font>
<font color=#447700>!-- STBOLT      Stefan-Boltzmann constant (W/m^2/K^4)<a name='80'></font>
<font color=#447700>!-- TSLB        soil temperature in 5-layer model<a name='81'></font>
<font color=#447700>!-- ZS          depths of centers of soil layers<a name='82'></font>
<font color=#447700>!-- DZS         thicknesses of soil layers<a name='83'></font>
<font color=#447700>!-- num_soil_layers   the number of soil layers<a name='84'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='85'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='86'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='87'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='88'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='89'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='90'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='91'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='92'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='93'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='94'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='95'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='96'></font>
<font color=#447700>!-- its         start index for i in tile<a name='97'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='98'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='99'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='100'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='101'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='102'></font>
<font color=#447700>!----------------------------------------------------------------<a name='103'></font>
   INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='104'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='105'>
                                    its,ite, jts,jte, kts,kte<a name='106'>
<a name='107'>
   INTEGER, INTENT(IN)       ::     num_soil_layers<a name='108'>
   LOGICAL, INTENT(IN)       ::     radiation<a name='109'>
<a name='110'>
   INTEGER,  INTENT(IN   )   ::     IFSNOW<a name='111'>
<a name='112'>
<font color=#447700>!<a name='113'></font>
   REAL,     INTENT(IN   )   ::     DTMIN,XLV,ROVCP,DELTSM<a name='114'>
<a name='115'>
   REAL,     INTENT(IN )     ::     SVP1,SVP2,SVP3,SVPT0<a name='116'>
   REAL,     INTENT(IN )     ::     EP2,KARMAN,EOMEG,STBOLT<a name='117'>
<a name='118'>
   REAL,     DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), &amp;<a name='119'>
             INTENT(INOUT)   :: TSLB<a name='120'>
<a name='121'>
   REAL,     DIMENSION(1:num_soil_layers), INTENT(IN)::ZS,DZS<a name='122'>
<a name='123'>
   REAL,    DIMENSION( ims:ime, kms:kme, jms:jme )            , &amp;<a name='124'>
            INTENT(IN   )    ::                           QV3D, &amp;<a name='125'>
                                                           P3D, &amp;<a name='126'>
                                                           T3D<a name='127'>
<font color=#447700>!<a name='128'></font>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='129'>
            INTENT(IN   )    ::                          SNOWC, &amp;<a name='130'>
                                                         XLAND, &amp;<a name='131'>
                                                         EMISS, &amp;<a name='132'>
                                                        MAVAIL, &amp;<a name='133'>
                                                           TMN, &amp;<a name='134'>
                                                           GSW, &amp;<a name='135'>
                                                           GLW, &amp;<a name='136'>
                                                           THC<a name='137'>
<a name='138'>
<font color=#447700>!CHKLOWQ is declared as memory size<a name='139'></font>
<font color=#447700>!<a name='140'></font>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='141'>
            INTENT(INOUT)    ::                            HFX, &amp;<a name='142'>
                                                           QFX, &amp;<a name='143'>
                                                            LH, &amp;<a name='144'>
                                                          CAPG, &amp;<a name='145'>
                                                           TSK, &amp;<a name='146'>
                                                          QSFC, &amp;<a name='147'>
                                                       CHKLOWQ<a name='148'>
<a name='149'>
   REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='150'>
             INTENT(IN   )               ::               PSFC<a name='151'>
<font color=#447700>!<a name='152'></font>
   REAL,    DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) ::     &amp;<a name='153'>
                                                          FLHC, &amp;<a name='154'>
                                                          FLQC<a name='155'>
<a name='156'>
<font color=#447700>! LOCAL VARS<a name='157'></font>
<a name='158'>
   REAL,     DIMENSION( its:ite ) ::                      QV1D, &amp;<a name='159'>
                                                           P1D, &amp;<a name='160'>
                                                           T1D<a name='161'>
   INTEGER ::  I,J<a name='162'>
<a name='163'>
   DO J=jts,jte<a name='164'>
<a name='165'>
      DO i=its,ite<a name='166'>
         T1D(i) =T3D(i,1,j)<a name='167'>
         QV1D(i)=QV3D(i,1,j)<a name='168'>
         P1D(i) =P3D(i,1,j)<a name='169'>
      ENDDO<a name='170'>
<a name='171'>
<font color=#447700>! the indices to the PSFC argument in the following call look<a name='172'></font>
<font color=#447700>! wrong; however, it is correct to call with its (and not ims)<a name='173'></font>
<font color=#447700>! because of the way PSFC is defined in SLAB1D. Whether *that*<a name='174'></font>
<font color=#447700>! is a good idea or not, this commenter cannot comment. JM<a name='175'></font>
<a name='176'>
      CALL <A href='../../html_code/phys/module_sf_slab.F.html#SLAB1D'>SLAB1D</A><A href='../../html_code/phys/module_sf_slab.F.html#SLAB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLAB1D_1">(J,T1D,QV1D,P1D,FLHC(ims,j),FLQC(ims,j),       &amp;<a name='177'>
           PSFC(its,j),XLAND(ims,j),TMN(ims,j),HFX(ims,j),      &amp;<a name='178'>
           QFX(ims,j),TSK(ims,j),QSFC(ims,j),CHKLOWQ(ims,j),    &amp;<a name='179'>
           LH(ims,j),GSW(ims,j),GLW(ims,j),                     &amp;<a name='180'>
           CAPG(ims,j),THC(ims,j),SNOWC(ims,j),EMISS(ims,j),    &amp;<a name='181'>
           MAVAIL(ims,j),DELTSM,ROVCP,XLV,DTMIN,IFSNOW,         &amp;<a name='182'>
           SVP1,SVP2,SVP3,SVPT0,EP2,KARMAN,EOMEG,STBOLT,        &amp;<a name='183'>
           TSLB(ims,1,j),ZS,DZS,num_soil_layers,radiation,      &amp;<a name='184'>
           ids,ide, jds,jde, kds,kde,                           &amp;<a name='185'>
           ims,ime, jms,jme, kms,kme,                           &amp;<a name='186'>
           its,ite, jts,jte, kts,kte                            )<a name='187'>
<a name='188'>
   ENDDO<a name='189'>
<a name='190'>
   END SUBROUTINE SLAB<a name='191'>
<a name='192'>
<font color=#447700>!----------------------------------------------------------------<a name='193'></font>
<A NAME='SLAB1D'><A href='../../html_code/phys/module_sf_slab.F.html#SLAB1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='194'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>SLAB1D</font>(J,T1D,QV1D,P1D,FLHC,FLQC,                  &amp; <A href='../../call_to/SLAB1D.html' TARGET='index'>1</A><a name='195'>
                   PSFCPA,XLAND,TMN,HFX,QFX,TSK,QSFC,CHKLOWQ,   &amp;<a name='196'>
                   LH,GSW,GLW,CAPG,THC,SNOWC,EMISS,MAVAIL,      &amp;<a name='197'>
                   DELTSM,ROVCP,XLV,DTMIN,IFSNOW,               &amp;<a name='198'>
                   SVP1,SVP2,SVP3,SVPT0,EP2,                    &amp;<a name='199'>
                   KARMAN,EOMEG,STBOLT,                         &amp;<a name='200'>
                   TSLB2D,ZS,DZS,num_soil_layers,radiation,     &amp;<a name='201'>
                   ids,ide, jds,jde, kds,kde,                   &amp;<a name='202'>
                   ims,ime, jms,jme, kms,kme,                   &amp;<a name='203'>
                   its,ite, jts,jte, kts,kte                    )<a name='204'>
<font color=#447700>!----------------------------------------------------------------<a name='205'></font>
    IMPLICIT NONE<a name='206'>
<font color=#447700>!----------------------------------------------------------------<a name='207'></font>
<font color=#447700>!                                                                        <a name='208'></font>
<font color=#447700>!     SUBROUTINE SLAB CALCULATES THE GROUND TEMPERATURE TENDENCY <a name='209'></font>
<font color=#447700>!     ACCORDING TO THE RESIDUAL OF THE SURFACE ENERGY BUDGET           <a name='210'></font>
<font color=#447700>!     (BLACKADAR, 1978B).                                              <a name='211'></font>
<font color=#447700>!                                                                      <a name='212'></font>
<font color=#447700>!     CHANGES:                                                         <a name='213'></font>
<font color=#447700>!          FOR SOIL SUB-TIMESTEPS UPDATE SURFACE HFX AND QFX AS TG     <a name='214'></font>
<font color=#447700>!          CHANGES TO PREVENT POSSIBLE INSTABILITY FOR LONG MODEL      <a name='215'></font>
<font color=#447700>!          STEPS (DT &gt; ~200 SEC).                                      <a name='216'></font>
<font color=#447700>!                                                                      <a name='217'></font>
<font color=#447700>!          PUT SNOW COVER CHECK ON SOIL SUB-TIMESTEPS                  <a name='218'></font>
<font color=#447700>!                                                                      <a name='219'></font>
<font color=#447700>!          MAKE UPPER LIMIT ON SOIL SUB-STEP LENGTH MORE CONSERVATIVE  <a name='220'></font>
<font color=#447700>!                                                                      <a name='221'></font>
<font color=#447700>!----------------------------------------------------------------          <a name='222'></font>
<a name='223'>
   INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='224'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='225'>
                                    its,ite, jts,jte, kts,kte,J <a name='226'>
<a name='227'>
   INTEGER , INTENT(IN)      ::     num_soil_layers<a name='228'>
   LOGICAL,  INTENT(IN   )   ::     radiation<a name='229'>
<a name='230'>
   INTEGER,  INTENT(IN   )   ::     IFSNOW<a name='231'>
<font color=#447700>!<a name='232'></font>
   REAL,     INTENT(IN   )   ::     DTMIN,XLV,ROVCP,DELTSM<a name='233'>
<a name='234'>
   REAL,     INTENT(IN )     ::     SVP1,SVP2,SVP3,SVPT0<a name='235'>
   REAL,     INTENT(IN )     ::     EP2,KARMAN,EOMEG,STBOLT<a name='236'>
<a name='237'>
   REAL,     DIMENSION( ims:ime , 1:num_soil_layers ),          &amp;<a name='238'>
             INTENT(INOUT)   :: TSLB2D<a name='239'>
<a name='240'>
   REAL,     DIMENSION(1:num_soil_layers), INTENT(IN)::ZS,DZS<a name='241'>
<a name='242'>
<font color=#447700>!<a name='243'></font>
   REAL,    DIMENSION( ims:ime )                              , &amp;<a name='244'>
            INTENT(INOUT)    ::                            HFX, &amp;<a name='245'>
                                                           QFX, &amp;<a name='246'>
                                                            LH, &amp;<a name='247'>
                                                          CAPG, &amp;<a name='248'>
                                                           TSK, &amp;<a name='249'>
                                                          QSFC, &amp;<a name='250'>
                                                       CHKLOWQ<a name='251'>
<font color=#447700>!<a name='252'></font>
   REAL,    DIMENSION( ims:ime )                              , &amp;<a name='253'>
            INTENT(IN   )    ::                          SNOWC, &amp;<a name='254'>
                                                         XLAND, &amp;<a name='255'>
                                                         EMISS, &amp;<a name='256'>
                                                        MAVAIL, &amp;<a name='257'>
                                                           TMN, &amp;<a name='258'>
                                                           GSW, &amp;<a name='259'>
                                                           GLW, &amp;<a name='260'>
                                                           THC<a name='261'>
<font color=#447700>!<a name='262'></font>
   REAL,    DIMENSION( its:ite )                              , &amp;<a name='263'>
            INTENT(IN   )    ::                           QV1D, &amp;<a name='264'>
                                                           P1D, &amp;<a name='265'>
                                                           T1D<a name='266'>
<font color=#447700>!<a name='267'></font>
   REAL,     DIMENSION( its:ite )                             , &amp;<a name='268'>
             INTENT(IN   )               ::             PSFCPA<a name='269'>
<a name='270'>
<font color=#447700>!<a name='271'></font>
   REAL,    DIMENSION( ims:ime ), INTENT(INOUT) ::              &amp;<a name='272'>
                                                          FLHC, &amp;<a name='273'>
                                                          FLQC<a name='274'>
<font color=#447700>! LOCAL VARS<a name='275'></font>
<a name='276'>
   REAL,    DIMENSION( its:ite )          ::              PSFC<a name='277'>
<a name='278'>
   REAL,    DIMENSION( its:ite )          ::                    &amp;<a name='279'>
                                                           THX, &amp;<a name='280'>
                                                            QX, &amp;<a name='281'>
                                                          SCR3 <a name='282'>
<a name='283'>
   REAL,    DIMENSION( its:ite )          ::            DTHGDT, &amp;<a name='284'>
                                                           TG0, &amp;<a name='285'>
                                                         THTMN, &amp;<a name='286'>
                                                          XLD1, &amp;<a name='287'>
                                                         TSCVN, &amp;<a name='288'>
                                                          OLTG, &amp;<a name='289'>
                                                        UPFLUX, &amp;<a name='290'>
                                                            HM, &amp;<a name='291'>
                                                          RNET, &amp;<a name='292'>
                                                         XINET, &amp;<a name='293'>
                                                            QS, &amp;<a name='294'>
                                                         DTSDT<a name='295'>
<font color=#447700>!<a name='296'></font>
   REAL, DIMENSION( its:ite, num_soil_layers )        :: FLUX<a name='297'>
<font color=#447700>!<a name='298'></font>
   INTEGER :: I,K,NSOIL,ITSOIL,L,NK,RADSWTCH<a name='299'>
   REAL    :: PS,PS1,XLDCOL,TSKX,RNSOIL,RHOG1,RHOG2,RHOG3,LAMDAG<a name='300'>
   REAL    :: THG,ESG,QSG,HFXT,QFXT,CS,CSW,LAMG(4),THCON,PL<a name='301'>
 <a name='302'>
<font color=#447700>!----------------------------------------------------------------------          <a name='303'></font>
<font color=#447700>!-----DETERMINE IF ANY POINTS IN COLUMN ARE LAND (RATHER THAN OCEAN)             <a name='304'></font>
<font color=#447700>!       POINTS.  IF NOT, SKIP DOWN TO THE PRINT STATEMENTS SINCE OCEAN           <a name='305'></font>
<font color=#447700>!       SURFACE TEMPERATURES ARE NOT ALLOWED TO CHANGE.                          <a name='306'></font>
<font color=#447700>!                                                                                <a name='307'></font>
<font color=#447700>! from sfcrad   <a name='308'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='309'></font>
   DATA CSW/4.183E6/<a name='310'>
   DATA LAMG/1.407E-8, -1.455E-5, 6.290E-3, 0.16857/<a name='311'>
<a name='312'>
   DO i=its,ite<a name='313'>
<font color=#447700>! in cmb<a name='314'></font>
      PSFC(I)=PSFCPA(I)/1000.<a name='315'>
   ENDDO<a name='316'>
<a name='317'>
<a name='318'>
      DO I=its,ite<a name='319'>
<font color=#447700>! PL cmb<a name='320'></font>
         PL=P1D(I)/1000.<a name='321'>
         SCR3(I)=T1D(I)<a name='322'>
         THCON=(100./PL)**ROVCP<a name='323'>
         THX(I)=SCR3(I)*THCON<a name='324'>
         QX(I)=0.<a name='325'>
      ENDDO<a name='326'>
<a name='327'>
<font color=#447700>!     IF(IDRY.EQ.1) GOTO 81<a name='328'></font>
      DO I=its,ite<a name='329'>
         QX(I)=QV1D(I)<a name='330'>
      ENDDO<a name='331'>
   81 CONTINUE<a name='332'>
<a name='333'>
<font color=#447700>!<a name='334'></font>
<font color=#447700>!-----THE SLAB THERMAL CAPACITY CAPG(I) ARE DEPENDENT ON:<a name='335'></font>
<font color=#447700>!     THC(I) - SOIL THERMAL INERTIAL, ONLY.<a name='336'></font>
<font color=#447700>!<a name='337'></font>
      DO I=its,ite<a name='338'>
         CAPG(I)=3.298E6*THC(I)<a name='339'>
         IF(num_soil_layers .gt. 1)THEN<a name='340'>
<a name='341'>
<font color=#447700>! CAPG REPRESENTS SOIL HEAT CAPACITY (J/K/M^3) WHEN DIFSL=5.E-7 (M^2/S)<a name='342'></font>
<font color=#447700>! TO GIVE A CORRECT THERMAL INERTIA (=CAPG*DIFSL^0.5)<a name='343'></font>
<a name='344'>
            CAPG(I)=5.9114E7*THC(I)<a name='345'>
         ENDIF<a name='346'>
      ENDDO<a name='347'>
<font color=#447700>!        <a name='348'></font>
      XLDCOL=2.0                                                                 <a name='349'>
      DO 10 I=its,ite<a name='350'>
        XLDCOL=AMIN1(XLDCOL,XLAND(I))                                          <a name='351'>
   10 CONTINUE                                                                   <a name='352'>
<font color=#447700>!                                                                                <a name='353'></font>
      IF(XLDCOL.GT.1.5)GOTO 90                                                   <a name='354'>
<font color=#447700>!                                                                                <a name='355'></font>
<font color=#447700>!                                                                                <a name='356'></font>
<font color=#447700>!-----CONVERT SLAB TEMPERATURE TO POTENTIAL TEMPERATURE AND                      <a name='357'></font>
<font color=#447700>!     SET XLD1(I) = 0. FOR OCEAN POINTS:                                         <a name='358'></font>
<font color=#447700>!                                                                                <a name='359'></font>
<font color=#447700>!                                                                                <a name='360'></font>
      DO 20 I=its,ite<a name='361'>
        IF((XLAND(I)-1.5).GE.0)THEN                                            <a name='362'>
          XLD1(I)=0.                                                             <a name='363'>
        ELSE                                                                     <a name='364'>
          XLD1(I)=1.                                                             <a name='365'>
        ENDIF                                                                    <a name='366'>
   20 CONTINUE                                                                   <a name='367'>
<font color=#447700>!                                                                                <a name='368'></font>
<font color=#447700>!-----CONVERT 'TSK(THETAG)' TO 'TG' FOR 'IUP' CALCULATION ....                   <a name='369'></font>
<font color=#447700>!       IF WE ARE USING THE BLACKADAR MULTI-LEVEL (HIGH-RESOLUTION)              <a name='370'></font>
<font color=#447700>!       PBL MODEL                                                                <a name='371'></font>
<font color=#447700>!                                                                                <a name='372'></font>
      DO 50 I=its,ite<a name='373'>
        IF(XLD1(I).LT.0.5)GOTO 50                                                <a name='374'>
<a name='375'>
<font color=#447700>! PS cmb<a name='376'></font>
        PS=PSFC(I)<a name='377'>
<a name='378'>
<font color=#447700>! TSK is Temperature at gound sfc<a name='379'></font>
<font color=#447700>!       TG0(I)=TSK(I)*(PS*0.01)**ROVCP                                         <a name='380'></font>
        TG0(I)=TSK(I)<a name='381'>
   50 CONTINUE                                                                   <a name='382'>
<font color=#447700>!                                                                                <a name='383'></font>
<font color=#447700>!-----COMPUTE THE SURFACE ENERGY BUDGET:                                         <a name='384'></font>
<font color=#447700>!                                                                                <a name='385'></font>
<font color=#447700>!     IF(ISOIL.EQ.1)NSOIL=1                                                      <a name='386'></font>
      IF(num_soil_layers .gt. 1)NSOIL=1                                                      <a name='387'>
<a name='388'>
<a name='389'>
      IF (radiation) then<a name='390'>
        RADSWTCH=1<a name='391'>
      ELSE<a name='392'>
        RADSWTCH=0<a name='393'>
      ENDIF<a name='394'>
<a name='395'>
      DO 70 I=its,ite<a name='396'>
        IF(XLD1(I).LT.0.5)GOTO 70<a name='397'>
        OLTG(I)=TSK(I)*(100./PSFC(I))**ROVCP<a name='398'>
        UPFLUX(I)=RADSWTCH*STBOLT*TG0(I)**4                            <a name='399'>
        XINET(I)=EMISS(I)*(GLW(I)-UPFLUX(I))    <a name='400'>
        RNET(I)=GSW(I)+XINET(I)                                                <a name='401'>
        HM(I)=1.18*EOMEG*(TG0(I)-TMN(I))                                       <a name='402'>
<font color=#447700>!       MOISTURE FLUX CALCULATED HERE (OVERWRITES SFC LAYER VALUE FOR LAND)<a name='403'></font>
                ESG=SVP1*EXP(SVP2*(TG0(I)-SVPT0)/(TG0(I)-SVP3))<a name='404'>
                QSG=EP2*ESG/(PSFC(I)-ESG)<a name='405'>
                QFX(I)=FLQC(I)*(QSG-QX(I))<a name='406'>
                LH(I)=QFX(I)*XLV<a name='407'>
        QS(I)=HFX(I)+QFX(I)*XLV                                <a name='408'>
<font color=#447700>!       IF(ISOIL.EQ.0)THEN                                                       <a name='409'></font>
        IF(num_soil_layers .EQ. 1)THEN                                                       <a name='410'>
          DTHGDT(I)=(RNET(I)-QS(I))/CAPG(I)-HM(I)                              <a name='411'>
        ELSE<a name='412'>
          DTHGDT(I)=0.                                                           <a name='413'>
        ENDIF                                                                    <a name='414'>
   70 CONTINUE                                                                   <a name='415'>
<font color=#447700>!     IF(ISOIL.EQ.1)THEN                                                         <a name='416'></font>
      IF(num_soil_layers .gt. 1)THEN                                                         <a name='417'>
        NSOIL=1+IFIX(SOILFAC*4*DIFSL/DZS(1)*DELTSM/DZS(1))   <a name='418'>
        RNSOIL=1./FLOAT(NSOIL)                                                   <a name='419'>
<font color=#447700>!                                                                                <a name='420'></font>
<font color=#447700>!     SOIL SUB-TIMESTEP                                                          <a name='421'></font>
<font color=#447700>!                                                                                <a name='422'></font>
        DO ITSOIL=1,NSOIL                                                        <a name='423'>
          DO I=its,ite<a name='424'>
             DO L=1,num_soil_layers-1<a name='425'>
              IF(XLD1(I).LT.0.5)GOTO 75                                          <a name='426'>
              IF(L.EQ.1.AND.ITSOIL.GT.1)THEN                                     <a name='427'>
                PS1=(PSFC(I)*0.01)**ROVCP    <a name='428'>
<a name='429'>
<font color=#447700>! for rk scheme A and B are the same<a name='430'></font>
                PS=PSFC(I)<a name='431'>
                THG=TSLB2D(I,1)/PS1                                              <a name='432'>
                ESG=SVP1*EXP(SVP2*(TSLB2D(I,1)-SVPT0)/(TSLB2D(I,1) &amp; <a name='433'>
                    -SVP3))                                                      <a name='434'>
                QSG=EP2*ESG/(PS-ESG)                                             <a name='435'>
<font color=#447700>!     UPDATE FLUXES FOR NEW GROUND TEMPERATURE                                   <a name='436'></font>
                HFXT=FLHC(I)*(THG-THX(I))                                     <a name='437'>
                QFXT=FLQC(I)*(QSG-QX(I))<a name='438'>
                QS(I)=HFXT+QFXT*XLV                                <a name='439'>
<font color=#447700>!     SUM HFX AND QFX OVER SOIL TIMESTEPS                                        <a name='440'></font>
                HFX(I)=HFX(I)+HFXT                                           <a name='441'>
                QFX(I)=QFX(I)+QFXT                                           <a name='442'>
              ENDIF                                                              <a name='443'>
              FLUX(I,1)=RNET(I)-QS(I)                                            <a name='444'>
              FLUX(I,L+1)=-DIFSL*CAPG(I)*(TSLB2D(I,L+1)-TSLB2D(I,L))/( &amp; <a name='445'>
                          ZS(L+1)-ZS(L))                                         <a name='446'>
              DTSDT(I)=-(FLUX(I,L+1)-FLUX(I,L))/(DZS(L)*CAPG(I))               <a name='447'>
              TSLB2D(I,L)=TSLB2D(I,L)+DTSDT(I)*DELTSM*RNSOIL                     <a name='448'>
              IF(IFSNOW.EQ.1.AND.L.EQ.1)THEN                              <a name='449'>
                IF((SNOWC(I).GT.0..AND.TSLB2D(I,1).GT.273.16))THEN             <a name='450'>
                  TSLB2D(I,1)=273.16                                             <a name='451'>
                ENDIF                                                            <a name='452'>
              ENDIF                                                              <a name='453'>
              IF(L.EQ.1)DTHGDT(I)=DTHGDT(I)+RNSOIL*DTSDT(I)                      <a name='454'>
              IF(ITSOIL.EQ.NSOIL.AND.L.EQ.1)THEN                                 <a name='455'>
<font color=#447700>!     AVERAGE HFX AND QFX OVER SOIL TIMESTEPS FOR OUTPUT TO PBL                  <a name='456'></font>
                HFX(I)=HFX(I)*RNSOIL                                         <a name='457'>
                QFX(I)=QFX(I)*RNSOIL                                         <a name='458'>
                LH(I)=QFX(I)*XLV<a name='459'>
              ENDIF                                                              <a name='460'>
   75         CONTINUE                                                           <a name='461'>
            ENDDO                                                                <a name='462'>
          ENDDO                                                                  <a name='463'>
        ENDDO                                                                    <a name='464'>
      ENDIF                                                                      <a name='465'>
<font color=#447700>!                                                                                <a name='466'></font>
      DO 80 I=its,ite<a name='467'>
        IF(XLD1(I).LT.0.5) GOTO 80                                                <a name='468'>
        TSKX=TG0(I)+DELTSM*DTHGDT(I)                                             <a name='469'>
<a name='470'>
<font color=#447700>! TSK is temperature<a name='471'></font>
<font color=#447700>!       TSK(I)=TSKX*(100./PS1)**ROVCP                                          <a name='472'></font>
        TSK(I)=TSKX<a name='473'>
   80 CONTINUE                                                                   <a name='474'>
<a name='475'>
<font color=#447700>!                                                                                <a name='476'></font>
<font color=#447700>!-----MODIFY THE THE GROUND TEMPERATURE IF THE SNOW COVER EFFECTS ARE            <a name='477'></font>
<font color=#447700>!     CONSIDERED: LIMIT THE GROUND TEMPERATURE UNDER 0 C.                        <a name='478'></font>
<font color=#447700>!                                                                                <a name='479'></font>
      IF(IFSNOW.EQ.0)GOTO 90                                              <a name='480'>
      DO 85 I=its,ite<a name='481'>
        IF(XLD1(I).LT.0.5)GOTO 85                                                <a name='482'>
<font color=#447700>!       PS1=(PSFC(I)*0.01)**ROVCP             <a name='483'></font>
<font color=#447700>!       TSCVN(I)=TSK(I)*PS1                                            <a name='484'></font>
        TSCVN(I)=TSK(I)<a name='485'>
        IF((SNOWC(I).GT.0..AND.TSCVN(I).GT.273.16))THEN                        <a name='486'>
          TSCVN(I)=273.16                                                        <a name='487'>
        ELSE                                                                     <a name='488'>
          TSCVN(I)=TSCVN(I)                                                      <a name='489'>
        ENDIF                                                                    <a name='490'>
<font color=#447700>!       TSK(I)=TSCVN(I)/PS1                                                    <a name='491'></font>
        TSK(I)=TSCVN(I)<a name='492'>
   85 CONTINUE                                                                   <a name='493'>
<font color=#447700>!                                                                                <a name='494'></font>
   90 CONTINUE                                                                   <a name='495'>
      DO I=its,ite<a name='496'>
<font color=#447700>! QSFC and CHKLOWQ needed by Eta PBL<a name='497'></font>
        QSFC(I)=QX(I)+QFX(I)/FLQC(I)<a name='498'>
        CHKLOWQ(I)=MAVAIL(I)<a name='499'>
      ENDDO<a name='500'>
<font color=#447700>!                                                                                <a name='501'></font>
  140 CONTINUE                                                                   <a name='502'>
<a name='503'>
   END SUBROUTINE SLAB1D<a name='504'>
<a name='505'>
<font color=#447700>!================================================================<a name='506'></font>
<A NAME='SLABINIT'><A href='../../html_code/phys/module_sf_slab.F.html#SLABINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='507'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>slabinit</font>(TSK,TMN,                                 &amp; <A href='../../call_to/SLABINIT.html' TARGET='index'>1</A><a name='508'>
                       TSLB,ZS,DZS,num_soil_layers,             &amp;<a name='509'>
                       restart, allowed_to_read,                &amp;<a name='510'>
                       ids,ide, jds,jde, kds,kde,               &amp;<a name='511'>
                       ims,ime, jms,jme, kms,kme,               &amp;<a name='512'>
                       its,ite, jts,jte, kts,kte                )<a name='513'>
<font color=#447700>!----------------------------------------------------------------<a name='514'></font>
   IMPLICIT NONE<a name='515'>
<font color=#447700>!----------------------------------------------------------------<a name='516'></font>
   LOGICAL , INTENT(IN)      ::      restart, allowed_to_read<a name='517'>
   INTEGER, INTENT(IN   )    ::      ids,ide, jds,jde, kds,kde, &amp;<a name='518'>
                                     ims,ime, jms,jme, kms,kme, &amp;<a name='519'>
                                     its,ite, jts,jte, kts,kte<a name='520'>
<a name='521'>
   INTEGER, INTENT(IN   )    ::      num_soil_layers<a name='522'>
<font color=#447700>!   <a name='523'></font>
   REAL,     DIMENSION( ims:ime , 1:num_soil_layers , jms:jme ), INTENT(INOUT) :: TSLB<a name='524'>
<a name='525'>
   REAL,     DIMENSION(1:num_soil_layers), INTENT(IN)  ::  ZS,DZS<a name='526'>
<a name='527'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='528'>
            INTENT(IN)    ::                            TSK, &amp;<a name='529'>
                                                           TMN<a name='530'>
<font color=#447700>!  LOCAR VAR<a name='531'></font>
<a name='532'>
   INTEGER                   ::      L,J,I,itf,jtf<a name='533'>
<font color=#447700>!----------------------------------------------------------------<a name='534'></font>
 <a name='535'>
   itf=min0(ite,ide-1)<a name='536'>
   jtf=min0(jte,jde-1)<a name='537'>
<a name='538'>
   END SUBROUTINE slabinit<a name='539'>
<a name='540'>
<font color=#447700>!-------------------------------------------------------------------          <a name='541'></font>
<a name='542'>
END MODULE module_sf_slab<a name='543'>
</pre></body></html>