<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='MODULE_CU_GD'><A href='../../html_code/phys/module_cu_gd.F.html#MODULE_CU_GD' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_gd</font> <A href='../../call_to/MODULE_CU_GD.html' TARGET='index'>2</A><a name='6'>
<a name='7'>
CONTAINS<a name='8'>
<a name='9'>
<font color=#447700>!-------------------------------------------------------------<a name='10'></font>
<A NAME='GRELLDRV'><A href='../../html_code/phys/module_cu_gd.F.html#GRELLDRV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='11'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>GRELLDRV</font>(                                         &amp; <A href='../../call_to/GRELLDRV.html' TARGET='index'>1</A>,<A href='../../call_from/GRELLDRV.html' TARGET='index'>2</A><a name='12'>
               DT,itimestep,DX                                  &amp;<a name='13'>
              ,rho,RAINCV                                       &amp;<a name='14'>
              ,U,V,t,W,q,p,pi                                   &amp;<a name='15'>
              ,dz8w,XLV,CP,G,r_v                                &amp;<a name='16'>
              ,STEPCU                                           &amp;<a name='17'>
              ,CU_ACT_FLAG,warm_rain                            &amp;<a name='18'>
              ,APR_GR,APR_W,APR_MC,APR_ST,APR_AS                &amp;<a name='19'>
              ,APR_CAPMA,APR_CAPME,APR_CAPMI                    &amp;<a name='20'>
              ,MASS_FLUX,XF_ENS,PR_ENS,HT                       &amp;<a name='21'>
              ,ensdim,maxiens,maxens,maxens2,maxens3            &amp;<a name='22'>
              ,ids,ide, jds,jde, kds,kde                        &amp;<a name='23'>
              ,ims,ime, jms,jme, kms,kme                        &amp;<a name='24'>
              ,its,ite, jts,jte, kts,kte                        &amp;<a name='25'>
              ,RQVCUTEN,RQCCUTEN,RQICUTEN                       &amp;<a name='26'>
              ,RQVFTEN,RQVBLTEN                                 &amp;<a name='27'>
              ,RTHFTEN,RTHCUTEN,RTHRATEN,RTHBLTEN               &amp;<a name='28'>
              ,F_QV    ,F_QC    ,F_QR    ,F_QI    ,F_QS         &amp;<a name='29'>
                                                                )<a name='30'>
<font color=#447700>!-------------------------------------------------------------<a name='31'></font>
   IMPLICIT NONE<a name='32'>
<font color=#447700>!-------------------------------------------------------------<a name='33'></font>
   INTEGER,      INTENT(IN   ) ::                               &amp;<a name='34'>
                                  ids,ide, jds,jde, kds,kde,    &amp; <a name='35'>
                                  ims,ime, jms,jme, kms,kme,    &amp; <a name='36'>
                                  its,ite, jts,jte, kts,kte<a name='37'>
<a name='38'>
   integer, intent (in   )              ::                      &amp;<a name='39'>
                       ensdim,maxiens,maxens,maxens2,maxens3<a name='40'>
  <a name='41'>
   INTEGER,      INTENT(IN   ) :: STEPCU, ITIMESTEP<a name='42'>
   LOGICAL,      INTENT(IN   ) :: warm_rain<a name='43'>
<a name='44'>
   REAL,         INTENT(IN   ) :: XLV, R_v<a name='45'>
   REAL,         INTENT(IN   ) :: CP,G<a name='46'>
<a name='47'>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         ,    &amp;<a name='48'>
          INTENT(IN   ) ::                                      &amp;<a name='49'>
                                                          U,    &amp;<a name='50'>
                                                          V,    &amp;<a name='51'>
                                                          W,    &amp;<a name='52'>
                                                         pi,    &amp;<a name='53'>
                                                          t,    &amp;<a name='54'>
                                                          q,    &amp;<a name='55'>
                                                          p,    &amp;<a name='56'>
                                                       dz8w,    &amp;<a name='57'>
                                                        rho<a name='58'>
<a name='59'>
<a name='60'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN) ::   HT<a name='61'>
<font color=#447700>!<a name='62'></font>
   REAL, INTENT(IN   ) :: DT, DX<a name='63'>
<font color=#447700>!<a name='64'></font>
<a name='65'>
   REAL, DIMENSION( ims:ime , jms:jme ),                        &amp;<a name='66'>
         INTENT(INOUT) ::                 RAINCV, MASS_FLUX,    &amp;<a name='67'>
                          APR_GR,APR_W,APR_MC,APR_ST,APR_AS,    &amp;<a name='68'>
                              APR_CAPMA,APR_CAPME,APR_CAPMI<a name='69'>
<font color=#447700>!+lxz<a name='70'></font>
   REAL, DIMENSION( ims:ime , jms:jme ) :: &amp; <font color=#447700>!, INTENT(INOUT) ::       &amp;<a name='71'></font>
         HTOP,     &amp;<font color=#447700>! highest model layer penetrated by cumulus since last reset in radiation_driver<a name='72'></font>
         HBOT       <font color=#447700>! lowest  model layer penetrated by cumulus since last reset in radiation_driver<a name='73'></font>
                    <font color=#447700>! HBOT&gt;HTOP follow physics leveling convention<a name='74'></font>
<a name='75'>
   LOGICAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='76'>
         INTENT(INOUT) ::                       CU_ACT_FLAG<a name='77'>
<a name='78'>
<font color=#447700>!<a name='79'></font>
<font color=#447700>! Optionals<a name='80'></font>
<font color=#447700>!<a name='81'></font>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),              &amp;<a name='82'>
         OPTIONAL,                                              &amp;<a name='83'>
         INTENT(INOUT) ::                           RTHFTEN,    &amp;<a name='84'>
                                                    RQVFTEN<a name='85'>
<a name='86'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),              &amp;<a name='87'>
         OPTIONAL,                                              &amp;<a name='88'>
         INTENT(IN   ) ::                                       &amp;<a name='89'>
                                                   RTHRATEN,    &amp;<a name='90'>
                                                   RTHBLTEN,    &amp;<a name='91'>
                                                   RQVBLTEN<a name='92'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),              &amp;<a name='93'>
         OPTIONAL,                                              &amp;<a name='94'>
         INTENT(INOUT) ::                                       &amp;<a name='95'>
                                                   RTHCUTEN,    &amp;<a name='96'>
                                                   RQVCUTEN,    &amp;<a name='97'>
                                                   RQCCUTEN,    &amp;<a name='98'>
                                                   RQICUTEN<a name='99'>
<font color=#447700>!<a name='100'></font>
<font color=#447700>! Flags relating to the optional tendency arrays declared above<a name='101'></font>
<font color=#447700>! Models that carry the optional tendencies will provdide the<a name='102'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='103'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in<a name='104'></font>
<font color=#447700>! use or not.<a name='105'></font>
<font color=#447700>!<a name='106'></font>
   LOGICAL, OPTIONAL ::                                      &amp;<a name='107'>
                                                   F_QV      &amp;<a name='108'>
                                                  ,F_QC      &amp;<a name='109'>
                                                  ,F_QR      &amp;<a name='110'>
                                                  ,F_QI      &amp;<a name='111'>
                                                  ,F_QS<a name='112'>
<a name='113'>
<a name='114'>
<a name='115'>
<font color=#447700>! LOCAL VARS<a name='116'></font>
     real,    dimension ( ims:ime , jms:jme , 1:ensdim) ::      &amp;<a name='117'>
        massfln,xf_ens,pr_ens<a name='118'>
     real,    dimension (its:ite,kts:kte) ::                    &amp;<a name='119'>
        OUTT,OUTQ,OUTQC<a name='120'>
     real,    dimension (its:ite)         ::                    &amp;<a name='121'>
        pret, ter11, aa0<a name='122'>
<font color=#447700>!+lxz<a name='123'></font>
     integer, dimension (its:ite) ::                            &amp;<a name='124'>
        kbcon, ktop<a name='125'>
<font color=#447700>!.lxz<a name='126'></font>
     integer, dimension (its:ite,jts:jte) ::                    &amp;<a name='127'>
        iact_old_gr<a name='128'>
     integer :: ichoice,iens,ibeg,iend,jbeg,jend<a name='129'>
<a name='130'>
<font color=#447700>!<a name='131'></font>
<font color=#447700>! basic environmental input includes moisture convergence (mconv)<a name='132'></font>
<font color=#447700>! omega (omeg), windspeed (us,vs), and a flag (aaeq) to turn off<a name='133'></font>
<font color=#447700>! convection for this call only and at that particular gridpoint<a name='134'></font>
<font color=#447700>!<a name='135'></font>
     real,    dimension (its:ite,kts:kte) ::                    &amp;<a name='136'>
        T2d,TN,q2d,qo,PO,P2d,US,VS,omeg<a name='137'>
     real, dimension (its:ite)            ::                    &amp;<a name='138'>
        Z1,PSUR,AAEQ,direction,mconv,cuten,umean,vmean,pmean<a name='139'>
<a name='140'>
   INTEGER :: i,j,k,ICLDCK,ipr,jpr<a name='141'>
   REAL    :: tcrit,dp,dq<a name='142'>
   INTEGER :: itf,jtf,ktf<a name='143'>
   REAL    :: rkbcon,rktop        <font color=#447700>!-lxz<a name='144'></font>
<a name='145'>
   ichoice=0<a name='146'>
   iens=1<a name='147'>
   ipr=0<a name='148'>
   jpr=0<a name='149'>
   jbeg=min(jds+1,jts)<a name='150'>
   jend=max(jde-2,jte)<a name='151'>
   ibeg=min(ids+1,its)<a name='152'>
   iend=max(ide-2,ite)<a name='153'>
   tcrit=258.<a name='154'>
<a name='155'>
   itf=MIN(ite,ide-1)<a name='156'>
   ktf=MIN(kte,kde-1)<a name='157'>
   jtf=MIN(jte,jde-1)<a name='158'>
<font color=#447700>!                                                                      <a name='159'></font>
     DO 100 J = jts,jtf  <a name='160'>
     DO I= its,itf<a name='161'>
        iact_old_gr(i,j)=0<a name='162'>
        mass_flux(i,j)=0.<a name='163'>
        raincv(i,j)=0.<a name='164'>
        CU_ACT_FLAG(i,j) = .true.<a name='165'>
     ENDDO<a name='166'>
     DO k=1,ensdim<a name='167'>
     DO I= its,itf<a name='168'>
        massfln(i,j,k)=0.<a name='169'>
     ENDDO<a name='170'>
     ENDDO<a name='171'>
     DO k= kts,ktf<a name='172'>
     DO I= its,itf<a name='173'>
        RTHFTEN(i,k,j)=(RTHFTEN(i,k,j)+RTHRATEN(i,k,j)+RTHBLTEN(i,k,j))*pi(i,k,j)<a name='174'>
        RQVFTEN(i,k,j)=RQVFTEN(i,k,j)+RQVBLTEN(i,k,j)<a name='175'>
     ENDDO<a name='176'>
     ENDDO<a name='177'>
     DO I=ITS,ITF<a name='178'>
         PSUR(I)=p(I,1,J)*.01<a name='179'>
         TER11(I)=HT(i,j)<a name='180'>
         mconv(i)=0.<a name='181'>
         aaeq(i)=0.<a name='182'>
         direction(i)=0.<a name='183'>
         pret(i)=0.<a name='184'>
         umean(i)=0.<a name='185'>
         vmean(i)=0.<a name='186'>
         pmean(i)=0.<a name='187'>
     ENDDO<a name='188'>
     DO K=kts,ktf<a name='189'>
     DO I=ITS,ITF<a name='190'>
         omeg(i,k)=0.<a name='191'>
         po(i,k)=p(i,k,j)*.01<a name='192'>
         P2d(I,K)=PO(i,k)<a name='193'>
         US(I,K) =u(i,k,j)<a name='194'>
         VS(I,K) =v(i,k,j)<a name='195'>
         T2d(I,K)=t(i,k,j)<a name='196'>
         q2d(I,K)=q(i,k,j)<a name='197'>
         omeg(I,K)= -g*rho(i,k,j)*w(i,k,j)<a name='198'>
         TN(I,K)=t2d(i,k)+RTHFTEN(i,k,j)*dt<a name='199'>
         IF(TN(I,K).LT.200.)TN(I,K)=T2d(I,K)<a name='200'>
         QO(I,K)=q2d(i,k)+RQVFTEN(i,k,j)*dt<a name='201'>
         IF(Q2d(I,K).LT.1.E-08)Q2d(I,K)=1.E-08<a name='202'>
         IF(QO(I,K).LT.1.E-08)QO(I,K)=1.E-08<a name='203'>
         OUTT(I,K)=0.<a name='204'>
         OUTQ(I,K)=0.<a name='205'>
         OUTQC(I,K)=0.<a name='206'>
<font color=#447700>!        RTHFTEN(i,k,j)=0.<a name='207'></font>
<font color=#447700>!        RQVFTEN(i,k,j)=0.<a name='208'></font>
     ENDDO<a name='209'>
     ENDDO<a name='210'>
      do k=  kts+1,ktf-1<a name='211'>
      DO I = its,itf<a name='212'>
         if((p2d(i,1)-p2d(i,k)).gt.150.and.p2d(i,k).gt.300)then<a name='213'>
            dp=-.5*(p2d(i,k+1)-p2d(i,k-1))<a name='214'>
            umean(i)=umean(i)+us(i,k)*dp<a name='215'>
            vmean(i)=vmean(i)+vs(i,k)*dp<a name='216'>
            pmean(i)=pmean(i)+dp<a name='217'>
         endif<a name='218'>
      enddo<a name='219'>
      enddo<a name='220'>
      DO I = its,itf<a name='221'>
         umean(i)=umean(i)/pmean(i)<a name='222'>
         vmean(i)=vmean(i)/pmean(i)<a name='223'>
         direction(i)=(atan2(umean(i),vmean(i))+3.1415926)*57.29578<a name='224'>
         if(direction(i).gt.360.)direction(i)=direction(i)-360.<a name='225'>
      ENDDO<a name='226'>
      DO K=kts,ktf-1<a name='227'>
      DO I = its,itf<a name='228'>
        dq=(q2d(i,k+1)-q2d(i,k))<a name='229'>
        mconv(i)=mconv(i)+omeg(i,k)*dq/g<a name='230'>
      ENDDO<a name='231'>
      ENDDO<a name='232'>
      DO I = its,itf<a name='233'>
        if(mconv(i).lt.0.)mconv(i)=0.<a name='234'>
        if(i.eq.ipr.and.j.eq.jpr)then<a name='235'>
<font color=#447700>!        do k=kts,ktf<a name='236'></font>
<font color=#447700>!          print *,'2',tn(i,k),qo(i,k),pi(i,k,j),po(i,k)<a name='237'></font>
<font color=#447700>!        enddo<a name='238'></font>
<font color=#447700>!        print *,mconv(i)<a name='239'></font>
        endif<a name='240'>
      ENDDO<a name='241'>
<font color=#447700>!<a name='242'></font>
<font color=#447700>!---- CALL CUMULUS PARAMETERIZATION<a name='243'></font>
<font color=#447700>!<a name='244'></font>
      CALL <A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS'>CUP_enss</A><A href='../../html_code/phys/module_cu_gd.F.html#GRELLDRV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENSS_1">(outqc,j,AAEQ,T2d,Q2d,TER11,TN,QO,PO,PRET,     &amp;<a name='245'>
           P2d,OUTT,OUTQ,DT,PSUR,US,VS,tcrit,iens,                &amp;<a name='246'>
           mconv,massfln,iact_old_gr,omeg,direction,MASS_FLUX,    &amp;<a name='247'>
           maxiens,maxens,maxens2,maxens3,ensdim,                 &amp;<a name='248'>
           APR_GR,APR_W,APR_MC,APR_ST,APR_AS,                     &amp;<a name='249'>
           APR_CAPMA,APR_CAPME,APR_CAPMI,kbcon,ktop,              &amp;<a name='250'>
           xf_ens,pr_ens,                                         &amp;<a name='251'>
           xlv,r_v,cp,g,ichoice,ipr,jpr,                          &amp;<a name='252'>
           ids,ide, jds,jde, kds,kde,                             &amp;<a name='253'>
           ims,ime, jms,jme, kms,kme,                             &amp;<a name='254'>
           its,ite, jts,jte, kts,kte                             )<a name='255'>
<a name='256'>
      CALL <A href='../../html_code/phys/module_cu_gd.F.html#NEG_CHECK'>neg_check</A><A href='../../html_code/phys/module_cu_gd.F.html#GRELLDRV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEG_CHECK_1">(dt,q2d,outq,outt,outqc,pret,its,ite,kts,kte,itf,ktf)<a name='257'>
<a name='258'>
            DO I=its,itf<a name='259'>
              cuten(i)=0.<a name='260'>
              if(pret(i).gt.0.)then<a name='261'>
                 raincv(i,j)=pret(i)*dt<a name='262'>
                 cuten(i)=1.<a name='263'>
                 rkbcon = kte+kts - kbcon(i)<a name='264'>
                 rktop  = kte+kts -  ktop(i)<a name='265'>
<font color=#447700>!                if (rktop  &lt; HTOP(i,j)) HTOP(i,j) = rktop<a name='266'></font>
<font color=#447700>!                if (rkbcon &gt; HBOT(i,j)) HBOT(i,j) = rkbcon<a name='267'></font>
              endif<a name='268'>
            ENDDO<a name='269'>
            DO K=kts,ktf<a name='270'>
            DO I=its,itf<a name='271'>
               RTHCUTEN(I,K,J)=outt(i,k)*cuten(i)/pi(i,k,j)<a name='272'>
               RQVCUTEN(I,K,J)=outq(i,k)*cuten(i)<a name='273'>
            ENDDO<a name='274'>
            ENDDO<a name='275'>
<a name='276'>
            IF(PRESENT(RQCCUTEN)) THEN<a name='277'>
              IF ( F_QC ) THEN<a name='278'>
                DO K=kts,ktf<a name='279'>
                DO I=its,itf<a name='280'>
                   RQCCUTEN(I,K,J)=outqc(I,K)*cuten(i)<a name='281'>
                ENDDO<a name='282'>
                ENDDO<a name='283'>
              ENDIF<a name='284'>
            ENDIF<a name='285'>
<a name='286'>
<font color=#447700>!......     QSTEN STORES GRAUPEL TENDENCY IF IT EXISTS, OTHERISE SNOW (V2)     <a name='287'></font>
<a name='288'>
            IF(PRESENT(RQICUTEN).AND.PRESENT(RQCCUTEN))THEN<a name='289'>
              IF (F_QI) THEN<a name='290'>
                DO K=kts,ktf<a name='291'>
                DO I=its,itf<a name='292'>
                   if(t2d(i,k).lt.258.)then<a name='293'>
                      RQICUTEN(I,K,J)=outqc(I,K)*cuten(i)<a name='294'>
                      RQCCUTEN(I,K,J)=0.<a name='295'>
                   else<a name='296'>
                      RQICUTEN(I,K,J)=0.<a name='297'>
                      RQCCUTEN(I,K,J)=outqc(I,K)*cuten(i)<a name='298'>
                   endif<a name='299'>
                ENDDO<a name='300'>
                ENDDO<a name='301'>
              ENDIF<a name='302'>
            ENDIF<a name='303'>
<a name='304'>
<a name='305'>
 100    continue<a name='306'>
<a name='307'>
   END SUBROUTINE GRELLDRV<a name='308'>
<a name='309'>
<a name='310'>
<A NAME='CUP_ENSS'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='311'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>CUP_enss</font>(OUTQC,J,AAEQ,T,Q,Z1,                            &amp; <A href='../../call_to/CUP_ENSS.html' TARGET='index'>1</A>,<A href='../../call_from/CUP_ENSS.html' TARGET='index'>42</A><a name='312'>
              TN,QO,PO,PRE,P,OUTT,OUTQ,DTIME,PSUR,US,VS,               &amp;<a name='313'>
              TCRIT,iens,mconv,massfln,iact,                           &amp;<a name='314'>
              omeg,direction,massflx,maxiens,                          &amp;<a name='315'>
              maxens,maxens2,maxens3,ensdim,                           &amp;<a name='316'>
              APR_GR,APR_W,APR_MC,APR_ST,APR_AS,                       &amp;<a name='317'>
              APR_CAPMA,APR_CAPME,APR_CAPMI,kbcon,ktop,                &amp;   <font color=#447700>!-lxz<a name='318'></font>
              xf_ens,pr_ens,                                           &amp;<a name='319'>
              xl,rv,cp,g,ichoice,ipr,jpr,                              &amp;<a name='320'>
              ids,ide, jds,jde, kds,kde,                               &amp;<a name='321'>
              ims,ime, jms,jme, kms,kme,                               &amp;<a name='322'>
              its,ite, jts,jte, kts,kte                               )<a name='323'>
<a name='324'>
   IMPLICIT NONE<a name='325'>
<a name='326'>
     integer                                                           &amp;<a name='327'>
        ,intent (in   )                   ::                           &amp;<a name='328'>
        ids,ide, jds,jde, kds,kde,                                     &amp;<a name='329'>
        ims,ime, jms,jme, kms,kme,                                     &amp;<a name='330'>
        its,ite, jts,jte, kts,kte,ipr,jpr<a name='331'>
     integer, intent (in   )              ::                           &amp;<a name='332'>
        j,ensdim,maxiens,maxens,maxens2,maxens3,ichoice,iens<a name='333'>
  <font color=#447700>!<a name='334'></font>
  <font color=#447700>! <a name='335'></font>
  <font color=#447700>!<a name='336'></font>
     real,    dimension (ims:ime,jms:jme,1:ensdim)                     &amp;<a name='337'>
        ,intent (inout)                   ::                           &amp;<a name='338'>
        massfln,xf_ens,pr_ens<a name='339'>
     real,    dimension (ims:ime,jms:jme)                              &amp;<a name='340'>
        ,intent (inout )                  ::                           &amp;<a name='341'>
               APR_GR,APR_W,APR_MC,APR_ST,APR_AS,APR_CAPMA,     &amp;<a name='342'>
               APR_CAPME,APR_CAPMI,massflx<a name='343'>
     integer, dimension (ims:ime,jms:jme)                              &amp;<a name='344'>
        ,intent (in   )                   ::                           &amp;<a name='345'>
        iact<a name='346'>
  <font color=#447700>! outtem = output temp tendency (per s)<a name='347'></font>
  <font color=#447700>! outq   = output q tendency (per s)<a name='348'></font>
  <font color=#447700>! outqc  = output qc tendency (per s)<a name='349'></font>
  <font color=#447700>! pre    = output precip<a name='350'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='351'>
        ,intent (out  )                   ::                           &amp;<a name='352'>
        OUTT,OUTQ,OUTQC<a name='353'>
     real,    dimension (its:ite)                                      &amp;<a name='354'>
        ,intent (out  )                   ::                           &amp;<a name='355'>
        pre<a name='356'>
<font color=#447700>!+lxz<a name='357'></font>
     integer,    dimension (its:ite)                                   &amp;<a name='358'>
        ,intent (out  )                   ::                           &amp;<a name='359'>
        kbcon,ktop<a name='360'>
<font color=#447700>!.lxz<a name='361'></font>
  <font color=#447700>!<a name='362'></font>
  <font color=#447700>! basic environmental input includes moisture convergence (mconv)<a name='363'></font>
  <font color=#447700>! omega (omeg), windspeed (us,vs), and a flag (aaeq) to turn off<a name='364'></font>
  <font color=#447700>! convection for this call only and at that particular gridpoint<a name='365'></font>
  <font color=#447700>!<a name='366'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='367'>
        ,intent (in   )                   ::                           &amp;<a name='368'>
        T,TN,PO,P,US,VS,omeg<a name='369'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='370'>
        ,intent (inout)                   ::                           &amp;<a name='371'>
         Q,QO<a name='372'>
     real, dimension (its:ite)                                         &amp;<a name='373'>
        ,intent (in   )                   ::                           &amp;<a name='374'>
        Z1,PSUR,AAEQ,direction,mconv<a name='375'>
<a name='376'>
       <a name='377'>
       real                                                            &amp;<a name='378'>
        ,intent (in   )                   ::                           &amp;<a name='379'>
        dtime,tcrit,xl,cp,rv,g<a name='380'>
<a name='381'>
<a name='382'>
<font color=#447700>!<a name='383'></font>
<font color=#447700>!  local ensemble dependent variables in this routine<a name='384'></font>
<font color=#447700>!<a name='385'></font>
     real,    dimension (its:ite,1:maxens)  ::                         &amp;<a name='386'>
        xaa0_ens<a name='387'>
     real,    dimension (1:maxens)  ::                                 &amp;<a name='388'>
        mbdt_ens<a name='389'>
     real,    dimension (1:maxens2) ::                                 &amp;<a name='390'>
        edt_ens<a name='391'>
     real,    dimension (its:ite,1:maxens2) ::                         &amp;<a name='392'>
        edtc<a name='393'>
     real,    dimension (its:ite,kts:kte,1:maxens2) ::                 &amp;<a name='394'>
        dellat_ens,dellaqc_ens,dellaq_ens,pwo_ens<a name='395'>
<font color=#447700>!<a name='396'></font>
<font color=#447700>!<a name='397'></font>
<font color=#447700>!<a name='398'></font>
<font color=#447700>!***************** the following are your basic environmental<a name='399'></font>
<font color=#447700>!                  variables. They carry a "_cup" if they are<a name='400'></font>
<font color=#447700>!                  on model cloud levels (staggered). They carry<a name='401'></font>
<font color=#447700>!                  an "o"-ending (z becomes zo), if they are the forced<a name='402'></font>
<font color=#447700>!                  variables. They are preceded by x (z becomes xz)<a name='403'></font>
<font color=#447700>!                  to indicate modification by some typ of cloud<a name='404'></font>
<font color=#447700>!<a name='405'></font>
  <font color=#447700>! z           = heights of model levels<a name='406'></font>
  <font color=#447700>! q           = environmental mixing ratio<a name='407'></font>
  <font color=#447700>! qes         = environmental saturation mixing ratio<a name='408'></font>
  <font color=#447700>! t           = environmental temp<a name='409'></font>
  <font color=#447700>! p           = environmental pressure<a name='410'></font>
  <font color=#447700>! he          = environmental moist static energy<a name='411'></font>
  <font color=#447700>! hes         = environmental saturation moist static energy<a name='412'></font>
  <font color=#447700>! z_cup       = heights of model cloud levels<a name='413'></font>
  <font color=#447700>! q_cup       = environmental q on model cloud levels<a name='414'></font>
  <font color=#447700>! qes_cup     = saturation q on model cloud levels<a name='415'></font>
  <font color=#447700>! t_cup       = temperature (Kelvin) on model cloud levels<a name='416'></font>
  <font color=#447700>! p_cup       = environmental pressure<a name='417'></font>
  <font color=#447700>! he_cup = moist static energy on model cloud levels<a name='418'></font>
  <font color=#447700>! hes_cup = saturation moist static energy on model cloud levels<a name='419'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='420'></font>
<font color=#447700>!<a name='421'></font>
<font color=#447700>!<a name='422'></font>
  <font color=#447700>! hcd = moist static energy in downdraft<a name='423'></font>
  <font color=#447700>! zd normalized downdraft mass flux<a name='424'></font>
  <font color=#447700>! dby = buoancy term<a name='425'></font>
  <font color=#447700>! entr = entrainment rate<a name='426'></font>
  <font color=#447700>! zd   = downdraft normalized mass flux<a name='427'></font>
  <font color=#447700>! entr= entrainment rate<a name='428'></font>
  <font color=#447700>! hcd = h in model cloud<a name='429'></font>
  <font color=#447700>! bu = buoancy term<a name='430'></font>
  <font color=#447700>! zd = normalized downdraft mass flux<a name='431'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='432'></font>
  <font color=#447700>! mentr_rate = entrainment rate<a name='433'></font>
  <font color=#447700>! qcd = cloud q (including liquid water) after entrainment<a name='434'></font>
  <font color=#447700>! qrch = saturation q in cloud<a name='435'></font>
  <font color=#447700>! pwd = evaporate at that level<a name='436'></font>
  <font color=#447700>! pwev = total normalized integrated evaoprate (I2)<a name='437'></font>
  <font color=#447700>! entr= entrainment rate<a name='438'></font>
  <font color=#447700>! z1 = terrain elevation<a name='439'></font>
  <font color=#447700>! entr = downdraft entrainment rate<a name='440'></font>
  <font color=#447700>! jmin = downdraft originating level<a name='441'></font>
  <font color=#447700>! kdet = level above ground where downdraft start detraining<a name='442'></font>
  <font color=#447700>! psur        = surface pressure<a name='443'></font>
  <font color=#447700>! z1          = terrain elevation<a name='444'></font>
  <font color=#447700>! pr_ens = precipitation ensemble<a name='445'></font>
  <font color=#447700>! xf_ens = mass flux ensembles<a name='446'></font>
  <font color=#447700>! massfln = downdraft mass flux ensembles used in next timestep<a name='447'></font>
  <font color=#447700>! omeg = omega from large scale model<a name='448'></font>
  <font color=#447700>! mconv = moisture convergence from large scale model<a name='449'></font>
  <font color=#447700>! zd      = downdraft normalized mass flux<a name='450'></font>
  <font color=#447700>! zu      = updraft normalized mass flux<a name='451'></font>
  <font color=#447700>! dir     = "storm motion"<a name='452'></font>
  <font color=#447700>! mbdt    = arbitrary numerical parameter<a name='453'></font>
  <font color=#447700>! dtime   = dt over which forcing is applied<a name='454'></font>
  <font color=#447700>! iact_gr_old = flag to tell where convection was active<a name='455'></font>
  <font color=#447700>! kbcon       = LFC of parcel from k22<a name='456'></font>
  <font color=#447700>! k22         = updraft originating level<a name='457'></font>
  <font color=#447700>! icoic       = flag if only want one closure (usually set to zero!)<a name='458'></font>
  <font color=#447700>! dby = buoancy term<a name='459'></font>
  <font color=#447700>! ktop = cloud top (output)<a name='460'></font>
  <font color=#447700>! xmb    = total base mass flux<a name='461'></font>
  <font color=#447700>! hc = cloud moist static energy<a name='462'></font>
  <font color=#447700>! hkb = moist static energy at originating level<a name='463'></font>
  <font color=#447700>! mentr_rate = entrainment rate<a name='464'></font>
<a name='465'>
     real,    dimension (its:ite,kts:kte) ::                           &amp;<a name='466'>
        he,hes,qes,z,                                                  &amp;<a name='467'>
        heo,heso,qeso,zo,                                              &amp;<a name='468'>
        xhe,xhes,xqes,xz,xt,xq,                                        &amp;<a name='469'>
<a name='470'>
        qes_cup,q_cup,he_cup,hes_cup,z_cup,p_cup,gamma_cup,t_cup,      &amp;<a name='471'>
        qeso_cup,qo_cup,heo_cup,heso_cup,zo_cup,po_cup,gammao_cup,     &amp;<a name='472'>
        tn_cup,                                                        &amp;<a name='473'>
        xqes_cup,xq_cup,xhe_cup,xhes_cup,xz_cup,xp_cup,xgamma_cup,     &amp;<a name='474'>
        xt_cup,                                                        &amp;<a name='475'>
<a name='476'>
        dby,qc,qrcd,pwd,pw,hcd,qcd,dbyd,hc,qrc,zu,zd,                  &amp;<a name='477'>
        dbyo,qco,qrcdo,pwdo,pwo,hcdo,qcdo,dbydo,hco,qrco,zuo,zdo,      &amp;<a name='478'>
        xdby,xqc,xqrcd,xpwd,xpw,xhcd,xqcd,xhc,xqrc,xzu,xzd,            &amp;<a name='479'>
<a name='480'>
  <font color=#447700>! cd  = detrainment function for updraft<a name='481'></font>
  <font color=#447700>! cdd = detrainment function for downdraft<a name='482'></font>
  <font color=#447700>! dellat = change of temperature per unit mass flux of cloud ensemble<a name='483'></font>
  <font color=#447700>! dellaq = change of q per unit mass flux of cloud ensemble<a name='484'></font>
  <font color=#447700>! dellaqc = change of qc per unit mass flux of cloud ensemble<a name='485'></font>
<a name='486'>
        cd,cdd,scr1,DELLAH,DELLAQ,DELLAT,DELLAQC<a name='487'>
<a name='488'>
  <font color=#447700>! aa0 cloud work function for downdraft<a name='489'></font>
  <font color=#447700>! edt = epsilon<a name='490'></font>
  <font color=#447700>! aa0     = cloud work function without forcing effects<a name='491'></font>
  <font color=#447700>! aa1     = cloud work function with forcing effects<a name='492'></font>
  <font color=#447700>! xaa0    = cloud work function with cloud effects (ensemble dependent)<a name='493'></font>
  <font color=#447700>! edt     = epsilon<a name='494'></font>
     real,    dimension (its:ite) ::                                   &amp;<a name='495'>
       edt,edto,edtx,AA1,AA0,XAA0,HKB,HKBO,aad,XHKB,QKB,QKBO,          &amp;<a name='496'>
       XMB,XPWAV,XPWEV,PWAV,PWEV,PWAVO,PWEVO,BU,BUO,cap_max<a name='497'>
     integer,    dimension (its:ite) ::                                &amp;<a name='498'>
       kzdown,KDET,K22,KB,JMIN,kstabi,kstabm,K22x,                     &amp;   <font color=#447700>!-lxz<a name='499'></font>
       KBCONx,KBx,KTOPx,ierr,ierr2,ierr3,KBMAX <a name='500'>
<a name='501'>
     integer                              ::                           &amp;<a name='502'>
       nall,iedt,nens,nens3,ki,I,K,KK,iresult<a name='503'>
     real                                 ::                           &amp;<a name='504'>
      day,dz,mbdt,entr_rate,radius,entrd_rate,mentr_rate,mentrd_rate,  &amp;<a name='505'>
      zcutdown,edtmax,edtmin,depth_min,zkbmax,z_detr,zktop,            &amp;<a name='506'>
      massfld,dh,cap_maxs,cap_max_increment<a name='507'>
<a name='508'>
     integer :: itf,jtf,ktf<a name='509'>
<a name='510'>
     itf=MIN(ite,ide-1)<a name='511'>
     ktf=MIN(kte,kde-1)<a name='512'>
     jtf=MIN(jte,jde-1)<a name='513'>
<a name='514'>
<font color=#447700>!sms$distribute end<a name='515'></font>
      day=86400.<a name='516'>
<font color=#447700>!<a name='517'></font>
<font color=#447700>!--- specify entrainmentrate and detrainmentrate<a name='518'></font>
<font color=#447700>!<a name='519'></font>
      if(iens.le.4)then<a name='520'>
      radius=14000.-float(iens)*2000.<a name='521'>
      else<a name='522'>
      radius=12000.<a name='523'>
      endif<a name='524'>
<font color=#447700>!<a name='525'></font>
<font color=#447700>!--- gross entrainment rate (these may be changed later on in the<a name='526'></font>
<font color=#447700>!--- program, depending what your detrainment is!!)<a name='527'></font>
<font color=#447700>!<a name='528'></font>
      entr_rate=.2/radius<a name='529'>
<font color=#447700>!<a name='530'></font>
<font color=#447700>!--- entrainment of mass<a name='531'></font>
<font color=#447700>!<a name='532'></font>
      mentrd_rate=0.<a name='533'>
      mentr_rate=entr_rate<a name='534'>
<font color=#447700>!<a name='535'></font>
<font color=#447700>!--- initial detrainmentrates<a name='536'></font>
<font color=#447700>!<a name='537'></font>
      do k=kts,ktf<a name='538'>
      do i=its,itf<a name='539'>
        cd(i,k)=0.1*entr_rate<a name='540'>
<font color=#447700>!       if(iens.gt.4)then<a name='541'></font>
<font color=#447700>!          cd(i,k)=(0.3+float(iens-4)*.15)*entr_rate<a name='542'></font>
<font color=#447700>!       endif<a name='543'></font>
<font color=#447700>!       cd(i,k)=0.<a name='544'></font>
        cdd(i,k)=0.<a name='545'>
      enddo<a name='546'>
      enddo<a name='547'>
<font color=#447700>!<a name='548'></font>
<font color=#447700>!--- max/min allowed value for epsilon (ratio downdraft base mass flux/updraft<a name='549'></font>
<font color=#447700>!    base mass flux<a name='550'></font>
<font color=#447700>!<a name='551'></font>
      edtmax=.8<a name='552'>
      edtmin=.2<a name='553'>
<font color=#447700>!<a name='554'></font>
<font color=#447700>!--- minimum depth (m), clouds must have<a name='555'></font>
<font color=#447700>!<a name='556'></font>
      depth_min=500.<a name='557'>
<font color=#447700>!<a name='558'></font>
<font color=#447700>!--- maximum depth (mb) of capping <a name='559'></font>
<font color=#447700>!--- inversion (larger cap = no convection)<a name='560'></font>
<font color=#447700>!<a name='561'></font>
<font color=#447700>!     cap_maxs=75.<a name='562'></font>
<font color=#447700>!     if(iens.eq.2)then<a name='563'></font>
<font color=#447700>!        cap_maxs=200.<a name='564'></font>
<font color=#447700>!     endif<a name='565'></font>
<font color=#447700>!     if(iens.eq.3)then<a name='566'></font>
<font color=#447700>!          radius=8.<a name='567'></font>
<font color=#447700>!     endif<a name='568'></font>
<font color=#447700>!     if(iens.eq.4)then<a name='569'></font>
<font color=#447700>!          do k=kts,ktf<a name='570'></font>
<font color=#447700>!          do i=its,itf<a name='571'></font>
<font color=#447700>!            cd(i,k)=0.<a name='572'></font>
<font color=#447700>!            cd(i,k)=0.1*entr_rate<a name='573'></font>
<font color=#447700>!          enddo<a name='574'></font>
<font color=#447700>!          enddo<a name='575'></font>
<font color=#447700>!     endif<a name='576'></font>
<font color=#447700>!<a name='577'></font>
<font color=#447700>!---- for kbcon_cin test<a name='578'></font>
<font color=#447700>!     cap_maxs=10.<a name='579'></font>
<font color=#447700>!!    if(iens.eq.2)cap_maxs=20.<a name='580'></font>
<font color=#447700>!!    if(iens.eq.3)cap_maxs=30.<a name='581'></font>
<font color=#447700>!!    if(iens.eq.4)cap_maxs=40.<a name='582'></font>
<font color=#447700>!     cap_maxs=25.<a name='583'></font>
<font color=#447700>! kbcon_p test<a name='584'></font>
<font color=#447700>!<a name='585'></font>
      cap_maxs=175.<a name='586'>
      cap_max_increment=75.<a name='587'>
<font color=#447700>!sms$to_local(grid_dh: &lt;1, mix :size&gt;, &lt;2, mjx :size&gt;) begin<a name='588'></font>
      DO 7 i=its,itf<a name='589'>
        kbmax(i)=1<a name='590'>
        aa0(i)=0.<a name='591'>
        aa1(i)=0.<a name='592'>
        aad(i)=0.<a name='593'>
        edt(i)=0.<a name='594'>
        kstabm(i)=ktf-1<a name='595'>
        IERR(i)=0<a name='596'>
        IERR2(i)=0<a name='597'>
        IERR3(i)=0<a name='598'>
        if(aaeq(i).lt.-1.)then<a name='599'>
           ierr(i)=20<a name='600'>
        endif<a name='601'>
 7    CONTINUE<a name='602'>
<font color=#447700>!<a name='603'></font>
<font color=#447700>!--- first check for upstream convection<a name='604'></font>
<font color=#447700>!<a name='605'></font>
      do i=its,itf<a name='606'>
          cap_max(i)=cap_maxs<a name='607'>
<font color=#447700>!      if(ierr(i).eq.0)then<a name='608'></font>
        iresult=0<a name='609'>
<font color=#447700>!       massfld=0.<a name='610'></font>
<font color=#447700>!     call cup_direction2(i,j,direction,iact, &amp;<a name='611'></font>
<font color=#447700>!          cu_mfx,iresult,0,massfld,  &amp;<a name='612'></font>
<font color=#447700>!          ids,ide, jds,jde, kds,kde, &amp;<a name='613'></font>
<font color=#447700>!          ims,ime, jms,jme, kms,kme, &amp;<a name='614'></font>
<font color=#447700>!          its,ite, jts,jte, kts,kte)<a name='615'></font>
          cap_max(i)=cap_maxs<a name='616'>
       if(iresult.eq.1)then<a name='617'>
          cap_max(i)=cap_maxs+20.<a name='618'>
       endif<a name='619'>
<font color=#447700>!      endif<a name='620'></font>
      enddo<a name='621'>
<font color=#447700>!<a name='622'></font>
<font color=#447700>!--- max height(m) above ground where updraft air can originate<a name='623'></font>
<font color=#447700>!<a name='624'></font>
      zkbmax=4000.<a name='625'>
<font color=#447700>!<a name='626'></font>
<font color=#447700>!--- height(m) above which no downdrafts are allowed to originate<a name='627'></font>
<font color=#447700>!<a name='628'></font>
      zcutdown=3000.<a name='629'>
<font color=#447700>!<a name='630'></font>
<font color=#447700>!--- depth(m) over which downdraft detrains all its mass<a name='631'></font>
<font color=#447700>!<a name='632'></font>
      z_detr=1250.<a name='633'>
<font color=#447700>!<a name='634'></font>
      do nens=1,maxens<a name='635'>
         mbdt_ens(nens)=(float(nens)-3.)*dtime*1.e-3+dtime*5.E-03<a name='636'>
<font color=#447700>!        mbdt_ens(nens)=(float(nens)-1.5)*dtime*2.e-3+dtime*5.E-03<a name='637'></font>
      enddo<a name='638'>
      do nens=1,maxens2<a name='639'>
<font color=#447700>!        edt_ens(nens)=.7-float(nens)*.1<a name='640'></font>
         edt_ens(nens)=.95-float(nens)*.01<a name='641'>
      enddo<a name='642'>
<font color=#447700>!     if(j.eq.jpr)then<a name='643'></font>
<font color=#447700>!       print *,'radius ensemble ',iens,radius<a name='644'></font>
<font color=#447700>!       print *,mbdt_ens<a name='645'></font>
<font color=#447700>!       print *,edt_ens<a name='646'></font>
<font color=#447700>!     endif<a name='647'></font>
<font color=#447700>!<a name='648'></font>
<font color=#447700>!--- environmental conditions, FIRST HEIGHTS<a name='649'></font>
<font color=#447700>!<a name='650'></font>
      do i=its,itf<a name='651'>
         if(ierr(i).ne.20)then<a name='652'>
            do k=1,maxens*maxens2*maxens3<a name='653'>
               xf_ens(i,j,(iens-1)*maxens*maxens2*maxens3+k)=0.<a name='654'>
               pr_ens(i,j,(iens-1)*maxens*maxens2*maxens3+k)=0.<a name='655'>
            enddo<a name='656'>
         endif<a name='657'>
      enddo<a name='658'>
<font color=#447700>!<a name='659'></font>
<font color=#447700>!--- calculate moist static energy, heights, qes<a name='660'></font>
<font color=#447700>!<a name='661'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_1">(z,qes,he,hes,t,q,p,z1, &amp;<a name='662'>
           psur,ierr,tcrit,0,xl,cp,   &amp;<a name='663'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='664'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='665'>
           its,ite, jts,jte, kts,kte)<a name='666'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_2">(zo,qeso,heo,heso,tn,qo,po,z1, &amp;<a name='667'>
           psur,ierr,tcrit,0,xl,cp,   &amp;<a name='668'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='669'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='670'>
           its,ite, jts,jte, kts,kte)<a name='671'>
<font color=#447700>!<a name='672'></font>
<font color=#447700>!--- environmental values on cloud levels<a name='673'></font>
<font color=#447700>!<a name='674'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_1">(t,qes,q,he,hes,z,p,qes_cup,q_cup,he_cup, &amp;<a name='675'>
           hes_cup,z_cup,p_cup,gamma_cup,t_cup,psur, &amp;<a name='676'>
           ierr,z1,xl,rv,cp,          &amp;<a name='677'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='678'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='679'>
           its,ite, jts,jte, kts,kte)<a name='680'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_2">(tn,qeso,qo,heo,heso,zo,po,qeso_cup,qo_cup, &amp;<a name='681'>
           heo_cup,heso_cup,zo_cup,po_cup,gammao_cup,tn_cup,psur,  &amp;<a name='682'>
           ierr,z1,xl,rv,cp,          &amp;<a name='683'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='684'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='685'>
           its,ite, jts,jte, kts,kte)<a name='686'>
<font color=#447700>!     if(numchem.gt.1)then<a name='687'></font>
<font color=#447700>!     call cup_env_clevt(trin,trcup,mix,kte,its,ite, &amp;<a name='688'></font>
<font color=#447700>!          numchem,ierr,              &amp;<a name='689'></font>
<font color=#447700>!          ids,ide, jds,jde, kds,kde, &amp;<a name='690'></font>
<font color=#447700>!          ims,ime, jms,jme, kms,kme, &amp;<a name='691'></font>
<font color=#447700>!          its,ite, jts,jte, kts,kte)<a name='692'></font>
<font color=#447700>!     endif<a name='693'></font>
      do i=its,itf<a name='694'>
      if(ierr(i).eq.0)then<a name='695'>
<font color=#447700>!<a name='696'></font>
      do k=kts,ktf<a name='697'>
        if(zo_cup(i,k).gt.zkbmax+z1(i))then<a name='698'>
          kbmax(i)=k<a name='699'>
          go to 25<a name='700'>
        endif<a name='701'>
      enddo<a name='702'>
 25   continue<a name='703'>
<font color=#447700>!<a name='704'></font>
<font color=#447700>!<a name='705'></font>
<font color=#447700>!--- level where detrainment for downdraft starts<a name='706'></font>
<font color=#447700>!<a name='707'></font>
      do k=kts,ktf<a name='708'>
        if(zo_cup(i,k).gt.z_detr+z1(i))then<a name='709'>
          kdet(i)=k<a name='710'>
          go to 26<a name='711'>
        endif<a name='712'>
      enddo<a name='713'>
 26   continue<a name='714'>
<font color=#447700>!<a name='715'></font>
      endif<a name='716'>
      enddo<a name='717'>
<font color=#447700>!<a name='718'></font>
<font color=#447700>!<a name='719'></font>
<font color=#447700>!<a name='720'></font>
<font color=#447700>!------- DETERMINE LEVEL WITH HIGHEST MOIST STATIC ENERGY CONTENT - K22<a name='721'></font>
<font color=#447700>!<a name='722'></font>
      CALL <A href='../../html_code/phys/module_cu_gd.F.html#CUP_MAXIMI'>cup_MAXIMI</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MAXIMI_1">(HEO_CUP,3,KBMAX,K22,ierr, &amp;<a name='723'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='724'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='725'>
           its,ite, jts,jte, kts,kte)<a name='726'>
       DO 36 i=its,itf<a name='727'>
         IF(ierr(I).eq.0.)THEN<a name='728'>
         IF(K22(I).GE.KBMAX(i))ierr(i)=2<a name='729'>
         endif<a name='730'>
 36   CONTINUE<a name='731'>
<font color=#447700>!<a name='732'></font>
<font color=#447700>!--- DETERMINE THE LEVEL OF CONVECTIVE CLOUD BASE  - KBCON<a name='733'></font>
<font color=#447700>!<a name='734'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_KBCON'>cup_kbcon</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KBCON_1">(cap_max_increment,1,k22,kbcon,heo_cup,heso_cup, &amp;<a name='735'>
           ierr,kbmax,po_cup,cap_max, &amp;<a name='736'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='737'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='738'>
           its,ite, jts,jte, kts,kte)<a name='739'>
<font color=#447700>!     call cup_kbcon_cin(1,k22,kbcon,heo_cup,heso_cup,z,tn_cup, &amp;<a name='740'></font>
<font color=#447700>!          qeso_cup,ierr,kbmax,po_cup,cap_max,xl,cp,&amp;<a name='741'></font>
<font color=#447700>!          ids,ide, jds,jde, kds,kde, &amp;<a name='742'></font>
<font color=#447700>!          ims,ime, jms,jme, kms,kme, &amp;<a name='743'></font>
<font color=#447700>!          its,ite, jts,jte, kts,kte)<a name='744'></font>
<font color=#447700>!<a name='745'></font>
<font color=#447700>!--- increase detrainment in stable layers<a name='746'></font>
<font color=#447700>!<a name='747'></font>
      CALL <A href='../../html_code/phys/module_cu_gd.F.html#CUP_MINIMI'>cup_minimi</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MINIMI_1">(HEso_cup,Kbcon,kstabm,kstabi,ierr,  &amp;<a name='748'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='749'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='750'>
           its,ite, jts,jte, kts,kte)<a name='751'>
      do i=its,itf<a name='752'>
      IF(ierr(I).eq.0.)THEN<a name='753'>
        if(kstabm(i)-1.gt.kstabi(i))then<a name='754'>
           do k=kstabi(i),kstabm(i)-1<a name='755'>
             cd(i,k)=cd(i,k-1)+1.5*entr_rate<a name='756'>
<font color=#447700>!            if(iens.gt.4)then<a name='757'></font>
<font color=#447700>!            cd(i,k)=cd(i,k-1)+float(iens-4)*entr_rate &amp;<a name='758'></font>
<font color=#447700>!                    /float(kstabm(i)-kstabi(i))<a name='759'></font>
<font color=#447700>!            else<a name='760'></font>
<font color=#447700>!             cd(i,k)=cd(i,k)<a name='761'></font>
<font color=#447700>!            endif<a name='762'></font>
<font color=#447700>!            cd(i,k)=cd(i,k-1)+0.5*entr_rate &amp;<a name='763'></font>
<font color=#447700>!                    /float(kstabm(i)-kstabi(i))<a name='764'></font>
             if(cd(i,k).gt.10.0*entr_rate)cd(i,k)=10.0*entr_rate<a name='765'>
<font color=#447700>!            if(cd(i,k).gt.5.0*entr_rate)cd(i,k)=5.0*entr_rate<a name='766'></font>
           enddo<a name='767'>
        ENDIF<a name='768'>
      ENDIF<a name='769'>
      ENDDO<a name='770'>
<font color=#447700>!<a name='771'></font>
<font color=#447700>!--- calculate incloud moist static energy<a name='772'></font>
<font color=#447700>!<a name='773'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_HE'>cup_up_he</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_HE_1">(k22,hkb,z_cup,cd,mentr_rate,he_cup,hc, &amp;<a name='774'>
           kbcon,ierr,dby,he,hes_cup, &amp;<a name='775'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='776'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='777'>
           its,ite, jts,jte, kts,kte)<a name='778'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_HE'>cup_up_he</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_HE_2">(k22,hkbo,zo_cup,cd,mentr_rate,heo_cup,hco, &amp;<a name='779'>
           kbcon,ierr,dbyo,heo,heso_cup, &amp;<a name='780'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='781'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='782'>
           its,ite, jts,jte, kts,kte)<a name='783'>
<a name='784'>
<font color=#447700>!--- DETERMINE CLOUD TOP - KTOP<a name='785'></font>
<font color=#447700>!<a name='786'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_KTOP'>cup_ktop</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KTOP_1">(1,dbyo,kbcon,ktop,ierr, &amp;<a name='787'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='788'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='789'>
           its,ite, jts,jte, kts,kte)<a name='790'>
      DO 37 i=its,itf<a name='791'>
         kzdown(i)=0<a name='792'>
         if(ierr(i).eq.0)then<a name='793'>
            zktop=(zo_cup(i,ktop(i))-z1(i))*.6<a name='794'>
            zktop=min(zktop+z1(i),zcutdown+z1(i))<a name='795'>
            do k=kts,kte<a name='796'>
              if(zo_cup(i,k).gt.zktop)then<a name='797'>
                 kzdown(i)=k<a name='798'>
                 go to 37<a name='799'>
              endif<a name='800'>
              enddo<a name='801'>
         endif<a name='802'>
 37   CONTINUE<a name='803'>
<font color=#447700>!<a name='804'></font>
<font color=#447700>!--- DOWNDRAFT ORIGINATING LEVEL - JMIN<a name='805'></font>
<font color=#447700>!<a name='806'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_MINIMI'>cup_minimi</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MINIMI_2">(HEso_cup,K22,kzdown,JMIN,ierr, &amp;<a name='807'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='808'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='809'>
           its,ite, jts,jte, kts,kte)<a name='810'>
      DO 100 i=its,ite<a name='811'>
      IF(ierr(I).eq.0.)THEN<a name='812'>
<font color=#447700>!<a name='813'></font>
<font color=#447700>!--- check whether it would have buoyancy, if there where<a name='814'></font>
<font color=#447700>!--- no entrainment/detrainment<a name='815'></font>
<font color=#447700>!<a name='816'></font>
101   continue<a name='817'>
      if(jmin(i)-1.lt.KDET(I))kdet(i)=jmin(i)-1<a name='818'>
      if(jmin(i).ge.Ktop(I)-1)jmin(i)=ktop(i)-2<a name='819'>
      ki=jmin(i)<a name='820'>
<font color=#447700>!     hcdo(i,ki)=heo_cup(i,ki)<a name='821'></font>
      hcdo(i,ki)=heso_cup(i,ki)<a name='822'>
      DZ=Zo_cup(i,Ki+1)-Zo_cup(i,Ki)<a name='823'>
      dh=dz*(HCDo(i,Ki)-heso_cup(i,ki))<a name='824'>
      dh=0.<a name='825'>
<font color=#447700>!<a name='826'></font>
      do k=ki-1,1,-1<a name='827'>
<font color=#447700>!        hcdo(i,k)=heo_cup(i,jmin(i))<a name='828'></font>
         hcdo(i,k)=heso_cup(i,jmin(i))<a name='829'>
         DZ=Zo_cup(i,K+1)-Zo_cup(i,K)<a name='830'>
         dh=dh+dz*(HCDo(i,K)-heso_cup(i,k))<a name='831'>
         if(dh.gt.0.)then<a name='832'>
           jmin(i)=jmin(i)-1<a name='833'>
           if(jmin(i).gt.3)then<a name='834'>
             go to 101<a name='835'>
           else if(jmin(i).le.3)then<a name='836'>
             ierr(i)=9<a name='837'>
             go to 100<a name='838'>
           endif<a name='839'>
         endif<a name='840'>
       enddo<a name='841'>
<a name='842'>
         IF(JMIN(I).LE.3)then<a name='843'>
            ierr(i)=4<a name='844'>
         endif<a name='845'>
<a name='846'>
      ENDIF<a name='847'>
100   continue<a name='848'>
<font color=#447700>!<a name='849'></font>
<font color=#447700>! - Must have at least depth_min m between cloud convective base<a name='850'></font>
<font color=#447700>!     and cloud top.<a name='851'></font>
<font color=#447700>!<a name='852'></font>
      do i=its,itf<a name='853'>
      IF(ierr(I).eq.0.)THEN<a name='854'>
      IF(-zo_cup(I,KBCON(I))+zo_cup(I,KTOP(I)).LT.depth_min)then<a name='855'>
            ierr(i)=6<a name='856'>
      endif<a name='857'>
      endif<a name='858'>
      enddo<a name='859'>
<a name='860'>
<font color=#447700>!<a name='861'></font>
<font color=#447700>!c--- normalized updraft mass flux profile<a name='862'></font>
<font color=#447700>!<a name='863'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_NMS'>cup_up_nms</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_NMS_1">(zu,z_cup,mentr_rate,cd,kbcon,ktop,ierr,k22, &amp;<a name='864'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='865'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='866'>
           its,ite, jts,jte, kts,kte)<a name='867'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_NMS'>cup_up_nms</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_NMS_2">(zuo,zo_cup,mentr_rate,cd,kbcon,ktop,ierr,k22, &amp;<a name='868'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='869'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='870'>
           its,ite, jts,jte, kts,kte)<a name='871'>
<font color=#447700>!<a name='872'></font>
<font color=#447700>!c--- normalized downdraft mass flux profile,also work on bottom detrainment<a name='873'></font>
<font color=#447700>!--- in this routine<a name='874'></font>
<font color=#447700>!<a name='875'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_NMS'>cup_dd_nms</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_NMS_1">(zd,z_cup,cdd,mentrd_rate,jmin,ierr, &amp;<a name='876'>
           0,kdet,z1,                 &amp;<a name='877'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='878'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='879'>
           its,ite, jts,jte, kts,kte)<a name='880'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_NMS'>cup_dd_nms</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_NMS_2">(zdo,zo_cup,cdd,mentrd_rate,jmin,ierr, &amp;<a name='881'>
           1,kdet,z1,                 &amp;<a name='882'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='883'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='884'>
           its,ite, jts,jte, kts,kte)<a name='885'>
<font color=#447700>!<a name='886'></font>
<font color=#447700>!--- downdraft moist static energy<a name='887'></font>
<font color=#447700>!<a name='888'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_HE'>cup_dd_he</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_HE_1">(hes_cup,zd,hcd,z_cup,cdd,mentrd_rate, &amp;<a name='889'>
           jmin,ierr,he,dbyd,he_cup,  &amp;<a name='890'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='891'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='892'>
           its,ite, jts,jte, kts,kte)<a name='893'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_HE'>cup_dd_he</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_HE_2">(heso_cup,zdo,hcdo,zo_cup,cdd,mentrd_rate, &amp;<a name='894'>
           jmin,ierr,heo,dbydo,he_cup,&amp;<a name='895'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='896'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='897'>
           its,ite, jts,jte, kts,kte)<a name='898'>
<font color=#447700>!<a name='899'></font>
<font color=#447700>!--- calculate moisture properties of downdraft<a name='900'></font>
<font color=#447700>!<a name='901'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_MOISTURE'>cup_dd_moisture</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_MOISTURE_1">(zd,hcd,hes_cup,qcd,qes_cup, &amp;<a name='902'>
           pwd,q_cup,z_cup,cdd,mentrd_rate,jmin,ierr,gamma_cup, &amp;<a name='903'>
           pwev,bu,qrcd,q,he,t_cup,2,xl, &amp;<a name='904'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='905'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='906'>
           its,ite, jts,jte, kts,kte)<a name='907'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_MOISTURE'>cup_dd_moisture</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_MOISTURE_2">(zdo,hcdo,heso_cup,qcdo,qeso_cup, &amp;<a name='908'>
           pwdo,qo_cup,zo_cup,cdd,mentrd_rate,jmin,ierr,gammao_cup, &amp;<a name='909'>
           pwevo,bu,qrcdo,qo,heo,tn_cup,1,xl, &amp;<a name='910'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='911'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='912'>
           its,ite, jts,jte, kts,kte)<a name='913'>
<font color=#447700>!<a name='914'></font>
<font color=#447700>!--- calculate moisture properties of updraft<a name='915'></font>
<font color=#447700>!<a name='916'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_MOISTURE'>cup_up_moisture</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_MOISTURE_1">(ierr,z_cup,qc,qrc,pw,pwav, &amp;<a name='917'>
           kbcon,ktop,cd,dby,mentr_rate,        &amp;<a name='918'>
           q,GAMMA_cup,zu,qes_cup,k22,q_cup,xl, &amp;<a name='919'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='920'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='921'>
           its,ite, jts,jte, kts,kte)<a name='922'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_MOISTURE'>cup_up_moisture</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_MOISTURE_2">(ierr,zo_cup,qco,qrco,pwo,pwavo, &amp;<a name='923'>
           kbcon,ktop,cd,dbyo,mentr_rate, &amp;<a name='924'>
           qo,GAMMAo_cup,zuo,qeso_cup,k22,qo_cup,xl,&amp;<a name='925'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='926'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='927'>
           its,ite, jts,jte, kts,kte)<a name='928'>
<font color=#447700>!<a name='929'></font>
<font color=#447700>!--- calculate workfunctions for updrafts<a name='930'></font>
<font color=#447700>!<a name='931'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_1">(aa0,z,zu,dby,GAMMA_CUP,t_cup, &amp;<a name='932'>
           kbcon,ktop,ierr,           &amp;<a name='933'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='934'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='935'>
           its,ite, jts,jte, kts,kte)<a name='936'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_2">(aa1,zo,zuo,dbyo,GAMMAo_CUP,tn_cup, &amp;<a name='937'>
           kbcon,ktop,ierr,           &amp;<a name='938'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='939'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='940'>
           its,ite, jts,jte, kts,kte)<a name='941'>
      do i=its,itf<a name='942'>
         if(ierr(i).eq.0)then<a name='943'>
           if(aa1(i).eq.0.)then<a name='944'>
               ierr(i)=17<a name='945'>
           endif<a name='946'>
         endif<a name='947'>
      enddo<a name='948'>
<font color=#447700>!<a name='949'></font>
<font color=#447700>!--- DETERMINE DOWNDRAFT STRENGTH IN TERMS OF WINDSHEAR<a name='950'></font>
<font color=#447700>!<a name='951'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_EDT'>cup_dd_edt</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_EDT_1">(ierr,us,vs,zo,ktop,kbcon,edt,po,pwavo, &amp;<a name='952'>
           pwevo,edtmax,edtmin,maxens2,edtc, &amp;<a name='953'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='954'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='955'>
           its,ite, jts,jte, kts,kte)<a name='956'>
      do 250 iedt=1,maxens2<a name='957'>
        do i=its,itf<a name='958'>
         if(ierr(i).eq.0)then<a name='959'>
         edt(i)=edtc(i,iedt)<a name='960'>
         edto(i)=edtc(i,iedt)<a name='961'>
         edtx(i)=edtc(i,iedt)<a name='962'>
         endif<a name='963'>
        enddo<a name='964'>
        do k=kts,ktf<a name='965'>
        do i=its,itf<a name='966'>
           dellat_ens(i,k,iedt)=0.<a name='967'>
           dellaq_ens(i,k,iedt)=0.<a name='968'>
           dellaqc_ens(i,k,iedt)=0.<a name='969'>
           pwo_ens(i,k,iedt)=0.<a name='970'>
        enddo<a name='971'>
        enddo<a name='972'>
<font color=#447700>!<a name='973'></font>
<font color=#447700>!     if(j.eq.jpr.and.iedt.eq.1)then<a name='974'></font>
<font color=#447700>!      if(j.eq.jpr)then<a name='975'></font>
<font color=#447700>!        i=ipr<a name='976'></font>
<font color=#447700>!        print *,'in 250 loop ',iedt,edt(ipr),ierr(ipr)<a name='977'></font>
<font color=#447700>!       if(ierr(i).eq.0.or.ierr(i).eq.3)then<a name='978'></font>
<font color=#447700>!        print *,k22(I),kbcon(i),ktop(i),jmin(i)<a name='979'></font>
<font color=#447700>!        print *,edt(i),aa0(i),aa1(i)<a name='980'></font>
<font color=#447700>!        do k=kts,ktf<a name='981'></font>
<font color=#447700>!          print *,k,z(i,k),he(i,k),hes(i,k)<a name='982'></font>
<font color=#447700>!        enddo<a name='983'></font>
<font color=#447700>!        do k=1,ktop(i)+1<a name='984'></font>
<font color=#447700>!          print *,zu(i,k),zd(i,k),pw(i,k),pwd(i,k)<a name='985'></font>
<font color=#447700>!        enddo<a name='986'></font>
<font color=#447700>!        endif<a name='987'></font>
<font color=#447700>!     endif<a name='988'></font>
      do i=its,itf<a name='989'>
        aad(i)=0.<a name='990'>
      enddo<a name='991'>
<font color=#447700>!     do i=its,itf<a name='992'></font>
<font color=#447700>!       if(ierr(i).eq.0)then<a name='993'></font>
<font color=#447700>!        eddt(i,j)=edt(i)<a name='994'></font>
<font color=#447700>!        EDTX(I)=EDT(I)<a name='995'></font>
<font color=#447700>!        BU(I)=0.<a name='996'></font>
<font color=#447700>!        BUO(I)=0.<a name='997'></font>
<font color=#447700>!       endif<a name='998'></font>
<font color=#447700>!     enddo<a name='999'></font>
<font color=#447700>!<a name='1000'></font>
<font color=#447700>!---downdraft workfunctions<a name='1001'></font>
<font color=#447700>!<a name='1002'></font>
<font color=#447700>!     call cup_dd_aa0(edt,ierr,aa0,jmin,gamma_cup,t_cup, &amp;<a name='1003'></font>
<font color=#447700>!          hcd,hes_cup,z,zd,          &amp;<a name='1004'></font>
<font color=#447700>!          ids,ide, jds,jde, kds,kde, &amp;<a name='1005'></font>
<font color=#447700>!          ims,ime, jms,jme, kms,kme, &amp;<a name='1006'></font>
<font color=#447700>!          its,ite, jts,jte, kts,kte)<a name='1007'></font>
<font color=#447700>!     call cup_dd_aa0(edto,ierr,aad,jmin,gammao_cup,tn_cup, &amp;<a name='1008'></font>
<font color=#447700>!          hcdo,heso_cup,zo,zdo,      &amp;<a name='1009'></font>
<font color=#447700>!          ids,ide, jds,jde, kds,kde, &amp;<a name='1010'></font>
<font color=#447700>!          ims,ime, jms,jme, kms,kme, &amp;<a name='1011'></font>
<font color=#447700>!          its,ite, jts,jte, kts,kte)<a name='1012'></font>
<font color=#447700>!<a name='1013'></font>
<font color=#447700>!--- change per unit mass that a model cloud would modify the environment<a name='1014'></font>
<font color=#447700>!<a name='1015'></font>
<font color=#447700>!--- 1. in bottom layer<a name='1016'></font>
<font color=#447700>!<a name='1017'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DELLABOT'>cup_dellabot</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DELLABOT_1">(ipr,jpr,heo_cup,ierr,zo_cup,po,hcdo,edto, &amp;<a name='1018'>
           zdo,cdd,heo,dellah,j,mentrd_rate,zo,g, &amp;<a name='1019'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1020'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1021'>
           its,ite, jts,jte, kts,kte)<a name='1022'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DELLABOT'>cup_dellabot</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DELLABOT_2">(ipr,jpr,qo_cup,ierr,zo_cup,po,qrcdo,edto, &amp;<a name='1023'>
           zdo,cdd,qo,dellaq,j,mentrd_rate,zo,g,&amp;<a name='1024'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1025'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1026'>
           its,ite, jts,jte, kts,kte)<a name='1027'>
<font color=#447700>!<a name='1028'></font>
<font color=#447700>!--- 2. everywhere else<a name='1029'></font>
<font color=#447700>!<a name='1030'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DELLAS'>cup_dellas</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DELLAS_1">(ierr,zo_cup,po_cup,hcdo,edto,zdo,cdd,    &amp;<a name='1031'>
           heo,dellah,j,mentrd_rate,zuo,g,                     &amp;<a name='1032'>
           cd,hco,ktop,k22,kbcon,mentr_rate,jmin,heo_cup,kdet, &amp;<a name='1033'>
           k22,ipr,jpr,'deep',                                 &amp;<a name='1034'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1035'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1036'>
           its,ite, jts,jte, kts,kte)<a name='1037'>
<font color=#447700>!<a name='1038'></font>
<font color=#447700>!-- take out cloud liquid water for detrainment<a name='1039'></font>
<font color=#447700>!<a name='1040'></font>
<font color=#447700>!??   do k=kts,ktf<a name='1041'></font>
      do k=kts,ktf-1<a name='1042'>
      do i=its,itf<a name='1043'>
       scr1(i,k)=0.<a name='1044'>
       dellaqc(i,k)=0.<a name='1045'>
       if(ierr(i).eq.0)then<a name='1046'>
<font color=#447700>!       print *,'in vupnewg, after della ',ierr(i),aa0(i),i,j<a name='1047'></font>
         scr1(i,k)=qco(i,k)-qrco(i,k)<a name='1048'>
         if(k.eq.ktop(i)-0)dellaqc(i,k)= &amp;<a name='1049'>
                      .01*zuo(i,ktop(i))*qrco(i,ktop(i))* &amp;<a name='1050'>
                      9.81/(po_cup(i,k)-po_cup(i,k+1))<a name='1051'>
         if(k.lt.ktop(i).and.k.gt.kbcon(i))then<a name='1052'>
           dz=zo_cup(i,k+1)-zo_cup(i,k)<a name='1053'>
           dellaqc(i,k)=.01*9.81*cd(i,k)*dz*zuo(i,k) &amp;<a name='1054'>
                        *.5*(qrco(i,k)+qrco(i,k+1))/ &amp;<a name='1055'>
                        (po_cup(i,k)-po_cup(i,k+1))<a name='1056'>
         endif<a name='1057'>
       endif<a name='1058'>
      enddo<a name='1059'>
      enddo<a name='1060'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DELLAS'>cup_dellas</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DELLAS_2">(ierr,zo_cup,po_cup,qrcdo,edto,zdo,cdd, &amp;<a name='1061'>
           qo,dellaq,j,mentrd_rate,zuo,g, &amp;<a name='1062'>
           cd,scr1,ktop,k22,kbcon,mentr_rate,jmin,qo_cup,kdet, &amp;<a name='1063'>
           k22,ipr,jpr,'deep',               &amp;<a name='1064'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='1065'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='1066'>
              its,ite, jts,jte, kts,kte    )<a name='1067'>
<font color=#447700>!<a name='1068'></font>
<font color=#447700>!--- using dellas, calculate changed environmental profiles<a name='1069'></font>
<font color=#447700>!<a name='1070'></font>
<font color=#447700>!     do 200 nens=1,maxens<a name='1071'></font>
      mbdt=mbdt_ens(2)<a name='1072'>
      do i=its,itf<a name='1073'>
      xaa0_ens(i,1)=0.<a name='1074'>
      xaa0_ens(i,2)=0.<a name='1075'>
      xaa0_ens(i,3)=0.<a name='1076'>
      enddo<a name='1077'>
<a name='1078'>
<font color=#447700>!     mbdt=mbdt_ens(nens)<a name='1079'></font>
<font color=#447700>!     do i=its,itf <a name='1080'></font>
<font color=#447700>!     xaa0_ens(i,nens)=0.<a name='1081'></font>
<font color=#447700>!     enddo<a name='1082'></font>
      do k=kts,ktf<a name='1083'>
      do i=its,itf<a name='1084'>
         dellat(i,k)=0.<a name='1085'>
         if(ierr(i).eq.0)then<a name='1086'>
            XHE(I,K)=DELLAH(I,K)*MBDT+HEO(I,K)<a name='1087'>
            XQ(I,K)=DELLAQ(I,K)*MBDT+QO(I,K)<a name='1088'>
            DELLAT(I,K)=(1./cp)*(DELLAH(I,K)-xl*DELLAQ(I,K))<a name='1089'>
            XT(I,K)= DELLAT(I,K)*MBDT+TN(I,K)<a name='1090'>
            IF(XQ(I,K).LE.0.)XQ(I,K)=1.E-08<a name='1091'>
<font color=#447700>!            if(i.eq.ipr.and.j.eq.jpr)then<a name='1092'></font>
<font color=#447700>!              print *,k,DELLAH(I,K),DELLAQ(I,K),DELLAT(I,K)<a name='1093'></font>
<font color=#447700>!            endif<a name='1094'></font>
         ENDIF<a name='1095'>
      enddo<a name='1096'>
      enddo<a name='1097'>
      do i=its,itf<a name='1098'>
      if(ierr(i).eq.0)then<a name='1099'>
      XHE(I,ktf)=HEO(I,ktf)<a name='1100'>
      XQ(I,ktf)=QO(I,ktf)<a name='1101'>
      XT(I,ktf)=TN(I,ktf)<a name='1102'>
      IF(XQ(I,ktf).LE.0.)XQ(I,ktf)=1.E-08<a name='1103'>
      endif<a name='1104'>
      enddo<a name='1105'>
<font color=#447700>!<a name='1106'></font>
<font color=#447700>!--- calculate moist static energy, heights, qes<a name='1107'></font>
<font color=#447700>!<a name='1108'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_3">(xz,xqes,xhe,xhes,xt,xq,po,z1, &amp;<a name='1109'>
           psur,ierr,tcrit,2,xl,cp,   &amp;<a name='1110'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1111'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1112'>
           its,ite, jts,jte, kts,kte)<a name='1113'>
<font color=#447700>!<a name='1114'></font>
<font color=#447700>!--- environmental values on cloud levels<a name='1115'></font>
<font color=#447700>!<a name='1116'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_3">(xt,xqes,xq,xhe,xhes,xz,po,xqes_cup,xq_cup, &amp;<a name='1117'>
           xhe_cup,xhes_cup,xz_cup,po_cup,gamma_cup,xt_cup,psur,   &amp;<a name='1118'>
           ierr,z1,xl,rv,cp,          &amp;<a name='1119'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1120'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1121'>
           its,ite, jts,jte, kts,kte)<a name='1122'>
<font color=#447700>!<a name='1123'></font>
<font color=#447700>!<a name='1124'></font>
<font color=#447700>!**************************** static control<a name='1125'></font>
<font color=#447700>!<a name='1126'></font>
<font color=#447700>!--- moist static energy inside cloud<a name='1127'></font>
<font color=#447700>!<a name='1128'></font>
      do i=its,itf<a name='1129'>
        if(ierr(i).eq.0)then<a name='1130'>
          xhkb(i)=xhe(i,k22(i))<a name='1131'>
        endif<a name='1132'>
      enddo<a name='1133'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_HE'>cup_up_he</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_HE_3">(k22,xhkb,xz_cup,cd,mentr_rate,xhe_cup,xhc, &amp;<a name='1134'>
           kbcon,ierr,xdby,xhe,xhes_cup, &amp;<a name='1135'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1136'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1137'>
           its,ite, jts,jte, kts,kte)<a name='1138'>
<font color=#447700>!<a name='1139'></font>
<font color=#447700>!c--- normalized mass flux profile<a name='1140'></font>
<font color=#447700>!<a name='1141'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_NMS'>cup_up_nms</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_NMS_3">(xzu,xz_cup,mentr_rate,cd,kbcon,ktop,ierr,k22, &amp;<a name='1142'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1143'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1144'>
           its,ite, jts,jte, kts,kte)<a name='1145'>
<font color=#447700>!<a name='1146'></font>
<font color=#447700>!--- moisture downdraft<a name='1147'></font>
<font color=#447700>!<a name='1148'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_NMS'>cup_dd_nms</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_NMS_3">(xzd,xz_cup,cdd,mentrd_rate,jmin,ierr, &amp;<a name='1149'>
           1,kdet,z1,                 &amp;<a name='1150'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1151'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1152'>
           its,ite, jts,jte, kts,kte)<a name='1153'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_HE'>cup_dd_he</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_HE_3">(xhes_cup,xzd,xhcd,xz_cup,cdd,mentrd_rate, &amp;<a name='1154'>
           jmin,ierr,xhe,dbyd,xhe_cup,&amp;<a name='1155'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1156'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1157'>
           its,ite, jts,jte, kts,kte)<a name='1158'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_MOISTURE'>cup_dd_moisture</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_MOISTURE_3">(xzd,xhcd,xhes_cup,xqcd,xqes_cup, &amp;<a name='1159'>
           xpwd,xq_cup,xz_cup,cdd,mentrd_rate,jmin,ierr,gamma_cup, &amp;<a name='1160'>
           xpwev,bu,xqrcd,xq,xhe,xt_cup,3,xl, &amp;<a name='1161'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1162'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1163'>
           its,ite, jts,jte, kts,kte)<a name='1164'>
<a name='1165'>
<font color=#447700>!<a name='1166'></font>
<font color=#447700>!------- MOISTURE updraft<a name='1167'></font>
<font color=#447700>!<a name='1168'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_MOISTURE'>cup_up_moisture</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_MOISTURE_3">(ierr,xz_cup,xqc,xqrc,xpw,xpwav, &amp;<a name='1169'>
           kbcon,ktop,cd,xdby,mentr_rate, &amp;<a name='1170'>
           xq,GAMMA_cup,xzu,xqes_cup,k22,xq_cup,xl, &amp;<a name='1171'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1172'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1173'>
           its,ite, jts,jte, kts,kte)<a name='1174'>
<font color=#447700>!<a name='1175'></font>
<font color=#447700>!--- workfunctions for updraft<a name='1176'></font>
<font color=#447700>!<a name='1177'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_3">(xaa0,xz,xzu,xdby,GAMMA_CUP,xt_cup, &amp;<a name='1178'>
           kbcon,ktop,ierr,           &amp;<a name='1179'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1180'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1181'>
           its,ite, jts,jte, kts,kte)<a name='1182'>
<font color=#447700>!<a name='1183'></font>
<font color=#447700>!--- workfunctions for downdraft<a name='1184'></font>
<font color=#447700>!<a name='1185'></font>
<font color=#447700>!<a name='1186'></font>
<font color=#447700>!     call cup_dd_aa0(edtx,ierr,xaa0,jmin,gamma_cup,xt_cup, &amp;<a name='1187'></font>
<font color=#447700>!          xhcd,xhes_cup,xz,xzd,      &amp;<a name='1188'></font>
<font color=#447700>!          ids,ide, jds,jde, kds,kde, &amp;<a name='1189'></font>
<font color=#447700>!          ims,ime, jms,jme, kms,kme, &amp;<a name='1190'></font>
<font color=#447700>!          its,ite, jts,jte, kts,kte)<a name='1191'></font>
      do 200 nens=1,maxens<a name='1192'>
      do i=its,itf <a name='1193'>
         if(ierr(i).eq.0)then<a name='1194'>
           xaa0_ens(i,nens)=xaa0(i)<a name='1195'>
           nall=(iens-1)*maxens3*maxens*maxens2 &amp;<a name='1196'>
                +(iedt-1)*maxens*maxens3 &amp;<a name='1197'>
                +(nens-1)*maxens3<a name='1198'>
           do k=kts,ktf<a name='1199'>
              if(k.le.ktop(i))then<a name='1200'>
                 do nens3=1,maxens3<a name='1201'>
                 if(nens3.eq.7)then<a name='1202'>
<font color=#447700>!--- b=0<a name='1203'></font>
                 pr_ens(i,j,nall+nens3)=pr_ens(i,j,nall+nens3)+ &amp;<a name='1204'>
                                    pwo(i,k) <a name='1205'>
<font color=#447700>!                                  +edto(i)*pwdo(i,k)<a name='1206'></font>
<font color=#447700>!--- b=beta<a name='1207'></font>
                 else if(nens3.eq.8)then<a name='1208'>
                 pr_ens(i,j,nall+nens3)=pr_ens(i,j,nall+nens3)+ &amp;<a name='1209'>
                                    pwo(i,k)<a name='1210'>
<font color=#447700>!--- b=beta/2<a name='1211'></font>
                 else if(nens3.eq.9)then<a name='1212'>
                 pr_ens(i,j,nall+nens3)=pr_ens(i,j,nall+nens3)+ &amp;<a name='1213'>
                                    pwo(i,k)<a name='1214'>
<font color=#447700>!                                  +.5*edto(i)*pwdo(i,k)<a name='1215'></font>
                 else<a name='1216'>
                 pr_ens(i,j,nall+nens3)=pr_ens(i,j,nall+nens3)+ &amp;<a name='1217'>
                                    pwo(i,k)+edto(i)*pwdo(i,k)<a name='1218'>
                 endif<a name='1219'>
                 enddo<a name='1220'>
              endif<a name='1221'>
           enddo<a name='1222'>
         if(pr_ens(i,j,nall+7).lt.1.e-6)then<a name='1223'>
            ierr(i)=18<a name='1224'>
            do nens3=1,maxens3<a name='1225'>
               pr_ens(i,j,nall+nens3)=0.<a name='1226'>
            enddo<a name='1227'>
         endif<a name='1228'>
         do nens3=1,maxens3<a name='1229'>
           if(pr_ens(i,j,nall+nens3).lt.1.e-4)then<a name='1230'>
            pr_ens(i,j,nall+nens3)=0.<a name='1231'>
           endif<a name='1232'>
         enddo<a name='1233'>
         endif<a name='1234'>
      enddo<a name='1235'>
 200  continue<a name='1236'>
<font color=#447700>!<a name='1237'></font>
<font color=#447700>!--- LARGE SCALE FORCING<a name='1238'></font>
<font color=#447700>!<a name='1239'></font>
<font color=#447700>!<a name='1240'></font>
<font color=#447700>!------- CHECK wether aa0 should have been zero<a name='1241'></font>
<font color=#447700>!<a name='1242'></font>
<font color=#447700>!<a name='1243'></font>
      CALL <A href='../../html_code/phys/module_cu_gd.F.html#CUP_MAXIMI'>cup_MAXIMI</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MAXIMI_2">(HEO_CUP,3,KBMAX,K22x,ierr, &amp;<a name='1244'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1245'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1246'>
           its,ite, jts,jte, kts,kte)<a name='1247'>
      do i=its,itf<a name='1248'>
         ierr2(i)=ierr(i)<a name='1249'>
         ierr3(i)=ierr(i)<a name='1250'>
      enddo<a name='1251'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_KBCON'>cup_kbcon</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KBCON_2">(cap_max_increment,2,k22x,kbconx,heo_cup, &amp;<a name='1252'>
           heso_cup,ierr2,kbmax,po_cup,cap_max, &amp;<a name='1253'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1254'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1255'>
           its,ite, jts,jte, kts,kte)<a name='1256'>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_KBCON'>cup_kbcon</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KBCON_3">(cap_max_increment,3,k22x,kbconx,heo_cup, &amp;<a name='1257'>
           heso_cup,ierr3,kbmax,po_cup,cap_max, &amp;<a name='1258'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1259'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1260'>
           its,ite, jts,jte, kts,kte)<a name='1261'>
<font color=#447700>!<a name='1262'></font>
<font color=#447700>!--- DETERMINE THE LEVEL OF CONVECTIVE CLOUD BASE  - KBCON<a name='1263'></font>
<font color=#447700>!<a name='1264'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_FORCING_ENS'>cup_forcing_ens</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_FORCING_ENS_1">(aa0,aa1,xaa0_ens,mbdt_ens,dtime,   &amp;<a name='1265'>
           ierr,ierr2,ierr3,xf_ens,j,'deeps',                 &amp;<a name='1266'>
           maxens,iens,iedt,maxens2,maxens3,mconv,            &amp;<a name='1267'>
           po_cup,ktop,omeg,zdo,k22,zuo,pr_ens,edto,kbcon,    &amp;<a name='1268'>
           massflx,iact,direction,ensdim,massfln,ichoice,     &amp;<a name='1269'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1270'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1271'>
           its,ite, jts,jte, kts,kte)<a name='1272'>
<font color=#447700>!<a name='1273'></font>
      do k=kts,ktf<a name='1274'>
      do i=its,itf<a name='1275'>
        if(ierr(i).eq.0)then<a name='1276'>
           dellat_ens(i,k,iedt)=dellat(i,k)<a name='1277'>
           dellaq_ens(i,k,iedt)=dellaq(i,k)<a name='1278'>
           dellaqc_ens(i,k,iedt)=dellaqc(i,k)<a name='1279'>
           pwo_ens(i,k,iedt)=pwo(i,k)+edt(i)*pwdo(i,k)<a name='1280'>
        else <a name='1281'>
           dellat_ens(i,k,iedt)=0.<a name='1282'>
           dellaq_ens(i,k,iedt)=0.<a name='1283'>
           dellaqc_ens(i,k,iedt)=0.<a name='1284'>
           pwo_ens(i,k,iedt)=0.<a name='1285'>
        endif<a name='1286'>
<font color=#447700>!      if(i.eq.ipr.and.j.eq.jpr)then<a name='1287'></font>
<font color=#447700>!        print *,iens,iedt,dellat(i,k),dellat_ens(i,k,iedt), &amp;<a name='1288'></font>
<font color=#447700>!          dellaq(i,k), dellaqc(i,k)<a name='1289'></font>
<font color=#447700>!      endif<a name='1290'></font>
      enddo<a name='1291'>
      enddo<a name='1292'>
 250  continue<a name='1293'>
<font color=#447700>!<a name='1294'></font>
<font color=#447700>!--- FEEDBACK<a name='1295'></font>
<font color=#447700>!<a name='1296'></font>
      call <A href='../../html_code/phys/module_cu_gd.F.html#CUP_OUTPUT_ENS'>cup_output_ens</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENSS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_OUTPUT_ENS_1">(xf_ens,ierr,dellat_ens,dellaq_ens, &amp;<a name='1297'>
           dellaqc_ens,outt,outq,outqc,pre,pwo_ens,xmb,ktop, &amp;<a name='1298'>
           j,'deep',maxens2,maxens,iens,ierr2,ierr3,         &amp;<a name='1299'>
           pr_ens,maxens3,ensdim,massfln,                    &amp;<a name='1300'>
           APR_GR,APR_W,APR_MC,APR_ST,APR_AS,                &amp;<a name='1301'>
           APR_CAPMA,APR_CAPME,APR_CAPMI,                    &amp;<a name='1302'>
           ids,ide, jds,jde, kds,kde, &amp;<a name='1303'>
           ims,ime, jms,jme, kms,kme, &amp;<a name='1304'>
           its,ite, jts,jte, kts,kte)<a name='1305'>
      do i=its,itf<a name='1306'>
           PRE(I)=MAX(PRE(I),0.)<a name='1307'>
      enddo<a name='1308'>
<font color=#447700>!<a name='1309'></font>
<font color=#447700>!---------------------------done------------------------------<a name='1310'></font>
<font color=#447700>!<a name='1311'></font>
<font color=#447700>!      if(j.eq.jpr)then<a name='1312'></font>
<font color=#447700>!      i=ipr<a name='1313'></font>
<font color=#447700>!       if(ierr(i).eq.0)then<a name='1314'></font>
<font color=#447700>!         print *,'on output, pre =',pre(i)<a name='1315'></font>
<font color=#447700>!        do k=kts,ktf<a name='1316'></font>
<font color=#447700>!          print *,k,z(i,k),outt(i,k),outq(i,k),outqc(i,k)<a name='1317'></font>
<font color=#447700>!        enddo<a name='1318'></font>
<font color=#447700>!        else<a name='1319'></font>
<font color=#447700>!          print *,'ierror = ',ierr(i)<a name='1320'></font>
<font color=#447700>!        endif<a name='1321'></font>
<font color=#447700>!      endif<a name='1322'></font>
<font color=#447700>!     do i=its,itf<a name='1323'></font>
<font color=#447700>!      if(ierr(i).eq.0)then<a name='1324'></font>
<font color=#447700>!           print *,i,j,ierr(i),pre(i)<a name='1325'></font>
<font color=#447700>!      endif<a name='1326'></font>
<font color=#447700>!     enddo<a name='1327'></font>
<font color=#447700>!sms$to_local end<a name='1328'></font>
<font color=#447700>!     print *,'ierr(i) = ',ierr(i),pre(i)<a name='1329'></font>
<a name='1330'>
   END SUBROUTINE CUP_enss<a name='1331'>
<a name='1332'>
<a name='1333'>
<A NAME='CUP_DD_AA0'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_AA0' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1334'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_aa0</font>(edt,ierr,aa0,jmin,gamma_cup,t_cup, &amp;<a name='1335'>
              hcd,hes_cup,z,zd,                             &amp;<a name='1336'>
              ids,ide, jds,jde, kds,kde,                    &amp;<a name='1337'>
              ims,ime, jms,jme, kms,kme,                    &amp;<a name='1338'>
              its,ite, jts,jte, kts,kte                    )<a name='1339'>
<a name='1340'>
   IMPLICIT NONE<a name='1341'>
<font color=#447700>!<a name='1342'></font>
<font color=#447700>!  on input<a name='1343'></font>
<font color=#447700>!<a name='1344'></font>
<a name='1345'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='1346'></font>
<a name='1347'>
     integer                                                           &amp;<a name='1348'>
        ,intent (in   )                   ::                           &amp;<a name='1349'>
        ids,ide, jds,jde, kds,kde,                                     &amp;<a name='1350'>
        ims,ime, jms,jme, kms,kme,                                     &amp;<a name='1351'>
        its,ite, jts,jte, kts,kte<a name='1352'>
  <font color=#447700>! aa0 cloud work function for downdraft<a name='1353'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='1354'></font>
  <font color=#447700>! t_cup = temperature (Kelvin) on model cloud levels<a name='1355'></font>
  <font color=#447700>! hes_cup = saturation moist static energy on model cloud levels<a name='1356'></font>
  <font color=#447700>! hcd = moist static energy in downdraft<a name='1357'></font>
  <font color=#447700>! edt = epsilon<a name='1358'></font>
  <font color=#447700>! zd normalized downdraft mass flux<a name='1359'></font>
  <font color=#447700>! z = heights of model levels <a name='1360'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='1361'></font>
  <font color=#447700>!<a name='1362'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1363'>
        ,intent (in   )                   ::                           &amp;<a name='1364'>
        z,zd,gamma_cup,t_cup,hes_cup,hcd<a name='1365'>
     real,    dimension (its:ite)                                      &amp;<a name='1366'>
        ,intent (in   )                   ::                           &amp;<a name='1367'>
        edt<a name='1368'>
     integer, dimension (its:ite)                                      &amp;<a name='1369'>
        ,intent (in   )                   ::                           &amp;<a name='1370'>
        jmin<a name='1371'>
<font color=#447700>!<a name='1372'></font>
<font color=#447700>! input and output<a name='1373'></font>
<font color=#447700>!<a name='1374'></font>
<a name='1375'>
<a name='1376'>
     integer, dimension (its:ite)                                      &amp;<a name='1377'>
        ,intent (inout)                   ::                           &amp;<a name='1378'>
        ierr<a name='1379'>
     real,    dimension (its:ite)                                      &amp;<a name='1380'>
        ,intent (out  )                   ::                           &amp;<a name='1381'>
        aa0<a name='1382'>
<font color=#447700>!<a name='1383'></font>
<font color=#447700>!  local variables in this routine<a name='1384'></font>
<font color=#447700>!<a name='1385'></font>
<a name='1386'>
     integer                              ::                           &amp;<a name='1387'>
        i,k,kk<a name='1388'>
     real                                 ::                           &amp;<a name='1389'>
        dz<a name='1390'>
<font color=#447700>!<a name='1391'></font>
     integer :: itf, ktf<a name='1392'>
<font color=#447700>!<a name='1393'></font>
     itf=MIN(ite,ide-1)<a name='1394'>
     ktf=MIN(kte,kde-1)<a name='1395'>
<font color=#447700>!<a name='1396'></font>
<font color=#447700>!??    DO k=kts,kte-1<a name='1397'></font>
       DO k=kts,ktf-1<a name='1398'>
       do i=its,itf<a name='1399'>
         IF(ierr(I).eq.0.and.k.lt.jmin(i))then<a name='1400'>
         KK=JMIN(I)-K<a name='1401'>
<font color=#447700>!<a name='1402'></font>
<font color=#447700>!--- ORIGINAL<a name='1403'></font>
<font color=#447700>!<a name='1404'></font>
         DZ=(Z(I,KK)-Z(I,KK+1))<a name='1405'>
         AA0(I)=AA0(I)+zd(i,kk)*EDT(I)*DZ*(9.81/(1004.*T_cup(I,KK))) &amp;<a name='1406'>
            *((hcd(i,kk)-hes_cup(i,kk))/(1.+GAMMA_cup(i,kk)))<a name='1407'>
         endif<a name='1408'>
      enddo<a name='1409'>
      enddo<a name='1410'>
<a name='1411'>
   END SUBROUTINE CUP_dd_aa0<a name='1412'>
<a name='1413'>
<a name='1414'>
<A NAME='CUP_DD_EDT'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_EDT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1415'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_edt</font>(ierr,us,vs,z,ktop,kbcon,edt,p,pwav, &amp; <A href='../../call_to/CUP_DD_EDT.html' TARGET='index'>1</A><a name='1416'>
              pwev,edtmax,edtmin,maxens2,edtc,               &amp;<a name='1417'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='1418'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='1419'>
              its,ite, jts,jte, kts,kte                     )<a name='1420'>
<a name='1421'>
   IMPLICIT NONE<a name='1422'>
<a name='1423'>
     integer                                                           &amp;<a name='1424'>
        ,intent (in   )                   ::                           &amp;<a name='1425'>
        ids,ide, jds,jde, kds,kde,           &amp;<a name='1426'>
        ims,ime, jms,jme, kms,kme,           &amp;<a name='1427'>
        its,ite, jts,jte, kts,kte<a name='1428'>
     integer, intent (in   )              ::                           &amp;<a name='1429'>
        maxens2<a name='1430'>
  <font color=#447700>!<a name='1431'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='1432'></font>
  <font color=#447700>!<a name='1433'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1434'>
        ,intent (in   )                   ::                           &amp;<a name='1435'>
        us,vs,z,p<a name='1436'>
     real,    dimension (its:ite,1:maxens2)                            &amp;<a name='1437'>
        ,intent (out  )                   ::                           &amp;<a name='1438'>
        edtc<a name='1439'>
     real,    dimension (its:ite)                                      &amp;<a name='1440'>
        ,intent (out  )                   ::                           &amp;<a name='1441'>
        edt<a name='1442'>
     real,    dimension (its:ite)                                      &amp;<a name='1443'>
        ,intent (in   )                   ::                           &amp;<a name='1444'>
        pwav,pwev<a name='1445'>
     real                                                              &amp;<a name='1446'>
        ,intent (in   )                   ::                           &amp;<a name='1447'>
        edtmax,edtmin<a name='1448'>
     integer, dimension (its:ite)                                      &amp;<a name='1449'>
        ,intent (in   )                   ::                           &amp;<a name='1450'>
        ktop,kbcon<a name='1451'>
     integer, dimension (its:ite)                                      &amp;<a name='1452'>
        ,intent (inout)                   ::                           &amp;<a name='1453'>
        ierr<a name='1454'>
<font color=#447700>!<a name='1455'></font>
<font color=#447700>!  local variables in this routine<a name='1456'></font>
<font color=#447700>!<a name='1457'></font>
<a name='1458'>
     integer i,k,kk<a name='1459'>
     real    einc,pef,pefb,prezk,zkbc<a name='1460'>
     real,    dimension (its:ite)         ::                           &amp;<a name='1461'>
      vshear,sdp,vws<a name='1462'>
<a name='1463'>
     integer :: itf, ktf<a name='1464'>
<a name='1465'>
     itf=MIN(ite,ide-1)<a name='1466'>
     ktf=MIN(kte,kde-1)<a name='1467'>
<font color=#447700>!<a name='1468'></font>
<font color=#447700>!--- DETERMINE DOWNDRAFT STRENGTH IN TERMS OF WINDSHEAR<a name='1469'></font>
<font color=#447700>!<a name='1470'></font>
<font color=#447700>! */ calculate an average wind shear over the depth of the cloud<a name='1471'></font>
<font color=#447700>!<a name='1472'></font>
       do i=its,itf<a name='1473'>
        edt(i)=0.<a name='1474'>
        vws(i)=0.<a name='1475'>
        sdp(i)=0.<a name='1476'>
        vshear(i)=0.<a name='1477'>
       enddo<a name='1478'>
       do kk = kts,ktf-1<a name='1479'>
         do 62 i=its,itf<a name='1480'>
          IF(ierr(i).ne.0)GO TO 62<a name='1481'>
          if (kk .le. min0(ktop(i),ktf) .and. kk .ge. kbcon(i)) then<a name='1482'>
             vws(i) = vws(i)+ &amp;<a name='1483'>
              (abs((us(i,kk+1)-us(i,kk))/(z(i,kk+1)-z(i,kk))) &amp;<a name='1484'>
          +   abs((vs(i,kk+1)-vs(i,kk))/(z(i,kk+1)-z(i,kk)))) * &amp;<a name='1485'>
              (p(i,kk) - p(i,kk+1))<a name='1486'>
            sdp(i) = sdp(i) + p(i,kk) - p(i,kk+1)<a name='1487'>
          endif<a name='1488'>
          if (kk .eq. ktf)vshear(i) = 1.e3 * vws(i) / sdp(i)<a name='1489'>
   62   continue<a name='1490'>
       end do<a name='1491'>
      do i=its,itf<a name='1492'>
         IF(ierr(i).eq.0)then<a name='1493'>
            pef=(1.591-.639*VSHEAR(I)+.0953*(VSHEAR(I)**2) &amp;<a name='1494'>
               -.00496*(VSHEAR(I)**3))<a name='1495'>
            if(pef.gt.edtmax)pef=edtmax<a name='1496'>
            if(pef.lt.edtmin)pef=edtmin<a name='1497'>
<font color=#447700>!<a name='1498'></font>
<font color=#447700>!--- cloud base precip efficiency<a name='1499'></font>
<font color=#447700>!<a name='1500'></font>
            zkbc=z(i,kbcon(i))*3.281e-3<a name='1501'>
            prezk=.02<a name='1502'>
            if(zkbc.gt.3.)then<a name='1503'>
               prezk=.96729352+zkbc*(-.70034167+zkbc*(.162179896+zkbc &amp;<a name='1504'>
               *(- 1.2569798E-2+zkbc*(4.2772E-4-zkbc*5.44E-6))))<a name='1505'>
            endif<a name='1506'>
            if(zkbc.gt.25)then<a name='1507'>
               prezk=2.4<a name='1508'>
            endif<a name='1509'>
            pefb=1./(1.+prezk)<a name='1510'>
            if(pefb.gt.edtmax)pefb=edtmax<a name='1511'>
            if(pefb.lt.edtmin)pefb=edtmin<a name='1512'>
            EDT(I)=1.-.5*(pefb+pef)<a name='1513'>
<font color=#447700>!--- edt here is 1-precipeff!<a name='1514'></font>
<font color=#447700>!           einc=(1.-edt(i))/float(maxens2)<a name='1515'></font>
<font color=#447700>!           einc=edt(i)/float(maxens2+1)<a name='1516'></font>
<font color=#447700>!--- 20 percent<a name='1517'></font>
            einc=.2*edt(i)<a name='1518'>
            do k=1,maxens2<a name='1519'>
                edtc(i,k)=edt(i)+float(k-2)*einc<a name='1520'>
            enddo<a name='1521'>
         endif<a name='1522'>
      enddo<a name='1523'>
      do i=its,itf<a name='1524'>
         IF(ierr(i).eq.0)then<a name='1525'>
            do k=1,maxens2<a name='1526'>
               EDTC(I,K)=-EDTC(I,K)*PWAV(I)/PWEV(I)<a name='1527'>
               IF(EDTC(I,K).GT.edtmax)EDTC(I,K)=edtmax<a name='1528'>
               IF(EDTC(I,K).LT.edtmin)EDTC(I,K)=edtmin<a name='1529'>
            enddo<a name='1530'>
         endif<a name='1531'>
      enddo<a name='1532'>
<a name='1533'>
   END SUBROUTINE cup_dd_edt<a name='1534'>
<a name='1535'>
<a name='1536'>
<A NAME='CUP_DD_HE'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_HE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1537'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_he</font>(hes_cup,zd,hcd,z_cup,cdd,entr,       &amp; <A href='../../call_to/CUP_DD_HE.html' TARGET='index'>3</A><a name='1538'>
              jmin,ierr,he,dby,he_cup,                       &amp;<a name='1539'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='1540'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='1541'>
              its,ite, jts,jte, kts,kte                     )<a name='1542'>
<a name='1543'>
   IMPLICIT NONE<a name='1544'>
<font color=#447700>!<a name='1545'></font>
<font color=#447700>!  on input<a name='1546'></font>
<font color=#447700>!<a name='1547'></font>
<a name='1548'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='1549'></font>
<a name='1550'>
     integer                                                           &amp;<a name='1551'>
        ,intent (in   )                   ::                           &amp;<a name='1552'>
                                  ids,ide, jds,jde, kds,kde,           &amp;<a name='1553'>
                                  ims,ime, jms,jme, kms,kme,           &amp;<a name='1554'>
                                  its,ite, jts,jte, kts,kte<a name='1555'>
  <font color=#447700>! hcd = downdraft moist static energy<a name='1556'></font>
  <font color=#447700>! he = moist static energy on model levels<a name='1557'></font>
  <font color=#447700>! he_cup = moist static energy on model cloud levels<a name='1558'></font>
  <font color=#447700>! hes_cup = saturation moist static energy on model cloud levels<a name='1559'></font>
  <font color=#447700>! dby = buoancy term<a name='1560'></font>
  <font color=#447700>! cdd= detrainment function <a name='1561'></font>
  <font color=#447700>! z_cup = heights of model cloud levels <a name='1562'></font>
  <font color=#447700>! entr = entrainment rate<a name='1563'></font>
  <font color=#447700>! zd   = downdraft normalized mass flux<a name='1564'></font>
  <font color=#447700>!<a name='1565'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1566'>
        ,intent (in   )                   ::                           &amp;<a name='1567'>
        he,he_cup,hes_cup,z_cup,cdd,zd<a name='1568'>
  <font color=#447700>! entr= entrainment rate <a name='1569'></font>
     real                                                              &amp;<a name='1570'>
        ,intent (in   )                   ::                           &amp;<a name='1571'>
        entr<a name='1572'>
     integer, dimension (its:ite)                                      &amp;<a name='1573'>
        ,intent (in   )                   ::                           &amp;<a name='1574'>
        jmin<a name='1575'>
<font color=#447700>!<a name='1576'></font>
<font color=#447700>! input and output<a name='1577'></font>
<font color=#447700>!<a name='1578'></font>
<a name='1579'>
   <font color=#447700>! ierr error value, maybe modified in this routine<a name='1580'></font>
<a name='1581'>
     integer, dimension (its:ite)                                      &amp;<a name='1582'>
        ,intent (inout)                   ::                           &amp;<a name='1583'>
        ierr<a name='1584'>
<a name='1585'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1586'>
        ,intent (out  )                   ::                           &amp;<a name='1587'>
        hcd,dby<a name='1588'>
<font color=#447700>!<a name='1589'></font>
<font color=#447700>!  local variables in this routine<a name='1590'></font>
<font color=#447700>!<a name='1591'></font>
<a name='1592'>
     integer                              ::                           &amp;<a name='1593'>
        i,k,ki<a name='1594'>
     real                                 ::                           &amp;<a name='1595'>
        dz<a name='1596'>
<a name='1597'>
     integer :: itf, ktf<a name='1598'>
<a name='1599'>
     itf=MIN(ite,ide-1)<a name='1600'>
     ktf=MIN(kte,kde-1)<a name='1601'>
<a name='1602'>
      do k=kts+1,ktf<a name='1603'>
      do i=its,itf<a name='1604'>
      dby(i,k)=0.<a name='1605'>
      IF(ierr(I).eq.0)then<a name='1606'>
         hcd(i,k)=hes_cup(i,k)<a name='1607'>
      endif<a name='1608'>
      enddo<a name='1609'>
      enddo<a name='1610'>
<font color=#447700>!<a name='1611'></font>
      do 100 i=its,itf<a name='1612'>
      IF(ierr(I).eq.0)then<a name='1613'>
      k=jmin(i)<a name='1614'>
      hcd(i,k)=hes_cup(i,k)<a name='1615'>
      dby(i,k)=hcd(i,jmin(i))-hes_cup(i,k)<a name='1616'>
<font color=#447700>!<a name='1617'></font>
      do ki=jmin(i)-1,1,-1<a name='1618'>
         DZ=Z_cup(i,Ki+1)-Z_cup(i,Ki)<a name='1619'>
         HCD(i,Ki)=(HCD(i,Ki+1)*(1.-.5*CDD(i,Ki)*DZ) &amp;<a name='1620'>
                  +entr*DZ*HE(i,Ki) &amp;<a name='1621'>
                  )/(1.+entr*DZ-.5*CDD(i,Ki)*DZ)<a name='1622'>
         dby(i,ki)=HCD(i,Ki)-hes_cup(i,ki)<a name='1623'>
      enddo<a name='1624'>
<font color=#447700>!<a name='1625'></font>
      endif<a name='1626'>
<font color=#447700>!--- end loop over i<a name='1627'></font>
100    continue<a name='1628'>
<a name='1629'>
<a name='1630'>
   END SUBROUTINE cup_dd_he<a name='1631'>
<a name='1632'>
<a name='1633'>
<A NAME='CUP_DD_MOISTURE'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_MOISTURE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1634'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_moisture</font>(zd,hcd,hes_cup,qcd,qes_cup,    &amp; <A href='../../call_to/CUP_DD_MOISTURE.html' TARGET='index'>3</A><a name='1635'>
              pwd,q_cup,z_cup,cdd,entr,jmin,ierr,            &amp;<a name='1636'>
              gamma_cup,pwev,bu,qrcd,                        &amp;<a name='1637'>
              q,he,t_cup,iloop,xl,                           &amp;<a name='1638'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='1639'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='1640'>
              its,ite, jts,jte, kts,kte                     )<a name='1641'>
<a name='1642'>
   IMPLICIT NONE<a name='1643'>
<a name='1644'>
     integer                                                           &amp;<a name='1645'>
        ,intent (in   )                   ::                           &amp;<a name='1646'>
                                  ids,ide, jds,jde, kds,kde,           &amp;<a name='1647'>
                                  ims,ime, jms,jme, kms,kme,           &amp;<a name='1648'>
                                  its,ite, jts,jte, kts,kte<a name='1649'>
  <font color=#447700>! cdd= detrainment function <a name='1650'></font>
  <font color=#447700>! q = environmental q on model levels<a name='1651'></font>
  <font color=#447700>! q_cup = environmental q on model cloud levels<a name='1652'></font>
  <font color=#447700>! qes_cup = saturation q on model cloud levels<a name='1653'></font>
  <font color=#447700>! hes_cup = saturation h on model cloud levels<a name='1654'></font>
  <font color=#447700>! hcd = h in model cloud<a name='1655'></font>
  <font color=#447700>! bu = buoancy term<a name='1656'></font>
  <font color=#447700>! zd = normalized downdraft mass flux<a name='1657'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='1658'></font>
  <font color=#447700>! mentr_rate = entrainment rate<a name='1659'></font>
  <font color=#447700>! qcd = cloud q (including liquid water) after entrainment<a name='1660'></font>
  <font color=#447700>! qrch = saturation q in cloud<a name='1661'></font>
  <font color=#447700>! pwd = evaporate at that level<a name='1662'></font>
  <font color=#447700>! pwev = total normalized integrated evaoprate (I2)<a name='1663'></font>
  <font color=#447700>! entr= entrainment rate <a name='1664'></font>
  <font color=#447700>!<a name='1665'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1666'>
        ,intent (in   )                   ::                           &amp;<a name='1667'>
        zd,t_cup,hes_cup,hcd,qes_cup,q_cup,z_cup,cdd,gamma_cup,q,he <a name='1668'>
     real                                                              &amp;<a name='1669'>
        ,intent (in   )                   ::                           &amp;<a name='1670'>
        entr,xl<a name='1671'>
     integer                                                           &amp;<a name='1672'>
        ,intent (in   )                   ::                           &amp;<a name='1673'>
        iloop<a name='1674'>
     integer, dimension (its:ite)                                      &amp;<a name='1675'>
        ,intent (in   )                   ::                           &amp;<a name='1676'>
        jmin<a name='1677'>
     integer, dimension (its:ite)                                      &amp;<a name='1678'>
        ,intent (inout)                   ::                           &amp;<a name='1679'>
        ierr<a name='1680'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1681'>
        ,intent (out  )                   ::                           &amp;<a name='1682'>
        qcd,qrcd,pwd<a name='1683'>
     real,    dimension (its:ite)                                      &amp;<a name='1684'>
        ,intent (out  )                   ::                           &amp;<a name='1685'>
        pwev,bu<a name='1686'>
<font color=#447700>!<a name='1687'></font>
<font color=#447700>!  local variables in this routine<a name='1688'></font>
<font color=#447700>!<a name='1689'></font>
<a name='1690'>
     integer                              ::                           &amp;<a name='1691'>
        i,k,ki<a name='1692'>
     real                                 ::                           &amp;<a name='1693'>
        dh,dz,dqeva<a name='1694'>
<a name='1695'>
     integer :: itf, ktf<a name='1696'>
<a name='1697'>
     itf=MIN(ite,ide-1)<a name='1698'>
     ktf=MIN(kte,kde-1)<a name='1699'>
<a name='1700'>
      do i=its,itf<a name='1701'>
         bu(i)=0.<a name='1702'>
         pwev(i)=0.<a name='1703'>
      enddo<a name='1704'>
      do k=kts,ktf<a name='1705'>
      do i=its,itf<a name='1706'>
         qcd(i,k)=0.<a name='1707'>
         qrcd(i,k)=0.<a name='1708'>
         pwd(i,k)=0.<a name='1709'>
      enddo<a name='1710'>
      enddo<a name='1711'>
<font color=#447700>!<a name='1712'></font>
<font color=#447700>!<a name='1713'></font>
<font color=#447700>!<a name='1714'></font>
      do 100 i=its,itf<a name='1715'>
      IF(ierr(I).eq.0)then<a name='1716'>
      k=jmin(i)<a name='1717'>
      DZ=Z_cup(i,K+1)-Z_cup(i,K)<a name='1718'>
      qcd(i,k)=q_cup(i,k)<a name='1719'>
<font color=#447700>!     qcd(i,k)=.5*(qes_cup(i,k)+q_cup(i,k))<a name='1720'></font>
      qrcd(i,k)=qes_cup(i,k)<a name='1721'>
      pwd(i,jmin(i))=min(0.,qcd(i,k)-qrcd(i,k))<a name='1722'>
      pwev(i)=pwev(i)+pwd(i,jmin(i))<a name='1723'>
      qcd(i,k)=qes_cup(i,k)<a name='1724'>
<font color=#447700>!<a name='1725'></font>
      DH=HCD(I,k)-HES_cup(I,K)<a name='1726'>
      bu(i)=dz*dh<a name='1727'>
      do ki=jmin(i)-1,1,-1<a name='1728'>
         DZ=Z_cup(i,Ki+1)-Z_cup(i,Ki)<a name='1729'>
         QCD(i,Ki)=(qCD(i,Ki+1)*(1.-.5*CDD(i,Ki)*DZ) &amp;<a name='1730'>
                  +entr*DZ*q(i,Ki) &amp;<a name='1731'>
                  )/(1.+entr*DZ-.5*CDD(i,Ki)*DZ)<a name='1732'>
<font color=#447700>!<a name='1733'></font>
<font color=#447700>!--- to be negatively buoyant, hcd should be smaller than hes!<a name='1734'></font>
<font color=#447700>!<a name='1735'></font>
         DH=HCD(I,ki)-HES_cup(I,Ki)<a name='1736'>
         bu(i)=bu(i)+dz*dh<a name='1737'>
         QRCD(I,Ki)=qes_cup(i,ki)+(1./XL)*(GAMMA_cup(i,ki) &amp;<a name='1738'>
                  /(1.+GAMMA_cup(i,ki)))*DH<a name='1739'>
         dqeva=qcd(i,ki)-qrcd(i,ki)<a name='1740'>
         if(dqeva.gt.0.)dqeva=0.<a name='1741'>
         pwd(i,ki)=zd(i,ki)*dqeva<a name='1742'>
         qcd(i,ki)=qrcd(i,ki)<a name='1743'>
         pwev(i)=pwev(i)+pwd(i,ki)<a name='1744'>
<font color=#447700>!        if(iloop.eq.1.and.i.eq.102.and.j.eq.62)then<a name='1745'></font>
<font color=#447700>!         print *,'in cup_dd_moi ', hcd(i,ki),HES_cup(I,Ki),dh,dqeva<a name='1746'></font>
<font color=#447700>!        endif<a name='1747'></font>
      enddo<a name='1748'>
<font color=#447700>!<a name='1749'></font>
<font color=#447700>!--- end loop over i<a name='1750'></font>
       if(pwev(I).eq.0.and.iloop.eq.1)then<a name='1751'>
<font color=#447700>!        print *,'problem with buoy in cup_dd_moisture',i<a name='1752'></font>
         ierr(i)=7<a name='1753'>
       endif<a name='1754'>
       if(BU(I).GE.0.and.iloop.eq.1)then<a name='1755'>
<font color=#447700>!        print *,'problem with buoy in cup_dd_moisture',i<a name='1756'></font>
         ierr(i)=7<a name='1757'>
       endif<a name='1758'>
      endif<a name='1759'>
100    continue<a name='1760'>
<a name='1761'>
   END SUBROUTINE cup_dd_moisture<a name='1762'>
<a name='1763'>
<a name='1764'>
<A NAME='CUP_DD_NMS'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_DD_NMS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1765'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_nms</font>(zd,z_cup,cdd,entr,jmin,ierr,        &amp; <A href='../../call_to/CUP_DD_NMS.html' TARGET='index'>3</A><a name='1766'>
              itest,kdet,z1,                                 &amp;<a name='1767'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='1768'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='1769'>
              its,ite, jts,jte, kts,kte                     )<a name='1770'>
<a name='1771'>
   IMPLICIT NONE<a name='1772'>
<font color=#447700>!<a name='1773'></font>
<font color=#447700>!  on input<a name='1774'></font>
<font color=#447700>!<a name='1775'></font>
<a name='1776'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='1777'></font>
<a name='1778'>
     integer                                                           &amp;<a name='1779'>
        ,intent (in   )                   ::                           &amp;<a name='1780'>
                                  ids,ide, jds,jde, kds,kde,           &amp;<a name='1781'>
                                  ims,ime, jms,jme, kms,kme,           &amp;<a name='1782'>
                                  its,ite, jts,jte, kts,kte<a name='1783'>
  <font color=#447700>! z_cup = height of cloud model level<a name='1784'></font>
  <font color=#447700>! z1 = terrain elevation<a name='1785'></font>
  <font color=#447700>! entr = downdraft entrainment rate<a name='1786'></font>
  <font color=#447700>! jmin = downdraft originating level<a name='1787'></font>
  <font color=#447700>! kdet = level above ground where downdraft start detraining<a name='1788'></font>
  <font color=#447700>! itest = flag to whether to calculate cdd<a name='1789'></font>
  <a name='1790'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1791'>
        ,intent (in   )                   ::                           &amp;<a name='1792'>
        z_cup<a name='1793'>
     real,    dimension (its:ite)                                      &amp;<a name='1794'>
        ,intent (in   )                   ::                           &amp;<a name='1795'>
        z1 <a name='1796'>
     real                                                              &amp;<a name='1797'>
        ,intent (in   )                   ::                           &amp;<a name='1798'>
        entr <a name='1799'>
     integer, dimension (its:ite)                                      &amp;<a name='1800'>
        ,intent (in   )                   ::                           &amp;<a name='1801'>
        jmin,kdet<a name='1802'>
     integer                                                           &amp;<a name='1803'>
        ,intent (in   )                   ::                           &amp;<a name='1804'>
        itest<a name='1805'>
<font color=#447700>!<a name='1806'></font>
<font color=#447700>! input and output<a name='1807'></font>
<font color=#447700>!<a name='1808'></font>
<a name='1809'>
   <font color=#447700>! ierr error value, maybe modified in this routine<a name='1810'></font>
<a name='1811'>
     integer, dimension (its:ite)                                      &amp;<a name='1812'>
        ,intent (inout)                   ::                           &amp;<a name='1813'>
                                                                 ierr<a name='1814'>
   <font color=#447700>! zd is the normalized downdraft mass flux<a name='1815'></font>
   <font color=#447700>! cdd is the downdraft detrainmen function<a name='1816'></font>
<a name='1817'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1818'>
        ,intent (out  )                   ::                           &amp;<a name='1819'>
                                                             zd<a name='1820'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1821'>
        ,intent (inout)                   ::                           &amp;<a name='1822'>
                                                             cdd<a name='1823'>
<font color=#447700>!<a name='1824'></font>
<font color=#447700>!  local variables in this routine<a name='1825'></font>
<font color=#447700>!<a name='1826'></font>
<a name='1827'>
     integer                              ::                           &amp;<a name='1828'>
                                                  i,k,ki<a name='1829'>
     real                                 ::                           &amp;<a name='1830'>
                                            a,perc,dz<a name='1831'>
<a name='1832'>
     integer :: itf, ktf<a name='1833'>
<a name='1834'>
     itf=MIN(ite,ide-1)<a name='1835'>
     ktf=MIN(kte,kde-1)<a name='1836'>
<font color=#447700>!<a name='1837'></font>
<font color=#447700>!--- perc is the percentage of mass left when hitting the ground<a name='1838'></font>
<font color=#447700>!<a name='1839'></font>
      perc=.03<a name='1840'>
<a name='1841'>
      do k=kts,ktf<a name='1842'>
      do i=its,itf<a name='1843'>
         zd(i,k)=0.<a name='1844'>
         if(itest.eq.0)cdd(i,k)=0.<a name='1845'>
      enddo<a name='1846'>
      enddo<a name='1847'>
      a=1.-perc<a name='1848'>
<font color=#447700>!<a name='1849'></font>
<font color=#447700>!<a name='1850'></font>
<font color=#447700>!<a name='1851'></font>
      do 100 i=its,itf<a name='1852'>
      IF(ierr(I).eq.0)then<a name='1853'>
      zd(i,jmin(i))=1.<a name='1854'>
<font color=#447700>!<a name='1855'></font>
<font color=#447700>!--- integrate downward, specify detrainment(cdd)!<a name='1856'></font>
<font color=#447700>!<a name='1857'></font>
      do ki=jmin(i)-1,1,-1<a name='1858'>
         DZ=Z_cup(i,Ki+1)-Z_cup(i,Ki)<a name='1859'>
         if(ki.le.kdet(i).and.itest.eq.0)then<a name='1860'>
           cdd(i,ki)=entr+(1.- (a*(z_cup(i,ki)-z1(i)) &amp;<a name='1861'>
                     +perc*(z_cup(i,kdet(i))-z1(i)) ) &amp;<a name='1862'>
                         /(a*(z_cup(i,ki+1)-z1(i)) &amp;<a name='1863'>
                      +perc*(z_cup(i,kdet(i))-z1(i))))/dz<a name='1864'>
         endif<a name='1865'>
         zd(i,ki)=zd(i,ki+1)*(1.+(entr-cdd(i,ki))*dz)<a name='1866'>
      enddo<a name='1867'>
<font color=#447700>!<a name='1868'></font>
      endif<a name='1869'>
<font color=#447700>!--- end loop over i<a name='1870'></font>
100    continue<a name='1871'>
<a name='1872'>
   END SUBROUTINE cup_dd_nms<a name='1873'>
<a name='1874'>
<a name='1875'>
<A NAME='CUP_DELLABOT'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_DELLABOT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1876'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dellabot</font>(ipr,jpr,he_cup,ierr,z_cup,p_cup,  &amp; <A href='../../call_to/CUP_DELLABOT.html' TARGET='index'>2</A><a name='1877'>
              hcd,edt,zd,cdd,he,della,j,mentrd_rate,z,g,     &amp;<a name='1878'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='1879'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='1880'>
              its,ite, jts,jte, kts,kte                     )<a name='1881'>
<a name='1882'>
   IMPLICIT NONE<a name='1883'>
<a name='1884'>
     integer                                                           &amp;<a name='1885'>
        ,intent (in   )                   ::                           &amp;<a name='1886'>
        ids,ide, jds,jde, kds,kde,           &amp;<a name='1887'>
        ims,ime, jms,jme, kms,kme,           &amp;<a name='1888'>
        its,ite, jts,jte, kts,kte<a name='1889'>
     integer, intent (in   )              ::                           &amp;<a name='1890'>
        j,ipr,jpr<a name='1891'>
  <font color=#447700>!<a name='1892'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='1893'></font>
  <font color=#447700>!<a name='1894'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1895'>
        ,intent (out  )                   ::                           &amp;<a name='1896'>
        della<a name='1897'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1898'>
        ,intent (in  )                   ::                           &amp;<a name='1899'>
        z_cup,p_cup,hcd,zd,cdd,he,z,he_cup<a name='1900'>
     real,    dimension (its:ite)                                      &amp;<a name='1901'>
        ,intent (in   )                   ::                           &amp;<a name='1902'>
        edt<a name='1903'>
     real                                                              &amp;<a name='1904'>
        ,intent (in   )                   ::                           &amp;<a name='1905'>
        g,mentrd_rate<a name='1906'>
     integer, dimension (its:ite)                                      &amp;<a name='1907'>
        ,intent (inout)                   ::                           &amp;<a name='1908'>
        ierr<a name='1909'>
<font color=#447700>!<a name='1910'></font>
<font color=#447700>!  local variables in this routine<a name='1911'></font>
<font color=#447700>!<a name='1912'></font>
<a name='1913'>
      integer i<a name='1914'>
      real detdo,detdo1,detdo2,entdo,dp,dz,subin,                      &amp;<a name='1915'>
      totmas<a name='1916'>
<font color=#447700>!<a name='1917'></font>
     integer :: itf, ktf<a name='1918'>
<a name='1919'>
     itf=MIN(ite,ide-1)<a name='1920'>
     ktf=MIN(kte,kde-1)<a name='1921'>
<font color=#447700>!<a name='1922'></font>
<font color=#447700>!<a name='1923'></font>
<font color=#447700>!      if(j.eq.jpr)print *,'in cup dellabot '<a name='1924'></font>
      do 100 i=its,itf<a name='1925'>
      della(i,1)=0.<a name='1926'>
      if(ierr(i).ne.0)go to 100<a name='1927'>
      dz=z_cup(i,2)-z_cup(i,1)<a name='1928'>
      DP=100.*(p_cup(i,1)-P_cup(i,2))<a name='1929'>
      detdo1=edt(i)*zd(i,2)*CDD(i,1)*DZ<a name='1930'>
      detdo2=edt(i)*zd(i,1)<a name='1931'>
      entdo=edt(i)*zd(i,2)*mentrd_rate*dz<a name='1932'>
      subin=-EDT(I)*zd(i,2)<a name='1933'>
      detdo=detdo1+detdo2-entdo+subin<a name='1934'>
      DELLA(I,1)=(detdo1*.5*(HCD(i,1)+HCD(i,2)) &amp;<a name='1935'>
                 +detdo2*hcd(i,1) &amp;<a name='1936'>
                 +subin*he_cup(i,2) &amp;<a name='1937'>
                 -entdo*he(i,1))*g/dp<a name='1938'>
 100  CONTINUE<a name='1939'>
<a name='1940'>
   END SUBROUTINE cup_dellabot<a name='1941'>
<a name='1942'>
<a name='1943'>
<A NAME='CUP_DELLAS'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_DELLAS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1944'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dellas</font>(ierr,z_cup,p_cup,hcd,edt,zd,cdd,              &amp; <A href='../../call_to/CUP_DELLAS.html' TARGET='index'>2</A>,<A href='../../call_from/CUP_DELLAS.html' TARGET='index'>1</A><a name='1945'>
              he,della,j,mentrd_rate,zu,g,                             &amp;<a name='1946'>
              cd,hc,ktop,k22,kbcon,mentr_rate,jmin,he_cup,kdet,kpbl,   &amp;<a name='1947'>
              ipr,jpr,name,                                            &amp;<a name='1948'>
              ids,ide, jds,jde, kds,kde,                               &amp;<a name='1949'>
              ims,ime, jms,jme, kms,kme,                               &amp;<a name='1950'>
              its,ite, jts,jte, kts,kte                               )<a name='1951'>
<a name='1952'>
   IMPLICIT NONE<a name='1953'>
<a name='1954'>
     integer                                                           &amp;<a name='1955'>
        ,intent (in   )                   ::                           &amp;<a name='1956'>
        ids,ide, jds,jde, kds,kde,           &amp;<a name='1957'>
        ims,ime, jms,jme, kms,kme,           &amp;<a name='1958'>
        its,ite, jts,jte, kts,kte<a name='1959'>
     integer, intent (in   )              ::                           &amp;<a name='1960'>
        j,ipr,jpr<a name='1961'>
  <font color=#447700>!<a name='1962'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='1963'></font>
  <font color=#447700>!<a name='1964'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1965'>
        ,intent (out  )                   ::                           &amp;<a name='1966'>
        della<a name='1967'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1968'>
        ,intent (in  )                   ::                           &amp;<a name='1969'>
        z_cup,p_cup,hcd,zd,cdd,he,hc,cd,zu,he_cup<a name='1970'>
     real,    dimension (its:ite)                                      &amp;<a name='1971'>
        ,intent (in   )                   ::                           &amp;<a name='1972'>
        edt<a name='1973'>
     real                                                              &amp;<a name='1974'>
        ,intent (in   )                   ::                           &amp;<a name='1975'>
        g,mentrd_rate,mentr_rate<a name='1976'>
     integer, dimension (its:ite)                                      &amp;<a name='1977'>
        ,intent (in   )                   ::                           &amp;<a name='1978'>
        kbcon,ktop,k22,jmin,kdet,kpbl<a name='1979'>
     integer, dimension (its:ite)                                      &amp;<a name='1980'>
        ,intent (inout)                   ::                           &amp;<a name='1981'>
        ierr<a name='1982'>
      character *(*), intent (in)        ::                           &amp;<a name='1983'>
       name<a name='1984'>
<font color=#447700>!<a name='1985'></font>
<font color=#447700>!  local variables in this routine<a name='1986'></font>
<font color=#447700>!<a name='1987'></font>
<a name='1988'>
      integer i,k<a name='1989'>
      real detdo1,detdo2,entdo,dp,dz,subin,detdo,entup,                &amp;<a name='1990'>
      detup,subdown,entdoj,entupk,detupk,totmas<a name='1991'>
<font color=#447700>!<a name='1992'></font>
     integer :: itf, ktf<a name='1993'>
<a name='1994'>
     itf=MIN(ite,ide-1)<a name='1995'>
     ktf=MIN(kte,kde-1)<a name='1996'>
<font color=#447700>!<a name='1997'></font>
<font color=#447700>!<a name='1998'></font>
      i=ipr<a name='1999'>
<font color=#447700>!      if(j.eq.jpr)then<a name='2000'></font>
<font color=#447700>!        print *,'in dellas kpbl(i),k22(i),kbcon(i),ktop(i),jmin(i)'<a name='2001'></font>
<font color=#447700>!        print *,kpbl(i),k22(i),kbcon(i),ktop(i),jmin(i)<a name='2002'></font>
<font color=#447700>!      endif<a name='2003'></font>
       DO K=kts+1,ktf<a name='2004'>
       do i=its,itf<a name='2005'>
          della(i,k)=0.<a name='2006'>
       enddo<a name='2007'>
       enddo<a name='2008'>
<font color=#447700>!<a name='2009'></font>
       DO 100 k=kts+1,ktf-1<a name='2010'>
       DO 100 i=its,ite<a name='2011'>
         IF(ierr(i).ne.0)GO TO 100<a name='2012'>
         IF(K.Gt.KTOP(I))GO TO 100<a name='2013'>
<font color=#447700>!<a name='2014'></font>
<font color=#447700>!--- SPECIFY DETRAINMENT OF DOWNDRAFT, HAS TO BE CONSISTENT<a name='2015'></font>
<font color=#447700>!--- WITH ZD CALCULATIONS IN SOUNDD.<a name='2016'></font>
<font color=#447700>!<a name='2017'></font>
         DZ=Z_cup(I,K+1)-Z_cup(I,K)<a name='2018'>
         detdo=edt(i)*CDD(i,K)*DZ*ZD(i,k+1)<a name='2019'>
         entdo=edt(i)*mentrd_rate*dz*zd(i,k+1)<a name='2020'>
         subin=zu(i,k+1)-zd(i,k+1)*edt(i)<a name='2021'>
         entup=0.<a name='2022'>
         detup=0.<a name='2023'>
         if(k.ge.kbcon(i).and.k.lt.ktop(i))then<a name='2024'>
            entup=mentr_rate*dz*zu(i,k)<a name='2025'>
            detup=CD(i,K+1)*DZ*ZU(i,k)<a name='2026'>
         endif<a name='2027'>
         subdown=(zu(i,k)-zd(i,k)*edt(i))<a name='2028'>
         entdoj=0.<a name='2029'>
         entupk=0.<a name='2030'>
         detupk=0.<a name='2031'>
<font color=#447700>!<a name='2032'></font>
         if(k.eq.jmin(i))then<a name='2033'>
         entdoj=edt(i)*zd(i,k)<a name='2034'>
         endif<a name='2035'>
<a name='2036'>
         if(k.eq.k22(i)-1)then<a name='2037'>
         entupk=zu(i,kpbl(i))<a name='2038'>
         endif<a name='2039'>
<a name='2040'>
         if(k.gt.kdet(i))then<a name='2041'>
            detdo=0.<a name='2042'>
         endif<a name='2043'>
<a name='2044'>
         if(k.eq.ktop(i)-0)then<a name='2045'>
         detupk=zu(i,ktop(i))<a name='2046'>
         subin=0.<a name='2047'>
         endif<a name='2048'>
         if(k.lt.kbcon(i))then<a name='2049'>
            detup=0.<a name='2050'>
         endif<a name='2051'>
<font color=#447700>!C<a name='2052'></font>
<font color=#447700>!C--- CHANGED DUE TO SUBSIDENCE AND ENTRAINMENT<a name='2053'></font>
<font color=#447700>!C<a name='2054'></font>
         totmas=subin-subdown+detup-entup-entdo+ &amp;<a name='2055'>
                 detdo-entupk-entdoj+detupk<a name='2056'>
<font color=#447700>!         if(j.eq.jpr.and.i.eq.ipr)print *,'k,totmas,sui,sud = ',k,<a name='2057'></font>
<font color=#447700>!     1   totmas,subin,subdown<a name='2058'></font>
<font color=#447700>!         if(j.eq.jpr.and.i.eq.ipr)print *,'updr stuff = ',detup,<a name='2059'></font>
<font color=#447700>!     1      entup,entupk,detupk<a name='2060'></font>
<font color=#447700>!         if(j.eq.jpr.and.i.eq.ipr)print *,'dddr stuff = ',entdo,<a name='2061'></font>
<font color=#447700>!     1      detdo,entdoj<a name='2062'></font>
         if(abs(totmas).gt.1.e-6)then<a name='2063'>
<font color=#447700>!           print *,'*********************',i,j,k,totmas,name<a name='2064'></font>
<font color=#447700>!           print *,kpbl(i),k22(i),kbcon(i),ktop(i)<a name='2065'></font>
<font color=#447700>!c          print *,'updr stuff = ',subin,<a name='2066'></font>
<font color=#447700>!c    1      subdown,detup,entup,entupk,detupk<a name='2067'></font>
<font color=#447700>!c          print *,'dddr stuff = ',entdo,<a name='2068'></font>
<font color=#447700>!c    1      detdo,entdoj<a name='2069'></font>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_DELLAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_138"> ( 'totmas .gt.1.e-6' )<a name='2070'>
         endif<a name='2071'>
         dp=100.*(p_cup(i,k-1)-p_cup(i,k))<a name='2072'>
         della(i,k)=(subin*he_cup(i,k+1) &amp;<a name='2073'>
                    -subdown*he_cup(i,k) &amp;<a name='2074'>
                    +detup*.5*(HC(i,K+1)+HC(i,K)) &amp;<a name='2075'>
                    +detdo*.5*(HCD(i,K+1)+HCD(i,K)) &amp;<a name='2076'>
                    -entup*he(i,k) &amp;<a name='2077'>
                    -entdo*he(i,k) &amp;<a name='2078'>
                    -entupk*he_cup(i,k22(i)) &amp;<a name='2079'>
                    -entdoj*he_cup(i,jmin(i)) &amp;<a name='2080'>
                    +detupk*hc(i,ktop(i)) &amp;<a name='2081'>
                     )*g/dp<a name='2082'>
<font color=#447700>!      if(i.eq.ipr.and.j.eq.jpr)then<a name='2083'></font>
<font color=#447700>!        print *,k,della(i,k),subin*he_cup(i,k+1),subdown*he_cup(i,k),<a name='2084'></font>
<font color=#447700>!     1            detdo*.5*(HCD(i,K+1)+HCD(i,K))<a name='2085'></font>
<font color=#447700>!        print *,k,detup*.5*(HC(i,K+1)+HC(i,K)),detupk*hc(i,ktop(i)),<a name='2086'></font>
<font color=#447700>!     1         entup*he(i,k),entdo*he(i,k)<a name='2087'></font>
<font color=#447700>!        print *,k,he_cup(i,k+1),he_cup(i,k),entupk*he_cup(i,k)<a name='2088'></font>
<font color=#447700>!      endif<a name='2089'></font>
<a name='2090'>
 100  CONTINUE<a name='2091'>
<a name='2092'>
   END SUBROUTINE cup_dellas<a name='2093'>
<a name='2094'>
<a name='2095'>
<A NAME='CUP_DIRECTION2'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_DIRECTION2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2096'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_direction2</font>(i,j,dir,id,massflx,             &amp;<a name='2097'>
              iresult,imass,massfld,                         &amp;<a name='2098'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='2099'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='2100'>
              its,ite, jts,jte, kts,kte                     )<a name='2101'>
<a name='2102'>
   IMPLICIT NONE<a name='2103'>
<a name='2104'>
     integer                                                           &amp;<a name='2105'>
        ,intent (in   )                   ::                           &amp;<a name='2106'>
        ids,ide, jds,jde, kds,kde,           &amp;<a name='2107'>
        ims,ime, jms,jme, kms,kme,           &amp;<a name='2108'>
        its,ite, jts,jte, kts,kte<a name='2109'>
     integer, intent (in   )              ::                           &amp;<a name='2110'>
        i,j,imass<a name='2111'>
     integer, intent (out  )              ::                           &amp;<a name='2112'>
        iresult<a name='2113'>
  <font color=#447700>!<a name='2114'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2115'></font>
  <font color=#447700>!<a name='2116'></font>
     integer,    dimension (ims:ime,jms:jme)                           &amp;<a name='2117'>
        ,intent (in   )                   ::                           &amp;<a name='2118'>
        id<a name='2119'>
     real,    dimension (ims:ime,jms:jme)                              &amp;<a name='2120'>
        ,intent (in   )                   ::                           &amp;<a name='2121'>
        massflx<a name='2122'>
     real,    dimension (its:ite)                                      &amp;<a name='2123'>
        ,intent (inout)                   ::                           &amp;<a name='2124'>
        dir<a name='2125'>
     real                                                              &amp;<a name='2126'>
        ,intent (out  )                   ::                           &amp;<a name='2127'>
        massfld<a name='2128'>
<font color=#447700>!<a name='2129'></font>
<font color=#447700>!  local variables in this routine<a name='2130'></font>
<font color=#447700>!<a name='2131'></font>
<a name='2132'>
       integer k,ia,ja,ib,jb<a name='2133'>
       real diff<a name='2134'>
<font color=#447700>!<a name='2135'></font>
<font color=#447700>!<a name='2136'></font>
<font color=#447700>!<a name='2137'></font>
       if(imass.eq.1)then<a name='2138'>
           massfld=massflx(i,j)<a name='2139'>
       endif<a name='2140'>
       iresult=0<a name='2141'>
<font color=#447700>!      return<a name='2142'></font>
       diff=22.5<a name='2143'>
       if(dir(i).lt.22.5)dir(i)=360.+dir(i)<a name='2144'>
       if(id(i,j).eq.1)iresult=1<a name='2145'>
<font color=#447700>!      ja=max(2,j-1)<a name='2146'></font>
<font color=#447700>!      ia=max(2,i-1)<a name='2147'></font>
<font color=#447700>!      jb=min(mjx-1,j+1)<a name='2148'></font>
<font color=#447700>!      ib=min(mix-1,i+1)<a name='2149'></font>
       ja=j-1<a name='2150'>
       ia=i-1<a name='2151'>
       jb=j+1<a name='2152'>
       ib=i+1<a name='2153'>
        if(dir(i).gt.90.-diff.and.dir(i).le.90.+diff)then<a name='2154'>
<font color=#447700>!--- steering flow from the east<a name='2155'></font>
          if(id(ib,j).eq.1)then<a name='2156'>
            iresult=1<a name='2157'>
            if(imass.eq.1)then<a name='2158'>
               massfld=max(massflx(ib,j),massflx(i,j))<a name='2159'>
            endif<a name='2160'>
            return<a name='2161'>
          endif<a name='2162'>
        else if(dir(i).gt.135.-diff.and.dir(i).le.135.+diff)then<a name='2163'>
<font color=#447700>!--- steering flow from the south-east<a name='2164'></font>
          if(id(ib,ja).eq.1)then<a name='2165'>
            iresult=1<a name='2166'>
            if(imass.eq.1)then<a name='2167'>
               massfld=max(massflx(ib,ja),massflx(i,j))<a name='2168'>
            endif<a name='2169'>
            return<a name='2170'>
          endif<a name='2171'>
<font color=#447700>!--- steering flow from the south<a name='2172'></font>
        else if(dir(i).gt.180.-diff.and.dir(i).le.180.+diff)then<a name='2173'>
          if(id(i,ja).eq.1)then<a name='2174'>
            iresult=1<a name='2175'>
            if(imass.eq.1)then<a name='2176'>
               massfld=max(massflx(i,ja),massflx(i,j))<a name='2177'>
            endif<a name='2178'>
            return<a name='2179'>
          endif<a name='2180'>
<font color=#447700>!--- steering flow from the south west<a name='2181'></font>
        else if(dir(i).gt.225.-diff.and.dir(i).le.225.+diff)then<a name='2182'>
          if(id(ia,ja).eq.1)then<a name='2183'>
            iresult=1<a name='2184'>
            if(imass.eq.1)then<a name='2185'>
               massfld=max(massflx(ia,ja),massflx(i,j))<a name='2186'>
            endif<a name='2187'>
            return<a name='2188'>
          endif<a name='2189'>
<font color=#447700>!--- steering flow from the west<a name='2190'></font>
        else if(dir(i).gt.270.-diff.and.dir(i).le.270.+diff)then<a name='2191'>
          if(id(ia,j).eq.1)then<a name='2192'>
            iresult=1<a name='2193'>
            if(imass.eq.1)then<a name='2194'>
               massfld=max(massflx(ia,j),massflx(i,j))<a name='2195'>
            endif<a name='2196'>
            return<a name='2197'>
          endif<a name='2198'>
<font color=#447700>!--- steering flow from the north-west<a name='2199'></font>
        else if(dir(i).gt.305.-diff.and.dir(i).le.305.+diff)then<a name='2200'>
          if(id(ia,jb).eq.1)then<a name='2201'>
            iresult=1<a name='2202'>
            if(imass.eq.1)then<a name='2203'>
               massfld=max(massflx(ia,jb),massflx(i,j))<a name='2204'>
            endif<a name='2205'>
            return<a name='2206'>
          endif<a name='2207'>
<font color=#447700>!--- steering flow from the north<a name='2208'></font>
        else if(dir(i).gt.360.-diff.and.dir(i).le.360.+diff)then<a name='2209'>
          if(id(i,jb).eq.1)then<a name='2210'>
            iresult=1<a name='2211'>
            if(imass.eq.1)then<a name='2212'>
               massfld=max(massflx(i,jb),massflx(i,j))<a name='2213'>
            endif<a name='2214'>
            return<a name='2215'>
          endif<a name='2216'>
<font color=#447700>!--- steering flow from the north-east<a name='2217'></font>
        else if(dir(i).gt.45.-diff.and.dir(i).le.45.+diff)then<a name='2218'>
          if(id(ib,jb).eq.1)then<a name='2219'>
            iresult=1<a name='2220'>
            if(imass.eq.1)then<a name='2221'>
               massfld=max(massflx(ib,jb),massflx(i,j))<a name='2222'>
            endif<a name='2223'>
            return<a name='2224'>
          endif<a name='2225'>
        endif<a name='2226'>
<a name='2227'>
   END SUBROUTINE cup_direction2<a name='2228'>
<a name='2229'>
<a name='2230'>
<A NAME='CUP_ENV'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2231'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_env</font>(z,qes,he,hes,t,q,p,z1,                 &amp; <A href='../../call_to/CUP_ENV.html' TARGET='index'>3</A><a name='2232'>
              psur,ierr,tcrit,itest,xl,cp,                   &amp;<a name='2233'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='2234'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='2235'>
              its,ite, jts,jte, kts,kte                     )<a name='2236'>
<a name='2237'>
   IMPLICIT NONE<a name='2238'>
<a name='2239'>
     integer                                                           &amp;<a name='2240'>
        ,intent (in   )                   ::                           &amp;<a name='2241'>
        ids,ide, jds,jde, kds,kde,           &amp;<a name='2242'>
        ims,ime, jms,jme, kms,kme,           &amp;<a name='2243'>
        its,ite, jts,jte, kts,kte<a name='2244'>
  <font color=#447700>!<a name='2245'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2246'></font>
  <font color=#447700>! q           = environmental mixing ratio<a name='2247'></font>
  <font color=#447700>! qes         = environmental saturation mixing ratio<a name='2248'></font>
  <font color=#447700>! t           = environmental temp<a name='2249'></font>
  <font color=#447700>! tv          = environmental virtual temp<a name='2250'></font>
  <font color=#447700>! p           = environmental pressure<a name='2251'></font>
  <font color=#447700>! z           = environmental heights<a name='2252'></font>
  <font color=#447700>! he          = environmental moist static energy<a name='2253'></font>
  <font color=#447700>! hes         = environmental saturation moist static energy<a name='2254'></font>
  <font color=#447700>! psur        = surface pressure<a name='2255'></font>
  <font color=#447700>! z1          = terrain elevation<a name='2256'></font>
  <font color=#447700>! <a name='2257'></font>
  <font color=#447700>!<a name='2258'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2259'>
        ,intent (in   )                   ::                           &amp;<a name='2260'>
        p,t<a name='2261'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2262'>
        ,intent (out  )                   ::                           &amp;<a name='2263'>
        he,hes,qes<a name='2264'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2265'>
        ,intent (inout)                   ::                           &amp;<a name='2266'>
        z,q<a name='2267'>
     real,    dimension (its:ite)                                      &amp;<a name='2268'>
        ,intent (in   )                   ::                           &amp;<a name='2269'>
        psur,z1<a name='2270'>
     real                                                              &amp;<a name='2271'>
        ,intent (in   )                   ::                           &amp;<a name='2272'>
        xl,cp<a name='2273'>
     integer, dimension (its:ite)                                      &amp;<a name='2274'>
        ,intent (inout)                   ::                           &amp;<a name='2275'>
        ierr<a name='2276'>
     integer                                                           &amp;<a name='2277'>
        ,intent (in   )                   ::                           &amp;<a name='2278'>
        itest<a name='2279'>
<font color=#447700>!<a name='2280'></font>
<font color=#447700>!  local variables in this routine<a name='2281'></font>
<font color=#447700>!<a name='2282'></font>
<a name='2283'>
     integer                              ::                           &amp;<a name='2284'>
       i,k,iph<a name='2285'>
      real, dimension (1:2) :: AE,BE,HT<a name='2286'>
      real, dimension (its:ite,kts:kte) :: tv<a name='2287'>
      real :: tcrit,e,tvbar<a name='2288'>
<a name='2289'>
     integer :: itf, ktf<a name='2290'>
<a name='2291'>
     itf=MIN(ite,ide-1)<a name='2292'>
     ktf=MIN(kte,kde-1)<a name='2293'>
<a name='2294'>
      HT(1)=XL/CP<a name='2295'>
      HT(2)=2.834E6/CP<a name='2296'>
      BE(1)=.622*HT(1)/.286<a name='2297'>
      AE(1)=BE(1)/273.+ALOG(610.71)<a name='2298'>
      BE(2)=.622*HT(2)/.286<a name='2299'>
      AE(2)=BE(2)/273.+ALOG(610.71)<a name='2300'>
<font color=#447700>!      print *, 'TCRIT = ', tcrit,its,ite<a name='2301'></font>
      DO k=kts,ktf<a name='2302'>
      do i=its,itf<a name='2303'>
        if(ierr(i).eq.0)then<a name='2304'>
<font color=#447700>!Csgb - IPH is for phase, dependent on TCRIT (water or ice)<a name='2305'></font>
        IPH=1<a name='2306'>
        IF(T(I,K).LE.TCRIT)IPH=2<a name='2307'>
<font color=#447700>!       print *, 'AE(IPH),BE(IPH) = ',AE(IPH),BE(IPH),AE(IPH)-BE(IPH),T(i,k),i,k<a name='2308'></font>
        E=EXP(AE(IPH)-BE(IPH)/T(I,K))<a name='2309'>
<font color=#447700>!       print *, 'P, E = ', P(I,K), E<a name='2310'></font>
        QES(I,K)=.622*E/(100.*P(I,K)-E)<a name='2311'>
        IF(QES(I,K).LE.1.E-08)QES(I,K)=1.E-08<a name='2312'>
        IF(Q(I,K).GT.QES(I,K))Q(I,K)=QES(I,K)<a name='2313'>
        TV(I,K)=T(I,K)+.608*Q(I,K)*T(I,K)<a name='2314'>
        endif<a name='2315'>
      enddo<a name='2316'>
      enddo<a name='2317'>
<font color=#447700>!<a name='2318'></font>
<font color=#447700>!--- z's are calculated with changed h's and q's and t's<a name='2319'></font>
<font color=#447700>!--- if itest=2<a name='2320'></font>
<font color=#447700>!<a name='2321'></font>
      if(itest.ne.2)then<a name='2322'>
         do i=its,itf<a name='2323'>
           if(ierr(i).eq.0)then<a name='2324'>
             Z(I,1)=max(0.,Z1(I))-(ALOG(P(I,1))- &amp;<a name='2325'>
                 ALOG(PSUR(I)))*287.*TV(I,1)/9.81<a name='2326'>
           endif<a name='2327'>
         enddo<a name='2328'>
<a name='2329'>
<font color=#447700>! --- calculate heights<a name='2330'></font>
         DO K=kts+1,ktf<a name='2331'>
         do i=its,itf<a name='2332'>
           if(ierr(i).eq.0)then<a name='2333'>
              TVBAR=.5*TV(I,K)+.5*TV(I,K-1)<a name='2334'>
              Z(I,K)=Z(I,K-1)-(ALOG(P(I,K))- &amp;<a name='2335'>
               ALOG(P(I,K-1)))*287.*TVBAR/9.81<a name='2336'>
           endif<a name='2337'>
         enddo<a name='2338'>
         enddo<a name='2339'>
      else<a name='2340'>
         do k=kts,ktf<a name='2341'>
         do i=its,itf<a name='2342'>
           if(ierr(i).eq.0)then<a name='2343'>
             z(i,k)=(he(i,k)-1004.*t(i,k)-2.5e6*q(i,k))/9.81<a name='2344'>
             z(i,k)=max(1.e-3,z(i,k))<a name='2345'>
           endif<a name='2346'>
         enddo<a name='2347'>
         enddo<a name='2348'>
      endif<a name='2349'>
<font color=#447700>!<a name='2350'></font>
<font color=#447700>!--- calculate moist static energy - HE<a name='2351'></font>
<font color=#447700>!    saturated moist static energy - HES<a name='2352'></font>
<font color=#447700>!<a name='2353'></font>
       DO k=kts,ktf<a name='2354'>
       do i=its,itf<a name='2355'>
         if(ierr(i).eq.0)then<a name='2356'>
         if(itest.eq.0)HE(I,K)=9.81*Z(I,K)+1004.*T(I,K)+2.5E06*Q(I,K)<a name='2357'>
         HES(I,K)=9.81*Z(I,K)+1004.*T(I,K)+2.5E06*QES(I,K)<a name='2358'>
         IF(HE(I,K).GE.HES(I,K))HE(I,K)=HES(I,K)<a name='2359'>
<font color=#447700>!         if(i.eq.2)then<a name='2360'></font>
<font color=#447700>!           print *,k,z(i,k),t(i,k),p(i,k),he(i,k),hes(i,k)<a name='2361'></font>
<font color=#447700>!         endif<a name='2362'></font>
         endif<a name='2363'>
      enddo<a name='2364'>
      enddo<a name='2365'>
<a name='2366'>
   END SUBROUTINE cup_env<a name='2367'>
<a name='2368'>
<a name='2369'>
<A NAME='CUP_ENV_CLEV'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_ENV_CLEV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2370'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_env_clev</font>(t,qes,q,he,hes,z,p,qes_cup,q_cup,   &amp; <A href='../../call_to/CUP_ENV_CLEV.html' TARGET='index'>3</A><a name='2371'>
              he_cup,hes_cup,z_cup,p_cup,gamma_cup,t_cup,psur, &amp;<a name='2372'>
              ierr,z1,xl,rv,cp,                                &amp;<a name='2373'>
              ids,ide, jds,jde, kds,kde,                       &amp;<a name='2374'>
              ims,ime, jms,jme, kms,kme,                       &amp;<a name='2375'>
              its,ite, jts,jte, kts,kte                       )<a name='2376'>
<a name='2377'>
   IMPLICIT NONE<a name='2378'>
<a name='2379'>
     integer                                                           &amp;<a name='2380'>
        ,intent (in   )                   ::                           &amp;<a name='2381'>
        ids,ide, jds,jde, kds,kde,           &amp;<a name='2382'>
        ims,ime, jms,jme, kms,kme,           &amp;<a name='2383'>
        its,ite, jts,jte, kts,kte<a name='2384'>
  <font color=#447700>!<a name='2385'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2386'></font>
  <font color=#447700>! q           = environmental mixing ratio<a name='2387'></font>
  <font color=#447700>! q_cup       = environmental mixing ratio on cloud levels<a name='2388'></font>
  <font color=#447700>! qes         = environmental saturation mixing ratio<a name='2389'></font>
  <font color=#447700>! qes_cup     = environmental saturation mixing ratio on cloud levels<a name='2390'></font>
  <font color=#447700>! t           = environmental temp<a name='2391'></font>
  <font color=#447700>! t_cup       = environmental temp on cloud levels<a name='2392'></font>
  <font color=#447700>! p           = environmental pressure<a name='2393'></font>
  <font color=#447700>! p_cup       = environmental pressure on cloud levels<a name='2394'></font>
  <font color=#447700>! z           = environmental heights<a name='2395'></font>
  <font color=#447700>! z_cup       = environmental heights on cloud levels<a name='2396'></font>
  <font color=#447700>! he          = environmental moist static energy<a name='2397'></font>
  <font color=#447700>! he_cup      = environmental moist static energy on cloud levels<a name='2398'></font>
  <font color=#447700>! hes         = environmental saturation moist static energy<a name='2399'></font>
  <font color=#447700>! hes_cup     = environmental saturation moist static energy on cloud levels<a name='2400'></font>
  <font color=#447700>! gamma_cup   = gamma on cloud levels<a name='2401'></font>
  <font color=#447700>! psur        = surface pressure<a name='2402'></font>
  <font color=#447700>! z1          = terrain elevation<a name='2403'></font>
  <font color=#447700>! <a name='2404'></font>
  <font color=#447700>!<a name='2405'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2406'>
        ,intent (in   )                   ::                           &amp;<a name='2407'>
        qes,q,he,hes,z,p,t<a name='2408'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2409'>
        ,intent (out  )                   ::                           &amp;<a name='2410'>
        qes_cup,q_cup,he_cup,hes_cup,z_cup,p_cup,gamma_cup,t_cup<a name='2411'>
     real,    dimension (its:ite)                                      &amp;<a name='2412'>
        ,intent (in   )                   ::                           &amp;<a name='2413'>
        psur,z1<a name='2414'>
     real                                                              &amp;<a name='2415'>
        ,intent (in   )                   ::                           &amp;<a name='2416'>
        xl,rv,cp<a name='2417'>
     integer, dimension (its:ite)                                      &amp;<a name='2418'>
        ,intent (inout)                   ::                           &amp;<a name='2419'>
        ierr<a name='2420'>
<font color=#447700>!<a name='2421'></font>
<font color=#447700>!  local variables in this routine<a name='2422'></font>
<font color=#447700>!<a name='2423'></font>
<a name='2424'>
     integer                              ::                           &amp;<a name='2425'>
       i,k<a name='2426'>
<a name='2427'>
     integer :: itf, ktf<a name='2428'>
<a name='2429'>
     itf=MIN(ite,ide-1)<a name='2430'>
     ktf=MIN(kte,kde-1)<a name='2431'>
<a name='2432'>
      do k=kts+1,ktf<a name='2433'>
      do i=its,itf<a name='2434'>
        if(ierr(i).eq.0)then<a name='2435'>
        qes_cup(i,k)=.5*(qes(i,k-1)+qes(i,k))<a name='2436'>
        q_cup(i,k)=.5*(q(i,k-1)+q(i,k))<a name='2437'>
        hes_cup(i,k)=.5*(hes(i,k-1)+hes(i,k))<a name='2438'>
        he_cup(i,k)=.5*(he(i,k-1)+he(i,k))<a name='2439'>
        if(he_cup(i,k).gt.hes_cup(i,k))he_cup(i,k)=hes_cup(i,k)<a name='2440'>
        z_cup(i,k)=.5*(z(i,k-1)+z(i,k))<a name='2441'>
        p_cup(i,k)=.5*(p(i,k-1)+p(i,k))<a name='2442'>
        t_cup(i,k)=.5*(t(i,k-1)+t(i,k))<a name='2443'>
        gamma_cup(i,k)=(xl/cp)*(xl/(rv*t_cup(i,k) &amp;<a name='2444'>
                       *t_cup(i,k)))*qes_cup(i,k)<a name='2445'>
        endif<a name='2446'>
      enddo<a name='2447'>
      enddo<a name='2448'>
      do i=its,itf<a name='2449'>
        if(ierr(i).eq.0)then<a name='2450'>
        qes_cup(i,1)=qes(i,1)<a name='2451'>
        q_cup(i,1)=q(i,1)<a name='2452'>
        hes_cup(i,1)=hes(i,1)<a name='2453'>
        he_cup(i,1)=he(i,1)<a name='2454'>
        z_cup(i,1)=.5*(z(i,1)+z1(i))<a name='2455'>
        p_cup(i,1)=.5*(p(i,1)+psur(i))<a name='2456'>
        t_cup(i,1)=t(i,1)<a name='2457'>
        gamma_cup(i,1)=xl/cp*(xl/(rv*t_cup(i,1) &amp;<a name='2458'>
                       *t_cup(i,1)))*qes_cup(i,1)<a name='2459'>
        endif<a name='2460'>
      enddo<a name='2461'>
<a name='2462'>
   END SUBROUTINE cup_env_clev<a name='2463'>
<a name='2464'>
<a name='2465'>
<A NAME='CUP_FORCING_ENS'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_FORCING_ENS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2466'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_forcing_ens</font>(aa0,aa1,xaa0,mbdt,dtime,ierr,ierr2,ierr3,&amp; <A href='../../call_to/CUP_FORCING_ENS.html' TARGET='index'>1</A><a name='2467'>
              xf_ens,j,name,maxens,iens,iedt,maxens2,maxens3,mconv,    &amp;<a name='2468'>
              p_cup,ktop,omeg,zd,k22,zu,pr_ens,edt,kbcon,massflx,      &amp;<a name='2469'>
              iact_old_gr,dir,ensdim,massfln,icoic,                    &amp;<a name='2470'>
              ids,ide, jds,jde, kds,kde,                               &amp;<a name='2471'>
              ims,ime, jms,jme, kms,kme,                               &amp;<a name='2472'>
              its,ite, jts,jte, kts,kte                               )<a name='2473'>
<a name='2474'>
   IMPLICIT NONE<a name='2475'>
<a name='2476'>
     integer                                                           &amp;<a name='2477'>
        ,intent (in   )                   ::                           &amp;<a name='2478'>
        ids,ide, jds,jde, kds,kde,           &amp;<a name='2479'>
        ims,ime, jms,jme, kms,kme,           &amp;<a name='2480'>
        its,ite, jts,jte, kts,kte<a name='2481'>
     integer, intent (in   )              ::                           &amp;<a name='2482'>
        j,ensdim,maxens,iens,iedt,maxens2,maxens3<a name='2483'>
  <font color=#447700>!<a name='2484'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2485'></font>
  <font color=#447700>! pr_ens = precipitation ensemble<a name='2486'></font>
  <font color=#447700>! xf_ens = mass flux ensembles<a name='2487'></font>
  <font color=#447700>! massfln = downdraft mass flux ensembles used in next timestep<a name='2488'></font>
  <font color=#447700>! omeg = omega from large scale model<a name='2489'></font>
  <font color=#447700>! mconv = moisture convergence from large scale model<a name='2490'></font>
  <font color=#447700>! zd      = downdraft normalized mass flux<a name='2491'></font>
  <font color=#447700>! zu      = updraft normalized mass flux<a name='2492'></font>
  <font color=#447700>! aa0     = cloud work function without forcing effects<a name='2493'></font>
  <font color=#447700>! aa1     = cloud work function with forcing effects<a name='2494'></font>
  <font color=#447700>! xaa0    = cloud work function with cloud effects (ensemble dependent)<a name='2495'></font>
  <font color=#447700>! edt     = epsilon<a name='2496'></font>
  <font color=#447700>! dir     = "storm motion"<a name='2497'></font>
  <font color=#447700>! mbdt    = arbitrary numerical parameter<a name='2498'></font>
  <font color=#447700>! dtime   = dt over which forcing is applied<a name='2499'></font>
  <font color=#447700>! iact_gr_old = flag to tell where convection was active<a name='2500'></font>
  <font color=#447700>! kbcon       = LFC of parcel from k22<a name='2501'></font>
  <font color=#447700>! k22         = updraft originating level<a name='2502'></font>
  <font color=#447700>! icoic       = flag if only want one closure (usually set to zero!)<a name='2503'></font>
  <font color=#447700>! name        = deep or shallow convection flag<a name='2504'></font>
  <font color=#447700>!<a name='2505'></font>
     real,    dimension (ims:ime,jms:jme,1:ensdim)                     &amp;<a name='2506'>
        ,intent (inout)                   ::                           &amp;<a name='2507'>
        pr_ens<a name='2508'>
     real,    dimension (ims:ime,jms:jme,1:ensdim)                     &amp;<a name='2509'>
        ,intent (out  )                   ::                           &amp;<a name='2510'>
        xf_ens,massfln<a name='2511'>
     real,    dimension (ims:ime,jms:jme)                              &amp;<a name='2512'>
        ,intent (in   )                   ::                           &amp;<a name='2513'>
        massflx<a name='2514'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2515'>
        ,intent (in   )                   ::                           &amp;<a name='2516'>
        omeg,zd,zu,p_cup<a name='2517'>
     real,    dimension (its:ite,1:maxens)                             &amp;<a name='2518'>
        ,intent (in   )                   ::                           &amp;<a name='2519'>
        xaa0<a name='2520'>
     real,    dimension (its:ite)                                      &amp;<a name='2521'>
        ,intent (in   )                   ::                           &amp;<a name='2522'>
        aa1,edt,dir,mconv<a name='2523'>
     real,    dimension (its:ite)                                      &amp;<a name='2524'>
        ,intent (inout)                   ::                           &amp;<a name='2525'>
        aa0<a name='2526'>
     real,    dimension (1:maxens)                                     &amp;<a name='2527'>
        ,intent (in   )                   ::                           &amp;<a name='2528'>
        mbdt<a name='2529'>
     real                                                              &amp;<a name='2530'>
        ,intent (in   )                   ::                           &amp;<a name='2531'>
        dtime<a name='2532'>
     integer, dimension (ims:ime,jms:jme)                              &amp;<a name='2533'>
        ,intent (in   )                   ::                           &amp;<a name='2534'>
        iact_old_gr<a name='2535'>
     integer, dimension (its:ite)                                      &amp;<a name='2536'>
        ,intent (in   )                   ::                           &amp;<a name='2537'>
        k22,kbcon,ktop<a name='2538'>
     integer, dimension (its:ite)                                      &amp;<a name='2539'>
        ,intent (inout)                   ::                           &amp;<a name='2540'>
        ierr,ierr2,ierr3<a name='2541'>
     integer                                                           &amp;<a name='2542'>
        ,intent (in   )                   ::                           &amp;<a name='2543'>
        icoic<a name='2544'>
      character *(*), intent (in)         ::                           &amp;<a name='2545'>
       name<a name='2546'>
<font color=#447700>!<a name='2547'></font>
<font color=#447700>!  local variables in this routine<a name='2548'></font>
<font color=#447700>!<a name='2549'></font>
<a name='2550'>
     real,    dimension (1:maxens3)       ::                           &amp;<a name='2551'>
       xff_ens3<a name='2552'>
     real,    dimension (1:maxens)        ::                           &amp;<a name='2553'>
       xk<a name='2554'>
     integer                              ::                           &amp;<a name='2555'>
       i,k,nall,n,ne,nens,nens3,iresult,iresultd,iresulte,mkxcrt,kclim<a name='2556'>
     parameter (mkxcrt=15)<a name='2557'>
     real                                 ::                           &amp;<a name='2558'>
       a1,massfld,xff0,xomg,aclim1,aclim2,aclim3,aclim4<a name='2559'>
     real,    dimension(1:mkxcrt)         ::                           &amp;<a name='2560'>
       pcrit,acrit,acritt<a name='2561'>
<a name='2562'>
     integer :: itf<a name='2563'>
<a name='2564'>
     itf=MIN(ite,ide-1)<a name='2565'>
<a name='2566'>
      DATA PCRIT/850.,800.,750.,700.,650.,600.,550.,500.,450.,400.,    &amp;<a name='2567'>
                 350.,300.,250.,200.,150./<a name='2568'>
      DATA ACRIT/.0633,.0445,.0553,.0664,.075,.1082,.1521,.2216,       &amp;<a name='2569'>
                 .3151,.3677,.41,.5255,.7663,1.1686,1.6851/<a name='2570'>
<font color=#447700>!  GDAS DERIVED ACRIT<a name='2571'></font>
      DATA ACRITT/.203,.515,.521,.566,.625,.665,.659,.688,             &amp;<a name='2572'>
                  .743,.813,.886,.947,1.138,1.377,1.896/<a name='2573'>
<font color=#447700>!<a name='2574'></font>
       nens=0<a name='2575'>
<a name='2576'>
<font color=#447700>!--- LARGE SCALE FORCING<a name='2577'></font>
<font color=#447700>!<a name='2578'></font>
       DO 100 i=its,itf<a name='2579'>
<font color=#447700>!       if(i.eq.ipr.and.j.eq.jpr)print *,'ierr = ',ierr(i)<a name='2580'></font>
          if(name.eq.'deeps'.and.ierr(i).gt.995)then<a name='2581'>
<font color=#447700>!          print *,i,j,ierr(i),aa0(i)<a name='2582'></font>
           aa0(i)=0.<a name='2583'>
           ierr(i)=0<a name='2584'>
          endif<a name='2585'>
          IF(ierr(i).eq.0)then<a name='2586'>
<font color=#447700>!           kclim=0<a name='2587'></font>
           do k=mkxcrt,1,-1<a name='2588'>
             if(p_cup(i,ktop(i)).lt.pcrit(k))then<a name='2589'>
               kclim=k<a name='2590'>
               go to 9<a name='2591'>
             endif<a name='2592'>
           enddo<a name='2593'>
           if(p_cup(i,ktop(i)).gt.pcrit(1))kclim=1<a name='2594'>
 9         continue<a name='2595'>
           kclim=max(kclim,1)<a name='2596'>
           k=max(kclim-1,1)<a name='2597'>
           aclim1=acrit(kclim)*1.e3<a name='2598'>
           aclim2=acrit(k)*1.e3<a name='2599'>
           aclim3=acritt(kclim)*1.e3<a name='2600'>
           aclim4=acritt(k)*1.e3<a name='2601'>
<font color=#447700>!           print *,'p_cup(ktop(i)),kclim,pcrit(kclim)'<a name='2602'></font>
<font color=#447700>!           print *,p_cup(i,ktop(i)),kclim,pcrit(kclim)<a name='2603'></font>
<font color=#447700>!           print *,'aclim1,aclim2,aclim3,aclim4'<a name='2604'></font>
<font color=#447700>!           print *,aclim1,aclim2,aclim3,aclim4<a name='2605'></font>
<font color=#447700>!           print *,dtime,name,ierr(i),aa1(i),aa0(i)<a name='2606'></font>
<font color=#447700>!          print *,dtime,name,ierr(i),aa1(i),aa0(i)<a name='2607'></font>
<font color=#447700>!<a name='2608'></font>
<font color=#447700>!--- treatment different for this closure<a name='2609'></font>
<font color=#447700>!<a name='2610'></font>
             if(name.eq.'deeps')then<a name='2611'>
<font color=#447700>!<a name='2612'></font>
                xff0= (AA1(I)-AA0(I))/DTIME<a name='2613'>
                xff_ens3(1)=(AA1(I)-AA0(I))/dtime<a name='2614'>
                xff_ens3(2)=.9*xff_ens3(1)<a name='2615'>
                xff_ens3(3)=1.1*xff_ens3(1)<a name='2616'>
<font color=#447700>!   <a name='2617'></font>
<font color=#447700>!--- more original Arakawa-Schubert (climatologic value of aa0)<a name='2618'></font>
<font color=#447700>!<a name='2619'></font>
<font color=#447700>!<a name='2620'></font>
<font color=#447700>!--- omeg is in bar/s, mconv done with omeg in Pa/s<a name='2621'></font>
<font color=#447700>!     more like Brown (1979), or Frank-Cohen (199?)<a name='2622'></font>
<font color=#447700>!<a name='2623'></font>
                xff_ens3(4)=-omeg(i,k22(i))/9.81<a name='2624'>
                xff_ens3(5)=-omeg(i,kbcon(i))/9.81<a name='2625'>
                xff_ens3(6)=-omeg(i,1)/9.81<a name='2626'>
                do k=2,kbcon(i)-1<a name='2627'>
                  xomg=-omeg(i,k)/9.81<a name='2628'>
                  if(xomg.gt.xff_ens3(6))xff_ens3(6)=xomg<a name='2629'>
                enddo<a name='2630'>
<font color=#447700>!<a name='2631'></font>
<font color=#447700>!--- more like Krishnamurti et al.<a name='2632'></font>
<font color=#447700>!<a name='2633'></font>
                xff_ens3(7)=mconv(i)<a name='2634'>
                xff_ens3(8)=mconv(i)<a name='2635'>
                xff_ens3(9)=mconv(i)<a name='2636'>
<font color=#447700>!<a name='2637'></font>
<font color=#447700>!--- more like Fritsch Chappel or Kain Fritsch (plus triggers)<a name='2638'></font>
<font color=#447700>!<a name='2639'></font>
                xff_ens3(10)=AA1(I)/(60.*20.)<a name='2640'>
                xff_ens3(11)=AA1(I)/(60.*30.)<a name='2641'>
                xff_ens3(12)=AA1(I)/(60.*40.)<a name='2642'>
<font color=#447700>!  <a name='2643'></font>
<font color=#447700>!--- more original Arakawa-Schubert (climatologic value of aa0)<a name='2644'></font>
<font color=#447700>!<a name='2645'></font>
                xff_ens3(13)=max(0.,(AA1(I)-aclim1)/dtime)<a name='2646'>
                xff_ens3(14)=max(0.,(AA1(I)-aclim2)/dtime)<a name='2647'>
                xff_ens3(15)=max(0.,(AA1(I)-aclim3)/dtime)<a name='2648'>
                xff_ens3(16)=max(0.,(AA1(I)-aclim4)/dtime)<a name='2649'>
<font color=#447700>!               if(ierr2(i).gt.0.or.ierr3(i).gt.0)then<a name='2650'></font>
<font color=#447700>!                 xff_ens3(10)=0.<a name='2651'></font>
<font color=#447700>!                 xff_ens3(11)=0.<a name='2652'></font>
<font color=#447700>!                 xff_ens3(12)=0.<a name='2653'></font>
<font color=#447700>!                 xff_ens3(13)=0.<a name='2654'></font>
<font color=#447700>!                 xff_ens3(14)=0.<a name='2655'></font>
<font color=#447700>!                 xff_ens3(15)=0.<a name='2656'></font>
<font color=#447700>!                 xff_ens3(16)=0.<a name='2657'></font>
<font color=#447700>!               endif<a name='2658'></font>
<a name='2659'>
                do nens=1,maxens<a name='2660'>
                   XK(nens)=(XAA0(I,nens)-AA1(I))/MBDT(2)<a name='2661'>
                   if(xk(nens).le.0.and.xk(nens).gt.-1.e-6) &amp;<a name='2662'>
                           xk(nens)=-1.e-6<a name='2663'>
                   if(xk(nens).gt.0.and.xk(nens).lt.1.e-6) &amp;<a name='2664'>
                           xk(nens)=1.e-6<a name='2665'>
                enddo<a name='2666'>
<font color=#447700>!<a name='2667'></font>
<font color=#447700>!--- add up all ensembles<a name='2668'></font>
<font color=#447700>!<a name='2669'></font>
                do 350 ne=1,maxens<a name='2670'>
<font color=#447700>!<a name='2671'></font>
<font color=#447700>!--- for every xk, we have maxens3 xffs<a name='2672'></font>
<font color=#447700>!--- iens is from outermost ensemble (most expensive!<a name='2673'></font>
<font color=#447700>!<a name='2674'></font>
<font color=#447700>!--- iedt (maxens2 belongs to it)<a name='2675'></font>
<font color=#447700>!--- is from second, next outermost, not so expensive<a name='2676'></font>
<font color=#447700>!<a name='2677'></font>
<font color=#447700>!--- so, for every outermost loop, we have maxens*maxens2*3<a name='2678'></font>
<font color=#447700>!--- ensembles!!! nall would be 0, if everything is on first<a name='2679'></font>
<font color=#447700>!--- loop index, then ne would start counting, then iedt, then iens....<a name='2680'></font>
<font color=#447700>!<a name='2681'></font>
                   iresult=0<a name='2682'>
                   iresultd=0<a name='2683'>
                   iresulte=0<a name='2684'>
                   nall=(iens-1)*maxens3*maxens*maxens2 &amp;<a name='2685'>
                        +(iedt-1)*maxens*maxens3 &amp;<a name='2686'>
                        +(ne-1)*maxens3<a name='2687'>
                if(ne.eq.2.and.ierr2(i).gt.0)then<a name='2688'>
                      xf_ens(i,j,nall+1) =0.<a name='2689'>
                      xf_ens(i,j,nall+2) =0.<a name='2690'>
                      xf_ens(i,j,nall+3) =0.<a name='2691'>
                      xf_ens(i,j,nall+4) =0.<a name='2692'>
                      xf_ens(i,j,nall+5) =0.<a name='2693'>
                      xf_ens(i,j,nall+6) =0.<a name='2694'>
                      xf_ens(i,j,nall+7) =0.<a name='2695'>
                      xf_ens(i,j,nall+8) =0.<a name='2696'>
                      xf_ens(i,j,nall+9) =0.<a name='2697'>
                      xf_ens(i,j,nall+10)=0.<a name='2698'>
                      xf_ens(i,j,nall+11)=0.<a name='2699'>
                      xf_ens(i,j,nall+12)=0.<a name='2700'>
                      xf_ens(i,j,nall+13)=0.<a name='2701'>
                      xf_ens(i,j,nall+14)=0.<a name='2702'>
                      xf_ens(i,j,nall+15)=0.<a name='2703'>
                      xf_ens(i,j,nall+16)=0.<a name='2704'>
                      do nens3=1,maxens3<a name='2705'>
                        massfln(i,j,nall+nens3)=0.<a name='2706'>
                      enddo<a name='2707'>
                    goto 350<a name='2708'>
                endif<a name='2709'>
                if(ne.eq.3.and.ierr3(i).gt.0)then<a name='2710'>
                      xf_ens(i,j,nall+1) =0.<a name='2711'>
                      xf_ens(i,j,nall+2) =0.<a name='2712'>
                      xf_ens(i,j,nall+3) =0.<a name='2713'>
                      xf_ens(i,j,nall+4) =0.<a name='2714'>
                      xf_ens(i,j,nall+5) =0.<a name='2715'>
                      xf_ens(i,j,nall+6) =0.<a name='2716'>
                      xf_ens(i,j,nall+7) =0.<a name='2717'>
                      xf_ens(i,j,nall+8) =0.<a name='2718'>
                      xf_ens(i,j,nall+9) =0.<a name='2719'>
                      xf_ens(i,j,nall+10)=0.<a name='2720'>
                      xf_ens(i,j,nall+11)=0.<a name='2721'>
                      xf_ens(i,j,nall+12)=0.<a name='2722'>
                      xf_ens(i,j,nall+13)=0.<a name='2723'>
                      xf_ens(i,j,nall+14)=0.<a name='2724'>
                      xf_ens(i,j,nall+15)=0.<a name='2725'>
                      xf_ens(i,j,nall+16)=0.<a name='2726'>
                      do nens3=1,maxens3<a name='2727'>
                        massfln(i,j,nall+nens3)=0.<a name='2728'>
                      enddo<a name='2729'>
                    goto 350<a name='2730'>
                endif<a name='2731'>
<font color=#447700>!--- check for upwind convection<a name='2732'></font>
<font color=#447700>!                  iresult=0<a name='2733'></font>
                   massfld=0.<a name='2734'>
<a name='2735'>
<font color=#447700>!                  call cup_direction2(i,j,dir,iact_old_gr, &amp;<a name='2736'></font>
<font color=#447700>!                       massflx,iresult,1,                  &amp;<a name='2737'></font>
<font color=#447700>!                       massfld,                            &amp;<a name='2738'></font>
<font color=#447700>!                       ids,ide, jds,jde, kds,kde,          &amp;<a name='2739'></font>
<font color=#447700>!                       ims,ime, jms,jme, kms,kme,          &amp;<a name='2740'></font>
<font color=#447700>!                       its,ite, jts,jte, kts,kte          )<a name='2741'></font>
<font color=#447700>!                  if(i.eq.ipr.and.j.eq.jpr.and.iedt.eq.1.and.ne.eq.1)then<a name='2742'></font>
<font color=#447700>!                  if(iedt.eq.1.and.ne.eq.1)then<a name='2743'></font>
<font color=#447700>!                   print *,massfld,ne,iedt,iens<a name='2744'></font>
<font color=#447700>!                   print *,xk(ne),xff_ens3(1),xff_ens3(2),xff_ens3(3)<a name='2745'></font>
<font color=#447700>!                  endif<a name='2746'></font>
<font color=#447700>!                  print *,i,j,massfld,aa0(i),aa1(i)<a name='2747'></font>
                   IF(XK(ne).lt.0.and.xff0.gt.0.)iresultd=1<a name='2748'>
                   iresulte=max(iresult,iresultd)<a name='2749'>
                   iresulte=1<a name='2750'>
                   if(iresulte.eq.1)then<a name='2751'>
<font color=#447700>!<a name='2752'></font>
<font color=#447700>!--- special treatment for stability closures<a name='2753'></font>
<font color=#447700>!<a name='2754'></font>
<a name='2755'>
                      if(xff0.gt.0.)then<a name='2756'>
                         xf_ens(i,j,nall+1)=max(0.,-xff_ens3(1)/xk(ne)) &amp;<a name='2757'>
                                        +massfld<a name='2758'>
                         xf_ens(i,j,nall+2)=max(0.,-xff_ens3(2)/xk(ne)) &amp;<a name='2759'>
                                        +massfld<a name='2760'>
                         xf_ens(i,j,nall+3)=max(0.,-xff_ens3(3)/xk(ne)) &amp;<a name='2761'>
                                        +massfld<a name='2762'>
                         xf_ens(i,j,nall+13)=max(0.,-xff_ens3(13)/xk(ne)) &amp;<a name='2763'>
                                        +massfld<a name='2764'>
                         xf_ens(i,j,nall+14)=max(0.,-xff_ens3(14)/xk(ne)) &amp;<a name='2765'>
                                        +massfld<a name='2766'>
                         xf_ens(i,j,nall+15)=max(0.,-xff_ens3(15)/xk(ne)) &amp;<a name='2767'>
                                        +massfld<a name='2768'>
                         xf_ens(i,j,nall+16)=max(0.,-xff_ens3(16)/xk(ne)) &amp;<a name='2769'>
                                        +massfld<a name='2770'>
                      else<a name='2771'>
                         xf_ens(i,j,nall+1)=massfld<a name='2772'>
                         xf_ens(i,j,nall+2)=massfld<a name='2773'>
                         xf_ens(i,j,nall+3)=massfld<a name='2774'>
                         xf_ens(i,j,nall+13)=massfld<a name='2775'>
                         xf_ens(i,j,nall+14)=massfld<a name='2776'>
                         xf_ens(i,j,nall+15)=massfld<a name='2777'>
                         xf_ens(i,j,nall+16)=massfld<a name='2778'>
                      endif<a name='2779'>
<font color=#447700>!<a name='2780'></font>
<font color=#447700>!--- if iresult.eq.1, following independent of xff0<a name='2781'></font>
<font color=#447700>!<a name='2782'></font>
                         xf_ens(i,j,nall+4)=max(0.,xff_ens3(4) &amp;<a name='2783'>
                            +massfld)<a name='2784'>
                         xf_ens(i,j,nall+5)=max(0.,xff_ens3(5) &amp;<a name='2785'>
                                        +massfld)<a name='2786'>
                         xf_ens(i,j,nall+6)=max(0.,xff_ens3(6) &amp;<a name='2787'>
                                        +massfld)<a name='2788'>
                         a1=max(1.e-3,pr_ens(i,j,nall+7))<a name='2789'>
                         xf_ens(i,j,nall+7)=max(0.,xff_ens3(7) &amp;<a name='2790'>
                                     /a1)<a name='2791'>
                         a1=max(1.e-3,pr_ens(i,j,nall+8))<a name='2792'>
                         xf_ens(i,j,nall+8)=max(0.,xff_ens3(8) &amp;<a name='2793'>
                                     /a1)<a name='2794'>
                         a1=max(1.e-3,pr_ens(i,j,nall+9))<a name='2795'>
                         xf_ens(i,j,nall+9)=max(0.,xff_ens3(9) &amp;<a name='2796'>
                                     /a1)<a name='2797'>
                         if(XK(ne).lt.0.)then<a name='2798'>
                            xf_ens(i,j,nall+10)=max(0., &amp;<a name='2799'>
                                        -xff_ens3(10)/xk(ne)) &amp;<a name='2800'>
                                        +massfld<a name='2801'>
                            xf_ens(i,j,nall+11)=max(0., &amp;<a name='2802'>
                                        -xff_ens3(11)/xk(ne)) &amp;<a name='2803'>
                                        +massfld<a name='2804'>
                            xf_ens(i,j,nall+12)=max(0., &amp;<a name='2805'>
                                        -xff_ens3(12)/xk(ne)) &amp;<a name='2806'>
                                        +massfld<a name='2807'>
                         else<a name='2808'>
                            xf_ens(i,j,nall+10)=massfld<a name='2809'>
                            xf_ens(i,j,nall+11)=massfld<a name='2810'>
                            xf_ens(i,j,nall+12)=massfld<a name='2811'>
                         endif<a name='2812'>
                      if(icoic.ge.1)then<a name='2813'>
                      xf_ens(i,j,nall+1)=xf_ens(i,j,nall+icoic)<a name='2814'>
                      xf_ens(i,j,nall+2)=xf_ens(i,j,nall+icoic)<a name='2815'>
                      xf_ens(i,j,nall+3)=xf_ens(i,j,nall+icoic)<a name='2816'>
                      xf_ens(i,j,nall+4)=xf_ens(i,j,nall+icoic)<a name='2817'>
                      xf_ens(i,j,nall+5)=xf_ens(i,j,nall+icoic)<a name='2818'>
                      xf_ens(i,j,nall+6)=xf_ens(i,j,nall+icoic)<a name='2819'>
                      xf_ens(i,j,nall+7)=xf_ens(i,j,nall+icoic)<a name='2820'>
                      xf_ens(i,j,nall+8)=xf_ens(i,j,nall+icoic)<a name='2821'>
                      xf_ens(i,j,nall+9)=xf_ens(i,j,nall+icoic)<a name='2822'>
                      xf_ens(i,j,nall+10)=xf_ens(i,j,nall+icoic)<a name='2823'>
                      xf_ens(i,j,nall+11)=xf_ens(i,j,nall+icoic)<a name='2824'>
                      xf_ens(i,j,nall+12)=xf_ens(i,j,nall+icoic)<a name='2825'>
                      xf_ens(i,j,nall+13)=xf_ens(i,j,nall+icoic)<a name='2826'>
                      xf_ens(i,j,nall+14)=xf_ens(i,j,nall+icoic)<a name='2827'>
                      xf_ens(i,j,nall+15)=xf_ens(i,j,nall+icoic)<a name='2828'>
                      xf_ens(i,j,nall+16)=xf_ens(i,j,nall+icoic)<a name='2829'>
                      endif<a name='2830'>
<font color=#447700>!<a name='2831'></font>
<font color=#447700>! replace 13-16 for now with other stab closures<a name='2832'></font>
<font color=#447700>! (13 gave problems for mass model)<a name='2833'></font>
<font color=#447700>!<a name='2834'></font>
<font color=#447700>!                     xf_ens(i,j,nall+13)=xf_ens(i,j,nall+1)<a name='2835'></font>
                      if(icoic.eq.0)xf_ens(i,j,nall+14)=xf_ens(i,j,nall+13)<a name='2836'>
<font color=#447700>!                     xf_ens(i,j,nall+15)=xf_ens(i,j,nall+11)<a name='2837'></font>
<font color=#447700>!                     xf_ens(i,j,nall+16)=xf_ens(i,j,nall+11)<a name='2838'></font>
<font color=#447700>!                     xf_ens(i,j,nall+7)=xf_ens(i,j,nall+4)<a name='2839'></font>
<font color=#447700>!                     xf_ens(i,j,nall+8)=xf_ens(i,j,nall+5)<a name='2840'></font>
<font color=#447700>!                     xf_ens(i,j,nall+9)=xf_ens(i,j,nall+6)<a name='2841'></font>
<font color=#447700>!<a name='2842'></font>
<font color=#447700>!--- store new for next time step<a name='2843'></font>
<font color=#447700>!<a name='2844'></font>
                      do nens3=1,maxens3<a name='2845'>
                        massfln(i,j,nall+nens3)=edt(i) &amp;<a name='2846'>
                                                *xf_ens(i,j,nall+nens3)<a name='2847'>
                        massfln(i,j,nall+nens3)=max(0., &amp;<a name='2848'>
                                              massfln(i,j,nall+nens3))<a name='2849'>
                      enddo<a name='2850'>
                   endif<a name='2851'>
<font color=#447700>!               enddo<a name='2852'></font>
 350            continue<a name='2853'>
                go to 100<a name='2854'>
             endif<a name='2855'>
          elseif(ierr(i).ne.20.and.ierr(i).ne.0)then<a name='2856'>
             do n=1,ensdim<a name='2857'>
               xf_ens(i,j,n)=0.<a name='2858'>
               massfln(i,j,n)=0.<a name='2859'>
             enddo<a name='2860'>
          endif<a name='2861'>
 100   continue<a name='2862'>
<a name='2863'>
   END SUBROUTINE cup_forcing_ens<a name='2864'>
<a name='2865'>
<a name='2866'>
<A NAME='CUP_KBCON'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_KBCON' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2867'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_kbcon</font>(cap_inc,iloop,k22,kbcon,he_cup,hes_cup, &amp; <A href='../../call_to/CUP_KBCON.html' TARGET='index'>3</A><a name='2868'>
              ierr,kbmax,p_cup,cap_max,                         &amp;<a name='2869'>
              ids,ide, jds,jde, kds,kde,                        &amp;<a name='2870'>
              ims,ime, jms,jme, kms,kme,                        &amp;<a name='2871'>
              its,ite, jts,jte, kts,kte                        )<a name='2872'>
<a name='2873'>
   IMPLICIT NONE<a name='2874'>
<font color=#447700>!<a name='2875'></font>
<a name='2876'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='2877'></font>
<a name='2878'>
     integer                                                           &amp;<a name='2879'>
        ,intent (in   )                   ::                           &amp;<a name='2880'>
        ids,ide, jds,jde, kds,kde,           &amp;<a name='2881'>
        ims,ime, jms,jme, kms,kme,           &amp;<a name='2882'>
        its,ite, jts,jte, kts,kte<a name='2883'>
  <font color=#447700>! <a name='2884'></font>
  <font color=#447700>! <a name='2885'></font>
  <font color=#447700>! <a name='2886'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2887'></font>
  <font color=#447700>!<a name='2888'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2889'>
        ,intent (in   )                   ::                           &amp;<a name='2890'>
        he_cup,hes_cup,p_cup<a name='2891'>
     real,    dimension (its:ite)                                      &amp;<a name='2892'>
        ,intent (in   )                   ::                           &amp;<a name='2893'>
        cap_max<a name='2894'>
     real,   intent (in   )                   ::                           &amp;<a name='2895'>
        cap_inc<a name='2896'>
     integer, dimension (its:ite)                                      &amp;<a name='2897'>
        ,intent (in   )                   ::                           &amp;<a name='2898'>
        kbmax<a name='2899'>
     integer, dimension (its:ite)                                      &amp;<a name='2900'>
        ,intent (inout)                   ::                           &amp;<a name='2901'>
        kbcon,k22,ierr<a name='2902'>
     integer                                                           &amp;<a name='2903'>
        ,intent (in   )                   ::                           &amp;<a name='2904'>
        iloop<a name='2905'>
<font color=#447700>!<a name='2906'></font>
<font color=#447700>!  local variables in this routine<a name='2907'></font>
<font color=#447700>!<a name='2908'></font>
<a name='2909'>
     integer                              ::                           &amp;<a name='2910'>
        i<a name='2911'>
     real                                 ::                           &amp;<a name='2912'>
        pbcdif,plus<a name='2913'>
     integer :: itf<a name='2914'>
<a name='2915'>
     itf=MIN(ite,ide-1)<a name='2916'>
<font color=#447700>!<a name='2917'></font>
<font color=#447700>!--- DETERMINE THE LEVEL OF CONVECTIVE CLOUD BASE  - KBCON<a name='2918'></font>
<font color=#447700>!<a name='2919'></font>
       DO 27 i=its,itf<a name='2920'>
      kbcon(i)=1<a name='2921'>
      IF(ierr(I).ne.0)GO TO 27<a name='2922'>
      KBCON(I)=K22(I)<a name='2923'>
      GO TO 32<a name='2924'>
 31   CONTINUE<a name='2925'>
      KBCON(I)=KBCON(I)+1<a name='2926'>
      IF(KBCON(I).GT.KBMAX(i)+2)THEN<a name='2927'>
         if(iloop.lt.4)ierr(i)=3<a name='2928'>
<font color=#447700>!        if(iloop.lt.4)ierr(i)=997<a name='2929'></font>
        GO TO 27<a name='2930'>
      ENDIF<a name='2931'>
 32   CONTINUE<a name='2932'>
      IF(HE_cup(I,K22(I)).LT.HES_cup(I,KBCON(I)))GO TO 31<a name='2933'>
<a name='2934'>
<font color=#447700>!     cloud base pressure and max moist static energy pressure<a name='2935'></font>
<font color=#447700>!     i.e., the depth (in mb) of the layer of negative buoyancy<a name='2936'></font>
      if(KBCON(I)-K22(I).eq.1)go to 27<a name='2937'>
      PBCDIF=-P_cup(I,KBCON(I))+P_cup(I,K22(I))<a name='2938'>
      plus=cap_max(i)-float(iloop-1)*cap_inc<a name='2939'>
      if(iloop.eq.4)plus=cap_max(i)<a name='2940'>
      IF(PBCDIF.GT.plus)THEN<a name='2941'>
        K22(I)=K22(I)+1<a name='2942'>
        KBCON(I)=K22(I)<a name='2943'>
        GO TO 32<a name='2944'>
      ENDIF<a name='2945'>
 27   CONTINUE<a name='2946'>
<a name='2947'>
   END SUBROUTINE cup_kbcon<a name='2948'>
<a name='2949'>
<a name='2950'>
<A NAME='CUP_KBCON_CIN'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_KBCON_CIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2951'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_kbcon_cin</font>(iloop,k22,kbcon,he_cup,hes_cup,  &amp;<a name='2952'>
              z,tmean,qes,ierr,kbmax,p_cup,cap_max,xl,cp,    &amp;<a name='2953'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='2954'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='2955'>
              its,ite, jts,jte, kts,kte                     )<a name='2956'>
<a name='2957'>
   IMPLICIT NONE<a name='2958'>
<font color=#447700>!<a name='2959'></font>
<a name='2960'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='2961'></font>
<a name='2962'>
     integer                                                           &amp;<a name='2963'>
        ,intent (in   )                   ::                           &amp;<a name='2964'>
        ids,ide, jds,jde, kds,kde,           &amp;<a name='2965'>
        ims,ime, jms,jme, kms,kme,           &amp;<a name='2966'>
        its,ite, jts,jte, kts,kte<a name='2967'>
  <font color=#447700>! <a name='2968'></font>
  <font color=#447700>! <a name='2969'></font>
  <font color=#447700>! <a name='2970'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2971'></font>
  <font color=#447700>!<a name='2972'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2973'>
        ,intent (in   )                   ::                           &amp;<a name='2974'>
        he_cup,hes_cup,p_cup,z,tmean,qes<a name='2975'>
     real,    dimension (its:ite)                                      &amp;<a name='2976'>
        ,intent (in   )                   ::                           &amp;<a name='2977'>
        cap_max<a name='2978'>
     real                                                              &amp;<a name='2979'>
        ,intent (in   )                   ::                           &amp;<a name='2980'>
        xl,cp<a name='2981'>
     integer, dimension (its:ite)                                      &amp;<a name='2982'>
        ,intent (in   )                   ::                           &amp;<a name='2983'>
        kbmax<a name='2984'>
     integer, dimension (its:ite)                                      &amp;<a name='2985'>
        ,intent (inout)                   ::                           &amp;<a name='2986'>
        kbcon,k22,ierr<a name='2987'>
     integer                                                           &amp;<a name='2988'>
        ,intent (in   )                   ::                           &amp;<a name='2989'>
        iloop<a name='2990'>
<font color=#447700>!<a name='2991'></font>
<font color=#447700>!  local variables in this routine<a name='2992'></font>
<font color=#447700>!<a name='2993'></font>
<a name='2994'>
     integer                              ::                           &amp;<a name='2995'>
        i,k<a name='2996'>
     real                                 ::                           &amp;<a name='2997'>
        cin,cin_max,dh,tprim,gamma<a name='2998'>
<font color=#447700>!<a name='2999'></font>
     integer :: itf<a name='3000'>
<a name='3001'>
     itf=MIN(ite,ide-1)<a name='3002'>
<font color=#447700>!<a name='3003'></font>
<font color=#447700>!<a name='3004'></font>
    <a name='3005'>
<font color=#447700>!<a name='3006'></font>
<font color=#447700>!--- DETERMINE THE LEVEL OF CONVECTIVE CLOUD BASE  - KBCON<a name='3007'></font>
<font color=#447700>!<a name='3008'></font>
       DO 27 i=its,itf<a name='3009'>
      cin_max=-cap_max(i)<a name='3010'>
      kbcon(i)=1<a name='3011'>
      cin = 0.<a name='3012'>
      IF(ierr(I).ne.0)GO TO 27<a name='3013'>
      KBCON(I)=K22(I)<a name='3014'>
      GO TO 32<a name='3015'>
 31   CONTINUE<a name='3016'>
      KBCON(I)=KBCON(I)+1<a name='3017'>
      IF(KBCON(I).GT.KBMAX(i)+2)THEN<a name='3018'>
         if(iloop.eq.1)ierr(i)=3<a name='3019'>
<font color=#447700>!        if(iloop.eq.2)ierr(i)=997<a name='3020'></font>
        GO TO 27<a name='3021'>
      ENDIF<a name='3022'>
 32   CONTINUE<a name='3023'>
      dh      = HE_cup(I,K22(I)) - HES_cup(I,KBCON(I))<a name='3024'>
      if (dh.lt. 0.) then<a name='3025'>
        GAMMA=(xl/cp)*(xl/(461.525*(Tmean(I,K22(i))**2)))*QES(I,K22(i))<a name='3026'>
        tprim = dh/(cp*(1.+gamma))<a name='3027'>
<a name='3028'>
        cin = cin + 9.8066 * tprim &amp;<a name='3029'>
              *(z(i,k22(i))-z(i,k22(i)-1)) / tmean(i,k22(i))<a name='3030'>
        go to 31<a name='3031'>
      end if<a name='3032'>
<a name='3033'>
<a name='3034'>
<font color=#447700>!     If negative energy in negatively buoyant layer<a name='3035'></font>
<font color=#447700>!       exceeds convective inhibition (CIN) threshold,<a name='3036'></font>
<font color=#447700>!       then set K22 level one level up and see if that<a name='3037'></font>
<font color=#447700>!       will work.<a name='3038'></font>
<a name='3039'>
      IF(cin.lT.cin_max)THEN<a name='3040'>
<font color=#447700>!       print *,i,cin,cin_max,k22(i),kbcon(i)<a name='3041'></font>
        K22(I)=K22(I)+1<a name='3042'>
        KBCON(I)=K22(I)<a name='3043'>
        GO TO 32<a name='3044'>
      ENDIF<a name='3045'>
 27   CONTINUE<a name='3046'>
<a name='3047'>
   END SUBROUTINE cup_kbcon_cin<a name='3048'>
<a name='3049'>
<a name='3050'>
<A NAME='CUP_KTOP'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_KTOP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3051'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_ktop</font>(ilo,dby,kbcon,ktop,ierr,              &amp; <A href='../../call_to/CUP_KTOP.html' TARGET='index'>1</A><a name='3052'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='3053'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='3054'>
              its,ite, jts,jte, kts,kte                     )<a name='3055'>
<a name='3056'>
   IMPLICIT NONE<a name='3057'>
<font color=#447700>!<a name='3058'></font>
<font color=#447700>!  on input<a name='3059'></font>
<font color=#447700>!<a name='3060'></font>
<a name='3061'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3062'></font>
<a name='3063'>
     integer                                                           &amp;<a name='3064'>
        ,intent (in   )                   ::                           &amp;<a name='3065'>
        ids,ide, jds,jde, kds,kde,           &amp;<a name='3066'>
        ims,ime, jms,jme, kms,kme,           &amp;<a name='3067'>
        its,ite, jts,jte, kts,kte<a name='3068'>
  <font color=#447700>! dby = buoancy term<a name='3069'></font>
  <font color=#447700>! ktop = cloud top (output)<a name='3070'></font>
  <font color=#447700>! ilo  = flag<a name='3071'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='3072'></font>
  <font color=#447700>!<a name='3073'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3074'>
        ,intent (inout)                   ::                           &amp;<a name='3075'>
        dby<a name='3076'>
     integer, dimension (its:ite)                                      &amp;<a name='3077'>
        ,intent (in   )                   ::                           &amp;<a name='3078'>
        kbcon<a name='3079'>
     integer                                                           &amp;<a name='3080'>
        ,intent (in   )                   ::                           &amp;<a name='3081'>
        ilo<a name='3082'>
     integer, dimension (its:ite)                                      &amp;<a name='3083'>
        ,intent (out  )                   ::                           &amp;<a name='3084'>
        ktop<a name='3085'>
     integer, dimension (its:ite)                                      &amp;<a name='3086'>
        ,intent (inout)                   ::                           &amp;<a name='3087'>
        ierr<a name='3088'>
<font color=#447700>!<a name='3089'></font>
<font color=#447700>!  local variables in this routine<a name='3090'></font>
<font color=#447700>!<a name='3091'></font>
<a name='3092'>
     integer                              ::                           &amp;<a name='3093'>
        i,k<a name='3094'>
<font color=#447700>!<a name='3095'></font>
     integer :: itf, ktf<a name='3096'>
<a name='3097'>
     itf=MIN(ite,ide-1)<a name='3098'>
     ktf=MIN(kte,kde-1)<a name='3099'>
<font color=#447700>!<a name='3100'></font>
<font color=#447700>!<a name='3101'></font>
        DO 42 i=its,itf<a name='3102'>
        ktop(i)=1<a name='3103'>
         IF(ierr(I).EQ.0)then<a name='3104'>
          DO 40 K=KBCON(I)+1,ktf-1<a name='3105'>
            IF(DBY(I,K).LE.0.)THEN<a name='3106'>
                KTOP(I)=K-1<a name='3107'>
                GO TO 41<a name='3108'>
             ENDIF<a name='3109'>
  40      CONTINUE<a name='3110'>
          if(ilo.eq.1)ierr(i)=5<a name='3111'>
<font color=#447700>!         if(ilo.eq.2)ierr(i)=998<a name='3112'></font>
          GO TO 42<a name='3113'>
  41     CONTINUE<a name='3114'>
         do k=ktop(i)+1,ktf<a name='3115'>
           dby(i,k)=0.<a name='3116'>
         enddo<a name='3117'>
         endif<a name='3118'>
  42     CONTINUE<a name='3119'>
<a name='3120'>
   END SUBROUTINE cup_ktop<a name='3121'>
<a name='3122'>
<a name='3123'>
<A NAME='CUP_MAXIMI'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_MAXIMI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3124'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_MAXIMI</font>(ARRAY,KS,KE,MAXX,ierr,              &amp; <A href='../../call_to/CUP_MAXIMI.html' TARGET='index'>2</A><a name='3125'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='3126'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='3127'>
              its,ite, jts,jte, kts,kte                     )<a name='3128'>
<a name='3129'>
   IMPLICIT NONE<a name='3130'>
<font color=#447700>!<a name='3131'></font>
<font color=#447700>!  on input<a name='3132'></font>
<font color=#447700>!<a name='3133'></font>
<a name='3134'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3135'></font>
<a name='3136'>
     integer                                                           &amp;<a name='3137'>
        ,intent (in   )                   ::                           &amp;<a name='3138'>
         ids,ide, jds,jde, kds,kde,                                    &amp;<a name='3139'>
         ims,ime, jms,jme, kms,kme,                                    &amp;<a name='3140'>
         its,ite, jts,jte, kts,kte<a name='3141'>
  <font color=#447700>! array input array<a name='3142'></font>
  <font color=#447700>! x output array with return values<a name='3143'></font>
  <font color=#447700>! kt output array of levels<a name='3144'></font>
  <font color=#447700>! ks,kend  check-range<a name='3145'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3146'>
        ,intent (in   )                   ::                           &amp;<a name='3147'>
         array<a name='3148'>
     integer, dimension (its:ite)                                      &amp;<a name='3149'>
        ,intent (in   )                   ::                           &amp;<a name='3150'>
         ierr,ke<a name='3151'>
     integer                                                           &amp;<a name='3152'>
        ,intent (in   )                   ::                           &amp;<a name='3153'>
         ks<a name='3154'>
     integer, dimension (its:ite)                                      &amp;<a name='3155'>
        ,intent (out  )                   ::                           &amp;<a name='3156'>
         maxx<a name='3157'>
     real,    dimension (its:ite)         ::                           &amp;<a name='3158'>
         x<a name='3159'>
     real                                 ::                           &amp;<a name='3160'>
         xar<a name='3161'>
     integer                              ::                           &amp;<a name='3162'>
         i,k<a name='3163'>
     integer :: itf<a name='3164'>
<a name='3165'>
     itf=MIN(ite,ide-1)<a name='3166'>
<a name='3167'>
       DO 200 i=its,itf<a name='3168'>
       MAXX(I)=KS<a name='3169'>
       if(ierr(i).eq.0)then<a name='3170'>
      X(I)=ARRAY(I,KS)<a name='3171'>
<font color=#447700>!<a name='3172'></font>
       DO 100 K=KS,KE(i)<a name='3173'>
         XAR=ARRAY(I,K)<a name='3174'>
         IF(XAR.GE.X(I)) THEN<a name='3175'>
            X(I)=XAR<a name='3176'>
            MAXX(I)=K<a name='3177'>
         ENDIF<a name='3178'>
 100  CONTINUE<a name='3179'>
      endif<a name='3180'>
 200  CONTINUE<a name='3181'>
<a name='3182'>
   END SUBROUTINE cup_MAXIMI<a name='3183'>
<a name='3184'>
<a name='3185'>
<A NAME='CUP_MINIMI'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_MINIMI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3186'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_minimi</font>(ARRAY,KS,KEND,KT,ierr,              &amp; <A href='../../call_to/CUP_MINIMI.html' TARGET='index'>2</A><a name='3187'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='3188'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='3189'>
              its,ite, jts,jte, kts,kte                     )<a name='3190'>
<a name='3191'>
   IMPLICIT NONE<a name='3192'>
<font color=#447700>!<a name='3193'></font>
<font color=#447700>!  on input<a name='3194'></font>
<font color=#447700>!<a name='3195'></font>
<a name='3196'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3197'></font>
<a name='3198'>
     integer                                                           &amp;<a name='3199'>
        ,intent (in   )                   ::                           &amp;<a name='3200'>
         ids,ide, jds,jde, kds,kde,                                    &amp;<a name='3201'>
         ims,ime, jms,jme, kms,kme,                                    &amp;<a name='3202'>
         its,ite, jts,jte, kts,kte<a name='3203'>
  <font color=#447700>! array input array<a name='3204'></font>
  <font color=#447700>! x output array with return values<a name='3205'></font>
  <font color=#447700>! kt output array of levels<a name='3206'></font>
  <font color=#447700>! ks,kend  check-range<a name='3207'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3208'>
        ,intent (in   )                   ::                           &amp;<a name='3209'>
         array<a name='3210'>
     integer, dimension (its:ite)                                      &amp;<a name='3211'>
        ,intent (in   )                   ::                           &amp;<a name='3212'>
         ierr,ks,kend<a name='3213'>
     integer, dimension (its:ite)                                      &amp;<a name='3214'>
        ,intent (out  )                   ::                           &amp;<a name='3215'>
         kt<a name='3216'>
     real,    dimension (its:ite)         ::                           &amp;<a name='3217'>
         x<a name='3218'>
     integer                              ::                           &amp;<a name='3219'>
         i,k,kstop<a name='3220'>
<a name='3221'>
     integer :: itf<a name='3222'>
<a name='3223'>
     itf=MIN(ite,ide-1)<a name='3224'>
<a name='3225'>
       DO 200 i=its,itf<a name='3226'>
      KT(I)=KS(I)<a name='3227'>
      if(ierr(i).eq.0)then<a name='3228'>
      X(I)=ARRAY(I,KS(I))<a name='3229'>
       KSTOP=MAX(KS(I)+1,KEND(I))<a name='3230'>
<font color=#447700>!<a name='3231'></font>
       DO 100 K=KS(I)+1,KSTOP<a name='3232'>
         IF(ARRAY(I,K).LT.X(I)) THEN<a name='3233'>
              X(I)=ARRAY(I,K)<a name='3234'>
              KT(I)=K<a name='3235'>
         ENDIF<a name='3236'>
 100  CONTINUE<a name='3237'>
      endif<a name='3238'>
 200  CONTINUE<a name='3239'>
<a name='3240'>
   END SUBROUTINE cup_MINIMI<a name='3241'>
<a name='3242'>
<a name='3243'>
<A NAME='CUP_OUTPUT_ENS'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_OUTPUT_ENS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3244'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_output_ens</font>(xf_ens,ierr,dellat,dellaq,dellaqc,  &amp; <A href='../../call_to/CUP_OUTPUT_ENS.html' TARGET='index'>1</A>,<A href='../../call_from/CUP_OUTPUT_ENS.html' TARGET='index'>2</A><a name='3245'>
              outtem,outq,outqc,pre,pw,xmb,ktop,                 &amp;<a name='3246'>
              j,name,nx,nx2,iens,ierr2,ierr3,pr_ens,             &amp;<a name='3247'>
              maxens3,ensdim,massfln,                            &amp;<a name='3248'>
              APR_GR,APR_W,APR_MC,APR_ST,APR_AS,                 &amp;<a name='3249'>
              APR_CAPMA,APR_CAPME,APR_CAPMI,                     &amp;<a name='3250'>
              ids,ide, jds,jde, kds,kde, &amp;<a name='3251'>
              ims,ime, jms,jme, kms,kme, &amp;<a name='3252'>
              its,ite, jts,jte, kts,kte)<a name='3253'>
<a name='3254'>
   IMPLICIT NONE<a name='3255'>
<font color=#447700>!<a name='3256'></font>
<font color=#447700>!  on input<a name='3257'></font>
<font color=#447700>!<a name='3258'></font>
<a name='3259'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3260'></font>
<a name='3261'>
     integer                                                           &amp;<a name='3262'>
        ,intent (in   )                   ::                           &amp;<a name='3263'>
        ids,ide, jds,jde, kds,kde,           &amp;<a name='3264'>
        ims,ime, jms,jme, kms,kme,           &amp;<a name='3265'>
        its,ite, jts,jte, kts,kte<a name='3266'>
     integer, intent (in   )              ::                           &amp;<a name='3267'>
        j,ensdim,nx,nx2,iens,maxens3<a name='3268'>
  <font color=#447700>! xf_ens = ensemble mass fluxes<a name='3269'></font>
  <font color=#447700>! pr_ens = precipitation ensembles<a name='3270'></font>
  <font color=#447700>! dellat = change of temperature per unit mass flux of cloud ensemble<a name='3271'></font>
  <font color=#447700>! dellaq = change of q per unit mass flux of cloud ensemble<a name='3272'></font>
  <font color=#447700>! dellaqc = change of qc per unit mass flux of cloud ensemble<a name='3273'></font>
  <font color=#447700>! outtem = output temp tendency (per s)<a name='3274'></font>
  <font color=#447700>! outq   = output q tendency (per s)<a name='3275'></font>
  <font color=#447700>! outqc  = output qc tendency (per s)<a name='3276'></font>
  <font color=#447700>! pre    = output precip<a name='3277'></font>
  <font color=#447700>! xmb    = total base mass flux<a name='3278'></font>
  <font color=#447700>! xfac1  = correction factor<a name='3279'></font>
  <font color=#447700>! pw = pw -epsilon*pd (ensemble dependent)<a name='3280'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='3281'></font>
  <font color=#447700>!<a name='3282'></font>
     real,    dimension (ims:ime,jms:jme,1:ensdim)                     &amp;<a name='3283'>
        ,intent (inout)                   ::                           &amp;<a name='3284'>
       xf_ens,pr_ens,massfln<a name='3285'>
     real,    dimension (ims:ime,jms:jme)                              &amp;<a name='3286'>
        ,intent (inout)                   ::                           &amp;<a name='3287'>
               APR_GR,APR_W,APR_MC,APR_ST,APR_AS,APR_CAPMA,            &amp;<a name='3288'>
               APR_CAPME,APR_CAPMI <a name='3289'>
<a name='3290'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3291'>
        ,intent (out  )                   ::                           &amp;<a name='3292'>
        outtem,outq,outqc<a name='3293'>
     real,    dimension (its:ite)                                      &amp;<a name='3294'>
        ,intent (out  )                   ::                           &amp;<a name='3295'>
        pre,xmb<a name='3296'>
     real,    dimension (its:ite,kts:kte,1:ensdim)                     &amp;<a name='3297'>
        ,intent (in   )                   ::                           &amp;<a name='3298'>
       dellat,dellaqc,dellaq,pw<a name='3299'>
     integer, dimension (its:ite)                                      &amp;<a name='3300'>
        ,intent (in   )                   ::                           &amp;<a name='3301'>
        ktop<a name='3302'>
     integer, dimension (its:ite)                                      &amp;<a name='3303'>
        ,intent (inout)                   ::                           &amp;<a name='3304'>
        ierr,ierr2,ierr3<a name='3305'>
<font color=#447700>!<a name='3306'></font>
<font color=#447700>!  local variables in this routine<a name='3307'></font>
<font color=#447700>!<a name='3308'></font>
<a name='3309'>
     integer                              ::                           &amp;<a name='3310'>
        i,k,n,ncount<a name='3311'>
     real                                 ::                           &amp;<a name='3312'>
        outtes,ddtes,dtt,dtq,dtqc,dtpw,tuning,prerate<a name='3313'>
     real,    dimension (its:ite)         ::                           &amp;<a name='3314'>
       xfac1<a name='3315'>
     real,    dimension (its:ite)::                           &amp;<a name='3316'>
       xmb_ske,xmb_ave,xmb_std,xmb_cur<a name='3317'>
     real,    dimension (its:ite)::                           &amp;<a name='3318'>
       pr_ske,pr_ave,pr_std,pr_cur<a name='3319'>
     real,    dimension (its:ite,jts:jte)::                           &amp;<a name='3320'>
               pr_gr,pr_w,pr_mc,pr_st,pr_as,pr_capma,     &amp;<a name='3321'>
               pr_capme,pr_capmi<a name='3322'>
<a name='3323'>
<font color=#447700>!<a name='3324'></font>
      character *(*), intent (in)        ::                           &amp;<a name='3325'>
       name<a name='3326'>
<font color=#447700>!<a name='3327'></font>
     integer :: itf, ktf<a name='3328'>
<a name='3329'>
     itf=MIN(ite,ide-1)<a name='3330'>
     ktf=MIN(kte,kde-1)<a name='3331'>
     tuning=0.<a name='3332'>
<font color=#447700>!<a name='3333'></font>
<font color=#447700>!<a name='3334'></font>
      DO k=kts,ktf<a name='3335'>
      do i=its,itf<a name='3336'>
        outtem(i,k)=0.<a name='3337'>
        outq(i,k)=0.<a name='3338'>
        outqc(i,k)=0.<a name='3339'>
      enddo<a name='3340'>
      enddo<a name='3341'>
      do i=its,itf<a name='3342'>
        pre(i)=0.<a name='3343'>
        xmb(i)=0.<a name='3344'>
         xfac1(i)=1.<a name='3345'>
      enddo<a name='3346'>
      do i=its,itf<a name='3347'>
        IF(ierr(i).eq.0)then<a name='3348'>
        do n=(iens-1)*nx*nx2*maxens3+1,iens*nx*nx2*maxens3<a name='3349'>
           if(pr_ens(i,j,n).le.0.)then<a name='3350'>
             xf_ens(i,j,n)=0.<a name='3351'>
           endif<a name='3352'>
        enddo<a name='3353'>
        endif<a name='3354'>
      enddo<a name='3355'>
<font color=#447700>!<a name='3356'></font>
<font color=#447700>!--- calculate ensemble average mass fluxes<a name='3357'></font>
<font color=#447700>!<a name='3358'></font>
       call <A href='../../html_code/phys/module_cu_gd.F.html#MASSFLX_STATS'>massflx_stats</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_OUTPUT_ENS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MASSFLX_STATS_1">(xf_ens,ensdim,nx2,nx,maxens3,      &amp;<a name='3359'>
            xmb_ave,xmb_std,xmb_cur,xmb_ske,j,ierr,1,    &amp;<a name='3360'>
            APR_GR,APR_W,APR_MC,APR_ST,APR_AS,           &amp;<a name='3361'>
            APR_CAPMA,APR_CAPME,APR_CAPMI,               &amp;<a name='3362'>
            pr_gr,pr_w,pr_mc,pr_st,pr_as,                &amp;<a name='3363'>
            pr_capma,pr_capme,pr_capmi,                  &amp;<a name='3364'>
            ids,ide, jds,jde, kds,kde,                   &amp;<a name='3365'>
            ims,ime, jms,jme, kms,kme,                   &amp;<a name='3366'>
            its,ite, jts,jte, kts,kte                   )<a name='3367'>
       call <A href='../../html_code/phys/module_cu_gd.F.html#MASSFLX_STATS'>massflx_stats</A><A href='../../html_code/phys/module_cu_gd.F.html#CUP_OUTPUT_ENS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MASSFLX_STATS_2">(pr_ens,ensdim,nx2,nx,maxens3,  &amp;<a name='3368'>
            pr_ave,pr_std,pr_cur,pr_ske,j,ierr,2,        &amp;<a name='3369'>
            APR_GR,APR_W,APR_MC,APR_ST,APR_AS,           &amp;<a name='3370'>
            APR_CAPMA,APR_CAPME,APR_CAPMI,               &amp;<a name='3371'>
            pr_gr,pr_w,pr_mc,pr_st,pr_as,                &amp;<a name='3372'>
            pr_capma,pr_capme,pr_capmi,                  &amp;<a name='3373'>
            ids,ide, jds,jde, kds,kde,                   &amp;<a name='3374'>
            ims,ime, jms,jme, kms,kme,                   &amp;<a name='3375'>
            its,ite, jts,jte, kts,kte                   )<a name='3376'>
<font color=#447700>!<a name='3377'></font>
<font color=#447700>!-- now do feedback<a name='3378'></font>
<font color=#447700>!<a name='3379'></font>
      ddtes=200.<a name='3380'>
<font color=#447700>!     if(name.eq.'shal')ddtes=200.<a name='3381'></font>
      do i=its,itf<a name='3382'>
        if(ierr(i).eq.0)then<a name='3383'>
         if(xmb_ave(i).le.0.)then<a name='3384'>
              ierr(i)=13<a name='3385'>
              xmb_ave(i)=0.<a name='3386'>
         endif<a name='3387'>
<font color=#447700>!        xmb(i)=max(0.,xmb_ave(i))<a name='3388'></font>
         xmb(i)=max(.1*xmb_ave(i),xmb_ave(i)-tuning*xmb_std(i))<a name='3389'>
        endif<a name='3390'>
        xfac1(i)=xmb_ave(i)<a name='3391'>
      ENDDO<a name='3392'>
      DO k=kts,ktf<a name='3393'>
      do i=its,itf<a name='3394'>
            dtt=0.<a name='3395'>
            dtq=0.<a name='3396'>
            dtqc=0.<a name='3397'>
            dtpw=0.<a name='3398'>
        IF(ierr(i).eq.0.and.k.le.ktop(i))then<a name='3399'>
           do n=1,nx<a name='3400'>
              dtt=dtt+dellat(i,k,n)<a name='3401'>
              dtq=dtq+dellaq(i,k,n)<a name='3402'>
              dtqc=dtqc+dellaqc(i,k,n)<a name='3403'>
              dtpw=dtpw+pw(i,k,n)<a name='3404'>
           enddo<a name='3405'>
           outtes=dtt*XMB(I)*86400./float(nx)<a name='3406'>
           IF((OUTTES.GT.2.*ddtes.and.k.gt.2))THEN<a name='3407'>
             XMB(I)= 2.*ddtes/outtes * xmb(i)<a name='3408'>
             outtes=1.*ddtes<a name='3409'>
           endif<a name='3410'>
           if (outtes .lt. -ddtes) then<a name='3411'>
             XMB(I)= -ddtes/outtes * xmb(i)<a name='3412'>
             outtes=-ddtes<a name='3413'>
           endif<a name='3414'>
           if (outtes .gt. .5*ddtes.and.k.le.2) then<a name='3415'>
             XMB(I)= ddtes/outtes * xmb(i)<a name='3416'>
             outtes=.5*ddtes<a name='3417'>
           endif<a name='3418'>
           OUTTEM(I,K)=XMB(I)*dtt/float(nx)<a name='3419'>
           OUTQ(I,K)=XMB(I)*dtq/float(nx)<a name='3420'>
           OUTQC(I,K)=XMB(I)*dtqc/float(nx)<a name='3421'>
           PRE(I)=PRE(I)+XMB(I)*dtpw/float(nx)<a name='3422'>
        endif<a name='3423'>
      enddo<a name='3424'>
      enddo<a name='3425'>
      do i=its,itf<a name='3426'>
        if(ierr(i).eq.0)then<a name='3427'>
           prerate=pre(i)*3600.<a name='3428'>
           if(prerate.lt.0.1)then<a name='3429'>
              if(ierr2(i).gt.0.or.ierr3(i).gt.0)then<a name='3430'>
                 pre(i)=0.<a name='3431'>
                 ierr(i)=221<a name='3432'>
                 do k=kts,ktf<a name='3433'>
                    outtem(i,k)=0.<a name='3434'>
                    outq(i,k)=0.<a name='3435'>
                    outqc(i,k)=0.<a name='3436'>
                 enddo<a name='3437'>
                 do k=(iens-1)*nx*nx2*maxens3+1,iens*nx*nx2*maxens3<a name='3438'>
                   massfln(i,j,k)=0.<a name='3439'>
                   xf_ens(i,j,k)=0.<a name='3440'>
                 enddo<a name='3441'>
               endif<a name='3442'>
            endif<a name='3443'>
<a name='3444'>
        endif<a name='3445'>
      ENDDO<a name='3446'>
<a name='3447'>
      do i=its,itf<a name='3448'>
        if(ierr(i).eq.0)then<a name='3449'>
        xfac1(i)=xmb(i)/xfac1(i)<a name='3450'>
        do k=(iens-1)*nx*nx2*maxens3+1,iens*nx*nx2*maxens3<a name='3451'>
          massfln(i,j,k)=massfln(i,j,k)*xfac1(i)<a name='3452'>
          xf_ens(i,j,k)=xf_ens(i,j,k)*xfac1(i)<a name='3453'>
        enddo<a name='3454'>
        endif<a name='3455'>
      ENDDO<a name='3456'>
<a name='3457'>
   END SUBROUTINE cup_output_ens<a name='3458'>
<a name='3459'>
<a name='3460'>
<A NAME='CUP_UP_AA0'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_AA0' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3461'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_up_aa0</font>(aa0,z,zu,dby,GAMMA_CUP,t_cup,       &amp; <A href='../../call_to/CUP_UP_AA0.html' TARGET='index'>3</A><a name='3462'>
              kbcon,ktop,ierr,                               &amp;<a name='3463'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='3464'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='3465'>
              its,ite, jts,jte, kts,kte                     )<a name='3466'>
<a name='3467'>
   IMPLICIT NONE<a name='3468'>
<font color=#447700>!<a name='3469'></font>
<font color=#447700>!  on input<a name='3470'></font>
<font color=#447700>!<a name='3471'></font>
<a name='3472'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3473'></font>
<a name='3474'>
     integer                                                           &amp;<a name='3475'>
        ,intent (in   )                   ::                           &amp;<a name='3476'>
        ids,ide, jds,jde, kds,kde,                                     &amp;<a name='3477'>
        ims,ime, jms,jme, kms,kme,                                     &amp;<a name='3478'>
        its,ite, jts,jte, kts,kte<a name='3479'>
  <font color=#447700>! aa0 cloud work function<a name='3480'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='3481'></font>
  <font color=#447700>! t_cup = temperature (Kelvin) on model cloud levels<a name='3482'></font>
  <font color=#447700>! dby = buoancy term<a name='3483'></font>
  <font color=#447700>! zu= normalized updraft mass flux<a name='3484'></font>
  <font color=#447700>! z = heights of model levels <a name='3485'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='3486'></font>
  <font color=#447700>!<a name='3487'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3488'>
        ,intent (in   )                   ::                           &amp;<a name='3489'>
        z,zu,gamma_cup,t_cup,dby<a name='3490'>
     integer, dimension (its:ite)                                      &amp;<a name='3491'>
        ,intent (in   )                   ::                           &amp;<a name='3492'>
        kbcon,ktop<a name='3493'>
<font color=#447700>!<a name='3494'></font>
<font color=#447700>! input and output<a name='3495'></font>
<font color=#447700>!<a name='3496'></font>
<a name='3497'>
<a name='3498'>
     integer, dimension (its:ite)                                      &amp;<a name='3499'>
        ,intent (inout)                   ::                           &amp;<a name='3500'>
        ierr<a name='3501'>
     real,    dimension (its:ite)                                      &amp;<a name='3502'>
        ,intent (out  )                   ::                           &amp;<a name='3503'>
        aa0<a name='3504'>
<font color=#447700>!<a name='3505'></font>
<font color=#447700>!  local variables in this routine<a name='3506'></font>
<font color=#447700>!<a name='3507'></font>
<a name='3508'>
     integer                              ::                           &amp;<a name='3509'>
        i,k<a name='3510'>
     real                                 ::                           &amp;<a name='3511'>
        dz,da<a name='3512'>
<font color=#447700>!<a name='3513'></font>
     integer :: itf, ktf<a name='3514'>
<a name='3515'>
     itf = MIN(ite,ide-1)<a name='3516'>
     ktf = MIN(kte,kde-1)<a name='3517'>
<a name='3518'>
        do i=its,itf<a name='3519'>
         aa0(i)=0.<a name='3520'>
        enddo<a name='3521'>
        DO 100 k=kts+1,ktf<a name='3522'>
        DO 100 i=its,itf<a name='3523'>
         IF(ierr(i).ne.0)GO TO 100<a name='3524'>
         IF(K.LE.KBCON(I))GO TO 100<a name='3525'>
         IF(K.Gt.KTOP(I))GO TO 100<a name='3526'>
         DZ=Z(I,K)-Z(I,K-1)<a name='3527'>
         da=zu(i,k)*DZ*(9.81/(1004.*( &amp;<a name='3528'>
                (T_cup(I,K)))))*DBY(I,K-1)/ &amp;<a name='3529'>
             (1.+GAMMA_CUP(I,K))<a name='3530'>
         IF(K.eq.KTOP(I).and.da.le.0.)go to 100<a name='3531'>
         AA0(I)=AA0(I)+da<a name='3532'>
         if(aa0(i).lt.0.)aa0(i)=0.<a name='3533'>
100     continue<a name='3534'>
<a name='3535'>
   END SUBROUTINE cup_up_aa0<a name='3536'>
<a name='3537'>
<a name='3538'>
<A NAME='CUP_UP_HE'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_HE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3539'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_up_he</font>(k22,hkb,z_cup,cd,entr,he_cup,hc,     &amp; <A href='../../call_to/CUP_UP_HE.html' TARGET='index'>3</A><a name='3540'>
              kbcon,ierr,dby,he,hes_cup,                     &amp;<a name='3541'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='3542'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='3543'>
              its,ite, jts,jte, kts,kte                     )<a name='3544'>
<a name='3545'>
   IMPLICIT NONE<a name='3546'>
<font color=#447700>!<a name='3547'></font>
<font color=#447700>!  on input<a name='3548'></font>
<font color=#447700>!<a name='3549'></font>
<a name='3550'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3551'></font>
<a name='3552'>
     integer                                                           &amp;<a name='3553'>
        ,intent (in   )                   ::                           &amp;<a name='3554'>
                                  ids,ide, jds,jde, kds,kde,           &amp;<a name='3555'>
                                  ims,ime, jms,jme, kms,kme,           &amp;<a name='3556'>
                                  its,ite, jts,jte, kts,kte<a name='3557'>
  <font color=#447700>! hc = cloud moist static energy<a name='3558'></font>
  <font color=#447700>! hkb = moist static energy at originating level<a name='3559'></font>
  <font color=#447700>! he = moist static energy on model levels<a name='3560'></font>
  <font color=#447700>! he_cup = moist static energy on model cloud levels<a name='3561'></font>
  <font color=#447700>! hes_cup = saturation moist static energy on model cloud levels<a name='3562'></font>
  <font color=#447700>! dby = buoancy term<a name='3563'></font>
  <font color=#447700>! cd= detrainment function <a name='3564'></font>
  <font color=#447700>! z_cup = heights of model cloud levels <a name='3565'></font>
  <font color=#447700>! entr = entrainment rate<a name='3566'></font>
  <font color=#447700>!<a name='3567'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3568'>
        ,intent (in   )                   ::                           &amp;<a name='3569'>
        he,he_cup,hes_cup,z_cup,cd<a name='3570'>
  <font color=#447700>! entr= entrainment rate <a name='3571'></font>
     real                                                              &amp;<a name='3572'>
        ,intent (in   )                   ::                           &amp;<a name='3573'>
        entr<a name='3574'>
     integer, dimension (its:ite)                                      &amp;<a name='3575'>
        ,intent (in   )                   ::                           &amp;<a name='3576'>
        kbcon,k22<a name='3577'>
<font color=#447700>!<a name='3578'></font>
<font color=#447700>! input and output<a name='3579'></font>
<font color=#447700>!<a name='3580'></font>
<a name='3581'>
   <font color=#447700>! ierr error value, maybe modified in this routine<a name='3582'></font>
<a name='3583'>
     integer, dimension (its:ite)                                      &amp;<a name='3584'>
        ,intent (inout)                   ::                           &amp;<a name='3585'>
        ierr<a name='3586'>
<a name='3587'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3588'>
        ,intent (out  )                   ::                           &amp;<a name='3589'>
        hc,dby<a name='3590'>
     real,    dimension (its:ite)                                      &amp;<a name='3591'>
        ,intent (out  )                   ::                           &amp;<a name='3592'>
        hkb<a name='3593'>
<font color=#447700>!<a name='3594'></font>
<font color=#447700>!  local variables in this routine<a name='3595'></font>
<font color=#447700>!<a name='3596'></font>
<a name='3597'>
     integer                              ::                           &amp;<a name='3598'>
        i,k<a name='3599'>
     real                                 ::                           &amp;<a name='3600'>
        dz<a name='3601'>
<font color=#447700>!<a name='3602'></font>
     integer :: itf, ktf<a name='3603'>
<a name='3604'>
     itf = MIN(ite,ide-1)<a name='3605'>
     ktf = MIN(kte,kde-1)<a name='3606'>
<font color=#447700>!<a name='3607'></font>
<font color=#447700>!--- moist static energy inside cloud<a name='3608'></font>
<font color=#447700>!<a name='3609'></font>
      do i=its,itf<a name='3610'>
      if(ierr(i).eq.0.)then<a name='3611'>
      hkb(i)=he_cup(i,k22(i))<a name='3612'>
      do k=1,k22(i)<a name='3613'>
        hc(i,k)=he_cup(i,k)<a name='3614'>
        DBY(I,K)=0.<a name='3615'>
      enddo<a name='3616'>
      do k=k22(i),kbcon(i)-1<a name='3617'>
        hc(i,k)=hkb(i)<a name='3618'>
        DBY(I,K)=0.<a name='3619'>
      enddo<a name='3620'>
        k=kbcon(i)<a name='3621'>
        hc(i,k)=hkb(i)<a name='3622'>
        DBY(I,Kbcon(i))=Hkb(I)-HES_cup(I,K)<a name='3623'>
      endif<a name='3624'>
      enddo<a name='3625'>
      do k=kts+1,ktf<a name='3626'>
      do i=its,itf<a name='3627'>
        if(k.gt.kbcon(i).and.ierr(i).eq.0.)then<a name='3628'>
           DZ=Z_cup(i,K)-Z_cup(i,K-1)<a name='3629'>
           HC(i,K)=(HC(i,K-1)*(1.-.5*CD(i,K)*DZ)+entr* &amp;<a name='3630'>
                DZ*HE(i,K-1))/(1.+entr*DZ-.5*cd(i,k)*dz)<a name='3631'>
           DBY(I,K)=HC(I,K)-HES_cup(I,K)<a name='3632'>
        endif<a name='3633'>
      enddo<a name='3634'>
<a name='3635'>
      enddo<a name='3636'>
<a name='3637'>
   END SUBROUTINE cup_up_he<a name='3638'>
<a name='3639'>
<a name='3640'>
<A NAME='CUP_UP_MOISTURE'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_MOISTURE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3641'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_up_moisture</font>(ierr,z_cup,qc,qrc,pw,pwav,     &amp; <A href='../../call_to/CUP_UP_MOISTURE.html' TARGET='index'>3</A><a name='3642'>
              kbcon,ktop,cd,dby,mentr_rate,                  &amp;<a name='3643'>
              q,GAMMA_cup,zu,qes_cup,k22,qe_cup,xl,          &amp;<a name='3644'>
              ids,ide, jds,jde, kds,kde,                     &amp;<a name='3645'>
              ims,ime, jms,jme, kms,kme,                     &amp;<a name='3646'>
              its,ite, jts,jte, kts,kte                     )<a name='3647'>
<a name='3648'>
   IMPLICIT NONE<a name='3649'>
<font color=#447700>!<a name='3650'></font>
<font color=#447700>!  on input<a name='3651'></font>
<font color=#447700>!<a name='3652'></font>
<a name='3653'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3654'></font>
<a name='3655'>
     integer                                                           &amp;<a name='3656'>
        ,intent (in   )                   ::                           &amp;<a name='3657'>
                                  ids,ide, jds,jde, kds,kde,           &amp;<a name='3658'>
                                  ims,ime, jms,jme, kms,kme,           &amp;<a name='3659'>
                                  its,ite, jts,jte, kts,kte<a name='3660'>
  <font color=#447700>! cd= detrainment function <a name='3661'></font>
  <font color=#447700>! q = environmental q on model levels<a name='3662'></font>
  <font color=#447700>! qe_cup = environmental q on model cloud levels<a name='3663'></font>
  <font color=#447700>! qes_cup = saturation q on model cloud levels<a name='3664'></font>
  <font color=#447700>! dby = buoancy term<a name='3665'></font>
  <font color=#447700>! cd= detrainment function <a name='3666'></font>
  <font color=#447700>! zu = normalized updraft mass flux<a name='3667'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='3668'></font>
  <font color=#447700>! mentr_rate = entrainment rate<a name='3669'></font>
  <font color=#447700>!<a name='3670'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3671'>
        ,intent (in   )                   ::                           &amp;<a name='3672'>
        q,zu,gamma_cup,qe_cup,dby,qes_cup,z_cup,cd<a name='3673'>
  <font color=#447700>! entr= entrainment rate <a name='3674'></font>
     real                                                              &amp;<a name='3675'>
        ,intent (in   )                   ::                           &amp;<a name='3676'>
        mentr_rate,xl<a name='3677'>
     integer, dimension (its:ite)                                      &amp;<a name='3678'>
        ,intent (in   )                   ::                           &amp;<a name='3679'>
        kbcon,ktop,k22<a name='3680'>
<font color=#447700>!<a name='3681'></font>
<font color=#447700>! input and output<a name='3682'></font>
<font color=#447700>!<a name='3683'></font>
<a name='3684'>
   <font color=#447700>! ierr error value, maybe modified in this routine<a name='3685'></font>
<a name='3686'>
     integer, dimension (its:ite)                                      &amp;<a name='3687'>
        ,intent (inout)                   ::                           &amp;<a name='3688'>
        ierr<a name='3689'>
   <font color=#447700>! qc = cloud q (including liquid water) after entrainment<a name='3690'></font>
   <font color=#447700>! qrch = saturation q in cloud<a name='3691'></font>
   <font color=#447700>! qrc = liquid water content in cloud after rainout<a name='3692'></font>
   <font color=#447700>! pw = condensate that will fall out at that level<a name='3693'></font>
   <font color=#447700>! pwav = totan normalized integrated condensate (I1)<a name='3694'></font>
   <font color=#447700>! c0 = conversion rate (cloud to rain)<a name='3695'></font>
<a name='3696'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3697'>
        ,intent (out  )                   ::                           &amp;<a name='3698'>
        qc,qrc,pw<a name='3699'>
     real,    dimension (its:ite)                                      &amp;<a name='3700'>
        ,intent (out  )                   ::                           &amp;<a name='3701'>
        pwav<a name='3702'>
<font color=#447700>!<a name='3703'></font>
<font color=#447700>!  local variables in this routine<a name='3704'></font>
<font color=#447700>!<a name='3705'></font>
<a name='3706'>
     integer                              ::                           &amp;<a name='3707'>
        iall,i,k<a name='3708'>
     real                                 ::                           &amp;<a name='3709'>
        dh,qrch,c0,dz,radius<a name='3710'>
<font color=#447700>!<a name='3711'></font>
     integer :: itf, ktf<a name='3712'>
<a name='3713'>
     itf = MIN(ite,ide-1)<a name='3714'>
     ktf = MIN(kte,kde-1)<a name='3715'>
<a name='3716'>
        iall=0<a name='3717'>
        c0=.002<a name='3718'>
<font color=#447700>!<a name='3719'></font>
<font color=#447700>!--- no precip for small clouds<a name='3720'></font>
<font color=#447700>!<a name='3721'></font>
        if(mentr_rate.gt.0.)then<a name='3722'>
          radius=.2/mentr_rate<a name='3723'>
          if(radius.lt.900.)c0=0.<a name='3724'>
<font color=#447700>!         if(radius.lt.900.)iall=0<a name='3725'></font>
        endif<a name='3726'>
        do i=its,itf<a name='3727'>
          pwav(i)=0.<a name='3728'>
        enddo<a name='3729'>
        do k=kts,ktf<a name='3730'>
        do i=its,itf<a name='3731'>
          pw(i,k)=0.<a name='3732'>
          qc(i,k)=qes_cup(i,k)<a name='3733'>
          qrc(i,k)=0.<a name='3734'>
        enddo<a name='3735'>
        enddo<a name='3736'>
      do i=its,itf<a name='3737'>
      if(ierr(i).eq.0.)then<a name='3738'>
      do k=k22(i),kbcon(i)-1<a name='3739'>
        qc(i,k)=qe_cup(i,k22(i))<a name='3740'>
      enddo<a name='3741'>
      endif<a name='3742'>
      enddo<a name='3743'>
<a name='3744'>
        DO 100 k=kts+1,ktf<a name='3745'>
        DO 100 i=its,itf<a name='3746'>
         IF(ierr(i).ne.0)GO TO 100<a name='3747'>
         IF(K.Lt.KBCON(I))GO TO 100<a name='3748'>
         IF(K.Gt.KTOP(I))GO TO 100<a name='3749'>
         DZ=Z_cup(i,K)-Z_cup(i,K-1)<a name='3750'>
<font color=#447700>!<a name='3751'></font>
<font color=#447700>!------    1. steady state plume equation, for what could<a name='3752'></font>
<font color=#447700>!------       be in cloud without condensation<a name='3753'></font>
<font color=#447700>!<a name='3754'></font>
<font color=#447700>!<a name='3755'></font>
        QC(i,K)=(QC(i,K-1)*(1.-.5*CD(i,K)*DZ)+mentr_rate* &amp;<a name='3756'>
                DZ*Q(i,K-1))/(1.+mentr_rate*DZ-.5*cd(i,k)*dz)<a name='3757'>
<font color=#447700>!<a name='3758'></font>
<font color=#447700>!--- saturation  in cloud, this is what is allowed to be in it<a name='3759'></font>
<font color=#447700>!<a name='3760'></font>
         QRCH=QES_cup(I,K)+(1./XL)*(GAMMA_cup(i,k) &amp;<a name='3761'>
              /(1.+GAMMA_cup(i,k)))*DBY(I,K)<a name='3762'>
<font color=#447700>!<a name='3763'></font>
<font color=#447700>!------- LIQUID WATER CONTENT IN cloud after rainout<a name='3764'></font>
<font color=#447700>!<a name='3765'></font>
        QRC(I,K)=(QC(I,K)-QRCH)/(1.+C0*DZ)<a name='3766'>
        if(qrc(i,k).lt.0.)then<a name='3767'>
          qrc(i,k)=0.<a name='3768'>
        endif<a name='3769'>
<font color=#447700>!<a name='3770'></font>
<font color=#447700>!-------   3.Condensation<a name='3771'></font>
<font color=#447700>!<a name='3772'></font>
         PW(i,k)=c0*dz*QRC(I,K)*zu(i,k)<a name='3773'>
        if(iall.eq.1)then<a name='3774'>
          qrc(i,k)=0.<a name='3775'>
          pw(i,k)=(QC(I,K)-QRCH)*zu(i,k)<a name='3776'>
          if(pw(i,k).lt.0.)pw(i,k)=0.<a name='3777'>
        endif<a name='3778'>
<font color=#447700>!<a name='3779'></font>
<font color=#447700>!----- set next level<a name='3780'></font>
<font color=#447700>!<a name='3781'></font>
         QC(I,K)=QRC(I,K)+qrch<a name='3782'>
<font color=#447700>!<a name='3783'></font>
<font color=#447700>!--- integrated normalized ondensate<a name='3784'></font>
<font color=#447700>!<a name='3785'></font>
         PWAV(I)=PWAV(I)+PW(I,K)<a name='3786'>
 100     CONTINUE<a name='3787'>
<a name='3788'>
   END SUBROUTINE cup_up_moisture<a name='3789'>
<a name='3790'>
<a name='3791'>
<A NAME='CUP_UP_NMS'><A href='../../html_code/phys/module_cu_gd.F.html#CUP_UP_NMS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3792'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_up_nms</font>(zu,z_cup,entr,cd,kbcon,ktop,ierr,k22,  &amp; <A href='../../call_to/CUP_UP_NMS.html' TARGET='index'>3</A><a name='3793'>
              ids,ide, jds,jde, kds,kde,                        &amp;<a name='3794'>
              ims,ime, jms,jme, kms,kme,                        &amp;<a name='3795'>
              its,ite, jts,jte, kts,kte                        )<a name='3796'>
<a name='3797'>
   IMPLICIT NONE<a name='3798'>
<a name='3799'>
<font color=#447700>!<a name='3800'></font>
<font color=#447700>!  on input<a name='3801'></font>
<font color=#447700>!<a name='3802'></font>
<a name='3803'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3804'></font>
<a name='3805'>
     integer                                                           &amp;<a name='3806'>
        ,intent (in   )                   ::                           &amp;<a name='3807'>
         ids,ide, jds,jde, kds,kde,                                    &amp;<a name='3808'>
         ims,ime, jms,jme, kms,kme,                                    &amp;<a name='3809'>
         its,ite, jts,jte, kts,kte<a name='3810'>
  <font color=#447700>! cd= detrainment function <a name='3811'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3812'>
        ,intent (in   )                   ::                           &amp;<a name='3813'>
         z_cup,cd<a name='3814'>
  <font color=#447700>! entr= entrainment rate <a name='3815'></font>
     real                                                              &amp;<a name='3816'>
        ,intent (in   )                   ::                           &amp;<a name='3817'>
         entr<a name='3818'>
     integer, dimension (its:ite)                                      &amp;<a name='3819'>
        ,intent (in   )                   ::                           &amp;<a name='3820'>
         kbcon,ktop,k22<a name='3821'>
<font color=#447700>!<a name='3822'></font>
<font color=#447700>! input and output<a name='3823'></font>
<font color=#447700>!<a name='3824'></font>
<a name='3825'>
   <font color=#447700>! ierr error value, maybe modified in this routine<a name='3826'></font>
<a name='3827'>
     integer, dimension (its:ite)                                      &amp;<a name='3828'>
        ,intent (inout)                   ::                           &amp;<a name='3829'>
         ierr<a name='3830'>
   <font color=#447700>! zu is the normalized mass flux<a name='3831'></font>
<a name='3832'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3833'>
        ,intent (out  )                   ::                           &amp;<a name='3834'>
         zu<a name='3835'>
<font color=#447700>!<a name='3836'></font>
<font color=#447700>!  local variables in this routine<a name='3837'></font>
<font color=#447700>!<a name='3838'></font>
<a name='3839'>
     integer                              ::                           &amp;<a name='3840'>
         i,k<a name='3841'>
     real                                 ::                           &amp;<a name='3842'>
         dz<a name='3843'>
     integer :: itf, ktf<a name='3844'>
<a name='3845'>
     itf = MIN(ite,ide-1)<a name='3846'>
     ktf = MIN(kte,kde-1)<a name='3847'>
<font color=#447700>!<a name='3848'></font>
<font color=#447700>!   initialize for this go around<a name='3849'></font>
<font color=#447700>!<a name='3850'></font>
       do k=kts,ktf<a name='3851'>
       do i=its,itf<a name='3852'>
         zu(i,k)=0.<a name='3853'>
       enddo<a name='3854'>
       enddo<a name='3855'>
<font color=#447700>!<a name='3856'></font>
<font color=#447700>! do normalized mass budget<a name='3857'></font>
<font color=#447700>!<a name='3858'></font>
       do i=its,itf<a name='3859'>
          IF(ierr(I).eq.0)then<a name='3860'>
             do k=k22(i),kbcon(i)<a name='3861'>
               zu(i,k)=1.<a name='3862'>
             enddo<a name='3863'>
             DO K=KBcon(i)+1,KTOP(i)<a name='3864'>
               DZ=Z_cup(i,K)-Z_cup(i,K-1)<a name='3865'>
               ZU(i,K)=ZU(i,K-1)*(1.+(entr-cd(i,k))*DZ)<a name='3866'>
             enddo<a name='3867'>
          endif<a name='3868'>
       enddo<a name='3869'>
<a name='3870'>
   END SUBROUTINE cup_up_nms<a name='3871'>
<a name='3872'>
<font color=#447700>!====================================================================<a name='3873'></font>
<A NAME='GDINIT'><A href='../../html_code/phys/module_cu_gd.F.html#GDINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3874'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>gdinit</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQICUTEN,           &amp; <A href='../../call_to/GDINIT.html' TARGET='index'>1</A><a name='3875'>
                        MASS_FLUX,cp,restart,                       &amp;<a name='3876'>
                        P_QC,P_QI,P_FIRST_SCALAR,                   &amp;<a name='3877'>
                        RTHFTEN, RQVFTEN,                           &amp;<a name='3878'>
                        APR_GR,APR_W,APR_MC,APR_ST,APR_AS,          &amp;<a name='3879'>
                        APR_CAPMA,APR_CAPME,APR_CAPMI,              &amp;<a name='3880'>
                        allowed_to_read,                            &amp;<a name='3881'>
                        ids, ide, jds, jde, kds, kde,               &amp;<a name='3882'>
                        ims, ime, jms, jme, kms, kme,               &amp;<a name='3883'>
                        its, ite, jts, jte, kts, kte               )<a name='3884'>
<font color=#447700>!--------------------------------------------------------------------   <a name='3885'></font>
   IMPLICIT NONE<a name='3886'>
<font color=#447700>!--------------------------------------------------------------------<a name='3887'></font>
   LOGICAL , INTENT(IN)           ::  restart,allowed_to_read<a name='3888'>
   INTEGER , INTENT(IN)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='3889'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='3890'>
                                      its, ite, jts, jte, kts, kte<a name='3891'>
   INTEGER , INTENT(IN)           ::  P_FIRST_SCALAR, P_QI, P_QC<a name='3892'>
   REAL,     INTENT(IN)           ::  cp<a name='3893'>
<a name='3894'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='3895'>
                                                          RTHCUTEN, &amp;<a name='3896'>
                                                          RQVCUTEN, &amp;<a name='3897'>
                                                          RQCCUTEN, &amp;<a name='3898'>
                                                          RQICUTEN   <a name='3899'>
<a name='3900'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='3901'>
                                                          RTHFTEN,  &amp;<a name='3902'>
                                                          RQVFTEN<a name='3903'>
<a name='3904'>
   REAL,     DIMENSION( ims:ime , jms:jme ) , INTENT(OUT) ::        &amp;<a name='3905'>
                                APR_GR,APR_W,APR_MC,APR_ST,APR_AS,  &amp;<a name='3906'>
                                APR_CAPMA,APR_CAPME,APR_CAPMI,      &amp;<a name='3907'>
                                MASS_FLUX<a name='3908'>
<a name='3909'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3910'>
 <a name='3911'>
   jtf=min0(jte,jde-1)<a name='3912'>
   ktf=min0(kte,kde-1)<a name='3913'>
   itf=min0(ite,ide-1)<a name='3914'>
 <a name='3915'>
   IF(.not.restart)THEN<a name='3916'>
     DO j=jts,jtf<a name='3917'>
     DO k=kts,ktf<a name='3918'>
     DO i=its,itf<a name='3919'>
        RTHCUTEN(i,k,j)=0.<a name='3920'>
        RQVCUTEN(i,k,j)=0.<a name='3921'>
     ENDDO<a name='3922'>
     ENDDO<a name='3923'>
     ENDDO<a name='3924'>
<a name='3925'>
     DO j=jts,jtf<a name='3926'>
     DO k=kts,ktf<a name='3927'>
     DO i=its,itf<a name='3928'>
        RTHFTEN(i,k,j)=0.<a name='3929'>
        RQVFTEN(i,k,j)=0.<a name='3930'>
     ENDDO<a name='3931'>
     ENDDO<a name='3932'>
     ENDDO<a name='3933'>
<a name='3934'>
     IF (P_QC .ge. P_FIRST_SCALAR) THEN<a name='3935'>
        DO j=jts,jtf<a name='3936'>
        DO k=kts,ktf<a name='3937'>
        DO i=its,itf<a name='3938'>
           RQCCUTEN(i,k,j)=0.<a name='3939'>
        ENDDO<a name='3940'>
        ENDDO<a name='3941'>
        ENDDO<a name='3942'>
     ENDIF<a name='3943'>
<a name='3944'>
     IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='3945'>
        DO j=jts,jtf<a name='3946'>
        DO k=kts,ktf<a name='3947'>
        DO i=its,itf<a name='3948'>
           RQICUTEN(i,k,j)=0.<a name='3949'>
        ENDDO<a name='3950'>
        ENDDO<a name='3951'>
        ENDDO<a name='3952'>
     ENDIF<a name='3953'>
<a name='3954'>
     DO j=jts,jtf<a name='3955'>
     DO i=its,itf<a name='3956'>
        mass_flux(i,j)=0.<a name='3957'>
     ENDDO<a name='3958'>
     ENDDO<a name='3959'>
<a name='3960'>
   ENDIF<a name='3961'>
     DO j=jts,jtf<a name='3962'>
     DO i=its,itf<a name='3963'>
        APR_GR(i,j)=0.<a name='3964'>
        APR_ST(i,j)=0.<a name='3965'>
        APR_W(i,j)=0.<a name='3966'>
        APR_MC(i,j)=0.<a name='3967'>
        APR_AS(i,j)=0.<a name='3968'>
        APR_CAPMA(i,j)=0.<a name='3969'>
        APR_CAPME(i,j)=0.<a name='3970'>
        APR_CAPMI(i,j)=0.<a name='3971'>
     ENDDO<a name='3972'>
     ENDDO<a name='3973'>
<a name='3974'>
   END SUBROUTINE gdinit<a name='3975'>
<a name='3976'>
<a name='3977'>
<A NAME='MASSFLX_STATS'><A href='../../html_code/phys/module_cu_gd.F.html#MASSFLX_STATS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3978'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>massflx_stats</font>(xf_ens,ensdim,maxens,maxens2,maxens3, &amp; <A href='../../call_to/MASSFLX_STATS.html' TARGET='index'>2</A><a name='3979'>
              xt_ave,xt_std,xt_cur,xt_ske,j,ierr,itest,           &amp;<a name='3980'>
              APR_GR,APR_W,APR_MC,APR_ST,APR_AS,                  &amp;<a name='3981'>
              APR_CAPMA,APR_CAPME,APR_CAPMI,                      &amp;<a name='3982'>
              pr_gr,pr_w,pr_mc,pr_st,pr_as,                       &amp;<a name='3983'>
              pr_capma,pr_capme,pr_capmi,                         &amp;<a name='3984'>
              ids,ide, jds,jde, kds,kde,  &amp;<a name='3985'>
              ims,ime, jms,jme, kms,kme,  &amp;<a name='3986'>
              its,ite, jts,jte, kts,kte)<a name='3987'>
<a name='3988'>
   IMPLICIT NONE<a name='3989'>
<a name='3990'>
   integer, intent (in   )              ::                                    &amp;<a name='3991'>
                     j,ensdim,maxens3,maxens,maxens2,itest<a name='3992'>
   INTEGER,      INTENT(IN   ) ::                                             &amp;<a name='3993'>
                                  ids,ide, jds,jde, kds,kde,                  &amp;<a name='3994'>
                                  ims,ime, jms,jme, kms,kme,                  &amp;<a name='3995'>
                                  its,ite, jts,jte, kts,kte<a name='3996'>
<a name='3997'>
<a name='3998'>
     real, dimension (its:ite)                                                &amp;<a name='3999'>
         , intent(inout) ::                                                   &amp;<a name='4000'>
           xt_ave,xt_cur,xt_std,xt_ske<a name='4001'>
     integer, dimension (its:ite), intent (in) ::                             &amp;<a name='4002'>
           ierr<a name='4003'>
     real, dimension (ims:ime,jms:jme,1:ensdim)                               &amp;<a name='4004'>
         , intent(in   ) ::                                                   &amp;<a name='4005'>
           xf_ens<a name='4006'>
     real, dimension (ims:ime,jms:jme)                                        &amp;<a name='4007'>
         , intent(inout) ::                                                   &amp;<a name='4008'>
           APR_GR,APR_W,APR_MC,APR_ST,APR_AS,                                 &amp;<a name='4009'>
           APR_CAPMA,APR_CAPME,APR_CAPMI<a name='4010'>
     real, dimension (its:ite,jts:jte)                                        &amp;<a name='4011'>
         , intent(inout) ::                                                   &amp;<a name='4012'>
           pr_gr,pr_w,pr_mc,pr_st,pr_as,                                      &amp;<a name='4013'>
           pr_capma,pr_capme,pr_capmi<a name='4014'>
<a name='4015'>
<font color=#447700>!<a name='4016'></font>
<font color=#447700>! local stuff<a name='4017'></font>
<font color=#447700>!<a name='4018'></font>
     real, dimension (its:ite , 1:maxens3 )       ::                          &amp;<a name='4019'>
           x_ave,x_cur,x_std,x_ske<a name='4020'>
     real, dimension (its:ite , 1:maxens  )       ::                          &amp;<a name='4021'>
           x_ave_cap<a name='4022'>
<a name='4023'>
<a name='4024'>
      integer, dimension (1:maxens3) :: nc1<a name='4025'>
      integer :: i,k<a name='4026'>
      integer :: num,kk,num2,iedt<a name='4027'>
      real :: a3,a4<a name='4028'>
<a name='4029'>
      num=ensdim/maxens3<a name='4030'>
      num2=ensdim/maxens<a name='4031'>
      if(itest.eq.1)then<a name='4032'>
      do i=its,ite<a name='4033'>
       pr_gr(i,j) =  0.<a name='4034'>
       pr_w(i,j) =  0.<a name='4035'>
       pr_mc(i,j) = 0.<a name='4036'>
       pr_st(i,j) = 0.<a name='4037'>
       pr_as(i,j) = 0.<a name='4038'>
       pr_capma(i,j) =  0.<a name='4039'>
       pr_capme(i,j) = 0.<a name='4040'>
       pr_capmi(i,j) = 0.<a name='4041'>
      enddo<a name='4042'>
      endif<a name='4043'>
<a name='4044'>
      do k=1,maxens<a name='4045'>
      do i=its,ite<a name='4046'>
        x_ave_cap(i,k)=0.<a name='4047'>
      enddo<a name='4048'>
      enddo<a name='4049'>
      do k=1,maxens3<a name='4050'>
      do i=its,ite<a name='4051'>
        x_ave(i,k)=0.<a name='4052'>
        x_std(i,k)=0.<a name='4053'>
        x_ske(i,k)=0.<a name='4054'>
        x_cur(i,k)=0.<a name='4055'>
      enddo<a name='4056'>
      enddo<a name='4057'>
      do i=its,ite<a name='4058'>
        xt_ave(i)=0.<a name='4059'>
        xt_std(i)=0.<a name='4060'>
        xt_ske(i)=0.<a name='4061'>
        xt_cur(i)=0.<a name='4062'>
      enddo<a name='4063'>
      do kk=1,num<a name='4064'>
      do k=1,maxens3<a name='4065'>
      do i=its,ite<a name='4066'>
        if(ierr(i).eq.0)then<a name='4067'>
        x_ave(i,k)=x_ave(i,k)+xf_ens(i,j,maxens3*(kk-1)+k)<a name='4068'>
        endif<a name='4069'>
      enddo<a name='4070'>
      enddo<a name='4071'>
      enddo<a name='4072'>
      do iedt=1,maxens2<a name='4073'>
      do k=1,maxens<a name='4074'>
      do kk=1,maxens3<a name='4075'>
      do i=its,ite<a name='4076'>
        if(ierr(i).eq.0)then<a name='4077'>
        x_ave_cap(i,k)=x_ave_cap(i,k)                               &amp;<a name='4078'>
            +xf_ens(i,j,maxens3*(k-1)+(iedt-1)*maxens*maxens3+kk)<a name='4079'>
        endif<a name='4080'>
      enddo<a name='4081'>
      enddo<a name='4082'>
      enddo<a name='4083'>
      enddo<a name='4084'>
      do k=1,maxens<a name='4085'>
      do i=its,ite<a name='4086'>
        if(ierr(i).eq.0)then<a name='4087'>
        x_ave_cap(i,k)=x_ave_cap(i,k)/float(num2)<a name='4088'>
        endif<a name='4089'>
      enddo<a name='4090'>
      enddo<a name='4091'>
<a name='4092'>
      do k=1,maxens3<a name='4093'>
      do i=its,ite<a name='4094'>
        if(ierr(i).eq.0)then<a name='4095'>
        x_ave(i,k)=x_ave(i,k)/float(num)<a name='4096'>
        endif<a name='4097'>
      enddo<a name='4098'>
      enddo<a name='4099'>
      do k=1,maxens3<a name='4100'>
      do i=its,ite<a name='4101'>
        if(ierr(i).eq.0)then<a name='4102'>
        xt_ave(i)=xt_ave(i)+x_ave(i,k)<a name='4103'>
        endif<a name='4104'>
      enddo<a name='4105'>
      enddo<a name='4106'>
      do i=its,ite<a name='4107'>
        if(ierr(i).eq.0)then<a name='4108'>
        xt_ave(i)=xt_ave(i)/float(maxens3)<a name='4109'>
        endif<a name='4110'>
      enddo<a name='4111'>
<font color=#447700>!<a name='4112'></font>
<font color=#447700>!--- now do std, skewness,curtosis<a name='4113'></font>
<font color=#447700>!<a name='4114'></font>
      do kk=1,num<a name='4115'>
      do k=1,maxens3<a name='4116'>
      do i=its,ite<a name='4117'>
        if(ierr(i).eq.0.and.x_ave(i,k).gt.0.)then<a name='4118'>
<font color=#447700>!       print *,i,j,k,kk,x_std(i,k),xf_ens(i,j,maxens3*(kk-1)+k),x_ave(i,k)<a name='4119'></font>
        x_std(i,k)=x_std(i,k)+(xf_ens(i,j,maxens3*(kk-1)+k)-x_ave(i,k))**2<a name='4120'>
        x_ske(i,k)=x_ske(i,k)+(xf_ens(i,j,maxens3*(kk-1)+k)-x_ave(i,k))**3<a name='4121'>
        x_cur(i,k)=x_cur(i,k)+(xf_ens(i,j,maxens3*(kk-1)+k)-x_ave(i,k))**4<a name='4122'>
        endif<a name='4123'>
      enddo<a name='4124'>
      enddo<a name='4125'>
      enddo<a name='4126'>
      do k=1,maxens3<a name='4127'>
      do i=its,ite<a name='4128'>
        if(ierr(i).eq.0.and.xt_ave(i).gt.0.)then<a name='4129'>
        xt_std(i)=xt_std(i)+(x_ave(i,k)-xt_ave(i))**2<a name='4130'>
        xt_ske(i)=xt_ske(i)+(x_ave(i,k)-xt_ave(i))**3<a name='4131'>
        xt_cur(i)=xt_cur(i)+(x_ave(i,k)-xt_ave(i))**4<a name='4132'>
        endif<a name='4133'>
      enddo<a name='4134'>
      enddo<a name='4135'>
      do k=1,maxens3<a name='4136'>
      do i=its,ite<a name='4137'>
        if(ierr(i).eq.0.and.x_std(i,k).gt.0.)then<a name='4138'>
           x_std(i,k)=x_std(i,k)/float(num)<a name='4139'>
           a3=max(1.e-6,x_std(i,k))<a name='4140'>
           x_std(i,k)=sqrt(a3)<a name='4141'>
           a3=max(1.e-6,x_std(i,k)**3)<a name='4142'>
           a4=max(1.e-6,x_std(i,k)**4)<a name='4143'>
           x_ske(i,k)=x_ske(i,k)/float(num)/a3<a name='4144'>
           x_cur(i,k)=x_cur(i,k)/float(num)/a4<a name='4145'>
        endif<a name='4146'>
<font color=#447700>!       print*,'                               '<a name='4147'></font>
<font color=#447700>!       print*,'Some statistics at gridpoint i,j, ierr',i,j,ierr(i)<a name='4148'></font>
<font color=#447700>!       print*,'statistics for closure number ',k<a name='4149'></font>
<font color=#447700>!       print*,'Average= ',x_ave(i,k),'  Std= ',x_std(i,k)<a name='4150'></font>
<font color=#447700>!       print*,'Skewness= ',x_ske(i,k),' Curtosis= ',x_cur(i,k)<a name='4151'></font>
<font color=#447700>!       print*,'                               '<a name='4152'></font>
<a name='4153'>
      enddo<a name='4154'>
      enddo<a name='4155'>
      do i=its,ite<a name='4156'>
        if(ierr(i).eq.0.and.xt_std(i).gt.0.)then<a name='4157'>
           xt_std(i)=xt_std(i)/float(maxens3)<a name='4158'>
           a3=max(1.e-6,xt_std(i))<a name='4159'>
           xt_std(i)=sqrt(a3)<a name='4160'>
           a3=max(1.e-6,xt_std(i)**3)<a name='4161'>
           a4=max(1.e-6,xt_std(i)**4)<a name='4162'>
           xt_ske(i)=xt_ske(i)/float(maxens3)/a3<a name='4163'>
           xt_cur(i)=xt_cur(i)/float(maxens3)/a4<a name='4164'>
<font color=#447700>!       print*,'                               '<a name='4165'></font>
<font color=#447700>!       print*,'Total ensemble independent statistics at i =',i<a name='4166'></font>
<font color=#447700>!       print*,'Average= ',xt_ave(i),'  Std= ',xt_std(i)<a name='4167'></font>
<font color=#447700>!       print*,'Skewness= ',xt_ske(i),' Curtosis= ',xt_cur(i)<a name='4168'></font>
<font color=#447700>!       print*,'                               '<a name='4169'></font>
<font color=#447700>!<a name='4170'></font>
<font color=#447700>!  first go around: store massflx for different closures/caps<a name='4171'></font>
<font color=#447700>!<a name='4172'></font>
      if(itest.eq.1)then<a name='4173'>
       pr_gr(i,j) = .333*(x_ave(i,1)+x_ave(i,2)+x_ave(i,3))<a name='4174'>
       pr_w(i,j) = .333*(x_ave(i,4)+x_ave(i,5)+x_ave(i,6))<a name='4175'>
       pr_mc(i,j) = .333*(x_ave(i,7)+x_ave(i,8)+x_ave(i,9))<a name='4176'>
       pr_st(i,j) = .333*(x_ave(i,10)+x_ave(i,11)+x_ave(i,12))<a name='4177'>
       pr_as(i,j) = .25*(x_ave(i,13)+x_ave(i,14)+x_ave(i,15) &amp;<a name='4178'>
                     + x_ave(i,16))<a name='4179'>
       pr_capma(i,j) = x_ave_cap(i,1)<a name='4180'>
       pr_capme(i,j) = x_ave_cap(i,2)<a name='4181'>
       pr_capmi(i,j) = x_ave_cap(i,3)<a name='4182'>
<font color=#447700>!<a name='4183'></font>
<font color=#447700>!  second go around: store preciprates (mm/hour) for different closures/caps<a name='4184'></font>
<font color=#447700>!<a name='4185'></font>
        else if (itest.eq.2)then<a name='4186'>
       APR_GR(i,j)=.333*(x_ave(i,1)+x_ave(i,2)+x_ave(i,3))*      &amp;<a name='4187'>
                  3600.*pr_gr(i,j) +APR_GR(i,j)<a name='4188'>
       APR_W(i,j)=.333*(x_ave(i,4)+x_ave(i,5)+x_ave(i,6))*       &amp;<a name='4189'>
                  3600.*pr_w(i,j) +APR_W(i,j)<a name='4190'>
       APR_MC(i,j)=.333*(x_ave(i,7)+x_ave(i,8)+x_ave(i,9))*      &amp;<a name='4191'>
                  3600.*pr_mc(i,j) +APR_MC(i,j)<a name='4192'>
       APR_ST(i,j)=.333*(x_ave(i,10)+x_ave(i,11)+x_ave(i,12))*   &amp;<a name='4193'>
                  3600.*pr_st(i,j) +APR_ST(i,j)<a name='4194'>
       APR_AS(i,j)=.25*(x_ave(i,13)+x_ave(i,14)+x_ave(i,15)      &amp;<a name='4195'>
                           + x_ave(i,16))*                       &amp;<a name='4196'>
                  3600.*pr_as(i,j) +APR_AS(i,j)<a name='4197'>
       APR_CAPMA(i,j) = x_ave_cap(i,1)*                          &amp;<a name='4198'>
                  3600.*pr_capma(i,j) +APR_CAPMA(i,j)<a name='4199'>
       APR_CAPME(i,j) = x_ave_cap(i,2)*                          &amp;<a name='4200'>
                  3600.*pr_capme(i,j) +APR_CAPME(i,j)<a name='4201'>
       APR_CAPMI(i,j) = x_ave_cap(i,3)*                          &amp;<a name='4202'>
                  3600.*pr_capmi(i,j) +APR_CAPMI(i,j)<a name='4203'>
        endif<a name='4204'>
        endif<a name='4205'>
      enddo<a name='4206'>
<a name='4207'>
   END SUBROUTINE massflx_stats<a name='4208'>
<a name='4209'>
<a name='4210'>
<A NAME='NEG_CHECK'><A href='../../html_code/phys/module_cu_gd.F.html#NEG_CHECK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4211'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>neg_check</font>(dt,q,outq,outt,outqc,pret,its,ite,kts,kte,itf,ktf) <A href='../../call_to/NEG_CHECK.html' TARGET='index'>1</A><a name='4212'>
<a name='4213'>
   INTEGER,      INTENT(IN   ) ::            its,ite,kts,kte,itf,ktf<a name='4214'>
<a name='4215'>
     real, dimension (its:ite,kts:kte  )                    ,                 &amp;<a name='4216'>
      intent(inout   ) ::                                                     &amp;<a name='4217'>
       q,outq,outt,outqc<a name='4218'>
     real, dimension (its:ite  )                            ,                 &amp;<a name='4219'>
      intent(inout   ) ::                                                     &amp;<a name='4220'>
       pret<a name='4221'>
     real                                                                     &amp;<a name='4222'>
        ,intent (in  )                   ::                                   &amp;<a name='4223'>
        dt<a name='4224'>
     real :: thresh,qmem,qmemf,qmem2,qtest,qmem1<a name='4225'>
<font color=#447700>!<a name='4226'></font>
<font color=#447700>! first do check on vertical heating rate<a name='4227'></font>
<font color=#447700>!<a name='4228'></font>
      thresh=200.01<a name='4229'>
      do i=its,itf<a name='4230'>
      qmemf=1.<a name='4231'>
      qmem=0.<a name='4232'>
      do k=kts,ktf<a name='4233'>
         qmem=outt(i,k)*86400.<a name='4234'>
         if(qmem.gt.2.*thresh)then<a name='4235'>
           qmem2=2.*thresh/qmem<a name='4236'>
           qmemf=min(qmemf,qmem2)<a name='4237'>
<font color=#447700>!<a name='4238'></font>
<font color=#447700>!<a name='4239'></font>
<font color=#447700>!          print *,'1',' adjusted massflux by factor ',i,k,qmem,qmem2,qmemf<a name='4240'></font>
         endif<a name='4241'>
         if(qmem.lt.-thresh)then<a name='4242'>
           qmem2=-thresh/qmem<a name='4243'>
           qmemf=min(qmemf,qmem2)<a name='4244'>
<font color=#447700>!<a name='4245'></font>
<font color=#447700>!<a name='4246'></font>
<font color=#447700>!          print *,'2',' adjusted massflux by factor ',i,k,qmem,qmem2,qmemf<a name='4247'></font>
         endif<a name='4248'>
      enddo<a name='4249'>
      do k=kts,ktf<a name='4250'>
         outq(i,k)=outq(i,k)*qmemf<a name='4251'>
         outt(i,k)=outt(i,k)*qmemf<a name='4252'>
         outqc(i,k)=outqc(i,k)*qmemf<a name='4253'>
      enddo<a name='4254'>
      pret(i)=pret(i)*qmemf <a name='4255'>
      enddo<a name='4256'>
<font color=#447700>!<a name='4257'></font>
<font color=#447700>! check whether routine produces negative q's. This can happen, since <a name='4258'></font>
<font color=#447700>! tendencies are calculated based on forced q's. This should have no<a name='4259'></font>
<font color=#447700>! influence on conservation properties, it scales linear through all<a name='4260'></font>
<font color=#447700>! tendencies<a name='4261'></font>
<font color=#447700>!<a name='4262'></font>
      thresh=1.e-10<a name='4263'>
      do i=its,itf<a name='4264'>
      qmemf=1.<a name='4265'>
      do k=kts,ktf<a name='4266'>
         qmem=outq(i,k)<a name='4267'>
         if(abs(qmem).gt.0.)then<a name='4268'>
         qtest=q(i,k)+outq(i,k)*dt<a name='4269'>
         if(qtest.lt.thresh)then<a name='4270'>
<font color=#447700>!<a name='4271'></font>
<font color=#447700>! qmem2 would be the maximum allowable tendency<a name='4272'></font>
<font color=#447700>!<a name='4273'></font>
           qmem1=outq(i,k)<a name='4274'>
           qmem2=(thresh-q(i,k))/dt<a name='4275'>
           qmemf=min(qmemf,qmem2/qmem1)<a name='4276'>
<font color=#447700>!          qmemf=max(0.,qmemf)<a name='4277'></font>
<font color=#447700>!          print *,'4 adjusted tendencies ',i,k,qmem,qmem2,qmemf<a name='4278'></font>
         endif<a name='4279'>
         endif<a name='4280'>
      enddo<a name='4281'>
      do k=kts,ktf<a name='4282'>
         outq(i,k)=outq(i,k)*qmemf<a name='4283'>
         outt(i,k)=outt(i,k)*qmemf<a name='4284'>
         outqc(i,k)=outqc(i,k)*qmemf<a name='4285'>
      enddo<a name='4286'>
      pret(i)=pret(i)*qmemf <a name='4287'>
      enddo<a name='4288'>
<a name='4289'>
   END SUBROUTINE neg_check<a name='4290'>
<a name='4291'>
<a name='4292'>
<font color=#447700>!-------------------------------------------------------<a name='4293'></font>
END MODULE module_cu_gd<a name='4294'>
</pre></body></html>