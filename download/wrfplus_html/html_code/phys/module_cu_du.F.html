<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_CU_DU'><A href='../../html_code/phys/module_cu_du.F.html#MODULE_CU_DU' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_du</font> <A href='../../call_to/MODULE_CU_DU.html' TARGET='index'>7</A><a name='3'>
<a name='4'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_cu_du.F.html#module_cu_du.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_32"><a name='5'>
<a name='6'>
   REAL    , PARAMETER :: cincap = -10.<a name='7'>
   REAL    , PARAMETER :: capemin = 10.<a name='8'>
   REAL    , PARAMETER :: dpthmin = 1000.<a name='9'>
   REAL    , PARAMETER :: alpha = 0.001<a name='10'>
   REAL    , PARAMETER :: eps = 0.5<a name='11'>
   REAL    , PARAMETER :: Vfall = 5.<a name='12'>
<a name='13'>
<font color=#447700>!--------------------------------------------------------------------<a name='14'></font>
<a name='15'>
CONTAINS<a name='16'>
<a name='17'>
<A NAME='DUCU'><A href='../../html_code/phys/module_cu_du.F.html#DUCU' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='18'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>DUCU</font>(                                          &amp; <A href='../../call_to/DUCU.html' TARGET='index'>5</A>,<A href='../../call_from/DUCU.html' TARGET='index'>1</A><a name='19'>
              ids,ide, jds,jde, kds,kde                      &amp;<a name='20'>
             ,ims,ime, jms,jme, kms,kme                      &amp;<a name='21'>
             ,its,ite, jts,jte, kts,kte                      &amp;<a name='22'>
             ,DT,KTAU,DX                                     &amp;<a name='23'>
             ,rho,RAINCV,NCA                                 &amp;<a name='24'>
             ,U,V,TH,T,W,dz8w,Z,Pcps,pi                      &amp;<a name='25'>
             ,W0AVG,XLV                                      &amp;<a name='26'>
             ,CP,RD,RV,G                                      &amp;<a name='27'>
             ,EP2,SVP1,SVP2,SVP3,SVPT0                       &amp;<a name='28'>
             ,STEPCU,CU_ACT_FLAG,warm_rain,CUTOP,CUBOT       &amp;<a name='29'>
             ,QV                                             &amp;<a name='30'>
            <font color=#447700>! optionals<a name='31'></font>
             ,RTHCUTEN,RQVCUTEN                              &amp;<a name='32'>
                                                             )<a name='33'>
<font color=#447700>!<a name='34'></font>
<font color=#447700>!-------------------------------------------------------------<a name='35'></font>
   IMPLICIT NONE<a name='36'>
<font color=#447700>!-------------------------------------------------------------<a name='37'></font>
   INTEGER,      INTENT(IN   ) ::                            &amp;<a name='38'>
                                  ids,ide, jds,jde, kds,kde, &amp;<a name='39'>
                                  ims,ime, jms,jme, kms,kme, &amp;<a name='40'>
                                  its,ite, jts,jte, kts,kte<a name='41'>
<a name='42'>
   INTEGER,      INTENT(IN   ) :: STEPCU<a name='43'>
   LOGICAL,      INTENT(IN   ) :: warm_rain<a name='44'>
<a name='45'>
   REAL,         INTENT(IN   ) :: XLV<a name='46'>
   REAL,         INTENT(IN   ) :: CP,RD,RV,G,EP2<a name='47'>
   REAL,         INTENT(IN   ) :: SVP1,SVP2,SVP3,SVPT0<a name='48'>
<a name='49'>
   INTEGER,      INTENT(IN   ) :: KTAU           <a name='50'>
<a name='51'>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='52'>
          INTENT(IN   ) ::                                   &amp;<a name='53'>
                                                          U, &amp;<a name='54'>
                                                          V, &amp;<a name='55'>
                                                          W, &amp;<a name='56'>
                                                         TH, &amp;<a name='57'>
                                                          T, &amp;<a name='58'>
                                                         QV, &amp;<a name='59'>
                                                       dz8w, &amp;<a name='60'>
                                                          z, &amp;<a name='61'>
                                                       Pcps, &amp;<a name='62'>
                                                        rho, &amp;<a name='63'>
                                                         pi<a name='64'>
<font color=#447700>!<a name='65'></font>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='66'>
          INTENT(INOUT) ::                                   &amp;<a name='67'>
                                                      W0AVG<a name='68'>
<a name='69'>
   REAL,  INTENT(IN   ) :: DT, DX<a name='70'>
<font color=#447700>!<a name='71'></font>
   REAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='72'>
          INTENT(INOUT) ::                           RAINCV<a name='73'>
<a name='74'>
   REAL,    DIMENSION( ims:ime , jms:jme ),                  &amp;<a name='75'>
            INTENT(INOUT) ::                            NCA<a name='76'>
<a name='77'>
   REAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='78'>
          INTENT(OUT) ::                              CUBOT, &amp;<a name='79'>
                                                      CUTOP    <a name='80'>
<a name='81'>
   LOGICAL, DIMENSION( ims:ime , jms:jme ),                  &amp;<a name='82'>
          INTENT(INOUT) :: CU_ACT_FLAG<a name='83'>
<a name='84'>
<font color=#447700>!<a name='85'></font>
<font color=#447700>! Optional arguments<a name='86'></font>
<font color=#447700>!<a name='87'></font>
<a name='88'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),           &amp;<a name='89'>
         OPTIONAL,                                           &amp;<a name='90'>
         INTENT(INOUT) ::                                    &amp;<a name='91'>
                                                   RTHCUTEN, &amp;<a name='92'>
                                                   RQVCUTEN<a name='93'>
<a name='94'>
<font color=#447700>!<a name='95'></font>
<font color=#447700>! LOCAL VARS<a name='96'></font>
<a name='97'>
   LOGICAL :: flag_qr, flag_qi, flag_qs<a name='98'>
<a name='99'>
   REAL, DIMENSION( kts:kte ) ::                             &amp;<a name='100'>
                                                        U1D, &amp;<a name='101'>
                                                        V1D, &amp;<a name='102'>
                                                        T1D, &amp;<a name='103'>
                                                       TH1D, &amp;<a name='104'>
                                                       DZ1D, &amp;<a name='105'>
                                                        Z1D, &amp;<a name='106'>
                                                       QV1D, &amp;<a name='107'>
                                                        P1D, &amp;<a name='108'>
                                                      RHO1D, &amp;<a name='109'>
                                                    W0AVG1D<a name='110'>
<a name='111'>
   REAL, DIMENSION( kts:kte )::                              &amp;<a name='112'>
                                                      DQVDT, &amp;<a name='113'>
                                                      DTHDT<a name='114'>
<a name='115'>
   REAL    :: PPRATE,TST,tv,PRS,RHOE,W0,SCR1,DXSQ,tmp,RTHCUMAX<a name='116'>
<a name='117'>
   INTEGER :: i,j,k,i_start,i_end,j_start,j_end,sz,NTST,ICLDCK<a name='118'>
<font color=#447700>!<a name='119'></font>
<a name='120'>
   DXSQ=DX*DX<a name='121'>
<a name='122'>
   NTST=STEPCU<a name='123'>
   ICLDCK=MOD(KTAU,NTST)<a name='124'>
   IF(ICLDCK.EQ.0 .or. KTAU .eq. 1) then<a name='125'>
<font color=#447700>!<a name='126'></font>
<font color=#447700>!  Keep away from specified and relaxation zone (should be for just specified and nested bc)<a name='127'></font>
   sz = 1<a name='128'>
   i_start=max(ids+sz,its)<a name='129'>
   i_end=min(ide-1-sz,ite)<a name='130'>
   j_start=max(jds+sz,jts)<a name='131'>
   j_end=min(jde-1-sz,jte)<a name='132'>
<font color=#447700>!<a name='133'></font>
     DO J = j_start, j_end<a name='134'>
       DO I= i_start, i_end<a name='135'>
<a name='136'>
            DO k=kts,kte<a name='137'>
               DQVDT(k)=0.<a name='138'>
               DTHDT(k)=0.<a name='139'>
            ENDDO<a name='140'>
            RAINCV(I,J)=0.<a name='141'>
            CUTOP(I,J)=KTS<a name='142'>
            CUBOT(I,J)=KTE+1<a name='143'>
<font color=#447700>!<a name='144'></font>
<font color=#447700>! assign vars from 3D to 1D<a name='145'></font>
<a name='146'>
            DO K=kts,kte<a name='147'>
               U1D(K) =U(I,K,J)<a name='148'>
               V1D(K) =V(I,K,J)<a name='149'>
               T1D(K) =T(I,K,J)<a name='150'>
               TH1D(K) =TH(I,K,J)<a name='151'>
               RHO1D(K) =rho(I,K,J)<a name='152'>
               QV1D(K)=QV(I,K,J)<a name='153'>
               P1D(K) =Pcps(I,K,J)<a name='154'>
               W0AVG1D(K) =W0AVG(I,K,J)<a name='155'>
               DZ1D(k)=dz8w(I,K,J)<a name='156'>
               Z1D(k)=z(I,K,J)<a name='157'>
            ENDDO<a name='158'>
            CALL <A href='../../html_code/phys/module_cu_du.F.html#DUCU1D'>DUCU1D</A><A href='../../html_code/phys/module_cu_du.F.html#DUCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DUCU1D_1">(I, J,                       &amp;<a name='159'>
                 U1D,V1D,T1D,QV1D,P1D,DZ1D,Z1D,     &amp;<a name='160'>
                 W0AVG1D,DT,DX,DXSQ,RHO1D,TH1D,     &amp;<a name='161'>
                 XLV,CP,RD,RV,G,                    &amp;<a name='162'>
                 EP2,SVP1,SVP2,SVP3,SVPT0,          &amp;<a name='163'>
                 DQVDT,DTHDT,                       &amp;<a name='164'>
                 PPRATE,NCA,NTST,                   &amp;<a name='165'>
                 CUTOP,CUBOT,                       &amp;<a name='166'>
                 ids,ide, jds,jde, kds,kde,         &amp;<a name='167'>
                 ims,ime, jms,jme, kms,kme,         &amp;<a name='168'>
                 its,ite, jts,jte, kts,kte)<a name='169'>
            IF(PRESENT(rthcuten).AND.PRESENT(rqvcuten)) THEN<a name='170'>
              DO K=kts,kte<a name='171'>
                 RTHCUTEN(I,K,J)=DTHDT(K)<a name='172'>
                 RQVCUTEN(I,K,J)=DQVDT(K)<a name='173'>
              ENDDO<a name='174'>
              RAINCV(I,J)=PPRATE*DT<a name='175'>
            ENDIF<a name='176'>
       ENDDO<a name='177'>
     ENDDO<a name='178'>
   ENDIF<a name='179'>
<font color=#447700>!<a name='180'></font>
   END SUBROUTINE DUCU<a name='181'>
<font color=#447700>! ****************************************************************************<a name='182'></font>
<font color=#447700>!-----------------------------------------------------------<a name='183'></font>
<A NAME='DUCU1D'><A href='../../html_code/phys/module_cu_du.F.html#DUCU1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='184'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>DUCU1D</font> (I, J,                           &amp; <A href='../../call_to/DUCU1D.html' TARGET='index'>2</A><a name='185'>
                      U0,V0,T0,QV0,P0,DZQ,Z,W0AVG1D,       &amp;<a name='186'>
                      DELT,DX,DXSQ,rhoe,TH0,               &amp;<a name='187'>
                      XLV,CP,RD,RV,G,                      &amp;<a name='188'>
                      EP2,SVP1,SVP2,SVP3,SVPT0,            &amp;<a name='189'>
                      DQVDT,DTHDT,                         &amp;<a name='190'>
                      PPRATE,NCA,NTST,                     &amp;<a name='191'>
                      CUTOP,CUBOT,                         &amp;<a name='192'>
                      ids,ide, jds,jde, kds,kde,           &amp;<a name='193'>
                      ims,ime, jms,jme, kms,kme,           &amp;<a name='194'>
                      its,ite, jts,jte, kts,kte)<a name='195'>
<font color=#447700>!-----------------------------------------------------------<a name='196'></font>
<font color=#447700>!<a name='197'></font>
      IMPLICIT NONE<a name='198'>
<font color=#447700>!-----------------------------------------------------------<a name='199'></font>
      INTEGER, INTENT(IN   ) :: ids,ide, jds,jde, kds,kde, &amp;<a name='200'>
                                ims,ime, jms,jme, kms,kme, &amp;<a name='201'>
                                its,ite, jts,jte, kts,kte, &amp;<a name='202'>
                                I,J,NTST<a name='203'>
<a name='204'>
<font color=#447700>!<a name='205'></font>
      REAL, DIMENSION( kts:kte ),                          &amp;<a name='206'>
            INTENT(IN   ) ::                           U0, &amp;<a name='207'>
                                                       V0, &amp;<a name='208'>
                                                       T0, &amp;<a name='209'>
                                                      TH0, &amp;<a name='210'>
                                                      QV0, &amp;<a name='211'>
                                                       P0, &amp;<a name='212'>
                                                     rhoe, &amp;<a name='213'>
                                                      DZQ, &amp;<a name='214'>
                                                        Z, &amp;<a name='215'>
                                                  W0AVG1D<a name='216'>
<font color=#447700>!<a name='217'></font>
      REAL,  INTENT(IN   ) :: DELT,DX,DXSQ<a name='218'>
<font color=#447700>!<a name='219'></font>
<a name='220'>
      REAL,  INTENT(IN   ) :: XLV,CP,RD,RV,G<a name='221'>
      REAL,  INTENT(IN   ) :: EP2,SVP1,SVP2,SVP3,SVPT0<a name='222'>
<a name='223'>
<font color=#447700>!<a name='224'></font>
      REAL, DIMENSION( kts:kte ), INTENT(INOUT) ::         &amp;<a name='225'>
                                                    DQVDT, &amp;<a name='226'>
                                                    DTHDT<a name='227'>
<a name='228'>
      REAL,    DIMENSION( ims:ime , jms:jme ),             &amp;<a name='229'>
            INTENT(INOUT) ::                          NCA<a name='230'>
<a name='231'>
      REAL, DIMENSION( ims:ime , jms:jme ),                &amp;<a name='232'>
            INTENT(OUT) ::                          CUBOT, &amp;<a name='233'>
                                                    CUTOP<a name='234'>
     REAL,  INTENT(OUT  ) :: PPRATE<a name='235'>
<font color=#447700>!<a name='236'></font>
<font color=#447700>!...DEFINE LOCAL VARIABLES...<a name='237'></font>
<font color=#447700>!<a name='238'></font>
      REAL, DIMENSION( kts:kte ) :: cond,h,hs,qs,x<a name='239'>
      REAL    :: buoy,cape,cin,condpr,dh,dq,dt,dtm,ep,es, &amp;<a name='240'>
                 evap,hp,mp,qp,qsp,rrk,rrkp, &amp;<a name='241'>
                 tadp,tdp,zb,zg,zi,zt<a name='242'>
      INTEGER :: ipos,isat,k,kb,ki,kt<a name='243'>
      INTEGER :: iprint,jprint<a name='244'>
      iprint=73<a name='245'>
      jprint=20<a name='246'>
<font color=#447700>!<a name='247'></font>
<font color=#447700>!...DEFINE PROFILES<a name='248'></font>
      DO k=kts,kte<a name='249'>
        h(k)=cp*t0(k)+g*z(k)+xlv*qv0(k)<a name='250'>
        es=1000.*svp1*EXP(svp2*(t0(k)-svpt0)/(t0(k)-svp3))<a name='251'>
        qs(k)=ep2*es/(p0(k)-es)<a name='252'>
        hs(k)=cp*t0(k)+g*z(k)+xlv*qs(k)<a name='253'>
        x(k)=xlv*xlv*qs(k)/(cp*rv*t0(k)*t0(k))<a name='254'>
        dthdt(k)=0.<a name='255'>
        dqvdt(k)=0.<a name='256'>
      ENDDO<a name='257'>
      pprate=0.<a name='258'>
      zg=z(1)-0.5*dzq(1)<a name='259'>
<font color=#447700>!<a name='260'></font>
<font color=#447700>!...LOOP OVER PARCELS<a name='261'></font>
      loop_origin: DO ki=kts,kte<a name='262'>
        hp=h(ki)<a name='263'>
        qp=qv0(ki)<a name='264'>
        mp=alpha*rhoe(ki)*dzq(ki)<a name='265'>
        zi=z(ki)<a name='266'>
        buoy=0.<a name='267'>
        cape=0.<a name='268'>
        cin=0.<a name='269'>
        dtm=0.<a name='270'>
        isat=0<a name='271'>
        ipos=0<a name='272'>
        kt=0<a name='273'>
        kb=0<a name='274'>
        cond=0.<a name='275'>
<font color=#447700>!<a name='276'></font>
<font color=#447700>!...LIFT PARCEL<a name='277'></font>
        loop_lift: DO k=ki+1,kte<a name='278'>
          tadp=t0(ki)+(g/cp)*(z(ki)-z(k))<a name='279'>
          ep=p0(k)*qv0(ki)/(ep2+qv0(ki))<a name='280'>
          tdp=(svpt0-(svp3/svp2)*ALOG(0.001*ep/svp1))/(1.-(1./svp2)*ALOG(0.001*ep/svp1))<a name='281'>
          IF(tadp.GE.tdp)THEN<a name='282'>
<font color=#447700>!         unsaturated<a name='283'></font>
            IF(isat.EQ.1)THEN<a name='284'>
              print *,i,j,'sounding warning: unsat above sat'<a name='285'>
            ENDIF<a name='286'>
            dt=tadp-t0(k)<a name='287'>
            cond(k)=0.<a name='288'>
            condpr=0.<a name='289'>
          ELSE<a name='290'>
<font color=#447700>!         saturated<a name='291'></font>
            IF(isat.EQ.0)THEN<a name='292'>
              kb=k<a name='293'>
              zb=z(k)-0.5*dzq(k)<a name='294'>
            ENDIF<a name='295'>
            isat=1<a name='296'>
            dh=hp-hs(k)<a name='297'>
            dt=(dh/cp)/(1.+x(k))<a name='298'>
            qsp=qs(k)+(dh/xlv)*x(k)/(1.+x(k))<a name='299'>
<font color=#447700>!...CONDENSATE PRODUCED<a name='300'></font>
            cond(k)=mp*(qp-qsp)<a name='301'>
            qp=qsp<a name='302'>
          ENDIF<a name='303'>
          buoy=buoy+g*dt*dzq(k)/t0(k)<a name='304'>
          cape=max(cape,buoy)<a name='305'>
          IF(buoy.GE.cincap)cin=min(cin,buoy)<a name='306'>
          IF(dt .GE. 0.)THEN<a name='307'>
            kt=k<a name='308'>
            zt=z(k)+0.5*dzq(k)<a name='309'>
          ELSE IF(dt .LT. 0. .AND. dtm .GE. 0.)THEN<a name='310'>
<font color=#447700>! cloud top is level closest to parcel temperature<a name='311'></font>
            IF(abs(dt) .LT. abs(dtm))THEN<a name='312'>
              kt=k<a name='313'>
              zt=z(k)+0.5*dzq(k)<a name='314'>
            ENDIF<a name='315'>
          ENDIF<a name='316'>
          dtm=dt<a name='317'>
<font color=#447700>! continue lifting until buoyancy is gone<a name='318'></font>
          IF(buoy.LT.cincap)THEN<a name='319'>
if(i.eq.iprint.and.j.eq.jprint)print *,i,j,ki,k,buoy,isat,ipos,' buoy,isat,ipos'<a name='320'>
<font color=#447700>!         capped or cloud top<a name='321'></font>
            EXIT loop_lift<a name='322'>
          ENDIF<a name='323'>
          IF(buoy.GT.0.)THEN<a name='324'>
<font color=#447700>!         positive area detected<a name='325'></font>
            ipos=1<a name='326'>
          ENDIF<a name='327'>
          IF(k.EQ.1)THEN<a name='328'>
            kt=k<a name='329'>
            zt=z(k)+0.5*dzq(k)<a name='330'>
            zi=z(ki)<a name='331'>
            print *,'sounding warning: cloud top at model top'<a name='332'>
          ENDIF<a name='333'>
        ENDDO loop_lift<a name='334'>
<font color=#447700>!<a name='335'></font>
<font color=#447700>!...CHECK FOR CLOUD<a name='336'></font>
        IF(isat.EQ.0)THEN<a name='337'>
<font color=#447700>!       no cloud from lifting - no convection<a name='338'></font>
if(i.eq.iprint.and.j.eq.jprint)print *,i,j,ki,' no saturation'<a name='339'>
          CYCLE loop_origin<a name='340'>
        ENDIF<a name='341'>
        IF(zt-zb.LE.dpthmin)THEN<a name='342'>
<font color=#447700>!       not more than one cloud level - no convection<a name='343'></font>
if(i.eq.iprint.and.j.eq.jprint)print *,i,j,ki,zb,zt,' cloud too shallow'<a name='344'>
          CYCLE loop_origin<a name='345'>
        ENDIF<a name='346'>
        IF(ipos.EQ.0)THEN<a name='347'>
<font color=#447700>!       no buoyancy in cloud - no convection<a name='348'></font>
if(i.eq.iprint.and.j.eq.jprint)print *,i,j,ki,' no buoyancy'<a name='349'>
          CYCLE loop_origin<a name='350'>
        ENDIF<a name='351'>
        IF(cape.LE.capemin)THEN<a name='352'>
<font color=#447700>!       not enough cape<a name='353'></font>
if(i.eq.iprint.and.j.eq.jprint)print *,i,j,cape,' not enough cape'<a name='354'>
          CYCLE loop_origin<a name='355'>
        ENDIF<a name='356'>
<font color=#447700>!<a name='357'></font>
<font color=#447700>!...IF CHECK FOR CLOUD SUCCESSFUL<a name='358'></font>
<font color=#447700>!<a name='359'></font>
<font color=#447700>!...DETRAINMENT<a name='360'></font>
        dh=hp-hs(kt)<a name='361'>
        dt=(dh/cp)/(1.+x(kt))<a name='362'>
        dq=qs(kt)+(dh/xlv)*x(kt)/(1.+x(kt))-qv0(kt)<a name='363'>
        dthdt(kt)=dthdt(kt)+mp*(th0(kt)/t0(kt))*dt/(rhoe(kt)*dzq(kt))<a name='364'>
if(i.eq.iprint.and.j.eq.jprint)print *,i,j,kt,dthdt(kt),mp,th0(kt)/t0(kt),dt,rhoe(k)*dzq(k),' detr'<a name='365'>
        dqvdt(kt)=dqvdt(kt)+mp*dq/(rhoe(kt)*dzq(kt))<a name='366'>
<font color=#447700>!<a name='367'></font>
<font color=#447700>!...SUBSIDENCE<a name='368'></font>
        loop_subsidence: DO k=kt-1,ki,-1 <a name='369'>
          dthdt(k)=dthdt(k)+mp*(th0(k+1)-th0(k))/(rhoe(k)*dzq(k))<a name='370'>
          dqvdt(k)=dqvdt(k)+mp*(qv0(k+1)-qv0(k))/(rhoe(k)*dzq(k))<a name='371'>
if(i.eq.iprint.and.j.eq.jprint)print *,i,j,k,mp,dqvdt(k),dthdt(k),' subs'<a name='372'>
        ENDDO loop_subsidence<a name='373'>
<font color=#447700>!<a name='374'></font>
<font color=#447700>!...RAINFALL<a name='375'></font>
        rrkp=0.<a name='376'>
        loop_rainfall: DO k=kt,1,-1<a name='377'>
          rrk=rrkp+cond(k)<a name='378'>
          rrkp=rrk<a name='379'>
        ENDDO loop_rainfall<a name='380'>
        pprate=pprate+rrkp<a name='381'>
if(i.eq.iprint.and.j.eq.jprint)print *,'conv ',i,j,ki,kb,kt,pprate,zb,zt,condpr,cape<a name='382'>
<font color=#447700>!print *,'cloud ',i,j,ki,kb,kt,pprate,condpr,cin,cape<a name='383'></font>
      ENDDO loop_origin<a name='384'>
<a name='385'>
<font color=#447700>!-----------------------------------------------------------------------<a name='386'></font>
   END SUBROUTINE DUCU1D<a name='387'>
<font color=#447700>! ***********************************************************************<a name='388'></font>
<font color=#447700>!====================================================================<a name='389'></font>
<A NAME='DUCUINIT'><A href='../../html_code/phys/module_cu_du.F.html#DUCUINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='390'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>ducuinit</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN,      &amp; <A href='../../call_to/DUCUINIT.html' TARGET='index'>1</A><a name='391'>
                     RQICUTEN,RQSCUTEN,NCA,W0AVG,P_QI,P_QS,         &amp;<a name='392'>
                     SVP1,SVP2,SVP3,SVPT0,                          &amp;<a name='393'>
                     P_FIRST_SCALAR,restart,allowed_to_read,        &amp;<a name='394'>
                     ids, ide, jds, jde, kds, kde,                  &amp;<a name='395'>
                     ims, ime, jms, jme, kms, kme,                  &amp;<a name='396'>
                     its, ite, jts, jte, kts, kte                   )<a name='397'>
<font color=#447700>!--------------------------------------------------------------------<a name='398'></font>
   IMPLICIT NONE<a name='399'>
<font color=#447700>!--------------------------------------------------------------------<a name='400'></font>
   LOGICAL , INTENT(IN)           ::  restart,allowed_to_read<a name='401'>
   INTEGER , INTENT(IN)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='402'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='403'>
                                      its, ite, jts, jte, kts, kte<a name='404'>
   INTEGER , INTENT(IN)           ::  P_QI,P_QS,P_FIRST_SCALAR<a name='405'>
<a name='406'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='407'>
                                                          RTHCUTEN, &amp;<a name='408'>
                                                          RQVCUTEN, &amp;<a name='409'>
                                                          RQCCUTEN, &amp;<a name='410'>
                                                          RQRCUTEN, &amp;<a name='411'>
                                                          RQICUTEN, &amp;<a name='412'>
                                                          RQSCUTEN<a name='413'>
<a name='414'>
   REAL ,   DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) :: W0AVG<a name='415'>
<a name='416'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT):: NCA<a name='417'>
<a name='418'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='419'>
   REAL, INTENT(IN)    :: SVP1,SVP2,SVP3,SVPT0<a name='420'>
<a name='421'>
   jtf=min0(jte,jde-1)<a name='422'>
   ktf=min0(kte,kde-1)<a name='423'>
   itf=min0(ite,ide-1)<a name='424'>
<a name='425'>
   IF(.not.restart)THEN<a name='426'>
<a name='427'>
      DO j=jts,jtf<a name='428'>
      DO k=kts,ktf<a name='429'>
      DO i=its,itf<a name='430'>
         RTHCUTEN(i,k,j)=0.<a name='431'>
         RQVCUTEN(i,k,j)=0.<a name='432'>
         RQCCUTEN(i,k,j)=0.<a name='433'>
         RQRCUTEN(i,k,j)=0.<a name='434'>
      ENDDO<a name='435'>
      ENDDO<a name='436'>
      ENDDO<a name='437'>
<a name='438'>
      IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='439'>
         DO j=jts,jtf<a name='440'>
         DO k=kts,ktf<a name='441'>
         DO i=its,itf<a name='442'>
            RQICUTEN(i,k,j)=0.<a name='443'>
         ENDDO<a name='444'>
         ENDDO<a name='445'>
         ENDDO<a name='446'>
      ENDIF<a name='447'>
<a name='448'>
      IF (P_QS .ge. P_FIRST_SCALAR) THEN<a name='449'>
         DO j=jts,jtf<a name='450'>
         DO k=kts,ktf<a name='451'>
         DO i=its,itf<a name='452'>
            RQSCUTEN(i,k,j)=0.<a name='453'>
         ENDDO<a name='454'>
         ENDDO<a name='455'>
         ENDDO<a name='456'>
      ENDIF<a name='457'>
<a name='458'>
      DO j=jts,jtf<a name='459'>
      DO i=its,itf<a name='460'>
         NCA(i,j)=-100.<a name='461'>
      ENDDO<a name='462'>
      ENDDO<a name='463'>
<a name='464'>
      DO j=jts,jtf<a name='465'>
      DO k=kts,ktf<a name='466'>
      DO i=its,itf<a name='467'>
         W0AVG(i,k,j)=0.<a name='468'>
      ENDDO<a name='469'>
      ENDDO<a name='470'>
      ENDDO<a name='471'>
<a name='472'>
   endif<a name='473'>
 <a name='474'>
   END SUBROUTINE ducuinit<a name='475'>
<a name='476'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='477'></font>
<font color=#447700>!!!!!!!!!!!               TL starts here.                            !!!!!!<a name='478'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='479'></font>
<a name='480'>
<font color=#447700>!  Differentiation of ducu1d in forward (tangent) mode:<a name='481'></font>
<font color=#447700>!   variations  of output variables: dthdt pprate dqvdt<a name='482'></font>
<font color=#447700>!   with respect to input variables: dthdt p0 z t0 th0 rhoe dzq<a name='483'></font>
<font color=#447700>!                dqvdt qv0<a name='484'></font>
<font color=#447700>! ****************************************************************************<a name='485'></font>
<font color=#447700>!-----------------------------------------------------------<a name='486'></font>
<A NAME='DUCU1D_D'><A href='../../html_code/phys/module_cu_du.F.html#DUCU1D_D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='487'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>DUCU1D_D</font>(i, j, u0, v0, t0, t0d, qv0, qv0d, p0, p0d, dzq, dzqd&amp; <A href='../../call_to/DUCU1D_D.html' TARGET='index'>1</A><a name='488'>
&amp;  , z, zd, w0avg1d, delt, dx, dxsq, rhoe, rhoed, th0, th0d, xlv, cp, rd&amp;<a name='489'>
&amp;  , rv, g, ep2, svp1, svp2, svp3, svpt0, dqvdt, dqvdtd, dthdt, dthdtd, &amp;<a name='490'>
&amp;  pprate, pprated, nca, ntst, cutop, cubot, ids, ide, jds, jde, kds, &amp;<a name='491'>
&amp;  kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte)<a name='492'>
  IMPLICIT NONE<a name='493'>
<font color=#447700>!-----------------------------------------------------------------------<a name='494'></font>
  REAL, INTENT(IN) :: cp, delt, dx, dxsq, ep2, g, rd, rv, svp1, svp2, &amp;<a name='495'>
&amp;  svp3, svpt0, xlv<a name='496'>
  INTEGER, INTENT(IN) :: ime, ims, jme, jms, kte, kts<a name='497'>
  REAL, DIMENSION(ims:ime, jms:jme), INTENT(OUT) :: cubot, cutop<a name='498'>
  REAL, DIMENSION(kts:kte), INTENT(INOUT) :: dqvdt, dthdt<a name='499'>
  REAL :: dqvdtd(kts:kte), dthdtd(kts:kte)<a name='500'>
  INTEGER, INTENT(IN) :: i, ide, ids, ite, its, j, jde, jds, jte, jts, &amp;<a name='501'>
&amp;  kde, kds, kme, kms, ntst<a name='502'>
  REAL, DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: nca<a name='503'>
  REAL, INTENT(OUT) :: pprate, pprated<a name='504'>
  REAL, DIMENSION(kts:kte), INTENT(IN) :: dzq, dzqd, p0, p0d, qv0, qv0d&amp;<a name='505'>
&amp;  , rhoe, rhoed, t0, t0d, th0, th0d, u0, v0, w0avg1d, z, zd<a name='506'>
  REAL :: abs1, abs2, arg1, arg1d, arg2, buoy, cape, cin, cond(&amp;<a name='507'>
&amp;  kts:kte), condd(kts:kte), condpr, dh, dhd, dq, dqd, dt, dtd, dtm, ep&amp;<a name='508'>
&amp;  , es, esd, evap, evapd, h(kts:kte), hd(kts:kte), hp, hpd, hs(kts&amp;<a name='509'>
&amp;  :kte), hsd(kts:kte), mp, mpd, qp, qpd, qs(kts:kte), qsd(kts:kte), qsp&amp;<a name='510'>
&amp;  , qspd, rrk, rrkd, rrkp, rrkpd, tadp, tdp, x(kts:kte), xd(kts:&amp;<a name='511'>
&amp;  kte), zb, zg, zi, zt<a name='512'>
<font color=#447700>!x  UNKNOWNTYPE :: capemin<a name='513'></font>
<font color=#447700>!x  UNKNOWNTYPE :: cincap<a name='514'></font>
<font color=#447700>!x  UNKNOWNTYPE :: dpthmin<a name='515'></font>
   REAL    , PARAMETER :: cincap = -10.<a name='516'>
   REAL    , PARAMETER :: capemin = 10.<a name='517'>
   REAL    , PARAMETER :: dpthmin = 1000.<a name='518'>
   REAL    , PARAMETER :: alpha = 0.001<a name='519'>
   REAL    , PARAMETER :: eps = 0.5<a name='520'>
   REAL    , PARAMETER :: Vfall = 5.<a name='521'>
<a name='522'>
  INTEGER :: ipos, iprint, isat, jprint, k, kb, ki, kt<a name='523'>
  INTRINSIC EXP, MAX, ABS, ALOG, MIN<a name='524'>
<font color=#447700>!-----------------------------------------------------------<a name='525'></font>
<font color=#447700>!<a name='526'></font>
<font color=#447700>!<a name='527'></font>
<font color=#447700>!<a name='528'></font>
<font color=#447700>!<a name='529'></font>
<font color=#447700>!<a name='530'></font>
<font color=#447700>!...DEFINE LOCAL VARIABLES...<a name='531'></font>
<font color=#447700>!<a name='532'></font>
  iprint = 73<a name='533'>
  jprint = 20<a name='534'>
  hd(kts:kte) = 0.0<a name='535'>
  qsd(kts:kte) = 0.0<a name='536'>
  xd(kts:kte) = 0.0<a name='537'>
  hsd(kts:kte) = 0.0<a name='538'>
<font color=#447700>!<a name='539'></font>
<font color=#447700>!...DEFINE PROFILES<a name='540'></font>
  DO k=kts,kte<a name='541'>
    hd(k) = cp*t0d(k) + g*zd(k) + xlv*qv0d(k)<a name='542'>
    h(k) = cp*t0(k) + g*z(k) + xlv*qv0(k)<a name='543'>
    arg1d = (svp2*t0d(k)*(t0(k)-svp3)-svp2*(t0(k)-svpt0)*t0d(k))/(t0(k)-&amp;<a name='544'>
&amp;      svp3)**2<a name='545'>
    arg1 = svp2*(t0(k)-svpt0)/(t0(k)-svp3)<a name='546'>
    esd = 1000.*svp1*arg1d*EXP(arg1)<a name='547'>
    es = 1000.*svp1*EXP(arg1)<a name='548'>
    qsd(k) = (ep2*esd*(p0(k)-es)-ep2*es*(p0d(k)-esd))/(p0(k)-es)**2<a name='549'>
    qs(k) = ep2*es/(p0(k)-es)<a name='550'>
    hsd(k) = cp*t0d(k) + g*zd(k) + xlv*qsd(k)<a name='551'>
    hs(k) = cp*t0(k) + g*z(k) + xlv*qs(k)<a name='552'>
    xd(k) = (xlv**2*qsd(k)*cp*rv*t0(k)**2-xlv**2*qs(k)*cp*rv*(t0d(k)*t0(&amp;<a name='553'>
&amp;      k)+t0(k)*t0d(k)))/(cp*rv*t0(k)*t0(k))**2<a name='554'>
    x(k) = xlv*xlv*qs(k)/(cp*rv*t0(k)*t0(k))<a name='555'>
    dthdtd(k) = 0.0<a name='556'>
    dthdt(k) = 0.<a name='557'>
    dqvdtd(k) = 0.0<a name='558'>
    dqvdt(k) = 0.<a name='559'>
  END DO<a name='560'>
<a name='561'>
  pprate = 0.<a name='562'>
  zg = z(1) - 0.5*dzq(1)<a name='563'>
  pprated = 0.0<a name='564'>
<font color=#447700>!<a name='565'></font>
<font color=#447700>!...LOOP OVER PARCELS<a name='566'></font>
loop_origin:DO ki=kts,kte<a name='567'>
    hpd = hd(ki)<a name='568'>
    hp = h(ki)<a name='569'>
    qpd = qv0d(ki)<a name='570'>
    qp = qv0(ki)<a name='571'>
    mpd = alpha*(rhoed(ki)*dzq(ki)+rhoe(ki)*dzqd(ki))<a name='572'>
    mp = alpha*rhoe(ki)*dzq(ki)<a name='573'>
    zi = z(ki)<a name='574'>
    buoy = 0.<a name='575'>
    cape = 0.<a name='576'>
    cin = 0.<a name='577'>
    dtm = 0.<a name='578'>
    isat = 0<a name='579'>
    ipos = 0<a name='580'>
    kt = 0<a name='581'>
    kb = 0<a name='582'>
    cond = 0.<a name='583'>
    condd(kts:kte) = 0.0<a name='584'>
<font color=#447700>!<a name='585'></font>
<font color=#447700>!...LIFT PARCEL<a name='586'></font>
loop_lift:DO k=ki+1,kte<a name='587'>
      tadp = t0(ki) + g/cp*(z(ki)-z(k))<a name='588'>
      ep = p0(k)*qv0(ki)/(ep2+qv0(ki))<a name='589'>
      arg1 = 0.001*ep/svp1<a name='590'>
      arg2 = 0.001*ep/svp1<a name='591'>
      tdp = (svpt0-svp3/svp2*ALOG(arg1))/(1.-1./svp2*ALOG(arg2))<a name='592'>
      IF (tadp .GE. tdp) THEN<a name='593'>
<font color=#447700>!         unsaturated<a name='594'></font>
        IF (isat .EQ. 1) PRINT*, i, j, &amp;<a name='595'>
&amp;                         'sounding warning: unsat above sat'<a name='596'>
        dt = tadp - t0(k)<a name='597'>
        condd(k) = 0.0<a name='598'>
        cond(k) = 0.<a name='599'>
        condpr = 0.<a name='600'>
      ELSE<a name='601'>
<font color=#447700>!         saturated<a name='602'></font>
        IF (isat .EQ. 0) THEN<a name='603'>
          kb = k<a name='604'>
          zb = z(k) - 0.5*dzq(k)<a name='605'>
        END IF<a name='606'>
        isat = 1<a name='607'>
        dhd = hpd - hsd(k)<a name='608'>
        dh = hp - hs(k)<a name='609'>
        dt = dh/cp/(1.+x(k))<a name='610'>
        qspd = qsd(k) + ((dhd*x(k)/xlv+dh*xd(k)/xlv)*(1.+x(k))-dh*x(k)*&amp;<a name='611'>
&amp;          xd(k)/xlv)/(1.+x(k))**2<a name='612'>
        qsp = qs(k) + dh/xlv*x(k)/(1.+x(k))<a name='613'>
<font color=#447700>!...CONDENSATE PRODUCED<a name='614'></font>
        condd(k) = mpd*(qp-qsp) + mp*(qpd-qspd)<a name='615'>
        cond(k) = mp*(qp-qsp)<a name='616'>
        qpd = qspd<a name='617'>
        qp = qsp<a name='618'>
      END IF<a name='619'>
      buoy = buoy + g*dt*dzq(k)/t0(k)<a name='620'>
      IF (cape .LT. buoy) THEN<a name='621'>
        cape = buoy<a name='622'>
      ELSE<a name='623'>
        cape = cape<a name='624'>
      END IF<a name='625'>
<a name='626'>
      IF (buoy .GE. cincap) THEN<a name='627'>
        IF (cin .GT. buoy) THEN<a name='628'>
          cin = buoy<a name='629'>
        ELSE<a name='630'>
          cin = cin<a name='631'>
        END IF<a name='632'>
      END IF<a name='633'>
      IF (dt .GE. 0.) THEN<a name='634'>
        kt = k<a name='635'>
        zt = z(k) + 0.5*dzq(k)<a name='636'>
      ELSE IF (dt .LT. 0. .AND. dtm .GE. 0.) THEN<a name='637'>
        IF (dt .GE. 0.) THEN<a name='638'>
          abs1 = dt<a name='639'>
        ELSE<a name='640'>
          abs1 = -dt<a name='641'>
        END IF<a name='642'>
        IF (dtm .GE. 0.) THEN<a name='643'>
          abs2 = dtm<a name='644'>
        ELSE<a name='645'>
          abs2 = -dtm<a name='646'>
        END IF<a name='647'>
<font color=#447700>! cloud top is level closest to parcel temperature<a name='648'></font>
        IF (abs1 .LT. abs2) THEN<a name='649'>
          kt = k<a name='650'>
          zt = z(k) + 0.5*dzq(k)<a name='651'>
        END IF<a name='652'>
      END IF<a name='653'>
      dtm = dt<a name='654'>
<font color=#447700>! continue lifting until buoyancy is gone<a name='655'></font>
      IF (buoy .LT. cincap) THEN<a name='656'>
        GOTO 100<a name='657'>
      ELSE<a name='658'>
<font color=#447700>!         capped or cloud top<a name='659'></font>
        IF (buoy .GT. 0.) ipos = 1<a name='660'>
<font color=#447700>!         positive area detected<a name='661'></font>
        IF (k .EQ. 1) THEN<a name='662'>
          kt = k<a name='663'>
          zt = z(k) + 0.5*dzq(k)<a name='664'>
          zi = z(ki)<a name='665'>
          PRINT*, 'sounding warning: cloud top at model top'<a name='666'>
        END IF<a name='667'>
      END IF<a name='668'>
<a name='669'>
    END DO loop_lift<a name='670'>
    GOTO 110<a name='671'>
 100 IF (i .EQ. iprint .AND. j .EQ. jprint) PRINT*, i, j, ki, k, buoy, &amp;<a name='672'>
&amp;                                            isat, ipos, &amp;<a name='673'>
&amp;                                            ' buoy,isat,ipos'<a name='674'>
<font color=#447700>!<a name='675'></font>
<font color=#447700>!...CHECK FOR CLOUD<a name='676'></font>
 110 IF (isat .EQ. 0) THEN<a name='677'>
<font color=#447700>!       no cloud from lifting - no convection<a name='678'></font>
      IF (i .EQ. iprint .AND. j .EQ. jprint) PRINT*, i, j, ki, &amp;<a name='679'>
&amp;                                             ' no saturation'<a name='680'>
    ELSE IF (zt - zb .LE. dpthmin) THEN<a name='681'>
<font color=#447700>!       not more than one cloud level - no convection<a name='682'></font>
      IF (i .EQ. iprint .AND. j .EQ. jprint) PRINT*, i, j, ki, zb, zt, &amp;<a name='683'>
&amp;                                             ' cloud too shallow'<a name='684'>
    ELSE IF (ipos .EQ. 0) THEN<a name='685'>
<font color=#447700>!       no buoyancy in cloud - no convection<a name='686'></font>
      IF (i .EQ. iprint .AND. j .EQ. jprint) PRINT*, i, j, ki, &amp;<a name='687'>
&amp;                                             ' no buoyancy'<a name='688'>
    ELSE IF (cape .LE. capemin) THEN<a name='689'>
<font color=#447700>!       not enough cape<a name='690'></font>
      IF (i .EQ. iprint .AND. j .EQ. jprint) PRINT*, i, j, cape, &amp;<a name='691'>
&amp;                                             ' not enough cape'<a name='692'>
    ELSE<a name='693'>
<font color=#447700>!<a name='694'></font>
<font color=#447700>!...IF CHECK FOR CLOUD SUCCESSFUL<a name='695'></font>
<font color=#447700>!<a name='696'></font>
<font color=#447700>!...DETRAINMENT<a name='697'></font>
      dhd = hpd - hsd(kt)<a name='698'>
      dh = hp - hs(kt)<a name='699'>
      dtd = (dhd*(1.+x(kt))/cp-dh*xd(kt)/cp)/(1.+x(kt))**2<a name='700'>
      dt = dh/cp/(1.+x(kt))<a name='701'>
      dqd = qsd(kt) + ((dhd*x(kt)/xlv+dh*xd(kt)/xlv)*(1.+x(kt))-dh*x(kt)&amp;<a name='702'>
&amp;        *xd(kt)/xlv)/(1.+x(kt))**2 - qv0d(kt)<a name='703'>
      dq = qs(kt) + dh/xlv*x(kt)/(1.+x(kt)) - qv0(kt)<a name='704'>
<a name='705'>
      dthdtd(kt) = dthdtd(kt) + (((mpd*dt+mp*dtd)*th0(kt)/t0(kt)+mp*dt*(&amp;<a name='706'>
&amp;        th0d(kt)*t0(kt)-th0(kt)*t0d(kt))/t0(kt)**2)*rhoe(kt)*dzq(kt)-mp&amp;<a name='707'>
&amp;        *th0(kt)*dt*(rhoed(kt)*dzq(kt)+rhoe(kt)*dzqd(kt))/t0(kt))/(rhoe&amp;<a name='708'>
&amp;        (kt)*dzq(kt))**2<a name='709'>
      dthdt(kt) = dthdt(kt) + mp*(th0(kt)/t0(kt))*dt/(rhoe(kt)*dzq(kt))<a name='710'>
      IF (i .EQ. iprint .AND. j .EQ. jprint) PRINT*, i, j, kt, dthdt(kt)&amp;<a name='711'>
&amp;                                             , mp, th0(kt)/t0(kt), dt, &amp;<a name='712'>
&amp;                                             rhoe(k)*dzq(k), ' detr'<a name='713'>
      dqvdtd(kt) = dqvdtd(kt) + ((mpd*dq+mp*dqd)*rhoe(kt)*dzq(kt)-mp*dq*&amp;<a name='714'>
&amp;        (rhoed(kt)*dzq(kt)+rhoe(kt)*dzqd(kt)))/(rhoe(kt)*dzq(kt))**2<a name='715'>
      dqvdt(kt) = dqvdt(kt) + mp*dq/(rhoe(kt)*dzq(kt))<a name='716'>
<font color=#447700>!<a name='717'></font>
<font color=#447700>!...SUBSIDENCE<a name='718'></font>
loop_subsidence:DO k=kt-1,ki,-1<a name='719'>
        dthdtd(k) = dthdtd(k) + ((mpd*(th0(k+1)-th0(k))+mp*(th0d(k+1)-&amp;<a name='720'>
&amp;          th0d(k)))*rhoe(k)*dzq(k)-mp*(th0(k+1)-th0(k))*(rhoed(k)*dzq(k&amp;<a name='721'>
&amp;          )+rhoe(k)*dzqd(k)))/(rhoe(k)*dzq(k))**2<a name='722'>
        dthdt(k) = dthdt(k) + mp*(th0(k+1)-th0(k))/(rhoe(k)*dzq(k))<a name='723'>
        dqvdtd(k) = dqvdtd(k) + ((mpd*(qv0(k+1)-qv0(k))+mp*(qv0d(k+1)-&amp;<a name='724'>
&amp;          qv0d(k)))*rhoe(k)*dzq(k)-mp*(qv0(k+1)-qv0(k))*(rhoed(k)*dzq(k&amp;<a name='725'>
&amp;          )+rhoe(k)*dzqd(k)))/(rhoe(k)*dzq(k))**2<a name='726'>
        dqvdt(k) = dqvdt(k) + mp*(qv0(k+1)-qv0(k))/(rhoe(k)*dzq(k))<a name='727'>
        IF (i .EQ. iprint .AND. j .EQ. jprint) PRINT*, i, j, k, mp, &amp;<a name='728'>
&amp;                                               dqvdt(k), dthdt(k), &amp;<a name='729'>
&amp;                                               ' subs'<a name='730'>
      END DO loop_subsidence<a name='731'>
<font color=#447700>!<a name='732'></font>
<font color=#447700>!...RAINFALL<a name='733'></font>
      rrkp = 0.<a name='734'>
      rrkpd = 0.0<a name='735'>
loop_rainfall:DO k=kt,1,-1<a name='736'>
        rrkd = rrkpd + condd(k)<a name='737'>
        rrk = rrkp + cond(k)<a name='738'>
        rrkpd = rrkd  <font color=#447700>!!!XIAO NOTE<a name='739'></font>
        rrkp = rrk<a name='740'>
      END DO loop_rainfall<a name='741'>
      pprated = pprated + rrkpd<a name='742'>
      pprate = pprate + rrkp<a name='743'>
      IF (i .EQ. iprint .AND. j .EQ. jprint) PRINT*, 'conv ', i, j, ki, &amp;<a name='744'>
&amp;                                             kb, kt, pprate, zb, zt, &amp;<a name='745'>
&amp;                                             condpr, cape<a name='746'>
<font color=#447700>!     PRINT*, 'cloud ', i, j, ki, kb, kt, pprate, condpr, cin, cape<a name='747'></font>
    END IF<a name='748'>
  END DO loop_origin<a name='749'>
END SUBROUTINE DUCU1D_D<a name='750'>
<a name='751'>
<font color=#447700>!  Differentiation of ducu in forward (tangent) mode:<a name='752'></font>
<font color=#447700>!   variations  of output variables: raincv rthcuten rqvcuten<a name='753'></font>
<font color=#447700>!   with respect to input variables: th t pcps qv z rho dz8w<a name='754'></font>
<font color=#447700>! optionals<a name='755'></font>
<A NAME='DUCU_D'><A href='../../html_code/phys/module_cu_du.F.html#DUCU_D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='756'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>DUCU_D</font>(ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms&amp; <A href='../../call_to/DUCU_D.html' TARGET='index'>3</A>,<A href='../../call_from/DUCU_D.html' TARGET='index'>1</A><a name='757'>
&amp;  , kme, its, ite, jts, jte, kts, kte, dt, ktau, dx, rho, rhod, raincv&amp;<a name='758'>
&amp;  , raincvd, nca, u, v, th, thd, t, td, w, dz8w, dz8wd, z, zd, pcps, &amp;<a name='759'>
&amp;  pcpsd, pi, w0avg, xlv, cp, rd, rv, g, ep2, svp1, svp2, svp3, svpt0, &amp;<a name='760'>
&amp;  stepcu, cu_act_flag, warm_rain, cutop, cubot, qv, qvd, rthcuten, &amp;<a name='761'>
&amp;  rthcutend, rqvcuten, rqvcutend)<a name='762'>
  IMPLICIT NONE<a name='763'>
<font color=#447700>!<a name='764'></font>
  INTEGER, INTENT(IN) :: ime, ims, jme, jms, kme, kms<a name='765'>
  LOGICAL, DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: cu_act_flag<a name='766'>
  REAL, DIMENSION(ims:ime, jms:jme), INTENT(OUT) :: cubot, cutop<a name='767'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN) :: dz8w, dz8wd&amp;<a name='768'>
&amp;  , pcps, pcpsd, pi, qv, qvd, rho, rhod, t, td, th, thd, u, v, w, z, zd<a name='769'>
  INTEGER, INTENT(IN) :: ide, ids, ite, its, jde, jds, jte, jts, kde, &amp;<a name='770'>
&amp;  kds, ktau, kte, kts, stepcu<a name='771'>
  REAL, DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: nca, raincv<a name='772'>
  REAL :: raincvd(ims:ime, jms:jme)<a name='773'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), OPTIONAL :: rqvcuten, &amp;<a name='774'>
&amp;  rqvcutend, rthcuten, rthcutend<a name='775'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: w0avg<a name='776'>
  LOGICAL, INTENT(IN) :: warm_rain<a name='777'>
  REAL, INTENT(IN) :: cp, dt, dx, ep2, g, rd, rv, svp1, svp2, svp3, &amp;<a name='778'>
&amp;  svpt0, xlv<a name='779'>
  REAL :: dqvdt(kts:kte), dqvdtd(kts:kte), dthdt(kts:kte), dthdtd(kts:&amp;<a name='780'>
&amp;  kte), dxsq, dz1d(kts:kte), dz1dd(kts:kte), p1d(kts:kte), p1dd(kts:kte&amp;<a name='781'>
&amp;  ), pprate, pprated, prs, qv1d(kts:kte), qv1dd(kts:kte), rho1d(kts:kte&amp;<a name='782'>
&amp;  ), rho1dd(kts:kte), rhoe, rthcumax, scr1, t1d(kts:kte), t1dd(kts:kte)&amp;<a name='783'>
&amp;  , th1d(kts:kte), th1dd(kts:kte), tmp, tst, tv, u1d(kts:kte), v1d(kts:&amp;<a name='784'>
&amp;  kte), w0, w0avg1d(kts:kte), z1d(kts:kte), z1dd(kts:kte)<a name='785'>
  LOGICAL :: flag_qi, flag_qr, flag_qs<a name='786'>
  INTEGER :: i, i_end, i_start, icldck, j, j_end, j_start, k, ntst, sz<a name='787'>
  INTRINSIC MOD, MAX, PRESENT, MIN<a name='788'>
<font color=#447700>!-------------------------------------------------------------<a name='789'></font>
<font color=#447700>!<a name='790'></font>
<font color=#447700>!<a name='791'></font>
<font color=#447700>!<a name='792'></font>
<font color=#447700>! Optional arguments<a name='793'></font>
<font color=#447700>!<a name='794'></font>
<font color=#447700>!<a name='795'></font>
<font color=#447700>! LOCAL VARS<a name='796'></font>
<font color=#447700>!<a name='797'></font>
  dxsq = dx*dx<a name='798'>
  ntst = stepcu<a name='799'>
  icldck = MOD(ktau, ntst)<a name='800'>
  IF (icldck .EQ. 0 .OR. ktau .EQ. 1) THEN<a name='801'>
<font color=#447700>!<a name='802'></font>
<font color=#447700>!  Keep away from specified and relaxation zone (should be for just specified and nested bc)<a name='803'></font>
    sz = 1<a name='804'>
    IF (ids + sz .LT. its) THEN<a name='805'>
      i_start = its<a name='806'>
    ELSE<a name='807'>
      i_start = ids + sz<a name='808'>
    END IF<a name='809'>
    IF (ide - 1 - sz .GT. ite) THEN<a name='810'>
      i_end = ite<a name='811'>
    ELSE<a name='812'>
      i_end = ide - 1 - sz<a name='813'>
    END IF<a name='814'>
    IF (jds + sz .LT. jts) THEN<a name='815'>
      j_start = jts<a name='816'>
    ELSE<a name='817'>
      j_start = jds + sz<a name='818'>
    END IF<a name='819'>
    IF (jde - 1 - sz .GT. jte) THEN<a name='820'>
      j_end = jte<a name='821'>
    ELSE<a name='822'>
      j_end = jde - 1 - sz<a name='823'>
    END IF<a name='824'>
<a name='825'>
    raincvd(ims:ime, jms:jme) = 0.0<a name='826'>
    rthcutend(ims:ime, kms:kme, jms:jme) = 0.0<a name='827'>
    rqvcutend(ims:ime, kms:kme, jms:jme) = 0.0<a name='828'>
    qv1dd(kts:kte) = 0.0<a name='829'>
    dthdtd(kts:kte) = 0.0<a name='830'>
    th1dd(kts:kte) = 0.0<a name='831'>
    rho1dd(kts:kte) = 0.0<a name='832'>
    p1dd(kts:kte) = 0.0<a name='833'>
    z1dd(kts:kte) = 0.0<a name='834'>
    dz1dd(kts:kte) = 0.0<a name='835'>
    t1dd(kts:kte) = 0.0<a name='836'>
    dqvdtd(kts:kte) = 0.0<a name='837'>
<font color=#447700>!<a name='838'></font>
    DO j=j_start,j_end<a name='839'>
      DO i=i_start,i_end<a name='840'>
        DO k=kts,kte<a name='841'>
          dqvdtd(k) = 0.0<a name='842'>
          dqvdt(k) = 0.<a name='843'>
          dthdtd(k) = 0.0<a name='844'>
          dthdt(k) = 0.<a name='845'>
        END DO<a name='846'>
        raincvd(i, j) = 0.0<a name='847'>
        raincv(i, j) = 0.<a name='848'>
        cutop(i, j) = kts<a name='849'>
        cubot(i, j) = kte + 1<a name='850'>
<font color=#447700>!<a name='851'></font>
<font color=#447700>! assign vars from 3D to 1D<a name='852'></font>
        DO k=kts,kte<a name='853'>
          u1d(k) = u(i, k, j)<a name='854'>
          v1d(k) = v(i, k, j)<a name='855'>
          t1dd(k) = td(i, k, j)<a name='856'>
          t1d(k) = t(i, k, j)<a name='857'>
          th1dd(k) = thd(i, k, j)<a name='858'>
          th1d(k) = th(i, k, j)<a name='859'>
          rho1dd(k) = rhod(i, k, j)<a name='860'>
          rho1d(k) = rho(i, k, j)<a name='861'>
          qv1dd(k) = qvd(i, k, j)<a name='862'>
          qv1d(k) = qv(i, k, j)<a name='863'>
          p1dd(k) = pcpsd(i, k, j)<a name='864'>
          p1d(k) = pcps(i, k, j)<a name='865'>
          w0avg1d(k) = w0avg(i, k, j)<a name='866'>
          dz1dd(k) = dz8wd(i, k, j)<a name='867'>
          dz1d(k) = dz8w(i, k, j)<a name='868'>
          z1dd(k) = zd(i, k, j)<a name='869'>
          z1d(k) = z(i, k, j)<a name='870'>
        END DO<a name='871'>
<a name='872'>
        CALL <A href='../../html_code/phys/module_cu_du.F.html#DUCU1D_D'>DUCU1D_D</A><A href='../../html_code/phys/module_cu_du.F.html#DUCU_D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DUCU1D_D_1">(i, j, u1d, v1d, t1d, t1dd, qv1d, qv1dd, p1d, p1dd&amp;<a name='873'>
&amp;                , dz1d, dz1dd, z1d, z1dd, w0avg1d, dt, dx, dxsq, rho1d&amp;<a name='874'>
&amp;                , rho1dd, th1d, th1dd, xlv, cp, rd, rv, g, ep2, svp1, &amp;<a name='875'>
&amp;                svp2, svp3, svpt0, dqvdt, dqvdtd, dthdt, dthdtd, pprate&amp;<a name='876'>
&amp;                , pprated, nca, ntst, cutop, cubot, ids, ide, jds, jde&amp;<a name='877'>
&amp;                , kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts&amp;<a name='878'>
&amp;                , jte, kts, kte)<a name='879'>
        IF (PRESENT(rthcuten) .AND. PRESENT(rqvcuten)) THEN<a name='880'>
          DO k=kts,kte<a name='881'>
            rthcutend(i, k, j) = dthdtd(k)<a name='882'>
            rthcuten(i, k, j) = dthdt(k)<a name='883'>
            rqvcutend(i, k, j) = dqvdtd(k)<a name='884'>
            rqvcuten(i, k, j) = dqvdt(k)<a name='885'>
          END DO<a name='886'>
          raincvd(i, j) = dt*pprated<a name='887'>
          raincv(i, j) = pprate*dt<a name='888'>
        END IF<a name='889'>
      END DO<a name='890'>
    END DO<a name='891'>
  ELSE<a name='892'>
    raincvd(ims:ime, jms:jme) = 0.0<a name='893'>
    rthcutend(ims:ime, kms:kme, jms:jme) = 0.0<a name='894'>
    rqvcutend(ims:ime, kms:kme, jms:jme) = 0.0<a name='895'>
  END IF<a name='896'>
END SUBROUTINE DUCU_D<a name='897'>
<a name='898'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='899'></font>
<font color=#447700>!!!!!!!!!!!               AD starts here.                            !!!!!!<a name='900'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='901'></font>
<a name='902'>
<font color=#447700>!  Differentiation of ducu1d in reverse (adjoint) mode:<a name='903'></font>
<font color=#447700>!   gradient, with respect to input variables: dthdt p0 z t0 th0<a name='904'></font>
<font color=#447700>!                rhoe dzq dqvdt qv0<a name='905'></font>
<font color=#447700>!   of linear combination of output variables: dthdt p0 z t0 th0<a name='906'></font>
<font color=#447700>!                pprate rhoe dzq dqvdt qv0<a name='907'></font>
<font color=#447700>! ****************************************************************************<a name='908'></font>
<font color=#447700>!-----------------------------------------------------------<a name='909'></font>
<A NAME='DUCU1D_B'><A href='../../html_code/phys/module_cu_du.F.html#DUCU1D_B' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='910'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>DUCU1D_B</font>(i, j, u0, v0, t0, t0b, qv0, qv0b, p0, p0b, dzq, dzqb&amp; <A href='../../call_to/DUCU1D_B.html' TARGET='index'>1</A><a name='911'>
&amp;  , z, zb0, w0avg1d, delt, dx, dxsq, rhoe, rhoeb, th0, th0b, xlv, cp, &amp;<a name='912'>
&amp;  rd, rv, g, ep2, svp1, svp2, svp3, svpt0, dqvdt, dqvdtb, dthdt, dthdtb&amp;<a name='913'>
&amp;  , pprate, pprateb, nca, ntst, cutop, cubot, ids, ide, jds, jde, kds, &amp;<a name='914'>
&amp;  kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte)<a name='915'>
  IMPLICIT NONE<a name='916'>
<font color=#447700>!-----------------------------------------------------------------------<a name='917'></font>
  REAL, INTENT(IN) :: cp, delt, dx, dxsq, ep2, g, rd, rv, svp1, svp2, &amp;<a name='918'>
&amp;  svp3, svpt0, xlv<a name='919'>
  INTEGER, INTENT(IN) :: ime, ims, jme, jms, kte, kts<a name='920'>
  REAL :: cubot(ims:ime, jms:jme), cutop(ims:ime, jms:jme), dqvdt(kts:&amp;<a name='921'>
&amp;  kte), dqvdtb(kts:kte), dthdt(kts:kte), dthdtb(kts:kte), dzqb(kts:kte)&amp;<a name='922'>
&amp;  , nca(ims:ime, jms:jme), p0b(kts:kte), pprate, pprateb, qv0b(kts:kte)&amp;<a name='923'>
&amp;  , rhoeb(kts:kte), t0b(kts:kte), th0b(kts:kte), zb0(kts:kte)<a name='924'>
  INTEGER, INTENT(IN) :: i, ide, ids, ite, its, j, jde, jds, jte, jts, &amp;<a name='925'>
&amp;  kde, kds, kme, kms, ntst<a name='926'>
  REAL, DIMENSION(kts:kte), INTENT(IN) :: dzq, p0, qv0, rhoe, t0, th0, &amp;<a name='927'>
&amp;  u0, v0, w0avg1d, z<a name='928'>
  INTEGER :: ad_from, ad_from0, ad_to, branch, ipos, iprint, isat, &amp;<a name='929'>
&amp;  jprint, k, kb, ki, kt<a name='930'>
  REAL :: abs1, abs2, buoy, cape, cin, cond(kts:kte), condb(kts:&amp;<a name='931'>
&amp;  kte), condpr, dh, dhb, dq, dqb, dt, dtb, dtm, ep, es, esb, evap&amp;<a name='932'>
&amp;  , evapb, h(kts:kte), hb(kts:kte), hp, hpb, hs(kts:kte), hsb(kts:kte)&amp;<a name='933'>
&amp;  , mp, mpb, qp, qpb, qs(kts:kte), qsb(kts:kte), qsp, qspb, rrk, rrkb, &amp;<a name='934'>
&amp;  rrkp, rrkpb, tadp, tdp, temp, temp0, temp1, temp10, temp10b, temp10b0&amp;<a name='935'>
&amp;  , temp10b1, temp10b2, temp11, temp11b, temp12, temp12b, temp13, &amp;<a name='936'>
&amp;  temp1b, temp1b0, temp1b1, temp2, temp3, temp3b, temp4, temp5, temp5b&amp;<a name='937'>
&amp;  , temp6, temp6b, temp6b0, temp7, temp7b, temp8, temp8b, temp8b0, &amp;<a name='938'>
&amp;  temp9, temp9b, temp9b0, tempb, x(kts:kte)<a name='939'>
  REAL :: xb(kts:kte), zb, zg, zi, zt<a name='940'>
<a name='941'>
<font color=#447700>!new definition<a name='942'></font>
   REAL :: ess(kts:kte), buoys(kts:kte), capes(kts:kte)<a name='943'>
   REAL :: rrkps(kts:kte), rrks(kts:kte), evaps(kts:kte), evapss(kts:kte)<a name='944'>
   REAL :: tadps(kts:kte), tdps(kts:kte)<a name='945'>
   REAL :: qps(kts:kte)  <font color=#447700>! Zhangl<a name='946'></font>
   INTEGER :: kt_s(kts:kte), kb_s(kts:kte)<a name='947'>
<font color=#447700>!end new definition<a name='948'></font>
<a name='949'>
<font color=#447700>!x  UNKNOWNTYPE :: capemin<a name='950'></font>
<font color=#447700>!x  UNKNOWNTYPE :: cincap<a name='951'></font>
<font color=#447700>!x  UNKNOWNTYPE :: dpthmin<a name='952'></font>
   REAL    , PARAMETER :: cincap = -10.<a name='953'>
   REAL    , PARAMETER :: capemin = 10.<a name='954'>
   REAL    , PARAMETER :: dpthmin = 1000.<a name='955'>
   REAL    , PARAMETER :: alpha = 0.001<a name='956'>
   REAL    , PARAMETER :: eps = 0.5<a name='957'>
   REAL    , PARAMETER :: Vfall = 5.<a name='958'>
<a name='959'>
  INTRINSIC EXP, MAX, ABS, ALOG, MIN<a name='960'>
<font color=#447700>!-----------------------------------------------------------<a name='961'></font>
<font color=#447700>!<a name='962'></font>
<font color=#447700>!<a name='963'></font>
<font color=#447700>!<a name='964'></font>
<font color=#447700>!<a name='965'></font>
<font color=#447700>!<a name='966'></font>
<font color=#447700>!...DEFINE LOCAL VARIABLES...<a name='967'></font>
<font color=#447700>!<a name='968'></font>
  iprint = 73<a name='969'>
  jprint = 20<a name='970'>
<font color=#447700>!<a name='971'></font>
<font color=#447700>! initialization of variables<a name='972'></font>
  condb(kts:kte) = 0.0<a name='973'>
  hb(kts:kte) = 0.0<a name='974'>
  qsb(kts:kte) = 0.0<a name='975'>
  xb(kts:kte) = 0.0<a name='976'>
  hsb(kts:kte) = 0.0<a name='977'>
  evapb = 0.0; rrkpb = 0.0; rrkb=0.0<a name='978'>
<font color=#447700>! end initizlization<a name='979'></font>
<font color=#447700>!<a name='980'></font>
<font color=#447700>!...DEFINE PROFILES<a name='981'></font>
  DO k=kts,kte<a name='982'>
    h(k) = cp*t0(k) + g*z(k) + xlv*qv0(k)<a name='983'>
    es = 1000.*svp1*EXP(svp2*(t0(k)-svpt0)/(t0(k)-svp3))<a name='984'>
    ess(k) = es <font color=#447700>!new<a name='985'></font>
    qs(k) = ep2*es/(p0(k)-es)<a name='986'>
    hs(k) = cp*t0(k) + g*z(k) + xlv*qs(k)<a name='987'>
    x(k) = xlv*xlv*qs(k)/(cp*rv*t0(k)*t0(k))<a name='988'>
    dthdt(k) = 0.<a name='989'>
    dqvdt(k) = 0.<a name='990'>
  END DO<a name='991'>
<a name='992'>
  pprate = 0.<a name='993'>
<font color=#447700>!<a name='994'></font>
<font color=#447700>!...LOOP OVER PARCELS<a name='995'></font>
loop_origin:DO ki=kts,kte<a name='996'>
    hp = h(ki)<a name='997'>
    qp = qv0(ki)<a name='998'>
    mp = alpha*rhoe(ki)*dzq(ki)<a name='999'>
    buoy = 0.<a name='1000'>
    cape = 0.<a name='1001'>
    dtm = 0.<a name='1002'>
    isat = 0<a name='1003'>
    ipos = 0<a name='1004'>
    kt = 0<a name='1005'>
    kb = 0<a name='1006'>
    cond = 0.<a name='1007'>
<font color=#447700>!<a name='1008'></font>
<font color=#447700>!...LIFT PARCEL<a name='1009'></font>
loop_lift:DO k=ki+1,kte<a name='1010'>
      tadp = t0(ki) + g/cp*(z(ki)-z(k))<a name='1011'>
      ep = p0(k)*qv0(ki)/(ep2+qv0(ki))<a name='1012'>
      tdp = (svpt0-svp3/svp2*ALOG(0.001*ep/svp1))/(1.-1./svp2*ALOG(0.001&amp;<a name='1013'>
&amp;        *ep/svp1))<a name='1014'>
      tadps(k) = tadp <font color=#447700>!new<a name='1015'></font>
      tdps(k) = tdp <font color=#447700>!new<a name='1016'></font>
      IF (tadp .GE. tdp) THEN<a name='1017'>
<font color=#447700>!         unsaturated<a name='1018'></font>
        dt = tadp - t0(k)<a name='1019'>
        cond(k) = 0.<a name='1020'>
      ELSE<a name='1021'>
<font color=#447700>!         saturated<a name='1022'></font>
        IF (isat .EQ. 0) THEN<a name='1023'>
          kb = k<a name='1024'>
          zb = z(k) - 0.5*dzq(k)<a name='1025'>
        END IF<a name='1026'>
        isat = 1<a name='1027'>
        dh = hp - hs(k)<a name='1028'>
        dt = dh/cp/(1.+x(k))<a name='1029'>
        qsp = qs(k) + dh/xlv*x(k)/(1.+x(k))<a name='1030'>
        qps(k) = qp                            <font color=#447700>! Zhangl<a name='1031'></font>
        cond(k) = mp*(qp-qsp)<a name='1032'>
        qp = qsp<a name='1033'>
      END IF<a name='1034'>
      buoy = buoy + g*dt*dzq(k)/t0(k)<a name='1035'>
      buoys(ki) = buoy <font color=#447700>!new<a name='1036'></font>
      IF (cape .LT. buoy) THEN<a name='1037'>
        cape = buoy<a name='1038'>
      ELSE<a name='1039'>
        cape = cape<a name='1040'>
      END IF<a name='1041'>
      capes(ki) = cape <font color=#447700>!new<a name='1042'></font>
      IF (dt .GE. 0.) THEN<a name='1043'>
        kt = k<a name='1044'>
        zt = z(k) + 0.5*dzq(k)<a name='1045'>
      ELSE IF (dt .LT. 0. .AND. dtm .GE. 0.) THEN<a name='1046'>
        IF (dt .GE. 0.) THEN<a name='1047'>
          abs1 = dt<a name='1048'>
        ELSE<a name='1049'>
          abs1 = -dt<a name='1050'>
        END IF<a name='1051'>
        IF (dtm .GE. 0.) THEN<a name='1052'>
          abs2 = dtm<a name='1053'>
        ELSE<a name='1054'>
          abs2 = -dtm<a name='1055'>
        END IF<a name='1056'>
<font color=#447700>! cloud top is level closest to parcel temperature<a name='1057'></font>
        IF (abs1 .LT. abs2) THEN<a name='1058'>
          kt = k<a name='1059'>
          zt = z(k) + 0.5*dzq(k)<a name='1060'>
        END IF<a name='1061'>
      END IF<a name='1062'>
      dtm = dt<a name='1063'>
<font color=#447700>! continue lifting until buoyancy is gone<a name='1064'></font>
      IF (buoy .LT. cincap) THEN<a name='1065'>
<font color=#447700>!         capped or cloud top<a name='1066'></font>
        EXIT loop_lift<a name='1067'>
      END IF<a name='1068'>
        IF (buoy .GT. 0.) ipos = 1<a name='1069'>
<font color=#447700>!         positive area detected<a name='1070'></font>
        IF (k .EQ. 1) THEN<a name='1071'>
          kt = k<a name='1072'>
          zt = z(k) + 0.5*dzq(k)<a name='1073'>
        END IF<a name='1074'>
    END DO loop_lift<a name='1075'>
    kt_s(ki) = kt <font color=#447700>!new<a name='1076'></font>
    kb_s(ki) = kb <font color=#447700>!new<a name='1077'></font>
<font color=#447700>!<a name='1078'></font>
<font color=#447700>!...CHECK FOR CLOUD<a name='1079'></font>
    IF (isat .EQ. 0) THEN<a name='1080'>
<font color=#447700>!       no cloud from lifting - no convection<a name='1081'></font>
      goto 500<a name='1082'>
      CYCLE loop_origin<a name='1083'>
    END IF<a name='1084'>
    IF (zt - zb .LE. dpthmin) THEN<a name='1085'>
<font color=#447700>!       not more than one cloud level - no convection<a name='1086'></font>
      goto 500<a name='1087'>
      CYCLE loop_origin<a name='1088'>
    ENDIF<a name='1089'>
    IF (ipos .EQ. 0) THEN<a name='1090'>
<font color=#447700>!       no buoyancy in cloud - no convection<a name='1091'></font>
      goto 500<a name='1092'>
      CYCLE loop_origin<a name='1093'>
    ENDIF<a name='1094'>
    IF (cape .LE. capemin) THEN<a name='1095'>
<font color=#447700>!       not enough cape<a name='1096'></font>
      goto 500<a name='1097'>
      CYCLE loop_origin<a name='1098'>
    ENDIF<a name='1099'>
<font color=#447700>!<a name='1100'></font>
<font color=#447700>!...IF CHECK FOR CLOUD SUCCESSFUL<a name='1101'></font>
<font color=#447700>!<a name='1102'></font>
<font color=#447700>!...DETRAINMENT<a name='1103'></font>
      dh = hp - hs(kt)<a name='1104'>
      dt = dh/cp/(1.+x(kt))<a name='1105'>
      dq = qs(kt) + dh/xlv*x(kt)/(1.+x(kt)) - qv0(kt)<a name='1106'>
<font color=#447700>!<a name='1107'></font>
<font color=#447700>!...SUBSIDENCE<a name='1108'></font>
<a name='1109'>
<font color=#447700>!...RAINFALL<a name='1110'></font>
      rrkp = 0.<a name='1111'>
loop_rainfall:DO k=kt,1,-1<a name='1112'>
        rrk = rrkp + cond(k)<a name='1113'>
        rrkps(k) = rrkp <font color=#447700>!new<a name='1114'></font>
        rrkp = rrk<a name='1115'>
      END DO loop_rainfall<a name='1116'>
<font color=#447700>!<a name='1117'></font>
<font color=#447700>! adjoint start<a name='1118'></font>
<font color=#447700>!<a name='1119'></font>
      rrkpb = pprateb<a name='1120'>
      DO k=1,kt_s(ki)<a name='1121'>
        rrkb = rrkpb  <font color=#447700>!!!XIAO NOTE<a name='1122'></font>
        rrkpb=rrkb<a name='1123'>
        condb(k) = condb(k) + rrkb<a name='1124'>
      END DO<a name='1125'>
      rrkpb=0.<a name='1126'>
      mpb = 0.0  <font color=#447700>!examine later<a name='1127'></font>
      DO k=ki,kt-1,1<a name='1128'>
        temp9 = rhoe(k)*dzq(k)<a name='1129'>
        temp10b = dqvdtb(k)/temp9<a name='1130'>
        temp9b = -(mp*(qv0(k+1)-qv0(k))*temp10b/temp9)<a name='1131'>
        temp8 = rhoe(k)*dzq(k)<a name='1132'>
        temp9b0 = dthdtb(k)/temp8<a name='1133'>
        mpb = mpb + (th0(k+1)-th0(k))*temp9b0 + (qv0(k+1)-qv0(k))*&amp;<a name='1134'>
&amp;          temp10b<a name='1135'>
        qv0b(k+1) = qv0b(k+1) + mp*temp10b<a name='1136'>
        qv0b(k) = qv0b(k) - mp*temp10b<a name='1137'>
        temp8b0 = -(mp*(th0(k+1)-th0(k))*temp9b0/temp8)<a name='1138'>
        rhoeb(k) = rhoeb(k) + dzq(k)*temp8b0 + dzq(k)*temp9b<a name='1139'>
        dzqb(k) = dzqb(k) + rhoe(k)*temp8b0 + rhoe(k)*temp9b<a name='1140'>
        th0b(k+1) = th0b(k+1) + mp*temp9b0<a name='1141'>
        th0b(k) = th0b(k) - mp*temp9b0<a name='1142'>
      END DO<a name='1143'>
      temp7 = rhoe(kt)*dzq(kt)<a name='1144'>
      temp8b = dqvdtb(kt)/temp7<a name='1145'>
      temp7b = -(mp*dq*temp8b/temp7)<a name='1146'>
      mpb = mpb + dq*temp8b<a name='1147'>
      dqb = mp*temp8b<a name='1148'>
      rhoeb(kt) = rhoeb(kt) + dzq(kt)*temp7b<a name='1149'>
      dzqb(kt) = dzqb(kt) + rhoe(kt)*temp7b<a name='1150'>
      temp6 = t0(kt)*rhoe(kt)<a name='1151'>
      temp6b = dthdtb(kt)/(temp6*dzq(kt))<a name='1152'>
      temp6b0 = -(th0(kt)*mp*dt*temp6b/(temp6*dzq(kt)))<a name='1153'>
      th0b(kt) = th0b(kt) + mp*dt*temp6b<a name='1154'>
      mpb = mpb + th0(kt)*dt*temp6b<a name='1155'>
      dtb = th0(kt)*mp*temp6b<a name='1156'>
      t0b(kt) = t0b(kt) + dzq(kt)*rhoe(kt)*temp6b0<a name='1157'>
      rhoeb(kt) = rhoeb(kt) + dzq(kt)*t0(kt)*temp6b0<a name='1158'>
      dzqb(kt) = dzqb(kt) + temp6*temp6b0<a name='1159'>
      temp5 = xlv*(x(kt)+1.)<a name='1160'>
      temp5b = dqb/temp5<a name='1161'>
      qsb(kt) = qsb(kt) + dqb<a name='1162'>
      temp4 = cp*(x(kt)+1.)<a name='1163'>
      dhb = dtb/temp4 + x(kt)*temp5b<a name='1164'>
      xb(kt) = xb(kt) + (dh-dh*x(kt)*xlv/temp5)*temp5b - dh*cp*dtb/temp4&amp;<a name='1165'>
&amp;        **2<a name='1166'>
      qv0b(kt) = qv0b(kt) - dqb<a name='1167'>
      hpb = dhb<a name='1168'>
      hsb(kt) = hsb(kt) - dhb<a name='1169'>
500   continue<a name='1170'>
<font color=#447700>!...LIFT PARCEL<a name='1171'></font>
      hp = h(ki)<a name='1172'>
      qp = qv0(ki)<a name='1173'>
      mp = alpha*rhoe(ki)*dzq(ki)<a name='1174'>
loop_lift1:DO k=kte,ki+1,-1<a name='1175'>
<font color=#447700>!loop_lift1:DO k=ki+1,kte<a name='1176'></font>
      IF (tadps(k) .GE. tdps(k)) THEN<a name='1177'>
        condb(k) = 0.<a name='1178'>
      ELSE<a name='1179'>
        dh = hp - hs(k)<a name='1180'>
        qsp = qs(k) + dh/xlv*x(k)/(1.+x(k))<a name='1181'>
        qspb = qpb - mp*condb(k)<a name='1182'>
<font color=#447700>!Zhangl        mpb = mpb + (qp-qsp)*condb(k)<a name='1183'></font>
        mpb = mpb + (qps(k)-qsp)*condb(k)<a name='1184'>
        qpb = mp*condb(k)<a name='1185'>
        condb(k) = 0.0<a name='1186'>
        temp3 = xlv*(x(k)+1.)<a name='1187'>
        temp3b = qspb/temp3<a name='1188'>
        qsb(k) = qsb(k) + qspb<a name='1189'>
        dhb = x(k)*temp3b<a name='1190'>
        xb(k) = xb(k) + (dh-dh*x(k)*xlv/temp3)*temp3b<a name='1191'>
        hpb = hpb + dhb<a name='1192'>
        hsb(k) = hsb(k) - dhb<a name='1193'>
        dhb = 0.<a name='1194'>
        qp = qsp<a name='1195'>
      END IF<a name='1196'>
    END DO loop_lift1<a name='1197'>
<font color=#447700>!<a name='1198'></font>
    condb(kts:kte) = 0.0<a name='1199'>
    rhoeb(ki) = rhoeb(ki) + alpha*dzq(ki)*mpb<a name='1200'>
    dzqb(ki) = dzqb(ki) + alpha*rhoe(ki)*mpb<a name='1201'>
    mpb = 0.<a name='1202'>
    qv0b(ki) = qv0b(ki) + qpb<a name='1203'>
    qpb = 0.<a name='1204'>
    hb(ki) = hb(ki) + hpb<a name='1205'>
    hpb  = 0.<a name='1206'>
  END DO loop_origin<a name='1207'>
<a name='1208'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!<a name='1209'></font>
  pprateb = 0.<a name='1210'>
  DO k=kte,kts,-1<a name='1211'>
    dqvdtb(k) = 0.0<a name='1212'>
    dthdtb(k) = 0.0<a name='1213'>
    temp1 = cp*rv*t0(k)**2<a name='1214'>
    temp1b = xlv**2*xb(k)/temp1<a name='1215'>
    qsb(k) = qsb(k) + xlv*hsb(k) + temp1b<a name='1216'>
    temp1b0 = ep2*qsb(k)/(p0(k)-ess(k))<a name='1217'>
    temp1b1 = -(ess(k)*temp1b0/(p0(k)-ess(k)))<a name='1218'>
    esb = temp1b0 - temp1b1<a name='1219'>
    temp0 = t0(k) - svp3<a name='1220'>
    temp = (t0(k)-svpt0)/temp0<a name='1221'>
    tempb = svp1*1000.*EXP(svp2*temp)*svp2*esb/temp0<a name='1222'>
    t0b(k) = t0b(k) + cp*hb(k) + (1.0-temp)*tempb + cp*hsb(k) - qs(k)*cp&amp;<a name='1223'>
&amp;      *rv*2*t0(k)*temp1b/temp1<a name='1224'>
    xb(k) = 0.0<a name='1225'>
    zb0(k) = zb0(k) + g*hb(k) + g*hsb(k)<a name='1226'>
    hsb(k) = 0.0<a name='1227'>
    p0b(k) = p0b(k) + temp1b1<a name='1228'>
    qsb(k) = 0.0<a name='1229'>
    qv0b(k) = qv0b(k) + xlv*hb(k)<a name='1230'>
    hb(k) = 0.0<a name='1231'>
  END DO<a name='1232'>
END SUBROUTINE DUCU1D_B<a name='1233'>
<a name='1234'>
<font color=#447700>!  Differentiation of ducu in reverse (adjoint) mode:<a name='1235'></font>
<font color=#447700>!   gradient, with respect to input variables: th raincv t rthcuten<a name='1236'></font>
<font color=#447700>!                pcps qv z rqvcuten rho dz8w<a name='1237'></font>
<font color=#447700>!   of linear combination of output variables: raincv rthcuten<a name='1238'></font>
<font color=#447700>!                rqvcuten<a name='1239'></font>
<font color=#447700>! optionals<a name='1240'></font>
<A NAME='DUCU_B'><A href='../../html_code/phys/module_cu_du.F.html#DUCU_B' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1241'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>DUCU_B</font>(ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms&amp; <A href='../../call_to/DUCU_B.html' TARGET='index'>2</A>,<A href='../../call_from/DUCU_B.html' TARGET='index'>2</A><a name='1242'>
&amp;  , kme, its, ite, jts, jte, kts, kte, dt, ktau, dx, rho, rhob, raincv&amp;<a name='1243'>
&amp;  , raincvb, nca, u, v, th, thb, t, tb, w, dz8w, dz8wb, z, zb, pcps, &amp;<a name='1244'>
&amp;  pcpsb, pi, w0avg, xlv, cp, rd, rv, g, ep2, svp1, svp2, svp3, svpt0, &amp;<a name='1245'>
&amp;  stepcu, cu_act_flag, warm_rain, cutop, cubot, qv, qvb, rthcuten, &amp;<a name='1246'>
&amp;  rthcutenb, rqvcuten, rqvcutenb)<a name='1247'>
  IMPLICIT NONE<a name='1248'>
<font color=#447700>!<a name='1249'></font>
  INTEGER, INTENT(IN) :: ime, ims, jme, jms, kme, kms<a name='1250'>
  LOGICAL :: cu_act_flag(ims:ime, jms:jme)<a name='1251'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN) :: dz8w, pcps, &amp;<a name='1252'>
&amp;  pi, qv, rho, t, th, u, v, w, z<a name='1253'>
  INTEGER, INTENT(IN) :: ide, ids, ite, its, jde, jds, jte, jts, kde, &amp;<a name='1254'>
&amp;  kds, ktau, kte, kts, stepcu<a name='1255'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), OPTIONAL :: rqvcuten, &amp;<a name='1256'>
&amp;  rqvcutenb, rthcuten, rthcutenb<a name='1257'>
  REAL :: cubot(ims:ime, jms:jme), cutop(ims:ime, jms:jme), dz8wb(ims:&amp;<a name='1258'>
&amp;  ime, kms:kme, jms:jme), nca(ims:ime, jms:jme), pcpsb(ims:ime, kms:kme&amp;<a name='1259'>
&amp;  , jms:jme), qvb(ims:ime, kms:kme, jms:jme), raincv(ims:ime, jms:jme)&amp;<a name='1260'>
&amp;  , raincvb(ims:ime, jms:jme), rhob(ims:ime, kms:kme, jms:jme), tb(ims:&amp;<a name='1261'>
&amp;  ime, kms:kme, jms:jme), thb(ims:ime, kms:kme, jms:jme), w0avg(ims:ime&amp;<a name='1262'>
&amp;  , kms:kme, jms:jme), zb(ims:ime, kms:kme, jms:jme)<a name='1263'>
  LOGICAL, INTENT(IN) :: warm_rain<a name='1264'>
  REAL, INTENT(IN) :: cp, dt, dx, ep2, g, rd, rv, svp1, svp2, svp3, &amp;<a name='1265'>
&amp;  svpt0, xlv<a name='1266'>
  REAL :: dqvdt(kts:kte), dqvdtb(kts:kte), dthdt(kts:kte), dthdtb(kts:&amp;<a name='1267'>
&amp;  kte), dxsq, dz1d(kts:kte), dz1db(kts:kte), p1d(kts:kte), p1db(kts:kte&amp;<a name='1268'>
&amp;  ), pprate, pprateb, prs, qv1d(kts:kte), qv1db(kts:kte), rho1d(kts:kte&amp;<a name='1269'>
&amp;  ), rho1db(kts:kte), rhoe, rthcumax, scr1, t1d(kts:kte), t1db(kts:kte)&amp;<a name='1270'>
&amp;  , th1d(kts:kte), th1db(kts:kte), tmp, tst, tv, u1d(kts:kte), v1d(kts:&amp;<a name='1271'>
&amp;  kte), w0, w0avg1d(kts:kte), z1d(kts:kte), z1db(kts:kte)<a name='1272'>
  LOGICAL :: flag_qi, flag_qr, flag_qs, result1, result2<a name='1273'>
  INTEGER :: branch, i, i_end, i_start, icldck, j, j_end, j_start, k, &amp;<a name='1274'>
&amp;  ntst, sz<a name='1275'>
  INTRINSIC MOD, MAX, PRESENT, MIN<a name='1276'>
<font color=#447700>! EXTERNAL PRESENT_B<a name='1277'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1278'></font>
<font color=#447700>!<a name='1279'></font>
<font color=#447700>!<a name='1280'></font>
<font color=#447700>!<a name='1281'></font>
<font color=#447700>! Optional arguments<a name='1282'></font>
<font color=#447700>!<a name='1283'></font>
<font color=#447700>!<a name='1284'></font>
<font color=#447700>! LOCAL VARS<a name='1285'></font>
<font color=#447700>!<a name='1286'></font>
<font color=#447700>! Initialize local variables<a name='1287'></font>
<font color=#447700>!<a name='1288'></font>
    qv1db(kts:kte) = 0.0<a name='1289'>
    dthdtb(kts:kte) = 0.0<a name='1290'>
    th1db(kts:kte) = 0.0<a name='1291'>
    rho1db(kts:kte) = 0.0<a name='1292'>
    p1db(kts:kte) = 0.0<a name='1293'>
    z1db(kts:kte) = 0.0<a name='1294'>
    dz1db(kts:kte) = 0.0<a name='1295'>
    t1db(kts:kte) = 0.0<a name='1296'>
    dqvdtb(kts:kte) = 0.0<a name='1297'>
    pprateb = 0.    <font color=#447700>!tested, this line no use, can be removed<a name='1298'></font>
<font color=#447700>!<a name='1299'></font>
  ntst = stepcu<a name='1300'>
  icldck = MOD(ktau, ntst)<a name='1301'>
  IF (icldck .EQ. 0 .OR. ktau .EQ. 1) THEN<a name='1302'>
<font color=#447700>!<a name='1303'></font>
<font color=#447700>!  Keep away from specified and relaxation zone (should be for just specified and nested bc)<a name='1304'></font>
    sz = 1<a name='1305'>
    IF (ids + sz .LT. its) THEN<a name='1306'>
      i_start = its<a name='1307'>
    ELSE<a name='1308'>
      i_start = ids + sz<a name='1309'>
    END IF<a name='1310'>
    IF (ide - 1 - sz .GT. ite) THEN<a name='1311'>
      i_end = ite<a name='1312'>
    ELSE<a name='1313'>
      i_end = ide - 1 - sz<a name='1314'>
    END IF<a name='1315'>
    IF (jds + sz .LT. jts) THEN<a name='1316'>
      j_start = jts<a name='1317'>
    ELSE<a name='1318'>
      j_start = jds + sz<a name='1319'>
    END IF<a name='1320'>
    IF (jde - 1 - sz .GT. jte) THEN<a name='1321'>
      j_end = jte<a name='1322'>
    ELSE<a name='1323'>
      j_end = jde - 1 - sz<a name='1324'>
    END IF<a name='1325'>
<font color=#447700>!<a name='1326'></font>
<font color=#447700>! Calculate basic state variables<a name='1327'></font>
<font color=#447700>!<a name='1328'></font>
    DO j=j_start,j_end<a name='1329'>
      DO i=i_start,i_end<a name='1330'>
        DO k=kts,kte<a name='1331'>
          dqvdt(k) = 0.<a name='1332'>
          dthdt(k) = 0.<a name='1333'>
        END DO<a name='1334'>
<font color=#447700>!<a name='1335'></font>
<font color=#447700>! assign vars from 3D to 1D<a name='1336'></font>
        DO k=kts,kte<a name='1337'>
          t1d(k) = t(i, k, j)<a name='1338'>
          th1d(k) = th(i, k, j)<a name='1339'>
          rho1d(k) = rho(i, k, j)<a name='1340'>
          qv1d(k) = qv(i, k, j)<a name='1341'>
          p1d(k) = pcps(i, k, j)<a name='1342'>
          dz1d(k) = dz8w(i, k, j)<a name='1343'>
          z1d(k) = z(i, k, j)<a name='1344'>
        END DO<a name='1345'>
        CALL <A href='../../html_code/phys/module_cu_du.F.html#DUCU1D'>DUCU1D</A><A href='../../html_code/phys/module_cu_du.F.html#DUCU_B' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DUCU1D_2">(i, j, u1d, v1d, t1d, qv1d, p1d, dz1d, z1d, w0avg1d, &amp;<a name='1346'>
&amp;              dt, dx, dxsq, rho1d, th1d, xlv, cp, rd, rv, g, ep2, svp1&amp;<a name='1347'>
&amp;              , svp2, svp3, svpt0, dqvdt, dthdt, pprate, nca, ntst, &amp;<a name='1348'>
&amp;              cutop, cubot, ids, ide, jds, jde, kds, kde, ims, ime, jms&amp;<a name='1349'>
&amp;              , jme, kms, kme, its, ite, jts, jte, kts, kte)<a name='1350'>
        result1 = PRESENT(rthcuten)<a name='1351'>
        result2 = PRESENT(rqvcuten)<a name='1352'>
        IF (result1 .AND. result2) THEN<a name='1353'>
          DO k=kts,kte<a name='1354'>
            rthcuten(i, k, j) = dthdt(k)<a name='1355'>
            rqvcuten(i, k, j) = dqvdt(k)<a name='1356'>
          END DO<a name='1357'>
        ELSE<a name='1358'>
        END IF<a name='1359'>
<font color=#447700>!<a name='1360'></font>
<font color=#447700>! Start adjoint<a name='1361'></font>
<font color=#447700>!<a name='1362'></font>
        IF (result1 .AND. result2) THEN<a name='1363'>
          pprateb = dt*raincvb(i, j)<a name='1364'>
          raincvb(i, j) = 0.0<a name='1365'>
          DO k=kte,kts,-1<a name='1366'>
            dqvdtb(k) = dqvdtb(k) + rqvcutenb(i, k, j)<a name='1367'>
            rqvcutenb(i, k, j) = 0.0<a name='1368'>
            dthdtb(k) = dthdtb(k) + rthcutenb(i, k, j)<a name='1369'>
            rthcutenb(i, k, j) = 0.0<a name='1370'>
          END DO<a name='1371'>
        ELSE<a name='1372'>
          pprateb = 0.0<a name='1373'>
        END IF<a name='1374'>
        CALL <A href='../../html_code/phys/module_cu_du.F.html#DUCU1D_B'>DUCU1D_B</A><A href='../../html_code/phys/module_cu_du.F.html#DUCU_B' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DUCU1D_B_1">(i, j, u1d, v1d, t1d, t1db, qv1d, qv1db, p1d, p1db&amp;<a name='1375'>
&amp;                , dz1d, dz1db, z1d, z1db, w0avg1d, dt, dx, dxsq, rho1d&amp;<a name='1376'>
&amp;                , rho1db, th1d, th1db, xlv, cp, rd, rv, g, ep2, svp1, &amp;<a name='1377'>
&amp;                svp2, svp3, svpt0, dqvdt, dqvdtb, dthdt, dthdtb, pprate&amp;<a name='1378'>
&amp;                , pprateb, nca, ntst, cutop, cubot, ids, ide, jds, jde&amp;<a name='1379'>
&amp;                , kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts&amp;<a name='1380'>
&amp;                , jte, kts, kte)<a name='1381'>
        DO k=kte,kts,-1<a name='1382'>
          zb(i, k, j) = zb(i, k, j) + z1db(k)<a name='1383'>
          z1db(k) = 0.0<a name='1384'>
          dz8wb(i, k, j) = dz8wb(i, k, j) + dz1db(k)<a name='1385'>
          dz1db(k) = 0.0<a name='1386'>
          pcpsb(i, k, j) = pcpsb(i, k, j) + p1db(k)<a name='1387'>
          p1db(k) = 0.0<a name='1388'>
          qvb(i, k, j) = qvb(i, k, j) + qv1db(k)<a name='1389'>
          qv1db(k) = 0.0<a name='1390'>
          rhob(i, k, j) = rhob(i, k, j) + rho1db(k)<a name='1391'>
          rho1db(k) = 0.0<a name='1392'>
          thb(i, k, j) = thb(i, k, j) + th1db(k)<a name='1393'>
          th1db(k) = 0.0<a name='1394'>
          tb(i, k, j) = tb(i, k, j) + t1db(k)<a name='1395'>
          t1db(k) = 0.0<a name='1396'>
        END DO<a name='1397'>
        raincvb(i, j) = 0.0<a name='1398'>
        DO k=kte,kts,-1<a name='1399'>
          dthdtb(k) = 0.0<a name='1400'>
          dqvdtb(k) = 0.0<a name='1401'>
        END DO<a name='1402'>
      END DO<a name='1403'>
    END DO<a name='1404'>
        qv1db(kts:kte) = 0.0<a name='1405'>
        dthdtb(kts:kte) = 0.0<a name='1406'>
        th1db(kts:kte) = 0.0<a name='1407'>
        rho1db(kts:kte) = 0.0<a name='1408'>
        p1db(kts:kte) = 0.0<a name='1409'>
        z1db(kts:kte) = 0.0<a name='1410'>
        dz1db(kts:kte) = 0.0<a name='1411'>
        t1db(kts:kte) = 0.0<a name='1412'>
        dqvdtb(kts:kte) = 0.0<a name='1413'>
        rqvcutenb(ims:ime, kms:kme, jms:jme) = 0.0<a name='1414'>
        rthcutenb(ims:ime, kms:kme, jms:jme) = 0.0<a name='1415'>
        raincvb(ims:ime, jms:jme) = 0.0<a name='1416'>
  ELSE<a name='1417'>
    raincvb(ims:ime, jms:jme) = 0.0<a name='1418'>
    rthcutenb(ims:ime, kms:kme, jms:jme) = 0.0<a name='1419'>
    rqvcutenb(ims:ime, kms:kme, jms:jme) = 0.0<a name='1420'>
  END IF<a name='1421'>
END SUBROUTINE DUCU_B<a name='1422'>
<a name='1423'>
END MODULE module_cu_du<a name='1424'>
<a name='1425'>
</pre></body></html>