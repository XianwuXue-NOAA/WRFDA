<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_SF_MYJSFC'><A href='../../html_code/phys/module_sf_myjsfc.F.html#MODULE_SF_MYJSFC' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
      <font color=#993300>MODULE </font><font color=#cc0000>MODULE_SF_MYJSFC</font> <A href='../../call_to/MODULE_SF_MYJSFC.html' TARGET='index'>2</A><a name='5'>
<font color=#447700>!<a name='6'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='7'></font>
<font color=#447700>!<a name='8'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/phys/module_sf_myjsfc.F.html#module_sf_myjsfc.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_42"><a name='9'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>MODULE_DM</A><A href='../../html_code/phys/module_sf_myjsfc.F.html#module_sf_myjsfc.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_30"><a name='10'>
<font color=#447700>!<a name='11'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='12'></font>
<font color=#447700>!<a name='13'></font>
<font color=#447700>! REFERENCES:  Janjic (2001), NCEP Office Note 437<a name='14'></font>
<font color=#447700>!              Mellor and Yamada (1982), Rev. Geophys. Space Phys.<a name='15'></font>
<font color=#447700>!              Mellor and Yamada (1974), J. Atmos. Sci.<a name='16'></font>
<font color=#447700>!<a name='17'></font>
<font color=#447700>! ABSTRACT:<a name='18'></font>
<font color=#447700>!     MYJSFC GENERATES THE SURFACE EXCHANGE COEFFICIENTS FOR VERTICAL<a name='19'></font>
<font color=#447700>!     TURBULENT EXCHANGE BASED UPON MONIN_OBUKHOV THEORY WITH<a name='20'></font>
<font color=#447700>!     VARIOUS REFINEMENTS.<a name='21'></font>
<font color=#447700>!<a name='22'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='23'></font>
<font color=#447700>!<a name='24'></font>
      INTEGER :: ITRMX=5 <font color=#447700>! Iteration count for sfc layer computations<a name='25'></font>
<font color=#447700>!<a name='26'></font>
      REAL,PARAMETER :: VKARMAN=0.4<a name='27'>
      REAL,PARAMETER :: CAPA=R_D/CP,ELOCP=2.72E6/CP,RCAP=1./CAPA<a name='28'>
      REAL,PARAMETER :: GOCP02=G/CP*2.,GOCP10=G/CP*10.<a name='29'>
      REAL,PARAMETER :: EPSL=0.10,EPSRU=1.E-7,EPSRS=1.E-7 <a name='30'>
      REAL,PARAMETER :: EPSU2=1.E-4,EPSUST=0.07,EPSZT=1.E-5<a name='31'>
      REAL,PARAMETER :: A1=0.659888514560862645                        &amp;<a name='32'>
     &amp;                 ,A2x=0.6574209922667784586                      &amp;<a name='33'>
     &amp;                 ,B1=11.87799326209552761                        &amp;<a name='34'>
     &amp;                 ,B2=7.226971804046074028                        &amp;<a name='35'>
     &amp;                 ,C1=0.000830955950095854396<a name='36'>
      REAL,PARAMETER :: A2S=17.2693882,A3S=273.16,A4S=35.86<a name='37'>
      REAL,PARAMETER :: SEAFC=0.98,PQ0SEA=PQ0*SEAFC<a name='38'>
      REAL,PARAMETER :: BETA=1./273.,CZIL=0.2,EXCML=0.001,EXCMS=0.001  &amp;<a name='39'>
     &amp;                 ,GLKBR=10.,GLKBS=30.,PI=3.1415926               &amp;<a name='40'>
     &amp;                 ,QVISC=2.1E-5,RIC=0.505,SMALL=0.35              &amp;<a name='41'>
     &amp;                 ,SQPR=0.84,SQSC=0.84,SQVISC=258.2,TVISC=2.1E-5  &amp;<a name='42'>
     &amp;                 ,USTC=0.7,USTR=0.225,VISC=1.5E-5                &amp;<a name='43'>
     &amp;                 ,WWST=1.2,ZTFC=1.<a name='44'>
<font color=#447700>!<a name='45'></font>
      REAL,PARAMETER :: BTG=BETA*G,CZIV=SMALL*GLKBS                    &amp;<a name='46'>
<font color=#447700>!    &amp;                 ,EP_1=R_V/R_D-1.,GRRS=GLKBR/GLKBS               &amp;<a name='47'></font>
     &amp;                 ,GRRS=GLKBR/GLKBS               &amp;<a name='48'>
     &amp;                 ,RB1=1./B1,RTVISC=1./TVISC,RVISC=1./VISC        &amp;<a name='49'>
     &amp;                 ,ZQRZT=SQSC/SQPR<a name='50'>
<font color=#447700>!<a name='51'></font>
      REAL,PARAMETER :: ADNH= 9.*A1*A2x*A2x*(12.*A1+3.*B2)*BTG*BTG     &amp;                  <a name='52'>
     &amp;                 ,ADNM=18.*A1*A1*A2x*(B2-3.*A2x)*BTG             &amp; <a name='53'>
     &amp;                 ,ANMH=-9.*A1*A2x*A2x*BTG*BTG                    &amp;<a name='54'>
     &amp;                 ,ANMM=-3.*A1*A2x*(3.*A2x+3.*B2*C1+18.*A1*C1-B2) &amp;<a name='55'>
     &amp;                                *BTG                             &amp;   <a name='56'>
     &amp;                 ,BDNH= 3.*A2x*(7.*A1+B2)*BTG                    &amp;<a name='57'>
     &amp;                 ,BDNM= 6.*A1*A1                                 &amp;<a name='58'>
     &amp;                 ,BEQH= A2x*B1*BTG+3.*A2x*(7.*A1+B2)*BTG         &amp;<a name='59'>
     &amp;                 ,BEQM=-A1*B1*(1.-3.*C1)+6.*A1*A1                &amp;<a name='60'>
     &amp;                 ,BNMH=-A2x*BTG                                  &amp;     <a name='61'>
     &amp;                 ,BNMM=A1*(1.-3.*C1)                             &amp;<a name='62'>
     &amp;                 ,BSHH=9.*A1*A2x*A2x*BTG                         &amp;<a name='63'>
     &amp;                 ,BSHM=18.*A1*A1*A2x*C1                          &amp;<a name='64'>
     &amp;                 ,BSMH=-3.*A1*A2x*(3.*A2x+3.*B2*C1+12.*A1*C1-B2) &amp;<a name='65'>
     &amp;                                *BTG                             &amp;<a name='66'>
     &amp;                 ,CESH=A2x                                       &amp;<a name='67'>
     &amp;                 ,CESM=A1*(1.-3.*C1)                             &amp;<a name='68'>
     &amp;                 ,CNV=EP_1*G/BTG                                 &amp;<a name='69'>
     &amp;                 ,ELFCS=VKARMAN*BTG                              &amp;<a name='70'>
     &amp;                 ,FZQ1=RTVISC*QVISC*ZQRZT                        &amp;<a name='71'>
     &amp;                 ,FZQ2=RTVISC*QVISC*ZQRZT                        &amp;<a name='72'>
     &amp;                 ,FZT1=RVISC *TVISC*SQPR                         &amp;<a name='73'>
     &amp;                 ,FZT2=CZIV*GRRS*TVISC*SQPR                      &amp;<a name='74'>
     &amp;                 ,FZU1=CZIV*VISC                                 &amp;<a name='75'>
     &amp;                 ,PIHF=0.5*PI                                    &amp;<a name='76'>
     &amp;                 ,RQVISC=1./QVISC                                &amp;<a name='77'>
     &amp;                 ,RRIC=1./RIC                                    &amp;<a name='78'>
     &amp;                 ,USTFC=0.018/G                                  &amp;<a name='79'>
     &amp;                 ,WWST2=WWST*WWST                                &amp;<a name='80'>
     &amp;                 ,ZILFC=-CZIL*VKARMAN*SQVISC<a name='81'>
<font color=#447700>!<a name='82'></font>
<font color=#447700>!<a name='83'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='84'></font>
<font color=#447700>!***  FREE TERM IN THE EQUILIBRIUM EQUATION FOR (L/Q)**2<a name='85'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='86'></font>
<font color=#447700>!<a name='87'></font>
      REAL,PARAMETER :: AEQH=9.*A1*A2x*A2x*B1*BTG*BTG                  &amp;<a name='88'>
     &amp;                      +9.*A1*A2x*A2x*(12.*A1+3.*B2)*BTG*BTG      &amp;<a name='89'>
     &amp;                 ,AEQM=3.*A1*A2x*B1*(3.*A2x+3.*B2*C1+18.*A1*C1-B2) &amp;<a name='90'>
     &amp;                      *BTG+18.*A1*A1*A2x*(B2-3.*A2x)*BTG<a name='91'>
<font color=#447700>!<a name='92'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='93'></font>
<font color=#447700>!***  FORBIDDEN TURBULENCE AREA<a name='94'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='95'></font>
<font color=#447700>!<a name='96'></font>
      REAL,PARAMETER :: REQU=-AEQH/AEQM                                &amp;<a name='97'>
     &amp;                 ,EPSGH=1.E-9,EPSGM=REQU*EPSGH<a name='98'>
<font color=#447700>!----------------------------------------------------------------------<a name='99'></font>
<font color=#447700>!***  NEAR ISOTROPY FOR SHEAR TURBULENCE, WW/Q2 LOWER LIMIT<a name='100'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='101'></font>
<font color=#447700>!<a name='102'></font>
      REAL,PARAMETER :: UBRYL=(18.*REQU*A1*A1*A2x*B2*C1*BTG            &amp;<a name='103'>
     &amp;                         +9.*A1*A2x*A2x*B2*BTG*BTG)              &amp;<a name='104'>
     &amp;                        /(REQU*ADNM+ADNH)                        &amp;<a name='105'>
     &amp;                 ,UBRY=(1.+EPSRS)*UBRYL,UBRY3=3.*UBRY<a name='106'>
<font color=#447700>!<a name='107'></font>
      REAL,PARAMETER :: AUBH=27.*A1*A2x*A2x*B2*BTG*BTG-ADNH*UBRY3      &amp;<a name='108'>
     &amp;                 ,AUBM=54.*A1*A1*A2x*B2*C1*BTG -ADNM*UBRY3       &amp;<a name='109'>
     &amp;                 ,BUBH=(9.*A1*A2x+3.*A2x*B2)*BTG-BDNH*UBRY3      &amp;<a name='110'>
     &amp;                 ,BUBM=18.*A1*A1*C1           -BDNM*UBRY3        &amp;<a name='111'>
     &amp;                 ,CUBR=1.                     -     UBRY3        &amp;<a name='112'>
     &amp;                 ,RCUBR=1./CUBR<a name='113'>
<font color=#447700>!----------------------------------------------------------------------<a name='114'></font>
      INTEGER, PARAMETER :: KZTM=10001,KZTM2=KZTM-2<a name='115'>
<font color=#447700>!<a name='116'></font>
      REAL :: DZETA1,DZETA2,FH01,FH02,ZTMAX1,ZTMAX2,ZTMIN1,ZTMIN2<a name='117'>
<font color=#447700>!<a name='118'></font>
      REAL,DIMENSION(KZTM) :: PSIH1,PSIH2,PSIM1,PSIM2<a name='119'>
      integer :: isee=01,jsee=015<a name='120'>
<font color=#447700>!<a name='121'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='122'></font>
<font color=#447700>!<a name='123'></font>
CONTAINS<a name='124'>
<font color=#447700>!<a name='125'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='126'></font>
<A NAME='MYJSFC'><A href='../../html_code/phys/module_sf_myjsfc.F.html#MYJSFC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='127'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MYJSFC</font>(ITIMESTEP,HT,DZ                                &amp;  <A href='../../call_to/MYJSFC.html' TARGET='index'>1</A>,<A href='../../call_from/MYJSFC.html' TARGET='index'>1</A><a name='128'>
     &amp;                 ,PMID,PINT,TH,T,QV,QC,U,V,Q2                    &amp;<a name='129'>
     &amp;                 ,TSK,QSFC,THZ0,QZ0,UZ0,VZ0                      &amp;<a name='130'>
     &amp;                 ,LOWLYR,XLAND                                   &amp;<a name='131'>
     &amp;                 ,USTAR,ZNT,PBLH,MAVAIL,RMOL                     &amp;<a name='132'>
     &amp;                 ,AKHS,AKMS                                      &amp;<a name='133'>
     &amp;                 ,CHS,CHS2,CQS2,HFX,QFX,FLX_LH,FLHC,FLQC         &amp;<a name='134'>
     &amp;                 ,QGH,CPM,CT                                     &amp;<a name='135'>
     &amp;                 ,U10,V10,TSHLTR,TH10,QSHLTR,Q10,PSHLTR          &amp;<a name='136'>
     &amp;                 ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='137'>
     &amp;                 ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='138'>
     &amp;                 ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='139'>
<font color=#447700>!----------------------------------------------------------------------<a name='140'></font>
<font color=#447700>!<a name='141'></font>
      IMPLICIT NONE<a name='142'>
<font color=#447700>!<a name='143'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='144'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='145'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='146'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='147'>
<font color=#447700>!<a name='148'></font>
      INTEGER,INTENT(IN) :: ITIMESTEP<a name='149'>
<font color=#447700>!<a name='150'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: LOWLYR<a name='151'>
<font color=#447700>!<a name='152'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: HT,XLAND,TSK,MAVAIL<a name='153'>
<font color=#447700>!<a name='154'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: DZ         &amp;<a name='155'>
     &amp;                                                     ,PMID,PINT  &amp;<a name='156'>
     &amp;                                                     ,Q2,QC,QV   &amp;<a name='157'>
     &amp;                                                     ,T,TH       &amp;<a name='158'>
     &amp;                                                     ,U,V   <a name='159'>
<font color=#447700>!<a name='160'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: FLX_LH,HFX,PSHLTR &amp;<a name='161'>
     &amp;                                              ,QFX,Q10,QSHLTR    &amp;<a name='162'>
     &amp;                                              ,TH10,TSHLTR       &amp;<a name='163'>
     &amp;                                              ,U10,V10<a name='164'>
<font color=#447700>!<a name='165'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: AKHS,AKMS       &amp;<a name='166'>
     &amp;                                                ,PBLH,QSFC<a name='167'>
<font color=#447700>!<a name='168'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: QZ0,RMOL,THZ0   &amp;<a name='169'>
     &amp;                                                ,USTAR,UZ0,VZ0   &amp;<a name='170'>
     &amp;                                                ,ZNT<a name='171'>
<font color=#447700>!<a name='172'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: CHS,CHS2,CQS2     &amp;<a name='173'>
     &amp;                                              ,CPM,CT,FLHC,FLQC  &amp;<a name='174'>
     &amp;                                              ,QGH <a name='175'>
<font color=#447700>!----------------------------------------------------------------------<a name='176'></font>
<font color=#447700>!***<a name='177'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='178'></font>
<font color=#447700>!***<a name='179'></font>
      INTEGER :: I,J,K,KFLIP,LMH,LPBL,NTSD<a name='180'>
<font color=#447700>!<a name='181'></font>
      REAL :: A,ADEN,APESFC,AUBR,B,BDEN,BTGX,BUBR,CWMLOW               &amp;<a name='182'>
     &amp;       ,DQDT,DTDIF,DTDT,DUDT,DVDT                                &amp;<a name='183'>
     &amp;       ,ELOQ2X,FIS,GHK,GMK                                       &amp;<a name='184'>
     &amp;       ,P02P,P10P,PLOW,PSFC,PTOP,QLOW,QOL2ST,QOL2UN,QS02,QS10    &amp;<a name='185'>
     &amp;       ,RAPA,RAPA02,RAPA10,RATIOMX,RDZ,SEAMASK,SM                &amp;<a name='186'>
     &amp;       ,T02P,T10P,TEM,TH02P,TH10P,THLOW,THELOW,THM               &amp;<a name='187'>
     &amp;       ,TLOW,TZ0,ULOW,VLOW,ZSL<a name='188'>
<font color=#447700>!<a name='189'></font>
      REAL,DIMENSION(KTS:KTE) :: CWMK,PK,Q2K,QK,THEK,THK,TK,UK,VK<a name='190'>
<font color=#447700>!<a name='191'></font>
      REAL,DIMENSION(KTS:KTE-1) :: AKHK,AKMK,EL,ELM,GH,GM<a name='192'>
<font color=#447700>!<a name='193'></font>
      REAL,DIMENSION(KTS:KTE+1) :: ZHK<a name='194'>
<font color=#447700>!<a name='195'></font>
      REAL,DIMENSION(ITS:ITE,JTS:JTE) :: THSK<a name='196'>
<font color=#447700>!<a name='197'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE+1,JTS:JTE) :: ZINT<a name='198'>
<font color=#447700>!<a name='199'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='200'></font>
<font color=#447700>!**********************************************************************<a name='201'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='202'></font>
<font color=#447700>!<a name='203'></font>
<font color=#447700>!***  MAKE PREPARATIONS<a name='204'></font>
<font color=#447700>!<a name='205'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='206'></font>
      DO J=JTS,JTE<a name='207'>
      DO K=KTS,KTE+1<a name='208'>
      DO I=ITS,ITE<a name='209'>
        ZINT(I,K,J)=0.<a name='210'>
      ENDDO<a name='211'>
      ENDDO<a name='212'>
      ENDDO<a name='213'>
<font color=#447700>!<a name='214'></font>
      DO J=JTS,JTE<a name='215'>
      DO I=ITS,ITE<a name='216'>
        ZINT(I,KTE+1,J)=HT(I,J)     <font color=#447700>! Z at bottom of lowest sigma layer<a name='217'></font>
        PBLH(I,J)=-1.<a name='218'>
<font color=#447700>!<a name='219'></font>
<font color=#447700>!!!!!!!!!<a name='220'></font>
<font color=#447700>!!!!!! UNCOMMENT THESE LINES IF USING ETA COORDINATES<a name='221'></font>
<font color=#447700>!!!!!!!!!<a name='222'></font>
<font color=#447700>!!!!!!  ZINT(I,KTE+1,J)=1.E-4       ! Z of bottom of lowest eta layer<a name='223'></font>
<font color=#447700>!!!!!!  ZHK(KTE+1)=1.E-4            ! Z of bottom of lowest eta layer<a name='224'></font>
<font color=#447700>!<a name='225'></font>
      ENDDO<a name='226'>
      ENDDO<a name='227'>
<font color=#447700>!<a name='228'></font>
      DO J=JTS,JTE<a name='229'>
      DO K=KTE,KTS,-1<a name='230'>
        KFLIP=KTE+1-K<a name='231'>
        DO I=ITS,ITE<a name='232'>
          ZINT(I,K,J)=ZINT(I,K+1,J)+DZ(I,KFLIP,J)<a name='233'>
        ENDDO<a name='234'>
      ENDDO<a name='235'>
      ENDDO<a name='236'>
<font color=#447700>!<a name='237'></font>
      NTSD=ITIMESTEP<a name='238'>
<font color=#447700>!<a name='239'></font>
      IF(NTSD==1)THEN<a name='240'>
        DO J=JTS,JTE<a name='241'>
        DO I=ITS,ITE<a name='242'>
          USTAR(I,J)=0.1<a name='243'>
          FIS=HT(I,J)*G<a name='244'>
          SM=XLAND(I,J)-1.<a name='245'>
<font color=#447700>!!!       Z0(I,J)=SM*Z0SEA+(1.-SM)*(Z0(I,J)*Z0MAX+FIS*FCM+Z0LAND)<a name='246'></font>
<font color=#447700>!!!       ZNT(I,J)=SM*Z0SEA+(1.-SM)*(ZNT(I,J)*Z0MAX+FIS*FCM+Z0LAND)<a name='247'></font>
        ENDDO<a name='248'>
        ENDDO<a name='249'>
      ENDIF<a name='250'>
<font color=#447700>!<a name='251'></font>
<font color=#447700>!!!!  IF(NTSD==1)THEN<a name='252'></font>
        DO J=JTS,JTE<a name='253'>
        DO I=ITS,ITE<a name='254'>
          CT(I,J)=0.<a name='255'>
        ENDDO<a name='256'>
        ENDDO<a name='257'>
<font color=#447700>!!!!  ENDIF<a name='258'></font>
<font color=#447700>!<a name='259'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='260'></font>
        setup_integration:  DO J=JTS,JTE<a name='261'>
<font color=#447700>!----------------------------------------------------------------------<a name='262'></font>
<font color=#447700>!<a name='263'></font>
        DO I=ITS,ITE<a name='264'>
<font color=#447700>!<a name='265'></font>
<font color=#447700>!***  LOWEST LAYER ABOVE GROUND MUST BE FLIPPED<a name='266'></font>
<font color=#447700>!<a name='267'></font>
          LMH=KTE-LOWLYR(I,J)+1<a name='268'>
<font color=#447700>!<a name='269'></font>
          PTOP=PINT(I,KTE+1,J)      <font color=#447700>! KTE+1=KME<a name='270'></font>
          PSFC=PINT(I,LOWLYR(I,J),J)<a name='271'>
<font color=#447700>! Define THSK here (for first timestep mostly)<a name='272'></font>
          THSK(I,J)=TSK(I,J)/(PSFC*1.E-5)**CAPA<a name='273'>
<font color=#447700>!<a name='274'></font>
<font color=#447700>!***  CONVERT LAND MASK (1 FOR SEA; 0 FOR LAND)<a name='275'></font>
<font color=#447700>!<a name='276'></font>
          SEAMASK=XLAND(I,J)-1.<a name='277'>
<font color=#447700>!<a name='278'></font>
<font color=#447700>!***  FILL 1-D VERTICAL ARRAYS<a name='279'></font>
<font color=#447700>!***  AND FLIP DIRECTION SINCE MYJ SCHEME<a name='280'></font>
<font color=#447700>!***  COUNTS DOWNWARD FROM THE DOMAIN'S TOP<a name='281'></font>
<font color=#447700>!<a name='282'></font>
          DO K=KTE,KTS,-1<a name='283'>
            KFLIP=KTE+1-K<a name='284'>
            THK(K)=TH(I,KFLIP,J)<a name='285'>
            TK(K)=T(I,KFLIP,J)<a name='286'>
            RATIOMX=QV(I,KFLIP,J)<a name='287'>
            QK(K)=RATIOMX/(1.+RATIOMX)<a name='288'>
            PK(K)=PMID(I,KFLIP,J)<a name='289'>
            CWMK(K)=QC(I,KFLIP,J)<a name='290'>
            THEK(K)=(CWMK(K)*(-ELOCP/TK(K))+1.)*THK(K)<a name='291'>
            Q2K(K)=2.*Q2(I,KFLIP,J)<a name='292'>
<font color=#447700>!<a name='293'></font>
<font color=#447700>!<a name='294'></font>
<font color=#447700>!***  COMPUTE THE HEIGHTS OF THE LAYER INTERFACES<a name='295'></font>
<font color=#447700>!<a name='296'></font>
            ZHK(K)=ZINT(I,K,J)<a name='297'>
<font color=#447700>!<a name='298'></font>
          ENDDO<a name='299'>
          ZHK(KTE+1)=HT(I,J)          <font color=#447700>! Z at bottom of lowest sigma layer<a name='300'></font>
<font color=#447700>!<a name='301'></font>
          DO K=KTE,KTS,-1<a name='302'>
            KFLIP=KTE+1-K<a name='303'>
            UK(K)=U(I,KFLIP,J)<a name='304'>
            VK(K)=V(I,KFLIP,J)<a name='305'>
          ENDDO<a name='306'>
<font color=#447700>!<a name='307'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='308'></font>
<font color=#447700>!***  COMPUTE THE HEIGHT OF THE BOUNDARY LAYER<a name='309'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='310'></font>
<font color=#447700>!<a name='311'></font>
          DO K=KTS,LMH-1<a name='312'>
            RDZ=2./(ZHK(K)-ZHK(K+2))<a name='313'>
            GMK=((UK(K)-UK(K+1))**2+(VK(K)-VK(K+1))**2)*RDZ*RDZ<a name='314'>
            GM(K)=MAX(GMK,EPSGM)<a name='315'>
<font color=#447700>!<a name='316'></font>
            TEM=(TK(K)+TK(K+1))*0.5<a name='317'>
            THM=(THEK(K)+THEK(K+1))*0.5<a name='318'>
<font color=#447700>!<a name='319'></font>
            A=THM*P608<a name='320'>
            B=(ELOCP/TEM-1.-P608)*THM<a name='321'>
<font color=#447700>!<a name='322'></font>
            GHK=((THEK(K)-THEK(K+1)+CT(I,J))                           &amp;<a name='323'>
     &amp;          *((QK(K)+QK(K+1))*(0.5*P608)+1.)                       &amp;<a name='324'>
     &amp;          +(QK(K)-QK(K+1))*A                                     &amp;<a name='325'>
     &amp;          +(CWMK(K)-CWMK(K+1))*B)*RDZ<a name='326'>
            IF(ABS(GHK)&lt;=EPSGH)GHK=EPSGH<a name='327'>
<font color=#447700>!<a name='328'></font>
            GH(K)=GHK<a name='329'>
          ENDDO<a name='330'>
<font color=#447700>!<a name='331'></font>
<font color=#447700>!***  FIND MAXIMUM MIXING LENGTHS AND THE LEVEL OF THE PBL TOP<a name='332'></font>
<font color=#447700>!<a name='333'></font>
          LPBL=LMH<a name='334'>
<font color=#447700>!<a name='335'></font>
          DO K=1,LMH-1<a name='336'>
            GMK=GM(K)<a name='337'>
            GHK=GH(K)<a name='338'>
<font color=#447700>!<a name='339'></font>
            IF(GHK&gt;=EPSGH)THEN<a name='340'>
<font color=#447700>!<a name='341'></font>
              IF(GMK/GHK&lt;=REQU)THEN<a name='342'>
                ELM(K)=EPSL<a name='343'>
                LPBL=K<a name='344'>
              ELSE<a name='345'>
                AUBR=(AUBM*GMK+AUBH*GHK)*GHK<a name='346'>
                BUBR= BUBM*GMK+BUBH*GHK<a name='347'>
                QOL2ST=(-0.5*BUBR+SQRT(BUBR*BUBR*0.25-AUBR*CUBR))*RCUBR<a name='348'>
                ELOQ2X=1./QOL2ST<a name='349'>
                ELM(K)=MAX(SQRT(ELOQ2X*Q2K(K)),EPSL)<a name='350'>
              ENDIF<a name='351'>
<font color=#447700>!<a name='352'></font>
            ELSE<a name='353'>
              ADEN=(ADNM*GMK+ADNH*GHK)*GHK<a name='354'>
              BDEN= BDNM*GMK+BDNH*GHK<a name='355'>
              QOL2UN=-0.5*BDEN+SQRT(BDEN*BDEN*0.25-ADEN)<a name='356'>
              ELOQ2X=1./(QOL2UN+EPSRU)  <font color=#447700>!  repsr1/qol2un<a name='357'></font>
              ELM(K)=MAX(SQRT(ELOQ2X*Q2K(K)),EPSL)<a name='358'>
            ENDIF<a name='359'>
<font color=#447700>!<a name='360'></font>
          ENDDO<a name='361'>
<font color=#447700>!<a name='362'></font>
          IF(ELM(LMH-1)==EPSL)LPBL=LMH<a name='363'>
<font color=#447700>!<a name='364'></font>
<font color=#447700>!***  THE HEIGHT OF THE PBL<a name='365'></font>
<font color=#447700>!<a name='366'></font>
          PBLH(I,J)=ZHK(LPBL)-ZHK(LMH+1)<a name='367'>
<font color=#447700>!<a name='368'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='369'></font>
<font color=#447700>!***<a name='370'></font>
<font color=#447700>!***  FIND THE SURFACE EXCHANGE COEFFICIENTS<a name='371'></font>
<font color=#447700>!***<a name='372'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='373'></font>
          PLOW=PK(LMH)<a name='374'>
          TLOW=TK(LMH)<a name='375'>
          THLOW=THK(LMH)<a name='376'>
          THELOW=THEK(LMH)<a name='377'>
          QLOW=QK(LMH)<a name='378'>
          CWMLOW=CWMK(LMH)<a name='379'>
          ULOW=UK(LMH)<a name='380'>
          VLOW=VK(LMH)<a name='381'>
          ZSL=(ZHK(LMH)-ZHK(LMH+1))*0.5<a name='382'>
          APESFC=(PSFC*1.E-5)**CAPA<a name='383'>
          TZ0=THZ0(I,J)*APESFC<a name='384'>
<font color=#447700>!<a name='385'></font>
          CALL <A href='../../html_code/phys/module_sf_myjsfc.F.html#SFCDIF'>SFCDIF</A><A href='../../html_code/phys/module_sf_myjsfc.F.html#MYJSFC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIF_1">(NTSD,SEAMASK,THSK(I,J),QSFC(I,J),PSFC            &amp;<a name='386'>
     &amp;               ,UZ0(I,J),VZ0(I,J),TZ0,THZ0(I,J),QZ0(I,J)         &amp;<a name='387'>
     &amp;               ,USTAR(I,J),ZNT(I,J),CT(I,J),RMOL(I,J)            &amp;<a name='388'>
     &amp;               ,AKMS(I,J),AKHS(I,J),PBLH(I,J),MAVAIL(I,J)        &amp;<a name='389'>
     &amp;               ,CHS(I,J),CHS2(I,J),CQS2(I,J)                     &amp;<a name='390'>
     &amp;               ,HFX(I,J),QFX(I,J),FLX_LH(I,J)                    &amp;<a name='391'>
     &amp;               ,FLHC(I,J),FLQC(I,J),QGH(I,J),CPM(I,J)            &amp;<a name='392'>
     &amp;               ,ULOW,VLOW,TLOW,THLOW,THELOW,QLOW,CWMLOW          &amp;<a name='393'>
     &amp;               ,ZSL,PLOW                                         &amp;<a name='394'>
     &amp;               ,U10(I,J),V10(I,J),TSHLTR(I,J),TH10(I,J)          &amp;<a name='395'>
     &amp;               ,QSHLTR(I,J),Q10(I,J),PSHLTR(I,J)                 &amp;<a name='396'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                          &amp;<a name='397'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='398'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE,i,j)<a name='399'>
<font color=#447700>!<a name='400'></font>
<font color=#447700>!***  REMOVE SUPERATURATION AT 2M AND 10M<a name='401'></font>
<font color=#447700>!<a name='402'></font>
          RAPA=APESFC<a name='403'>
          TH02P=TSHLTR(I,J)<a name='404'>
          TH10P=TH10(I,J)<a name='405'>
<font color=#447700>!<a name='406'></font>
          RAPA02=RAPA-GOCP02/TH02P<a name='407'>
          RAPA10=RAPA-GOCP10/TH10P<a name='408'>
<font color=#447700>!<a name='409'></font>
          T02P=TH02P*RAPA02<a name='410'>
          T10P=TH10P*RAPA10<a name='411'>
<font color=#447700>!<a name='412'></font>
          P02P=(RAPA02**RCAP)*1.E5<a name='413'>
          P10P=(RAPA10**RCAP)*1.E5<a name='414'>
<font color=#447700>!<a name='415'></font>
          QS02=PQ0/P02P*EXP(A2*(T02P-A3)/(T02P-A4))<a name='416'>
          QS10=PQ0/P10P*EXP(A2*(T10P-A3)/(T10P-A4))<a name='417'>
<font color=#447700>!<a name='418'></font>
          IF(QSHLTR(I,J)&gt;QS02)QSHLTR(I,J)=QS02<a name='419'>
          IF(Q10   (I,J)&gt;QS10)Q10   (I,J)=QS10<a name='420'>
<font color=#447700>!----------------------------------------------------------------------<a name='421'></font>
<font color=#447700>!<a name='422'></font>
        ENDDO<a name='423'>
<font color=#447700>!<a name='424'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='425'></font>
      ENDDO setup_integration<a name='426'>
<font color=#447700>!----------------------------------------------------------------------<a name='427'></font>
 <a name='428'>
      END SUBROUTINE MYJSFC<a name='429'>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='430'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='431'></font>
<A NAME='SFCDIF'><A href='../../html_code/phys/module_sf_myjsfc.F.html#SFCDIF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='432'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCDIF</font>(NTSD,SEAMASK,THS,QS,PSFC                       &amp; <A href='../../call_to/SFCDIF.html' TARGET='index'>1</A><a name='433'>
     &amp;                 ,UZ0,VZ0,TZ0,THZ0,QZ0                           &amp;<a name='434'>
     &amp;                 ,USTAR,Z0,CT,RLMO,AKMS,AKHS,PBLH,WETM           &amp;<a name='435'>
     &amp;                 ,CHS,CHS2,CQS2,HFX,QFX,FLX_LH,FLHC,FLQC,QGH,CPM &amp;<a name='436'>
     &amp;                 ,ULOW,VLOW,TLOW,THLOW,THELOW,QLOW,CWMLOW        &amp;<a name='437'>
     &amp;                 ,ZSL,PLOW                                       &amp;<a name='438'>
     &amp;                 ,U10,V10,TH02,TH10,Q02,Q10,PSHLTR               &amp;<a name='439'>
     &amp;                 ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='440'>
     &amp;                 ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='441'>
     &amp;                 ,ITS,ITE,JTS,JTE,KTS,KTE,i,j)<a name='442'>
<font color=#447700>!     ****************************************************************<a name='443'></font>
<font color=#447700>!     *                                                              *<a name='444'></font>
<font color=#447700>!     *                       SURFACE LAYER                          *<a name='445'></font>
<font color=#447700>!     *                                                              *<a name='446'></font>
<font color=#447700>!     ****************************************************************<a name='447'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='448'></font>
<font color=#447700>!<a name='449'></font>
      IMPLICIT NONE<a name='450'>
<font color=#447700>!<a name='451'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='452'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='453'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='454'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE,i,j<a name='455'>
<font color=#447700>!<a name='456'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='457'>
<font color=#447700>!<a name='458'></font>
      REAL,INTENT(IN) :: CWMLOW,PBLH,PLOW,QLOW,PSFC,SEAMASK            &amp;<a name='459'>
     &amp;                  ,THELOW,THLOW,THS,TLOW,TZ0,ULOW,VLOW,WETM,ZSL<a name='460'>
<font color=#447700>!<a name='461'></font>
      REAL,INTENT(OUT) :: CHS,CHS2,CPM,CQS2,CT,FLHC,FLQC,FLX_LH,HFX    &amp;<a name='462'>
     &amp;                   ,PSHLTR,Q02,Q10,QFX,QGH,RLMO,TH02,TH10,U10,V10<a name='463'>
<font color=#447700>!<a name='464'></font>
      REAL,INTENT(INOUT) :: AKHS,AKMS,QZ0,THZ0,USTAR,UZ0,VZ0,Z0,QS<a name='465'>
<font color=#447700>!----------------------------------------------------------------------<a name='466'></font>
<font color=#447700>!***<a name='467'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='468'></font>
<font color=#447700>!***<a name='469'></font>
      INTEGER :: ITR,K<a name='470'>
<font color=#447700>!<a name='471'></font>
      REAL :: A,B,BTGH,BTGX,CXCHL,CXCHS,DTHV,DU2,ELFC,FCT              &amp;<a name='472'>
     &amp;       ,HLFLX,HSFLX,HV,PSH02,PSH10,PSHZ,PSHZL,PSM10,PSMZ,PSMZL   &amp;<a name='473'>
     &amp;       ,RDZ,RDZT,RIB,RLMA,RLMN,RLMP                              &amp;<a name='474'>
     &amp;       ,RLOGT,RLOGU,RWGH,RZ,RZST,RZSU,SIMH,SIMM,TEM,THM          &amp;<a name='475'>
     &amp;       ,UMFLX,USTARK,VMFLX,WGHT,WGHTT,WGHTQ,WSTAR2               &amp;<a name='476'>
     &amp;       ,X,XLT,XLT4,XLU,XLU4,XT,XT4,XU,XU4,ZETALT,ZETALU          &amp;<a name='477'>
     &amp;       ,ZETAT,ZETAU,ZQ,ZSLT,ZSLU,ZT,ZU<a name='478'>
<font color=#447700>!<a name='479'></font>
<font color=#447700>!***  DIAGNOSTICS<a name='480'></font>
<font color=#447700>!<a name='481'></font>
      REAL :: AKHS02,AKHS10,AKMS02,AKMS10,EKMS10,QSAT10,QSAT2          &amp;<a name='482'>
     &amp;       ,RLNT02,RLNT10,RLNU10,SIMH02,SIMH10,SIMM10,T02,T10        &amp;<a name='483'>
     &amp;       ,TERM1,RLOW,U10E,V10E,WSTAR,XLT02,XLT024,XLT10            &amp;<a name='484'>
     &amp;       ,XLT104,XLU10,XLU104,XU10,XU104,ZT02,ZT10,ZTAT02,ZTAT10   &amp;<a name='485'>
     &amp;       ,ZTAU,ZTAU10,ZU10,ZUUZ<a name='486'>
<font color=#447700>!----------------------------------------------------------------------<a name='487'></font>
<font color=#447700>!**********************************************************************<a name='488'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='489'></font>
      RDZ=1./ZSL<a name='490'>
      CXCHL=EXCML*RDZ<a name='491'>
      CXCHS=EXCMS*RDZ<a name='492'>
<font color=#447700>!<a name='493'></font>
      BTGX=G/THLOW<a name='494'>
      ELFC=VKARMAN*BTGX<a name='495'>
<font color=#447700>!<a name='496'></font>
      IF(PBLH&gt;1000.)THEN<a name='497'>
        BTGH=BTGX*PBLH<a name='498'>
      ELSE<a name='499'>
        BTGH=BTGX*1000.<a name='500'>
      ENDIF<a name='501'>
<font color=#447700>!<a name='502'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='503'></font>
<font color=#447700>!<a name='504'></font>
<font color=#447700>!***  SEA POINTS<a name='505'></font>
<font color=#447700>!<a name='506'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='507'></font>
<font color=#447700>!<a name='508'></font>
      IF(SEAMASK&gt;0.)THEN <a name='509'>
<font color=#447700>!<a name='510'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='511'></font>
        DO ITR=1,ITRMX<a name='512'>
<font color=#447700>!----------------------------------------------------------------------<a name='513'></font>
          Z0=MAX(USTFC*USTAR*USTAR,1.59E-5)<a name='514'>
<font color=#447700>!<a name='515'></font>
<font color=#447700>!***  VISCOUS SUBLAYER, JANJIC MWR 1994<a name='516'></font>
<font color=#447700>!<a name='517'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='518'></font>
          IF(USTAR&lt;USTC)THEN<a name='519'>
<font color=#447700>!----------------------------------------------------------------------<a name='520'></font>
<font color=#447700>!<a name='521'></font>
            IF(USTAR&lt;USTR)THEN<a name='522'>
<font color=#447700>!<a name='523'></font>
              IF(NTSD==1)THEN<a name='524'>
                AKMS=CXCHS<a name='525'>
                AKHS=CXCHS<a name='526'>
                QS=QLOW<a name='527'>
              ENDIF<a name='528'>
<font color=#447700>!<a name='529'></font>
              ZU=FZU1*SQRT(SQRT(Z0*USTAR*RVISC))/USTAR<a name='530'>
              WGHT=AKMS*ZU*RVISC<a name='531'>
              RWGH=WGHT/(WGHT+1.)<a name='532'>
              UZ0=(ULOW*RWGH+UZ0)*0.5<a name='533'>
              VZ0=(VLOW*RWGH+VZ0)*0.5<a name='534'>
<font color=#447700>!<a name='535'></font>
              ZT=FZT1*ZU<a name='536'>
              ZQ=FZQ1*ZT<a name='537'>
              WGHTT=AKHS*ZT*RTVISC<a name='538'>
              WGHTQ=AKHS*ZQ*RQVISC<a name='539'>
<font color=#447700>!<a name='540'></font>
              IF(NTSD&gt;1)THEN<a name='541'>
                THZ0=((WGHTT*THLOW+THS)/(WGHTT+1.)+THZ0)*0.5<a name='542'>
                QZ0=((WGHTQ*QLOW+QS)/(WGHTQ+1.)+QZ0)*0.5<a name='543'>
              ELSE<a name='544'>
                THZ0=(WGHTT*THLOW+THS)/(WGHTT+1.)<a name='545'>
                QZ0=(WGHTQ*QLOW+QS)/(WGHTQ+1.)<a name='546'>
              ENDIF<a name='547'>
<font color=#447700>!<a name='548'></font>
            ENDIF<a name='549'>
<font color=#447700>!<a name='550'></font>
            IF(USTAR&gt;=USTR.AND.USTAR&lt;USTC)THEN<a name='551'>
              ZU=Z0<a name='552'>
              UZ0=0.<a name='553'>
              VZ0=0.<a name='554'>
<font color=#447700>!<a name='555'></font>
              ZT=FZT2*SQRT(SQRT(Z0*USTAR*RVISC))/USTAR<a name='556'>
              ZQ=FZQ2*ZT<a name='557'>
              WGHTT=AKHS*ZT*RTVISC<a name='558'>
              WGHTQ=AKHS*ZQ*RQVISC<a name='559'>
<font color=#447700>!<a name='560'></font>
              IF(NTSD&gt;1)THEN<a name='561'>
                THZ0=((WGHTT*THLOW+THS)/(WGHTT+1.)+THZ0)*0.5<a name='562'>
                QZ0=((WGHTQ*QLOW+QS)/(WGHTQ+1.)+QZ0)*0.5<a name='563'>
              ELSE<a name='564'>
                THZ0=(WGHTT*THLOW+THS)/(WGHTT+1.)<a name='565'>
                QZ0=(WGHTQ*QLOW+QS)/(WGHTQ+1.)<a name='566'>
              ENDIF<a name='567'>
<font color=#447700>!<a name='568'></font>
            ENDIF<a name='569'>
<font color=#447700>!----------------------------------------------------------------------<a name='570'></font>
          ELSE<a name='571'>
<font color=#447700>!----------------------------------------------------------------------<a name='572'></font>
            ZU=Z0<a name='573'>
            UZ0=0.<a name='574'>
            VZ0=0.<a name='575'>
<font color=#447700>!<a name='576'></font>
            ZT=Z0<a name='577'>
            THZ0=THS<a name='578'>
<font color=#447700>!<a name='579'></font>
            ZQ=Z0<a name='580'>
            QZ0=QS<a name='581'>
<font color=#447700>!----------------------------------------------------------------------<a name='582'></font>
          ENDIF<a name='583'>
<font color=#447700>!----------------------------------------------------------------------<a name='584'></font>
          TEM=(TLOW+TZ0)*0.5<a name='585'>
          THM=(THELOW+THZ0)*0.5<a name='586'>
<font color=#447700>!<a name='587'></font>
          A=THM*P608<a name='588'>
          B=(ELOCP/TEM-1.-P608)*THM<a name='589'>
<font color=#447700>!<a name='590'></font>
          DTHV=((THELOW-THZ0)*((QLOW+QZ0)*(0.5*P608)+1.)               &amp;<a name='591'>
     &amp;        +(QLOW-QZ0)*A+CWMLOW*B)<a name='592'>
<font color=#447700>!<a name='593'></font>
          DU2=MAX((ULOW-UZ0)**2+(VLOW-VZ0)**2,EPSU2)<a name='594'>
          RIB=BTGX*DTHV*ZSL/DU2<a name='595'>
<font color=#447700>!----------------------------------------------------------------------<a name='596'></font>
<font color=#447700>!         IF(RIB&gt;=RIC)THEN<a name='597'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='598'></font>
<font color=#447700>!           AKMS=MAX( VISC*RDZ,CXCHS)<a name='599'></font>
<font color=#447700>!           AKHS=MAX(TVISC*RDZ,CXCHS)<a name='600'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='601'></font>
<font color=#447700>!         ELSE  !  turbulent branch<a name='602'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='603'></font>
            ZSLU=ZSL+ZU<a name='604'>
            ZSLT=ZSL+ZT<a name='605'>
<font color=#447700>!<a name='606'></font>
            RZSU=ZSLU/ZU<a name='607'>
            RZST=ZSLT/ZT<a name='608'>
<font color=#447700>!<a name='609'></font>
            RLOGU=LOG(RZSU)<a name='610'>
            RLOGT=LOG(RZST)<a name='611'>
<font color=#447700>!<a name='612'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='613'></font>
<font color=#447700>!***  1./MONIN-OBUKHOV LENGTH<a name='614'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='615'></font>
<font color=#447700>!<a name='616'></font>
            RLMO=ELFC*AKHS*DTHV/USTAR**3<a name='617'>
<font color=#447700>!<a name='618'></font>
            ZETALU=ZSLU*RLMO<a name='619'>
            ZETALT=ZSLT*RLMO<a name='620'>
            ZETAU=ZU*RLMO<a name='621'>
            ZETAT=ZT*RLMO<a name='622'>
<font color=#447700>!<a name='623'></font>
            ZETALU=MIN(MAX(ZETALU,ZTMIN1),ZTMAX1)<a name='624'>
            ZETALT=MIN(MAX(ZETALT,ZTMIN1),ZTMAX1)<a name='625'>
            ZETAU=MIN(MAX(ZETAU,ZTMIN1/RZSU),ZTMAX1/RZSU)<a name='626'>
            ZETAT=MIN(MAX(ZETAT,ZTMIN1/RZST),ZTMAX1/RZST)<a name='627'>
<font color=#447700>!<a name='628'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='629'></font>
<font color=#447700>!***   WATER FUNCTIONS<a name='630'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='631'></font>
<font color=#447700>!<a name='632'></font>
            RZ=(ZETAU-ZTMIN1)/DZETA1<a name='633'>
            K=INT(RZ)<a name='634'>
            RDZT=RZ-REAL(K)<a name='635'>
            K=MIN(K,KZTM2)<a name='636'>
            K=MAX(K,0)<a name='637'>
            PSMZ=(PSIM1(K+2)-PSIM1(K+1))*RDZT+PSIM1(K+1)<a name='638'>
<font color=#447700>!<a name='639'></font>
            RZ=(ZETALU-ZTMIN1)/DZETA1<a name='640'>
            K=INT(RZ)<a name='641'>
            RDZT=RZ-REAL(K)<a name='642'>
            K=MIN(K,KZTM2)<a name='643'>
            K=MAX(K,0)<a name='644'>
            PSMZL=(PSIM1(K+2)-PSIM1(K+1))*RDZT+PSIM1(K+1)<a name='645'>
<font color=#447700>!<a name='646'></font>
            SIMM=PSMZL-PSMZ+RLOGU<a name='647'>
<font color=#447700>!<a name='648'></font>
            RZ=(ZETAT-ZTMIN1)/DZETA1<a name='649'>
            K=INT(RZ)<a name='650'>
            RDZT=RZ-REAL(K)<a name='651'>
            K=MIN(K,KZTM2)<a name='652'>
            K=MAX(K,0)<a name='653'>
            PSHZ=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='654'>
<font color=#447700>!<a name='655'></font>
            RZ=(ZETALT-ZTMIN1)/DZETA1<a name='656'>
            K=INT(RZ)<a name='657'>
            RDZT=RZ-REAL(K)<a name='658'>
            K=MIN(K,KZTM2)<a name='659'>
            K=MAX(K,0)<a name='660'>
            PSHZL=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='661'>
<font color=#447700>!<a name='662'></font>
            SIMH=(PSHZL-PSHZ+RLOGT)*FH01<a name='663'>
<font color=#447700>!----------------------------------------------------------------------<a name='664'></font>
            USTARK=USTAR*VKARMAN<a name='665'>
            AKMS=MAX(USTARK/SIMM,CXCHS)<a name='666'>
            AKHS=MAX(USTARK/SIMH,CXCHS)<a name='667'>
<font color=#447700>!<a name='668'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='669'></font>
<font color=#447700>!***  BELJAARS CORRECTION FOR USTAR<a name='670'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='671'></font>
<font color=#447700>!<a name='672'></font>
            WSTAR2=WWST2*ABS(BTGH*AKHS*DTHV)**(2./3.)<a name='673'>
            USTAR=MAX(SQRT(AKMS*SQRT(DU2+WSTAR2)),EPSUST)<a name='674'>
<font color=#447700>!----------------------------------------------------------------------<a name='675'></font>
<font color=#447700>!         ENDIF  !  End of turbulent branch<a name='676'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='677'></font>
<font color=#447700>!<a name='678'></font>
        ENDDO  <font color=#447700>!  End of the iteration loop over sea points<a name='679'></font>
<font color=#447700>!<a name='680'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='681'></font>
<font color=#447700>!<a name='682'></font>
<font color=#447700>!***  LAND POINTS<a name='683'></font>
<font color=#447700>!<a name='684'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='685'></font>
<font color=#447700>!<a name='686'></font>
      ELSE  <a name='687'>
<font color=#447700>!<a name='688'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='689'></font>
        ZU=Z0<a name='690'>
        UZ0=0.<a name='691'>
        VZ0=0.<a name='692'>
<font color=#447700>!<a name='693'></font>
        ZT=ZU*ZTFC<a name='694'>
        THZ0=THS<a name='695'>
<font color=#447700>!<a name='696'></font>
        ZQ=ZT<a name='697'>
        QZ0=QS<a name='698'>
<font color=#447700>!----------------------------------------------------------------------<a name='699'></font>
        TEM=(TLOW+TZ0)*0.5<a name='700'>
        THM=(THELOW+THZ0)*0.5<a name='701'>
<font color=#447700>!<a name='702'></font>
        A=THM*P608<a name='703'>
        B=(ELOCP/TEM-1.-P608)*THM<a name='704'>
<font color=#447700>!<a name='705'></font>
        DTHV=((THELOW-THZ0)*((QLOW+QZ0)*(0.5*P608)+1.)                 &amp;<a name='706'>
     &amp;      +(QLOW-QZ0)*A+CWMLOW*B)<a name='707'>
<font color=#447700>!<a name='708'></font>
        DU2=MAX((ULOW-UZ0)**2+(VLOW-VZ0)**2,EPSU2)<a name='709'>
        RIB=BTGX*DTHV*ZSL/DU2<a name='710'>
<font color=#447700>!----------------------------------------------------------------------<a name='711'></font>
<font color=#447700>!       IF(RIB&gt;=RIC)THEN<a name='712'></font>
<font color=#447700>!         AKMS=MAX( VISC*RDZ,CXCHL)<a name='713'></font>
<font color=#447700>!         AKHS=MAX(TVISC*RDZ,CXCHL)<a name='714'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='715'></font>
<font color=#447700>!       ELSE  !  Turbulent branch<a name='716'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='717'></font>
          ZSLU=ZSL+ZU<a name='718'>
          ZSLT=ZSL+ZT<a name='719'>
<font color=#447700>!<a name='720'></font>
          RZSU=ZSLU/ZU<a name='721'>
<font color=#447700>!<a name='722'></font>
          RLOGU=LOG(RZSU)<a name='723'>
<font color=#447700>!----------------------------------------------------------------------<a name='724'></font>
<font color=#447700>!<a name='725'></font>
          DO ITR=1,ITRMX<a name='726'>
<font color=#447700>!<a name='727'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='728'></font>
<font color=#447700>!***  ZILITINKEVITCH FIX FOR ZT<a name='729'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='730'></font>
<font color=#447700>!<a name='731'></font>
            ZT=MAX(EXP(ZILFC*SQRT(USTAR*ZU))*ZU,EPSZT)<a name='732'>
<font color=#447700>!zj         ZT=EXP(ZILFC*SQRT(USTAR*ZU))*ZU<a name='733'></font>
            RZST=ZSLT/ZT<a name='734'>
            RLOGT=LOG(RZST)<a name='735'>
<font color=#447700>!<a name='736'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='737'></font>
<font color=#447700>!***  1./MONIN-OBUKHOV LENGTH-SCALE<a name='738'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='739'></font>
<font color=#447700>!<a name='740'></font>
            RLMO=ELFC*AKHS*DTHV/USTAR**3<a name='741'>
            ZETALU=ZSLU*RLMO<a name='742'>
            ZETALT=ZSLT*RLMO<a name='743'>
            ZETAU=ZU*RLMO<a name='744'>
            ZETAT=ZT*RLMO<a name='745'>
<font color=#447700>!<a name='746'></font>
            ZETALU=MIN(MAX(ZETALU,ZTMIN2),ZTMAX2)<a name='747'>
            ZETALT=MIN(MAX(ZETALT,ZTMIN2),ZTMAX2)<a name='748'>
            ZETAU=MIN(MAX(ZETAU,ZTMIN2/RZSU),ZTMAX2/RZSU)<a name='749'>
            ZETAT=MIN(MAX(ZETAT,ZTMIN2/RZST),ZTMAX2/RZST)<a name='750'>
<font color=#447700>!<a name='751'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='752'></font>
<font color=#447700>!***  LAND FUNCTIONS<a name='753'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='754'></font>
<font color=#447700>!<a name='755'></font>
            RZ=(ZETAU-ZTMIN2)/DZETA2<a name='756'>
            K=INT(RZ)<a name='757'>
            RDZT=RZ-REAL(K)<a name='758'>
            K=MIN(K,KZTM2)<a name='759'>
            K=MAX(K,0)<a name='760'>
            PSMZ=(PSIM2(K+2)-PSIM2(K+1))*RDZT+PSIM2(K+1)<a name='761'>
<font color=#447700>!<a name='762'></font>
            RZ=(ZETALU-ZTMIN2)/DZETA2<a name='763'>
            K=INT(RZ)<a name='764'>
            RDZT=RZ-REAL(K)<a name='765'>
            K=MIN(K,KZTM2)<a name='766'>
            K=MAX(K,0)<a name='767'>
            PSMZL=(PSIM2(K+2)-PSIM2(K+1))*RDZT+PSIM2(K+1)<a name='768'>
<font color=#447700>!<a name='769'></font>
            SIMM=PSMZL-PSMZ+RLOGU<a name='770'>
<font color=#447700>!<a name='771'></font>
            RZ=(ZETAT-ZTMIN2)/DZETA2<a name='772'>
            K=INT(RZ)<a name='773'>
            RDZT=RZ-REAL(K)<a name='774'>
            K=MIN(K,KZTM2)<a name='775'>
            K=MAX(K,0)<a name='776'>
            PSHZ=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='777'>
<font color=#447700>!<a name='778'></font>
            RZ=(ZETALT-ZTMIN2)/DZETA2<a name='779'>
            K=INT(RZ)<a name='780'>
            RDZT=RZ-REAL(K)<a name='781'>
            K=MIN(K,KZTM2)<a name='782'>
            K=MAX(K,0)<a name='783'>
            PSHZL=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='784'>
<font color=#447700>!<a name='785'></font>
            SIMH=(PSHZL-PSHZ+RLOGT)*FH02<a name='786'>
<font color=#447700>!----------------------------------------------------------------------<a name='787'></font>
            USTARK=USTAR*VKARMAN<a name='788'>
            AKMS=MAX(USTARK/SIMM,CXCHL)<a name='789'>
            AKHS=MAX(USTARK/SIMH,CXCHL)<a name='790'>
<font color=#447700>!<a name='791'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='792'></font>
<font color=#447700>!***  BELJAARS CORRECTION FOR USTAR<a name='793'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='794'></font>
<font color=#447700>!<a name='795'></font>
            WSTAR2=WWST2*ABS(BTGH*AKHS*DTHV)**(2./3.)<a name='796'>
            USTAR=MAX(SQRT(AKMS*SQRT(DU2+WSTAR2)),EPSUST)<a name='797'>
<font color=#447700>!<a name='798'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='799'></font>
          ENDDO  <font color=#447700>!  End of iteration for land points<a name='800'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='801'></font>
<font color=#447700>!<a name='802'></font>
<font color=#447700>!       ENDIF  !  End of turbulant branch over land<a name='803'></font>
<font color=#447700>!<a name='804'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='805'></font>
<font color=#447700>!<a name='806'></font>
      ENDIF  <font color=#447700>!  End of land/sea branch<a name='807'></font>
<font color=#447700>!<a name='808'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='809'></font>
<font color=#447700>!***  COUNTERGRADIENT FIX<a name='810'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='811'></font>
      HV=-AKHS*DTHV<a name='812'>
      IF(HV&gt;0.)THEN<a name='813'>
        FCT=-10.*(BTGX)**(-1./3.)<a name='814'>
        CT=FCT*(HV/(PBLH*PBLH))**(2./3.)<a name='815'>
      ELSE<a name='816'>
        CT=0.<a name='817'>
      ENDIF<a name='818'>
<font color=#447700>!----------------------------------------------------------------------<a name='819'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='820'></font>
<font color=#447700>!***  THE FOLLOWING DIAGNOSTIC BLOCK PRODUCES 2-m and 10-m VALUES<a name='821'></font>
<font color=#447700>!***  FOR TEMPERATURE, MOISTURE, AND WINDS.  IT IS DONE HERE SINCE<a name='822'></font>
<font color=#447700>!***  THE VARIOUS QUANTITIES NEEDED FOR THE COMPUTATION ARE LOST<a name='823'></font>
<font color=#447700>!***  UPON EXIT FROM THE ROTUINE.<a name='824'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='825'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='826'></font>
<font color=#447700>!<a name='827'></font>
      WSTAR=SQRT(WSTAR2)/WWST<a name='828'>
<font color=#447700>!<a name='829'></font>
      UMFLX=AKMS*(ULOW -UZ0 )<a name='830'>
      VMFLX=AKMS*(VLOW -VZ0 )<a name='831'>
      HSFLX=AKHS*(THLOW-THZ0)<a name='832'>
      HLFLX=AKHS*(QLOW -QZ0 )<a name='833'>
<font color=#447700>!----------------------------------------------------------------------<a name='834'></font>
<font color=#447700>!     IF(RIB&gt;=RIC)THEN<a name='835'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='836'></font>
<font color=#447700>!       IF(SEAMASK&gt;0.)THEN<a name='837'></font>
<font color=#447700>!         AKMS10=MAX( VISC/10.,CXCHS)<a name='838'></font>
<font color=#447700>!         AKHS02=MAX(TVISC/02.,CXCHS)<a name='839'></font>
<font color=#447700>!         AKHS10=MAX(TVISC/10.,CXCHS)<a name='840'></font>
<font color=#447700>!       ELSE<a name='841'></font>
<font color=#447700>!         AKMS10=MAX( VISC/10.,CXCHL)<a name='842'></font>
<font color=#447700>!         AKHS02=MAX(TVISC/02.,CXCHL)<a name='843'></font>
<font color=#447700>!         AKHS10=MAX(TVISC/10.,CXCHL)<a name='844'></font>
<font color=#447700>!       ENDIF<a name='845'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='846'></font>
<font color=#447700>!     ELSE<a name='847'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='848'></font>
        ZU10=ZU+10.<a name='849'>
        ZT02=ZT+02.<a name='850'>
        ZT10=ZT+10.<a name='851'>
<font color=#447700>!<a name='852'></font>
        RLNU10=LOG(ZU10/ZU)<a name='853'>
        RLNT02=LOG(ZT02/ZT)<a name='854'>
        RLNT10=LOG(ZT10/ZT)<a name='855'>
<font color=#447700>!<a name='856'></font>
        ZTAU10=ZU10*RLMO<a name='857'>
        ZTAT02=ZT02*RLMO<a name='858'>
        ZTAT10=ZT10*RLMO<a name='859'>
<font color=#447700>!<a name='860'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='861'></font>
<font color=#447700>!***  SEA<a name='862'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='863'></font>
<font color=#447700>!<a name='864'></font>
        IF(SEAMASK&gt;0.)THEN<a name='865'>
<font color=#447700>!<a name='866'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='867'></font>
          ZTAU10=MIN(MAX(ZTAU10,ZTMIN1),ZTMAX1)<a name='868'>
          ZTAT02=MIN(MAX(ZTAT02,ZTMIN1),ZTMAX1)<a name='869'>
          ZTAT10=MIN(MAX(ZTAT10,ZTMIN1),ZTMAX1)<a name='870'>
<font color=#447700>!----------------------------------------------------------------------<a name='871'></font>
          RZ=(ZTAU10-ZTMIN1)/DZETA1<a name='872'>
          K=INT(RZ)<a name='873'>
          RDZT=RZ-REAL(K)<a name='874'>
          K=MIN(K,KZTM2)<a name='875'>
          K=MAX(K,0)<a name='876'>
          PSM10=(PSIM1(K+2)-PSIM1(K+1))*RDZT+PSIM1(K+1)<a name='877'>
<font color=#447700>!<a name='878'></font>
          SIMM10=PSM10-PSMZ+RLNU10<a name='879'>
<font color=#447700>!<a name='880'></font>
          RZ=(ZTAT02-ZTMIN1)/DZETA1<a name='881'>
          K=INT(RZ)<a name='882'>
          RDZT=RZ-REAL(K)<a name='883'>
          K=MIN(K,KZTM2)<a name='884'>
          K=MAX(K,0)<a name='885'>
          PSH02=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='886'>
<font color=#447700>!<a name='887'></font>
          SIMH02=(PSH02-PSHZ+RLNT02)*FH01<a name='888'>
<font color=#447700>!<a name='889'></font>
          RZ=(ZTAT10-ZTMIN1)/DZETA1<a name='890'>
          K=INT(RZ)<a name='891'>
          RDZT=RZ-REAL(K)<a name='892'>
          K=MIN(K,KZTM2)<a name='893'>
          K=MAX(K,0)<a name='894'>
          PSH10=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='895'>
<font color=#447700>!<a name='896'></font>
          SIMH10=(PSH10-PSHZ+RLNT10)*FH01<a name='897'>
<font color=#447700>!<a name='898'></font>
          AKMS10=MAX(USTARK/SIMM10,CXCHS)<a name='899'>
          AKHS02=MAX(USTARK/SIMH02,CXCHS)<a name='900'>
          AKHS10=MAX(USTARK/SIMH10,CXCHS)<a name='901'>
<font color=#447700>!<a name='902'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='903'></font>
<font color=#447700>!***  LAND<a name='904'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='905'></font>
<font color=#447700>!<a name='906'></font>
        ELSE<a name='907'>
<font color=#447700>!<a name='908'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='909'></font>
          ZTAU10=MIN(MAX(ZTAU10,ZTMIN2),ZTMAX2)<a name='910'>
          ZTAT02=MIN(MAX(ZTAT02,ZTMIN2),ZTMAX2)<a name='911'>
          ZTAT10=MIN(MAX(ZTAT10,ZTMIN2),ZTMAX2)<a name='912'>
<font color=#447700>!----------------------------------------------------------------------<a name='913'></font>
          RZ=(ZTAU10-ZTMIN2)/DZETA2<a name='914'>
          K=INT(RZ)<a name='915'>
          RDZT=RZ-REAL(K)<a name='916'>
          K=MIN(K,KZTM2)<a name='917'>
          K=MAX(K,0)<a name='918'>
          PSM10=(PSIM2(K+2)-PSIM2(K+1))*RDZT+PSIM2(K+1)<a name='919'>
<font color=#447700>!<a name='920'></font>
          SIMM10=PSM10-PSMZ+RLNU10<a name='921'>
<font color=#447700>!<a name='922'></font>
          RZ=(ZTAT02-ZTMIN2)/DZETA2<a name='923'>
          K=INT(RZ)<a name='924'>
          RDZT=RZ-REAL(K)<a name='925'>
          K=MIN(K,KZTM2)<a name='926'>
          K=MAX(K,0)<a name='927'>
          PSH02=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='928'>
<font color=#447700>!<a name='929'></font>
          SIMH02=(PSH02-PSHZ+RLNT02)*FH02<a name='930'>
<font color=#447700>!<a name='931'></font>
          RZ=(ZTAT10-ZTMIN2)/DZETA2<a name='932'>
          K=INT(RZ)<a name='933'>
          RDZT=RZ-REAL(K)<a name='934'>
          K=MIN(K,KZTM2)<a name='935'>
          K=MAX(K,0)<a name='936'>
          PSH10=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='937'>
<font color=#447700>!<a name='938'></font>
          SIMH10=(PSH10-PSHZ+RLNT10)*FH02<a name='939'>
<font color=#447700>!<a name='940'></font>
          AKMS10=MAX(USTARK/SIMM10,CXCHL)<a name='941'>
          AKHS02=MAX(USTARK/SIMH02,CXCHL)<a name='942'>
          AKHS10=MAX(USTARK/SIMH10,CXCHL)<a name='943'>
<font color=#447700>!----------------------------------------------------------------------<a name='944'></font>
        ENDIF<a name='945'>
<font color=#447700>!----------------------------------------------------------------------<a name='946'></font>
<font color=#447700>!     ENDIF<a name='947'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='948'></font>
      U10 =UMFLX/AKMS10+UZ0<a name='949'>
      V10 =VMFLX/AKMS10+VZ0<a name='950'>
      TH02=HSFLX/AKHS02+THZ0<a name='951'>
      TH10=HSFLX/AKHS10+THZ0<a name='952'>
      Q02 =HLFLX/AKHS02+QZ0<a name='953'>
      Q10 =HLFLX/AKHS10+QZ0<a name='954'>
      TERM1=-0.068283/TLOW<a name='955'>
      PSHLTR=PSFC*EXP(TERM1)<a name='956'>
<font color=#447700>!<a name='957'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='958'></font>
<font color=#447700>!***  SET OTHER WRF DRIVER ARRAYS<a name='959'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='960'></font>
      RLOW=PLOW/(R_D*TLOW)<a name='961'>
      CHS=AKHS<a name='962'>
      CHS2=AKHS02<a name='963'>
      CQS2=AKHS02<a name='964'>
      HFX=-RLOW*CP*HSFLX<a name='965'>
      QFX=-RLOW*HLFLX*WETM<a name='966'>
      FLX_LH=XLV*QFX<a name='967'>
      FLHC=RLOW*CP*AKHS<a name='968'>
      FLQC=RLOW*AKHS*WETM<a name='969'>
<font color=#447700>!!!   QGH=PQ0/PSHLTR*EXP(A2S*(TSK-A3S)/(TSK-A4S))<a name='970'></font>
      QGH=((1.-SEAMASK)*PQ0+SEAMASK*PQ0SEA)                            &amp;<a name='971'>
     &amp;     /PLOW*EXP(A2S*(TLOW-A3S)/(TLOW-A4S))<a name='972'>
      QGH=QGH/(1.-QGH)    <font color=#447700>!Convert to mixing ratio<a name='973'></font>
      CPM=CP*(1.+0.8*QLOW)<a name='974'>
      IF ( SEAMASK .GT. 0.5 ) THEN<a name='975'>
        QS=QLOW+QFX/(RLOW*AKHS)<a name='976'>
        QS=QS/(1.-QS)<a name='977'>
      ENDIF<a name='978'>
<font color=#447700>!----------------------------------------------------------------------<a name='979'></font>
<font color=#447700>!<a name='980'></font>
      END SUBROUTINE SFCDIF<a name='981'>
<font color=#447700>!<a name='982'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='983'></font>
<A NAME='MYJSFCINIT'><A href='../../html_code/phys/module_sf_myjsfc.F.html#MYJSFCINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='984'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MYJSFCINIT</font>(LOWLYR,USTAR,Z0                            &amp; <A href='../../call_to/MYJSFCINIT.html' TARGET='index'>2</A>,<A href='../../call_from/MYJSFCINIT.html' TARGET='index'>1</A><a name='985'>
     &amp;                     ,SEAMASK,XICE,IVGTYP,RESTART                &amp;<a name='986'>
     &amp;                     ,ALLOWED_TO_READ                            &amp;<a name='987'>
     &amp;                     ,IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='988'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='989'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='990'>
<font color=#447700>!----------------------------------------------------------------------<a name='991'></font>
      IMPLICIT NONE<a name='992'>
<font color=#447700>!----------------------------------------------------------------------<a name='993'></font>
      LOGICAL,INTENT(IN) :: RESTART,ALLOWED_TO_READ<a name='994'>
<font color=#447700>!<a name='995'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='996'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='997'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='998'>
<font color=#447700>!<a name='999'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: IVGTYP<a name='1000'>
<font color=#447700>!<a name='1001'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: LOWLYR<a name='1002'>
<font color=#447700>!<a name='1003'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: SEAMASK,XICE<a name='1004'>
<font color=#447700>!<a name='1005'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: USTAR,Z0<a name='1006'>
<font color=#447700>!<a name='1007'></font>
      REAL,DIMENSION(0:30) :: VZ0TBL<a name='1008'>
      REAL,DIMENSION(0:30) :: VZ0TBL_24<a name='1009'>
<font color=#447700>!<a name='1010'></font>
      INTEGER :: I,IDUM,IRECV,J,JDUM,K,ITF,JTF,KTF,MAXGBL_IVGTYP       &amp;<a name='1011'>
     &amp;,          MAXLOC_IVGTYP,MPI_COMM_COMP<a name='1012'>
<font color=#447700>!<a name='1013'></font>
<font color=#447700>!     INTEGER :: MPI_INTEGER,MPI_MAX<a name='1014'></font>
<font color=#447700>!<a name='1015'></font>
      REAL :: SM,X,ZETA1,ZETA2,ZRNG1,ZRNG2<a name='1016'>
<font color=#447700>!<a name='1017'></font>
      REAL :: PIHF=3.1415926/2.,EPS=1.E-6<a name='1018'>
<font color=#447700>!----------------------------------------------------------------------<a name='1019'></font>
      VZ0TBL=                                                          &amp;<a name='1020'>
     &amp;  (/0.,                                                          &amp;<a name='1021'>
     &amp;    2.653,0.826,0.563,1.089,0.854,0.856,0.035,0.238,0.065,0.076  &amp;<a name='1022'>
     &amp;   ,0.011,0.035,0.011,0.000,0.000,0.000,0.000,0.000,0.000,0.000  &amp;<a name='1023'>
     &amp;   ,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000/)<a name='1024'>
<a name='1025'>
      VZ0TBL_24= (/0.,                                                 &amp;<a name='1026'>
     &amp;            1.00,  0.07,  0.07,  0.07,  0.07,  0.15,             &amp;<a name='1027'>
     &amp;            0.08,  0.03,  0.05,  0.86,  0.80,  0.85,             &amp;<a name='1028'>
     &amp;            2.65,  1.09,  0.80,  0.001, 0.04,  0.05,             &amp;<a name='1029'>
     &amp;            0.01,  0.04,  0.06,  0.05,  0.03,  0.001,            &amp;<a name='1030'>
     &amp;            0.000, 0.000, 0.000, 0.000, 0.000, 0.000/)<a name='1031'>
<a name='1032'>
<font color=#447700>!----------------------------------------------------------------------<a name='1033'></font>
<font color=#447700>!<a name='1034'></font>
      JTF=MIN0(JTE,JDE-1)<a name='1035'>
      KTF=MIN0(KTE,KDE-1)<a name='1036'>
      ITF=MIN0(ITE,IDE-1)<a name='1037'>
<font color=#447700>!<a name='1038'></font>
<font color=#447700>!<a name='1039'></font>
<font color=#447700>!***  FOR NOW, ASSUME SIGMA MODE FOR LOWEST MODEL LAYER<a name='1040'></font>
<font color=#447700>!<a name='1041'></font>
      DO J=JTS,JTF<a name='1042'>
      DO I=ITS,ITF<a name='1043'>
        LOWLYR(I,J)=1<a name='1044'>
<font color=#447700>!       USTAR(I,J)=EPSUST<a name='1045'></font>
      ENDDO<a name='1046'>
      ENDDO<a name='1047'>
<font color=#447700>!----------------------------------------------------------------------<a name='1048'></font>
#if (NMM_CORE == 1)<a name='1049'>
<font color=#447700>!<a name='1050'></font>
      IF(.NOT.RESTART)THEN<a name='1051'>
<font color=#447700>!       CALL WRF_GET_DM_COMMUNICATOR(MPI_COMM_COMP)<a name='1052'></font>
<font color=#447700>!       MAXLOC_IVGTYP=MAXVAL(IVGTYP)<a name='1053'></font>
<font color=#447700>!       CALL MPI_ALLREDUCE(MAXLOC_IVGTYP,MAXGBL_IVGTYP,1,MPI_INTEGER   &amp;<a name='1054'></font>
<font color=#447700>!    &amp;,                    MPI_MAX,MPI_COMM_COMP,IRECV)<a name='1055'></font>
        MAXGBL_IVGTYP=MAXVAL(IVGTYP)<a name='1056'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAXVAL'>WRF_DM_MAXVAL</A><A href='../../html_code/phys/module_sf_myjsfc.F.html#MYJSFCINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_1">(MAXGBL_IVGTYP,IDUM,JDUM)<a name='1057'>
<font color=#447700>!<a name='1058'></font>
        IF (MAXGBL_IVGTYP&lt;13) THEN<a name='1059'>
          DO J=JTS,JTE<a name='1060'>
          DO I=ITS,ITE<a name='1061'>
            SM=SEAMASK(I,J)-1.<a name='1062'>
            IF(SM+XICE(I,J)&lt;0.5)THEN<a name='1063'>
              Z0(I,J)=Z0(I,J)+VZ0TBL(IVGTYP(I,J))<a name='1064'>
            ENDIF<a name='1065'>
          ENDDO<a name='1066'>
          ENDDO<a name='1067'>
<font color=#447700>!<a name='1068'></font>
        ELSE<a name='1069'>
<font color=#447700>!<a name='1070'></font>
          DO J=JTS,JTE<a name='1071'>
          DO I=ITS,ITE<a name='1072'>
            SM=SEAMASK(I,J)-1.<a name='1073'>
            IF(SM+XICE(I,J)&lt;0.5)THEN<a name='1074'>
              Z0(I,J)=Z0(I,J)+VZ0TBL_24(IVGTYP(I,J))<a name='1075'>
            ENDIF<a name='1076'>
          ENDDO<a name='1077'>
          ENDDO<a name='1078'>
<font color=#447700>!<a name='1079'></font>
        ENDIF <font color=#447700>! Vegtype check<a name='1080'></font>
<font color=#447700>!<a name='1081'></font>
      ENDIF <font color=#447700>! Restart check<a name='1082'></font>
#endif<a name='1083'>
<font color=#447700>!----------------------------------------------------------------------<a name='1084'></font>
      IF(.NOT.RESTART)THEN<a name='1085'>
        DO J=JTS,JTE<a name='1086'>
        DO I=ITS,ITF<a name='1087'>
          USTAR(I,J)=0.1<a name='1088'>
        ENDDO<a name='1089'>
        ENDDO<a name='1090'>
      ENDIF<a name='1091'>
<font color=#447700>!----------------------------------------------------------------------<a name='1092'></font>
<font color=#447700>!<a name='1093'></font>
<font color=#447700>!***  COMPUTE SURFACE LAYER INTEGRAL FUNCTIONS<a name='1094'></font>
<font color=#447700>!<a name='1095'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1096'></font>
      FH01=1.<a name='1097'>
      FH02=1.<a name='1098'>
<font color=#447700>!<a name='1099'></font>
<font color=#447700>!      ZTMIN1=-10.0<a name='1100'></font>
<font color=#447700>!      ZTMAX1=2.0<a name='1101'></font>
<font color=#447700>!      ZTMIN2=-10.0<a name='1102'></font>
<font color=#447700>!      ZTMAX2=2.0<a name='1103'></font>
      ZTMIN1=-5.0<a name='1104'>
      ZTMAX1=1.0<a name='1105'>
      ZTMIN2=-5.0<a name='1106'>
      ZTMAX2=1.0<a name='1107'>
<font color=#447700>!<a name='1108'></font>
      ZRNG1=ZTMAX1-ZTMIN1<a name='1109'>
      ZRNG2=ZTMAX2-ZTMIN2<a name='1110'>
<font color=#447700>!<a name='1111'></font>
      DZETA1=ZRNG1/(KZTM-1)<a name='1112'>
      DZETA2=ZRNG2/(KZTM-1)<a name='1113'>
<font color=#447700>!<a name='1114'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1115'></font>
<font color=#447700>!***  FUNCTION DEFINITION LOOP<a name='1116'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1117'></font>
<font color=#447700>!<a name='1118'></font>
      ZETA1=ZTMIN1<a name='1119'>
      ZETA2=ZTMIN2<a name='1120'>
<font color=#447700>!<a name='1121'></font>
      DO K=1,KZTM<a name='1122'>
<font color=#447700>!<a name='1123'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1124'></font>
<font color=#447700>!***  UNSTABLE RANGE<a name='1125'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1126'></font>
<font color=#447700>!<a name='1127'></font>
        IF(ZETA1&lt;0.)THEN<a name='1128'>
<font color=#447700>!<a name='1129'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1130'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1131'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1132'></font>
          X=SQRT(SQRT(1.-16.*ZETA1))<a name='1133'>
<font color=#447700>!<a name='1134'></font>
          PSIM1(K)=-2.*LOG((X+1.)/2.)-LOG((X*X+1.)/2.)+2.*ATAN(X)-PIHF<a name='1135'>
          PSIH1(K)=-2.*LOG((X*X+1.)/2.)<a name='1136'>
<font color=#447700>!<a name='1137'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1138'></font>
<font color=#447700>!***  STABLE RANGE<a name='1139'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1140'></font>
<font color=#447700>!<a name='1141'></font>
        ELSE<a name='1142'>
<font color=#447700>!<a name='1143'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1144'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1145'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1146'></font>
<font color=#447700>!<a name='1147'></font>
<font color=#447700>!         PSIM1(K)=5.*ZETA1<a name='1148'></font>
<font color=#447700>!         PSIH1(K)=5.*ZETA1<a name='1149'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1150'></font>
<font color=#447700>!***   HOLTSLAG AND DE BRUIN 1988<a name='1151'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1152'></font>
<font color=#447700>!<a name='1153'></font>
          PSIM1(K)=0.7*ZETA1+0.75*ZETA1*(6.-0.35*ZETA1)*EXP(-0.35*ZETA1)<a name='1154'>
          PSIH1(K)=0.7*ZETA1+0.75*ZETA1*(6.-0.35*ZETA1)*EXP(-0.35*ZETA1)<a name='1155'>
<font color=#447700>!----------------------------------------------------------------------<a name='1156'></font>
<font color=#447700>!<a name='1157'></font>
        ENDIF<a name='1158'>
<font color=#447700>!<a name='1159'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1160'></font>
<font color=#447700>!***  UNSTABLE RANGE<a name='1161'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1162'></font>
<font color=#447700>!<a name='1163'></font>
        IF(ZETA2&lt;0.)THEN<a name='1164'>
<font color=#447700>!<a name='1165'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1166'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1167'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1168'></font>
<font color=#447700>!<a name='1169'></font>
          X=SQRT(SQRT(1.-16.*ZETA2))<a name='1170'>
<font color=#447700>!<a name='1171'></font>
          PSIM2(K)=-2.*LOG((X+1.)/2.)-LOG((X*X+1.)/2.)+2.*ATAN(X)-PIHF<a name='1172'>
          PSIH2(K)=-2.*LOG((X*X+1.)/2.)<a name='1173'>
<font color=#447700>!----------------------------------------------------------------------<a name='1174'></font>
<font color=#447700>!***  STABLE RANGE<a name='1175'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1176'></font>
<font color=#447700>!<a name='1177'></font>
        ELSE<a name='1178'>
<font color=#447700>!<a name='1179'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1180'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1181'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1182'></font>
<font color=#447700>!<a name='1183'></font>
<font color=#447700>!         PSIM2(K)=5.*ZETA2<a name='1184'></font>
<font color=#447700>!         PSIH2(K)=5.*ZETA2<a name='1185'></font>
<font color=#447700>!<a name='1186'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1187'></font>
<font color=#447700>!***  HOLTSLAG AND DE BRUIN 1988<a name='1188'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1189'></font>
<font color=#447700>!<a name='1190'></font>
          PSIM2(K)=0.7*ZETA2+0.75*ZETA2*(6.-0.35*ZETA2)*EXP(-0.35*ZETA2)<a name='1191'>
          PSIH2(K)=0.7*ZETA2+0.75*ZETA2*(6.-0.35*ZETA2)*EXP(-0.35*ZETA2)<a name='1192'>
<font color=#447700>!----------------------------------------------------------------------<a name='1193'></font>
<font color=#447700>!<a name='1194'></font>
        ENDIF<a name='1195'>
<font color=#447700>!<a name='1196'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1197'></font>
        IF(K==KZTM)THEN<a name='1198'>
          ZTMAX1=ZETA1<a name='1199'>
          ZTMAX2=ZETA2<a name='1200'>
        ENDIF<a name='1201'>
<font color=#447700>!<a name='1202'></font>
        ZETA1=ZETA1+DZETA1<a name='1203'>
        ZETA2=ZETA2+DZETA2<a name='1204'>
<font color=#447700>!----------------------------------------------------------------------<a name='1205'></font>
      ENDDO<a name='1206'>
<font color=#447700>!----------------------------------------------------------------------<a name='1207'></font>
      ZTMAX1=ZTMAX1-EPS<a name='1208'>
      ZTMAX2=ZTMAX2-EPS<a name='1209'>
<font color=#447700>!----------------------------------------------------------------------<a name='1210'></font>
<font color=#447700>!<a name='1211'></font>
      END SUBROUTINE MYJSFCINIT<a name='1212'>
<font color=#447700>!<a name='1213'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1214'></font>
<font color=#447700>!<a name='1215'></font>
      END MODULE MODULE_SF_MYJSFC<a name='1216'>
<font color=#447700>!<a name='1217'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1218'></font>
</pre></body></html>