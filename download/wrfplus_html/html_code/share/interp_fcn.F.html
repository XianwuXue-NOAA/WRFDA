<HTML> <BODY BGCOLOR=#eedddd LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MEDIATION_LAYER:INTERPOLATIONFUNCTION<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
#define MM5_SINT<a name='5'>
<font color=#447700>!#define DUMBCOPY<a name='6'></font>
<a name='7'>
<A NAME='INTERP_FCN'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcn</font> ( cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/INTERP_FCN.html' TARGET='index'>3</A><a name='9'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='10'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='11'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='12'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='13'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='14'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='15'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='16'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='17'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='18'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='19'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='20'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='21'></font>
     USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/module_interp_fcn.F.html#INTERP_FCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_23"><a name='22'>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/module_interp_fcn.F.html#INTERP_FCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_113"><a name='23'>
     IMPLICIT NONE<a name='24'>
<a name='25'>
<a name='26'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='27'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='28'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='29'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='30'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='31'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='32'>
                            shw,                                  &amp;<a name='33'>
                            ipos, jpos,                           &amp;<a name='34'>
                            nri, nrj<a name='35'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='36'>
<a name='37'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='38'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='39'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='40'>
<a name='41'>
     <font color=#447700>! Local<a name='42'></font>
<a name='43'>
<font color=#447700>!logical first<a name='44'></font>
<a name='45'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp, ioff, joff, nioff, njoff<a name='46'>
#ifdef MM5_SINT<a name='47'>
     INTEGER nfx, ior<a name='48'>
     PARAMETER (ior=2)<a name='49'>
     INTEGER nf<a name='50'>
     REAL psca(cims:cime,cjms:cjme,nri*nrj)<a name='51'>
     LOGICAL icmask( cims:cime, cjms:cjme )<a name='52'>
     INTEGER i,j,k<a name='53'>
#endif<a name='54'>
<a name='55'>
     <font color=#447700>! Iterate over the ND tile and compute the values<a name='56'></font>
     <font color=#447700>! from the CD tile. <a name='57'></font>
<a name='58'>
<font color=#447700>!write(0,'("cids:cide, ckds:ckde, cjds:cjde ",6i4)')cids,cide, ckds,ckde, cjds,cjde<a name='59'></font>
<font color=#447700>!write(0,'("cims:cime, ckms:ckme, cjms:cjme ",6i4)')cims,cime, ckms,ckme, cjms,cjme<a name='60'></font>
<font color=#447700>!write(0,'("cits:cite, ckts:ckte, cjts:cjte ",6i4)')cits,cite, ckts,ckte, cjts,cjte<a name='61'></font>
<font color=#447700>!write(0,'("nims:nime, nkms:nkme, njms:njme ",6i4)')nims,nime, nkms,nkme, njms,njme<a name='62'></font>
<font color=#447700>!write(0,'("nits:nite, nkts:nkte, njts:njte ",6i4)')nits,nite, nkts,nkte, njts,njte<a name='63'></font>
<a name='64'>
#ifdef MM5_SINT<a name='65'>
<a name='66'>
     ioff  = 0 ; joff  = 0<a name='67'>
     nioff = 0 ; njoff = 0<a name='68'>
     IF ( xstag ) THEN <a name='69'>
       ioff = (nri-1)/2<a name='70'>
       nioff = nri <a name='71'>
     ENDIF<a name='72'>
     IF ( ystag ) THEN<a name='73'>
       joff = (nrj-1)/2<a name='74'>
       njoff = nrj<a name='75'>
     ENDIF<a name='76'>
<a name='77'>
     nfx = nri * nrj<a name='78'>
#ifndef crayx1<a name='79'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='80'></font>
   <font color=#447700>!$OMP PRIVATE ( i,j,k,ni,nj,ci,cj,ip,jp,nk,ck,nf,icmask,psca )<a name='81'></font>
#endif<a name='82'>
     DO k = ckts, ckte<a name='83'>
        icmask = .FALSE.<a name='84'>
        DO nf = 1,nfx<a name='85'>
           DO j = cjms,cjme<a name='86'>
              nj = (j-jpos) * nrj + 2   <font color=#447700>! j point on nest<a name='87'></font>
              DO i = cims,cime<a name='88'>
                ni = (i-ipos) * nri + 2   <font color=#447700>! i point on nest<a name='89'></font>
                if ( ni .ge. nits-nioff-1 .and. ni .le. nite+nioff+1 .and. nj .ge. njts-njoff-1 .and. nj .le. njte+njoff+1 ) then<a name='90'>
                  if ( imask(ni,nj) .eq. 1 ) then<a name='91'>
                    icmask( i, j ) = .TRUE.<a name='92'>
                  endif<a name='93'>
                endif<a name='94'>
                psca(i,j,nf) = cfld(i,k,j)<a name='95'>
              ENDDO<a name='96'>
           ENDDO<a name='97'>
        ENDDO<a name='98'>
<a name='99'>
<font color=#447700>! tile dims in this call to sint are 1-over to account for the fact<a name='100'></font>
<font color=#447700>! that the number of cells on the nest local subdomain is not <a name='101'></font>
<font color=#447700>! necessarily a multiple of the nest ratio in a given dim.<a name='102'></font>
<font color=#447700>! this could be a little less ham-handed.<a name='103'></font>
<a name='104'>
<font color=#447700>!call start_timing<a name='105'></font>
<a name='106'>
        CALL <A href='../../html_code/share/sint.F.html#SINT'>sint</A><A href='../../html_code/share/module_interp_fcn.F.html#INTERP_FCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINT_1">( psca,                     &amp;<a name='107'>
                   cims, cime, cjms, cjme, icmask,   &amp;<a name='108'>
                   cits-1, cite+1, cjts-1, cjte+1, nrj*nri, xstag, ystag )<a name='109'>
<a name='110'>
<font color=#447700>!call end_timing( ' sint ' )<a name='111'></font>
<a name='112'>
        DO nj = njts, njte+joff<a name='113'>
           cj = jpos + (nj-1) / nrj <font color=#447700>! j coord of CD point <a name='114'></font>
           jp = mod ( nj-1 , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='115'></font>
           nk = k<a name='116'>
           ck = nk<a name='117'>
           DO ni = nits, nite+ioff<a name='118'>
               ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point <a name='119'></font>
               ip = mod ( ni-1 , nri )  <font color=#447700>! coord of ND w/i CD point<a name='120'></font>
               if ( imask ( ni, nj ) .eq. 1 .or. imask ( ni-ioff, nj-joff ) .eq. 1  ) then<a name='121'>
                 nfld( ni-ioff, nk, nj-joff ) = psca( ci , cj, ip+1 + (jp)*nri )<a name='122'>
               endif<a name='123'>
           ENDDO<a name='124'>
        ENDDO<a name='125'>
     ENDDO<a name='126'>
#ifndef crayx1<a name='127'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='128'></font>
#endif<a name='129'>
#endif<a name='130'>
<a name='131'>
#ifdef DUMBCOPY<a name='132'>
<font color=#447700>!write(0,'(") cims:cime, ckms:ckme, cjms:cjme ",6i4)')cims,cime, ckms,ckme, cjms,cjme<a name='133'></font>
<font color=#447700>!write(0,'(") nims:nime, nkms:nkme, njms:njme ",6i4)')nims,nime, nkms,nkme, njms,njme<a name='134'></font>
<font color=#447700>!write(0,'(") cits:cite, ckts:ckte, cjts:cjte ",6i4)')cits,cite, ckts,ckte, cjts,cjte<a name='135'></font>
<font color=#447700>!write(0,'(") nits:nite, nkts:nkte, njts:njte ",6i4)')nits,nite, nkts,nkte, njts,njte<a name='136'></font>
<a name='137'>
     DO nj = njts, njte<a name='138'>
        cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point <a name='139'></font>
        jp = mod ( nj , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='140'></font>
        DO nk = nkts, nkte<a name='141'>
           ck = nk<a name='142'>
           DO ni = nits, nite<a name='143'>
              ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point <a name='144'></font>
              ip = mod ( ni , nri )  <font color=#447700>! coord of ND w/i CD point<a name='145'></font>
              <font color=#447700>! This is a trivial implementation of the interp_fcn; just copies<a name='146'></font>
              <font color=#447700>! the values from the CD into the ND<a name='147'></font>
              if ( imask ( ni, nj ) .eq. 1 ) then<a name='148'>
                nfld( ni, nk, nj ) = cfld( ci , ck , cj )<a name='149'>
              endif<a name='150'>
           ENDDO<a name='151'>
        ENDDO<a name='152'>
     ENDDO<a name='153'>
#endif<a name='154'>
<a name='155'>
     RETURN<a name='156'>
<a name='157'>
   END SUBROUTINE interp_fcn<a name='158'>
<a name='159'>
<font color=#447700>!==================================<a name='160'></font>
<font color=#447700>! this is the default function used in feedback.<a name='161'></font>
<a name='162'>
<A NAME='COPY_FCN'><A href='../../html_code/share/interp_fcn.F.html#COPY_FCN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='163'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>copy_fcn</font> ( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/COPY_FCN.html' TARGET='index'>3</A>,<A href='../../call_from/COPY_FCN.html' TARGET='index'>1</A><a name='164'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='165'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='166'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='167'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='168'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='169'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='170'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='171'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='172'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='173'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='174'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='175'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='176'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#COPY_FCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_114"><a name='177'>
     IMPLICIT NONE<a name='178'>
<a name='179'>
<a name='180'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='181'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='182'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='183'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='184'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='185'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='186'>
                            shw,                                  &amp;<a name='187'>
                            ipos, jpos,                           &amp;<a name='188'>
                            nri, nrj<a name='189'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='190'>
<a name='191'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(OUT) :: cfld<a name='192'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ),INTENT(IN)  :: nfld<a name='193'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ),INTENT(IN)  :: imask<a name='194'>
<a name='195'>
     <font color=#447700>! Local<a name='196'></font>
<a name='197'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp, ioff, joff, ioffa, joffa<a name='198'>
     INTEGER :: icmin,icmax,jcmin,jcmax<a name='199'>
     INTEGER :: istag,jstag, ipoints,jpoints,ijpoints<a name='200'>
     INTEGER , PARAMETER :: passes = 2<a name='201'>
<a name='202'>
     <font color=#447700>!  Loop over the coarse grid in the area of the fine mesh.  Do not<a name='203'></font>
     <font color=#447700>!  process the coarse grid values that are along the lateral BC<a name='204'></font>
     <font color=#447700>!  provided to the fine grid.  Since that is in the specified zone<a name='205'></font>
     <font color=#447700>!  for the fine grid, it should not be used in any feedback to the<a name='206'></font>
     <font color=#447700>!  coarse grid as it should not have changed.<a name='207'></font>
<a name='208'>
     <font color=#447700>!  Due to peculiarities of staggering, it is simpler to handle the feedback<a name='209'></font>
     <font color=#447700>!  for the staggerings based upon whether it is a even ratio (2::1, 4::1, etc.) or<a name='210'></font>
     <font color=#447700>!  an odd staggering ratio (3::1, 5::1, etc.). <a name='211'></font>
<a name='212'>
     <font color=#447700>!  Though there are separate grid ratios for the i and j directions, this code<a name='213'></font>
     <font color=#447700>!  is not general enough to handle aspect ratios .NE. 1 for the fine grid cell.<a name='214'></font>
 <a name='215'>
     <font color=#447700>!  These are local integer increments in the looping.  Basically, istag=1 means<a name='216'></font>
     <font color=#447700>!  that we will assume one less point in the i direction.  Note that ci and cj<a name='217'></font>
     <font color=#447700>!  have a maximum value that is decreased by istag and jstag, respectively.  <a name='218'></font>
<a name='219'>
     <font color=#447700>!  Horizontal momentum feedback is along the face, not within the cell.  For a<a name='220'></font>
     <font color=#447700>!  3::1 ratio, temperature would use 9 pts for feedback, while u and v use<a name='221'></font>
     <font color=#447700>!  only 3 points for feedback from the nest to the parent.<a name='222'></font>
<a name='223'>
     istag = 1 ; jstag = 1<a name='224'>
     IF ( xstag ) istag = 0<a name='225'>
     IF ( ystag ) jstag = 0<a name='226'>
<a name='227'>
     IF( MOD(nrj,2) .NE. 0) THEN  <font color=#447700>! odd refinement ratio<a name='228'></font>
<a name='229'>
        IF      ( ( .NOT. xstag ) .AND. ( .NOT. ystag ) ) THEN<a name='230'>
           DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='231'>
              nj = (cj-jpos)*nrj + jstag + 1<a name='232'>
              DO ck = ckts, ckte<a name='233'>
                 nk = ck<a name='234'>
                 DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='235'>
                    ni = (ci-ipos)*nri + istag + 1<a name='236'>
                    cfld( ci, ck, cj ) = 0.<a name='237'>
                    DO ijpoints = 1 , nri * nrj<a name='238'>
                       ipoints = MOD((ijpoints-1),nri) + 1 - nri/2 - 1<a name='239'>
                       jpoints = (ijpoints-1)/nri + 1 - nrj/2 - 1<a name='240'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='241'>
                                             1./REAL(nri*nrj) * nfld( ni+ipoints , nk , nj+jpoints )<a name='242'>
                    END DO<a name='243'>
<font color=#447700>!                   cfld( ci, ck, cj ) =  1./9. * &amp;<a name='244'></font>
<font color=#447700>!                                         ( nfld( ni-1, nk , nj-1) + &amp;<a name='245'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj-1) + &amp;<a name='246'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj-1) + &amp;<a name='247'></font>
<font color=#447700>!                                           nfld( ni-1, nk , nj  ) + &amp;<a name='248'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj  ) + &amp;<a name='249'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj  ) + &amp;<a name='250'></font>
<font color=#447700>!                                           nfld( ni-1, nk , nj+1) + &amp;<a name='251'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj+1) + &amp;<a name='252'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj+1) )<a name='253'></font>
                 ENDDO<a name='254'>
              ENDDO<a name='255'>
           ENDDO<a name='256'>
<a name='257'>
        ELSE IF ( (       xstag ) .AND. ( .NOT. ystag ) ) THEN<a name='258'>
           DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='259'>
              nj = (cj-jpos)*nrj + jstag + 1<a name='260'>
              DO ck = ckts, ckte<a name='261'>
                 nk = ck<a name='262'>
                 DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='263'>
                    ni = (ci-ipos)*nri + istag + 1<a name='264'>
                    cfld( ci, ck, cj ) = 0.<a name='265'>
                    DO ijpoints = (nri+1)/2 , (nri+1)/2 + nri*(nri-1) , nri<a name='266'>
                       ipoints = MOD((ijpoints-1),nri) + 1 - nri/2 - 1<a name='267'>
                       jpoints = (ijpoints-1)/nri + 1 - nrj/2 - 1<a name='268'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='269'>
                                             1./REAL(nri    ) * nfld( ni+ipoints , nk , nj+jpoints )<a name='270'>
                    END DO<a name='271'>
<font color=#447700>!                   cfld( ci, ck, cj ) =  1./3. * &amp;<a name='272'></font>
<font color=#447700>!                                         ( nfld( ni  , nk , nj-1) + &amp;<a name='273'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj  ) + &amp;<a name='274'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj+1) )<a name='275'></font>
                 ENDDO<a name='276'>
              ENDDO<a name='277'>
           ENDDO<a name='278'>
<a name='279'>
        ELSE IF ( ( .NOT. xstag ) .AND. (       ystag ) ) THEN<a name='280'>
           DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='281'>
              nj = (cj-jpos)*nrj + jstag + 1<a name='282'>
              DO ck = ckts, ckte<a name='283'>
                 nk = ck<a name='284'>
                 DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='285'>
                    ni = (ci-ipos)*nri + istag + 1<a name='286'>
                    cfld( ci, ck, cj ) = 0.<a name='287'>
                    DO ijpoints = ( nrj*nrj +1 )/2 - nrj/2 , ( nrj*nrj +1 )/2 - nrj/2 + nrj-1<a name='288'>
                       ipoints = MOD((ijpoints-1),nri) + 1 - nri/2 - 1<a name='289'>
                       jpoints = (ijpoints-1)/nri + 1 - nrj/2 - 1<a name='290'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='291'>
                                             1./REAL(    nrj) * nfld( ni+ipoints , nk , nj+jpoints )<a name='292'>
                    END DO<a name='293'>
<font color=#447700>!                   cfld( ci, ck, cj ) =  1./3. * &amp;<a name='294'></font>
<font color=#447700>!                                         ( nfld( ni-1, nk , nj  ) + &amp;<a name='295'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj  ) + &amp;<a name='296'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj  ) )<a name='297'></font>
                 ENDDO<a name='298'>
              ENDDO<a name='299'>
           ENDDO<a name='300'>
<a name='301'>
        END IF<a name='302'>
<a name='303'>
     <font color=#447700>!  Even refinement ratio<a name='304'></font>
<a name='305'>
     ELSE IF ( MOD(nrj,2) .EQ. 0) THEN<a name='306'>
        IF ( ( .NOT. xstag ) .AND. ( .NOT. ystag ) ) THEN<a name='307'>
<a name='308'>
        <font color=#447700>!  This is a simple schematic of the feedback indexing used in the even<a name='309'></font>
        <font color=#447700>!  ratio nests.  For simplicity, a 2::1 ratio is depicted.  Only the <a name='310'></font>
        <font color=#447700>!  mass variable staggering is shown. <a name='311'></font>
        <font color=#447700>!                                                                  Each of<a name='312'></font>
        <font color=#447700>!  the boxes with a "T" and four small "t" represents a coarse grid (CG)<a name='313'></font>
        <font color=#447700>!  cell, that is composed of four (2::1 ratio) fine grid (FG) cells.<a name='314'></font>
   <a name='315'>
        <font color=#447700>!  Shown below is the area of the CG that is in the area of the FG.   The<a name='316'></font>
        <font color=#447700>!  first grid point of the depicted CG is the starting location of the nest<a name='317'></font>
        <font color=#447700>!  in the parent domain (ipos,jpos - i_parent_start and j_parent_start from<a name='318'></font>
        <font color=#447700>!  the namelist).  <a name='319'></font>
   <a name='320'>
        <font color=#447700>!  For each of the CG points, the feedback loop is over each of the FG points<a name='321'></font>
        <font color=#447700>!  within the CG cell.  For a 2::1 ratio, there are four total points (this is <a name='322'></font>
        <font color=#447700>!  the ijpoints loop).  The feedback value to the CG is the arithmetic mean of <a name='323'></font>
        <font color=#447700>!  all of the FG values within each CG cell.<a name='324'></font>
<a name='325'>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='326'></font>
<font color=#447700>!              |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='327'></font>
<font color=#447700>! jpos+        |             ||             |                          |             ||             |<a name='328'></font>
<font color=#447700>! (njde-njds)- |      T      ||      T      |                          |      T      ||      T      |<a name='329'></font>
<font color=#447700>! jstag        |             ||             |                          |             ||             |<a name='330'></font>
<font color=#447700>!              |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='331'></font>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='332'></font>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='333'></font>
<font color=#447700>!              |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='334'></font>
<font color=#447700>!              |             ||             |                          |             ||             |<a name='335'></font>
<font color=#447700>!              |      T      ||      T      |                          |      T      ||      T      |<a name='336'></font>
<font color=#447700>!              |             ||             |                          |             ||             |<a name='337'></font>
<font color=#447700>!              |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='338'></font>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='339'></font>
<font color=#447700>!<a name='340'></font>
<font color=#447700>!                   ...<a name='341'></font>
<font color=#447700>!                   ...<a name='342'></font>
<font color=#447700>!                   ...<a name='343'></font>
<font color=#447700>!                   ...<a name='344'></font>
<font color=#447700>!                   ...<a name='345'></font>
<a name='346'>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='347'></font>
<font color=#447700>! jpoints = 1  |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='348'></font>
<font color=#447700>!              |             ||             |                          |             ||             |<a name='349'></font>
<font color=#447700>!              |      T      ||      T      |                          |      T      ||      T      |<a name='350'></font>
<font color=#447700>!              |             ||             |                          |             ||             |<a name='351'></font>
<font color=#447700>! jpoints = 0, |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='352'></font>
<font color=#447700>!  nj=3        |-------------||-------------|                          |-------------||-------------|<a name='353'></font>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='354'></font>
<font color=#447700>! jpoints = 1  |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='355'></font>
<font color=#447700>!              |             ||             |                          |             ||             |<a name='356'></font>
<font color=#447700>!    jpos      |      T      ||      T      |          ...             |      T      ||      T      |<a name='357'></font>
<font color=#447700>!              |             ||             |          ...             |             ||             |<a name='358'></font>
<font color=#447700>! jpoints = 0, |  t      t   ||  t      t   |          ...             |  t      t   ||  t      t   |<a name='359'></font>
<font color=#447700>!  nj=1        |-------------||-------------|                          |-------------||-------------|<a name='360'></font>
<font color=#447700>!                     ^                                                                      ^<a name='361'></font>
<font color=#447700>!                     |                                                                      |<a name='362'></font>
<font color=#447700>!                     |                                                                      |<a name='363'></font>
<font color=#447700>!                   ipos                                                                   ipos+<a name='364'></font>
<font color=#447700>!     ni =        1              3                                                         (nide-nids)/nri<a name='365'></font>
<font color=#447700>! ipoints=        0      1       0      1                                                  -istag<a name='366'></font>
<font color=#447700>!<a name='367'></font>
<a name='368'>
           <font color=#447700>!  For performance benefits, users can comment out the inner most loop (and cfld=0) and<a name='369'></font>
           <font color=#447700>!  hardcode the loop feedback.  For example, it is set up to run a 2::1 ratio<a name='370'></font>
           <font color=#447700>!  if uncommented.  This lacks generality, but is likely to gain timing benefits<a name='371'></font>
           <font color=#447700>!  with compilers unable to unroll inner loops that do not have parameterized sizes.<a name='372'></font>
   <a name='373'>
           <font color=#447700>!  The extra +1 ---------/ and the extra -1 ----\  (both for ci and cj) <a name='374'></font>
           <font color=#447700>!                       /                        \   keeps the feedback out of the <a name='375'></font>
           <font color=#447700>!                      /                          \  outer row/col, since that CG data<a name='376'></font>
           <font color=#447700>!                     /                            \ specified the nest boundary originally<a name='377'></font>
           <font color=#447700>!                    /                              \   This<a name='378'></font>
           <font color=#447700>!                   /                                \    is just<a name='379'></font>
           <font color=#447700>!                  /                                  \   a sentence to not end a line<a name='380'></font>
           <font color=#447700>!                 /                                    \   with a stupid backslash<a name='381'></font>
           DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='382'>
              nj = (cj-jpos)*nrj + jstag<a name='383'>
              DO ck = ckts, ckte<a name='384'>
                 nk = ck<a name='385'>
                 DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='386'>
                    ni = (ci-ipos)*nri + istag<a name='387'>
                    cfld( ci, ck, cj ) = 0.<a name='388'>
                    DO ijpoints = 1 , nri * nrj<a name='389'>
                       ipoints = MOD((ijpoints-1),nri)<a name='390'>
                       jpoints = (ijpoints-1)/nri<a name='391'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='392'>
                                             1./REAL(nri*nrj) * nfld( ni+ipoints , nk , nj+jpoints )<a name='393'>
                    END DO<a name='394'>
<font color=#447700>!                   cfld( ci, ck, cj ) =  1./4. * &amp;<a name='395'></font>
<font color=#447700>!                                         ( nfld( ni  , nk , nj  ) + &amp;<a name='396'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj  ) + &amp;<a name='397'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj+1) + &amp;<a name='398'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj+1) )<a name='399'></font>
                 END DO<a name='400'>
              END DO<a name='401'>
           END DO<a name='402'>
<a name='403'>
        <font color=#447700>!  U<a name='404'></font>
<a name='405'>
        ELSE IF ( (       xstag ) .AND. ( .NOT. ystag ) ) THEN<a name='406'>
<font color=#447700>!              |---------------|<a name='407'></font>
<font color=#447700>!              |               |<a name='408'></font>
<font color=#447700>! jpoints = 1  u       u       |<a name='409'></font>
<font color=#447700>!              |               |<a name='410'></font>
<font color=#447700>!              U               |<a name='411'></font>
<font color=#447700>!              |               |<a name='412'></font>
<font color=#447700>! jpoints = 0, u       u       |<a name='413'></font>
<font color=#447700>!  nj=3        |               |<a name='414'></font>
<font color=#447700>!              |---------------|<a name='415'></font>
<font color=#447700>!              |---------------|<a name='416'></font>
<font color=#447700>!              |               |<a name='417'></font>
<font color=#447700>! jpoints = 1  u       u       |<a name='418'></font>
<font color=#447700>!              |               |<a name='419'></font>
<font color=#447700>!    jpos      U               |<a name='420'></font>
<font color=#447700>!              |               |<a name='421'></font>
<font color=#447700>! jpoints = 0, u       u       |<a name='422'></font>
<font color=#447700>! nj=1         |               |<a name='423'></font>
<font color=#447700>!              |---------------|<a name='424'></font>
<font color=#447700>! <a name='425'></font>
<font color=#447700>!              ^               <a name='426'></font>
<font color=#447700>!              |              <a name='427'></font>
<font color=#447700>!              |             <a name='428'></font>
<font color=#447700>!            ipos           <a name='429'></font>
<font color=#447700>!     ni =     1               3<a name='430'></font>
<font color=#447700>! ipoints=     0       1       0 <a name='431'></font>
<font color=#447700>!<a name='432'></font>
<a name='433'>
           DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='434'>
              nj = (cj-jpos)*nrj + 1<a name='435'>
              DO ck = ckts, ckte<a name='436'>
                 nk = ck<a name='437'>
                 DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='438'>
                    ni = (ci-ipos)*nri + 1<a name='439'>
                    cfld( ci, ck, cj ) = 0.<a name='440'>
                    DO ijpoints = 1 , nri*nrj , nri<a name='441'>
                       ipoints = MOD((ijpoints-1),nri)<a name='442'>
                       jpoints = (ijpoints-1)/nri<a name='443'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='444'>
                                             1./REAL(nri    ) * nfld( ni+ipoints , nk , nj+jpoints )<a name='445'>
                    END DO<a name='446'>
<font color=#447700>!                cfld( ci, ck, cj ) =  1./2. * &amp;<a name='447'></font>
<font color=#447700>!                                      ( nfld( ni  , nk , nj  ) + &amp;<a name='448'></font>
<font color=#447700>!                                        nfld( ni  , nk , nj+1) )<a name='449'></font>
                 ENDDO<a name='450'>
              ENDDO<a name='451'>
           ENDDO<a name='452'>
<a name='453'>
        <font color=#447700>!  V <a name='454'></font>
<a name='455'>
        ELSE IF ( ( .NOT. xstag ) .AND. (       ystag ) ) THEN<a name='456'>
           DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='457'>
              nj = (cj-jpos)*nrj + 1<a name='458'>
              DO ck = ckts, ckte<a name='459'>
                 nk = ck<a name='460'>
                 DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='461'>
                    ni = (ci-ipos)*nri + 1<a name='462'>
                    cfld( ci, ck, cj ) = 0.<a name='463'>
                    DO ijpoints = 1 , nri<a name='464'>
                       ipoints = MOD((ijpoints-1),nri)<a name='465'>
                       jpoints = (ijpoints-1)/nri<a name='466'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='467'>
                                             1./REAL(nri    ) * nfld( ni+ipoints , nk , nj+jpoints )<a name='468'>
                    END DO<a name='469'>
<font color=#447700>!                cfld( ci, ck, cj ) =  1./2. * &amp;<a name='470'></font>
<font color=#447700>!                                      ( nfld( ni  , nk , nj  ) + &amp;<a name='471'></font>
<font color=#447700>!                                        nfld( ni+1, nk , nj  ) )<a name='472'></font>
                 ENDDO<a name='473'>
              ENDDO<a name='474'>
           ENDDO<a name='475'>
        END IF<a name='476'>
     END IF<a name='477'>
<a name='478'>
     RETURN<a name='479'>
<a name='480'>
   END SUBROUTINE copy_fcn<a name='481'>
<a name='482'>
<font color=#447700>!==================================<a name='483'></font>
<font color=#447700>! this is the 1pt function used in feedback.<a name='484'></font>
<a name='485'>
<A NAME='COPY_FCNM'><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='486'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>copy_fcnm</font> (  cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/COPY_FCNM.html' TARGET='index'>3</A>,<A href='../../call_from/COPY_FCNM.html' TARGET='index'>2</A><a name='487'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='488'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='489'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='490'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='491'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='492'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='493'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='494'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='495'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='496'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='497'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='498'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='499'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_115"><a name='500'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_43"><a name='501'>
     IMPLICIT NONE<a name='502'>
<a name='503'>
<a name='504'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='505'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='506'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='507'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='508'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='509'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='510'>
                            shw,                                  &amp;<a name='511'>
                            ipos, jpos,                           &amp;<a name='512'>
                            nri, nrj<a name='513'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='514'>
<a name='515'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(OUT) :: cfld<a name='516'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ), INTENT(IN) :: nfld<a name='517'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ), INTENT(IN) :: imask<a name='518'>
<a name='519'>
     <font color=#447700>! Local<a name='520'></font>
<a name='521'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp, ioff, joff, ioffa, joffa<a name='522'>
     INTEGER :: icmin,icmax,jcmin,jcmax<a name='523'>
     INTEGER :: istag,jstag, ipoints,jpoints,ijpoints<a name='524'>
     INTEGER , PARAMETER :: passes = 2<a name='525'>
<a name='526'>
     istag = 1 ; jstag = 1<a name='527'>
     IF ( xstag ) istag = 0<a name='528'>
     IF ( ystag ) jstag = 0<a name='529'>
<a name='530'>
     IF( MOD(nrj,2) .NE. 0) THEN  <font color=#447700>! odd refinement ratio<a name='531'></font>
<a name='532'>
        DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='533'>
           nj = (cj-jpos)*nrj + jstag + 1<a name='534'>
           DO ck = ckts, ckte<a name='535'>
              nk = ck<a name='536'>
              DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='537'>
                 ni = (ci-ipos)*nri + istag + 1<a name='538'>
                 cfld( ci, ck, cj ) =  nfld( ni  , nk , nj  )<a name='539'>
              ENDDO<a name='540'>
           ENDDO<a name='541'>
        ENDDO<a name='542'>
<a name='543'>
     ELSE  <font color=#447700>! even refinement ratio, pick nearest neighbor on SW corner<a name='544'></font>
        DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='545'>
           nj = (cj-jpos)*nrj + 1<a name='546'>
           DO ck = ckts, ckte<a name='547'>
              nk = ck<a name='548'>
              DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='549'>
                 ni = (ci-ipos)*nri + 1<a name='550'>
                 ipoints = nri/2 -1<a name='551'>
                 jpoints = nrj/2 -1<a name='552'>
                 cfld( ci, ck, cj ) =  nfld( ni+ipoints , nk , nj+jpoints )<a name='553'>
              END DO<a name='554'>
           END DO<a name='555'>
        END DO<a name='556'>
<a name='557'>
     END IF<a name='558'>
<a name='559'>
     RETURN<a name='560'>
<a name='561'>
   END SUBROUTINE copy_fcnm<a name='562'>
<a name='563'>
<font color=#447700>!==================================<a name='564'></font>
<font color=#447700>! this is the 1pt function used in feedback for integers<a name='565'></font>
<a name='566'>
<A NAME='COPY_FCNI'><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='567'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>copy_fcni</font> ( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/COPY_FCNI.html' TARGET='index'>1</A>,<A href='../../call_from/COPY_FCNI.html' TARGET='index'>2</A><a name='568'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='569'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='570'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='571'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='572'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='573'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='574'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='575'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='576'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='577'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='578'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='579'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='580'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_116"><a name='581'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_44"><a name='582'>
     IMPLICIT NONE<a name='583'>
<a name='584'>
<a name='585'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='586'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='587'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='588'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='589'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='590'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='591'>
                            shw,                                  &amp;<a name='592'>
                            ipos, jpos,                           &amp;<a name='593'>
                            nri, nrj<a name='594'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='595'>
<a name='596'>
     INTEGER, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(OUT) :: cfld<a name='597'>
     INTEGER, DIMENSION ( nims:nime, nkms:nkme, njms:njme ), INTENT(IN) :: nfld<a name='598'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ), INTENT(IN)  :: imask<a name='599'>
<a name='600'>
     <font color=#447700>! Local<a name='601'></font>
<a name='602'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp, ioff, joff, ioffa, joffa<a name='603'>
     INTEGER :: icmin,icmax,jcmin,jcmax<a name='604'>
     INTEGER :: istag,jstag, ipoints,jpoints,ijpoints<a name='605'>
     INTEGER , PARAMETER :: passes = 2<a name='606'>
<a name='607'>
     istag = 1 ; jstag = 1<a name='608'>
     IF ( xstag ) istag = 0<a name='609'>
     IF ( ystag ) jstag = 0<a name='610'>
<a name='611'>
     IF( MOD(nrj,2) .NE. 0) THEN  <font color=#447700>! odd refinement ratio<a name='612'></font>
<a name='613'>
        DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='614'>
           nj = (cj-jpos)*nrj + jstag + 1<a name='615'>
           DO ck = ckts, ckte<a name='616'>
              nk = ck<a name='617'>
              DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='618'>
                 ni = (ci-ipos)*nri + istag + 1<a name='619'>
                 cfld( ci, ck, cj ) =  nfld( ni  , nk , nj  )<a name='620'>
              ENDDO<a name='621'>
           ENDDO<a name='622'>
        ENDDO<a name='623'>
<a name='624'>
     ELSE  <font color=#447700>! even refinement ratio<a name='625'></font>
        DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='626'>
           nj = (cj-jpos)*nrj + 1<a name='627'>
           DO ck = ckts, ckte<a name='628'>
              nk = ck<a name='629'>
              DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='630'>
                 ni = (ci-ipos)*nri + 1<a name='631'>
                 ipoints = nri/2 -1<a name='632'>
                 jpoints = nrj/2 -1<a name='633'>
                 cfld( ci, ck, cj ) =  nfld( ni+ipoints , nk , nj+jpoints )<a name='634'>
              END DO<a name='635'>
           END DO<a name='636'>
        END DO<a name='637'>
<a name='638'>
     END IF<a name='639'>
<a name='640'>
     RETURN<a name='641'>
<a name='642'>
   END SUBROUTINE copy_fcni<a name='643'>
<a name='644'>
<font color=#447700>!==================================<a name='645'></font>
<a name='646'>
<A NAME='BDY_INTERP'><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='647'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>bdy_interp</font> ( cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/BDY_INTERP.html' TARGET='index'>2</A><a name='648'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='649'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='650'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='651'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='652'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='653'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='654'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='655'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='656'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='657'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='658'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='659'></font>
                           nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='660'></font>
                           cdt, ndt,                             &amp;<a name='661'>
                           cbdy, nbdy,                           &amp;<a name='662'>
                           cbdy_t, nbdy_t                        &amp;<a name='663'>
                           )   <font color=#447700>! boundary arrays<a name='664'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_117"><a name='665'>
     IMPLICIT NONE<a name='666'>
<a name='667'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='668'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='669'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='670'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='671'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='672'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='673'>
                            shw,                                  &amp;<a name='674'>
                            ipos, jpos,                           &amp;<a name='675'>
                            nri, nrj<a name='676'>
<a name='677'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='678'>
<a name='679'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='680'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='681'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='682'>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: cbdy, cbdy_t, nbdy, nbdy_t<a name='683'>
     REAL cdt, ndt<a name='684'>
<a name='685'>
     <font color=#447700>! Local<a name='686'></font>
<a name='687'>
     INTEGER nijds, nijde, spec_bdy_width<a name='688'>
<a name='689'>
     nijds = min(nids, njds)<a name='690'>
     nijde = max(nide, njde)<a name='691'>
     CALL nl_get_spec_bdy_width( 1, spec_bdy_width )<a name='692'>
<a name='693'>
     CALL <A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1'>bdy_interp1</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BDY_INTERP1_1">( cfld,                                 &amp;  <font color=#447700>! CD field<a name='694'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='695'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='696'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='697'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='698'></font>
                           nijds, nijde , spec_bdy_width ,       &amp;  <a name='699'>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='700'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='701'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='702'>
                           shw, imask,                           &amp;<a name='703'>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='704'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='705'></font>
                           nri, nrj,                             &amp;<a name='706'>
                           cdt, ndt,                             &amp;<a name='707'>
                           cbdy, nbdy,                           &amp;<a name='708'>
                           cbdy_t, nbdy_t                        &amp;<a name='709'>
                                        )<a name='710'>
<a name='711'>
     RETURN<a name='712'>
<a name='713'>
   END SUBROUTINE bdy_interp<a name='714'>
<a name='715'>
<A NAME='BDY_INTERP1'><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='716'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>bdy_interp1</font>( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/BDY_INTERP1.html' TARGET='index'>1</A>,<A href='../../call_from/BDY_INTERP1.html' TARGET='index'>7</A><a name='717'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='718'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='719'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='720'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='721'></font>
                           nijds, nijde, spec_bdy_width ,          &amp;<a name='722'>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='723'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='724'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='725'>
                           shw1,                                 &amp;<a name='726'>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='727'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='728'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='729'></font>
                           nri, nrj,                             &amp;<a name='730'>
                           cdt, ndt,                             &amp;<a name='731'>
                           cbdy, bdy,                            &amp;<a name='732'>
                           cbdy_t, bdy_t                         &amp;<a name='733'>
                                        )<a name='734'>
<a name='735'>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_118"><a name='736'>
     use module_state_description<a name='737'>
     IMPLICIT NONE<a name='738'>
<a name='739'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='740'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='741'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='742'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='743'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='744'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='745'>
                            shw1,                                 &amp;  <font color=#447700>! ignore<a name='746'></font>
                            ipos, jpos,                           &amp;<a name='747'>
                            nri, nrj<a name='748'>
     INTEGER, INTENT(IN) :: nijds, nijde, spec_bdy_width<a name='749'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='750'>
<a name='751'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(INOUT) :: cfld<a name='752'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ), INTENT(INOUT) :: nfld<a name='753'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='754'>
     REAL, DIMENSION ( * ), INTENT(INOUT) :: cbdy, cbdy_t   <font color=#447700>! not used<a name='755'></font>
     REAL                                 :: cdt, ndt<a name='756'>
     REAL, DIMENSION ( nijds:nijde, nkms:nkme, spec_bdy_width, 4 ), INTENT(INOUT) :: bdy, bdy_t<a name='757'>
<a name='758'>
     <font color=#447700>! Local<a name='759'></font>
<a name='760'>
     REAL*8 rdt<a name='761'>
     INTEGER ci, cj, ck, ni, nj, nk, ni1, nj1, nk1, ip, jp, ioff, joff<a name='762'>
#ifdef MM5_SINT<a name='763'>
     INTEGER nfx, ior<a name='764'>
     PARAMETER (ior=2)<a name='765'>
     INTEGER nf<a name='766'>
     REAL psca1(cims:cime,cjms:cjme,nri*nrj)<a name='767'>
     REAL psca(cims:cime,cjms:cjme,nri*nrj)<a name='768'>
     LOGICAL icmask( cims:cime, cjms:cjme )<a name='769'>
     INTEGER i,j,k<a name='770'>
#endif<a name='771'>
     INTEGER shw<a name='772'>
     INTEGER spec_zone <a name='773'>
     INTEGER relax_zone<a name='774'>
     INTEGER sz<a name='775'>
     INTEGER n2ci,n<a name='776'>
     INTEGER n2cj<a name='777'>
<a name='778'>
<font color=#447700>! statement functions for converting a nest index to coarse<a name='779'></font>
     n2ci(n) = (n+ipos*nri-1)/nri<a name='780'>
     n2cj(n) = (n+jpos*nrj-1)/nrj<a name='781'>
<a name='782'>
     rdt = 1.D0/cdt<a name='783'>
<a name='784'>
     shw = 0<a name='785'>
<a name='786'>
     ioff = 0 ; joff = 0<a name='787'>
     IF ( xstag ) ioff = (nri-1)/2<a name='788'>
     IF ( ystag ) joff = (nrj-1)/2<a name='789'>
<a name='790'>
     <font color=#447700>! Iterate over the ND tile and compute the values<a name='791'></font>
     <font color=#447700>! from the CD tile. <a name='792'></font>
<a name='793'>
#ifdef MM5_SINT<a name='794'>
     CALL nl_get_spec_zone( 1, spec_zone )<a name='795'>
     CALL nl_get_relax_zone( 1, relax_zone )<a name='796'>
     sz = MIN(MAX( spec_zone, relax_zone ),spec_bdy_width)<a name='797'>
<a name='798'>
     nfx = nri * nrj<a name='799'>
<a name='800'>
#ifndef crayx1<a name='801'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='802'></font>
   <font color=#447700>!$OMP PRIVATE ( i,j,k,ni,nj,ni1,nj1,ci,cj,ip,jp,nk,ck,nf,icmask,psca,psca1 )<a name='803'></font>
#endif<a name='804'>
     DO k = ckts, ckte<a name='805'>
<a name='806'>
        DO nf = 1,nfx<a name='807'>
           DO j = cjms,cjme<a name='808'>
              nj = (j-jpos) * nrj + 2   <font color=#447700>! j point on nest<a name='809'></font>
              DO i = cims,cime<a name='810'>
                ni = (i-ipos) * nri + 2   <font color=#447700>! i point on nest<a name='811'></font>
                psca1(i,j,nf) = cfld(i,k,j)<a name='812'>
              ENDDO<a name='813'>
           ENDDO<a name='814'>
        ENDDO<a name='815'>
<font color=#447700>! hopefully less ham handed but still correct and more efficient<a name='816'></font>
<font color=#447700>! sintb ignores icmask so it does not matter that icmask is not set<a name='817'></font>
<font color=#447700>!<a name='818'></font>
<font color=#447700>! SOUTH BDY<a name='819'></font>
               IF   ( njts .ge. njds .and. njts .le. njds + sz - 1  ) THEN<a name='820'>
        CALL <A href='../../html_code/share/sint.F.html#SINTB'>sintb</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINTB_1">( psca1, psca,                     &amp;<a name='821'>
          cims, cime, cjms, cjme, icmask,  &amp;<a name='822'>
          n2ci(nits)-1, n2ci(nite)+1, n2cj(MAX(njts,njds)), n2cj(MIN(njte,njds+sz-1)), nrj*nri, xstag, ystag )<a name='823'>
               ENDIF<a name='824'>
<font color=#447700>! NORTH BDY<a name='825'></font>
               IF ( ystag ) THEN<a name='826'>
                 IF   ( njte .le. njde .and. njte .ge. njde - sz + 1 ) THEN<a name='827'>
        CALL <A href='../../html_code/share/sint.F.html#SINTB'>sintb</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINTB_2">( psca1, psca,                     &amp;<a name='828'>
          cims, cime, cjms, cjme, icmask,  &amp;<a name='829'>
          n2ci(nits)-1, n2ci(nite)+1, n2cj(MAX(njts,njde-sz+1)), n2cj(MIN(njte,njde)), nrj*nri, xstag, ystag )<a name='830'>
                 ENDIF<a name='831'>
               ELSE<a name='832'>
                 IF   ( njte .le. njde .and. njte .ge. njde - sz ) THEN<a name='833'>
        CALL <A href='../../html_code/share/sint.F.html#SINTB'>sintb</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINTB_3">( psca1, psca,                     &amp;<a name='834'>
          cims, cime, cjms, cjme, icmask,  &amp;<a name='835'>
          n2ci(nits)-1, n2ci(nite)+1, n2cj(MAX(njts,njde-sz)), n2cj(MIN(njte,njde-1)), nrj*nri, xstag, ystag )<a name='836'>
                 ENDIF<a name='837'>
               ENDIF<a name='838'>
<font color=#447700>! WEST BDY<a name='839'></font>
               IF   ( nits .ge. nids .and. nits .le. nids + sz - 1 ) THEN<a name='840'>
        CALL <A href='../../html_code/share/sint.F.html#SINTB'>sintb</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINTB_4">( psca1, psca,                     &amp;<a name='841'>
          cims, cime, cjms, cjme, icmask,  &amp;<a name='842'>
          n2ci(MAX(nits,nids)), n2ci(MIN(nite,nids+sz-1)), n2cj(njts)-1, n2cj(njte)+1, nrj*nri, xstag, ystag )<a name='843'>
               ENDIF<a name='844'>
<font color=#447700>! EAST BDY<a name='845'></font>
               IF ( xstag ) THEN<a name='846'>
                 IF   ( nite .le. nide .and. nite .ge. nide - sz + 1 ) THEN<a name='847'>
        CALL <A href='../../html_code/share/sint.F.html#SINTB'>sintb</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINTB_5">( psca1, psca,                     &amp;<a name='848'>
          cims, cime, cjms, cjme, icmask,  &amp;<a name='849'>
          n2ci(MAX(nits,nide-sz+1)), n2ci(MIN(nite,nide)), n2cj(njts)-1, n2cj(njte)+1, nrj*nri, xstag, ystag )<a name='850'>
                 ENDIF<a name='851'>
               ELSE<a name='852'>
                 IF   ( nite .le. nide .and. nite .ge. nide - sz ) THEN<a name='853'>
        CALL <A href='../../html_code/share/sint.F.html#SINTB'>sintb</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINTB_6">( psca1, psca,                     &amp;<a name='854'>
          cims, cime, cjms, cjme, icmask,  &amp;<a name='855'>
          n2ci(MAX(nits,nide-sz)), n2ci(MIN(nite,nide-1)), n2cj(njts)-1, n2cj(njte)+1, nrj*nri, xstag, ystag )<a name='856'>
                 ENDIF<a name='857'>
               ENDIF<a name='858'>
<a name='859'>
        DO nj1 = njts, njte+joff<a name='860'>
           cj = jpos + (nj1-1) / nrj     <font color=#447700>! j coord of CD point <a name='861'></font>
           jp = mod ( nj1-1 , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='862'></font>
           nk = k<a name='863'>
           ck = nk<a name='864'>
           DO ni1 = nits, nite+ioff<a name='865'>
               ci = ipos + (ni1-1) / nri      <font color=#447700>! j coord of CD point <a name='866'></font>
               ip = mod ( ni1-1 , nri )  <font color=#447700>! coord of ND w/i CD point<a name='867'></font>
<a name='868'>
               ni = ni1-ioff<a name='869'>
               nj = nj1-joff<a name='870'>
<a name='871'>
               IF ( ( ni.LT.nids) .OR. (nj.LT.njds) ) THEN<a name='872'>
                  CYCLE<a name='873'>
               END IF<a name='874'>
<a name='875'>
<font color=#447700>!bdy contains the value at t-dt. psca contains the value at t<a name='876'></font>
<font color=#447700>!compute dv/dt and store in bdy_t<a name='877'></font>
<font color=#447700>!afterwards store the new value of v at t into bdy<a name='878'></font>
<a name='879'>
               IF   ( ni .ge. nids .and. ni .lt. nids + sz ) THEN<a name='880'>
                 bdy_t( nj,k,ni, P_XSB ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='881'>
                 bdy( nj,k,ni, P_XSB ) = psca(ci+shw,cj+shw,ip+1+(jp)*nri )<a name='882'>
               ENDIF<a name='883'>
<a name='884'>
               IF   ( nj .ge. njds .and. nj .lt. njds + sz ) THEN<a name='885'>
                 bdy_t( ni,k,nj, P_YSB ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='886'>
                 bdy( ni,k,nj, P_YSB ) = psca(ci+shw,cj+shw,ip+1+(jp)*nri )<a name='887'>
               ENDIF<a name='888'>
<a name='889'>
               IF ( xstag ) THEN<a name='890'>
                 IF   ( ni .le. nide .and. ni .ge. nide - sz + 1 ) THEN<a name='891'>
                   bdy_t( nj,k,nide-ni+1, P_XEB ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='892'>
                   bdy( nj,k,nide-ni+1, P_XEB ) = psca(ci+shw,cj+shw,ip+1+(jp)*nri )<a name='893'>
                 ENDIF<a name='894'>
               ELSE<a name='895'>
                 IF   ( ni .le. nide-1 .and. ni .ge. nide - sz ) THEN<a name='896'>
                   bdy_t( nj,k,nide-ni, P_XEB ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='897'>
                   bdy( nj,k,nide-ni, P_XEB ) = psca(ci+shw,cj+shw,ip+1+(jp)*nri )<a name='898'>
                 ENDIF<a name='899'>
               ENDIF<a name='900'>
<a name='901'>
               IF ( ystag ) THEN<a name='902'>
                 IF   ( nj .le. njde .and. nj .ge. njde - sz + 1 ) THEN<a name='903'>
                   bdy_t(ni,k,njde-nj+1,P_YEB ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='904'>
                   bdy( ni,k,njde-nj+1,P_YEB ) = psca(ci+shw,cj+shw,ip+1+(jp)*nri )<a name='905'>
                 ENDIF<a name='906'>
               ELSE<a name='907'>
                 IF   ( nj .le. njde-1 .and. nj .ge. njde - sz ) THEN<a name='908'>
                   bdy_t(ni,k,njde-nj,P_YEB ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='909'>
                   bdy( ni,k,njde-nj,P_YEB ) = psca(ci+shw,cj+shw,ip+1+(jp)*nri )<a name='910'>
                 ENDIF<a name='911'>
               ENDIF<a name='912'>
<a name='913'>
           ENDDO<a name='914'>
        ENDDO<a name='915'>
     ENDDO<a name='916'>
#ifndef crayx1<a name='917'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='918'></font>
#endif<a name='919'>
#endif<a name='920'>
<a name='921'>
#ifdef DUMBCOPY<a name='922'>
<font color=#447700>!write(0,'("cims:cime, ckms:ckme, cjms:cjme ",6i4)')cims,cime, ckms,ckme, cjms,cjme<a name='923'></font>
<font color=#447700>!write(0,'("nims:nime, nkms:nkme, njms:njme ",6i4)')nims,nime, nkms,nkme, njms,njme<a name='924'></font>
<font color=#447700>!write(0,'("cits:cite, ckts:ckte, cjts:cjte ",6i4)')cits,cite, ckts,ckte, cjts,cjte<a name='925'></font>
<font color=#447700>!write(0,'("nits:nite, nkts:nkte, njts:njte ",6i4)')nits,nite, nkts,nkte, njts,njte<a name='926'></font>
<a name='927'>
     DO nj = njts, njte<a name='928'>
        cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point <a name='929'></font>
        jp = mod ( nj , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='930'></font>
        DO nk = nkts, nkte<a name='931'>
           ck = nk<a name='932'>
           DO ni = nits, nite<a name='933'>
              ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point <a name='934'></font>
              ip = mod ( ni , nri )  <font color=#447700>! coord of ND w/i CD point<a name='935'></font>
              <font color=#447700>! This is a trivial implementation of the interp_fcn; just copies<a name='936'></font>
              <font color=#447700>! the values from the CD into the ND<a name='937'></font>
              nfld( ni, nk, nj ) = cfld( ci , ck , cj )<a name='938'>
           ENDDO<a name='939'>
        ENDDO<a name='940'>
     ENDDO<a name='941'>
#endif<a name='942'>
<a name='943'>
     RETURN<a name='944'>
<a name='945'>
   END SUBROUTINE bdy_interp1<a name='946'>
<a name='947'>
<a name='948'>
<a name='949'>
<A NAME='INTERP_FCNI'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='950'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcni</font>( cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/INTERP_FCNI.html' TARGET='index'>1</A><a name='951'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='952'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='953'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='954'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='955'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='956'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='957'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='958'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='959'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='960'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='961'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='962'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='963'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_119"><a name='964'>
     IMPLICIT NONE<a name='965'>
<a name='966'>
<a name='967'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='968'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='969'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='970'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='971'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='972'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='973'>
                            shw,                                  &amp;<a name='974'>
                            ipos, jpos,                           &amp;<a name='975'>
                            nri, nrj<a name='976'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='977'>
<a name='978'>
     INTEGER, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='979'>
     INTEGER, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='980'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='981'>
<a name='982'>
     <font color=#447700>! Local<a name='983'></font>
<a name='984'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='985'>
<a name='986'>
     <font color=#447700>! Iterate over the ND tile and compute the values<a name='987'></font>
     <font color=#447700>! from the CD tile. <a name='988'></font>
<a name='989'>
<font color=#447700>!write(0,'("cits:cite, ckts:ckte, cjts:cjte ",6i4)')cits,cite, ckts,ckte, cjts,cjte<a name='990'></font>
<font color=#447700>!write(0,'("nits:nite, nkts:nkte, njts:njte ",6i4)')nits,nite, nkts,nkte, njts,njte<a name='991'></font>
<a name='992'>
     DO nj = njts, njte<a name='993'>
        cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point <a name='994'></font>
        jp = mod ( nj , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='995'></font>
        DO nk = nkts, nkte<a name='996'>
           ck = nk<a name='997'>
           DO ni = nits, nite<a name='998'>
              ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point <a name='999'></font>
              ip = mod ( ni , nri )  <font color=#447700>! coord of ND w/i CD point<a name='1000'></font>
              <font color=#447700>! This is a trivial implementation of the interp_fcn; just copies<a name='1001'></font>
              <font color=#447700>! the values from the CD into the ND<a name='1002'></font>
              nfld( ni, nk, nj ) = cfld( ci , ck , cj )<a name='1003'>
           ENDDO<a name='1004'>
        ENDDO<a name='1005'>
     ENDDO<a name='1006'>
<a name='1007'>
     RETURN<a name='1008'>
<a name='1009'>
   END SUBROUTINE interp_fcni<a name='1010'>
<a name='1011'>
<A NAME='INTERP_FCNM'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1012'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcnm</font>( cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/INTERP_FCNM.html' TARGET='index'>1</A><a name='1013'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1014'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1015'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1016'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='1017'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1018'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1019'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1020'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='1021'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='1022'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1023'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='1024'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='1025'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_120"><a name='1026'>
     IMPLICIT NONE<a name='1027'>
<a name='1028'>
<a name='1029'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1030'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1031'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1032'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1033'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1034'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1035'>
                            shw,                                  &amp;<a name='1036'>
                            ipos, jpos,                           &amp;<a name='1037'>
                            nri, nrj<a name='1038'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='1039'>
<a name='1040'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='1041'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='1042'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='1043'>
<a name='1044'>
     <font color=#447700>! Local<a name='1045'></font>
<a name='1046'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='1047'>
<a name='1048'>
     <font color=#447700>! Iterate over the ND tile and compute the values<a name='1049'></font>
     <font color=#447700>! from the CD tile. <a name='1050'></font>
<a name='1051'>
<font color=#447700>!write(0,'("mask cits:cite, ckts:ckte, cjts:cjte ",6i4)')cits,cite, ckts,ckte, cjts,cjte<a name='1052'></font>
<font color=#447700>!write(0,'("mask nits:nite, nkts:nkte, njts:njte ",6i4)')nits,nite, nkts,nkte, njts,njte<a name='1053'></font>
<a name='1054'>
     DO nj = njts, njte<a name='1055'>
        cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point <a name='1056'></font>
        jp = mod ( nj , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='1057'></font>
        DO nk = nkts, nkte<a name='1058'>
           ck = nk<a name='1059'>
           DO ni = nits, nite<a name='1060'>
              ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point <a name='1061'></font>
              ip = mod ( ni , nri )  <font color=#447700>! coord of ND w/i CD point<a name='1062'></font>
              <font color=#447700>! This is a trivial implementation of the interp_fcn; just copies<a name='1063'></font>
              <font color=#447700>! the values from the CD into the ND<a name='1064'></font>
              nfld( ni, nk, nj ) = cfld( ci , ck , cj )<a name='1065'>
           ENDDO<a name='1066'>
        ENDDO<a name='1067'>
     ENDDO<a name='1068'>
<a name='1069'>
     RETURN<a name='1070'>
<a name='1071'>
   END SUBROUTINE interp_fcnm<a name='1072'>
<a name='1073'>
<A NAME='INTERP_MASK_LAND_FIELD'><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1074'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_mask_land_field</font> ( cfld,                     &amp;  <font color=#447700>! CD field,<A href='../../call_from/INTERP_MASK_LAND_FIELD.html' TARGET='index'>5</A><a name='1075'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1076'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1077'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1078'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='1079'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1080'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1081'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1082'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='1083'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='1084'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1085'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='1086'></font>
                           nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='1087'></font>
                           clu, nlu                              )<a name='1088'>
<a name='1089'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_121"><a name='1090'>
      USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_45"><a name='1091'>
<a name='1092'>
      IMPLICIT NONE<a name='1093'>
   <a name='1094'>
   <a name='1095'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1096'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1097'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1098'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1099'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1100'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1101'>
                             shw,                                  &amp;<a name='1102'>
                             ipos, jpos,                           &amp;<a name='1103'>
                             nri, nrj<a name='1104'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='1105'>
   <a name='1106'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='1107'>
      REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='1108'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='1109'>
   <a name='1110'>
      REAL, DIMENSION ( cims:cime, cjms:cjme ) :: clu<a name='1111'>
      REAL, DIMENSION ( nims:nime, njms:njme ) :: nlu<a name='1112'>
   <a name='1113'>
      <font color=#447700>! Local<a name='1114'></font>
   <a name='1115'>
      INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='1116'>
      INTEGER :: icount , ii , jj , ist , ien , jst , jen , iswater<a name='1117'>
      REAL :: avg , sum , dx , dy<a name='1118'>
      INTEGER , PARAMETER :: max_search = 5<a name='1119'>
      CHARACTER*120 message<a name='1120'>
   <a name='1121'>
      <font color=#447700>!  Find out what the water value is.<a name='1122'></font>
   <a name='1123'>
      CALL nl_get_iswater(1,iswater)<a name='1124'>
<a name='1125'>
      <font color=#447700>!  Right now, only mass point locations permitted.<a name='1126'></font>
   <a name='1127'>
      IF ( ( .NOT. xstag) .AND. ( .NOT. ystag ) ) THEN<a name='1128'>
<a name='1129'>
         <font color=#447700>!  Loop over each i,k,j in the nested domain.<a name='1130'></font>
<a name='1131'>
         DO nj = njts, njte<a name='1132'>
            cj = ( nj + 1) / nrj + jpos -1 <font color=#447700>! coarse position equal to or below nest point<a name='1133'></font>
            DO nk = nkts, nkte<a name='1134'>
               ck = nk<a name='1135'>
               DO ni = nits, nite<a name='1136'>
                  ci = ( ni + 1) / nri + ipos -1 <font color=#447700>! coarse position equal to or to the left of nest point<a name='1137'></font>
   <a name='1138'>
<a name='1139'>
<a name='1140'>
<a name='1141'>
                  <font color=#447700>!<a name='1142'></font>
                  <font color=#447700>!                    (ci,cj+1)     (ci+1,cj+1)<a name='1143'></font>
                  <font color=#447700>!               -        -------------<a name='1144'></font>
                  <font color=#447700>!         1-dy  |        |           |<a name='1145'></font>
                  <font color=#447700>!               |        |           |<a name='1146'></font>
                  <font color=#447700>!               -        |  *        |<a name='1147'></font>
                  <font color=#447700>!          dy   |        | (ni,nj)   |<a name='1148'></font>
                  <font color=#447700>!               |        |           |<a name='1149'></font>
                  <font color=#447700>!               -        -------------<a name='1150'></font>
                  <font color=#447700>!                    (ci,cj)       (ci+1,cj)  <a name='1151'></font>
                  <font color=#447700>!<a name='1152'></font>
                  <font color=#447700>!                        |--|--------|<a name='1153'></font>
                  <font color=#447700>!                         dx  1-dx         <a name='1154'></font>
<a name='1155'>
<a name='1156'>
                  <font color=#447700>!  At ni=2, we are on the coarse grid point, so dx = 0<a name='1157'></font>
<a name='1158'>
                  dx = REAL ( MOD ( ni+1 , nri ) ) / REAL ( nri ) <a name='1159'>
                  dy = REAL ( MOD ( nj+1 , nrj ) ) / REAL ( nrj ) <a name='1160'>
   <a name='1161'>
                  <font color=#447700>!  This is a "land only" field.  If this is a water point, no operations required.<a name='1162'></font>
<a name='1163'>
                  IF      ( ( NINT(nlu(ni  ,nj  )) .EQ. iswater ) ) THEN<a name='1164'>
                     <font color=#447700>! noop<a name='1165'></font>
<font color=#447700>!                    nfld(ni,nk,nj) =  1.e20<a name='1166'></font>
                     nfld(ni,nk,nj) =  -1<a name='1167'>
<a name='1168'>
                  <font color=#447700>!  If this is a nested land point, and the surrounding coarse values are all land points,<a name='1169'></font>
                  <font color=#447700>!  then this is a simple 4-pt interpolation.<a name='1170'></font>
<a name='1171'>
                  ELSE IF ( ( NINT(nlu(ni  ,nj  )) .NE. iswater ) .AND. &amp;<a name='1172'>
                            ( NINT(clu(ci  ,cj  )) .NE. iswater ) .AND. &amp;<a name='1173'>
                            ( NINT(clu(ci+1,cj  )) .NE. iswater ) .AND. &amp;<a name='1174'>
                            ( NINT(clu(ci  ,cj+1)) .NE. iswater ) .AND. &amp;<a name='1175'>
                            ( NINT(clu(ci+1,cj+1)) .NE. iswater ) ) THEN<a name='1176'>
                     nfld(ni,nk,nj) = ( 1. - dx ) * ( ( 1. - dy ) * cfld(ci  ,ck,cj  )   + &amp;<a name='1177'>
                                                             dy   * cfld(ci  ,ck,cj+1) ) + &amp;<a name='1178'>
                                             dx   * ( ( 1. - dy ) * cfld(ci+1,ck,cj  )   + &amp;<a name='1179'>
                                                             dy   * cfld(ci+1,ck,cj+1) )<a name='1180'>
<a name='1181'>
                  <font color=#447700>!  If this is a nested land point and there are NO coarse land values surrounding,<a name='1182'></font>
                  <font color=#447700>!  we temporarily punt.<a name='1183'></font>
<a name='1184'>
                  ELSE IF ( ( NINT(nlu(ni  ,nj  )) .NE. iswater ) .AND. &amp;<a name='1185'>
                            ( NINT(clu(ci  ,cj  )) .EQ. iswater ) .AND. &amp;<a name='1186'>
                            ( NINT(clu(ci+1,cj  )) .EQ. iswater ) .AND. &amp;<a name='1187'>
                            ( NINT(clu(ci  ,cj+1)) .EQ. iswater ) .AND. &amp;<a name='1188'>
                            ( NINT(clu(ci+1,cj+1)) .EQ. iswater ) ) THEN<a name='1189'>
<font color=#447700>!                    nfld(ni,nk,nj) = -1.e20<a name='1190'></font>
                     nfld(ni,nk,nj) = -1<a name='1191'>
<a name='1192'>
                  <font color=#447700>!  If there are some water points and some land points, take an average. <a name='1193'></font>
                  <a name='1194'>
                  ELSE IF ( NINT(nlu(ni  ,nj  )) .NE. iswater ) THEN<a name='1195'>
                     icount = 0<a name='1196'>
                     sum = 0<a name='1197'>
                     IF ( NINT(clu(ci  ,cj  )) .NE. iswater ) THEN<a name='1198'>
                        icount = icount + 1<a name='1199'>
                        sum = sum + cfld(ci  ,ck,cj  )<a name='1200'>
                     END IF<a name='1201'>
                     IF ( NINT(clu(ci+1,cj  )) .NE. iswater ) THEN<a name='1202'>
                        icount = icount + 1<a name='1203'>
                        sum = sum + cfld(ci+1,ck,cj  )<a name='1204'>
                     END IF<a name='1205'>
                     IF ( NINT(clu(ci  ,cj+1)) .NE. iswater ) THEN<a name='1206'>
                        icount = icount + 1<a name='1207'>
                        sum = sum + cfld(ci  ,ck,cj+1)<a name='1208'>
                     END IF<a name='1209'>
                     IF ( NINT(clu(ci+1,cj+1)) .NE. iswater ) THEN<a name='1210'>
                        icount = icount + 1<a name='1211'>
                        sum = sum + cfld(ci+1,ck,cj+1)<a name='1212'>
                     END IF<a name='1213'>
                     nfld(ni,nk,nj) = sum / REAL ( icount ) <a name='1214'>
                  END IF<a name='1215'>
               END DO<a name='1216'>
            END DO<a name='1217'>
         END DO<a name='1218'>
<a name='1219'>
         <font color=#447700>!  Get an average of the whole domain for problem locations.<a name='1220'></font>
<a name='1221'>
         sum = 0<a name='1222'>
         icount = 0 <a name='1223'>
         DO nj = njts, njte<a name='1224'>
            DO nk = nkts, nkte<a name='1225'>
               DO ni = nits, nite<a name='1226'>
                  IF ( ( nfld(ni,nk,nj) .GT. -1.e19 ) .AND. (  nfld(ni,nk,nj) .LT. 1.e19 ) ) THEN<a name='1227'>
                     icount = icount + 1<a name='1228'>
                     sum = sum + nfld(ni,nk,nj)<a name='1229'>
                  END IF<a name='1230'>
               END DO<a name='1231'>
            END DO<a name='1232'>
         END DO<a name='1233'>
         CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_55">( sum, 1 )<a name='1234'>
         IF ( icount .GT. 0 ) THEN<a name='1235'>
           avg = sum / REAL ( icount ) <a name='1236'>
<a name='1237'>
         <font color=#447700>!  OK, if there were any of those island situations, we try to search a bit broader<a name='1238'></font>
         <font color=#447700>!  of an area in the coarse grid.<a name='1239'></font>
<a name='1240'>
           DO nj = njts, njte<a name='1241'>
              DO nk = nkts, nkte<a name='1242'>
                 DO ni = nits, nite<a name='1243'>
                    IF ( nfld(ni,nk,nj) .LT. -1.e19 ) THEN<a name='1244'>
                       cj = ( nj + 1) / nrj + jpos -1<a name='1245'>
                       ci = ( ni + 1) / nri + ipos -1<a name='1246'>
                       ist = MAX (ci-max_search,cits)<a name='1247'>
                       ien = MIN (ci+max_search,cite,cide-1)<a name='1248'>
                       jst = MAX (cj-max_search,cjts)<a name='1249'>
                       jen = MIN (cj+max_search,cjte,cjde-1)<a name='1250'>
                       icount = 0 <a name='1251'>
                       sum = 0<a name='1252'>
                       DO jj = jst,jen<a name='1253'>
                          DO ii = ist,ien<a name='1254'>
                             IF ( NINT(clu(ii,jj)) .NE. iswater ) THEN<a name='1255'>
                                icount = icount + 1<a name='1256'>
                                sum = sum + cfld(ii,nk,jj)<a name='1257'>
                             END IF<a name='1258'>
                          END DO<a name='1259'>
                       END DO<a name='1260'>
                       IF ( icount .GT. 0 ) THEN<a name='1261'>
                          nfld(ni,nk,nj) = sum / REAL ( icount ) <a name='1262'>
                       ELSE<a name='1263'>
<font color=#447700>!                         CALL wrf_error_fatal ( "horizontal interp error - island" )<a name='1264'></font>
                          write(message,*) 'horizontal interp error - island, using average ', avg<a name='1265'>
                          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_70"> ( message )<a name='1266'>
                          nfld(ni,nk,nj) = avg<a name='1267'>
                       END IF        <a name='1268'>
                    END IF<a name='1269'>
                 END DO<a name='1270'>
              END DO<a name='1271'>
           END DO<a name='1272'>
         ENDIF<a name='1273'>
      ELSE<a name='1274'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_209"> ( "only unstaggered fields right now" )<a name='1275'>
      END IF<a name='1276'>
<a name='1277'>
   END SUBROUTINE interp_mask_land_field<a name='1278'>
<a name='1279'>
<A NAME='INTERP_MASK_WATER_FIELD'><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1280'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_mask_water_field</font> ( cfld,                    &amp;  <font color=#447700>! CD field,<A href='../../call_from/INTERP_MASK_WATER_FIELD.html' TARGET='index'>3</A><a name='1281'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1282'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1283'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1284'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='1285'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1286'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1287'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1288'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='1289'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='1290'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1291'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='1292'></font>
                           nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='1293'></font>
                           clu, nlu                              )<a name='1294'>
<a name='1295'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_122"><a name='1296'>
      USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_46"><a name='1297'>
<a name='1298'>
      IMPLICIT NONE<a name='1299'>
   <a name='1300'>
   <a name='1301'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1302'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1303'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1304'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1305'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1306'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1307'>
                             shw,                                  &amp;<a name='1308'>
                             ipos, jpos,                           &amp;<a name='1309'>
                             nri, nrj<a name='1310'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='1311'>
   <a name='1312'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='1313'>
      REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='1314'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='1315'>
   <a name='1316'>
      REAL, DIMENSION ( cims:cime, cjms:cjme ) :: clu<a name='1317'>
      REAL, DIMENSION ( nims:nime, njms:njme ) :: nlu<a name='1318'>
   <a name='1319'>
      <font color=#447700>! Local<a name='1320'></font>
   <a name='1321'>
      INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='1322'>
      INTEGER :: icount , ii , jj , ist , ien , jst , jen , iswater<a name='1323'>
      REAL :: avg , sum , dx , dy<a name='1324'>
      INTEGER , PARAMETER :: max_search = 5<a name='1325'>
   <a name='1326'>
      <font color=#447700>!  Find out what the water value is.<a name='1327'></font>
   <a name='1328'>
      CALL nl_get_iswater(1,iswater)<a name='1329'>
<a name='1330'>
      <font color=#447700>!  Right now, only mass point locations permitted.<a name='1331'></font>
   <a name='1332'>
      IF ( ( .NOT. xstag) .AND. ( .NOT. ystag ) ) THEN<a name='1333'>
<a name='1334'>
         <font color=#447700>!  Loop over each i,k,j in the nested domain.<a name='1335'></font>
<a name='1336'>
         DO nj = njts, njte<a name='1337'>
            cj = ( nj + 1) / nrj + jpos -1 <font color=#447700>! coarse position equal to or below nest point<a name='1338'></font>
            DO nk = nkts, nkte<a name='1339'>
               ck = nk<a name='1340'>
               DO ni = nits, nite<a name='1341'>
                  ci = ( ni + 1) / nri + ipos -1 <font color=#447700>! coarse position equal to or to the left of nest point<a name='1342'></font>
   <a name='1343'>
<a name='1344'>
<a name='1345'>
<a name='1346'>
                  <font color=#447700>!<a name='1347'></font>
                  <font color=#447700>!                    (ci,cj+1)     (ci+1,cj+1)<a name='1348'></font>
                  <font color=#447700>!               -        -------------<a name='1349'></font>
                  <font color=#447700>!         1-dy  |        |           |<a name='1350'></font>
                  <font color=#447700>!               |        |           |<a name='1351'></font>
                  <font color=#447700>!               -        |  *        |<a name='1352'></font>
                  <font color=#447700>!          dy   |        | (ni,nj)   |<a name='1353'></font>
                  <font color=#447700>!               |        |           |<a name='1354'></font>
                  <font color=#447700>!               -        -------------<a name='1355'></font>
                  <font color=#447700>!                    (ci,cj)       (ci+1,cj)  <a name='1356'></font>
                  <font color=#447700>!<a name='1357'></font>
                  <font color=#447700>!                        |--|--------|<a name='1358'></font>
                  <font color=#447700>!                         dx  1-dx         <a name='1359'></font>
<a name='1360'>
<a name='1361'>
                  <font color=#447700>!  At ni=2, we are on the coarse grid point, so dx = 0<a name='1362'></font>
<a name='1363'>
                  dx = REAL ( MOD ( ni+1 , nri ) ) / REAL ( nri ) <a name='1364'>
                  dy = REAL ( MOD ( nj+1 , nrj ) ) / REAL ( nrj ) <a name='1365'>
   <a name='1366'>
                  <font color=#447700>!  This is a "water only" field.  If this is a land point, no operations required.<a name='1367'></font>
<a name='1368'>
                  IF      ( ( NINT(nlu(ni  ,nj  )) .NE. iswater ) ) THEN<a name='1369'>
                     <font color=#447700>! noop<a name='1370'></font>
<font color=#447700>!                    nfld(ni,nk,nj) =  1.e20<a name='1371'></font>
                     nfld(ni,nk,nj) = -1<a name='1372'>
<a name='1373'>
                  <font color=#447700>!  If this is a nested water point, and the surrounding coarse values are all water points,<a name='1374'></font>
                  <font color=#447700>!  then this is a simple 4-pt interpolation.<a name='1375'></font>
<a name='1376'>
                  ELSE IF ( ( NINT(nlu(ni  ,nj  )) .EQ. iswater ) .AND. &amp;<a name='1377'>
                            ( NINT(clu(ci  ,cj  )) .EQ. iswater ) .AND. &amp;<a name='1378'>
                            ( NINT(clu(ci+1,cj  )) .EQ. iswater ) .AND. &amp;<a name='1379'>
                            ( NINT(clu(ci  ,cj+1)) .EQ. iswater ) .AND. &amp;<a name='1380'>
                            ( NINT(clu(ci+1,cj+1)) .EQ. iswater ) ) THEN<a name='1381'>
                     nfld(ni,nk,nj) = ( 1. - dx ) * ( ( 1. - dy ) * cfld(ci  ,ck,cj  )   + &amp;<a name='1382'>
                                                             dy   * cfld(ci  ,ck,cj+1) ) + &amp;<a name='1383'>
                                             dx   * ( ( 1. - dy ) * cfld(ci+1,ck,cj  )   + &amp;<a name='1384'>
                                                             dy   * cfld(ci+1,ck,cj+1) )<a name='1385'>
<a name='1386'>
                  <font color=#447700>!  If this is a nested water point and there are NO coarse water values surrounding,<a name='1387'></font>
                  <font color=#447700>!  we temporarily punt.<a name='1388'></font>
<a name='1389'>
                  ELSE IF ( ( NINT(nlu(ni  ,nj  )) .EQ. iswater ) .AND. &amp;<a name='1390'>
                            ( NINT(clu(ci  ,cj  )) .NE. iswater ) .AND. &amp;<a name='1391'>
                            ( NINT(clu(ci+1,cj  )) .NE. iswater ) .AND. &amp;<a name='1392'>
                            ( NINT(clu(ci  ,cj+1)) .NE. iswater ) .AND. &amp;<a name='1393'>
                            ( NINT(clu(ci+1,cj+1)) .NE. iswater ) ) THEN<a name='1394'>
<font color=#447700>!                    nfld(ni,nk,nj) = -1.e20<a name='1395'></font>
                     nfld(ni,nk,nj) = -1<a name='1396'>
<a name='1397'>
                  <font color=#447700>!  If there are some land points and some water points, take an average. <a name='1398'></font>
                  <a name='1399'>
                  ELSE IF ( NINT(nlu(ni  ,nj  )) .EQ. iswater ) THEN<a name='1400'>
                     icount = 0<a name='1401'>
                     sum = 0<a name='1402'>
                     IF ( NINT(clu(ci  ,cj  )) .EQ. iswater ) THEN<a name='1403'>
                        icount = icount + 1<a name='1404'>
                        sum = sum + cfld(ci  ,ck,cj  )<a name='1405'>
                     END IF<a name='1406'>
                     IF ( NINT(clu(ci+1,cj  )) .EQ. iswater ) THEN<a name='1407'>
                        icount = icount + 1<a name='1408'>
                        sum = sum + cfld(ci+1,ck,cj  )<a name='1409'>
                     END IF<a name='1410'>
                     IF ( NINT(clu(ci  ,cj+1)) .EQ. iswater ) THEN<a name='1411'>
                        icount = icount + 1<a name='1412'>
                        sum = sum + cfld(ci  ,ck,cj+1)<a name='1413'>
                     END IF<a name='1414'>
                     IF ( NINT(clu(ci+1,cj+1)) .EQ. iswater ) THEN<a name='1415'>
                        icount = icount + 1<a name='1416'>
                        sum = sum + cfld(ci+1,ck,cj+1)<a name='1417'>
                     END IF<a name='1418'>
                     nfld(ni,nk,nj) = sum / REAL ( icount ) <a name='1419'>
                  END IF<a name='1420'>
               END DO<a name='1421'>
            END DO<a name='1422'>
         END DO<a name='1423'>
<a name='1424'>
         <font color=#447700>!  Get an average of the whole domain for problem locations.<a name='1425'></font>
<a name='1426'>
         sum = 0<a name='1427'>
         icount = 0 <a name='1428'>
         DO nj = njts, njte<a name='1429'>
            DO nk = nkts, nkte<a name='1430'>
               DO ni = nits, nite<a name='1431'>
                  IF ( ( nfld(ni,nk,nj) .GT. -1.e19 ) .AND. (  nfld(ni,nk,nj) .LT. 1.e19 ) ) THEN<a name='1432'>
                     icount = icount + 1<a name='1433'>
                     sum = sum + nfld(ni,nk,nj)<a name='1434'>
                  END IF<a name='1435'>
               END DO<a name='1436'>
            END DO<a name='1437'>
         END DO<a name='1438'>
         avg = sum / REAL ( icount ) <a name='1439'>
<a name='1440'>
<a name='1441'>
         <font color=#447700>!  OK, if there were any of those lake situations, we try to search a bit broader<a name='1442'></font>
         <font color=#447700>!  of an area in the coarse grid.<a name='1443'></font>
<a name='1444'>
         DO nj = njts, njte<a name='1445'>
            DO nk = nkts, nkte<a name='1446'>
               DO ni = nits, nite<a name='1447'>
                  IF ( nfld(ni,nk,nj) .LT. -1.e19 ) THEN<a name='1448'>
                     cj = ( nj + 1) / nrj + jpos -1<a name='1449'>
                     ci = ( ni + 1) / nri + ipos -1<a name='1450'>
                     ist = MAX (ci-max_search,cits)<a name='1451'>
                     ien = MIN (ci+max_search,cite,cide-1)<a name='1452'>
                     jst = MAX (cj-max_search,cjts)<a name='1453'>
                     jen = MIN (cj+max_search,cjte,cjde-1)<a name='1454'>
                     icount = 0 <a name='1455'>
                     sum = 0<a name='1456'>
                     DO jj = jst,jen<a name='1457'>
                        DO ii = ist,ien<a name='1458'>
                           IF ( NINT(clu(ii,jj)) .EQ. iswater ) THEN<a name='1459'>
                              icount = icount + 1<a name='1460'>
                              sum = sum + cfld(ii,nk,jj)<a name='1461'>
                           END IF<a name='1462'>
                        END DO<a name='1463'>
                     END DO<a name='1464'>
                     IF ( icount .GT. 0 ) THEN<a name='1465'>
                        nfld(ni,nk,nj) = sum / REAL ( icount ) <a name='1466'>
                     ELSE<a name='1467'>
<font color=#447700>!                       CALL wrf_error_fatal ( "horizontal interp error - lake" )<a name='1468'></font>
                        print *,'horizontal interp error - lake, using average ',avg<a name='1469'>
                        nfld(ni,nk,nj) = avg<a name='1470'>
                     END IF        <a name='1471'>
                  END IF<a name='1472'>
               END DO<a name='1473'>
            END DO<a name='1474'>
         END DO<a name='1475'>
      ELSE<a name='1476'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_210"> ( "only unstaggered fields right now" )<a name='1477'>
      END IF<a name='1478'>
<a name='1479'>
   END SUBROUTINE interp_mask_water_field<a name='1480'>
<a name='1481'>
<A NAME='NONE'><A href='../../html_code/share/interp_fcn.F.html#NONE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1482'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>none</font><a name='1483'>
   END SUBROUTINE none<a name='1484'>
<a name='1485'>
<A NAME='SMOOTHER'><A href='../../html_code/share/interp_fcn.F.html#SMOOTHER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1486'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>smoother</font> ( cfld , &amp; <A href='../../call_to/SMOOTHER.html' TARGET='index'>3</A>,<A href='../../call_from/SMOOTHER.html' TARGET='index'>3</A><a name='1487'>
                      cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1488'>
                      cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1489'>
                      cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1490'>
                      nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1491'>
                      nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1492'>
                      nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1493'>
                      xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1494'></font>
                      ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in<a name='1495'></font>
                      nri, nrj                              &amp;<a name='1496'>
                      )<a name='1497'>
 <a name='1498'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#SMOOTHER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_123"><a name='1499'>
      IMPLICIT NONE<a name='1500'>
   <a name='1501'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1502'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1503'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1504'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1505'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1506'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1507'>
                             nri, nrj,                             &amp;  <a name='1508'>
                             ipos, jpos<a name='1509'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='1510'>
      INTEGER             :: smooth_option, feedback , spec_zone<a name='1511'>
   <a name='1512'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='1513'>
<a name='1514'>
      <font color=#447700>!  If there is no feedback, there can be no smoothing.<a name='1515'></font>
<a name='1516'>
      CALL nl_get_feedback       ( 1, feedback  )<a name='1517'>
      IF ( feedback == 0 ) RETURN<a name='1518'>
      CALL nl_get_spec_zone ( 1, spec_zone )<a name='1519'>
<a name='1520'>
      <font color=#447700>!  These are the 2d smoothers used on the fedback data.  These filters<a name='1521'></font>
      <font color=#447700>!  are run on the coarse grid data (after the nested info has been<a name='1522'></font>
      <font color=#447700>!  fedback).  Only the area of the nest in the coarse grid is filtered.<a name='1523'></font>
<a name='1524'>
      CALL nl_get_smooth_option  ( 1, smooth_option  )<a name='1525'>
<a name='1526'>
      IF      ( smooth_option == 0 ) THEN<a name='1527'>
<font color=#447700>! no op<a name='1528'></font>
      ELSE IF ( smooth_option == 1 ) THEN<a name='1529'>
         CALL <A href='../../html_code/share/interp_fcn.F.html#SM121'>sm121</A><A href='../../html_code/share/interp_fcn.F.html#SMOOTHER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SM121_2"> ( cfld , &amp;<a name='1530'>
                      cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1531'>
                      cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1532'>
                      cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1533'>
                      xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1534'></font>
                      nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1535'>
                      nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1536'>
                      nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1537'>
                      nri, nrj,                             &amp;  <a name='1538'>
                      ipos, jpos                            &amp;  <font color=#447700>! Position of lower left of nest in <a name='1539'></font>
                      )<a name='1540'>
      ELSE IF ( smooth_option == 2 ) THEN<a name='1541'>
         CALL <A href='../../html_code/share/interp_fcn.F.html#SMDSM'>smdsm</A><A href='../../html_code/share/interp_fcn.F.html#SMOOTHER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMDSM_2"> ( cfld , &amp;<a name='1542'>
                      cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1543'>
                      cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1544'>
                      cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1545'>
                      xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1546'></font>
                      nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1547'>
                      nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1548'>
                      nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1549'>
                      nri, nrj,                             &amp;  <a name='1550'>
                      ipos, jpos                            &amp;  <font color=#447700>! Position of lower left of nest in <a name='1551'></font>
                      )<a name='1552'>
      END IF<a name='1553'>
<a name='1554'>
   END SUBROUTINE smoother <a name='1555'>
<a name='1556'>
<A NAME='SM121'><A href='../../html_code/share/interp_fcn.F.html#SM121' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1557'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>sm121</font> ( cfld , &amp; <A href='../../call_to/SM121.html' TARGET='index'>2</A>,<A href='../../call_from/SM121.html' TARGET='index'>1</A><a name='1558'>
                      cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1559'>
                      cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1560'>
                      cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1561'>
                      xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1562'></font>
                      nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1563'>
                      nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1564'>
                      nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1565'>
                      nri, nrj,                             &amp;  <a name='1566'>
                      ipos, jpos                            &amp;  <font color=#447700>! Position of lower left of nest in <a name='1567'></font>
                      )<a name='1568'>
   <a name='1569'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#SM121' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_124"><a name='1570'>
      IMPLICIT NONE<a name='1571'>
   <a name='1572'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1573'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1574'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1575'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1576'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1577'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1578'>
                             nri, nrj,                             &amp;  <a name='1579'>
                             ipos, jpos<a name='1580'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='1581'>
   <a name='1582'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='1583'>
      REAL, DIMENSION ( cims:cime,            cjms:cjme ) :: cfldnew<a name='1584'>
   <a name='1585'>
      INTEGER                        :: i , j , k , loop<a name='1586'>
      INTEGER :: istag,jstag<a name='1587'>
<a name='1588'>
      INTEGER, PARAMETER  :: smooth_passes = 1 <font color=#447700>! More passes requires a larger stencil (currently 48 pt)<a name='1589'></font>
<a name='1590'>
      istag = 1 ; jstag = 1<a name='1591'>
      IF ( xstag ) istag = 0<a name='1592'>
      IF ( ystag ) jstag = 0<a name='1593'>
   <a name='1594'>
      <font color=#447700>!  Simple 1-2-1 smoother.<a name='1595'></font>
   <a name='1596'>
      smoothing_passes : DO loop = 1 , smooth_passes<a name='1597'>
   <a name='1598'>
         DO k = ckts , ckte<a name='1599'>
   <a name='1600'>
            <font color=#447700>!  Initialize dummy cfldnew<a name='1601'></font>
<a name='1602'>
            DO i = MAX(ipos,cits-3) , MIN(ipos+(nide-nids)/nri,cite+3)<a name='1603'>
               DO j = MAX(jpos,cjts-3) , MIN(jpos+(njde-njds)/nrj,cjte+3)<a name='1604'>
                  cfldnew(i,j) = cfld(i,k,j) <a name='1605'>
               END DO<a name='1606'>
            END DO<a name='1607'>
<a name='1608'>
            <font color=#447700>!  1-2-1 smoothing in the j direction first, <a name='1609'></font>
   <a name='1610'>
            DO i = MAX(ipos+1,cits-2) , MIN(ipos+(nide-nids)/nri-1-istag,cite+2)<a name='1611'>
            DO j = MAX(jpos+1,cjts-2) , MIN(jpos+(njde-njds)/nrj-1-jstag,cjte+2)<a name='1612'>
                  cfldnew(i,j) = 0.25 * ( cfld(i,k,j+1) + 2.*cfld(i,k,j) + cfld(i,k,j-1) )<a name='1613'>
               END DO<a name='1614'>
            END DO<a name='1615'>
<a name='1616'>
            <font color=#447700>!  then 1-2-1 smoothing in the i direction last<a name='1617'></font>
       <a name='1618'>
            DO j = MAX(jpos+1,cjts-2) , MIN(jpos+(njde-njds)/nrj-1-jstag,cjte+2)<a name='1619'>
            DO i = MAX(ipos+1,cits-2) , MIN(ipos+(nide-nids)/nri-1-istag,cite+2)<a name='1620'>
                  cfld(i,k,j) =  0.25 * ( cfldnew(i+1,j) + 2.*cfldnew(i,j) + cfldnew(i-1,j) )<a name='1621'>
               END DO<a name='1622'>
            END DO<a name='1623'>
       <a name='1624'>
         END DO<a name='1625'>
    <a name='1626'>
      END DO smoothing_passes<a name='1627'>
   <a name='1628'>
   END SUBROUTINE sm121<a name='1629'>
<a name='1630'>
<A NAME='SMDSM'><A href='../../html_code/share/interp_fcn.F.html#SMDSM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1631'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>smdsm</font> ( cfld , &amp; <A href='../../call_to/SMDSM.html' TARGET='index'>2</A>,<A href='../../call_from/SMDSM.html' TARGET='index'>1</A><a name='1632'>
                      cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1633'>
                      cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1634'>
                      cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1635'>
                      xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1636'></font>
                      nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1637'>
                      nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1638'>
                      nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1639'>
                      nri, nrj,                             &amp;  <a name='1640'>
                      ipos, jpos                            &amp;  <font color=#447700>! Position of lower left of nest in <a name='1641'></font>
                      )<a name='1642'>
   <a name='1643'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#SMDSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_125"><a name='1644'>
      IMPLICIT NONE<a name='1645'>
   <a name='1646'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1647'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1648'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1649'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1650'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1651'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1652'>
                             nri, nrj,                             &amp;  <a name='1653'>
                             ipos, jpos<a name='1654'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='1655'>
   <a name='1656'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='1657'>
      REAL, DIMENSION ( cims:cime,            cjms:cjme ) :: cfldnew<a name='1658'>
   <a name='1659'>
      REAL , DIMENSION ( 2 )         :: xnu<a name='1660'>
      INTEGER                        :: i , j , k , loop , n <a name='1661'>
      INTEGER :: istag,jstag<a name='1662'>
<a name='1663'>
      INTEGER, PARAMETER  :: smooth_passes = 1 <font color=#447700>! More passes requires a larger stencil (currently 48 pt)<a name='1664'></font>
<a name='1665'>
      xnu  =  (/ 0.50 , -0.52 /)<a name='1666'>
    <a name='1667'>
      istag = 1 ; jstag = 1<a name='1668'>
      IF ( xstag ) istag = 0<a name='1669'>
      IF ( ystag ) jstag = 0<a name='1670'>
   <a name='1671'>
      <font color=#447700>!  The odd number passes of this are the "smoother", the even<a name='1672'></font>
      <font color=#447700>!  number passes are the "de-smoother" (note the different signs on xnu).<a name='1673'></font>
   <a name='1674'>
      smoothing_passes : DO loop = 1 , smooth_passes * 2<a name='1675'>
   <a name='1676'>
         n  =  2 - MOD ( loop , 2 )<a name='1677'>
    <a name='1678'>
         DO k = ckts , ckte<a name='1679'>
   <a name='1680'>
            DO i = MAX(ipos+1,cits-2) , MIN(ipos+(nide-nids)/nri-1-istag,cite+2)<a name='1681'>
               DO j = MAX(jpos+1,cjts-2) , MIN(jpos+(njde-njds)/nrj-1-jstag,cjte+2)<a name='1682'>
                  cfldnew(i,j) = cfld(i,k,j) + xnu(n) * ((cfld(i,k,j+1) + cfld(i,k,j-1)) * 0.5-cfld(i,k,j))<a name='1683'>
               END DO<a name='1684'>
            END DO<a name='1685'>
       <a name='1686'>
            DO i = MAX(ipos+1,cits-2) , MIN(ipos+(nide-nids)/nri-1-istag,cite+2)<a name='1687'>
               DO j = MAX(jpos+1,cjts-2) , MIN(jpos+(njde-njds)/nrj-1-jstag,cjte+2)<a name='1688'>
                  cfld(i,k,j) = cfldnew(i,j)<a name='1689'>
               END DO<a name='1690'>
            END DO<a name='1691'>
       <a name='1692'>
            DO j = MAX(jpos+1,cjts-2) , MIN(jpos+(njde-njds)/nrj-1-jstag,cjte+2)<a name='1693'>
               DO i = MAX(ipos+1,cits-2) , MIN(ipos+(nide-nids)/nri-1-istag,cite+2)<a name='1694'>
                  cfldnew(i,j) = cfld(i,k,j) + xnu(n) * ((cfld(i+1,k,j) + cfld(i-1,k,j)) * 0.5-cfld(i,k,j))<a name='1695'>
               END DO<a name='1696'>
            END DO<a name='1697'>
       <a name='1698'>
            DO j = MAX(jpos+1,cjts-2) , MIN(jpos+(njde-njds)/nrj-1-jstag,cjte+2)<a name='1699'>
               DO i = MAX(ipos+1,cits-2) , MIN(ipos+(nide-nids)/nri-1-istag,cite+2)<a name='1700'>
                  cfld(i,k,j) = cfldnew(i,j)<a name='1701'>
               END DO<a name='1702'>
            END DO<a name='1703'>
   <a name='1704'>
         END DO<a name='1705'>
    <a name='1706'>
      END DO smoothing_passes<a name='1707'>
   <a name='1708'>
   END SUBROUTINE smdsm<a name='1709'>
<a name='1710'>
<font color=#447700>!==================================<a name='1711'></font>
<font color=#447700>! this is used to modify a field over the nest so we can see where the nest is<a name='1712'></font>
<a name='1713'>
<A NAME='MARK_DOMAIN'><A href='../../html_code/share/interp_fcn.F.html#MARK_DOMAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1714'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>mark_domain</font> (  cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/MARK_DOMAIN.html' TARGET='index'>2</A><a name='1715'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1716'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1717'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1718'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='1719'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1720'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1721'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1722'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='1723'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='1724'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1725'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='1726'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='1727'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#MARK_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_126"><a name='1728'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#MARK_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_47"><a name='1729'>
     IMPLICIT NONE<a name='1730'>
<a name='1731'>
<a name='1732'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1733'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1734'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1735'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1736'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1737'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1738'>
                            shw,                                  &amp;<a name='1739'>
                            ipos, jpos,                           &amp;<a name='1740'>
                            nri, nrj<a name='1741'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='1742'>
<a name='1743'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(OUT) :: cfld<a name='1744'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ), INTENT(IN) :: nfld<a name='1745'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ), INTENT(IN) :: imask<a name='1746'>
<a name='1747'>
     <font color=#447700>! Local<a name='1748'></font>
<a name='1749'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp, ioff, joff, ioffa, joffa<a name='1750'>
     INTEGER :: icmin,icmax,jcmin,jcmax<a name='1751'>
     INTEGER :: istag,jstag, ipoints,jpoints,ijpoints<a name='1752'>
<a name='1753'>
     istag = 1 ; jstag = 1<a name='1754'>
     IF ( xstag ) istag = 0<a name='1755'>
     IF ( ystag ) jstag = 0<a name='1756'>
<a name='1757'>
     DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='1758'>
        nj = (cj-jpos)*nrj + jstag + 1<a name='1759'>
        DO ck = ckts, ckte<a name='1760'>
           nk = ck<a name='1761'>
           DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='1762'>
              ni = (ci-ipos)*nri + istag + 1<a name='1763'>
              cfld( ci, ck, cj ) =  9021000.  <font color=#447700>!magic number: Beverly Hills * 100.<a name='1764'></font>
           ENDDO<a name='1765'>
        ENDDO<a name='1766'>
     ENDDO<a name='1767'>
<a name='1768'>
   END SUBROUTINE mark_domain<a name='1769'>
</pre></body></html>