<HTML> <BODY BGCOLOR=#eedddd LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( <font color=#447700>! NMM_CORE == 1 )<a name='2'></font>
<a name='3'>
<A NAME='MODULE_SOIL_PRE'><A href='../../html_code/share/module_soil_pre.F.html#MODULE_SOIL_PRE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>module_soil_pre</font> <A href='../../call_to/MODULE_SOIL_PRE.html' TARGET='index'>2</A><a name='5'>
<a name='6'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/module_soil_pre.F.html#module_soil_pre.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_15"><a name='7'>
   USE module_state_description<a name='8'>
<a name='9'>
CONTAINS<a name='10'>
<a name='11'>
<A NAME='ADJUST_FOR_SEAICE_PRE'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='12'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_for_seaice_pre</font> ( xice , landmask , tsk , ivgtyp , vegcat , lu_index , &amp; <A href='../../call_to/ADJUST_FOR_SEAICE_PRE.html' TARGET='index'>1</A>,<A href='../../call_from/ADJUST_FOR_SEAICE_PRE.html' TARGET='index'>5</A><a name='13'>
                                      xland , landusef , isltyp , soilcat , soilctop , &amp;<a name='14'>
                                      soilcbot , tmn , &amp;<a name='15'>
                                      seaice_threshold , &amp;<a name='16'>
                                      num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='17'>
                                      iswater , isice , &amp;<a name='18'>
                                      scheme , &amp;<a name='19'>
                                      ids , ide , jds , jde , kds , kde , &amp;<a name='20'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='21'>
                                      its , ite , jts , jte , kts , kte )<a name='22'>
<a name='23'>
      IMPLICIT NONE<a name='24'>
<a name='25'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='26'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='27'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='28'>
                              iswater , isice <a name='29'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat , scheme<a name='30'>
<a name='31'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landusef<a name='32'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(INOUT):: soilctop<a name='33'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(INOUT):: soilcbot<a name='34'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='35'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask , xice , tsk , lu_index , &amp;<a name='36'>
                                                           vegcat, xland , soilcat , tmn<a name='37'>
      REAL , INTENT(IN) :: seaice_threshold<a name='38'>
<a name='39'>
      INTEGER :: i , j , num_seaice_changes , loop<a name='40'>
      CHARACTER (LEN=132) :: message<a name='41'>
      <a name='42'>
      num_seaice_changes = 0<a name='43'>
      fix_seaice : SELECT CASE ( scheme ) <a name='44'>
 <a name='45'>
         CASE ( SLABSCHEME ) <a name='46'>
            DO j = jts , MIN(jde-1,jte)<a name='47'>
               DO i = its , MIN(ide-1,ite)<a name='48'>
                  IF ( xice(i,j) .GT. 200.0 ) THEN<a name='49'>
                     xice(i,j) = 0.<a name='50'>
                     num_seaice_changes = num_seaice_changes + 1<a name='51'>
                  END IF<a name='52'>
               END DO<a name='53'>
            END DO<a name='54'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='55'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='56'>
               'Total pre number of sea ice locations removed (due to FLAG values) = ', &amp;<a name='57'>
               num_seaice_changes<a name='58'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_250"> ( 0 , message )  <a name='59'>
            END IF<a name='60'>
            num_seaice_changes = 0<a name='61'>
            DO j = jts , MIN(jde-1,jte)<a name='62'>
               DO i = its , MIN(ide-1,ite)<a name='63'>
                  IF ( ( xice(i,j) .GE. 0.5 ) .OR. &amp;<a name='64'>
                       ( ( landmask(i,j) .LT. 0.5 ) .AND. ( tsk(i,j) .LT. seaice_threshold ) ) ) THEN<a name='65'>
                     xice(i,j) = 1.<a name='66'>
                     num_seaice_changes = num_seaice_changes + 1<a name='67'>
                     tmn(i,j) = 271.4<a name='68'>
                     vegcat(i,j)=isice<a name='69'>
                     ivgtyp(i,j)=isice<a name='70'>
                     lu_index(i,j)=isice<a name='71'>
                     landmask(i,j)=1.<a name='72'>
                     xland(i,j)=1.<a name='73'>
                     DO loop=1,num_veg_cat<a name='74'>
                        landusef(i,loop,j)=0.<a name='75'>
                     END DO<a name='76'>
                     landusef(i,ivgtyp(i,j),j)=1.<a name='77'>
<a name='78'>
                     isltyp(i,j) = 16<a name='79'>
                     soilcat(i,j)=isltyp(i,j)<a name='80'>
                     DO loop=1,num_soil_top_cat<a name='81'>
                        soilctop(i,loop,j)=0<a name='82'>
                     END DO<a name='83'>
                     DO loop=1,num_soil_bot_cat<a name='84'>
                        soilcbot(i,loop,j)=0<a name='85'>
                     END DO<a name='86'>
                     soilctop(i,isltyp(i,j),j)=1.<a name='87'>
                     soilcbot(i,isltyp(i,j),j)=1.<a name='88'>
                  END IF<a name='89'>
               END DO<a name='90'>
            END DO<a name='91'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='92'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='93'>
               'Total pre number of sea ice location changes (water to land) = ', num_seaice_changes<a name='94'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_251"> ( 0 , message )  <a name='95'>
            END IF<a name='96'>
<a name='97'>
         CASE ( LSMSCHEME ) <a name='98'>
            num_seaice_changes = 0<a name='99'>
            DO j = jts , MIN(jde-1,jte)<a name='100'>
               DO i = its , MIN(ide-1,ite)<a name='101'>
                  IF ( landmask(i,j) .GT. 0.5 ) THEN<a name='102'>
                     if (xice(i,j).gt.0) num_seaice_changes = num_seaice_changes + 1<a name='103'>
                     xice(i,j) = 0.<a name='104'>
                  END IF<a name='105'>
               END DO<a name='106'>
            END DO<a name='107'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='108'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='109'>
               'Total pre number of land location changes (seaice set to zero) = ', num_seaice_changes<a name='110'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_252"> ( 0 , message )<a name='111'>
            END IF<a name='112'>
<a name='113'>
         CASE ( RUCLSMSCHEME ) <a name='114'>
<a name='115'>
      END SELECT fix_seaice<a name='116'>
<a name='117'>
   END SUBROUTINE adjust_for_seaice_pre<a name='118'>
<a name='119'>
<A NAME='ADJUST_FOR_SEAICE_POST'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='120'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_for_seaice_post</font> ( xice , landmask , tsk_old , tsk , ivgtyp , vegcat , lu_index , &amp; <A href='../../call_to/ADJUST_FOR_SEAICE_POST.html' TARGET='index'>1</A>,<A href='../../call_from/ADJUST_FOR_SEAICE_POST.html' TARGET='index'>5</A><a name='121'>
                                      xland , landusef , isltyp , soilcat , soilctop , &amp;<a name='122'>
                                      soilcbot , tmn , vegfra , &amp;<a name='123'>
                                      tslb , smois , sh2o , &amp;<a name='124'>
                                      seaice_threshold , &amp;<a name='125'>
                                      num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='126'>
                                      num_soil_layers , &amp;<a name='127'>
                                      iswater , isice , &amp;<a name='128'>
                                      scheme , &amp;<a name='129'>
                                      ids , ide , jds , jde , kds , kde , &amp;<a name='130'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='131'>
                                      its , ite , jts , jte , kts , kte )<a name='132'>
<a name='133'>
      IMPLICIT NONE<a name='134'>
<a name='135'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='136'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='137'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='138'>
                              iswater , isice <a name='139'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat , scheme<a name='140'>
      INTEGER , INTENT(IN) :: num_soil_layers<a name='141'>
<a name='142'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landusef<a name='143'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(INOUT):: soilctop<a name='144'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(INOUT):: soilcbot<a name='145'>
      REAL , DIMENSION(ims:ime,1:num_soil_layers,jms:jme) , INTENT(INOUT):: tslb , smois , sh2o<a name='146'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='147'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask , xice , tsk , lu_index , &amp;<a name='148'>
                                                           vegcat, xland , soilcat , tmn , &amp;<a name='149'>
                                                           tsk_old , vegfra<a name='150'>
      REAL , INTENT(IN) :: seaice_threshold<a name='151'>
      REAL :: total_depth , mid_point_depth<a name='152'>
<a name='153'>
      INTEGER :: i , j , num_seaice_changes , loop<a name='154'>
      CHARACTER (LEN=132) :: message<a name='155'>
      <a name='156'>
      num_seaice_changes = 0<a name='157'>
      fix_seaice : SELECT CASE ( scheme ) <a name='158'>
 <a name='159'>
         CASE ( SLABSCHEME ) <a name='160'>
<a name='161'>
         CASE ( LSMSCHEME ) <a name='162'>
            DO j = jts , MIN(jde-1,jte)<a name='163'>
               DO i = its , MIN(ide-1,ite)<a name='164'>
                  IF ( xice(i,j) .GT. 200.0 ) THEN<a name='165'>
                     xice(i,j) = 0.<a name='166'>
                     num_seaice_changes = num_seaice_changes + 1<a name='167'>
                  END IF<a name='168'>
               END DO<a name='169'>
            END DO<a name='170'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='171'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='172'>
               'Total post number of sea ice locations removed (due to FLAG values) = ', &amp;<a name='173'>
               num_seaice_changes<a name='174'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_253"> ( 0 , message )  <a name='175'>
            END IF<a name='176'>
            num_seaice_changes = 0<a name='177'>
            DO j = jts , MIN(jde-1,jte)<a name='178'>
               DO i = its , MIN(ide-1,ite)<a name='179'>
                  IF ( ( tsk(i,j) .LT. 200 ) .OR. ( tsk(i,j) .GT. 350 ) ) THEN<a name='180'>
                     print *,'TSK woes in seaice post, i,j=',i,j,'  tsk = ',tsk(i,j)<a name='181'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_238"> ( 'TSK is unrealistic, problems for seaice post')<a name='182'>
                  ELSE IF ( ( xice(i,j) .GE. 0.5 ) .OR. &amp;<a name='183'>
                       ( ( landmask(i,j) .LT. 0.5 ) .AND. ( tsk(i,j) .LT. seaice_threshold ) ) ) THEN<a name='184'>
                     xice(i,j) = 1.<a name='185'>
                     num_seaice_changes = num_seaice_changes + 1<a name='186'>
                     tmn(i,j) = 271.16<a name='187'>
                     vegcat(i,j)=isice<a name='188'>
                     ivgtyp(i,j)=isice<a name='189'>
                     lu_index(i,j)=isice<a name='190'>
                     landmask(i,j)=1.<a name='191'>
                     xland(i,j)=1.<a name='192'>
                     vegfra(i,j)=0.<a name='193'>
                     DO loop=1,num_veg_cat<a name='194'>
                        landusef(i,loop,j)=0.<a name='195'>
                     END DO<a name='196'>
                     landusef(i,ivgtyp(i,j),j)=1.<a name='197'>
<a name='198'>
                     tsk_old(i,j) = tsk(i,j)<a name='199'>
<a name='200'>
                     isltyp(i,j) = 16<a name='201'>
                     soilcat(i,j)=isltyp(i,j)<a name='202'>
                     DO loop=1,num_soil_top_cat<a name='203'>
                        soilctop(i,loop,j)=0<a name='204'>
                     END DO<a name='205'>
                     DO loop=1,num_soil_bot_cat<a name='206'>
                        soilcbot(i,loop,j)=0<a name='207'>
                     END DO<a name='208'>
                     soilctop(i,isltyp(i,j),j)=1.<a name='209'>
                     soilcbot(i,isltyp(i,j),j)=1.<a name='210'>
<a name='211'>
                     total_depth = 3. <font color=#447700>! ice is 3 m deep, num_soil_layers equispaced layers<a name='212'></font>
                     DO loop = 1,num_soil_layers<a name='213'>
                        mid_point_depth=(total_depth/num_soil_layers)/2. + &amp;<a name='214'>
                                        (loop-1)*(total_depth/num_soil_layers)<a name='215'>
                        tslb(i,loop,j) = ( (total_depth-mid_point_depth)*tsk(i,j) + &amp;<a name='216'>
                                            mid_point_depth*tmn(i,j) ) / total_depth<a name='217'>
                     END DO<a name='218'>
<a name='219'>
                     DO loop=1,num_soil_layers<a name='220'>
                        smois(i,loop,j) = 1.0<a name='221'>
                        sh2o(i,loop,j)  = 0.0<a name='222'>
                     END DO<a name='223'>
                  ELSE IF ( xice(i,j) .LT. 0.5 ) THEN<a name='224'>
                     xice(i,j) = 0.<a name='225'>
                  END IF<a name='226'>
               END DO<a name='227'>
            END DO<a name='228'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='229'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='230'>
               'Total post number of sea ice location changes (water to land) = ', num_seaice_changes<a name='231'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_254"> ( 0 , message )  <a name='232'>
            END IF<a name='233'>
<a name='234'>
         CASE ( RUCLSMSCHEME ) <a name='235'>
<a name='236'>
      END SELECT fix_seaice<a name='237'>
<a name='238'>
   END SUBROUTINE adjust_for_seaice_post<a name='239'>
<a name='240'>
<A NAME='PROCESS_PERCENT_CAT_NEW'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='241'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_percent_cat_new</font> ( landmask ,  &amp; <A href='../../call_to/PROCESS_PERCENT_CAT_NEW.html' TARGET='index'>2</A>,<A href='../../call_from/PROCESS_PERCENT_CAT_NEW.html' TARGET='index'>14</A><a name='242'>
                                landuse_frac , soil_top_cat , soil_bot_cat , &amp;<a name='243'>
                                isltyp , ivgtyp , &amp;<a name='244'>
                                num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='245'>
                                ids , ide , jds , jde , kds , kde , &amp;<a name='246'>
                                ims , ime , jms , jme , kms , kme , &amp;<a name='247'>
                                its , ite , jts , jte , kts , kte , &amp;<a name='248'>
                                iswater )<a name='249'>
<a name='250'>
      IMPLICIT NONE<a name='251'>
<a name='252'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='253'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='254'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='255'>
                              iswater<a name='256'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='257'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landuse_frac<a name='258'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(IN):: soil_top_cat<a name='259'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(IN):: soil_bot_cat<a name='260'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='261'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask<a name='262'>
<a name='263'>
      INTEGER :: i , j , l , ll, dominant_index<a name='264'>
      REAL :: dominant_value<a name='265'>
<a name='266'>
#ifdef WRF_CHEM<a name='267'>
<font color=#447700>!      REAL :: lwthresh = .99<a name='268'></font>
      REAL :: lwthresh = .50<a name='269'>
#else<a name='270'>
      REAL :: lwthresh = .50<a name='271'>
#endif<a name='272'>
<a name='273'>
      INTEGER , PARAMETER :: iswater_soil = 14<a name='274'>
      INTEGER :: iforce<a name='275'>
      CHARACTER (LEN=132) :: message<a name='276'>
<a name='277'>
      <font color=#447700>!  Sanity check on the 50/50 points<a name='278'></font>
<a name='279'>
      DO j = jts , MIN(jde-1,jte)<a name='280'>
         DO i = its , MIN(ide-1,ite)<a name='281'>
            dominant_value = landuse_frac(i,iswater,j)<a name='282'>
            IF ( dominant_value .EQ. lwthresh ) THEN<a name='283'>
               DO l = 1 , num_veg_cat<a name='284'>
                  IF ( l .EQ. iswater ) CYCLE<a name='285'>
                  IF ( landuse_frac(i,l,j) .EQ. lwthresh ) THEN<a name='286'>
                     PRINT *,i,j,' water and category ',l,' both at 50%, landmask is ',landmask(i,j)<a name='287'>
                     landuse_frac(i,l,j) = lwthresh - .01<a name='288'>
                     landuse_frac(i,iswater,j) = 1. - (lwthresh + 0.01)<a name='289'>
                  END IF<a name='290'>
               END DO<a name='291'>
            END IF<a name='292'>
         END DO<a name='293'>
      END DO<a name='294'>
<a name='295'>
      <font color=#447700>!  Compute the dominant VEGETATION INDEX.<a name='296'></font>
<a name='297'>
      DO j = jts , MIN(jde-1,jte)<a name='298'>
         DO i = its , MIN(ide-1,ite)<a name='299'>
            dominant_value = landuse_frac(i,1,j)<a name='300'>
            dominant_index = 1<a name='301'>
            DO l = 2 , num_veg_cat<a name='302'>
               IF        ( l .EQ. iswater ) THEN<a name='303'>
                  <font color=#447700>! wait a bit<a name='304'></font>
               ELSE IF ( ( l .NE. iswater ) .AND. ( landuse_frac(i,l,j) .GT. dominant_value ) ) THEN<a name='305'>
                  dominant_value = landuse_frac(i,l,j)<a name='306'>
                  dominant_index = l<a name='307'>
               END IF<a name='308'>
            END DO<a name='309'>
            IF ( landuse_frac(i,iswater,j) .GT. lwthresh ) THEN<a name='310'>
               dominant_value = landuse_frac(i,iswater,j)<a name='311'>
               dominant_index = iswater<a name='312'>
#if 0<a name='313'>
si needs to beef up consistency checks before we can use this part<a name='314'>
            ELSE IF ( ( landuse_frac(i,iswater,j) .EQ. lwthresh) .AND. &amp;<a name='315'>
                      ( dominant_value .EQ. lwthresh) ) THEN<a name='316'>
               <font color=#447700>! no op<a name='317'></font>
#else<a name='318'>
ELSEIF((landuse_frac(i,iswater,j).EQ.lwthresh).AND.(dominant_value.EQ.lwthresh).and.(dominant_index.LT.iswater))THEN<a name='319'>
print *,'temporary SI landmask fix'<a name='320'>
<font color=#447700>! no op<a name='321'></font>
ELSEIF((landuse_frac(i,iswater,j).EQ.lwthresh).AND.(dominant_value.EQ.lwthresh).and.(dominant_index.GT.iswater))THEN<a name='322'>
print *,'temporary SI landmask fix'<a name='323'>
dominant_value = landuse_frac(i,iswater,j)<a name='324'>
dominant_index = iswater<a name='325'>
#endif<a name='326'>
            ELSE IF ( ( landuse_frac(i,iswater,j) .EQ. lwthresh ) .AND. &amp;<a name='327'>
                      ( dominant_value .LT. lwthresh ) ) THEN<a name='328'>
               dominant_value = landuse_frac(i,iswater,j)<a name='329'>
               dominant_index = iswater<a name='330'>
            END IF<a name='331'>
            IF      ( dominant_index .EQ. iswater ) THEN<a name='332'>
if(landmask(i,j).gt.lwthresh) then<a name='333'>
print *,'changing to water at point ',i,j<a name='334'>
print '(24(i3,1x))',1, 2, 3, 4, 5, 6, 7, 8, 9, 10,11,12, 13, 14, 15, 16, 17,18,19,20,21, 22, 23,24<a name='335'>
print '(24(i3,1x))',nint(landuse_frac(i,:,j)*100)<a name='336'>
endif<a name='337'>
               landmask(i,j) = 0<a name='338'>
            ELSE IF ( dominant_index .NE. iswater ) THEN<a name='339'>
if(landmask(i,j).lt.lwthresh) then<a name='340'>
print *,'changing to land at point ',i,j<a name='341'>
print '(24(i3,1x))',1, 2, 3, 4, 5, 6, 7, 8, 9, 10,11,12, 13, 14, 15, 16, 17,18,19,20,21, 22, 23,24<a name='342'>
print '(24(i3,1x))',nint(landuse_frac(i,:,j)*100)<a name='343'>
endif<a name='344'>
               landmask(i,j) = 1<a name='345'>
            END IF<a name='346'>
            ivgtyp(i,j) = dominant_index<a name='347'>
         END DO<a name='348'>
      END DO<a name='349'>
<a name='350'>
      <font color=#447700>!  Compute the dominant SOIL TEXTURE INDEX, TOP.<a name='351'></font>
<a name='352'>
      iforce = 0<a name='353'>
      DO i = its , MIN(ide-1,ite)<a name='354'>
         DO j = jts , MIN(jde-1,jte)<a name='355'>
            dominant_value = soil_top_cat(i,1,j)<a name='356'>
            dominant_index = 1<a name='357'>
            IF ( landmask(i,j) .GT. lwthresh ) THEN<a name='358'>
               DO l = 2 , num_soil_top_cat<a name='359'>
                  IF ( ( l .NE. iswater_soil ) .AND. ( soil_top_cat(i,l,j) .GT. dominant_value ) ) THEN<a name='360'>
                     dominant_value = soil_top_cat(i,l,j)<a name='361'>
                     dominant_index = l<a name='362'>
                  END IF<a name='363'>
               END DO<a name='364'>
               IF ( dominant_value .LT. 0.01 ) THEN<a name='365'>
                  iforce = iforce + 1<a name='366'>
                  WRITE ( message , FMT = '(A,I4,I4)' ) &amp;<a name='367'>
                  'based on landuse, changing soil to land at point ',i,j<a name='368'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_255">(1,message)<a name='369'>
                  WRITE ( message , FMT = '(16(i3,1x))' ) &amp;<a name='370'>
                  1, 2, 3, 4, 5, 6, 7, 8, 9, 10,11,12, 13, 14, 15, 16<a name='371'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_256">(1,message)<a name='372'>
                  WRITE ( message , FMT = '(16(i3,1x))' ) &amp;<a name='373'>
                  nint(soil_top_cat(i,:,j)*100)<a name='374'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_257">(1,message)<a name='375'>
                  dominant_index = 8<a name='376'>
               END IF<a name='377'>
            ELSE<a name='378'>
               dominant_index = iswater_soil<a name='379'>
            END IF<a name='380'>
            isltyp(i,j) = dominant_index<a name='381'>
         END DO<a name='382'>
      END DO<a name='383'>
<a name='384'>
if(iforce.ne.0)then<a name='385'>
WRITE(message,FMT='(A,I4,A,I6)' ) &amp;<a name='386'>
'forcing artificial silty clay loam at ',iforce,' points, out of ',&amp;<a name='387'>
(MIN(ide-1,ite)-its+1)*(MIN(jde-1,jte)-jts+1)<a name='388'>
CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_258">(0,message)<a name='389'>
endif<a name='390'>
<a name='391'>
   END SUBROUTINE process_percent_cat_new<a name='392'>
<a name='393'>
<A NAME='PROCESS_SOIL_REAL'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='394'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_soil_real</font> ( tsk , tmn , &amp; <A href='../../call_to/PROCESS_SOIL_REAL.html' TARGET='index'>1</A>,<A href='../../call_from/PROCESS_SOIL_REAL.html' TARGET='index'>12</A><a name='395'>
                                landmask , sst , &amp;<a name='396'>
                                st_input , sm_input , sw_input , st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='397'>
                                zs , dzs , tslb , smois , sh2o , &amp;<a name='398'>
                                flag_sst , flag_soilt000, flag_soilm000, &amp;<a name='399'>
                                ids , ide , jds , jde , kds , kde , &amp;<a name='400'>
                                ims , ime , jms , jme , kms , kme , &amp;<a name='401'>
                                its , ite , jts , jte , kts , kte , &amp;<a name='402'>
                                sf_surface_physics , num_soil_layers , real_data_init_type , &amp;<a name='403'>
                                num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='404'>
                                num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc )<a name='405'>
<a name='406'>
      IMPLICIT NONE<a name='407'>
<a name='408'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='409'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='410'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='411'>
                              sf_surface_physics , num_soil_layers , real_data_init_type , &amp;<a name='412'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='413'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc <a name='414'>
<a name='415'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soilt000, flag_soilm000<a name='416'>
<a name='417'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='418'>
<a name='419'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='420'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='421'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='422'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='423'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='424'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='425'>
<a name='426'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='427'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='428'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn <a name='429'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='430'>
<a name='431'>
      INTEGER :: i , j , l , dominant_index , num_soil_cat , num_veg_cat<a name='432'>
      REAL :: dominant_value<a name='433'>
<a name='434'>
      <font color=#447700>!  Initialize the soil depth, and the soil temperature and moisture.<a name='435'></font>
   <a name='436'>
      IF      ( ( sf_surface_physics .EQ. 1 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='437'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1'>init_soil_depth_1</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_1_1"> ( zs , dzs , num_soil_layers )<a name='438'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_REAL'>init_soil_1_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_1_REAL_1"> ( tsk , tmn , tslb , zs , dzs , num_soil_layers , real_data_init_type , &amp;<a name='439'>
                                 landmask , sst , flag_sst , &amp;<a name='440'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='441'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='442'>
                                 its , ite , jts , jte , kts , kte )<a name='443'>
<a name='444'>
      ELSE IF ( ( sf_surface_physics .EQ. 2 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='445'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_1"> ( zs , dzs , num_soil_layers )<a name='446'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL'>init_soil_2_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_REAL_1"> ( tsk , tmn , smois , sh2o , tslb , &amp;<a name='447'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='448'>
                                 zs , dzs , &amp;<a name='449'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='450'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='451'>
                                 num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='452'>
                                 flag_sst , flag_soilt000 , flag_soilm000 , &amp;<a name='453'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='454'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='455'>
                                 its , ite , jts , jte , kts , kte )<a name='456'>
<font color=#447700>!        CALL init_soil_old ( tsk , tmn , &amp;<a name='457'></font>
<font color=#447700>!                             smois , tslb , zs , dzs , num_soil_layers , &amp;<a name='458'></font>
<font color=#447700>!                             st000010_input , st010040_input , st040100_input , st100200_input , &amp;<a name='459'></font>
<font color=#447700>!                             st010200_input , &amp;<a name='460'></font>
<font color=#447700>!                             sm000010_input , sm010040_input , sm040100_input , sm100200_input , &amp;<a name='461'></font>
<font color=#447700>!                             sm010200_input , &amp;<a name='462'></font>
<font color=#447700>!                             landmask_input , sst_input , &amp;<a name='463'></font>
<font color=#447700>!                             ids , ide , jds , jde , kds , kde , &amp;<a name='464'></font>
<font color=#447700>!                             ims , ime , jms , jme , kms , kme , &amp;<a name='465'></font>
<font color=#447700>!                             its , ite , jts , jte , kts , kte )<a name='466'></font>
      ELSE IF ( ( sf_surface_physics .EQ. 3 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='467'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3'>init_soil_depth_3</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_3_1"> ( zs , dzs , num_soil_layers )<a name='468'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL'>init_soil_3_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_3_REAL_1"> ( tsk , tmn , smois , tslb , &amp;<a name='469'>
                                 st_input , sm_input , landmask , sst , &amp;<a name='470'>
                                 zs , dzs , &amp;<a name='471'>
                                 st_levels_input , sm_levels_input , &amp;<a name='472'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , &amp;<a name='473'>
                                 num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='474'>
                                 flag_sst , flag_soilt000 , flag_soilm000 , &amp;<a name='475'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='476'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='477'>
                                 its , ite , jts , jte , kts , kte )<a name='478'>
      END IF<a name='479'>
<a name='480'>
   END SUBROUTINE process_soil_real<a name='481'>
<a name='482'>
<A NAME='PROCESS_SOIL_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='483'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_soil_ideal</font> ( xland,xice,vegfra,snow,canwat,  &amp;,<A href='../../call_from/PROCESS_SOIL_IDEAL.html' TARGET='index'>10</A><a name='484'>
                                   ivgtyp,isltyp,tslb,smois, &amp;<a name='485'>
                                   tsk,tmn,zs,dzs,           &amp;<a name='486'>
                                   num_soil_layers,          &amp;<a name='487'>
                                   sf_surface_physics ,      &amp;<a name='488'>
                                   ids,ide, jds,jde, kds,kde,&amp;<a name='489'>
                                   ims,ime, jms,jme, kms,kme,&amp;<a name='490'>
                                   its,ite, jts,jte, kts,kte )<a name='491'>
<a name='492'>
      IMPLICIT NONE<a name='493'>
<a name='494'>
      INTEGER, INTENT(IN) ::ids,ide, jds,jde, kds,kde,  &amp;<a name='495'>
                            ims,ime, jms,jme, kms,kme,  &amp;<a name='496'>
                            its,ite, jts,jte, kts,kte<a name='497'>
  <a name='498'>
      INTEGER, INTENT(IN) :: num_soil_layers , sf_surface_physics<a name='499'>
<a name='500'>
      REAL, DIMENSION( ims:ime, num_soil_layers, jms:jme ) , INTENT(INOUT) :: smois, tslb<a name='501'>
<a name='502'>
      REAL, DIMENSION(num_soil_layers), INTENT(OUT) :: dzs,zs<a name='503'>
<a name='504'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT) :: tsk, tmn<a name='505'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: xland, snow, canwat, xice, vegfra<a name='506'>
      INTEGER, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: ivgtyp, isltyp<a name='507'>
<a name='508'>
      <font color=#447700>!  Local variables.<a name='509'></font>
<a name='510'>
      INTEGER :: itf,jtf<a name='511'>
<a name='512'>
      itf=MIN(ite,ide-1)<a name='513'>
      jtf=MIN(jte,jde-1)<a name='514'>
<a name='515'>
      IF      ( ( sf_surface_physics .EQ. 1 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='516'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1'>init_soil_depth_1</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_1_2"> ( zs , dzs , num_soil_layers )<a name='517'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_IDEAL'>init_soil_1_ideal</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_1_IDEAL_1">(tsk,tmn,tslb,xland,                      &amp;<a name='518'>
                                ivgtyp,zs,dzs,num_soil_layers,           &amp;<a name='519'>
                                ids,ide, jds,jde, kds,kde,               &amp;<a name='520'>
                                ims,ime, jms,jme, kms,kme,               &amp;<a name='521'>
                                its,ite, jts,jte, kts,kte                )<a name='522'>
      ELSE IF ( ( sf_surface_physics .EQ. 2 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='523'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_2"> ( zs , dzs , num_soil_layers )<a name='524'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_IDEAL'>init_soil_2_ideal</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_IDEAL_1"> ( xland,xice,vegfra,snow,canwat,         &amp;<a name='525'>
                                  ivgtyp,isltyp,tslb,smois,tmn,          &amp;<a name='526'>
                                  num_soil_layers,                       &amp;<a name='527'>
                                  ids,ide, jds,jde, kds,kde,             &amp;<a name='528'>
                                  ims,ime, jms,jme, kms,kme,             &amp;<a name='529'>
                                  its,ite, jts,jte, kts,kte              )<a name='530'>
      ELSE IF ( ( sf_surface_physics .EQ. 3 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='531'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3'>init_soil_depth_3</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_3_2"> ( zs , dzs , num_soil_layers )<a name='532'>
<a name='533'>
      END IF<a name='534'>
<a name='535'>
   END SUBROUTINE process_soil_ideal<a name='536'>
<a name='537'>
<A NAME='ADJUST_SOIL_TEMP_NEW'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='538'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_soil_temp_new</font> ( tmn , sf_surface_physics , &amp; <A href='../../call_to/ADJUST_SOIL_TEMP_NEW.html' TARGET='index'>1</A>,<A href='../../call_from/ADJUST_SOIL_TEMP_NEW.html' TARGET='index'>4</A><a name='539'>
                                 tsk , ter , toposoil , landmask , flag_toposoil , &amp;<a name='540'>
                                      st000010 ,      st010040 ,      st040100 ,      st100200 ,      st010200 , &amp;<a name='541'>
                                 flag_st000010 , flag_st010040 , flag_st040100 , flag_st100200 , flag_st010200 , &amp; <a name='542'>
                                      soilt000 ,      soilt005 ,      soilt020 ,      soilt040 ,      soilt160 ,      soilt300 , &amp;<a name='543'>
                                 flag_soilt000 , flag_soilt005 , flag_soilt020 , flag_soilt040 , flag_soilt160 , flag_soilt300 , &amp;<a name='544'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='545'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='546'>
                                 its , ite , jts , jte , kts , kte )<a name='547'>
<a name='548'>
      IMPLICIT NONE<a name='549'>
   <a name='550'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='551'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='552'>
                              its , ite , jts , jte , kts , kte <a name='553'>
<a name='554'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN)    :: ter , toposoil , landmask<a name='555'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tmn , tsk<a name='556'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: st000010 , st010040 , st040100 , st100200 , st010200<a name='557'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: soilt000 , soilt005 , soilt020 , soilt040 , soilt160 , soilt300<a name='558'>
<a name='559'>
      INTEGER , INTENT(IN) :: flag_st000010 , flag_st010040 , flag_st040100 , flag_st100200 , flag_st010200<a name='560'>
      INTEGER , INTENT(IN) :: flag_soilt000 , flag_soilt005 , flag_soilt020 , flag_soilt040 , flag_soilt160 , flag_soilt300<a name='561'>
      INTEGER , INTENT(IN) :: sf_surface_physics , flag_toposoil<a name='562'>
 <a name='563'>
      INTEGER :: i , j<a name='564'>
<a name='565'>
      REAL :: soil_elev_min_val ,  soil_elev_max_val , soil_elev_min_dif , soil_elev_max_dif<a name='566'>
<a name='567'>
      <font color=#447700>!  Do we have a soil field with which to modify soil temperatures?<a name='568'></font>
<a name='569'>
      IF ( flag_toposoil .EQ. 1 ) THEN<a name='570'>
<a name='571'>
         DO j = jts , MIN(jde-1,jte)<a name='572'>
            DO i = its , MIN(ide-1,ite)<a name='573'>
<a name='574'>
               <font color=#447700>!  Is the toposoil field OK, or is it a subversive soil elevation field.  We can tell<a name='575'></font>
               <font color=#447700>!  usually by looking at values.  Anything less than -1000 m (lower than the Dead Sea) is<a name='576'></font>
               <font color=#447700>!  bad.  Anything larger than 10 km (taller than Everest) is toast.  Also, anything where <a name='577'></font>
               <font color=#447700>!  the difference between the soil elevation and the terrain is greater than 3 km means<a name='578'></font>
               <font color=#447700>!  that the soil data is either all zeros or that the data are inconsistent.  Any of these<a name='579'></font>
               <font color=#447700>!  three conditions is grievous enough to induce a WRF fatality.  However, if they are at<a name='580'></font>
               <font color=#447700>!  a water point, then we can safely ignore them.<a name='581'></font>
         <a name='582'>
               soil_elev_min_val = toposoil(i,j) <a name='583'>
               soil_elev_max_val = toposoil(i,j) <a name='584'>
               soil_elev_min_dif = ter(i,j) - toposoil(i,j)<a name='585'>
               soil_elev_max_dif = ter(i,j) - toposoil(i,j)<a name='586'>
         <a name='587'>
               IF      ( ( soil_elev_min_val .LT. -1000 ) .AND. ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='588'>
                  CYCLE<a name='589'>
               ELSE IF ( ( soil_elev_min_val .LT. -1000 ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='590'>
<font color=#447700>!print *,'no soil temperature elevation adjustment, soil height too small = ',toposoil(i,j)<a name='591'></font>
cycle<a name='592'>
<font color=#447700>!                 CALL wrf_error_fatal ( 'TOPOSOIL values have large negative values &lt; -1000 m, unrealistic.' )<a name='593'></font>
               ENDIF<a name='594'>
         <a name='595'>
               IF      ( ( soil_elev_max_val .GT. 10000 ) .AND. ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='596'>
                  CYCLE<a name='597'>
               ELSE IF ( ( soil_elev_max_val .GT. 10000 ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='598'>
print *,'no soil temperature elevation adjustment, soil height too high = ',toposoil(i,j)<a name='599'>
cycle<a name='600'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_239"> ( 'TOPOSOIL values have large positive values &gt; 10,000 m , unrealistic.' )<a name='601'>
               ENDIF<a name='602'>
         <a name='603'>
               IF      ( ( ( soil_elev_min_dif .LT. -3000 ) .OR. ( soil_elev_max_dif .GT. 3000 ) ) .AND. &amp;<a name='604'>
                           ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='605'>
                  CYCLE<a name='606'>
               ELSE IF ( ( ( soil_elev_min_dif .LT. -3000 ) .OR. ( soil_elev_max_dif .GT. 3000 ) ) .AND. &amp;<a name='607'>
                           ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='608'>
print *,'no soil temperature elevation adjustment, diff of soil height and terrain = ',ter(i,j) - toposoil(i,j)<a name='609'>
cycle<a name='610'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_240"> ( 'TOPOSOIL difference with terrain elevation differs by more than 3000 m, unrealistic' )<a name='611'>
               ENDIF<a name='612'>
<a name='613'>
               <font color=#447700>!  For each of the fields that we would like to modify, check to see if it came in from the SI.<a name='614'></font>
               <font color=#447700>!  If so, then use a -6.5 K/km lapse rate (based on the elevation diffs).  We only adjust when we<a name='615'></font>
               <font color=#447700>!  are not at a water point.<a name='616'></font>
<a name='617'>
               IF (landmask(i,j) .GT. 0.5 ) THEN<a name='618'>
   <a name='619'>
                  IF ( sf_surface_physics .EQ. 1 ) THEN<a name='620'>
                     tmn(i,j) = tmn(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='621'>
                  END IF<a name='622'>
                  <a name='623'>
                  tsk(i,j) = tsk(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='624'>
      <a name='625'>
                  IF ( flag_st000010 .EQ. 1 ) THEN<a name='626'>
                     st000010(i,j) = st000010(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='627'>
                  END IF<a name='628'>
                  IF ( flag_st010040 .EQ. 1 ) THEN<a name='629'>
                     st010040(i,j) = st010040(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='630'>
                  END IF<a name='631'>
                  IF ( flag_st040100 .EQ. 1 ) THEN<a name='632'>
                     st040100(i,j) = st040100(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='633'>
                  END IF<a name='634'>
                  IF ( flag_st100200 .EQ. 1 ) THEN<a name='635'>
                     st100200(i,j) = st100200(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='636'>
                  END IF<a name='637'>
                  IF ( flag_st010200 .EQ. 1 ) THEN<a name='638'>
                     st010200(i,j) = st010200(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='639'>
                  END IF<a name='640'>
      <a name='641'>
                  IF ( flag_soilt000 .EQ. 1 ) THEN<a name='642'>
                     soilt000(i,j) = soilt000(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='643'>
                  END IF<a name='644'>
                  IF ( flag_soilt005 .EQ. 1 ) THEN<a name='645'>
                     soilt005(i,j) = soilt005(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='646'>
                  END IF<a name='647'>
                  IF ( flag_soilt020 .EQ. 1 ) THEN<a name='648'>
                     soilt020(i,j) = soilt020(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='649'>
                  END IF<a name='650'>
                  IF ( flag_soilt040 .EQ. 1 ) THEN<a name='651'>
                     soilt040(i,j) = soilt040(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='652'>
                  END IF<a name='653'>
                  IF ( flag_soilt160 .EQ. 1 ) THEN<a name='654'>
                     soilt160(i,j) = soilt160(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='655'>
                  END IF<a name='656'>
                  IF ( flag_soilt300 .EQ. 1 ) THEN<a name='657'>
                     soilt300(i,j) = soilt300(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='658'>
                  END IF<a name='659'>
   <a name='660'>
               END IF<a name='661'>
            END DO<a name='662'>
         END DO<a name='663'>
<a name='664'>
      END IF<a name='665'>
<a name='666'>
   END SUBROUTINE adjust_soil_temp_new<a name='667'>
<a name='668'>
<a name='669'>
<A NAME='INIT_SOIL_DEPTH_1'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='670'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_1</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_1.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_DEPTH_1.html' TARGET='index'>2</A><a name='671'>
<a name='672'>
      IMPLICIT NONE<a name='673'>
   <a name='674'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='675'>
   <a name='676'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='677'>
   <a name='678'>
      INTEGER                   ::      l<a name='679'>
<a name='680'>
      <font color=#447700>!  Define layers (top layer = 0.01 m).  Double the thicknesses at each step (dzs values).<a name='681'></font>
      <font color=#447700>!  The distance from the ground level to the midpoint of the layer is given by zs.<a name='682'></font>
<a name='683'>
      <font color=#447700>!    -------   Ground Level   ----------      ||      ||   ||  || <a name='684'></font>
      <font color=#447700>!                                             ||      ||   ||  || zs(1) = 0.005 m<a name='685'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||      ||   ||  \/<a name='686'></font>
      <font color=#447700>!                                             ||      ||   ||<a name='687'></font>
      <font color=#447700>!    -----------------------------------      ||  ||  ||   \/   dzs(1) = 0.01 m<a name='688'></font>
      <font color=#447700>!                                             ||  ||  || <a name='689'></font>
      <font color=#447700>!                                             ||  ||  || zs(2) = 0.02<a name='690'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||  ||  \/<a name='691'></font>
      <font color=#447700>!                                             ||  ||<a name='692'></font>
      <font color=#447700>!                                             ||  ||<a name='693'></font>
      <font color=#447700>!    -----------------------------------  ||  ||  \/   dzs(2) = 0.02 m<a name='694'></font>
      <font color=#447700>!                                         ||  || <a name='695'></font>
      <font color=#447700>!                                         ||  ||<a name='696'></font>
      <font color=#447700>!                                         ||  || <a name='697'></font>
      <font color=#447700>!                                         ||  || zs(3) = 0.05<a name='698'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --   ||  \/<a name='699'></font>
      <font color=#447700>!                                         ||<a name='700'></font>
      <font color=#447700>!                                         ||<a name='701'></font>
      <font color=#447700>!                                         ||<a name='702'></font>
      <font color=#447700>!                                         ||<a name='703'></font>
      <font color=#447700>!    -----------------------------------  \/   dzs(3) = 0.04 m<a name='704'></font>
<a name='705'>
      IF ( num_soil_layers .NE. 5 ) THEN<a name='706'>
         PRINT '(A)','Usually, the 5-layer diffusion uses 5 layers.  Change this in the namelist.'<a name='707'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_241"> ( '5-layer_diffusion_uses_5_layers' )<a name='708'>
      END IF<a name='709'>
   <a name='710'>
      dzs(1)=.01<a name='711'>
      zs(1)=.5*dzs(1)<a name='712'>
   <a name='713'>
      DO l=2,num_soil_layers<a name='714'>
         dzs(l)=2*dzs(l-1)<a name='715'>
         zs(l)=zs(l-1)+.5*dzs(l-1)+.5*dzs(l)<a name='716'>
      ENDDO<a name='717'>
<a name='718'>
   END SUBROUTINE init_soil_depth_1<a name='719'>
<a name='720'>
<A NAME='INIT_SOIL_DEPTH_2'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='721'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_2</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_2.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_DEPTH_2.html' TARGET='index'>2</A><a name='722'>
<a name='723'>
      IMPLICIT NONE<a name='724'>
   <a name='725'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='726'>
   <a name='727'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='728'>
   <a name='729'>
      INTEGER                   ::      l<a name='730'>
<a name='731'>
      dzs = (/ 0.1 , 0.3 , 0.6 , 1.0 /)<a name='732'>
<a name='733'>
      IF ( num_soil_layers .NE. 4 ) THEN<a name='734'>
         PRINT '(A)','Usually, the LSM uses 4 layers.  Change this in the namelist.'<a name='735'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_242"> ( 'LSM_uses_4_layers' )<a name='736'>
      END IF<a name='737'>
<a name='738'>
      zs(1)=.5*dzs(1)<a name='739'>
   <a name='740'>
      DO l=2,num_soil_layers<a name='741'>
         zs(l)=zs(l-1)+.5*dzs(l-1)+.5*dzs(l)<a name='742'>
      ENDDO<a name='743'>
<a name='744'>
   END SUBROUTINE init_soil_depth_2<a name='745'>
<a name='746'>
<A NAME='INIT_SOIL_DEPTH_3'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='747'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_3</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_3.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_DEPTH_3.html' TARGET='index'>2</A><a name='748'>
<a name='749'>
      IMPLICIT NONE<a name='750'>
   <a name='751'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='752'>
   <a name='753'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='754'>
   <a name='755'>
      INTEGER                   ::      l<a name='756'>
<a name='757'>
      zs  = (/ 0.00 , 0.05 , 0.20 , 0.40 , 1.60 , 3.00 /)<a name='758'>
      dzs = (/ 0.00 , 0.125, 0.175 , 0.70 , 1.30 , 1.40 /)<a name='759'>
<a name='760'>
      IF ( num_soil_layers .NE. 6 ) THEN<a name='761'>
         PRINT '(A)','Usually, the RUC LSM uses 6 layers.  Change this in the namelist.'<a name='762'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_243"> ( 'LSM_uses_6_layers' )<a name='763'>
      END IF<a name='764'>
<a name='765'>
<font color=#447700>!print *,'RUCLSM dzs=',dzs<a name='766'></font>
<font color=#447700>!print *,'RUCLSM zs =',zs<a name='767'></font>
<a name='768'>
   END SUBROUTINE init_soil_depth_3<a name='769'>
<a name='770'>
<A NAME='INIT_SOIL_1_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='771'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_1_real</font> ( tsk , tmn , tslb , zs , dzs , &amp; <A href='../../call_to/INIT_SOIL_1_REAL.html' TARGET='index'>2</A><a name='772'>
                                 num_soil_layers , real_data_init_type , &amp;<a name='773'>
                                 landmask , sst , flag_sst , &amp;<a name='774'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='775'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='776'>
                                 its , ite , jts , jte , kts , kte )<a name='777'>
<a name='778'>
      IMPLICIT NONE<a name='779'>
<a name='780'>
      INTEGER , INTENT(IN) :: num_soil_layers , real_data_init_type , &amp;<a name='781'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='782'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='783'>
                              its , ite , jts , jte , kts , kte <a name='784'>
<a name='785'>
      INTEGER , INTENT(IN) :: flag_sst<a name='786'>
<a name='787'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='788'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tsk , tmn<a name='789'>
<a name='790'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='791'>
<a name='792'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb<a name='793'>
<a name='794'>
      INTEGER :: i , j , l<a name='795'>
<a name='796'>
      <font color=#447700>!  Soil temperature is linearly interpolated between the skin temperature (taken to be at a<a name='797'></font>
      <font color=#447700>!  depth of 0.5 cm) and the deep soil, annual temperature (taken to be at a depth of 23 cm).<a name='798'></font>
      <font color=#447700>!  The tslb(i,1,j) is the skin temperature, and the tslb(i,num_soil_layers,j) level is the <a name='799'></font>
      <font color=#447700>!  annual mean temperature.<a name='800'></font>
<a name='801'>
      DO j = jts , MIN(jde-1,jte)<a name='802'>
         DO i = its , MIN(ide-1,ite)<a name='803'>
            IF ( landmask(i,j) .GT. 0.5 ) THEN<a name='804'>
               DO l = 1 , num_soil_layers<a name='805'>
                  tslb(i,l,j)= ( tsk(i,j) * ( zs(num_soil_layers) - zs(l) )   + &amp;<a name='806'>
                                 tmn(i,j) * ( zs(              l) - zs(1) ) ) / &amp;<a name='807'>
                                            ( zs(num_soil_layers) - zs(1) )<a name='808'>
               END DO<a name='809'>
            ELSE<a name='810'>
               IF ( ( real_data_init_type .EQ. 1 ) .AND. ( flag_sst .EQ. 1 ) ) THEN<a name='811'>
                  DO l = 1 , num_soil_layers<a name='812'>
                     tslb(i,l,j)= sst(i,j)<a name='813'>
                  END DO<a name='814'>
               ELSE<a name='815'>
                  DO l = 1 , num_soil_layers<a name='816'>
                     tslb(i,l,j)= tsk(i,j)<a name='817'>
                  END DO<a name='818'>
               END IF<a name='819'>
            END IF<a name='820'>
         END DO<a name='821'>
      END DO<a name='822'>
<a name='823'>
   END SUBROUTINE init_soil_1_real<a name='824'>
<a name='825'>
<A NAME='INIT_SOIL_1_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='826'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_1_ideal</font>(tsk,tmn,tslb,xland,             &amp; <A href='../../call_to/INIT_SOIL_1_IDEAL.html' TARGET='index'>2</A><a name='827'>
                       ivgtyp,ZS,DZS,num_soil_layers,           &amp;<a name='828'>
                       ids,ide, jds,jde, kds,kde,               &amp;<a name='829'>
                       ims,ime, jms,jme, kms,kme,               &amp;<a name='830'>
                       its,ite, jts,jte, kts,kte                )<a name='831'>
<a name='832'>
      IMPLICIT NONE<a name='833'>
   <a name='834'>
      INTEGER, INTENT(IN   )    ::      ids,ide, jds,jde, kds,kde, &amp;<a name='835'>
                                        ims,ime, jms,jme, kms,kme, &amp;<a name='836'>
                                        its,ite, jts,jte, kts,kte<a name='837'>
   <a name='838'>
      INTEGER, INTENT(IN   )    ::      num_soil_layers<a name='839'>
   <a name='840'>
      REAL, DIMENSION( ims:ime , 1 , jms:jme ), INTENT(OUT) :: tslb<a name='841'>
      REAL, DIMENSION( ims:ime , jms:jme ), INTENT(OUT) :: xland<a name='842'>
      INTEGER, DIMENSION( ims:ime , jms:jme ), INTENT(OUT) :: ivgtyp<a name='843'>
   <a name='844'>
      REAL, DIMENSION(1:), INTENT(IN) :: dzs,zs<a name='845'>
   <a name='846'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(IN) :: tsk, tmn<a name='847'>
<a name='848'>
      <font color=#447700>!  Lcal variables.<a name='849'></font>
   <a name='850'>
      INTEGER :: l,j,i,itf,jtf<a name='851'>
   <a name='852'>
      itf=MIN(ite,ide-1)<a name='853'>
      jtf=MIN(jte,jde-1)<a name='854'>
   <a name='855'>
      IF (num_soil_layers.NE.1)THEN<a name='856'>
         DO j=jts,jtf<a name='857'>
            DO l=1,num_soil_layers<a name='858'>
               DO i=its,itf<a name='859'>
                 tslb(i,l,j)=( tsk(i,j)*(zs(num_soil_layers)-zs(l)) + tmn(i,j)*(zs(l)-zs(1)) ) / &amp;<a name='860'>
                             ( zs(num_soil_layers)-zs(1) )<a name='861'>
               ENDDO<a name='862'>
            ENDDO<a name='863'>
         ENDDO<a name='864'>
      ENDIF<a name='865'>
      DO j=jts,jtf<a name='866'>
         DO i=its,itf<a name='867'>
           xland(i,j)  = 2<a name='868'>
           ivgtyp(i,j) = 7<a name='869'>
         ENDDO<a name='870'>
      ENDDO<a name='871'>
<a name='872'>
   END SUBROUTINE init_soil_1_ideal<a name='873'>
<a name='874'>
<A NAME='INIT_SOIL_2_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='875'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_2_real</font> ( tsk , tmn , smois , sh2o , tslb , &amp; <A href='../../call_to/INIT_SOIL_2_REAL.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_SOIL_2_REAL.html' TARGET='index'>2</A><a name='876'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='877'>
                                 zs , dzs , &amp;<a name='878'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='879'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input ,  num_sw_levels_input , &amp;<a name='880'>
                                 num_st_levels_alloc , num_sm_levels_alloc ,  num_sw_levels_alloc , &amp;<a name='881'>
                                 flag_sst , flag_soilt000 , flag_soilmt000 , &amp;<a name='882'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='883'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='884'>
                                 its , ite , jts , jte , kts , kte )<a name='885'>
<a name='886'>
      IMPLICIT NONE<a name='887'>
<a name='888'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='889'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='890'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='891'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='892'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='893'>
                              its , ite , jts , jte , kts , kte <a name='894'>
<a name='895'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soilt000, flag_soilmt000<a name='896'>
<a name='897'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='898'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='899'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='900'>
<a name='901'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='902'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='903'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='904'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='905'>
<a name='906'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='907'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='908'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='909'>
<a name='910'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='911'>
<a name='912'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='913'>
<a name='914'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave , num<a name='915'>
      REAL :: temp<a name='916'>
      LOGICAL :: found_levels<a name='917'>
<a name='918'>
      <font color=#447700>!  Are there any soil temp and moisture levels - ya know, they are mandatory.<a name='919'></font>
<a name='920'>
      num = num_st_levels_input * num_sm_levels_input<a name='921'>
<a name='922'>
      IF ( num .GE. 1 ) THEN<a name='923'>
<a name='924'>
         <font color=#447700>!  Ordered levels that we have data for.<a name='925'></font>
<a name='926'>
         ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input,num_sw_levels_input) +2) )<a name='927'>
<a name='928'>
         <font color=#447700>!  Sort the levels for temperature.<a name='929'></font>
   <a name='930'>
         outert : DO lout = 1 , num_st_levels_input-1<a name='931'>
            innert : DO lin = lout+1 , num_st_levels_input<a name='932'>
               IF ( st_levels_input(lout) .GT. st_levels_input(lin) ) THEN<a name='933'>
                  temp = st_levels_input(lout) <a name='934'>
                  st_levels_input(lout) = st_levels_input(lin)<a name='935'>
                  st_levels_input(lin) = NINT(temp)<a name='936'>
                  DO j = jts , MIN(jde-1,jte)<a name='937'>
                     DO i = its , MIN(ide-1,ite)<a name='938'>
                        temp = st_input(i,lout+1,j)<a name='939'>
                        st_input(i,lout+1,j) = st_input(i,lin+1,j)<a name='940'>
                        st_input(i,lin+1,j) = temp<a name='941'>
                     END DO<a name='942'>
                  END DO<a name='943'>
               END IF<a name='944'>
            END DO innert<a name='945'>
         END DO outert<a name='946'>
         DO j = jts , MIN(jde-1,jte)<a name='947'>
            DO i = its , MIN(ide-1,ite)<a name='948'>
               st_input(i,1,j) = tsk(i,j)<a name='949'>
               st_input(i,num_st_levels_input+2,j) = tmn(i,j)<a name='950'>
            END DO<a name='951'>
         END DO<a name='952'>
   <a name='953'>
         <font color=#447700>!  Sort the levels for moisture.<a name='954'></font>
   <a name='955'>
         outerm: DO lout = 1 , num_sm_levels_input-1<a name='956'>
            innerm : DO lin = lout+1 , num_sm_levels_input<a name='957'>
               IF ( sm_levels_input(lout) .GT. sm_levels_input(lin) ) THEN<a name='958'>
                  temp = sm_levels_input(lout) <a name='959'>
                  sm_levels_input(lout) = sm_levels_input(lin)<a name='960'>
                  sm_levels_input(lin) = NINT(temp)<a name='961'>
                  DO j = jts , MIN(jde-1,jte)<a name='962'>
                     DO i = its , MIN(ide-1,ite)<a name='963'>
                        temp = sm_input(i,lout+1,j)<a name='964'>
                        sm_input(i,lout+1,j) = sm_input(i,lin+1,j)<a name='965'>
                        sm_input(i,lin+1,j) = temp<a name='966'>
                     END DO<a name='967'>
                  END DO<a name='968'>
               END IF<a name='969'>
            END DO innerm<a name='970'>
         END DO outerm<a name='971'>
         DO j = jts , MIN(jde-1,jte)<a name='972'>
            DO i = its , MIN(ide-1,ite)<a name='973'>
               sm_input(i,1,j) = sm_input(i,2,j)<a name='974'>
               sm_input(i,num_sm_levels_input+2,j) = sm_input(i,num_sm_levels_input+1,j)<a name='975'>
            END DO<a name='976'>
         END DO<a name='977'>
   <a name='978'>
         <font color=#447700>!  Sort the levels for liquid moisture.<a name='979'></font>
   <a name='980'>
         outerw: DO lout = 1 , num_sw_levels_input-1<a name='981'>
            innerw : DO lin = lout+1 , num_sw_levels_input<a name='982'>
               IF ( sw_levels_input(lout) .GT. sw_levels_input(lin) ) THEN<a name='983'>
                  temp = sw_levels_input(lout) <a name='984'>
                  sw_levels_input(lout) = sw_levels_input(lin)<a name='985'>
                  sw_levels_input(lin) = NINT(temp)<a name='986'>
                  DO j = jts , MIN(jde-1,jte)<a name='987'>
                     DO i = its , MIN(ide-1,ite)<a name='988'>
                        temp = sw_input(i,lout+1,j)<a name='989'>
                        sw_input(i,lout+1,j) = sw_input(i,lin+1,j)<a name='990'>
                        sw_input(i,lin+1,j) = temp<a name='991'>
                     END DO<a name='992'>
                  END DO<a name='993'>
               END IF<a name='994'>
            END DO innerw<a name='995'>
         END DO outerw<a name='996'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='997'>
            DO j = jts , MIN(jde-1,jte)<a name='998'>
               DO i = its , MIN(ide-1,ite)<a name='999'>
                  sw_input(i,1,j) = sw_input(i,2,j)<a name='1000'>
                  sw_input(i,num_sw_levels_input+2,j) = sw_input(i,num_sw_levels_input+1,j)<a name='1001'>
               END DO<a name='1002'>
            END DO<a name='1003'>
         END IF<a name='1004'>
<a name='1005'>
         found_levels = .TRUE.<a name='1006'>
<a name='1007'>
      ELSE IF ( ( num .LE. 0 ) .AND. (  start_date .NE. current_date ) ) THEN<a name='1008'>
<a name='1009'>
         found_levels = .FALSE.<a name='1010'>
<a name='1011'>
      ELSE<a name='1012'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_244"> ( &amp;<a name='1013'>
         'No input soil level data (temperature, moisture or liquid, or all are missing). Required for LSM.' )<a name='1014'>
      END IF<a name='1015'>
<a name='1016'>
      <font color=#447700>!  Is it OK to continue?<a name='1017'></font>
<a name='1018'>
      IF ( found_levels ) THEN<a name='1019'>
<a name='1020'>
         <font color=#447700>!  Here are the levels that we have from the input for temperature.  The input levels plus<a name='1021'></font>
         <font color=#447700>!  two more: the skin temperature at 0 cm, and the annual mean temperature at 300 cm.<a name='1022'></font>
<a name='1023'>
         zhave(1) = 0.<a name='1024'>
         DO l = 1 , num_st_levels_input<a name='1025'>
            zhave(l+1) = st_levels_input(l) / 100.<a name='1026'>
         END DO<a name='1027'>
         zhave(num_st_levels_input+2) = 300. / 100.<a name='1028'>
   <a name='1029'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1030'></font>
   <a name='1031'>
         z_wantt : DO lwant = 1 , num_soil_layers<a name='1032'>
            z_havet : DO lhave = 1 , num_st_levels_input +2 -1<a name='1033'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1034'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1035'>
                  DO j = jts , MIN(jde-1,jte)<a name='1036'>
                     DO i = its , MIN(ide-1,ite)<a name='1037'>
                        tslb(i,lwant,j)= ( st_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1038'>
                                           st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1039'>
                                                                   ( zhave(lhave+1) - zhave(lhave) )<a name='1040'>
                     END DO<a name='1041'>
                  END DO<a name='1042'>
                  EXIT z_havet<a name='1043'>
               END IF<a name='1044'>
            END DO z_havet<a name='1045'>
         END DO z_wantt<a name='1046'>
<a name='1047'>
         <font color=#447700>!  Here are the levels that we have from the input for moisture.  The input levels plus<a name='1048'></font>
         <font color=#447700>!  two more: a value at 0 cm and one at 300 cm.  The 0 cm value is taken to be identical<a name='1049'></font>
         <font color=#447700>!  to the most shallow layer's value.  Similarly, the 300 cm value is taken to be the same<a name='1050'></font>
         <font color=#447700>!  as the most deep layer's value.<a name='1051'></font>
   <a name='1052'>
         zhave(1) = 0.<a name='1053'>
         DO l = 1 , num_sm_levels_input<a name='1054'>
            zhave(l+1) = sm_levels_input(l) / 100.<a name='1055'>
         END DO<a name='1056'>
         zhave(num_sm_levels_input+2) = 300. / 100.<a name='1057'>
   <a name='1058'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1059'></font>
   <a name='1060'>
         z_wantm : DO lwant = 1 , num_soil_layers<a name='1061'>
            z_havem : DO lhave = 1 , num_sm_levels_input +2 -1<a name='1062'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1063'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1064'>
                  DO j = jts , MIN(jde-1,jte)<a name='1065'>
                     DO i = its , MIN(ide-1,ite)<a name='1066'>
                        smois(i,lwant,j)= ( sm_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1067'>
                                            sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1068'>
                                                                    ( zhave(lhave+1) - zhave(lhave) )<a name='1069'>
                     END DO<a name='1070'>
                  END DO<a name='1071'>
                  EXIT z_havem<a name='1072'>
               END IF<a name='1073'>
            END DO z_havem<a name='1074'>
         END DO z_wantm<a name='1075'>
   <a name='1076'>
         <font color=#447700>!  Any liquid soil moisture to worry about?<a name='1077'></font>
   <a name='1078'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='1079'>
   <a name='1080'>
            zhave(1) = 0.<a name='1081'>
            DO l = 1 , num_sw_levels_input<a name='1082'>
               zhave(l+1) = sw_levels_input(l) / 100.<a name='1083'>
            END DO<a name='1084'>
            zhave(num_sw_levels_input+2) = 300. / 100.<a name='1085'>
      <a name='1086'>
            <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1087'></font>
      <a name='1088'>
            z_wantw : DO lwant = 1 , num_soil_layers<a name='1089'>
               z_havew : DO lhave = 1 , num_sw_levels_input +2 -1<a name='1090'>
                  IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1091'>
                       ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1092'>
                     DO j = jts , MIN(jde-1,jte)<a name='1093'>
                        DO i = its , MIN(ide-1,ite)<a name='1094'>
                           sh2o(i,lwant,j)= ( sw_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1095'>
                                               sw_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1096'>
                                                                       ( zhave(lhave+1) - zhave(lhave) )<a name='1097'>
                        END DO<a name='1098'>
                     END DO<a name='1099'>
                     EXIT z_havew<a name='1100'>
                  END IF<a name='1101'>
               END DO z_havew<a name='1102'>
            END DO z_wantw<a name='1103'>
   <a name='1104'>
         END IF<a name='1105'>
   <a name='1106'>
   <a name='1107'>
         <font color=#447700>!  Over water, put in reasonable values for soil temperature and moisture.  These won't be<a name='1108'></font>
         <font color=#447700>!  used, but they will make a more continuous plot.<a name='1109'></font>
   <a name='1110'>
         IF ( flag_sst .EQ. 1 ) THEN<a name='1111'>
            DO j = jts , MIN(jde-1,jte)<a name='1112'>
               DO i = its , MIN(ide-1,ite)<a name='1113'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='1114'>
                     DO l = 1 , num_soil_layers<a name='1115'>
                        tslb(i,l,j)= sst(i,j)<a name='1116'>
                        smois(i,l,j)= 1.0<a name='1117'>
                        sh2o (i,l,j)= 1.0<a name='1118'>
                     END DO<a name='1119'>
                  END IF<a name='1120'>
               END DO<a name='1121'>
            END DO<a name='1122'>
         ELSE<a name='1123'>
            DO j = jts , MIN(jde-1,jte)<a name='1124'>
               DO i = its , MIN(ide-1,ite)<a name='1125'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='1126'>
                     DO l = 1 , num_soil_layers<a name='1127'>
                        tslb(i,l,j)= tsk(i,j)<a name='1128'>
                        smois(i,l,j)= 1.0<a name='1129'>
                        sh2o (i,l,j)= 1.0<a name='1130'>
                     END DO<a name='1131'>
                  END IF<a name='1132'>
               END DO<a name='1133'>
            END DO<a name='1134'>
         END IF<a name='1135'>
   <a name='1136'>
         DEALLOCATE (zhave)<a name='1137'>
<a name='1138'>
      END IF<a name='1139'>
<a name='1140'>
   END SUBROUTINE init_soil_2_real<a name='1141'>
<a name='1142'>
<A NAME='INIT_SOIL_2_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1143'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_2_ideal</font> ( xland,xice,vegfra,snow,canwat,     &amp; <A href='../../call_to/INIT_SOIL_2_IDEAL.html' TARGET='index'>2</A><a name='1144'>
                     ivgtyp,isltyp,tslb,smois,tmn,                  &amp;<a name='1145'>
                     num_soil_layers,                               &amp;<a name='1146'>
                     ids,ide, jds,jde, kds,kde,                     &amp;<a name='1147'>
                     ims,ime, jms,jme, kms,kme,                     &amp;<a name='1148'>
                     its,ite, jts,jte, kts,kte                      )<a name='1149'>
<a name='1150'>
      IMPLICIT NONE <a name='1151'>
   <a name='1152'>
      INTEGER, INTENT(IN) ::ids,ide, jds,jde, kds,kde,  &amp;<a name='1153'>
                            ims,ime, jms,jme, kms,kme,  &amp;<a name='1154'>
                            its,ite, jts,jte, kts,kte<a name='1155'>
   <a name='1156'>
      INTEGER, INTENT(IN) ::num_soil_layers<a name='1157'>
   <a name='1158'>
      REAL, DIMENSION( ims:ime, num_soil_layers, jms:jme ) , INTENT(OUT) :: smois, tslb <a name='1159'>
   <a name='1160'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT)  :: xland, snow, canwat, xice, vegfra, tmn<a name='1161'>
   <a name='1162'>
      INTEGER, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: ivgtyp, isltyp<a name='1163'>
   <a name='1164'>
      INTEGER :: icm,jcm,itf,jtf<a name='1165'>
      INTEGER ::  i,j,l<a name='1166'>
   <a name='1167'>
      itf=min0(ite,ide-1)<a name='1168'>
      jtf=min0(jte,jde-1)<a name='1169'>
   <a name='1170'>
      icm = ide/2<a name='1171'>
      jcm = jde/2<a name='1172'>
   <a name='1173'>
      DO j=jts,jtf<a name='1174'>
         DO l=1,num_soil_layers<a name='1175'>
            DO i=its,itf<a name='1176'>
   <a name='1177'>
               smois(i,1,j)=0.10<a name='1178'>
               smois(i,2,j)=0.10<a name='1179'>
               smois(i,3,j)=0.10<a name='1180'>
               smois(i,4,j)=0.10<a name='1181'>
      <a name='1182'>
               tslb(i,1,j)=295.           <a name='1183'>
               tslb(i,2,j)=297.          <a name='1184'>
               tslb(i,3,j)=293.         <a name='1185'>
               tslb(i,4,j)=293. <a name='1186'>
<a name='1187'>
            ENDDO<a name='1188'>
         ENDDO<a name='1189'>
      ENDDO                                 <a name='1190'>
<a name='1191'>
      DO j=jts,jtf<a name='1192'>
         DO i=its,itf<a name='1193'>
            xland(i,j)  =   2<a name='1194'>
            tmn(i,j)    = 294. <a name='1195'>
            xice(i,j)   =   0.<a name='1196'>
            vegfra(i,j) =   0. <a name='1197'>
            snow(i,j)   =   0.<a name='1198'>
            canwat(i,j) =   0.<a name='1199'>
            ivgtyp(i,j) =   7<a name='1200'>
            isltyp(i,j) =   8<a name='1201'>
         ENDDO<a name='1202'>
      ENDDO<a name='1203'>
<a name='1204'>
   END SUBROUTINE init_soil_2_ideal<a name='1205'>
<a name='1206'>
<A NAME='INIT_SOIL_3_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1207'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_3_real</font> ( tsk , tmn , smois , tslb , &amp; <A href='../../call_to/INIT_SOIL_3_REAL.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_SOIL_3_REAL.html' TARGET='index'>3</A><a name='1208'>
                                 st_input , sm_input , landmask, sst, &amp;<a name='1209'>
                                 zs , dzs , &amp;<a name='1210'>
                                 st_levels_input , sm_levels_input , &amp;<a name='1211'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input ,  &amp;<a name='1212'>
                                 num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='1213'>
                                 flag_sst , flag_soilt000 , flag_soilm000 , &amp;<a name='1214'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='1215'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='1216'>
                                 its , ite , jts , jte , kts , kte )<a name='1217'>
<a name='1218'>
      IMPLICIT NONE<a name='1219'>
<a name='1220'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='1221'>
                              num_st_levels_input , num_sm_levels_input , &amp;<a name='1222'>
                              num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='1223'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='1224'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1225'>
                              its , ite , jts , jte , kts , kte<a name='1226'>
<a name='1227'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soilt000, flag_soilm000<a name='1228'>
<a name='1229'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='1230'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='1231'>
<a name='1232'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='1233'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='1234'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='1235'>
<a name='1236'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='1237'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='1238'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='1239'>
<a name='1240'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois<a name='1241'>
<a name='1242'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='1243'>
<a name='1244'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave<a name='1245'>
      REAL :: temp<a name='1246'>
<a name='1247'>
      <font color=#447700>!  Allocate the soil layer array used for interpolating.<a name='1248'></font>
<a name='1249'>
      IF ( ( num_st_levels_input .LE. 0 ) .OR. &amp; <a name='1250'>
           ( num_sm_levels_input .LE. 0 ) ) THEN<a name='1251'>
         PRINT '(A)','No input soil level data (either temperature or moisture, or both are missing).  Required for RUC LSM.'<a name='1252'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_245"> ( 'no soil data' )<a name='1253'>
      ELSE<a name='1254'>
         IF ( flag_soilt000 .eq. 1 ) THEN<a name='1255'>
           PRINT '(A)',' Assume RUC LSM 6-level input'<a name='1256'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input)  ) )<a name='1257'>
         ELSE<a name='1258'>
           PRINT '(A)',' Assume non-RUC LSM input'<a name='1259'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_soil_layers)  ) )<a name='1260'>
         END IF<a name='1261'>
      END IF<a name='1262'>
<a name='1263'>
      <font color=#447700>!  Sort the levels for temperature.<a name='1264'></font>
<a name='1265'>
      outert : DO lout = 1 , num_st_levels_input-1<a name='1266'>
         innert : DO lin = lout+1 , num_st_levels_input<a name='1267'>
            IF ( st_levels_input(lout) .GT. st_levels_input(lin) ) THEN<a name='1268'>
               temp = st_levels_input(lout) <a name='1269'>
               st_levels_input(lout) = st_levels_input(lin)<a name='1270'>
               st_levels_input(lin) = NINT(temp)<a name='1271'>
               DO j = jts , MIN(jde-1,jte)<a name='1272'>
                  DO i = its , MIN(ide-1,ite)<a name='1273'>
                     temp = st_input(i,lout,j)<a name='1274'>
                     st_input(i,lout,j) = st_input(i,lin,j)<a name='1275'>
                     st_input(i,lin,j) = temp<a name='1276'>
                  END DO<a name='1277'>
               END DO<a name='1278'>
            END IF<a name='1279'>
         END DO innert<a name='1280'>
      END DO outert<a name='1281'>
<a name='1282'>
      IF ( flag_soilt000 .NE. 1 ) THEN<a name='1283'>
      DO j = jts , MIN(jde-1,jte)<a name='1284'>
         DO i = its , MIN(ide-1,ite)<a name='1285'>
            st_input(i,1,j) = tsk(i,j)<a name='1286'>
            st_input(i,num_st_levels_input+2,j) = tmn(i,j)<a name='1287'>
         END DO<a name='1288'>
      END DO<a name='1289'>
      END IF<a name='1290'>
<a name='1291'>
      <font color=#447700>!  Sort the levels for moisture.<a name='1292'></font>
<a name='1293'>
      outerm: DO lout = 1 , num_sm_levels_input-1<a name='1294'>
         innerm : DO lin = lout+1 , num_sm_levels_input<a name='1295'>
            IF ( sm_levels_input(lout) .GT. sm_levels_input(lin) ) THEN<a name='1296'>
               temp = sm_levels_input(lout) <a name='1297'>
               sm_levels_input(lout) = sm_levels_input(lin)<a name='1298'>
               sm_levels_input(lin) = NINT(temp)<a name='1299'>
               DO j = jts , MIN(jde-1,jte)<a name='1300'>
                  DO i = its , MIN(ide-1,ite)<a name='1301'>
                     temp = sm_input(i,lout,j)<a name='1302'>
                     sm_input(i,lout,j) = sm_input(i,lin,j)<a name='1303'>
                     sm_input(i,lin,j) = temp<a name='1304'>
                  END DO<a name='1305'>
               END DO<a name='1306'>
            END IF<a name='1307'>
         END DO innerm<a name='1308'>
      END DO outerm<a name='1309'>
<a name='1310'>
      IF ( flag_soilm000 .NE. 1 ) THEN<a name='1311'>
      DO j = jts , MIN(jde-1,jte)<a name='1312'>
         DO i = its , MIN(ide-1,ite)<a name='1313'>
            sm_input(i,1,j) = sm_input(i,2,j)<a name='1314'>
            sm_input(i,num_sm_levels_input+2,j) = sm_input(i,num_sm_levels_input+1,j)<a name='1315'>
         END DO<a name='1316'>
      END DO<a name='1317'>
      END IF<a name='1318'>
<a name='1319'>
      <font color=#447700>!  Here are the levels that we have from the input for temperature.<a name='1320'></font>
<a name='1321'>
      IF ( flag_soilt000 .EQ. 1 ) THEN<a name='1322'>
         DO l = 1 , num_st_levels_input<a name='1323'>
            zhave(l) = st_levels_input(l) / 100.<a name='1324'>
         END DO<a name='1325'>
<a name='1326'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1327'></font>
<a name='1328'>
      z_wantt : DO lwant = 1 , num_soil_layers<a name='1329'>
         z_havet : DO lhave = 1 , num_st_levels_input -1<a name='1330'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1331'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1332'>
               DO j = jts , MIN(jde-1,jte)<a name='1333'>
                  DO i = its , MIN(ide-1,ite)<a name='1334'>
                     tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1335'>
                                        st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1336'>
                                                                ( zhave(lhave+1) - zhave(lhave) )<a name='1337'>
                  END DO<a name='1338'>
               END DO<a name='1339'>
               EXIT z_havet<a name='1340'>
            END IF<a name='1341'>
         END DO z_havet<a name='1342'>
      END DO z_wantt<a name='1343'>
<a name='1344'>
      ELSE<a name='1345'>
<a name='1346'>
         zhave(1) = 0.<a name='1347'>
         DO l = 1 , num_st_levels_input<a name='1348'>
            zhave(l+1) = st_levels_input(l) / 100.<a name='1349'>
         END DO<a name='1350'>
         zhave(num_st_levels_input+2) = 300. / 100.<a name='1351'>
<a name='1352'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1353'></font>
<a name='1354'>
      z_wantt_2 : DO lwant = 1 , num_soil_layers<a name='1355'>
         z_havet_2 : DO lhave = 1 , num_st_levels_input +2<a name='1356'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1357'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1358'>
               DO j = jts , MIN(jde-1,jte)<a name='1359'>
                  DO i = its , MIN(ide-1,ite)<a name='1360'>
                     tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1361'>
                                        st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1362'>
                                                                ( zhave(lhave+1) - zhave(lhave) )<a name='1363'>
                  END DO<a name='1364'>
               END DO<a name='1365'>
               EXIT z_havet_2<a name='1366'>
            END IF<a name='1367'>
         END DO z_havet_2<a name='1368'>
      END DO z_wantt_2<a name='1369'>
<a name='1370'>
      END IF<a name='1371'>
<a name='1372'>
      <font color=#447700>!  Here are the levels that we have from the input for moisture.<a name='1373'></font>
<a name='1374'>
      IF ( flag_soilm000 .EQ. 1 ) THEN<a name='1375'>
         DO l = 1 , num_sm_levels_input<a name='1376'>
            zhave(l) = sm_levels_input(l) / 100.<a name='1377'>
         END DO<a name='1378'>
<a name='1379'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1380'></font>
<a name='1381'>
      z_wantm : DO lwant = 1 , num_soil_layers<a name='1382'>
         z_havem : DO lhave = 1 , num_sm_levels_input -1<a name='1383'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1384'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1385'>
               DO j = jts , MIN(jde-1,jte)<a name='1386'>
                  DO i = its , MIN(ide-1,ite)<a name='1387'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1388'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1389'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='1390'>
                  END DO<a name='1391'>
               END DO<a name='1392'>
               EXIT z_havem<a name='1393'>
            END IF<a name='1394'>
         END DO z_havem<a name='1395'>
      END DO z_wantm<a name='1396'>
<a name='1397'>
      ELSE<a name='1398'>
<a name='1399'>
         zhave(1) = 0.<a name='1400'>
         DO l = 1 , num_sm_levels_input<a name='1401'>
            zhave(l+1) = sm_levels_input(l) / 100.<a name='1402'>
         END DO<a name='1403'>
         zhave(num_sm_levels_input+2) = 300. / 100.<a name='1404'>
<a name='1405'>
      z_wantm_2 : DO lwant = 1 , num_soil_layers<a name='1406'>
         z_havem_2 : DO lhave = 1 , num_sm_levels_input +2<a name='1407'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1408'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1409'>
               DO j = jts , MIN(jde-1,jte)<a name='1410'>
                  DO i = its , MIN(ide-1,ite)<a name='1411'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1412'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1413'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='1414'>
                  END DO<a name='1415'>
               END DO<a name='1416'>
               EXIT z_havem_2<a name='1417'>
            END IF<a name='1418'>
         END DO z_havem_2<a name='1419'>
      END DO z_wantm_2<a name='1420'>
<a name='1421'>
      END IF<a name='1422'>
      <font color=#447700>!  Over water, put in reasonable values for soil temperature and moisture.  These won't be<a name='1423'></font>
      <font color=#447700>!  used, but they will make a more continuous plot.<a name='1424'></font>
<a name='1425'>
      IF ( flag_sst .EQ. 1 ) THEN<a name='1426'>
         DO j = jts , MIN(jde-1,jte)<a name='1427'>
            DO i = its , MIN(ide-1,ite)<a name='1428'>
               IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='1429'>
                  DO l = 1 , num_soil_layers<a name='1430'>
                     tslb(i,l,j) = sst(i,j)<a name='1431'>
                     tsk(i,j)    = sst(i,j)<a name='1432'>
                     smois(i,l,j)= 1.0<a name='1433'>
                  END DO<a name='1434'>
               END IF<a name='1435'>
            END DO<a name='1436'>
         END DO<a name='1437'>
      ELSE<a name='1438'>
         DO j = jts , MIN(jde-1,jte)<a name='1439'>
            DO i = its , MIN(ide-1,ite)<a name='1440'>
               IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='1441'>
                  DO l = 1 , num_soil_layers<a name='1442'>
                     tslb(i,l,j)= tsk(i,j)<a name='1443'>
                     smois(i,l,j)= 1.0<a name='1444'>
                  END DO<a name='1445'>
               END IF<a name='1446'>
            END DO<a name='1447'>
         END DO<a name='1448'>
      END IF<a name='1449'>
<a name='1450'>
      DEALLOCATE (zhave)<a name='1451'>
<a name='1452'>
   END SUBROUTINE init_soil_3_real<a name='1453'>
<a name='1454'>
END MODULE module_soil_pre<a name='1455'>
<a name='1456'>
#else<a name='1457'>
<a name='1458'>
<A NAME='MODULE_SOIL_PRE'><A href='../../html_code/share/module_soil_pre.F.html#MODULE_SOIL_PRE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='1459'>
<font color=#993300>MODULE </font><font color=#cc0000>module_soil_pre</font> <A href='../../call_to/MODULE_SOIL_PRE.html' TARGET='index'>2</A><a name='1460'>
<a name='1461'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_16"><a name='1462'>
   USE module_state_description<a name='1463'>
<a name='1464'>
CONTAINS<a name='1465'>
<a name='1466'>
<A NAME='ADJUST_FOR_SEAICE_PRE'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1467'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_for_seaice_pre</font> ( xice , landmask , tsk , ivgtyp , vegcat , lu_index , &amp; <A href='../../call_to/ADJUST_FOR_SEAICE_PRE.html' TARGET='index'>1</A>,<A href='../../call_from/ADJUST_FOR_SEAICE_PRE.html' TARGET='index'>5</A><a name='1468'>
                                      xland , landusef , isltyp , soilcat , soilctop , &amp;<a name='1469'>
                                      soilcbot , tmn , &amp;<a name='1470'>
                                      seaice_threshold , &amp;<a name='1471'>
                                      num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='1472'>
                                      iswater , isice , &amp;<a name='1473'>
                                      scheme , &amp;<a name='1474'>
                                      ids , ide , jds , jde , kds , kde , &amp;<a name='1475'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='1476'>
                                      its , ite , jts , jte , kts , kte )<a name='1477'>
<a name='1478'>
      IMPLICIT NONE<a name='1479'>
<a name='1480'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='1481'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1482'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='1483'>
                              iswater , isice <a name='1484'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat , scheme<a name='1485'>
<a name='1486'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landusef<a name='1487'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(INOUT):: soilctop<a name='1488'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(INOUT):: soilcbot<a name='1489'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='1490'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask , xice , tsk , lu_index , &amp;<a name='1491'>
                                                           vegcat, xland , soilcat , tmn<a name='1492'>
      REAL , INTENT(IN) :: seaice_threshold<a name='1493'>
<a name='1494'>
      INTEGER :: i , j , num_seaice_changes , loop<a name='1495'>
      CHARACTER (LEN=132) :: message<a name='1496'>
      <a name='1497'>
      fix_seaice : SELECT CASE ( scheme ) <a name='1498'>
 <a name='1499'>
         CASE ( SLABSCHEME ) <a name='1500'>
            DO j = jts , MIN(jde-1,jte)<a name='1501'>
               DO i = its , MIN(ide-1,ite)<a name='1502'>
                  IF ( xice(i,j) .GT. 200.0 ) THEN<a name='1503'>
                     xice(i,j) = 0.<a name='1504'>
                     num_seaice_changes = num_seaice_changes + 1<a name='1505'>
                  END IF<a name='1506'>
               END DO<a name='1507'>
            END DO<a name='1508'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='1509'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='1510'>
               'Total pre number of sea ice locations removed (due to FLAG values) = ', &amp;<a name='1511'>
               num_seaice_changes<a name='1512'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_259"> ( 0 , message )  <a name='1513'>
            END IF<a name='1514'>
            num_seaice_changes = 0<a name='1515'>
            DO j = jts , MIN(jde-1,jte)<a name='1516'>
               DO i = its , MIN(ide-1,ite)<a name='1517'>
                  IF ( ( xice(i,j) .GE. 0.5 ) .OR. &amp;<a name='1518'>
                       ( ( landmask(i,j) .LT. 0.5 ) .AND. ( tsk(i,j) .LT. seaice_threshold ) ) ) THEN<a name='1519'>
                     xice(i,j) = 1.<a name='1520'>
                     num_seaice_changes = num_seaice_changes + 1<a name='1521'>
                     tmn(i,j) = 271.4<a name='1522'>
                     vegcat(i,j)=isice<a name='1523'>
                     lu_index(i,j)=ivgtyp(i,j)<a name='1524'>
                     landmask(i,j)=1.<a name='1525'>
                     xland(i,j)=1.<a name='1526'>
                     DO loop=1,num_veg_cat<a name='1527'>
                        landusef(i,loop,j)=0.<a name='1528'>
                     END DO<a name='1529'>
                     landusef(i,ivgtyp(i,j),j)=1.<a name='1530'>
<a name='1531'>
                     isltyp(i,j) = 16<a name='1532'>
                     soilcat(i,j)=isltyp(i,j)<a name='1533'>
                     DO loop=1,num_soil_top_cat<a name='1534'>
                        soilctop(i,loop,j)=0<a name='1535'>
                     END DO<a name='1536'>
                     DO loop=1,num_soil_bot_cat<a name='1537'>
                        soilcbot(i,loop,j)=0<a name='1538'>
                     END DO<a name='1539'>
                     soilctop(i,isltyp(i,j),j)=1.<a name='1540'>
                     soilcbot(i,isltyp(i,j),j)=1.<a name='1541'>
                  END IF<a name='1542'>
               END DO<a name='1543'>
            END DO<a name='1544'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='1545'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='1546'>
               'Total pre number of sea ice location changes (water to land) = ', num_seaice_changes<a name='1547'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_260"> ( 0 , message )  <a name='1548'>
            END IF<a name='1549'>
<a name='1550'>
         CASE ( LSMSCHEME ) <a name='1551'>
         CASE ( RUCLSMSCHEME ) <a name='1552'>
<a name='1553'>
      END SELECT fix_seaice<a name='1554'>
<a name='1555'>
   END SUBROUTINE adjust_for_seaice_pre<a name='1556'>
<a name='1557'>
<A NAME='ADJUST_FOR_SEAICE_POST'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1558'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_for_seaice_post</font> ( xice , landmask , tsk , ivgtyp , vegcat , lu_index , &amp; <A href='../../call_to/ADJUST_FOR_SEAICE_POST.html' TARGET='index'>1</A>,<A href='../../call_from/ADJUST_FOR_SEAICE_POST.html' TARGET='index'>5</A><a name='1559'>
                                      xland , landusef , isltyp , soilcat , soilctop , &amp;<a name='1560'>
                                      soilcbot , tmn , &amp;<a name='1561'>
                                      tslb , smois , sh2o , &amp;<a name='1562'>
                                      seaice_threshold , &amp;<a name='1563'>
                                      num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='1564'>
                                      num_soil_layers , &amp;<a name='1565'>
                                      iswater , isice , &amp;<a name='1566'>
                                      scheme , &amp;<a name='1567'>
                                      ids , ide , jds , jde , kds , kde , &amp;<a name='1568'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='1569'>
                                      its , ite , jts , jte , kts , kte )<a name='1570'>
<a name='1571'>
      IMPLICIT NONE<a name='1572'>
<a name='1573'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='1574'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1575'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='1576'>
                              iswater , isice <a name='1577'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat , scheme<a name='1578'>
      INTEGER , INTENT(IN) :: num_soil_layers<a name='1579'>
<a name='1580'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landusef<a name='1581'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(INOUT):: soilctop<a name='1582'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(INOUT):: soilcbot<a name='1583'>
      REAL , DIMENSION(ims:ime,1:num_soil_layers,jms:jme) , INTENT(INOUT):: tslb , smois , sh2o<a name='1584'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='1585'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask , xice , tsk , lu_index , &amp;<a name='1586'>
                                                           vegcat, xland , soilcat , tmn<a name='1587'>
      REAL , INTENT(IN) :: seaice_threshold<a name='1588'>
      REAL :: total_depth , mid_point_depth<a name='1589'>
<a name='1590'>
      INTEGER :: i , j , num_seaice_changes , loop<a name='1591'>
      CHARACTER (LEN=132) :: message<a name='1592'>
      <a name='1593'>
      fix_seaice : SELECT CASE ( scheme ) <a name='1594'>
 <a name='1595'>
         CASE ( SLABSCHEME ) <a name='1596'>
<a name='1597'>
         CASE ( LSMSCHEME ) <a name='1598'>
            DO j = jts , MIN(jde-1,jte)<a name='1599'>
               DO i = its , MIN(ide-1,ite)<a name='1600'>
                  IF ( xice(i,j) .GT. 200.0 ) THEN<a name='1601'>
                     xice(i,j) = 0.<a name='1602'>
                     num_seaice_changes = num_seaice_changes + 1<a name='1603'>
                  END IF<a name='1604'>
               END DO<a name='1605'>
            END DO<a name='1606'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='1607'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='1608'>
               'Total post number of sea ice locations removed (due to FLAG values) = ', &amp;<a name='1609'>
               num_seaice_changes<a name='1610'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_261"> ( 0 , message )  <a name='1611'>
            END IF<a name='1612'>
            num_seaice_changes = 0<a name='1613'>
            DO j = jts , MIN(jde-1,jte)<a name='1614'>
               DO i = its , MIN(ide-1,ite)<a name='1615'>
                  IF ( ( xice(i,j) .GE. 0.5 ) .OR. &amp;<a name='1616'>
                       ( ( landmask(i,j) .LT. 0.5 ) .AND. ( tsk(i,j) .LT. seaice_threshold ) ) ) THEN<a name='1617'>
                     xice(i,j) = 1.<a name='1618'>
                     num_seaice_changes = num_seaice_changes + 1<a name='1619'>
                     tmn(i,j) = 271.16<a name='1620'>
                     vegcat(i,j)=isice<a name='1621'>
                     lu_index(i,j)=ivgtyp(i,j)<a name='1622'>
                     landmask(i,j)=1.<a name='1623'>
                     xland(i,j)=1.<a name='1624'>
                     DO loop=1,num_veg_cat<a name='1625'>
                        landusef(i,loop,j)=0.<a name='1626'>
                     END DO<a name='1627'>
                     landusef(i,ivgtyp(i,j),j)=1.<a name='1628'>
<a name='1629'>
                     isltyp(i,j) = 16<a name='1630'>
                     soilcat(i,j)=isltyp(i,j)<a name='1631'>
                     DO loop=1,num_soil_top_cat<a name='1632'>
                        soilctop(i,loop,j)=0<a name='1633'>
                     END DO<a name='1634'>
                     DO loop=1,num_soil_bot_cat<a name='1635'>
                        soilcbot(i,loop,j)=0<a name='1636'>
                     END DO<a name='1637'>
                     soilctop(i,isltyp(i,j),j)=1.<a name='1638'>
                     soilcbot(i,isltyp(i,j),j)=1.<a name='1639'>
<a name='1640'>
                     total_depth = 3. <font color=#447700>! ice is 3 m deep, num_soil_layers equispaced layers<a name='1641'></font>
                     DO loop = 1,num_soil_layers<a name='1642'>
                        mid_point_depth=(total_depth/num_soil_layers)/2. + &amp;<a name='1643'>
                                        (loop-1)*(total_depth/num_soil_layers)<a name='1644'>
                        tslb(i,loop,j) = ( (total_depth-mid_point_depth)*tsk(i,j) + &amp;<a name='1645'>
                                            mid_point_depth*tmn(i,j) ) / total_depth<a name='1646'>
                     END DO<a name='1647'>
<a name='1648'>
                     DO loop=1,num_soil_layers<a name='1649'>
                        smois(i,loop,j) = 1.0<a name='1650'>
                        sh2o(i,loop,j)  = 0.0<a name='1651'>
                     END DO<a name='1652'>
                  END IF<a name='1653'>
               END DO<a name='1654'>
            END DO<a name='1655'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='1656'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='1657'>
               'Total post number of sea ice location changes (water to land) = ', num_seaice_changes<a name='1658'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_262"> ( 0 , message )  <a name='1659'>
            END IF<a name='1660'>
<a name='1661'>
         CASE ( RUCLSMSCHEME ) <a name='1662'>
<a name='1663'>
      END SELECT fix_seaice<a name='1664'>
<a name='1665'>
   END SUBROUTINE adjust_for_seaice_post<a name='1666'>
<a name='1667'>
<A NAME='PROCESS_PERCENT_CAT_NEW'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1668'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_percent_cat_new</font> ( landmask ,  &amp; <A href='../../call_to/PROCESS_PERCENT_CAT_NEW.html' TARGET='index'>2</A>,<A href='../../call_from/PROCESS_PERCENT_CAT_NEW.html' TARGET='index'>14</A><a name='1669'>
                                landuse_frac , soil_top_cat , soil_bot_cat , &amp;<a name='1670'>
                                isltyp , ivgtyp , &amp;<a name='1671'>
                                num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='1672'>
                                ids , ide , jds , jde , kds , kde , &amp;<a name='1673'>
                                ims , ime , jms , jme , kms , kme , &amp;<a name='1674'>
                                its , ite , jts , jte , kts , kte , &amp;<a name='1675'>
                                iswater )<a name='1676'>
<a name='1677'>
      IMPLICIT NONE<a name='1678'>
<a name='1679'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='1680'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1681'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='1682'>
                              iswater<a name='1683'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='1684'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landuse_frac<a name='1685'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(IN):: soil_top_cat<a name='1686'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(IN):: soil_bot_cat<a name='1687'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='1688'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask<a name='1689'>
<a name='1690'>
      INTEGER :: i , j , l , ll, dominant_index<a name='1691'>
      REAL :: dominant_value<a name='1692'>
<a name='1693'>
#ifdef WRF_CHEM<a name='1694'>
<font color=#447700>!      REAL :: lwthresh = .99<a name='1695'></font>
      REAL :: lwthresh = .50<a name='1696'>
#else<a name='1697'>
      REAL :: lwthresh = .50<a name='1698'>
#endif<a name='1699'>
<a name='1700'>
      INTEGER , PARAMETER :: iswater_soil = 14<a name='1701'>
      INTEGER :: iforce<a name='1702'>
      CHARACTER (LEN=132) :: message<a name='1703'>
<a name='1704'>
      <font color=#447700>!  Sanity check on the 50/50 points<a name='1705'></font>
<a name='1706'>
      DO j = jts , MIN(jde-1,jte)<a name='1707'>
         DO i = its , MIN(ide-1,ite)<a name='1708'>
            dominant_value = landuse_frac(i,iswater,j)<a name='1709'>
            IF ( dominant_value .EQ. lwthresh ) THEN<a name='1710'>
               DO l = 1 , num_veg_cat<a name='1711'>
                  IF ( l .EQ. iswater ) CYCLE<a name='1712'>
                  IF ( landuse_frac(i,l,j) .EQ. lwthresh ) THEN<a name='1713'>
                     PRINT *,i,j,' water and category ',l,' both at 50%, landmask is ',landmask(i,j)<a name='1714'>
                     landuse_frac(i,l,j) = lwthresh - .01<a name='1715'>
                     landuse_frac(i,iswater,j) = 1. - (lwthresh + 0.01)<a name='1716'>
                  END IF<a name='1717'>
               END DO<a name='1718'>
            END IF<a name='1719'>
         END DO<a name='1720'>
      END DO<a name='1721'>
<a name='1722'>
      <font color=#447700>!  Compute the dominant VEGETATION INDEX.<a name='1723'></font>
<a name='1724'>
      DO j = jts , MIN(jde-1,jte)<a name='1725'>
         DO i = its , MIN(ide-1,ite)<a name='1726'>
            dominant_value = landuse_frac(i,1,j)<a name='1727'>
            dominant_index = 1<a name='1728'>
            DO l = 2 , num_veg_cat<a name='1729'>
               IF        ( l .EQ. iswater ) THEN<a name='1730'>
                  <font color=#447700>! wait a bit<a name='1731'></font>
               ELSE IF ( ( l .NE. iswater ) .AND. ( landuse_frac(i,l,j) .GT. dominant_value ) ) THEN<a name='1732'>
                  dominant_value = landuse_frac(i,l,j)<a name='1733'>
                  dominant_index = l<a name='1734'>
               END IF<a name='1735'>
            END DO<a name='1736'>
            IF ( landuse_frac(i,iswater,j) .GT. lwthresh ) THEN<a name='1737'>
               dominant_value = landuse_frac(i,iswater,j)<a name='1738'>
               dominant_index = iswater<a name='1739'>
#if 0<a name='1740'>
si needs to beef up consistency checks before we can use this part<a name='1741'>
            ELSE IF ( ( landuse_frac(i,iswater,j) .EQ. lwthresh) .AND. &amp;<a name='1742'>
                      ( dominant_value .EQ. lwthresh) ) THEN<a name='1743'>
               <font color=#447700>! no op<a name='1744'></font>
#else<a name='1745'>
ELSEIF((landuse_frac(i,iswater,j).EQ.lwthresh).AND.(dominant_value.EQ.lwthresh).and.(dominant_index.LT.iswater))THEN<a name='1746'>
write(message,*)'temporary SI landmask fix'<a name='1747'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_122">(trim(message))<a name='1748'>
<font color=#447700>! no op<a name='1749'></font>
ELSEIF((landuse_frac(i,iswater,j).EQ.lwthresh).AND.(dominant_value.EQ.lwthresh).and.(dominant_index.GT.iswater))THEN<a name='1750'>
write(message,*)'temporary SI landmask fix'<a name='1751'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_123">(trim(message))<a name='1752'>
dominant_value = landuse_frac(i,iswater,j)<a name='1753'>
dominant_index = iswater<a name='1754'>
#endif<a name='1755'>
            ELSE IF ( ( landuse_frac(i,iswater,j) .EQ. lwthresh ) .AND. &amp;<a name='1756'>
                      ( dominant_value .LT. lwthresh ) ) THEN<a name='1757'>
               dominant_value = landuse_frac(i,iswater,j)<a name='1758'>
               dominant_index = iswater<a name='1759'>
            END IF<a name='1760'>
            IF      ( dominant_index .EQ. iswater ) THEN<a name='1761'>
if(landmask(i,j).gt.lwthresh) then<a name='1762'>
write(message,*) 'changing to water at point ',i,j<a name='1763'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_124">(trim(message))<a name='1764'>
write(message,*)  nint(landuse_frac(i,:,j)*100)<a name='1765'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_125">(trim(message))<a name='1766'>
endif<a name='1767'>
               landmask(i,j) = 0<a name='1768'>
            ELSE IF ( dominant_index .NE. iswater ) THEN<a name='1769'>
if(landmask(i,j).lt.lwthresh) then<a name='1770'>
write(message,*) 'changing to land at point ',i,j<a name='1771'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_126">(trim(message))<a name='1772'>
write(message,*) nint(landuse_frac(i,:,j)*100)<a name='1773'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_127">(trim(message))<a name='1774'>
endif<a name='1775'>
               landmask(i,j) = 1<a name='1776'>
            END IF<a name='1777'>
            ivgtyp(i,j) = dominant_index<a name='1778'>
         END DO<a name='1779'>
      END DO<a name='1780'>
<a name='1781'>
      <font color=#447700>!  Compute the dominant SOIL TEXTURE INDEX, TOP.<a name='1782'></font>
<a name='1783'>
      iforce = 0<a name='1784'>
      DO i = its , MIN(ide-1,ite)<a name='1785'>
         DO j = jts , MIN(jde-1,jte)<a name='1786'>
            dominant_value = soil_top_cat(i,1,j)<a name='1787'>
            dominant_index = 1<a name='1788'>
            IF ( landmask(i,j) .GT. lwthresh ) THEN<a name='1789'>
               DO l = 2 , num_soil_top_cat<a name='1790'>
                  IF ( ( l .NE. iswater_soil ) .AND. ( soil_top_cat(i,l,j) .GT. dominant_value ) ) THEN<a name='1791'>
                     dominant_value = soil_top_cat(i,l,j)<a name='1792'>
                     dominant_index = l<a name='1793'>
                  END IF<a name='1794'>
               END DO<a name='1795'>
               IF ( dominant_value .LT. 0.01 ) THEN<a name='1796'>
                  iforce = iforce + 1<a name='1797'>
                  WRITE ( message , FMT = '(A,I4,I4)' ) &amp;<a name='1798'>
                  'based on landuse, changing soil to land at point ',i,j<a name='1799'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_263">(1,message)<a name='1800'>
                  WRITE ( message , FMT = '(16(i3,1x))' ) &amp;<a name='1801'>
                  1, 2, 3, 4, 5, 6, 7, 8, 9, 10,11,12, 13, 14, 15, 16<a name='1802'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_264">(1,message)<a name='1803'>
                  WRITE ( message , FMT = '(16(i3,1x))' ) &amp;<a name='1804'>
                  nint(soil_top_cat(i,:,j)*100)<a name='1805'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_265">(1,message)<a name='1806'>
                  dominant_index = 8<a name='1807'>
               END IF<a name='1808'>
            ELSE<a name='1809'>
               dominant_index = iswater_soil<a name='1810'>
            END IF<a name='1811'>
            isltyp(i,j) = dominant_index<a name='1812'>
         END DO<a name='1813'>
      END DO<a name='1814'>
<a name='1815'>
if(iforce.ne.0)then<a name='1816'>
WRITE(message,FMT='(A,I4,A,I6)' ) &amp;<a name='1817'>
'forcing artificial silty clay loam at ',iforce,' points, out of ',&amp;<a name='1818'>
(MIN(ide-1,ite)-its+1)*(MIN(jde-1,jte)-jts+1)<a name='1819'>
CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_266">(0,message)<a name='1820'>
endif<a name='1821'>
<a name='1822'>
   END SUBROUTINE process_percent_cat_new<a name='1823'>
<a name='1824'>
<A NAME='PROCESS_SOIL_REAL'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1825'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_soil_real</font> ( tsk , tmn , &amp; <A href='../../call_to/PROCESS_SOIL_REAL.html' TARGET='index'>1</A>,<A href='../../call_from/PROCESS_SOIL_REAL.html' TARGET='index'>12</A><a name='1826'>
                                landmask , sst , &amp;<a name='1827'>
                                st_input , sm_input , sw_input , st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='1828'>
                                zs , dzs , tslb , smois , sh2o , &amp;<a name='1829'>
                                flag_sst , flag_soilt000, flag_soilm000, &amp;<a name='1830'>
                                ids , ide , jds , jde , kds , kde , &amp;<a name='1831'>
                                ims , ime , jms , jme , kms , kme , &amp;<a name='1832'>
                                its , ite , jts , jte , kts , kte , &amp;<a name='1833'>
                                sf_surface_physics , num_soil_layers , real_data_init_type , &amp;<a name='1834'>
                                num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='1835'>
                                num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc )<a name='1836'>
<a name='1837'>
      IMPLICIT NONE<a name='1838'>
<a name='1839'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='1840'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1841'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='1842'>
                              sf_surface_physics , num_soil_layers , real_data_init_type , &amp;<a name='1843'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='1844'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc <a name='1845'>
<a name='1846'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soilt000, flag_soilm000<a name='1847'>
<a name='1848'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='1849'>
<a name='1850'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='1851'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='1852'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='1853'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='1854'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='1855'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='1856'>
<a name='1857'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='1858'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='1859'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn <a name='1860'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='1861'>
<a name='1862'>
      INTEGER :: i , j , l , dominant_index , num_soil_cat , num_veg_cat<a name='1863'>
      REAL :: dominant_value<a name='1864'>
<a name='1865'>
      <font color=#447700>!  Initialize the soil depth, and the soil temperature and moisture.<a name='1866'></font>
<a name='1867'>
      IF      ( ( sf_surface_physics .EQ. 1 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='1868'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1'>init_soil_depth_1</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_1_3"> ( zs , dzs , num_soil_layers )<a name='1869'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_REAL'>init_soil_1_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_1_REAL_2"> ( tsk , tmn , tslb , zs , dzs , num_soil_layers , real_data_init_type , &amp;<a name='1870'>
                                 landmask , sst , flag_sst , &amp;<a name='1871'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='1872'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='1873'>
                                 its , ite , jts , jte , kts , kte )<a name='1874'>
<a name='1875'>
      ELSE IF ( ( sf_surface_physics .EQ. 2 .or. sf_surface_physics .EQ. 99 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='1876'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_3"> ( zs , dzs , num_soil_layers )<a name='1877'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL'>init_soil_2_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_REAL_2"> ( tsk , tmn , smois , sh2o , tslb , &amp;<a name='1878'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='1879'>
                                 zs , dzs , &amp;<a name='1880'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='1881'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='1882'>
                                 num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='1883'>
                                 flag_sst , flag_soilt000 , flag_soilm000 , &amp;<a name='1884'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='1885'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='1886'>
                                 its , ite , jts , jte , kts , kte )<a name='1887'>
<font color=#447700>!        CALL init_soil_old ( tsk , tmn , &amp;<a name='1888'></font>
<font color=#447700>!                             smois , tslb , zs , dzs , num_soil_layers , &amp;<a name='1889'></font>
<font color=#447700>!                             st000010_input , st010040_input , st040100_input , st100200_input , &amp;<a name='1890'></font>
<font color=#447700>!                             st010200_input , &amp;<a name='1891'></font>
<font color=#447700>!                             sm000010_input , sm010040_input , sm040100_input , sm100200_input , &amp;<a name='1892'></font>
<font color=#447700>!                             sm010200_input , &amp;<a name='1893'></font>
<font color=#447700>!                             landmask_input , sst_input , &amp;<a name='1894'></font>
<font color=#447700>!                             ids , ide , jds , jde , kds , kde , &amp;<a name='1895'></font>
<font color=#447700>!                             ims , ime , jms , jme , kms , kme , &amp;<a name='1896'></font>
<font color=#447700>!                             its , ite , jts , jte , kts , kte )<a name='1897'></font>
      ELSE IF ( ( sf_surface_physics .EQ. 3 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='1898'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3'>init_soil_depth_3</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_3_3"> ( zs , dzs , num_soil_layers )<a name='1899'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL'>init_soil_3_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_3_REAL_2"> ( tsk , tmn , smois , tslb , &amp;<a name='1900'>
                                 st_input , sm_input , landmask , sst , &amp;<a name='1901'>
                                 zs , dzs , &amp;<a name='1902'>
                                 st_levels_input , sm_levels_input , &amp;<a name='1903'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , &amp;<a name='1904'>
                                 num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='1905'>
                                 flag_sst , flag_soilt000 , flag_soilm000 , &amp;<a name='1906'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='1907'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='1908'>
                                 its , ite , jts , jte , kts , kte )<a name='1909'>
      END IF<a name='1910'>
<a name='1911'>
   END SUBROUTINE process_soil_real<a name='1912'>
<a name='1913'>
<A NAME='PROCESS_SOIL_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1914'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_soil_ideal</font> ( xland,xice,vegfra,snow,canwat,  &amp;,<A href='../../call_from/PROCESS_SOIL_IDEAL.html' TARGET='index'>10</A><a name='1915'>
                                   ivgtyp,isltyp,tslb,smois, &amp;<a name='1916'>
                                   tsk,tmn,zs,dzs,           &amp;<a name='1917'>
                                   num_soil_layers,          &amp;<a name='1918'>
                                   sf_surface_physics ,      &amp;<a name='1919'>
                                   ids,ide, jds,jde, kds,kde,&amp;<a name='1920'>
                                   ims,ime, jms,jme, kms,kme,&amp;<a name='1921'>
                                   its,ite, jts,jte, kts,kte )<a name='1922'>
<a name='1923'>
      IMPLICIT NONE<a name='1924'>
<a name='1925'>
      INTEGER, INTENT(IN) ::ids,ide, jds,jde, kds,kde,  &amp;<a name='1926'>
                            ims,ime, jms,jme, kms,kme,  &amp;<a name='1927'>
                            its,ite, jts,jte, kts,kte<a name='1928'>
  <a name='1929'>
      INTEGER, INTENT(IN) :: num_soil_layers , sf_surface_physics<a name='1930'>
<a name='1931'>
      REAL, DIMENSION( ims:ime, num_soil_layers, jms:jme ) , INTENT(INOUT) :: smois, tslb<a name='1932'>
<a name='1933'>
      REAL, DIMENSION(num_soil_layers), INTENT(OUT) :: dzs,zs<a name='1934'>
<a name='1935'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT) :: tsk, tmn<a name='1936'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: xland, snow, canwat, xice, vegfra<a name='1937'>
      INTEGER, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: ivgtyp, isltyp<a name='1938'>
<a name='1939'>
      <font color=#447700>!  Local variables.<a name='1940'></font>
<a name='1941'>
      INTEGER :: itf,jtf<a name='1942'>
<a name='1943'>
      itf=MIN(ite,ide-1)<a name='1944'>
      jtf=MIN(jte,jde-1)<a name='1945'>
<a name='1946'>
      IF      ( ( sf_surface_physics .EQ. 1 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='1947'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1'>init_soil_depth_1</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_1_4"> ( zs , dzs , num_soil_layers )<a name='1948'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_IDEAL'>init_soil_1_ideal</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_1_IDEAL_2">(tsk,tmn,tslb,xland,                      &amp;<a name='1949'>
                                ivgtyp,zs,dzs,num_soil_layers,           &amp;<a name='1950'>
                                ids,ide, jds,jde, kds,kde,               &amp;<a name='1951'>
                                ims,ime, jms,jme, kms,kme,               &amp;<a name='1952'>
                                its,ite, jts,jte, kts,kte                )<a name='1953'>
      ELSE IF ( ( sf_surface_physics .EQ. 2 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='1954'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_4"> ( zs , dzs , num_soil_layers )<a name='1955'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_IDEAL'>init_soil_2_ideal</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_IDEAL_2"> ( xland,xice,vegfra,snow,canwat,         &amp;<a name='1956'>
                                  ivgtyp,isltyp,tslb,smois,tmn,          &amp;<a name='1957'>
                                  num_soil_layers,                       &amp;<a name='1958'>
                                  ids,ide, jds,jde, kds,kde,             &amp;<a name='1959'>
                                  ims,ime, jms,jme, kms,kme,             &amp;<a name='1960'>
                                  its,ite, jts,jte, kts,kte              )<a name='1961'>
      ELSE IF ( ( sf_surface_physics .EQ. 3 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='1962'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3'>init_soil_depth_3</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_3_4"> ( zs , dzs , num_soil_layers )<a name='1963'>
<a name='1964'>
      END IF<a name='1965'>
<a name='1966'>
   END SUBROUTINE process_soil_ideal<a name='1967'>
<a name='1968'>
<A NAME='ADJUST_SOIL_TEMP_NEW'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1969'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_soil_temp_new</font> ( tmn , sf_surface_physics , &amp; <A href='../../call_to/ADJUST_SOIL_TEMP_NEW.html' TARGET='index'>1</A>,<A href='../../call_from/ADJUST_SOIL_TEMP_NEW.html' TARGET='index'>4</A><a name='1970'>
                                 tsk , ter , toposoil , landmask , flag_toposoil , &amp;<a name='1971'>
                                      st000010 ,      st010040 ,      st040100 ,      st100200 ,      st010200 , &amp;<a name='1972'>
                                 flag_st000010 , flag_st010040 , flag_st040100 , flag_st100200 , flag_st010200 , &amp; <a name='1973'>
                                      soilt000 ,      soilt005 ,      soilt020 ,      soilt040 ,      soilt160 ,      soilt300 , &amp;<a name='1974'>
                                 flag_soilt000 , flag_soilt005 , flag_soilt020 , flag_soilt040 , flag_soilt160 , flag_soilt300 , &amp;<a name='1975'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='1976'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='1977'>
                                 its , ite , jts , jte , kts , kte )<a name='1978'>
<a name='1979'>
      IMPLICIT NONE<a name='1980'>
   <a name='1981'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='1982'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1983'>
                              its , ite , jts , jte , kts , kte <a name='1984'>
<a name='1985'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN)    :: ter , toposoil , landmask<a name='1986'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tmn , tsk<a name='1987'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: st000010 , st010040 , st040100 , st100200 , st010200<a name='1988'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: soilt000 , soilt005 , soilt020 , soilt040 , soilt160 , soilt300<a name='1989'>
<a name='1990'>
      INTEGER , INTENT(IN) :: flag_st000010 , flag_st010040 , flag_st040100 , flag_st100200 , flag_st010200<a name='1991'>
      INTEGER , INTENT(IN) :: flag_soilt000 , flag_soilt005 , flag_soilt020 , flag_soilt040 , flag_soilt160 , flag_soilt300<a name='1992'>
      INTEGER , INTENT(IN) :: sf_surface_physics , flag_toposoil<a name='1993'>
 <a name='1994'>
      INTEGER :: i , j<a name='1995'>
<a name='1996'>
      REAL :: soil_elev_min_val ,  soil_elev_max_val , soil_elev_min_dif , soil_elev_max_dif<a name='1997'>
<a name='1998'>
      <font color=#447700>!  Do we have a soil field with which to modify soil temperatures?<a name='1999'></font>
<a name='2000'>
      IF ( flag_toposoil .EQ. 1 ) THEN<a name='2001'>
<a name='2002'>
         DO j = jts , MIN(jde-1,jte)<a name='2003'>
            DO i = its , MIN(ide-1,ite)<a name='2004'>
<a name='2005'>
               <font color=#447700>!  Is the toposoil field OK, or is it a subversive soil elevation field.  We can tell<a name='2006'></font>
               <font color=#447700>!  usually by looking at values.  Anything less than -1000 m (lower than the Dead Sea) is<a name='2007'></font>
               <font color=#447700>!  bad.  Anything larger than 10 km (taller than Everest) is toast.  Also, anything where <a name='2008'></font>
               <font color=#447700>!  the difference between the soil elevation and the terrain is greater than 3 km means<a name='2009'></font>
               <font color=#447700>!  that the soil data is either all zeros or that the data are inconsistent.  Any of these<a name='2010'></font>
               <font color=#447700>!  three conditions is grievous enough to induce a WRF fatality.  However, if they are at<a name='2011'></font>
               <font color=#447700>!  a water point, then we can safely ignore them.<a name='2012'></font>
         <a name='2013'>
               soil_elev_min_val = toposoil(i,j) <a name='2014'>
               soil_elev_max_val = toposoil(i,j) <a name='2015'>
               soil_elev_min_dif = ter(i,j) - toposoil(i,j)<a name='2016'>
               soil_elev_max_dif = ter(i,j) - toposoil(i,j)<a name='2017'>
         <a name='2018'>
               IF      ( ( soil_elev_min_val .LT. -1000 ) .AND. ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='2019'>
                  CYCLE<a name='2020'>
               ELSE IF ( ( soil_elev_min_val .LT. -1000 ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='2021'>
<font color=#447700>!print *,'no soil temperature elevation adjustment, soil height too small = ',toposoil(i,j)<a name='2022'></font>
cycle<a name='2023'>
<font color=#447700>!                 CALL wrf_error_fatal ( 'TOPOSOIL values have large negative values &lt; -1000 m, unrealistic.' )<a name='2024'></font>
               ENDIF<a name='2025'>
         <a name='2026'>
               IF      ( ( soil_elev_max_val .GT. 10000 ) .AND. ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='2027'>
                  CYCLE<a name='2028'>
               ELSE IF ( ( soil_elev_max_val .GT. 10000 ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='2029'>
print *,'no soil temperature elevation adjustment, soil height too high = ',toposoil(i,j)<a name='2030'>
cycle<a name='2031'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_246"> ( 'TOPOSOIL values have large positive values &gt; 10,000 m , unrealistic.' )<a name='2032'>
               ENDIF<a name='2033'>
         <a name='2034'>
               IF      ( ( ( soil_elev_min_dif .LT. -3000 ) .OR. ( soil_elev_max_dif .GT. 3000 ) ) .AND. &amp;<a name='2035'>
                           ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='2036'>
                  CYCLE<a name='2037'>
               ELSE IF ( ( ( soil_elev_min_dif .LT. -3000 ) .OR. ( soil_elev_max_dif .GT. 3000 ) ) .AND. &amp;<a name='2038'>
                           ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='2039'>
print *,'no soil temperature elevation adjustment, diff of soil height and terrain = ',ter(i,j) - toposoil(i,j)<a name='2040'>
cycle<a name='2041'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_247"> ( 'TOPOSOIL difference with terrain elevation differs by more than 3000 m, unrealistic' )<a name='2042'>
               ENDIF<a name='2043'>
<a name='2044'>
               <font color=#447700>!  For each of the fields that we would like to modify, check to see if it came in from the SI.<a name='2045'></font>
               <font color=#447700>!  If so, then use a -6.5 K/km lapse rate (based on the elevation diffs).  We only adjust when we<a name='2046'></font>
               <font color=#447700>!  are not at a water point.<a name='2047'></font>
<a name='2048'>
               IF (landmask(i,j) .GT. 0.5 ) THEN<a name='2049'>
   <a name='2050'>
                  IF ( sf_surface_physics .EQ. 1 ) THEN<a name='2051'>
                     tmn(i,j) = tmn(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2052'>
                  END IF<a name='2053'>
                  <a name='2054'>
                  tsk(i,j) = tsk(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2055'>
      <a name='2056'>
                  IF ( flag_st000010 .EQ. 1 ) THEN<a name='2057'>
                     st000010(i,j) = st000010(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2058'>
                  END IF<a name='2059'>
                  IF ( flag_st010040 .EQ. 1 ) THEN<a name='2060'>
                     st010040(i,j) = st010040(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2061'>
                  END IF<a name='2062'>
                  IF ( flag_st040100 .EQ. 1 ) THEN<a name='2063'>
                     st040100(i,j) = st040100(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2064'>
                  END IF<a name='2065'>
                  IF ( flag_st100200 .EQ. 1 ) THEN<a name='2066'>
                     st100200(i,j) = st100200(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2067'>
                  END IF<a name='2068'>
                  IF ( flag_st010200 .EQ. 1 ) THEN<a name='2069'>
                     st010200(i,j) = st010200(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2070'>
                  END IF<a name='2071'>
      <a name='2072'>
                  IF ( flag_soilt000 .EQ. 1 ) THEN<a name='2073'>
                     soilt000(i,j) = soilt000(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2074'>
                  END IF<a name='2075'>
                  IF ( flag_soilt005 .EQ. 1 ) THEN<a name='2076'>
                     soilt005(i,j) = soilt005(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2077'>
                  END IF<a name='2078'>
                  IF ( flag_soilt020 .EQ. 1 ) THEN<a name='2079'>
                     soilt020(i,j) = soilt020(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2080'>
                  END IF<a name='2081'>
                  IF ( flag_soilt040 .EQ. 1 ) THEN<a name='2082'>
                     soilt040(i,j) = soilt040(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2083'>
                  END IF<a name='2084'>
                  IF ( flag_soilt160 .EQ. 1 ) THEN<a name='2085'>
                     soilt160(i,j) = soilt160(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2086'>
                  END IF<a name='2087'>
                  IF ( flag_soilt300 .EQ. 1 ) THEN<a name='2088'>
                     soilt300(i,j) = soilt300(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='2089'>
                  END IF<a name='2090'>
   <a name='2091'>
               END IF<a name='2092'>
            END DO<a name='2093'>
         END DO<a name='2094'>
<a name='2095'>
      END IF<a name='2096'>
<a name='2097'>
   END SUBROUTINE adjust_soil_temp_new<a name='2098'>
<a name='2099'>
<a name='2100'>
<A NAME='INIT_SOIL_DEPTH_1'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2101'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_1</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_1.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_DEPTH_1.html' TARGET='index'>2</A><a name='2102'>
<a name='2103'>
      IMPLICIT NONE<a name='2104'>
   <a name='2105'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='2106'>
   <a name='2107'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='2108'>
   <a name='2109'>
      INTEGER                   ::      l<a name='2110'>
<a name='2111'>
      <font color=#447700>!  Define layers (top layer = 0.01 m).  Double the thicknesses at each step (dzs values).<a name='2112'></font>
      <font color=#447700>!  The distance from the ground level to the midpoint of the layer is given by zs.<a name='2113'></font>
<a name='2114'>
      <font color=#447700>!    -------   Ground Level   ----------      ||      ||   ||  || <a name='2115'></font>
      <font color=#447700>!                                             ||      ||   ||  || zs(1) = 0.005 m<a name='2116'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||      ||   ||  \/<a name='2117'></font>
      <font color=#447700>!                                             ||      ||   ||<a name='2118'></font>
      <font color=#447700>!    -----------------------------------      ||  ||  ||   \/   dzs(1) = 0.01 m<a name='2119'></font>
      <font color=#447700>!                                             ||  ||  || <a name='2120'></font>
      <font color=#447700>!                                             ||  ||  || zs(2) = 0.02<a name='2121'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||  ||  \/<a name='2122'></font>
      <font color=#447700>!                                             ||  ||<a name='2123'></font>
      <font color=#447700>!                                             ||  ||<a name='2124'></font>
      <font color=#447700>!    -----------------------------------  ||  ||  \/   dzs(2) = 0.02 m<a name='2125'></font>
      <font color=#447700>!                                         ||  || <a name='2126'></font>
      <font color=#447700>!                                         ||  ||<a name='2127'></font>
      <font color=#447700>!                                         ||  || <a name='2128'></font>
      <font color=#447700>!                                         ||  || zs(3) = 0.05<a name='2129'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --   ||  \/<a name='2130'></font>
      <font color=#447700>!                                         ||<a name='2131'></font>
      <font color=#447700>!                                         ||<a name='2132'></font>
      <font color=#447700>!                                         ||<a name='2133'></font>
      <font color=#447700>!                                         ||<a name='2134'></font>
      <font color=#447700>!    -----------------------------------  \/   dzs(3) = 0.04 m<a name='2135'></font>
<a name='2136'>
      IF ( num_soil_layers .NE. 5 ) THEN<a name='2137'>
         PRINT '(A)','Usually, the 5-layer diffusion uses 5 layers.  Change this in the namelist.'<a name='2138'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_248"> ( '5-layer_diffusion_uses_5_layers' )<a name='2139'>
      END IF<a name='2140'>
   <a name='2141'>
      dzs(1)=.01<a name='2142'>
      zs(1)=.5*dzs(1)<a name='2143'>
   <a name='2144'>
      DO l=2,num_soil_layers<a name='2145'>
         dzs(l)=2*dzs(l-1)<a name='2146'>
         zs(l)=zs(l-1)+.5*dzs(l-1)+.5*dzs(l)<a name='2147'>
      ENDDO<a name='2148'>
<a name='2149'>
   END SUBROUTINE init_soil_depth_1<a name='2150'>
<a name='2151'>
<A NAME='INIT_SOIL_DEPTH_2'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2152'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_2</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_2.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_DEPTH_2.html' TARGET='index'>2</A><a name='2153'>
<a name='2154'>
      IMPLICIT NONE<a name='2155'>
   <a name='2156'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='2157'>
   <a name='2158'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='2159'>
   <a name='2160'>
      INTEGER                   ::      l<a name='2161'>
<a name='2162'>
      dzs = (/ 0.1 , 0.3 , 0.6 , 1.0 /)<a name='2163'>
<a name='2164'>
      IF ( num_soil_layers .NE. 4 ) THEN<a name='2165'>
         PRINT '(A)','Usually, the LSM uses 4 layers.  Change this in the namelist.'<a name='2166'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_249"> ( 'LSM_uses_4_layers' )<a name='2167'>
      END IF<a name='2168'>
<a name='2169'>
      zs(1)=.5*dzs(1)<a name='2170'>
   <a name='2171'>
      DO l=2,num_soil_layers<a name='2172'>
         zs(l)=zs(l-1)+.5*dzs(l-1)+.5*dzs(l)<a name='2173'>
      ENDDO<a name='2174'>
<a name='2175'>
   END SUBROUTINE init_soil_depth_2<a name='2176'>
<a name='2177'>
<A NAME='INIT_SOIL_DEPTH_3'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2178'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_3</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_3.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_DEPTH_3.html' TARGET='index'>2</A><a name='2179'>
<a name='2180'>
      IMPLICIT NONE<a name='2181'>
   <a name='2182'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='2183'>
   <a name='2184'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='2185'>
   <a name='2186'>
      INTEGER                   ::      l<a name='2187'>
<a name='2188'>
      zs  = (/ 0.00 , 0.05 , 0.20 , 0.40 , 1.60 , 3.00 /)<a name='2189'>
      dzs = (/ 0.00 , 0.125, 0.175 , 0.70 , 1.30 , 1.40 /)<a name='2190'>
<a name='2191'>
      IF ( num_soil_layers .NE. 6 ) THEN<a name='2192'>
         PRINT '(A)','Usually, the RUC LSM uses 6 layers.  Change this in the namelist.'<a name='2193'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_250"> ( 'LSM_uses_6_layers' )<a name='2194'>
      END IF<a name='2195'>
<a name='2196'>
<font color=#447700>!print *,'RUCLSM dzs=',dzs<a name='2197'></font>
<font color=#447700>!print *,'RUCLSM zs =',zs<a name='2198'></font>
<a name='2199'>
   END SUBROUTINE init_soil_depth_3<a name='2200'>
<a name='2201'>
<A NAME='INIT_SOIL_1_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2202'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_1_real</font> ( tsk , tmn , tslb , zs , dzs , &amp; <A href='../../call_to/INIT_SOIL_1_REAL.html' TARGET='index'>2</A><a name='2203'>
                                 num_soil_layers , real_data_init_type , &amp;<a name='2204'>
                                 landmask , sst , flag_sst , &amp;<a name='2205'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='2206'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='2207'>
                                 its , ite , jts , jte , kts , kte )<a name='2208'>
<a name='2209'>
      IMPLICIT NONE<a name='2210'>
<a name='2211'>
      INTEGER , INTENT(IN) :: num_soil_layers , real_data_init_type , &amp;<a name='2212'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='2213'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='2214'>
                              its , ite , jts , jte , kts , kte <a name='2215'>
<a name='2216'>
      INTEGER , INTENT(IN) :: flag_sst<a name='2217'>
<a name='2218'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='2219'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tsk , tmn<a name='2220'>
<a name='2221'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='2222'>
<a name='2223'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb<a name='2224'>
<a name='2225'>
      INTEGER :: i , j , l<a name='2226'>
<a name='2227'>
      <font color=#447700>!  Soil temperature is linearly interpolated between the skin temperature (taken to be at a<a name='2228'></font>
      <font color=#447700>!  depth of 0.5 cm) and the deep soil, annual temperature (taken to be at a depth of 23 cm).<a name='2229'></font>
      <font color=#447700>!  The tslb(i,1,j) is the skin temperature, and the tslb(i,num_soil_layers,j) level is the <a name='2230'></font>
      <font color=#447700>!  annual mean temperature.<a name='2231'></font>
<a name='2232'>
      DO j = jts , MIN(jde-1,jte)<a name='2233'>
         DO i = its , MIN(ide-1,ite)<a name='2234'>
            IF ( landmask(i,j) .GT. 0.5 ) THEN<a name='2235'>
               DO l = 1 , num_soil_layers<a name='2236'>
                  tslb(i,l,j)= ( tsk(i,j) * ( zs(num_soil_layers) - zs(l) )   + &amp;<a name='2237'>
                                 tmn(i,j) * ( zs(              l) - zs(1) ) ) / &amp;<a name='2238'>
                                            ( zs(num_soil_layers) - zs(1) )<a name='2239'>
               END DO<a name='2240'>
            ELSE<a name='2241'>
               IF ( ( real_data_init_type .EQ. 1 ) .AND. ( flag_sst .EQ. 1 ) ) THEN<a name='2242'>
                  DO l = 1 , num_soil_layers<a name='2243'>
                     tslb(i,l,j)= sst(i,j)<a name='2244'>
                  END DO<a name='2245'>
               ELSE<a name='2246'>
                  DO l = 1 , num_soil_layers<a name='2247'>
                     tslb(i,l,j)= tsk(i,j)<a name='2248'>
                  END DO<a name='2249'>
               END IF<a name='2250'>
            END IF<a name='2251'>
         END DO<a name='2252'>
      END DO<a name='2253'>
<a name='2254'>
   END SUBROUTINE init_soil_1_real<a name='2255'>
<a name='2256'>
<A NAME='INIT_SOIL_1_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2257'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_1_ideal</font>(tsk,tmn,tslb,xland,             &amp; <A href='../../call_to/INIT_SOIL_1_IDEAL.html' TARGET='index'>2</A><a name='2258'>
                       ivgtyp,ZS,DZS,num_soil_layers,           &amp;<a name='2259'>
                       ids,ide, jds,jde, kds,kde,               &amp;<a name='2260'>
                       ims,ime, jms,jme, kms,kme,               &amp;<a name='2261'>
                       its,ite, jts,jte, kts,kte                )<a name='2262'>
<a name='2263'>
      IMPLICIT NONE<a name='2264'>
   <a name='2265'>
      INTEGER, INTENT(IN   )    ::      ids,ide, jds,jde, kds,kde, &amp;<a name='2266'>
                                        ims,ime, jms,jme, kms,kme, &amp;<a name='2267'>
                                        its,ite, jts,jte, kts,kte<a name='2268'>
   <a name='2269'>
      INTEGER, INTENT(IN   )    ::      num_soil_layers<a name='2270'>
   <a name='2271'>
      REAL, DIMENSION( ims:ime , 1 , jms:jme ), INTENT(OUT) :: tslb<a name='2272'>
      REAL, DIMENSION( ims:ime , jms:jme ), INTENT(OUT) :: xland<a name='2273'>
      INTEGER, DIMENSION( ims:ime , jms:jme ), INTENT(OUT) :: ivgtyp<a name='2274'>
   <a name='2275'>
      REAL, DIMENSION(1:), INTENT(IN) :: dzs,zs<a name='2276'>
   <a name='2277'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(IN) :: tsk, tmn<a name='2278'>
<a name='2279'>
      <font color=#447700>!  Lcal variables.<a name='2280'></font>
   <a name='2281'>
      INTEGER :: l,j,i,itf,jtf<a name='2282'>
   <a name='2283'>
      itf=MIN(ite,ide-1)<a name='2284'>
      jtf=MIN(jte,jde-1)<a name='2285'>
   <a name='2286'>
      IF (num_soil_layers.NE.1)THEN<a name='2287'>
         DO j=jts,jtf<a name='2288'>
            DO l=1,num_soil_layers<a name='2289'>
               DO i=its,itf<a name='2290'>
                 tslb(i,l,j)=( tsk(i,j)*(zs(num_soil_layers)-zs(l)) + tmn(i,j)*(zs(l)-zs(1)) ) / &amp;<a name='2291'>
                             ( zs(num_soil_layers)-zs(1) )<a name='2292'>
               ENDDO<a name='2293'>
            ENDDO<a name='2294'>
         ENDDO<a name='2295'>
      ENDIF<a name='2296'>
      DO j=jts,jtf<a name='2297'>
         DO i=its,itf<a name='2298'>
           xland(i,j)  = 2<a name='2299'>
           ivgtyp(i,j) = 7<a name='2300'>
         ENDDO<a name='2301'>
      ENDDO<a name='2302'>
<a name='2303'>
   END SUBROUTINE init_soil_1_ideal<a name='2304'>
<a name='2305'>
<A NAME='INIT_SOIL_2_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2306'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_2_real</font> ( tsk , tmn , smois , sh2o , tslb , &amp; <A href='../../call_to/INIT_SOIL_2_REAL.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_SOIL_2_REAL.html' TARGET='index'>2</A><a name='2307'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='2308'>
                                 zs , dzs , &amp;<a name='2309'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='2310'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input ,  num_sw_levels_input , &amp;<a name='2311'>
                                 num_st_levels_alloc , num_sm_levels_alloc ,  num_sw_levels_alloc , &amp;<a name='2312'>
                                 flag_sst , flag_soilt000 , flag_soilmt000 , &amp;<a name='2313'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='2314'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='2315'>
                                 its , ite , jts , jte , kts , kte )<a name='2316'>
<a name='2317'>
      IMPLICIT NONE<a name='2318'>
<a name='2319'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='2320'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='2321'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='2322'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='2323'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='2324'>
                              its , ite , jts , jte , kts , kte <a name='2325'>
<a name='2326'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soilt000, flag_soilmt000<a name='2327'>
<a name='2328'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='2329'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='2330'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='2331'>
<a name='2332'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='2333'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='2334'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='2335'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='2336'>
<a name='2337'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='2338'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='2339'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='2340'>
<a name='2341'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='2342'>
<a name='2343'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='2344'>
<a name='2345'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave , num<a name='2346'>
      REAL :: temp<a name='2347'>
      LOGICAL :: found_levels<a name='2348'>
<a name='2349'>
      <font color=#447700>!  Are there any soil temp and moisture levels - ya know, they are mandatory.<a name='2350'></font>
<a name='2351'>
      num = num_st_levels_input * num_sm_levels_input<a name='2352'>
<a name='2353'>
      IF ( num .GE. 1 ) THEN<a name='2354'>
<a name='2355'>
         <font color=#447700>!  Ordered levels that we have data for.<a name='2356'></font>
<a name='2357'>
         ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input,num_sw_levels_input) +2) )<a name='2358'>
<a name='2359'>
         <font color=#447700>!  Sort the levels for temperature.<a name='2360'></font>
   <a name='2361'>
         outert : DO lout = 1 , num_st_levels_input-1<a name='2362'>
            innert : DO lin = lout+1 , num_st_levels_input<a name='2363'>
               IF ( st_levels_input(lout) .GT. st_levels_input(lin) ) THEN<a name='2364'>
                  temp = st_levels_input(lout) <a name='2365'>
                  st_levels_input(lout) = st_levels_input(lin)<a name='2366'>
                  st_levels_input(lin) = NINT(temp)<a name='2367'>
                  DO j = jts , MIN(jde-1,jte)<a name='2368'>
                     DO i = its , MIN(ide-1,ite)<a name='2369'>
                        temp = st_input(i,lout+1,j)<a name='2370'>
                        st_input(i,lout+1,j) = st_input(i,lin+1,j)<a name='2371'>
                        st_input(i,lin+1,j) = temp<a name='2372'>
                     END DO<a name='2373'>
                  END DO<a name='2374'>
               END IF<a name='2375'>
            END DO innert<a name='2376'>
         END DO outert<a name='2377'>
         DO j = jts , MIN(jde-1,jte)<a name='2378'>
            DO i = its , MIN(ide-1,ite)<a name='2379'>
               st_input(i,1,j) = tsk(i,j)<a name='2380'>
               st_input(i,num_st_levels_input+2,j) = tmn(i,j)<a name='2381'>
            END DO<a name='2382'>
         END DO<a name='2383'>
<a name='2384'>
<a name='2385'>
#ifdef ( NMM_CORE == 1 )<a name='2386'>
<font color=#447700>!new<a name='2387'></font>
	write(0,*) 'st_input(1) in init_soil_2_real'<a name='2388'>
	DO J=MIN(jde-1,jte),JTS, -MIN(jde-1,jte)/15<a name='2389'>
	write(0,616) (st_input(I,1,J),I=its , MIN(ide-1,ite),MIN(ide-1,ite)/10)<a name='2390'>
	ENDDO<a name='2391'>
<a name='2392'>
	write(0,*) 'st_input(2) in init_soil_2_real'<a name='2393'>
	DO J=MIN(jde-1,jte),JTS, -MIN(jde-1,jte)/15<a name='2394'>
	write(0,616) (st_input(I,2,J),I=its , MIN(ide-1,ite),MIN(ide-1,ite)/10)<a name='2395'>
	ENDDO<a name='2396'>
<a name='2397'>
  616	format(20(f4.0,1x))<a name='2398'>
#endif<a name='2399'>
   <a name='2400'>
         <font color=#447700>!  Sort the levels for moisture.<a name='2401'></font>
   <a name='2402'>
         outerm: DO lout = 1 , num_sm_levels_input-1<a name='2403'>
            innerm : DO lin = lout+1 , num_sm_levels_input<a name='2404'>
               IF ( sm_levels_input(lout) .GT. sm_levels_input(lin) ) THEN<a name='2405'>
                  temp = sm_levels_input(lout) <a name='2406'>
                  sm_levels_input(lout) = sm_levels_input(lin)<a name='2407'>
                  sm_levels_input(lin) = NINT(temp)<a name='2408'>
                  DO j = jts , MIN(jde-1,jte)<a name='2409'>
                     DO i = its , MIN(ide-1,ite)<a name='2410'>
                        temp = sm_input(i,lout+1,j)<a name='2411'>
                        sm_input(i,lout+1,j) = sm_input(i,lin+1,j)<a name='2412'>
                        sm_input(i,lin+1,j) = temp<a name='2413'>
                     END DO<a name='2414'>
                  END DO<a name='2415'>
               END IF<a name='2416'>
            END DO innerm<a name='2417'>
         END DO outerm<a name='2418'>
         DO j = jts , MIN(jde-1,jte)<a name='2419'>
            DO i = its , MIN(ide-1,ite)<a name='2420'>
               sm_input(i,1,j) = sm_input(i,2,j)<a name='2421'>
               sm_input(i,num_sm_levels_input+2,j) = sm_input(i,num_sm_levels_input+1,j)<a name='2422'>
            END DO<a name='2423'>
         END DO<a name='2424'>
   <a name='2425'>
         <font color=#447700>!  Sort the levels for liquid moisture.<a name='2426'></font>
   <a name='2427'>
         outerw: DO lout = 1 , num_sw_levels_input-1<a name='2428'>
            innerw : DO lin = lout+1 , num_sw_levels_input<a name='2429'>
               IF ( sw_levels_input(lout) .GT. sw_levels_input(lin) ) THEN<a name='2430'>
                  temp = sw_levels_input(lout) <a name='2431'>
                  sw_levels_input(lout) = sw_levels_input(lin)<a name='2432'>
                  sw_levels_input(lin) = NINT(temp)<a name='2433'>
                  DO j = jts , MIN(jde-1,jte)<a name='2434'>
                     DO i = its , MIN(ide-1,ite)<a name='2435'>
                        temp = sw_input(i,lout+1,j)<a name='2436'>
                        sw_input(i,lout+1,j) = sw_input(i,lin+1,j)<a name='2437'>
                        sw_input(i,lin+1,j) = temp<a name='2438'>
                     END DO<a name='2439'>
                  END DO<a name='2440'>
               END IF<a name='2441'>
            END DO innerw<a name='2442'>
         END DO outerw<a name='2443'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='2444'>
            DO j = jts , MIN(jde-1,jte)<a name='2445'>
               DO i = its , MIN(ide-1,ite)<a name='2446'>
                  sw_input(i,1,j) = sw_input(i,2,j)<a name='2447'>
                  sw_input(i,num_sw_levels_input+2,j) = sw_input(i,num_sw_levels_input+1,j)<a name='2448'>
               END DO<a name='2449'>
            END DO<a name='2450'>
         END IF<a name='2451'>
<a name='2452'>
         found_levels = .TRUE.<a name='2453'>
<a name='2454'>
      ELSE IF ( ( num .LE. 0 ) .AND. (  start_date .NE. current_date ) ) THEN<a name='2455'>
<a name='2456'>
         found_levels = .FALSE.<a name='2457'>
<a name='2458'>
      ELSE<a name='2459'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_251"> ( &amp;<a name='2460'>
         'No input soil level data (temperature, moisture or liquid, or all are missing). Required for LSM.' )<a name='2461'>
      END IF<a name='2462'>
<a name='2463'>
      <font color=#447700>!  Is it OK to continue?<a name='2464'></font>
<a name='2465'>
      IF ( found_levels ) THEN<a name='2466'>
<a name='2467'>
         <font color=#447700>!  Here are the levels that we have from the input for temperature.  The input levels plus<a name='2468'></font>
         <font color=#447700>!  two more: the skin temperature at 0 cm, and the annual mean temperature at 300 cm.<a name='2469'></font>
<a name='2470'>
         zhave(1) = 0.<a name='2471'>
         DO l = 1 , num_st_levels_input<a name='2472'>
            zhave(l+1) = st_levels_input(l) / 100.<a name='2473'>
         END DO<a name='2474'>
         zhave(num_st_levels_input+2) = 300. / 100.<a name='2475'>
   <a name='2476'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2477'></font>
   <a name='2478'>
         z_wantt : DO lwant = 1 , num_soil_layers<a name='2479'>
            z_havet : DO lhave = 1 , num_st_levels_input +2 -1<a name='2480'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2481'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2482'>
                  DO j = jts , MIN(jde-1,jte)<a name='2483'>
                     DO i = its , MIN(ide-1,ite)<a name='2484'>
                        tslb(i,lwant,j)= ( st_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2485'>
                                           st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2486'>
                                                                   ( zhave(lhave+1) - zhave(lhave) )<a name='2487'>
                     END DO<a name='2488'>
                  END DO<a name='2489'>
                  EXIT z_havet<a name='2490'>
               END IF<a name='2491'>
            END DO z_havet<a name='2492'>
         END DO z_wantt<a name='2493'>
<a name='2494'>
         <font color=#447700>!  Here are the levels that we have from the input for moisture.  The input levels plus<a name='2495'></font>
         <font color=#447700>!  two more: a value at 0 cm and one at 300 cm.  The 0 cm value is taken to be identical<a name='2496'></font>
         <font color=#447700>!  to the most shallow layer's value.  Similarly, the 300 cm value is taken to be the same<a name='2497'></font>
         <font color=#447700>!  as the most deep layer's value.<a name='2498'></font>
   <a name='2499'>
         zhave(1) = 0.<a name='2500'>
         DO l = 1 , num_sm_levels_input<a name='2501'>
            zhave(l+1) = sm_levels_input(l) / 100.<a name='2502'>
         END DO<a name='2503'>
         zhave(num_sm_levels_input+2) = 300. / 100.<a name='2504'>
   <a name='2505'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2506'></font>
   <a name='2507'>
         z_wantm : DO lwant = 1 , num_soil_layers<a name='2508'>
            z_havem : DO lhave = 1 , num_sm_levels_input +2 -1<a name='2509'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2510'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2511'>
                  DO j = jts , MIN(jde-1,jte)<a name='2512'>
                     DO i = its , MIN(ide-1,ite)<a name='2513'>
                        smois(i,lwant,j)= ( sm_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2514'>
                                            sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2515'>
                                                                    ( zhave(lhave+1) - zhave(lhave) )<a name='2516'>
                     END DO<a name='2517'>
                  END DO<a name='2518'>
                  EXIT z_havem<a name='2519'>
               END IF<a name='2520'>
            END DO z_havem<a name='2521'>
         END DO z_wantm<a name='2522'>
   <a name='2523'>
         <font color=#447700>!  Any liquid soil moisture to worry about?<a name='2524'></font>
   <a name='2525'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='2526'>
   <a name='2527'>
            zhave(1) = 0.<a name='2528'>
            DO l = 1 , num_sw_levels_input<a name='2529'>
               zhave(l+1) = sw_levels_input(l) / 100.<a name='2530'>
            END DO<a name='2531'>
            zhave(num_sw_levels_input+2) = 300. / 100.<a name='2532'>
      <a name='2533'>
            <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2534'></font>
      <a name='2535'>
            z_wantw : DO lwant = 1 , num_soil_layers<a name='2536'>
               z_havew : DO lhave = 1 , num_sw_levels_input +2 -1<a name='2537'>
                  IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2538'>
                       ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2539'>
                     DO j = jts , MIN(jde-1,jte)<a name='2540'>
                        DO i = its , MIN(ide-1,ite)<a name='2541'>
                           sh2o(i,lwant,j)= ( sw_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2542'>
                                               sw_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2543'>
                                                                       ( zhave(lhave+1) - zhave(lhave) )<a name='2544'>
                        END DO<a name='2545'>
                     END DO<a name='2546'>
                     EXIT z_havew<a name='2547'>
                  END IF<a name='2548'>
               END DO z_havew<a name='2549'>
            END DO z_wantw<a name='2550'>
   <a name='2551'>
         END IF<a name='2552'>
   <a name='2553'>
   <a name='2554'>
         <font color=#447700>!  Over water, put in reasonable values for soil temperature and moisture.  These won't be<a name='2555'></font>
         <font color=#447700>!  used, but they will make a more continuous plot.<a name='2556'></font>
   <a name='2557'>
         IF ( flag_sst .EQ. 1 ) THEN<a name='2558'>
            DO j = jts , MIN(jde-1,jte)<a name='2559'>
               DO i = its , MIN(ide-1,ite)<a name='2560'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2561'>
                     DO l = 1 , num_soil_layers<a name='2562'>
                        tslb(i,l,j)= sst(i,j)<a name='2563'>
                        smois(i,l,j)= 1.0<a name='2564'>
                        sh2o (i,l,j)= 1.0<a name='2565'>
                     END DO<a name='2566'>
                  END IF<a name='2567'>
               END DO<a name='2568'>
            END DO<a name='2569'>
         ELSE<a name='2570'>
            DO j = jts , MIN(jde-1,jte)<a name='2571'>
               DO i = its , MIN(ide-1,ite)<a name='2572'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2573'>
                     DO l = 1 , num_soil_layers<a name='2574'>
                        tslb(i,l,j)= tsk(i,j)<a name='2575'>
                        smois(i,l,j)= 1.0<a name='2576'>
                        sh2o (i,l,j)= 1.0<a name='2577'>
                     END DO<a name='2578'>
                  END IF<a name='2579'>
               END DO<a name='2580'>
            END DO<a name='2581'>
         END IF<a name='2582'>
   <a name='2583'>
         DEALLOCATE (zhave)<a name='2584'>
<a name='2585'>
      END IF<a name='2586'>
<a name='2587'>
   END SUBROUTINE init_soil_2_real<a name='2588'>
<a name='2589'>
<A NAME='INIT_SOIL_2_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2590'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_2_ideal</font> ( xland,xice,vegfra,snow,canwat,     &amp; <A href='../../call_to/INIT_SOIL_2_IDEAL.html' TARGET='index'>2</A><a name='2591'>
                     ivgtyp,isltyp,tslb,smois,tmn,                  &amp;<a name='2592'>
                     num_soil_layers,                               &amp;<a name='2593'>
                     ids,ide, jds,jde, kds,kde,                     &amp;<a name='2594'>
                     ims,ime, jms,jme, kms,kme,                     &amp;<a name='2595'>
                     its,ite, jts,jte, kts,kte                      )<a name='2596'>
<a name='2597'>
      IMPLICIT NONE <a name='2598'>
   <a name='2599'>
      INTEGER, INTENT(IN) ::ids,ide, jds,jde, kds,kde,  &amp;<a name='2600'>
                            ims,ime, jms,jme, kms,kme,  &amp;<a name='2601'>
                            its,ite, jts,jte, kts,kte<a name='2602'>
   <a name='2603'>
      INTEGER, INTENT(IN) ::num_soil_layers<a name='2604'>
   <a name='2605'>
      REAL, DIMENSION( ims:ime, num_soil_layers, jms:jme ) , INTENT(OUT) :: smois, tslb <a name='2606'>
   <a name='2607'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT)  :: xland, snow, canwat, xice, vegfra, tmn<a name='2608'>
   <a name='2609'>
      INTEGER, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: ivgtyp, isltyp<a name='2610'>
   <a name='2611'>
      INTEGER :: icm,jcm,itf,jtf<a name='2612'>
      INTEGER ::  i,j,l<a name='2613'>
   <a name='2614'>
      itf=min0(ite,ide-1)<a name='2615'>
      jtf=min0(jte,jde-1)<a name='2616'>
   <a name='2617'>
      icm = ide/2<a name='2618'>
      jcm = jde/2<a name='2619'>
   <a name='2620'>
      DO j=jts,jtf<a name='2621'>
         DO l=1,num_soil_layers<a name='2622'>
            DO i=its,itf<a name='2623'>
   <a name='2624'>
               smois(i,1,j)=0.10<a name='2625'>
               smois(i,2,j)=0.10<a name='2626'>
               smois(i,3,j)=0.10<a name='2627'>
               smois(i,4,j)=0.10<a name='2628'>
      <a name='2629'>
               tslb(i,1,j)=295.           <a name='2630'>
               tslb(i,2,j)=297.          <a name='2631'>
               tslb(i,3,j)=293.         <a name='2632'>
               tslb(i,4,j)=293. <a name='2633'>
<a name='2634'>
            ENDDO<a name='2635'>
         ENDDO<a name='2636'>
      ENDDO                                 <a name='2637'>
<a name='2638'>
      DO j=jts,jtf<a name='2639'>
         DO i=its,itf<a name='2640'>
            xland(i,j)  =   2<a name='2641'>
            tmn(i,j)    = 294. <a name='2642'>
            xice(i,j)   =   0.<a name='2643'>
            vegfra(i,j) =   0. <a name='2644'>
            snow(i,j)   =   0.<a name='2645'>
            canwat(i,j) =   0.<a name='2646'>
            ivgtyp(i,j) =   7<a name='2647'>
            isltyp(i,j) =   8<a name='2648'>
         ENDDO<a name='2649'>
      ENDDO<a name='2650'>
<a name='2651'>
   END SUBROUTINE init_soil_2_ideal<a name='2652'>
<a name='2653'>
<A NAME='INIT_SOIL_3_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2654'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_3_real</font> ( tsk , tmn , smois , tslb , &amp; <A href='../../call_to/INIT_SOIL_3_REAL.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_SOIL_3_REAL.html' TARGET='index'>3</A><a name='2655'>
                                 st_input , sm_input , landmask, sst, &amp;<a name='2656'>
                                 zs , dzs , &amp;<a name='2657'>
                                 st_levels_input , sm_levels_input , &amp;<a name='2658'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input ,  &amp;<a name='2659'>
                                 num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='2660'>
                                 flag_sst , flag_soilt000 , flag_soilm000 , &amp;<a name='2661'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='2662'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='2663'>
                                 its , ite , jts , jte , kts , kte )<a name='2664'>
<a name='2665'>
      IMPLICIT NONE<a name='2666'>
<a name='2667'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='2668'>
                              num_st_levels_input , num_sm_levels_input , &amp;<a name='2669'>
                              num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='2670'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='2671'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='2672'>
                              its , ite , jts , jte , kts , kte<a name='2673'>
<a name='2674'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soilt000, flag_soilm000<a name='2675'>
<a name='2676'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='2677'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='2678'>
<a name='2679'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='2680'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='2681'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='2682'>
<a name='2683'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='2684'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='2685'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='2686'>
<a name='2687'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois<a name='2688'>
<a name='2689'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='2690'>
<a name='2691'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave<a name='2692'>
      REAL :: temp<a name='2693'>
<a name='2694'>
      <font color=#447700>!  Allocate the soil layer array used for interpolating.<a name='2695'></font>
<a name='2696'>
      IF ( ( num_st_levels_input .LE. 0 ) .OR. &amp; <a name='2697'>
           ( num_sm_levels_input .LE. 0 ) ) THEN<a name='2698'>
         PRINT '(A)','No input soil level data (either temperature or moisture, or both are missing).  Required for RUC LSM.'<a name='2699'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_252"> ( 'no soil data' )<a name='2700'>
      ELSE<a name='2701'>
         IF ( flag_soilt000 .eq. 1 ) THEN<a name='2702'>
           PRINT '(A)',' Assume RUC LSM 6-level input'<a name='2703'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input)  ) )<a name='2704'>
         ELSE<a name='2705'>
           PRINT '(A)',' Assume non-RUC LSM input'<a name='2706'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_soil_layers)  ) )<a name='2707'>
         END IF<a name='2708'>
      END IF<a name='2709'>
<a name='2710'>
      <font color=#447700>!  Sort the levels for temperature.<a name='2711'></font>
<a name='2712'>
      outert : DO lout = 1 , num_st_levels_input-1<a name='2713'>
         innert : DO lin = lout+1 , num_st_levels_input<a name='2714'>
            IF ( st_levels_input(lout) .GT. st_levels_input(lin) ) THEN<a name='2715'>
               temp = st_levels_input(lout) <a name='2716'>
               st_levels_input(lout) = st_levels_input(lin)<a name='2717'>
               st_levels_input(lin) = NINT(temp)<a name='2718'>
               DO j = jts , MIN(jde-1,jte)<a name='2719'>
                  DO i = its , MIN(ide-1,ite)<a name='2720'>
                     temp = st_input(i,lout,j)<a name='2721'>
                     st_input(i,lout,j) = st_input(i,lin,j)<a name='2722'>
                     st_input(i,lin,j) = temp<a name='2723'>
                  END DO<a name='2724'>
               END DO<a name='2725'>
            END IF<a name='2726'>
         END DO innert<a name='2727'>
      END DO outert<a name='2728'>
<a name='2729'>
      IF ( flag_soilt000 .NE. 1 ) THEN<a name='2730'>
      DO j = jts , MIN(jde-1,jte)<a name='2731'>
         DO i = its , MIN(ide-1,ite)<a name='2732'>
            st_input(i,1,j) = tsk(i,j)<a name='2733'>
            st_input(i,num_st_levels_input+2,j) = tmn(i,j)<a name='2734'>
         END DO<a name='2735'>
      END DO<a name='2736'>
      END IF<a name='2737'>
<a name='2738'>
      <font color=#447700>!  Sort the levels for moisture.<a name='2739'></font>
<a name='2740'>
      outerm: DO lout = 1 , num_sm_levels_input-1<a name='2741'>
         innerm : DO lin = lout+1 , num_sm_levels_input<a name='2742'>
            IF ( sm_levels_input(lout) .GT. sm_levels_input(lin) ) THEN<a name='2743'>
               temp = sm_levels_input(lout) <a name='2744'>
               sm_levels_input(lout) = sm_levels_input(lin)<a name='2745'>
               sm_levels_input(lin) = NINT(temp)<a name='2746'>
               DO j = jts , MIN(jde-1,jte)<a name='2747'>
                  DO i = its , MIN(ide-1,ite)<a name='2748'>
                     temp = sm_input(i,lout,j)<a name='2749'>
                     sm_input(i,lout,j) = sm_input(i,lin,j)<a name='2750'>
                     sm_input(i,lin,j) = temp<a name='2751'>
                  END DO<a name='2752'>
               END DO<a name='2753'>
            END IF<a name='2754'>
         END DO innerm<a name='2755'>
      END DO outerm<a name='2756'>
<a name='2757'>
      IF ( flag_soilm000 .NE. 1 ) THEN<a name='2758'>
      DO j = jts , MIN(jde-1,jte)<a name='2759'>
         DO i = its , MIN(ide-1,ite)<a name='2760'>
            sm_input(i,1,j) = sm_input(i,2,j)<a name='2761'>
            sm_input(i,num_sm_levels_input+2,j) = sm_input(i,num_sm_levels_input+1,j)<a name='2762'>
         END DO<a name='2763'>
      END DO<a name='2764'>
      END IF<a name='2765'>
<a name='2766'>
      <font color=#447700>!  Here are the levels that we have from the input for temperature.<a name='2767'></font>
<a name='2768'>
      IF ( flag_soilt000 .EQ. 1 ) THEN<a name='2769'>
         DO l = 1 , num_st_levels_input<a name='2770'>
            zhave(l) = st_levels_input(l) / 100.<a name='2771'>
         END DO<a name='2772'>
<a name='2773'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2774'></font>
<a name='2775'>
      z_wantt : DO lwant = 1 , num_soil_layers<a name='2776'>
         z_havet : DO lhave = 1 , num_st_levels_input -1<a name='2777'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2778'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2779'>
               DO j = jts , MIN(jde-1,jte)<a name='2780'>
                  DO i = its , MIN(ide-1,ite)<a name='2781'>
                     tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2782'>
                                        st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2783'>
                                                                ( zhave(lhave+1) - zhave(lhave) )<a name='2784'>
                  END DO<a name='2785'>
               END DO<a name='2786'>
               EXIT z_havet<a name='2787'>
            END IF<a name='2788'>
         END DO z_havet<a name='2789'>
      END DO z_wantt<a name='2790'>
<a name='2791'>
      ELSE<a name='2792'>
<a name='2793'>
         zhave(1) = 0.<a name='2794'>
         DO l = 1 , num_st_levels_input<a name='2795'>
            zhave(l+1) = st_levels_input(l) / 100.<a name='2796'>
         END DO<a name='2797'>
         zhave(num_st_levels_input+2) = 300. / 100.<a name='2798'>
<a name='2799'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2800'></font>
<a name='2801'>
      z_wantt_2 : DO lwant = 1 , num_soil_layers<a name='2802'>
         z_havet_2 : DO lhave = 1 , num_st_levels_input +2<a name='2803'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2804'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2805'>
               DO j = jts , MIN(jde-1,jte)<a name='2806'>
                  DO i = its , MIN(ide-1,ite)<a name='2807'>
                     tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2808'>
                                        st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2809'>
                                                                ( zhave(lhave+1) - zhave(lhave) )<a name='2810'>
                  END DO<a name='2811'>
               END DO<a name='2812'>
               EXIT z_havet_2<a name='2813'>
            END IF<a name='2814'>
         END DO z_havet_2<a name='2815'>
      END DO z_wantt_2<a name='2816'>
<a name='2817'>
      END IF<a name='2818'>
<a name='2819'>
      <font color=#447700>!  Here are the levels that we have from the input for moisture.<a name='2820'></font>
<a name='2821'>
      IF ( flag_soilm000 .EQ. 1 ) THEN<a name='2822'>
         DO l = 1 , num_sm_levels_input<a name='2823'>
            zhave(l) = sm_levels_input(l) / 100.<a name='2824'>
         END DO<a name='2825'>
<a name='2826'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2827'></font>
<a name='2828'>
      z_wantm : DO lwant = 1 , num_soil_layers<a name='2829'>
         z_havem : DO lhave = 1 , num_sm_levels_input -1<a name='2830'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2831'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2832'>
               DO j = jts , MIN(jde-1,jte)<a name='2833'>
                  DO i = its , MIN(ide-1,ite)<a name='2834'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2835'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2836'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='2837'>
                  END DO<a name='2838'>
               END DO<a name='2839'>
               EXIT z_havem<a name='2840'>
            END IF<a name='2841'>
         END DO z_havem<a name='2842'>
      END DO z_wantm<a name='2843'>
<a name='2844'>
      ELSE<a name='2845'>
<a name='2846'>
         zhave(1) = 0.<a name='2847'>
         DO l = 1 , num_sm_levels_input<a name='2848'>
            zhave(l+1) = sm_levels_input(l) / 100.<a name='2849'>
         END DO<a name='2850'>
         zhave(num_sm_levels_input+2) = 300. / 100.<a name='2851'>
<a name='2852'>
      z_wantm_2 : DO lwant = 1 , num_soil_layers<a name='2853'>
         z_havem_2 : DO lhave = 1 , num_sm_levels_input +2<a name='2854'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2855'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2856'>
               DO j = jts , MIN(jde-1,jte)<a name='2857'>
                  DO i = its , MIN(ide-1,ite)<a name='2858'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2859'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2860'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='2861'>
                  END DO<a name='2862'>
               END DO<a name='2863'>
               EXIT z_havem_2<a name='2864'>
            END IF<a name='2865'>
         END DO z_havem_2<a name='2866'>
      END DO z_wantm_2<a name='2867'>
<a name='2868'>
      END IF<a name='2869'>
      <font color=#447700>!  Over water, put in reasonable values for soil temperature and moisture.  These won't be<a name='2870'></font>
      <font color=#447700>!  used, but they will make a more continuous plot.<a name='2871'></font>
<a name='2872'>
      IF ( flag_sst .EQ. 1 ) THEN<a name='2873'>
         DO j = jts , MIN(jde-1,jte)<a name='2874'>
            DO i = its , MIN(ide-1,ite)<a name='2875'>
               IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2876'>
                  DO l = 1 , num_soil_layers<a name='2877'>
                     tslb(i,l,j) = sst(i,j)<a name='2878'>
                     tsk(i,j)    = sst(i,j)<a name='2879'>
                     smois(i,l,j)= 1.0<a name='2880'>
                  END DO<a name='2881'>
               END IF<a name='2882'>
            END DO<a name='2883'>
         END DO<a name='2884'>
      ELSE<a name='2885'>
         DO j = jts , MIN(jde-1,jte)<a name='2886'>
            DO i = its , MIN(ide-1,ite)<a name='2887'>
               IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2888'>
                  DO l = 1 , num_soil_layers<a name='2889'>
                     tslb(i,l,j)= tsk(i,j)<a name='2890'>
                     smois(i,l,j)= 1.0<a name='2891'>
                  END DO<a name='2892'>
               END IF<a name='2893'>
            END DO<a name='2894'>
         END DO<a name='2895'>
      END IF<a name='2896'>
<a name='2897'>
      DEALLOCATE (zhave)<a name='2898'>
<a name='2899'>
   END SUBROUTINE init_soil_3_real<a name='2900'>
<a name='2901'>
END MODULE module_soil_pre<a name='2902'>
<a name='2903'>
#endif<a name='2904'>
<a name='2905'>
</pre></body></html>