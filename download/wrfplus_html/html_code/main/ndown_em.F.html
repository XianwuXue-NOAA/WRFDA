<HTML> <BODY BGCOLOR=#eeeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:DRIVER_LAYER:MAIN<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='NDOWN_EM'><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='top_target'><IMG SRC="../../gif/bar_yellow.gif" border=0></A><a name='5'>
<font color=#993300>PROGRAM </font><font color=#cc0000>ndown_em</font>,<A href='../../call_from/NDOWN_EM.html' TARGET='index'>146</A><a name='6'>
<a name='7'>
   USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_19"><a name='8'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_84"><a name='9'>
   USE <A href='../../html_code/dyn_exp/module_initialize_exp.F.html#MODULE_INITIALIZE'>module_initialize</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INITIALIZE_3"><a name='10'>
   USE <A href='../../html_code/frame/module_integrate.F.html#MODULE_INTEGRATE'>module_integrate</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTEGRATE_2"><a name='11'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_32"><a name='12'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_94"><a name='13'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_10"><a name='14'>
   USE WRF_ESMF_MOD<a name='15'>
<a name='16'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_18"><a name='17'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_30"><a name='18'>
#ifdef DM_PARALLEL<a name='19'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_24"><a name='20'>
#endif<a name='21'>
<a name='22'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='23'></font>
<font color=#447700>!new for bc<a name='24'></font>
   USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_27"><a name='25'>
   USE <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_16"><a name='26'>
   USE <A href='../../html_code/share/module_get_file_names.F.html#MODULE_GET_FILE_NAMES'>module_get_file_names</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GET_FILE_NAMES_1"><a name='27'>
#ifdef WRF_CHEM<a name='28'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='29'></font>
<font color=#447700>! for chemistry<a name='30'></font>
   USE module_input_chem_data<a name='31'>
   USE module_input_chem_bioemiss<a name='32'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='33'></font>
#endif<a name='34'>
<a name='35'>
   IMPLICIT NONE<a name='36'>
<a name='37'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='38'></font>
<font color=#447700>!new for bc<a name='39'></font>
   INTEGER :: ids , ide , jds , jde , kds , kde<a name='40'>
   INTEGER :: ims , ime , jms , jme , kms , kme<a name='41'>
   INTEGER :: ips , ipe , jps , jpe , kps , kpe<a name='42'>
   INTEGER :: its , ite , jts , jte , kts , kte<a name='43'>
   INTEGER :: ijds , ijde , spec_bdy_width<a name='44'>
   INTEGER :: i , j , k<a name='45'>
   INTEGER :: time_loop_max , time_loop<a name='46'>
   INTEGER :: total_time_sec , file_counter<a name='47'>
   INTEGER :: julyr , julday , iswater , map_proj<a name='48'>
   INTEGER :: icnt<a name='49'>
<a name='50'>
   REAL    :: dt , new_bdy_frq<a name='51'>
   REAL    :: gmt , cen_lat , cen_lon , dx , dy , truelat1 , truelat2 , moad_cen_lat , stand_lon<a name='52'>
<a name='53'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: ubdy3dtemp1 , vbdy3dtemp1 , tbdy3dtemp1 , pbdy3dtemp1 , qbdy3dtemp1<a name='54'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: mbdy2dtemp1<a name='55'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: ubdy3dtemp2 , vbdy3dtemp2 , tbdy3dtemp2 , pbdy3dtemp2 , qbdy3dtemp2<a name='56'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: mbdy2dtemp2<a name='57'>
<a name='58'>
   CHARACTER(LEN=19) :: start_date_char , current_date_char , end_date_char<a name='59'>
<a name='60'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='61'></font>
<a name='62'>
   INTEGER :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='63'>
<a name='64'>
   REAL    :: time<a name='65'>
   INTEGER :: rc<a name='66'>
<a name='67'>
   INTEGER :: loop , levels_to_process<a name='68'>
   INTEGER , PARAMETER :: max_sanity_file_loop = 100<a name='69'>
<a name='70'>
   TYPE (domain) , POINTER :: keep_grid, grid_ptr, null_domain, parent_grid , nested_grid<a name='71'>
   TYPE (domain)           :: dummy<a name='72'>
   TYPE (grid_config_rec_type)              :: config_flags<a name='73'>
   INTEGER                 :: number_at_same_level<a name='74'>
   INTEGER                 :: time_step_begin_restart<a name='75'>
<a name='76'>
   INTEGER :: max_dom , domain_id , fid , fido, fidb , oid , idum1 , idum2 , ierr<a name='77'>
   INTEGER :: status_next_var<a name='78'>
   INTEGER :: debug_level<a name='79'>
   LOGICAL :: input_from_file , need_new_file<a name='80'>
   CHARACTER (LEN=19) :: date_string<a name='81'>
<a name='82'>
#ifdef DM_PARALLEL<a name='83'>
   INTEGER                 :: nbytes<a name='84'>
   INTEGER, PARAMETER      :: configbuflen = 4* CONFIG_BUF_LEN<a name='85'>
   INTEGER                 :: configbuf( configbuflen )<a name='86'>
   LOGICAL , EXTERNAL      :: wrf_dm_on_monitor<a name='87'>
#endif<a name='88'>
<a name='89'>
   INTEGER                 :: idsi<a name='90'>
   CHARACTER (LEN=80)      :: inpname , outname , bdyname<a name='91'>
   CHARACTER (LEN=80)      :: si_inpname<a name='92'>
character *19 :: temp19<a name='93'>
character *24 :: temp24 , temp24b<a name='94'>
character(len=24) :: start_date_hold<a name='95'>
<a name='96'>
   CHARACTER (LEN=80)      :: message<a name='97'>
integer :: ii<a name='98'>
   TYPE(ESMF_TimeInterval) :: time_interval<a name='99'>
<a name='100'>
   <font color=#447700>!  Interface block for routine that passes pointers and needs to know that they<a name='101'></font>
   <font color=#447700>!  are receiving pointers.<a name='102'></font>
<a name='103'>
   INTERFACE<a name='104'>
<a name='105'>
      SUBROUTINE med_interp_domain ( parent_grid , nested_grid )<a name='106'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_85"><a name='107'>
         USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_95"><a name='108'>
         TYPE(domain), POINTER :: parent_grid , nested_grid<a name='109'>
      END SUBROUTINE med_interp_domain<a name='110'>
<a name='111'>
      SUBROUTINE Setup_Timekeeping( parent_grid )<a name='112'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_86"><a name='113'>
         TYPE(domain), POINTER :: parent_grid<a name='114'>
      END SUBROUTINE Setup_Timekeeping<a name='115'>
<a name='116'>
   END INTERFACE<a name='117'>
<a name='118'>
   <font color=#447700>!  Define the name of this program (program_name defined in module_domain)<a name='119'></font>
<a name='120'>
   program_name = "NDOWN_EM V2.0.3.1 PREPROCESSOR"<a name='121'>
<a name='122'>
#ifdef DM_PARALLEL<a name='123'>
   CALL <A href='../../html_code/frame/module_io_quilt.F.html#DISABLE_QUILTING'>disable_quilting</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DISABLE_QUILTING_3"><a name='124'>
#endif<a name='125'>
<a name='126'>
   <font color=#447700>!  Initialize the modules used by the WRF system.  Many of the CALLs made from the<a name='127'></font>
   <font color=#447700>!  init_modules routine are NO-OPs.  Typical initializations are: the size of a <a name='128'></font>
   <font color=#447700>!  REAL, setting the file handles to a pre-use value, defining moisture and <a name='129'></font>
   <font color=#447700>!  chemistry indices, etc.<a name='130'></font>
<a name='131'>
   CALL <A href='../../html_code/share/init_modules.F.html#INIT_MODULES'>init_modules</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULES_8">(1)   <font color=#447700>! Phase 1 returns after MPI_INIT() (if it is called)<a name='132'></font>
   CALL ESMF_Initialize( defaultCalendar=ESMF_CAL_GREGORIAN, rc=rc )<a name='133'>
   CALL <A href='../../html_code/share/init_modules.F.html#INIT_MODULES'>init_modules</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULES_9">(2)   <font color=#447700>! Phase 2 resumes after MPI_INIT() (if it is called)<a name='134'></font>
<a name='135'>
   <font color=#447700>!  Get the NAMELIST data.  This is handled in the initial_config routine.  All of the<a name='136'></font>
   <font color=#447700>!  NAMELIST input variables are assigned to the model_config_rec structure.  Below,<a name='137'></font>
   <font color=#447700>!  note for parallel processing, only the monitor processor handles the raw Fortran<a name='138'></font>
   <font color=#447700>!  I/O, and then broadcasts the info to each of the other nodes.<a name='139'></font>
<a name='140'>
#ifdef DM_PARALLEL<a name='141'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='142'>
     CALL <A href='../../html_code/frame/module_configure.F.html#INITIAL_CONFIG'>initial_config</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIAL_CONFIG_9"><a name='143'>
   ENDIF<a name='144'>
   CALL <A href='../../html_code/frame/module_configure.F.html#GET_CONFIG_AS_BUFFER'>get_config_as_buffer</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CONFIG_AS_BUFFER_8">( configbuf, configbuflen, nbytes )<a name='145'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_76">( configbuf, nbytes )<a name='146'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_CONFIG_AS_BUFFER'>set_config_as_buffer</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CONFIG_AS_BUFFER_8">( configbuf, configbuflen )<a name='147'>
   CALL wrf_dm_initialize<a name='148'>
#else<a name='149'>
   CALL <A href='../../html_code/frame/module_configure.F.html#INITIAL_CONFIG'>initial_config</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIAL_CONFIG_10"><a name='150'>
#endif<a name='151'>
<a name='152'>
   <font color=#447700>!  And here is an instance of using the information in the NAMELIST.  <a name='153'></font>
<a name='154'>
   CALL nl_get_debug_level ( 1, debug_level )<a name='155'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#SET_WRF_DEBUG_LEVEL'>set_wrf_debug_level</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_WRF_DEBUG_LEVEL_5"> ( debug_level )<a name='156'>
<a name='157'>
   <font color=#447700>!  Allocated and configure the mother domain.  Since we are in the nesting down<a name='158'></font>
   <font color=#447700>!  mode, we know a) we got a nest, and b) we only got 1 nest.<a name='159'></font>
<a name='160'>
   NULLIFY( null_domain )<a name='161'>
<a name='162'>
   CALL       <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_37"> ( program_name )<a name='163'>
   CALL       wrf_debug ( 100 , 'ndown_em: calling alloc_and_configure_domain coarse ' )<a name='164'>
   CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_AND_CONFIGURE_DOMAIN'>alloc_and_configure_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_AND_CONFIGURE_DOMAIN_9"> ( domain_id  = 1 ,                  &amp;<a name='165'>
                                     grid       = head_grid ,          &amp;<a name='166'>
                                     parent     = null_domain ,        &amp;<a name='167'>
                                     kid        = -1                   )<a name='168'>
<a name='169'>
   parent_grid =&gt; head_grid<a name='170'>
<a name='171'>
   <font color=#447700>!  Set up time initializations.<a name='172'></font>
<a name='173'>
   CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_6"> ( parent_grid )<a name='174'>
   CALL ESMF_TimeIntervalSet ( time_interval , S=model_config_rec%interval_seconds, rc=rc )<a name='175'>
   CALL ESMF_ClockSet ( head_grid%domain_clock , timeStep=time_interval , rc=rc )<a name='176'>
<a name='177'>
   CALL       wrf_debug ( 100 , 'ndown_em: calling model_to_grid_config_rec ' )<a name='178'>
   CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_20"> ( parent_grid%id , model_config_rec , config_flags )<a name='179'>
   CALL       wrf_debug ( 100 , 'ndown_em: calling set_scalar_indices_from_config ' )<a name='180'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_15"> ( parent_grid%id , idum1, idum2 )<a name='181'>
<a name='182'>
   <font color=#447700>!  Initialize the I/O for WRF.<a name='183'></font>
<a name='184'>
   CALL       wrf_debug ( 100 , 'ndown_em: calling init_wrfio' )<a name='185'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#INIT_WRFIO'>init_wrfio</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_WRFIO_5"><a name='186'>
<a name='187'>
   <font color=#447700>!  Some of the configuration values may have been modified from the initial READ<a name='188'></font>
   <font color=#447700>!  of the NAMELIST, so we re-broadcast the configuration records.<a name='189'></font>
<a name='190'>
#ifdef DM_PARALLEL<a name='191'>
   CALL <A href='../../html_code/frame/module_configure.F.html#GET_CONFIG_AS_BUFFER'>get_config_as_buffer</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CONFIG_AS_BUFFER_9">( configbuf, configbuflen, nbytes )<a name='192'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_77">( configbuf, nbytes )<a name='193'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_CONFIG_AS_BUFFER'>set_config_as_buffer</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CONFIG_AS_BUFFER_9">( configbuf, configbuflen )<a name='194'>
#endif<a name='195'>
<a name='196'>
   <font color=#447700>!  We need to current and starting dates for the output files.  The times need to be incremented<a name='197'></font>
   <font color=#447700>!  so that the lateral BC files are not overwritten.<a name='198'></font>
<a name='199'>
   WRITE ( start_date_char , FMT = '(I4.4,"-",I2.2,"-",I2.2,"_",I2.2,":",I2.2,":",I2.2)' ) &amp;<a name='200'>
           model_config_rec%start_year  (parent_grid%id) , &amp;<a name='201'>
           model_config_rec%start_month (parent_grid%id) , &amp;<a name='202'>
           model_config_rec%start_day   (parent_grid%id) , &amp;<a name='203'>
           model_config_rec%start_hour  (parent_grid%id) , &amp;<a name='204'>
           model_config_rec%start_minute(parent_grid%id) , &amp;<a name='205'>
           model_config_rec%start_second(parent_grid%id) <a name='206'>
<a name='207'>
   WRITE (   end_date_char , FMT = '(I4.4,"-",I2.2,"-",I2.2,"_",I2.2,":",I2.2,":",I2.2)' ) &amp;<a name='208'>
           model_config_rec%  end_year  (parent_grid%id) , &amp;<a name='209'>
           model_config_rec%  end_month (parent_grid%id) , &amp;<a name='210'>
           model_config_rec%  end_day   (parent_grid%id) , &amp;<a name='211'>
           model_config_rec%  end_hour  (parent_grid%id) , &amp;<a name='212'>
           model_config_rec%  end_minute(parent_grid%id) , &amp;<a name='213'>
           model_config_rec%  end_second(parent_grid%id) <a name='214'>
<a name='215'>
   <font color=#447700>!  Override stop time with value computed above.<a name='216'></font>
   CALL <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_2">( end_date_char, parent_grid%stop_time )<a name='217'>
   CALL ESMF_ClockSet ( parent_grid%domain_clock , StopTime=parent_grid%stop_time, rc=rc )<a name='218'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_CHECK_ERROR'>wrf_check_error</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_CHECK_ERROR_7">( ESMF_SUCCESS, rc, &amp;<a name='219'>
                         'ESMF_ClockSet(parent_grid%domain_clock) FAILED', &amp;<a name='220'>
                         __FILE__ , &amp;<a name='221'>
                         __LINE__  )<a name='222'>
<a name='223'>
   CALL <A href='../../html_code/share/module_date_time.F.html#GETH_IDTS'>geth_idts</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_IDTS_1"> ( end_date_char , start_date_char , total_time_sec ) <a name='224'>
<a name='225'>
   new_bdy_frq = model_config_rec%interval_seconds<a name='226'>
   time_loop_max = total_time_sec / model_config_rec%interval_seconds + 1<a name='227'>
<a name='228'>
   start_date        = start_date_char // '.0000' <a name='229'>
   current_date      = start_date_char // '.0000' <a name='230'>
   start_date_hold   = start_date_char // '.0000'<a name='231'>
   current_date_char = start_date_char<a name='232'>
<a name='233'>
   <font color=#447700>!  Get a list of available file names to try.  This fills up the eligible_file_name<a name='234'></font>
   <font color=#447700>!  array with number_of_eligible_files entries.  This routine issues a nonstandard<a name='235'></font>
   <font color=#447700>!  call (system).<a name='236'></font>
<a name='237'>
   file_counter = 1<a name='238'>
   need_new_file = .FALSE.<a name='239'>
   CALL <A href='../../html_code/share/module_get_file_names.F.html#UNIX_LS'>unix_ls</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UNIX_LS_1"> ( 'wrfout' , parent_grid%id )<a name='240'>
<a name='241'>
   <font color=#447700>!  Open the input data (wrfout_d01_xxxxxx) for reading.<a name='242'></font>
   <a name='243'>
   CALL wrf_debug          ( 100 , 'ndown_em main: calling open_r_dataset for ' // TRIM(eligible_file_name(file_counter)) )<a name='244'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_1">     ( fid, TRIM(eligible_file_name(file_counter)) , head_grid , config_flags , "DATASET=AUXINPUT1", ierr )<a name='245'>
   IF ( ierr .NE. 0 ) THEN<a name='246'>
      WRITE( wrf_err_message , FMT='(A,A,A,I8)' ) 'program ndown: error opening ',TRIM(eligible_file_name(file_counter)), &amp;<a name='247'>
                                                  ' for reading ierr=',ierr<a name='248'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_119"> ( wrf_err_message )<a name='249'>
   ENDIF<a name='250'>
<a name='251'>
   <font color=#447700>!  We know how many time periods to process, so we begin.<a name='252'></font>
<a name='253'>
   big_time_loop_thingy : DO time_loop = 1 , time_loop_max<a name='254'>
<a name='255'>
      <font color=#447700>!  Which date are we currently soliciting?<a name='256'></font>
<a name='257'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_NEWDATE'>geth_newdate</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_NEWDATE_4"> ( date_string , start_date_char , ( time_loop - 1 ) * NINT ( new_bdy_frq) )<a name='258'>
print *,'--------&gt;&gt;&gt;  Processing data: loop=',time_loop,'  date/time = ',date_string<a name='259'>
      current_date_char = date_string<a name='260'>
      current_date      = date_string // '.0000'<a name='261'>
      start_date        = date_string // '.0000'<a name='262'>
print *,'loopmax = ', time_loop_max, '   ending date = ',end_date_char<a name='263'>
      CALL <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_3">( current_date(1:19), parent_grid%current_time )<a name='264'>
      CALL ESMF_ClockSet(parent_grid%domain_clock, currTime=parent_grid%current_time, rc=rc)<a name='265'>
<a name='266'>
      <font color=#447700>!  Which times are in this file, and more importantly, are any of them the<a name='267'></font>
      <font color=#447700>!  ones that we want?  We need to loop over times in each files, loop<a name='268'></font>
      <font color=#447700>!  over files.<a name='269'></font>
<a name='270'>
      get_the_right_time : DO<a name='271'>
      <a name='272'>
         CALL <A href='../../html_code/frame/module_io.F.html#WRF_GET_NEXT_TIME'>wrf_get_next_time</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NEXT_TIME_1"> ( fid , date_string , status_next_var )<a name='273'>
print *,'file date/time = ',date_string,'     desired date = ',current_date_char,'     status = ', status_next_var<a name='274'>
<a name='275'>
         IF      (  status_next_var .NE. 0 ) THEN<a name='276'>
            CALL wrf_debug          ( 100 , 'ndown_em main: calling close_dataset  for ' // TRIM(eligible_file_name(file_counter)) )<a name='277'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_5">      ( fid , config_flags , "DATASET=INPUT" )<a name='278'>
            file_counter = file_counter + 1<a name='279'>
            IF ( file_counter .GT. number_of_eligible_files ) THEN<a name='280'>
               WRITE( wrf_err_message , FMT='(A,A,A,I8)' ) 'program ndown: opening too many files'<a name='281'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_120"> ( wrf_err_message )<a name='282'>
            END IF<a name='283'>
            CALL wrf_debug      ( 100 , 'ndown_em main: calling open_r_dataset for ' // TRIM(eligible_file_name(file_counter)) )<a name='284'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_2"> ( fid, TRIM(eligible_file_name(file_counter)) , head_grid , config_flags , "DATASET=INPUT", ierr )<a name='285'>
            IF ( ierr .NE. 0 ) THEN<a name='286'>
               WRITE( wrf_err_message , FMT='(A,A,A,I8)' ) 'program ndown: error opening ',TRIM(eligible_file_name(file_counter)), &amp;<a name='287'>
                                                           ' for reading ierr=',ierr<a name='288'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_121"> ( wrf_err_message )<a name='289'>
            ENDIF<a name='290'>
            CYCLE get_the_right_time<a name='291'>
         ELSE IF ( TRIM(date_string) .LT. TRIM(current_date_char) ) THEN<a name='292'>
            CYCLE get_the_right_time<a name='293'>
         ELSE IF ( TRIM(date_string) .EQ. TRIM(current_date_char) ) THEN<a name='294'>
            EXIT get_the_right_time<a name='295'>
         ELSE IF ( TRIM(date_string) .GT. TRIM(current_date_char) ) THEN<a name='296'>
            WRITE( wrf_err_message , FMT='(A,A,A,A,A)' ) 'Found ',TRIM(date_string),' before I found ',TRIM(current_date_char),'.'<a name='297'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_122"> ( wrf_err_message )<a name='298'>
         END IF<a name='299'>
      END DO get_the_right_time <a name='300'>
<a name='301'>
      CALL wrf_debug          ( 100 , 'wrf: calling input_history' )<a name='302'>
      CALL <A href='../../html_code/frame/module_io.F.html#WRF_GET_PREVIOUS_TIME'>wrf_get_previous_time</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_PREVIOUS_TIME_1"> ( fid , date_string , status_next_var )<a name='303'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#INPUT_HISTORY'>input_history</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_HISTORY_1">      ( fid , head_grid , config_flags, ierr )<a name='304'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_128">          ( 100 , 'wrf: back from input_history' )<a name='305'>
<a name='306'>
      <font color=#447700>!  Get the coarse grid info for later transfer to the fine grid domain.<a name='307'></font>
<a name='308'>
      CALL wrf_get_dom_ti_integer ( fid , 'MAP_PROJ' , map_proj , 1 , icnt , ierr ) <a name='309'>
      CALL wrf_get_dom_ti_real    ( fid , 'DX'  , dx  , 1 , icnt , ierr ) <a name='310'>
      CALL wrf_get_dom_ti_real    ( fid , 'DY'  , dy  , 1 , icnt , ierr ) <a name='311'>
      CALL wrf_get_dom_ti_real    ( fid , 'CEN_LAT' , cen_lat , 1 , icnt , ierr ) <a name='312'>
      CALL wrf_get_dom_ti_real    ( fid , 'CEN_LON' , cen_lon , 1 , icnt , ierr ) <a name='313'>
      CALL wrf_get_dom_ti_real    ( fid , 'TRUELAT1' , truelat1 , 1 , icnt , ierr ) <a name='314'>
      CALL wrf_get_dom_ti_real    ( fid , 'TRUELAT2' , truelat2 , 1 , icnt , ierr ) <a name='315'>
      CALL wrf_get_dom_ti_real    ( fid , 'MOAD_CEN_LAT' , moad_cen_lat , 1 , icnt , ierr ) <a name='316'>
      CALL wrf_get_dom_ti_real    ( fid , 'STAND_LON' , stand_lon , 1 , icnt , ierr ) <a name='317'>
<font color=#447700>!     CALL wrf_get_dom_ti_real    ( fid , 'GMT' , gmt , 1 , icnt , ierr ) <a name='318'></font>
<font color=#447700>!     CALL wrf_get_dom_ti_integer ( fid , 'JULYR' , julyr , 1 , icnt , ierr ) <a name='319'></font>
<font color=#447700>!     CALL wrf_get_dom_ti_integer ( fid , 'JULDAY' , julday , 1 , icnt , ierr ) <a name='320'></font>
      CALL wrf_get_dom_ti_integer ( fid , 'ISWATER' , iswater , 1 , icnt , ierr ) <a name='321'>
<a name='322'>
      <font color=#447700>!  First time in, do this: allocate sapce for the fine grid, get the config flags, open the <a name='323'></font>
      <font color=#447700>!  wrfinput and wrfbdy files.  This COULD be done outside the time loop, I think, so check it<a name='324'></font>
      <font color=#447700>!  out and move it up if you can.<a name='325'></font>
<a name='326'>
      IF ( time_loop .EQ. 1 ) THEN<a name='327'>
<a name='328'>
         CALL       <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_38"> ( program_name )<a name='329'>
         CALL       wrf_debug ( 100 , 'wrf: calling alloc_and_configure_domain fine ' )<a name='330'>
         CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_AND_CONFIGURE_DOMAIN'>alloc_and_configure_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_AND_CONFIGURE_DOMAIN_10"> ( domain_id  = 2 ,                  &amp;<a name='331'>
                                           grid       = nested_grid ,        &amp;<a name='332'>
                                           parent     = parent_grid ,        &amp;<a name='333'>
                                           kid        = 1                   )<a name='334'>
   <a name='335'>
         CALL       wrf_debug ( 100 , 'wrf: calling model_to_grid_config_rec ' )<a name='336'>
         CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_21"> ( nested_grid%id , model_config_rec , config_flags )<a name='337'>
         CALL       wrf_debug ( 100 , 'wrf: calling set_scalar_indices_from_config ' )<a name='338'>
         CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_16"> ( nested_grid%id , idum1, idum2 )<a name='339'>
<a name='340'>
         <font color=#447700>!  Set up time initializations for the fine grid.<a name='341'></font>
<a name='342'>
         CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_7"> ( nested_grid )<a name='343'>
         CALL ESMF_TimeIntervalSet ( time_interval , S=model_config_rec%interval_seconds, rc=rc )<a name='344'>
         CALL <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_4">( current_date(1:19), nested_grid%current_time )<a name='345'>
         <font color=#447700>! Strictly speaking, nest stop time should come from model_config_rec...  <a name='346'></font>
         CALL ESMF_ClockSet( nested_grid%domain_clock, timeStep=time_interval,            &amp;<a name='347'>
                                                       currTime=nested_grid%current_time, &amp;<a name='348'>
                                                       StopTime=parent_grid%stop_time, &amp;<a name='349'>
                                                       rc=rc )<a name='350'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_CHECK_ERROR'>wrf_check_error</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_CHECK_ERROR_8">( ESMF_SUCCESS, rc, &amp;<a name='351'>
                               'ESMF_ClockSet(nested_grid%domain_clock) FAILED', &amp;<a name='352'>
                               __FILE__ , &amp;<a name='353'>
                               __LINE__  )<a name='354'>
<a name='355'>
         <font color=#447700>!  Generate an output file from this program, which will be an input file to WRF.<a name='356'></font>
<a name='357'>
         CALL nl_set_bdyfrq ( nested_grid%id , new_bdy_frq )<a name='358'>
         config_flags%bdyfrq = new_bdy_frq<a name='359'>
<a name='360'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='361'></font>
<font color=#447700>! major kludge<a name='362'></font>
print *,'kludge - stupid way to get 1d and consts into new grid'<a name='363'>
nested_grid%em_fnm    = parent_grid%em_fnm<a name='364'>
nested_grid%em_fnp    = parent_grid%em_fnp<a name='365'>
nested_grid%em_rdnw   = parent_grid%em_rdnw<a name='366'>
nested_grid%em_rdn    = parent_grid%em_rdn<a name='367'>
nested_grid%em_dnw    = parent_grid%em_dnw<a name='368'>
nested_grid%em_dn     = parent_grid%em_dn <a name='369'>
nested_grid%em_znu    = parent_grid%em_znu<a name='370'>
nested_grid%em_znw    = parent_grid%em_znw<a name='371'>
<a name='372'>
print *,'nested_grid%em_fnm    =', parent_grid%em_fnm<a name='373'>
print *,'nested_grid%em_fnp    =', parent_grid%em_fnp<a name='374'>
print *,'nested_grid%em_rdnw   =', parent_grid%em_rdnw<a name='375'>
print *,'nested_grid%em_rdn    =', parent_grid%em_rdn<a name='376'>
print *,'nested_grid%em_dnw    =', parent_grid%em_dnw<a name='377'>
print *,'nested_grid%em_dn     =', parent_grid%em_dn <a name='378'>
print *,'nested_grid%em_znu    =', parent_grid%em_znu<a name='379'>
print *,'nested_grid%em_znw    =', parent_grid%em_znw<a name='380'>
<a name='381'>
nested_grid%zs        = parent_grid%zs<a name='382'>
nested_grid%dzs       = parent_grid%dzs<a name='383'>
<a name='384'>
nested_grid%p_top     = parent_grid%p_top<a name='385'>
nested_grid%rdx       = parent_grid%rdx * 3.<a name='386'>
nested_grid%rdy       = parent_grid%rdy * 3.<a name='387'>
nested_grid%resm      = parent_grid%resm<a name='388'>
nested_grid%zetatop   = parent_grid%zetatop<a name='389'>
nested_grid%cf1       = parent_grid%cf1<a name='390'>
nested_grid%cf2       = parent_grid%cf2<a name='391'>
nested_grid%cf3       = parent_grid%cf3<a name='392'>
<a name='393'>
print *,'nested_grid%zs        =', parent_grid%zs<a name='394'>
print *,'nested_grid%dzs       =', parent_grid%dzs<a name='395'>
<a name='396'>
print *,'nested_grid%p_top     =', parent_grid%p_top<a name='397'>
print *,'nested_grid%rdx       =', parent_grid%rdx *3.<a name='398'>
print *,'nested_grid%rdy       =', parent_grid%rdy * 3.<a name='399'>
print *,'nested_grid%resm      =', parent_grid%resm<a name='400'>
print *,'nested_grid%zetatop   =', parent_grid%zetatop<a name='401'>
print *,'nested_grid%cf1       =', parent_grid%cf1<a name='402'>
print *,'nested_grid%cf2       =', parent_grid%cf2<a name='403'>
print *,'nested_grid%cf3       =', parent_grid%cf3<a name='404'>
<a name='405'>
nested_grid%cfn       = parent_grid%cfn <a name='406'>
nested_grid%cfn1      = parent_grid%cfn1<a name='407'>
nested_grid%epsts     = parent_grid%epsts<a name='408'>
<a name='409'>
print *,'nested_grid%cfn       =', parent_grid%cfn <a name='410'>
print *,'nested_grid%cfn1      =', parent_grid%cfn1<a name='411'>
print *,'nested_grid%epsts     =', parent_grid%epsts<a name='412'>
<a name='413'>
#ifdef WRF_CHEM<a name='414'>
nested_grid%chem_opt    = parent_grid%chem_opt<a name='415'>
nested_grid%chem_in_opt = parent_grid%chem_in_opt<a name='416'>
#endif<a name='417'>
<a name='418'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='419'></font>
   <a name='420'>
         CALL wrf_debug          ( 100 , 'ndown_em main: calling open_w_dataset for wrfinput' )<a name='421'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_5">( outname , 'wrfinput' , nested_grid%id , 2 )<a name='422'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_5">     ( fido, TRIM(outname) , nested_grid , config_flags , output_model_input , "DATASET=INPUT", ierr )<a name='423'>
         IF ( ierr .NE. 0 ) THEN<a name='424'>
            WRITE( wrf_err_message , FMT='(A,A,A,I8)' ) 'program ndown: error opening ',TRIM(outname),' for reading ierr=',ierr<a name='425'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_123"> ( wrf_err_message )<a name='426'>
         ENDIF<a name='427'>
<a name='428'>
         <font color=#447700>!  Various sizes that we need to be concerned about.<a name='429'></font>
<a name='430'>
         ids = nested_grid%sd31<a name='431'>
         ide = nested_grid%ed31<a name='432'>
         kds = nested_grid%sd32<a name='433'>
         kde = nested_grid%ed32<a name='434'>
         jds = nested_grid%sd33<a name='435'>
         jde = nested_grid%ed33<a name='436'>
<a name='437'>
         ims = nested_grid%sm31<a name='438'>
         ime = nested_grid%em31<a name='439'>
         kms = nested_grid%sm32<a name='440'>
         kme = nested_grid%em32<a name='441'>
         jms = nested_grid%sm33<a name='442'>
         jme = nested_grid%em33<a name='443'>
<a name='444'>
         ips = nested_grid%sp31<a name='445'>
         ipe = nested_grid%ep31<a name='446'>
         kps = nested_grid%sp32<a name='447'>
         kpe = nested_grid%ep32<a name='448'>
         jps = nested_grid%sp33<a name='449'>
         jpe = nested_grid%ep33<a name='450'>
<a name='451'>
         ijds = MIN ( ids , jds )<a name='452'>
         ijde = MAX ( ide , jde )<a name='453'>
<a name='454'>
         print *, ids , ide , jds , jde , kds , kde<a name='455'>
         print *, ims , ime , jms , jme , kms , kme<a name='456'>
         print *, ips , ipe , jps , jpe , kps , kpe<a name='457'>
         print *, ijds , ijde<a name='458'>
<a name='459'>
         spec_bdy_width = model_config_rec%spec_bdy_width<a name='460'>
         print *,'spec_bdy_width=',spec_bdy_width<a name='461'>
<a name='462'>
         <font color=#447700>!  This is the space needed to save the current 3d data for use in computing<a name='463'></font>
         <font color=#447700>!  the lateral boundary tendencies.<a name='464'></font>
<a name='465'>
         ALLOCATE ( ubdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='466'>
         ALLOCATE ( vbdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='467'>
         ALLOCATE ( tbdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='468'>
         ALLOCATE ( pbdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='469'>
         ALLOCATE ( qbdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='470'>
         ALLOCATE ( mbdy2dtemp1(ims:ime,1:1,    jms:jme) )<a name='471'>
         ALLOCATE ( ubdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='472'>
         ALLOCATE ( vbdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='473'>
         ALLOCATE ( tbdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='474'>
         ALLOCATE ( pbdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='475'>
         ALLOCATE ( qbdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='476'>
         ALLOCATE ( mbdy2dtemp2(ims:ime,1:1,    jms:jme) )<a name='477'>
<a name='478'>
      END IF<a name='479'>
<a name='480'>
      CALL <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_5">( current_date(1:19), nested_grid%current_time )<a name='481'>
      CALL ESMF_ClockSet( nested_grid%domain_clock, timeStep=time_interval,            &amp;<a name='482'>
                                                    currTime=nested_grid%current_time, &amp;<a name='483'>
                                                    rc=rc )<a name='484'>
<a name='485'>
      <font color=#447700>!  Do the horizontal interpolation.<a name='486'></font>
<a name='487'>
      nested_grid%imask_nostag = 1<a name='488'>
      nested_grid%imask_xstag = 1<a name='489'>
      nested_grid%imask_ystag = 1<a name='490'>
      nested_grid%imask_xystag = 1<a name='491'>
      CALL <A href='../../html_code/share/mediation_interp_domain.F.html#MED_INTERP_DOMAIN'>med_interp_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INTERP_DOMAIN_1"> ( head_grid , nested_grid )<a name='492'>
      nested_grid%ht_int = nested_grid%ht<a name='493'>
<a name='494'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='495'></font>
<a name='496'>
      IF ( time_loop .EQ. 1 ) THEN<a name='497'>
<a name='498'>
         <font color=#447700>!  Open the fine grid SI static file.<a name='499'></font>
   <a name='500'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2'>construct_filename2</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2_1">( si_inpname , 'wrf_real_input_em' , nested_grid%id , 2 , start_date_char )<a name='501'>
         CALL       wrf_debug ( 100 , 'med_sidata_input: calling open_r_dataset for ' // TRIM(si_inpname) )<a name='502'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_3"> ( idsi, TRIM(si_inpname) , nested_grid , config_flags , "DATASET=INPUT", ierr )<a name='503'>
         IF ( ierr .NE. 0 ) THEN<a name='504'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_124">( 'real: error opening wrf_real_input_em for reading: ' // TRIM (si_inpname) )<a name='505'>
         END IF<a name='506'>
<a name='507'>
         <font color=#447700>!  Input data.<a name='508'></font>
   <a name='509'>
         CALL       wrf_debug ( 100 , 'ndown_em: calling input_aux_model_input2' )<a name='510'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#INPUT_AUX_MODEL_INPUT2'>input_aux_model_input2</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_AUX_MODEL_INPUT2_1"> ( idsi , nested_grid , config_flags , ierr )<a name='511'>
         nested_grid%ht_input = nested_grid%ht<a name='512'>
   <a name='513'>
         <font color=#447700>!  Close this fine grid static input file.<a name='514'></font>
   <a name='515'>
         CALL       <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_129"> ( 100 , 'ndown_em: closing fine grid static input' )<a name='516'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_6"> ( idsi , config_flags , "DATASET=INPUT" )<a name='517'>
<a name='518'>
         <font color=#447700>!  We need a fine grid landuse in the interpolation.  So we need to generate<a name='519'></font>
         <font color=#447700>!  that field now.<a name='520'></font>
<a name='521'>
         IF      ( ( nested_grid%ivgtyp(ips,jps) .GT. 0 ) .AND. &amp;<a name='522'>
                   ( nested_grid%isltyp(ips,jps) .GT. 0 ) ) THEN<a name='523'>
            DO j = jps, MIN(jde-1,jpe)<a name='524'>
               DO i = ips, MIN(ide-1,ipe)<a name='525'>
                  nested_grid% vegcat(i,j) = nested_grid%ivgtyp(i,j)<a name='526'>
                  nested_grid%soilcat(i,j) = nested_grid%isltyp(i,j)<a name='527'>
               END DO<a name='528'>
            END DO<a name='529'>
<a name='530'>
         ELSE IF ( ( nested_grid% vegcat(ips,jps) .GT. 0.5 ) .AND. &amp;<a name='531'>
                   ( nested_grid%soilcat(ips,jps) .GT. 0.5 ) ) THEN<a name='532'>
            DO j = jps, MIN(jde-1,jpe)<a name='533'>
               DO i = ips, MIN(ide-1,ipe)<a name='534'>
                  nested_grid%ivgtyp(i,j) = NINT(nested_grid% vegcat(i,j))<a name='535'>
                  nested_grid%isltyp(i,j) = NINT(nested_grid%soilcat(i,j))<a name='536'>
               END DO<a name='537'>
            END DO<a name='538'>
<a name='539'>
         ELSE<a name='540'>
            num_veg_cat      = SIZE ( nested_grid%landusef , DIM=2 )<a name='541'>
            num_soil_top_cat = SIZE ( nested_grid%soilctop , DIM=2 )<a name='542'>
            num_soil_bot_cat = SIZE ( nested_grid%soilcbot , DIM=2 )<a name='543'>
   <a name='544'>
            CALL <A href='../../html_code/main/ndown_em.F.html#LAND_PERCENTAGES'>land_percentages</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LAND_PERCENTAGES_1"> (  nested_grid%xland , &amp;<a name='545'>
                                     nested_grid%landusef , nested_grid%soilctop , nested_grid%soilcbot , &amp;<a name='546'>
                                     nested_grid%isltyp , nested_grid%ivgtyp , &amp;<a name='547'>
                                     num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='548'>
                                     ids , ide , jds , jde , kds , kde , &amp;<a name='549'>
                                     ims , ime , jms , jme , kms , kme , &amp;<a name='550'>
                                     ips , ipe , jps , jpe , kps , kpe , &amp;<a name='551'>
                                     model_config_rec%iswater(nested_grid%id) )<a name='552'>
<a name='553'>
          END IF<a name='554'>
<a name='555'>
          DO j = jps, MIN(jde-1,jpe)<a name='556'>
            DO i = ips, MIN(ide-1,ipe)<a name='557'>
               nested_grid%lu_index(i,j) = nested_grid%ivgtyp(i,j)<a name='558'>
            END DO<a name='559'>
         END DO<a name='560'>
<a name='561'>
         CALL <A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY'>check_consistency</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_CONSISTENCY_1"> ( nested_grid%ivgtyp , nested_grid%isltyp , nested_grid%landmask , &amp;<a name='562'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='563'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='564'>
                                  ips , ipe , jps , jpe , kps , kpe , &amp;<a name='565'>
                                  model_config_rec%iswater(nested_grid%id) )<a name='566'>
<a name='567'>
         CALL <A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY2'>check_consistency2</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_CONSISTENCY2_1">( nested_grid%ivgtyp , nested_grid%isltyp , nested_grid%landmask , &amp;<a name='568'>
                                  nested_grid%tmn , nested_grid%tsk , nested_grid%sst , nested_grid%xland , &amp;<a name='569'>
                                  nested_grid%tslb , nested_grid%smois , nested_grid%sh2o , &amp;<a name='570'>
                                  config_flags%num_soil_layers , nested_grid%id , &amp;<a name='571'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='572'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='573'>
                                  ips , ipe , jps , jpe , kps , kpe , &amp;<a name='574'>
                                  model_config_rec%iswater(nested_grid%id) )<a name='575'>
<a name='576'>
      END IF<a name='577'>
<a name='578'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='579'></font>
   <a name='580'>
      <font color=#447700>!  We have 2 terrain elevations.  One is from input and the other is from the<a name='581'></font>
      <font color=#447700>!  the horizontal interpolation.<a name='582'></font>
<a name='583'>
      nested_grid%ht_fine = nested_grid%ht_input<a name='584'>
      nested_grid%ht      = nested_grid%ht_int<a name='585'>
<a name='586'>
      <font color=#447700>!  We have both the interpolated fields and the higher-resolution static fields.  From these<a name='587'></font>
      <font color=#447700>!  the rebalancing is now done.  Note also that the field nested_grid%ht is now from the <a name='588'></font>
      <font color=#447700>!  fine grid input file (after this call is completed).<a name='589'></font>
<a name='590'>
      CALL <A href='../../html_code/dyn_em/module_initialize_real.F.html#REBALANCE_DRIVER'>rebalance_driver</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REBALANCE_DRIVER_1"> ( nested_grid ) <a name='591'>
<a name='592'>
      <font color=#447700>!  Different things happen during the different time loops:<a name='593'></font>
      <font color=#447700>!      first loop - write wrfinput file, close data set, copy files to holder arrays<a name='594'></font>
      <font color=#447700>!      middle loops - diff 3d/2d arrays, compute and output bc<a name='595'></font>
      <font color=#447700>!      last loop - diff 3d/2d arrays, compute and output bc, write wrfbdy file, close wrfbdy file<a name='596'></font>
<a name='597'>
      IF ( time_loop .EQ. 1 ) THEN<a name='598'>
<a name='599'>
         <font color=#447700>!  Set the time info.<a name='600'></font>
<a name='601'>
         print *,'current_date = ',current_date<a name='602'>
         CALL <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_6">( current_date(1:19), nested_grid%current_time )<a name='603'>
         CALL ESMF_ClockSet(nested_grid%domain_clock, currTime=nested_grid%current_time, rc=rc)<a name='604'>
<font color=#447700>!<a name='605'></font>
<font color=#447700>! SEP     Put in chemistry data<a name='606'></font>
<font color=#447700>!<a name='607'></font>
#ifdef WRF_CHEM<a name='608'>
         IF( nested_grid%chem_opt .NE. 0 ) then<a name='609'>
            IF( nested_grid%chem_in_opt .EQ. 0 ) then<a name='610'>
             <font color=#447700>! Read the chemistry data from a previous wrf forecast (wrfout file)<a name='611'></font>
              <font color=#447700>! Generate chemistry data from a idealized vertical profile<a name='612'></font>
              message = 'STARTING WITH BACKGROUND CHEMISTRY '<a name='613'>
              CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_39"> ( message )<a name='614'>
<a name='615'>
              CALL input_chem_profile ( nested_grid )<a name='616'>
<a name='617'>
              message = 'READING BEIS3.11 EMISSIONS DATA'<a name='618'>
              CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_40"> ( message )<a name='619'>
<a name='620'>
              CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS'>med_read_wrf_chem_bioemiss</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_CHEM_BIOEMISS_1"> ( nested_grid , config_flags)<a name='621'>
            ELSE<a name='622'>
              message = 'RUNNING WITHOUT CHEMISTRY INITIALIZATION'<a name='623'>
              CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_41"> ( message )<a name='624'>
            ENDIF<a name='625'>
         ENDIF<a name='626'>
#endif<a name='627'>
<a name='628'>
         <font color=#447700>!  Output the first time period of the data.<a name='629'></font>
   <a name='630'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#OUTPUT_MODEL_INPUT'>output_model_input</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_MODEL_INPUT_3"> ( fido , nested_grid , config_flags , ierr )<a name='631'>
<a name='632'>
         CALL wrf_put_dom_ti_integer ( fido , 'MAP_PROJ' , map_proj , 1 , ierr ) <a name='633'>
<font color=#447700>!        CALL wrf_put_dom_ti_real    ( fido , 'DX'  , dx  , 1 , ierr ) <a name='634'></font>
<font color=#447700>!        CALL wrf_put_dom_ti_real    ( fido , 'DY'  , dy  , 1 , ierr ) <a name='635'></font>
         CALL wrf_put_dom_ti_real    ( fido , 'CEN_LAT' , cen_lat , 1 , ierr ) <a name='636'>
         CALL wrf_put_dom_ti_real    ( fido , 'CEN_LON' , cen_lon , 1 , ierr ) <a name='637'>
         CALL wrf_put_dom_ti_real    ( fido , 'TRUELAT1' , truelat1 , 1 , ierr ) <a name='638'>
         CALL wrf_put_dom_ti_real    ( fido , 'TRUELAT2' , truelat2 , 1 , ierr ) <a name='639'>
         CALL wrf_put_dom_ti_real    ( fido , 'MOAD_CEN_LAT' , moad_cen_lat , 1 , ierr ) <a name='640'>
         CALL wrf_put_dom_ti_real    ( fido , 'STAND_LON' , stand_lon , 1 , ierr ) <a name='641'>
         CALL wrf_put_dom_ti_integer ( fido , 'ISWATER' , iswater , 1 , ierr ) <a name='642'>
<a name='643'>
         <font color=#447700>!  These change if the initial time for the nest is not the same as the<a name='644'></font>
         <font color=#447700>!  first time period in the WRF output file.<a name='645'></font>
         <font color=#447700>!  Now that we know the starting date, we need to set the GMT, JULYR, and JULDAY<a name='646'></font>
         <font color=#447700>!  values for the global attributes.  This call is based on the setting of the <a name='647'></font>
         <font color=#447700>!  current_date string.<a name='648'></font>
<a name='649'>
         CALL <A href='../../html_code/share/module_date_time.F.html#GETH_JULGMT'>geth_julgmt</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_JULGMT_1"> ( julyr , julday , gmt)<a name='650'>
         CALL nl_set_julyr  ( nested_grid%id , julyr  )<a name='651'>
         CALL nl_set_julday ( nested_grid%id , julday )<a name='652'>
         CALL nl_set_gmt    ( nested_grid%id , gmt    )<a name='653'>
         CALL wrf_put_dom_ti_real    ( fido , 'GMT' , gmt , 1 , ierr ) <a name='654'>
         CALL wrf_put_dom_ti_integer ( fido , 'JULYR' , julyr , 1 , ierr ) <a name='655'>
         CALL wrf_put_dom_ti_integer ( fido , 'JULDAY' , julday , 1 , ierr ) <a name='656'>
print *,'current_date =',current_date<a name='657'>
print *,'julyr=',julyr<a name='658'>
print *,'julday=',julday<a name='659'>
print *,'gmt=',gmt<a name='660'>
         <a name='661'>
         <font color=#447700>!  Close the input (wrfout_d01_000000, for example) file.  That's right, the <a name='662'></font>
         <font color=#447700>!  input is an output file.  Who'd've thunk.<a name='663'></font>
   <a name='664'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_7">      ( fido , config_flags , "DATASET=INPUT" )<a name='665'>
<a name='666'>
         <font color=#447700>!  We need to save the 3d/2d data to compute a difference during the next loop.  Couple the<a name='667'></font>
         <font color=#447700>!  3d fields with total mu (mub + mu_2) and the stagger-specific map scale factor.<a name='668'></font>
<a name='669'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_1"> ( nested_grid%em_mu_2 , nested_grid%em_mub , ubdy3dtemp1 , nested_grid%em_u_2                 , &amp;<a name='670'>
                       'u' , nested_grid%msfu , &amp;<a name='671'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='672'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_2"> ( nested_grid%em_mu_2 , nested_grid%em_mub , vbdy3dtemp1 , nested_grid%em_v_2                 , &amp;<a name='673'>
                       'v' , nested_grid%msfv , &amp;<a name='674'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='675'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_3"> ( nested_grid%em_mu_2 , nested_grid%em_mub , tbdy3dtemp1 , nested_grid%em_t_2                 , &amp;<a name='676'>
                       't' , nested_grid%msft , &amp;<a name='677'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='678'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_4"> ( nested_grid%em_mu_2 , nested_grid%em_mub , pbdy3dtemp1 , nested_grid%em_ph_2                , &amp;<a name='679'>
                       'h' , nested_grid%msft , &amp;<a name='680'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='681'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_5"> ( nested_grid%em_mu_2 , nested_grid%em_mub , qbdy3dtemp1 , nested_grid%moist_2(:,:,:,P_QV)    , &amp;<a name='682'>
                       't' , nested_grid%msft , &amp;<a name='683'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='684'>
<a name='685'>
          DO j = jps , jpe<a name='686'>
             DO i = ips , ipe<a name='687'>
                mbdy2dtemp1(i,1,j) = nested_grid%em_mu_2(i,j)<a name='688'>
             END DO<a name='689'>
          END DO<a name='690'>
<a name='691'>
         <font color=#447700>!  There are 2 components to the lateral boundaries.  First, there is the starting<a name='692'></font>
         <font color=#447700>!  point of this time period - just the outer few rows and columns.<a name='693'></font>
<a name='694'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_1">     ( ubdy3dtemp1 , nested_grid%em_u_b     , 'U' , ijds , ijde , spec_bdy_width      , &amp;<a name='695'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='696'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='697'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='698'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_2">     ( vbdy3dtemp1 , nested_grid%em_v_b     , 'V' , ijds , ijde , spec_bdy_width      , &amp;<a name='699'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='700'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='701'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='702'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_3">     ( tbdy3dtemp1 , nested_grid%em_t_b     , 'T' , ijds , ijde , spec_bdy_width      , &amp;<a name='703'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='704'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='705'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='706'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_4">     ( pbdy3dtemp1 , nested_grid%em_ph_b    , 'W' , ijds , ijde , spec_bdy_width      , &amp;<a name='707'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='708'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='709'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='710'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_5">     ( qbdy3dtemp1 , nested_grid%em_rqv_b   , 'T' , ijds , ijde , spec_bdy_width      , &amp;<a name='711'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='712'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='713'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='714'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_6">     ( mbdy2dtemp1 , nested_grid%em_mu_b    , 'M' , ijds , ijde , spec_bdy_width      , &amp;<a name='715'>
                                                                           ids , ide , jds , jde , 1 , 1 , &amp;<a name='716'>
                                                                           ims , ime , jms , jme , 1 , 1 , &amp;<a name='717'>
                                                                           ips , ipe , jps , jpe , 1 , 1 )<a name='718'>
<a name='719'>
      ELSE IF ( ( time_loop .GT. 1 ) .AND. ( time_loop .LT. time_loop_max ) ) THEN<a name='720'>
<a name='721'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_6"> ( nested_grid%em_mu_2 , nested_grid%em_mub , ubdy3dtemp2 , nested_grid%em_u_2                 , &amp;<a name='722'>
                       'u' , nested_grid%msfu , &amp;<a name='723'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='724'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_7"> ( nested_grid%em_mu_2 , nested_grid%em_mub , vbdy3dtemp2 , nested_grid%em_v_2                 , &amp;<a name='725'>
                       'v' , nested_grid%msfv , &amp;<a name='726'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='727'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_8"> ( nested_grid%em_mu_2 , nested_grid%em_mub , tbdy3dtemp2 , nested_grid%em_t_2                 , &amp;<a name='728'>
                       't' , nested_grid%msft , &amp;<a name='729'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='730'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_9"> ( nested_grid%em_mu_2 , nested_grid%em_mub , pbdy3dtemp2 , nested_grid%em_ph_2                , &amp;<a name='731'>
                       'h' , nested_grid%msft , &amp;<a name='732'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='733'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_10"> ( nested_grid%em_mu_2 , nested_grid%em_mub , qbdy3dtemp2 , nested_grid%moist_2(:,:,:,P_QV)    , &amp;<a name='734'>
                       't' , nested_grid%msft , &amp;<a name='735'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='736'>
<a name='737'>
          DO j = jps , jpe<a name='738'>
             DO i = ips , ipe<a name='739'>
                mbdy2dtemp2(i,1,j) = nested_grid%em_mu_2(i,j)<a name='740'>
             END DO<a name='741'>
          END DO<a name='742'>
<a name='743'>
         <font color=#447700>!  During all of the loops after the first loop, we first compute the boundary<a name='744'></font>
         <font color=#447700>!  tendencies with the current data values and the previously save information<a name='745'></font>
         <font color=#447700>!  stored in the *bdy3dtemp1 arrays.<a name='746'></font>
<a name='747'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_1"> ( ubdy3dtemp2 , ubdy3dtemp1 , new_bdy_frq , nested_grid%em_u_bt  , 'U'  , &amp;<a name='748'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='749'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='750'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='751'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='752'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_2"> ( vbdy3dtemp2 , vbdy3dtemp1 , new_bdy_frq , nested_grid%em_v_bt  , 'V'  , &amp;<a name='753'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='754'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='755'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='756'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='757'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_3"> ( tbdy3dtemp2 , tbdy3dtemp1 , new_bdy_frq , nested_grid%em_t_bt  , 'T'  , &amp;<a name='758'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='759'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='760'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='761'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='762'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_4"> ( pbdy3dtemp2 , pbdy3dtemp1 , new_bdy_frq , nested_grid%em_ph_bt  , 'W' , &amp;<a name='763'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='764'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='765'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='766'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='767'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_5"> ( qbdy3dtemp2 , qbdy3dtemp1 , new_bdy_frq , nested_grid%em_rqv_bt , 'T' , &amp;<a name='768'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='769'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='770'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='771'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='772'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_6"> ( mbdy2dtemp2 , mbdy2dtemp1 , new_bdy_frq , nested_grid%em_mu_bt  , 'M' , &amp;<a name='773'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='774'>
                                                                  ids , ide , jds , jde , 1 , 1 , &amp;<a name='775'>
                                                                  ims , ime , jms , jme , 1 , 1 , &amp;<a name='776'>
                                                                  ips , ipe , jps , jpe , 1 , 1 )<a name='777'>
         IF ( time_loop .EQ. 2 ) THEN<a name='778'>
   <a name='779'>
            <font color=#447700>!  Generate an output file from this program, which will be an input file to WRF.<a name='780'></font>
<a name='781'>
            CALL wrf_debug          ( 100 , 'ndown_em main: calling open_w_dataset for wrfbdy' )<a name='782'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_6">( bdyname , 'wrfbdy' , nested_grid%id , 2 )<a name='783'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_6">     ( fidb, TRIM(bdyname) , nested_grid , config_flags , output_boundary , &amp;<a name='784'>
                                      "DATASET=BOUNDARY", ierr )<a name='785'>
            IF ( ierr .NE. 0 ) THEN<a name='786'>
               WRITE( wrf_err_message , FMT='(A,A,A,I8)' ) 'program ndown: error opening ',TRIM(bdyname),' for reading ierr=',ierr<a name='787'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_125"> ( wrf_err_message )<a name='788'>
            ENDIF<a name='789'>
<a name='790'>
         END IF<a name='791'>
<a name='792'>
         <font color=#447700>!  Both pieces of the boundary data are now available to be written.<a name='793'></font>
         <a name='794'>
      CALL <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_7">( current_date(1:19), nested_grid%current_time )<a name='795'>
      CALL ESMF_ClockSet(nested_grid%domain_clock, currTime=nested_grid%current_time, rc=rc)<a name='796'>
      temp24= current_date<a name='797'>
      temp24b=start_date_hold<a name='798'>
      start_date = start_date_hold<a name='799'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_NEWDATE'>geth_newdate</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_NEWDATE_5"> ( temp19 , temp24b(1:19) , (time_loop-2) * model_config_rec%interval_seconds )<a name='800'>
      current_date = temp19 //  '.0000'<a name='801'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_JULGMT'>geth_julgmt</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_JULGMT_2"> ( julyr , julday , gmt)<a name='802'>
      CALL nl_set_julyr  ( nested_grid%id , julyr  )<a name='803'>
      CALL nl_set_julday ( nested_grid%id , julday )<a name='804'>
      CALL nl_set_gmt    ( nested_grid%id , gmt    )<a name='805'>
      CALL wrf_put_dom_ti_real    ( fidb , 'GMT' , gmt , 1 , ierr ) <a name='806'>
      CALL wrf_put_dom_ti_integer ( fidb , 'JULYR' , julyr , 1 , ierr ) <a name='807'>
      CALL wrf_put_dom_ti_integer ( fidb , 'JULDAY' , julday , 1 , ierr ) <a name='808'>
      CALL <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_8">( current_date(1:19), nested_grid%current_time )<a name='809'>
      CALL ESMF_ClockSet(nested_grid%domain_clock, currTime=nested_grid%current_time, rc=rc)<a name='810'>
print *,'bdy time = ',time_loop-1,'  bdy date = ',current_date,' ',start_date<a name='811'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OUTPUT_BOUNDARY'>output_boundary</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_BOUNDARY_3"> ( fidb , nested_grid , config_flags , ierr )<a name='812'>
      current_date = temp24<a name='813'>
      start_date = temp24b<a name='814'>
      CALL <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_9">( current_date(1:19), nested_grid%current_time )<a name='815'>
      CALL ESMF_ClockSet(nested_grid%domain_clock, currTime=nested_grid%current_time, rc=rc)<a name='816'>
<a name='817'>
         IF ( time_loop .EQ. 2 ) THEN<a name='818'>
            CALL wrf_put_dom_ti_real    ( fidb , 'BDYFRQ' , new_bdy_frq , 1 , ierr ) <a name='819'>
         END IF<a name='820'>
<a name='821'>
         <font color=#447700>!  We need to save the 3d data to compute a difference during the next loop.  Couple the<a name='822'></font>
         <font color=#447700>!  3d fields with total mu (mub + mu_2) and the stagger-specific map scale factor.<a name='823'></font>
         <font color=#447700>!  We load up the boundary data again for use in the next loop.<a name='824'></font>
<a name='825'>
          DO j = jps , jpe<a name='826'>
             DO k = kps , kpe<a name='827'>
                DO i = ips , ipe<a name='828'>
                   ubdy3dtemp1(i,k,j) = ubdy3dtemp2(i,k,j)<a name='829'>
                   vbdy3dtemp1(i,k,j) = vbdy3dtemp2(i,k,j)<a name='830'>
                   tbdy3dtemp1(i,k,j) = tbdy3dtemp2(i,k,j)<a name='831'>
                   pbdy3dtemp1(i,k,j) = pbdy3dtemp2(i,k,j)<a name='832'>
                   qbdy3dtemp1(i,k,j) = qbdy3dtemp2(i,k,j)<a name='833'>
                END DO<a name='834'>
             END DO<a name='835'>
          END DO<a name='836'>
<a name='837'>
          DO j = jps , jpe<a name='838'>
             DO i = ips , ipe<a name='839'>
                mbdy2dtemp1(i,1,j) = mbdy2dtemp2(i,1,j)<a name='840'>
             END DO<a name='841'>
          END DO<a name='842'>
<a name='843'>
         <font color=#447700>!  There are 2 components to the lateral boundaries.  First, there is the starting<a name='844'></font>
         <font color=#447700>!  point of this time period - just the outer few rows and columns.<a name='845'></font>
<a name='846'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_7">     ( ubdy3dtemp1 , nested_grid%em_u_b     , 'U' , ijds , ijde , spec_bdy_width      , &amp;<a name='847'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='848'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='849'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='850'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_8">     ( vbdy3dtemp1 , nested_grid%em_v_b     , 'V' , ijds , ijde , spec_bdy_width      , &amp;<a name='851'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='852'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='853'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='854'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_9">     ( tbdy3dtemp1 , nested_grid%em_t_b     , 'T' , ijds , ijde , spec_bdy_width      , &amp;<a name='855'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='856'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='857'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='858'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_10">     ( pbdy3dtemp1 , nested_grid%em_ph_b    , 'W' , ijds , ijde , spec_bdy_width      , &amp;<a name='859'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='860'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='861'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='862'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_11">     ( qbdy3dtemp1 , nested_grid%em_rqv_b   , 'T' , ijds , ijde , spec_bdy_width      , &amp;<a name='863'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='864'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='865'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='866'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_12">     ( mbdy2dtemp1 , nested_grid%em_mu_b    , 'M' , ijds , ijde , spec_bdy_width      , &amp;<a name='867'>
                                                                           ids , ide , jds , jde , 1 , 1 , &amp;<a name='868'>
                                                                           ims , ime , jms , jme , 1 , 1 , &amp;<a name='869'>
                                                                           ips , ipe , jps , jpe , 1 , 1 )<a name='870'>
<a name='871'>
      ELSE IF ( time_loop .EQ. time_loop_max ) THEN<a name='872'>
<a name='873'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_11"> ( nested_grid%em_mu_2 , nested_grid%em_mub , ubdy3dtemp2 , nested_grid%em_u_2                 , &amp;<a name='874'>
                       'u' , nested_grid%msfu , &amp;<a name='875'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='876'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_12"> ( nested_grid%em_mu_2 , nested_grid%em_mub , vbdy3dtemp2 , nested_grid%em_v_2                 , &amp;<a name='877'>
                       'v' , nested_grid%msfv , &amp;<a name='878'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='879'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_13"> ( nested_grid%em_mu_2 , nested_grid%em_mub , tbdy3dtemp2 , nested_grid%em_t_2                 , &amp;<a name='880'>
                       't' , nested_grid%msft , &amp;<a name='881'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='882'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_14"> ( nested_grid%em_mu_2 , nested_grid%em_mub , pbdy3dtemp2 , nested_grid%em_ph_2                , &amp;<a name='883'>
                       'h' , nested_grid%msft , &amp;<a name='884'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='885'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_15"> ( nested_grid%em_mu_2 , nested_grid%em_mub , qbdy3dtemp2 , nested_grid%moist_2(:,:,:,P_QV)    , &amp;<a name='886'>
                       't' , nested_grid%msft , &amp;<a name='887'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='888'>
         mbdy2dtemp2(:,1,:) = nested_grid%em_mu_2(:,:)<a name='889'>
<a name='890'>
         <font color=#447700>!  During all of the loops after the first loop, we first compute the boundary<a name='891'></font>
         <font color=#447700>!  tendencies with the current data values and the previously save information<a name='892'></font>
         <font color=#447700>!  stored in the *bdy3dtemp1 arrays.<a name='893'></font>
<a name='894'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_7"> ( ubdy3dtemp2 , ubdy3dtemp1 , new_bdy_frq , nested_grid%em_u_bt  , 'U'  , &amp;<a name='895'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='896'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='897'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='898'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='899'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_8"> ( vbdy3dtemp2 , vbdy3dtemp1 , new_bdy_frq , nested_grid%em_v_bt  , 'V'  , &amp;<a name='900'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='901'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='902'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='903'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='904'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_9"> ( tbdy3dtemp2 , tbdy3dtemp1 , new_bdy_frq , nested_grid%em_t_bt  , 'T'  , &amp;<a name='905'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='906'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='907'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='908'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='909'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_10"> ( pbdy3dtemp2 , pbdy3dtemp1 , new_bdy_frq , nested_grid%em_ph_bt  , 'W' , &amp;<a name='910'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='911'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='912'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='913'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='914'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_11"> ( qbdy3dtemp2 , qbdy3dtemp1 , new_bdy_frq , nested_grid%em_rqv_bt , 'T' , &amp;<a name='915'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='916'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='917'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='918'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='919'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_12"> ( mbdy2dtemp2 , mbdy2dtemp1 , new_bdy_frq , nested_grid%em_mu_bt  , 'M' , &amp;<a name='920'>
                                                                  ijds , ijde , spec_bdy_width      , &amp;<a name='921'>
                                                                  ids , ide , jds , jde , 1 , 1 , &amp;<a name='922'>
                                                                  ims , ime , jms , jme , 1 , 1 , &amp;<a name='923'>
                                                                  ips , ipe , jps , jpe , 1 , 1 )<a name='924'>
<a name='925'>
         IF ( time_loop .EQ. 2 ) THEN<a name='926'>
   <a name='927'>
            <font color=#447700>!  Generate an output file from this program, which will be an input file to WRF.<a name='928'></font>
<a name='929'>
            CALL wrf_debug          ( 100 , 'ndown_em main: calling open_w_dataset for wrfbdy' )<a name='930'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_7">( bdyname , 'wrfbdy' , nested_grid%id , 2 )<a name='931'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_7">     ( fidb, TRIM(bdyname) , nested_grid , config_flags , output_boundary , &amp;<a name='932'>
                                      "DATASET=BOUNDARY", ierr )<a name='933'>
            IF ( ierr .NE. 0 ) THEN<a name='934'>
               WRITE( wrf_err_message , FMT='(A,A,A,I8)' ) 'program ndown: error opening ',TRIM(bdyname),' for reading ierr=',ierr<a name='935'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_126"> ( wrf_err_message )<a name='936'>
            ENDIF<a name='937'>
<a name='938'>
         END IF<a name='939'>
<a name='940'>
         <font color=#447700>!  Both pieces of the boundary data are now available to be written.<a name='941'></font>
<a name='942'>
      CALL <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_10">( current_date(1:19), nested_grid%current_time )<a name='943'>
      CALL ESMF_ClockSet(nested_grid%domain_clock, currTime=nested_grid%current_time, rc=rc)<a name='944'>
      temp24= current_date<a name='945'>
      temp24b=start_date_hold<a name='946'>
      start_date = start_date_hold<a name='947'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_NEWDATE'>geth_newdate</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_NEWDATE_6"> ( temp19 , temp24b(1:19) , (time_loop-2) * model_config_rec%interval_seconds )<a name='948'>
      current_date = temp19 //  '.0000'<a name='949'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_JULGMT'>geth_julgmt</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_JULGMT_3"> ( julyr , julday , gmt)<a name='950'>
      CALL nl_set_julyr  ( nested_grid%id , julyr  )<a name='951'>
      CALL nl_set_julday ( nested_grid%id , julday )<a name='952'>
      CALL nl_set_gmt    ( nested_grid%id , gmt    )<a name='953'>
      CALL wrf_put_dom_ti_real    ( fidb , 'GMT' , gmt , 1 , ierr ) <a name='954'>
      CALL wrf_put_dom_ti_integer ( fidb , 'JULYR' , julyr , 1 , ierr ) <a name='955'>
      CALL wrf_put_dom_ti_integer ( fidb , 'JULDAY' , julday , 1 , ierr ) <a name='956'>
      CALL <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_11">( current_date(1:19), nested_grid%current_time )<a name='957'>
      CALL ESMF_ClockSet(nested_grid%domain_clock, currTime=nested_grid%current_time, rc=rc)<a name='958'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OUTPUT_BOUNDARY'>output_boundary</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_BOUNDARY_4"> ( fidb , nested_grid , config_flags , ierr )<a name='959'>
      current_date = temp24<a name='960'>
      start_date = temp24b<a name='961'>
      CALL <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_12">( current_date(1:19), nested_grid%current_time )<a name='962'>
      CALL ESMF_ClockSet(nested_grid%domain_clock, currTime=nested_grid%current_time, rc=rc)<a name='963'>
<a name='964'>
         IF ( time_loop .EQ. 2 ) THEN<a name='965'>
            CALL wrf_put_dom_ti_real    ( fidb , 'BDYFRQ' , new_bdy_frq , 1 , ierr ) <a name='966'>
         END IF<a name='967'>
<a name='968'>
         <font color=#447700>!  Since this is the last time through here, we need to close the boundary file.<a name='969'></font>
<a name='970'>
         CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_22"> ( nested_grid%id , model_config_rec , config_flags )<a name='971'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_8"> ( fidb , config_flags , "DATASET=BOUNDARY" )<a name='972'>
<a name='973'>
<a name='974'>
      END IF<a name='975'>
<a name='976'>
      <font color=#447700>!  Process which time now?<a name='977'></font>
<a name='978'>
   END DO big_time_loop_thingy<a name='979'>
<a name='980'>
   CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_23"> ( parent_grid%id , model_config_rec , config_flags )<a name='981'>
   CALL <A href='../../html_code/share/mediation_wrfmain.F.html#MED_SHUTDOWN_IO'>med_shutdown_io</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_SHUTDOWN_IO_4"> ( parent_grid , config_flags )<a name='982'>
<a name='983'>
   CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_24"> ( nested_grid%id , model_config_rec , config_flags )<a name='984'>
   CALL <A href='../../html_code/share/mediation_wrfmain.F.html#MED_SHUTDOWN_IO'>med_shutdown_io</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_SHUTDOWN_IO_5"> ( nested_grid , config_flags )<a name='985'>
<a name='986'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_130"> ( 0 , 'ndown_em: SUCCESS COMPLETE NDOWN_EM INIT' )<a name='987'>
<a name='988'>
   CALL <A href='../../html_code/frame/wrf_shutdown.F.html#WRF_SHUTDOWN'>wrf_shutdown</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SHUTDOWN_6"><a name='989'>
<a name='990'>
   CALL ESMF_Finalize( rc=rc )<a name='991'>
<a name='992'>
END PROGRAM ndown_em<a name='993'>
<a name='994'>
<A NAME='LAND_PERCENTAGES'><A href='../../html_code/main/ndown_em.F.html#LAND_PERCENTAGES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='995'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>land_percentages</font> ( xland , &amp; <A href='../../call_to/LAND_PERCENTAGES.html' TARGET='index'>1</A>,<A href='../../call_from/LAND_PERCENTAGES.html' TARGET='index'>2</A><a name='996'>
                              landuse_frac , soil_top_cat , soil_bot_cat , &amp;<a name='997'>
                              isltyp , ivgtyp , &amp;<a name='998'>
                              num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='999'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='1000'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1001'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='1002'>
                              iswater )<a name='1003'>
   USE <A href='../../html_code/share/module_soil_pre.F.html#MODULE_SOIL_PRE'>module_soil_pre</A><A href='../../html_code/main/ndown_em.F.html#LAND_PERCENTAGES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SOIL_PRE_2"><a name='1004'>
<a name='1005'>
   IMPLICIT NONE<a name='1006'>
<a name='1007'>
   INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='1008'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='1009'>
                           its , ite , jts , jte , kts , kte , &amp;<a name='1010'>
                           iswater<a name='1011'>
<a name='1012'>
   INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='1013'>
   REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landuse_frac<a name='1014'>
   REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(IN):: soil_top_cat<a name='1015'>
   REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(IN):: soil_bot_cat<a name='1016'>
   INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='1017'>
   REAL , DIMENSION(ims:ime,jms:jme) , INTENT(OUT) :: xland<a name='1018'>
<a name='1019'>
   CALL <A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW'>process_percent_cat_new</A><A href='../../html_code/main/ndown_em.F.html#LAND_PERCENTAGES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PROCESS_PERCENT_CAT_NEW_2"> ( xland , &amp;<a name='1020'>
                                  landuse_frac , soil_top_cat , soil_bot_cat , &amp;<a name='1021'>
                                  isltyp , ivgtyp , &amp;<a name='1022'>
                                  num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='1023'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1024'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1025'>
                                  its , ite , jts , jte , kts , kte , &amp;<a name='1026'>
                                  iswater )<a name='1027'>
<a name='1028'>
END SUBROUTINE land_percentages<a name='1029'>
<a name='1030'>
<A NAME='CHECK_CONSISTENCY'><A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1031'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>check_consistency</font> ( ivgtyp , isltyp , landmask , &amp; <A href='../../call_to/CHECK_CONSISTENCY.html' TARGET='index'>1</A>,<A href='../../call_from/CHECK_CONSISTENCY.html' TARGET='index'>1</A><a name='1032'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1033'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1034'>
                                  its , ite , jts , jte , kts , kte , &amp;<a name='1035'>
                                  iswater )<a name='1036'>
<a name='1037'>
   IMPLICIT NONE<a name='1038'>
<a name='1039'>
   INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='1040'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='1041'>
                           its , ite , jts , jte , kts , kte , &amp;<a name='1042'>
                           iswater<a name='1043'>
   INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: isltyp , ivgtyp<a name='1044'>
   REAL    , DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: landmask<a name='1045'>
<a name='1046'>
   LOGICAL :: oops<a name='1047'>
   INTEGER :: oops_count , i , j<a name='1048'>
<a name='1049'>
   oops = .FALSE.<a name='1050'>
   oops_count = 0<a name='1051'>
<a name='1052'>
   DO j = jts, MIN(jde-1,jte)<a name='1053'>
      DO i = its, MIN(ide-1,ite)<a name='1054'>
         IF ( ( ( landmask(i,j) .LT. 0.5 ) .AND. ( ivgtyp(i,j) .NE. iswater ) ) .OR. &amp;<a name='1055'>
              ( ( landmask(i,j) .GT. 0.5 ) .AND. ( ivgtyp(i,j) .EQ. iswater ) ) ) THEN<a name='1056'>
            print *,'mismatch in landmask and veg type'<a name='1057'>
            print *,'i,j=',i,j, '  landmask =',NINT(landmask(i,j)),'  ivgtyp=',ivgtyp(i,j)<a name='1058'>
            oops = .TRUE.<a name='1059'>
            oops_count = oops_count + 1<a name='1060'>
landmask(i,j) = 0<a name='1061'>
ivgtyp(i,j)=16<a name='1062'>
isltyp(i,j)=14<a name='1063'>
         END IF<a name='1064'>
      END DO<a name='1065'>
   END DO<a name='1066'>
<a name='1067'>
   IF ( oops ) THEN<a name='1068'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_131">( 0, 'mismatch in check_consistency, turned to water points, be careful' )<a name='1069'>
   END IF<a name='1070'>
<a name='1071'>
END SUBROUTINE check_consistency<a name='1072'>
<a name='1073'>
<A NAME='CHECK_CONSISTENCY2'><A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1074'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>check_consistency2</font>( ivgtyp , isltyp , landmask , &amp; <A href='../../call_to/CHECK_CONSISTENCY2.html' TARGET='index'>1</A>,<A href='../../call_from/CHECK_CONSISTENCY2.html' TARGET='index'>6</A><a name='1075'>
                               tmn , tsk , sst , xland , &amp;<a name='1076'>
                               tslb , smois , sh2o , &amp;<a name='1077'>
                               num_soil_layers , id , &amp;<a name='1078'>
                               ids , ide , jds , jde , kds , kde , &amp;<a name='1079'>
                               ims , ime , jms , jme , kms , kme , &amp;<a name='1080'>
                               its , ite , jts , jte , kts , kte , &amp;<a name='1081'>
                               iswater )<a name='1082'>
<a name='1083'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_96"><a name='1084'>
   USE <A href='../../html_code/share/module_optional_si_input.F.html#MODULE_OPTIONAL_SI_INPUT'>module_optional_si_input</A><A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_OPTIONAL_SI_INPUT_2"><a name='1085'>
<a name='1086'>
   INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='1087'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='1088'>
                           its , ite , jts , jte , kts , kte <a name='1089'>
   INTEGER , INTENT(IN) :: num_soil_layers , id<a name='1090'>
<a name='1091'>
   INTEGER , DIMENSION(ims:ime,jms:jme) :: ivgtyp , isltyp<a name='1092'>
   REAL    , DIMENSION(ims:ime,jms:jme) :: landmask , tmn , tsk , sst , xland<a name='1093'>
   REAL    , DIMENSION(ims:ime,num_soil_layers,jms:jme) :: tslb , smois , sh2o<a name='1094'>
<a name='1095'>
   INTEGER :: oops1 , oops2<a name='1096'>
   INTEGER :: i , j , k<a name='1097'>
<a name='1098'>
      fix_tsk_tmn : SELECT CASE ( model_config_rec%sf_surface_physics(id) )<a name='1099'>
<a name='1100'>
         CASE ( SLABSCHEME , LSMSCHEME , RUCLSMSCHEME )<a name='1101'>
            DO j = jts, MIN(jde-1,jte)<a name='1102'>
               DO i = its, MIN(ide-1,ite)<a name='1103'>
                  IF ( ( landmask(i,j) .LT. 0.5 ) .AND. ( flag_sst .EQ. 1 ) ) THEN<a name='1104'>
                     tmn(i,j) = sst(i,j)<a name='1105'>
                     tsk(i,j) = sst(i,j)<a name='1106'>
                  ELSE IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='1107'>
                     tmn(i,j) = tsk(i,j)<a name='1108'>
                  END IF<a name='1109'>
               END DO<a name='1110'>
            END DO<a name='1111'>
      END SELECT fix_tsk_tmn<a name='1112'>
<a name='1113'>
      <font color=#447700>!  Is the TSK reasonable?<a name='1114'></font>
<a name='1115'>
      DO j = jts, MIN(jde-1,jte)<a name='1116'>
         DO i = its, MIN(ide-1,ite)<a name='1117'>
            IF ( tsk(i,j) .LT. 170 .or. tsk(i,j) .GT. 400. ) THEN<a name='1118'>
               print *,'error in the TSK'<a name='1119'>
               print *,'i,j=',i,j<a name='1120'>
               print *,'landmask=',landmask(i,j)<a name='1121'>
               print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='1122'>
               if(tmn(i,j).gt.170. .and. tmn(i,j).lt.400.)then<a name='1123'>
                  tsk(i,j)=tmn(i,j)<a name='1124'>
               else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='1125'>
                  tsk(i,j)=sst(i,j)<a name='1126'>
               else<a name='1127'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_127"> ( 'TSK unreasonable' )<a name='1128'>
               end if<a name='1129'>
            END IF<a name='1130'>
         END DO<a name='1131'>
      END DO<a name='1132'>
<a name='1133'>
      <font color=#447700>!  Is the TMN reasonable?<a name='1134'></font>
<a name='1135'>
      DO j = jts, MIN(jde-1,jte)<a name='1136'>
         DO i = its, MIN(ide-1,ite)<a name='1137'>
            IF ( ( ( tmn(i,j) .LT. 170. ) .OR. ( tmn(i,j) .GT. 400. ) ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='1138'>
                  print *,'error in the TMN'<a name='1139'>
                  print *,'i,j=',i,j<a name='1140'>
                  print *,'landmask=',landmask(i,j)<a name='1141'>
                  print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='1142'>
               if(tsk(i,j).gt.170. .and. tsk(i,j).lt.400.)then<a name='1143'>
                  tmn(i,j)=tsk(i,j)<a name='1144'>
               else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='1145'>
                  tmn(i,j)=sst(i,j)<a name='1146'>
               else<a name='1147'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_128"> ( 'TMN unreasonable' )<a name='1148'>
               endif<a name='1149'>
            END IF<a name='1150'>
         END DO<a name='1151'>
      END DO<a name='1152'>
<a name='1153'>
      <font color=#447700>!  Is the TSLB reasonable?<a name='1154'></font>
<a name='1155'>
      DO j = jts, MIN(jde-1,jte)<a name='1156'>
         DO i = its, MIN(ide-1,ite)<a name='1157'>
            IF ( ( ( tslb(i,1,j) .LT. 170. ) .OR. ( tslb(i,1,j) .GT. 400. ) ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='1158'>
                  print *,'error in the TSLB'<a name='1159'>
                  print *,'i,j=',i,j<a name='1160'>
                  print *,'landmask=',landmask(i,j)<a name='1161'>
                  print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='1162'>
                  print *,'tslb = ',tslb(i,:,j)<a name='1163'>
                  print *,'old smois = ',smois(i,:,j)<a name='1164'>
                  DO l = 1 , num_soil_layers<a name='1165'>
                     sh2o(i,l,j) = 0.0<a name='1166'>
                  END DO<a name='1167'>
                  DO l = 1 , num_soil_layers<a name='1168'>
                     smois(i,l,j) = 0.3<a name='1169'>
                  END DO<a name='1170'>
                  if(tsk(i,j).gt.170. .and. tsk(i,j).lt.400.)then<a name='1171'>
                     DO l = 1 , num_soil_layers<a name='1172'>
                        tslb(i,l,j)=tsk(i,j)<a name='1173'>
                     END DO<a name='1174'>
                  else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='1175'>
                     DO l = 1 , num_soil_layers<a name='1176'>
                        tslb(i,l,j)=sst(i,j)<a name='1177'>
                     END DO<a name='1178'>
                  else if(tmn(i,j).gt.170. .and. tmn(i,j).lt.400.)then<a name='1179'>
                     DO l = 1 , num_soil_layers<a name='1180'>
                        tslb(i,l,j)=tmn(i,j)<a name='1181'>
                     END DO<a name='1182'>
                  else<a name='1183'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_129"> ( 'TSLB unreasonable' )<a name='1184'>
                  endif<a name='1185'>
            END IF<a name='1186'>
         END DO<a name='1187'>
      END DO<a name='1188'>
<a name='1189'>
      <font color=#447700>!  Let us make sure (again) that the landmask and the veg/soil categories match.<a name='1190'></font>
<a name='1191'>
oops1=0<a name='1192'>
oops2=0<a name='1193'>
      DO j = jts, MIN(jde-1,jte)<a name='1194'>
         DO i = its, MIN(ide-1,ite)<a name='1195'>
            IF ( ( ( landmask(i,j) .LT. 0.5 ) .AND. ( ivgtyp(i,j) .NE. iswater .OR. isltyp(i,j) .NE. 14 ) ) .OR. &amp;<a name='1196'>
                 ( ( landmask(i,j) .GT. 0.5 ) .AND. ( ivgtyp(i,j) .EQ. iswater .OR. isltyp(i,j) .EQ. 14 ) ) ) THEN<a name='1197'>
               IF ( tslb(i,1,j) .GT. 1. ) THEN<a name='1198'>
oops1=oops1+1<a name='1199'>
                  ivgtyp(i,j) = 5<a name='1200'>
                  isltyp(i,j) = 8<a name='1201'>
                  landmask(i,j) = 1<a name='1202'>
                  xland(i,j) = 1<a name='1203'>
               ELSE IF ( sst(i,j) .GT. 1. ) THEN<a name='1204'>
oops2=oops2+1<a name='1205'>
                  ivgtyp(i,j) = iswater<a name='1206'>
                  isltyp(i,j) = 14<a name='1207'>
                  landmask(i,j) = 0<a name='1208'>
                  xland(i,j) = 2<a name='1209'>
               ELSE<a name='1210'>
                  print *,'the landmask and soil/veg cats do not match'<a name='1211'>
                  print *,'i,j=',i,j<a name='1212'>
                  print *,'landmask=',landmask(i,j)<a name='1213'>
                  print *,'ivgtyp=',ivgtyp(i,j)<a name='1214'>
                  print *,'isltyp=',isltyp(i,j)<a name='1215'>
                  print *,'iswater=', iswater<a name='1216'>
                  print *,'tslb=',tslb(i,:,j)<a name='1217'>
                  print *,'sst=',sst(i,j)<a name='1218'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_130"> ( 'mismatch_landmask_ivgtyp' )<a name='1219'>
               END IF<a name='1220'>
            END IF<a name='1221'>
         END DO<a name='1222'>
      END DO<a name='1223'>
if (oops1.gt.0) then<a name='1224'>
print *,'points artificially set to land : ',oops1<a name='1225'>
endif<a name='1226'>
if(oops2.gt.0) then<a name='1227'>
print *,'points artificially set to water: ',oops2<a name='1228'>
endif<a name='1229'>
<a name='1230'>
END SUBROUTINE check_consistency2<a name='1231'>
</pre></body></html>