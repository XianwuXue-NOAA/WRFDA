% this file is called up by thesis.tex
% content in this file will be fed into the main document

\chapter{Overview of 4DVAR in the WRF Modeling System} % top level followed by section, subsection


% ----------------------- contents from here ------------------------

\section{Background Preprocessing}

Our ultimate goal is...

\section{How to run WRF Tangent Linear Model}

\section{Background Error Calculation}

\section{4DVAR System Overview}

\section{Check the Accuracy}

There are three input files: WRFDA analysis, $wrfinput$, and $wrfbdy$ files from $real.exe$, and a namelist file: $param.in$ for running $da\_update\_bc.exe$ for domain-1. Before running NWP forecast using the WRF-model with WRFDA analysis, update the values and tendencies for each predicted variable in the first time period in the lateral boundary condition file. For domain-1 ($wrfbdy\_d01$) must be updated to be consistent with the new WRFDA initial condition (analysis). This is absolutely essential. Moreover, in the cycling run mode (warm-start), the low boundary in the WRFDA analysis file also needs to be updated based on the information from the wrfinput file generated by WPS/real.exe at analysis time.

For the nested domains, domain-2, domain-3É, the lateral boundaries are provided by their parent domains, so no lateral boundary update is needed for these domains; but the low boundaries in each of the nested domainsÕ WRFDA analysis files still need to be updated. In these cases, you must set the namelist variable, $domain\_id > 1$ (default is 1 for domain-1), and no $wrfbdy\_d01$ file need to be provided to the namelist variable: $wrf\_bdy\_file$.

This procedure is performed by the WRFDA utility called $da\_updated\_bc.exe$.

Note: Make sure that you have $da\_update\_bc.exe$ in $WRFDA/var/build$ directory. This executable should be created when you compiled WRFDA code, 

To run $da\_update\_bc.exe$, follow the steps below:

\begin{Verbatim}[frame=single,framerule=0.5mm,rulecolor=\color{blue},commandchars=\\\{\}]
> cd WRFDA/var/test/update_bc 
> cp -p $DAT_DIR/rc/2008020512/wrfbdy_d01 ./wrfbdy_d01 
\textcolor{green}{# IMPORTANT: make a copy of wrfbdy_d01 as the wrf_bdy_file}
\textcolor{green}{# will be overwritten by da_update_bc.exe}
> vi parame.in
&control_param
 wrfvar_output_file = './wrfvar_output'
 wrf_bdy_file       = './wrfbdy_d01'
 wrf_input          = '$DAT_DIR/rc/2008020512/wrfinput_d01'
 \textcolor{red}{var4d_lbc = .false.}
 cycling = .false. 
 \textcolor{green}{# (set to .true. if WRFDA first guess comes from}
 \textcolor{green}{# a previous WRF forecast.)}
 debug   = .true.
 low_bdy_only = .false.            
 update_lsm = .false.
/
> ln -sf WRFDA/var/da/da_update_bc.exe ./da_update_bc.exe
> ./da_updatebc.exe
\end{Verbatim}

At this stage, you should have the files $wrfvar\_output$ and $wrfbdy\_d01$ in your WRFDA working directory. They are the WRFDA updated initial condition and boundary condition for any subsequent WRF model runs. To use, link a copy of $wrfvar\_output $and $wrfbdy\_d01$ to $wrfinput\_d01$ and $wrfbdy\_d01$, respectively, in your WRF working directory.
 
As of V3.2, some changes were made to $da\_update\_bc$ to address some issues that are related to sea-ice and snow change during cycling runs and radiance data assimilation. The new settings in $parame.in$ are introduced as follows. (However, for backward compatibility, the pre-V3.2 $parame.in$ mentioned above still works with V3.2+ $da\_update\_bc$)


% ---------------------------------------------------------------------------
% ----------------------- end of thesis sub-document ------------------------
% ---------------------------------------------------------------------------